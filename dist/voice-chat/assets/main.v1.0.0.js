(function(Ai,Ht){typeof exports=="object"&&typeof module<"u"?Ht(exports,require("react"),require("@chakra-ui/react")):typeof define=="function"&&define.amd?define(["exports","react","@chakra-ui/react"],Ht):(Ai=typeof globalThis<"u"?globalThis:Ai||self,Ht(Ai.VoiceChat={},Ai.React,Ai.ChakraUI))})(this,function(Ai,Ht,Cr){"use strict";var ag=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function PI(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var tf={exports:{}},Wu={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var DI;function bV(){if(DI)return Wu;DI=1;var u=Ht,s=Symbol.for("react.element"),c=Symbol.for("react.fragment"),p=Object.prototype.hasOwnProperty,_=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,g={key:!0,ref:!0,__self:!0,__source:!0};function y(O,L,V){var G,tt={},st=null,ht=null;V!==void 0&&(st=""+V),L.key!==void 0&&(st=""+L.key),L.ref!==void 0&&(ht=L.ref);for(G in L)p.call(L,G)&&!g.hasOwnProperty(G)&&(tt[G]=L[G]);if(O&&O.defaultProps)for(G in L=O.defaultProps,L)tt[G]===void 0&&(tt[G]=L[G]);return{$$typeof:s,type:O,key:st,ref:ht,props:tt,_owner:_.current}}return Wu.Fragment=c,Wu.jsx=y,Wu.jsxs=y,Wu}var Hu={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var kI;function OV(){return kI||(kI=1,process.env.NODE_ENV!=="production"&&function(){var u=Ht,s=Symbol.for("react.element"),c=Symbol.for("react.portal"),p=Symbol.for("react.fragment"),_=Symbol.for("react.strict_mode"),g=Symbol.for("react.profiler"),y=Symbol.for("react.provider"),O=Symbol.for("react.context"),L=Symbol.for("react.forward_ref"),V=Symbol.for("react.suspense"),G=Symbol.for("react.suspense_list"),tt=Symbol.for("react.memo"),st=Symbol.for("react.lazy"),ht=Symbol.for("react.offscreen"),yt=Symbol.iterator,Vt="@@iterator";function wt(Q){if(Q===null||typeof Q!="object")return null;var kt=yt&&Q[yt]||Q[Vt];return typeof kt=="function"?kt:null}var te=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function Nt(Q){{for(var kt=arguments.length,Jt=new Array(kt>1?kt-1:0),_e=1;_e<kt;_e++)Jt[_e-1]=arguments[_e];oe("error",Q,Jt)}}function oe(Q,kt,Jt){{var _e=te.ReactDebugCurrentFrame,rn=_e.getStackAddendum();rn!==""&&(kt+="%s",Jt=Jt.concat([rn]));var gn=Jt.map(function(He){return String(He)});gn.unshift("Warning: "+kt),Function.prototype.apply.call(console[Q],console,gn)}}var Lt=!1,It=!1,ae=!1,J=!1,q=!1,K;K=Symbol.for("react.module.reference");function Z(Q){return!!(typeof Q=="string"||typeof Q=="function"||Q===p||Q===g||q||Q===_||Q===V||Q===G||J||Q===ht||Lt||It||ae||typeof Q=="object"&&Q!==null&&(Q.$$typeof===st||Q.$$typeof===tt||Q.$$typeof===y||Q.$$typeof===O||Q.$$typeof===L||Q.$$typeof===K||Q.getModuleId!==void 0))}function rt(Q,kt,Jt){var _e=Q.displayName;if(_e)return _e;var rn=kt.displayName||kt.name||"";return rn!==""?Jt+"("+rn+")":Jt}function nt(Q){return Q.displayName||"Context"}function X(Q){if(Q==null)return null;if(typeof Q.tag=="number"&&Nt("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof Q=="function")return Q.displayName||Q.name||null;if(typeof Q=="string")return Q;switch(Q){case p:return"Fragment";case c:return"Portal";case g:return"Profiler";case _:return"StrictMode";case V:return"Suspense";case G:return"SuspenseList"}if(typeof Q=="object")switch(Q.$$typeof){case O:var kt=Q;return nt(kt)+".Consumer";case y:var Jt=Q;return nt(Jt._context)+".Provider";case L:return rt(Q,Q.render,"ForwardRef");case tt:var _e=Q.displayName||null;return _e!==null?_e:X(Q.type)||"Memo";case st:{var rn=Q,gn=rn._payload,He=rn._init;try{return X(He(gn))}catch{return null}}}return null}var ee=Object.assign,xn=0,ne,nn,lr,an,Pt,zt,Te;function Ot(){}Ot.__reactDisabledLog=!0;function Bt(){{if(xn===0){ne=console.log,nn=console.info,lr=console.warn,an=console.error,Pt=console.group,zt=console.groupCollapsed,Te=console.groupEnd;var Q={configurable:!0,enumerable:!0,value:Ot,writable:!0};Object.defineProperties(console,{info:Q,log:Q,warn:Q,error:Q,group:Q,groupCollapsed:Q,groupEnd:Q})}xn++}}function re(){{if(xn--,xn===0){var Q={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:ee({},Q,{value:ne}),info:ee({},Q,{value:nn}),warn:ee({},Q,{value:lr}),error:ee({},Q,{value:an}),group:ee({},Q,{value:Pt}),groupCollapsed:ee({},Q,{value:zt}),groupEnd:ee({},Q,{value:Te})})}xn<0&&Nt("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var ie=te.ReactCurrentDispatcher,we;function Zt(Q,kt,Jt){{if(we===void 0)try{throw Error()}catch(rn){var _e=rn.stack.trim().match(/\n( *(at )?)/);we=_e&&_e[1]||""}return`
`+we+Q}}var me=!1,fe;{var Hn=typeof WeakMap=="function"?WeakMap:Map;fe=new Hn}function jt(Q,kt){if(!Q||me)return"";{var Jt=fe.get(Q);if(Jt!==void 0)return Jt}var _e;me=!0;var rn=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var gn;gn=ie.current,ie.current=null,Bt();try{if(kt){var He=function(){throw Error()};if(Object.defineProperty(He.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(He,[])}catch(Zi){_e=Zi}Reflect.construct(Q,[],He)}else{try{He.call()}catch(Zi){_e=Zi}Q.call(He.prototype)}}else{try{throw Error()}catch(Zi){_e=Zi}Q()}}catch(Zi){if(Zi&&_e&&typeof Zi.stack=="string"){for(var be=Zi.stack.split(`
`),gr=_e.stack.split(`
`),Jn=be.length-1,wn=gr.length-1;Jn>=1&&wn>=0&&be[Jn]!==gr[wn];)wn--;for(;Jn>=1&&wn>=0;Jn--,wn--)if(be[Jn]!==gr[wn]){if(Jn!==1||wn!==1)do if(Jn--,wn--,wn<0||be[Jn]!==gr[wn]){var zr=`
`+be[Jn].replace(" at new "," at ");return Q.displayName&&zr.includes("<anonymous>")&&(zr=zr.replace("<anonymous>",Q.displayName)),typeof Q=="function"&&fe.set(Q,zr),zr}while(Jn>=1&&wn>=0);break}}}finally{me=!1,ie.current=gn,re(),Error.prepareStackTrace=rn}var Fs=Q?Q.displayName||Q.name:"",gi=Fs?Zt(Fs):"";return typeof Q=="function"&&fe.set(Q,gi),gi}function qr(Q,kt,Jt){return jt(Q,!1)}function ps(Q){var kt=Q.prototype;return!!(kt&&kt.isReactComponent)}function Yr(Q,kt,Jt){if(Q==null)return"";if(typeof Q=="function")return jt(Q,ps(Q));if(typeof Q=="string")return Zt(Q);switch(Q){case V:return Zt("Suspense");case G:return Zt("SuspenseList")}if(typeof Q=="object")switch(Q.$$typeof){case L:return qr(Q.render);case tt:return Yr(Q.type,kt,Jt);case st:{var _e=Q,rn=_e._payload,gn=_e._init;try{return Yr(gn(rn),kt,Jt)}catch{}}}return""}var $o=Object.prototype.hasOwnProperty,fl={},Qi=te.ReactDebugCurrentFrame;function po(Q){if(Q){var kt=Q._owner,Jt=Yr(Q.type,Q._source,kt?kt.type:null);Qi.setExtraStackFrame(Jt)}else Qi.setExtraStackFrame(null)}function Kc(Q,kt,Jt,_e,rn){{var gn=Function.call.bind($o);for(var He in Q)if(gn(Q,He)){var be=void 0;try{if(typeof Q[He]!="function"){var gr=Error((_e||"React class")+": "+Jt+" type `"+He+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof Q[He]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw gr.name="Invariant Violation",gr}be=Q[He](kt,He,_e,Jt,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(Jn){be=Jn}be&&!(be instanceof Error)&&(po(rn),Nt("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",_e||"React class",Jt,He,typeof be),po(null)),be instanceof Error&&!(be.message in fl)&&(fl[be.message]=!0,po(rn),Nt("Failed %s type: %s",Jt,be.message),po(null))}}}var Ur=Array.isArray;function xr(Q){return Ur(Q)}function Zo(Q){{var kt=typeof Symbol=="function"&&Symbol.toStringTag,Jt=kt&&Q[Symbol.toStringTag]||Q.constructor.name||"Object";return Jt}}function ta(Q){try{return qc(Q),!1}catch{return!0}}function qc(Q){return""+Q}function Er(Q){if(ta(Q))return Nt("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",Zo(Q)),qc(Q)}var pn=te.ReactCurrentOwner,bi={key:!0,ref:!0,__self:!0,__source:!0},Ja,ea;function _l(Q){if($o.call(Q,"ref")){var kt=Object.getOwnPropertyDescriptor(Q,"ref").get;if(kt&&kt.isReactWarning)return!1}return Q.ref!==void 0}function fo(Q){if($o.call(Q,"key")){var kt=Object.getOwnPropertyDescriptor(Q,"key").get;if(kt&&kt.isReactWarning)return!1}return Q.key!==void 0}function Yc(Q,kt){typeof Q.ref=="string"&&pn.current}function zc(Q,kt){{var Jt=function(){Ja||(Ja=!0,Nt("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",kt))};Jt.isReactWarning=!0,Object.defineProperty(Q,"key",{get:Jt,configurable:!0})}}function $i(Q,kt){{var Jt=function(){ea||(ea=!0,Nt("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",kt))};Jt.isReactWarning=!0,Object.defineProperty(Q,"ref",{get:Jt,configurable:!0})}}var ml=function(Q,kt,Jt,_e,rn,gn,He){var be={$$typeof:s,type:Q,key:kt,ref:Jt,props:He,_owner:gn};return be._store={},Object.defineProperty(be._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(be,"_self",{configurable:!1,enumerable:!1,writable:!1,value:_e}),Object.defineProperty(be,"_source",{configurable:!1,enumerable:!1,writable:!1,value:rn}),Object.freeze&&(Object.freeze(be.props),Object.freeze(be)),be};function mh(Q,kt,Jt,_e,rn){{var gn,He={},be=null,gr=null;Jt!==void 0&&(Er(Jt),be=""+Jt),fo(kt)&&(Er(kt.key),be=""+kt.key),_l(kt)&&(gr=kt.ref,Yc(kt,rn));for(gn in kt)$o.call(kt,gn)&&!bi.hasOwnProperty(gn)&&(He[gn]=kt[gn]);if(Q&&Q.defaultProps){var Jn=Q.defaultProps;for(gn in Jn)He[gn]===void 0&&(He[gn]=Jn[gn])}if(be||gr){var wn=typeof Q=="function"?Q.displayName||Q.name||"Unknown":Q;be&&zc(He,wn),gr&&$i(He,wn)}return ml(Q,be,gr,rn,_e,pn.current,He)}}var na=te.ReactCurrentOwner,fs=te.ReactDebugCurrentFrame;function _s(Q){if(Q){var kt=Q._owner,Jt=Yr(Q.type,Q._source,kt?kt.type:null);fs.setExtraStackFrame(Jt)}else fs.setExtraStackFrame(null)}var Us;Us=!1;function ra(Q){return typeof Q=="object"&&Q!==null&&Q.$$typeof===s}function Xa(){{if(na.current){var Q=X(na.current.type);if(Q)return`

Check the render method of \``+Q+"`."}return""}}function xs(Q){return""}var Vs={};function Qa(Q){{var kt=Xa();if(!kt){var Jt=typeof Q=="string"?Q:Q.displayName||Q.name;Jt&&(kt=`

Check the top-level render call using <`+Jt+">.")}return kt}}function ms(Q,kt){{if(!Q._store||Q._store.validated||Q.key!=null)return;Q._store.validated=!0;var Jt=Qa(kt);if(Vs[Jt])return;Vs[Jt]=!0;var _e="";Q&&Q._owner&&Q._owner!==na.current&&(_e=" It was passed a child from "+X(Q._owner.type)+"."),_s(Q),Nt('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',Jt,_e),_s(null)}}function _o(Q,kt){{if(typeof Q!="object")return;if(xr(Q))for(var Jt=0;Jt<Q.length;Jt++){var _e=Q[Jt];ra(_e)&&ms(_e,kt)}else if(ra(Q))Q._store&&(Q._store.validated=!0);else if(Q){var rn=wt(Q);if(typeof rn=="function"&&rn!==Q.entries)for(var gn=rn.call(Q),He;!(He=gn.next()).done;)ra(He.value)&&ms(He.value,kt)}}}function El(Q){{var kt=Q.type;if(kt==null||typeof kt=="string")return;var Jt;if(typeof kt=="function")Jt=kt.propTypes;else if(typeof kt=="object"&&(kt.$$typeof===L||kt.$$typeof===tt))Jt=kt.propTypes;else return;if(Jt){var _e=X(kt);Kc(Jt,Q.props,"prop",_e,Q)}else if(kt.PropTypes!==void 0&&!Us){Us=!0;var rn=X(kt);Nt("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",rn||"Unknown")}typeof kt.getDefaultProps=="function"&&!kt.getDefaultProps.isReactClassApproved&&Nt("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Vr(Q){{for(var kt=Object.keys(Q.props),Jt=0;Jt<kt.length;Jt++){var _e=kt[Jt];if(_e!=="children"&&_e!=="key"){_s(Q),Nt("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",_e),_s(null);break}}Q.ref!==null&&(_s(Q),Nt("Invalid attribute `ref` supplied to `React.Fragment`."),_s(null))}}function Fr(Q,kt,Jt,_e,rn,gn){{var He=Z(Q);if(!He){var be="";(Q===void 0||typeof Q=="object"&&Q!==null&&Object.keys(Q).length===0)&&(be+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var gr=xs();gr?be+=gr:be+=Xa();var Jn;Q===null?Jn="null":xr(Q)?Jn="array":Q!==void 0&&Q.$$typeof===s?(Jn="<"+(X(Q.type)||"Unknown")+" />",be=" Did you accidentally export a JSX literal instead of a component?"):Jn=typeof Q,Nt("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",Jn,be)}var wn=mh(Q,kt,Jt,rn,gn);if(wn==null)return wn;if(He){var zr=kt.children;if(zr!==void 0)if(_e)if(xr(zr)){for(var Fs=0;Fs<zr.length;Fs++)_o(zr[Fs],Q);Object.freeze&&Object.freeze(zr)}else Nt("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else _o(zr,Q)}return Q===p?Vr(wn):El(wn),wn}}function ia(Q,kt,Jt){return Fr(Q,kt,Jt,!0)}function sa(Q,kt,Jt){return Fr(Q,kt,Jt,!1)}var $a=sa,gl=ia;Hu.Fragment=p,Hu.jsx=$a,Hu.jsxs=gl}()),Hu}var LI;function NV(){return LI||(LI=1,process.env.NODE_ENV==="production"?tf.exports=bV():tf.exports=OV()),tf.exports}var Ze=NV(),MI={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},UI=Ht.createContext&&Ht.createContext(MI),La=function(){return La=Object.assign||function(u){for(var s,c=1,p=arguments.length;c<p;c++){s=arguments[c];for(var _ in s)Object.prototype.hasOwnProperty.call(s,_)&&(u[_]=s[_])}return u},La.apply(this,arguments)},PV=function(u,s){var c={};for(var p in u)Object.prototype.hasOwnProperty.call(u,p)&&s.indexOf(p)<0&&(c[p]=u[p]);if(u!=null&&typeof Object.getOwnPropertySymbols=="function")for(var _=0,p=Object.getOwnPropertySymbols(u);_<p.length;_++)s.indexOf(p[_])<0&&Object.prototype.propertyIsEnumerable.call(u,p[_])&&(c[p[_]]=u[p[_]]);return c};function xI(u){return u&&u.map(function(s,c){return Ht.createElement(s.tag,La({key:c},s.attr),xI(s.child))})}function cg(u){return function(s){return Ht.createElement(DV,La({attr:La({},u.attr)},s),xI(u.child))}}function DV(u){var s=function(c){var p=u.attr,_=u.size,g=u.title,y=PV(u,["attr","size","title"]),O=_||c.size||"1em",L;return c.className&&(L=c.className),u.className&&(L=(L?L+" ":"")+u.className),Ht.createElement("svg",La({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},c.attr,p,y,{className:L,style:La(La({color:u.color||c.color},c.style),u.style),height:O,width:O,xmlns:"http://www.w3.org/2000/svg"}),g&&Ht.createElement("title",null,g),u.children)};return UI!==void 0?Ht.createElement(UI.Consumer,null,function(c){return s(c)}):s(MI)}function kV(u){return cg({attr:{viewBox:"0 0 576 512"},child:[{tag:"path",attr:{d:"M528 0H48C21.5 0 0 21.5 0 48v320c0 26.5 21.5 48 48 48h192l-16 48h-72c-13.3 0-24 10.7-24 24s10.7 24 24 24h272c13.3 0 24-10.7 24-24s-10.7-24-24-24h-72l-16-48h192c26.5 0 48-21.5 48-48V48c0-26.5-21.5-48-48-48zm-16 352H64V64h448v288z"}}]})(u)}function LV(u){return cg({attr:{viewBox:"0 0 640 512"},child:[{tag:"path",attr:{d:"M633.82 458.1l-157.8-121.96C488.61 312.13 496 285.01 496 256v-48c0-8.84-7.16-16-16-16h-16c-8.84 0-16 7.16-16 16v48c0 17.92-3.96 34.8-10.72 50.2l-26.55-20.52c3.1-9.4 5.28-19.22 5.28-29.67V96c0-53.02-42.98-96-96-96s-96 42.98-96 96v45.36L45.47 3.37C38.49-2.05 28.43-.8 23.01 6.18L3.37 31.45C-2.05 38.42-.8 48.47 6.18 53.9l588.36 454.73c6.98 5.43 17.03 4.17 22.46-2.81l19.64-25.27c5.41-6.97 4.16-17.02-2.82-22.45zM400 464h-56v-33.77c11.66-1.6 22.85-4.54 33.67-8.31l-50.11-38.73c-6.71.4-13.41.87-20.35.2-55.85-5.45-98.74-48.63-111.18-101.85L144 241.31v6.85c0 89.64 63.97 169.55 152 181.69V464h-56c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16z"}}]})(u)}function MV(u){return cg({attr:{viewBox:"0 0 352 512"},child:[{tag:"path",attr:{d:"M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"}}]})(u)}var ef={exports:{}},UV=ef.exports,VI;function xV(){return VI||(VI=1,function(u,s){(function(c,p){u.exports=p()})(UV,function(){function c(t,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(r){if(r!=="default"&&!(r in t)){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}})}),Object.freeze(t)}var p=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof ag<"u"?ag:typeof self<"u"?self:{};function _(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var g=function(t){try{return!!t()}catch{return!0}},y=!g(function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),O=y,L=Function.prototype,V=L.call,G=O&&L.bind.bind(V,V),tt=O?G:function(t){return function(){return V.apply(t,arguments)}},st=tt({}.isPrototypeOf),ht=function(t){return t&&t.Math==Math&&t},yt=ht(typeof globalThis=="object"&&globalThis)||ht(typeof window=="object"&&window)||ht(typeof self=="object"&&self)||ht(typeof p=="object"&&p)||function(){return this}()||p||Function("return this")(),Vt=y,wt=Function.prototype,te=wt.apply,Nt=wt.call,oe=typeof Reflect=="object"&&Reflect.apply||(Vt?Nt.bind(te):function(){return Nt.apply(te,arguments)}),Lt=tt,It=Lt({}.toString),ae=Lt("".slice),J=function(t){return ae(It(t),8,-1)},q=J,K=tt,Z=function(t){if(q(t)==="Function")return K(t)},rt=typeof document=="object"&&document.all,nt={all:rt,IS_HTMLDDA:rt===void 0&&rt!==void 0},X=nt.all,ee=nt.IS_HTMLDDA?function(t){return typeof t=="function"||t===X}:function(t){return typeof t=="function"},xn={},ne=!g(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),nn=y,lr=Function.prototype.call,an=nn?lr.bind(lr):function(){return lr.apply(lr,arguments)},Pt={},zt={}.propertyIsEnumerable,Te=Object.getOwnPropertyDescriptor,Ot=Te&&!zt.call({1:2},1);Pt.f=Ot?function(t){var e=Te(this,t);return!!e&&e.enumerable}:zt;var Bt,re,ie=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},we=g,Zt=J,me=Object,fe=tt("".split),Hn=we(function(){return!me("z").propertyIsEnumerable(0)})?function(t){return Zt(t)=="String"?fe(t,""):me(t)}:me,jt=function(t){return t==null},qr=jt,ps=TypeError,Yr=function(t){if(qr(t))throw ps("Can't call method on "+t);return t},$o=Hn,fl=Yr,Qi=function(t){return $o(fl(t))},po=ee,Kc=nt.all,Ur=nt.IS_HTMLDDA?function(t){return typeof t=="object"?t!==null:po(t)||t===Kc}:function(t){return typeof t=="object"?t!==null:po(t)},xr={},Zo=xr,ta=yt,qc=ee,Er=function(t){return qc(t)?t:void 0},pn=function(t,e){return arguments.length<2?Er(Zo[t])||Er(ta[t]):Zo[t]&&Zo[t][e]||ta[t]&&ta[t][e]},bi=typeof navigator<"u"&&String(navigator.userAgent)||"",Ja=yt,ea=bi,_l=Ja.process,fo=Ja.Deno,Yc=_l&&_l.versions||fo&&fo.version,zc=Yc&&Yc.v8;zc&&(re=(Bt=zc.split("."))[0]>0&&Bt[0]<4?1:+(Bt[0]+Bt[1])),!re&&ea&&(!(Bt=ea.match(/Edge\/(\d+)/))||Bt[1]>=74)&&(Bt=ea.match(/Chrome\/(\d+)/))&&(re=+Bt[1]);var $i=re,ml=$i,mh=g,na=yt.String,fs=!!Object.getOwnPropertySymbols&&!mh(function(){var t=Symbol();return!na(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&ml&&ml<41}),_s=fs&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Us=pn,ra=ee,Xa=st,xs=Object,Vs=_s?function(t){return typeof t=="symbol"}:function(t){var e=Us("Symbol");return ra(e)&&Xa(e.prototype,xs(t))},Qa=String,ms=function(t){try{return Qa(t)}catch{return"Object"}},_o=ee,El=ms,Vr=TypeError,Fr=function(t){if(_o(t))return t;throw Vr(El(t)+" is not a function")},ia=Fr,sa=jt,$a=function(t,e){var n=t[e];return sa(n)?void 0:ia(n)},gl=an,Q=ee,kt=Ur,Jt=TypeError,_e={exports:{}},rn=yt,gn=Object.defineProperty,He=function(t,e){try{gn(rn,t,{value:e,configurable:!0,writable:!0})}catch{rn[t]=e}return e},be="__core-js_shared__",gr=yt[be]||He(be,{}),Jn=gr;(_e.exports=function(t,e){return Jn[t]||(Jn[t]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var wn=_e.exports,zr=Yr,Fs=Object,gi=function(t){return Fs(zr(t))},Zi=gi,Tl=tt({}.hasOwnProperty),or=Object.hasOwn||function(t,e){return Tl(Zi(t),e)},Eh=tt,Jc=0,oa=Math.random(),gh=Eh(1 .toString),Th=function(t){return"Symbol("+(t===void 0?"":t)+")_"+gh(++Jc+oa,36)},Yf=wn,Sh=or,zf=Th,vh=fs,yh=_s,aa=yt.Symbol,Sl=Yf("wks"),UT=yh?aa.for||aa:aa&&aa.withoutSetter||zf,bn=function(t){return Sh(Sl,t)||(Sl[t]=vh&&Sh(aa,t)?aa[t]:UT("Symbol."+t)),Sl[t]},Jf=an,Rh=Ur,Xf=Vs,ca=$a,Bs=function(t,e){var n,r;if(Q(n=t.toString)&&!kt(r=gl(n,t))||Q(n=t.valueOf)&&!kt(r=gl(n,t)))return r;throw Jt("Can't convert object to primitive value")},vl=TypeError,yl=bn("toPrimitive"),Qf=function(t,e){if(!Rh(t)||Xf(t))return t;var n,r=ca(t,yl);if(r){if(n=Jf(r,t,e),!Rh(n)||Xf(n))return n;throw vl("Can't convert object to primitive value")}return Bs(t)},Xn=Vs,da=function(t){var e=Qf(t,"string");return Xn(e)?e:e+""},Za=Ur,la=yt.document,xT=Za(la)&&Za(la.createElement),Rl=function(t){return xT?la.createElement(t):{}},VT=Rl,$f=!ne&&!g(function(){return Object.defineProperty(VT("div"),"a",{get:function(){return 7}}).a!=7}),FT=ne,BT=an,Xc=Pt,mo=ie,Zf=Qi,t_=da,e_=or,tc=$f,n_=Object.getOwnPropertyDescriptor;xn.f=FT?n_:function(t,e){if(t=Zf(t),e=t_(e),tc)try{return n_(t,e)}catch{}if(e_(t,e))return mo(!BT(Xc.f,t,e),t[e])};var jT=g,GT=ee,Eo=/#|\.prototype\./,Qc=function(t,e){var n=Il[WT(t)];return n==r_||n!=Cl&&(GT(e)?jT(e):!!e)},WT=Qc.normalize=function(t){return String(t).replace(Eo,".").toLowerCase()},Il=Qc.data={},Cl=Qc.NATIVE="N",r_=Qc.POLYFILL="P",ec=Qc,$c=Fr,i_=y,Ih=Z(Z.bind),On=function(t,e){return $c(t),e===void 0?t:i_?Ih(t,e):function(){return t.apply(e,arguments)}},xi={},s_=ne&&g(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),o_=Ur,a_=String,c_=TypeError,br=function(t){if(o_(t))return t;throw c_(a_(t)+" is not an object")},d_=ne,js=$f,l_=s_,Al=br,nc=da,u_=TypeError,Zc=Object.defineProperty,wl=Object.getOwnPropertyDescriptor,bl="enumerable",rc="configurable",Ch="writable";xi.f=d_?l_?function(t,e,n){if(Al(t),e=nc(e),Al(n),typeof t=="function"&&e==="prototype"&&"value"in n&&Ch in n&&!n[Ch]){var r=wl(t,e);r&&r[Ch]&&(t[e]=n.value,n={configurable:rc in n?n[rc]:r[rc],enumerable:bl in n?n[bl]:r[bl],writable:!1})}return Zc(t,e,n)}:Zc:function(t,e,n){if(Al(t),e=nc(e),Al(n),js)try{return Zc(t,e,n)}catch{}if("get"in n||"set"in n)throw u_("Accessors not supported");return"value"in n&&(t[e]=n.value),t};var h_=xi,td=ie,Gs=ne?function(t,e,n){return h_.f(t,e,td(1,n))}:function(t,e,n){return t[e]=n,t},ed=yt,Ah=oe,wh=Z,p_=ee,Ol=xn.f,f_=ec,ua=xr,ha=On,pa=Gs,bh=or,__=function(t){var e=function(n,r,i){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,i)}return Ah(t,this,arguments)};return e.prototype=t.prototype,e},Me=function(t,e){var n,r,i,o,a,d,l,h,f,m=t.target,T=t.global,S=t.stat,w=t.proto,I=T?ed:S?ed[m]:(ed[m]||{}).prototype,C=T?ua:ua[m]||pa(ua,m,{})[m],N=C.prototype;for(o in e)r=!(n=f_(T?o:m+(S?".":"#")+o,t.forced))&&I&&bh(I,o),d=C[o],r&&(l=t.dontCallGetSet?(f=Ol(I,o))&&f.value:I[o]),a=r&&l?l:e[o],r&&typeof d==typeof a||(h=t.bind&&r?ha(a,ed):t.wrap&&r?__(a):w&&p_(a)?wh(a):a,(t.sham||a&&a.sham||d&&d.sham)&&pa(h,"sham",!0),pa(C,o,h),w&&(bh(ua,i=m+"Prototype")||pa(ua,i,{}),pa(ua[i],o,a),t.real&&N&&(n||!N[o])&&pa(N,o,a)))},Nl=Math.ceil,Oi=Math.floor,m_=Math.trunc||function(t){var e=+t;return(e>0?Oi:Nl)(e)},E_=m_,go=function(t){var e=+t;return e!=e||e===0?0:E_(e)},E=go,A=Math.max,k=Math.min,B=function(t,e){var n=E(t);return n<0?A(n+e,0):k(n,e)},dt=go,pt=Math.min,Ft=function(t){return t>0?pt(dt(t),9007199254740991):0},Vn=Ft,Qn=function(t){return Vn(t.length)},fn=Qi,Jr=B,Xr=Qn,fa=function(t){return function(e,n,r){var i,o=fn(e),a=Xr(o),d=Jr(r,a);if(t&&n!=n){for(;a>d;)if((i=o[d++])!=i)return!0}else for(;a>d;d++)if((t||d in o)&&o[d]===n)return t||d||0;return!t&&-1}},Ni={includes:fa(!0),indexOf:fa(!1)},Pl=Ni.includes;Me({target:"Array",proto:!0,forced:g(function(){return!Array(1).includes()})},{includes:function(t){return Pl(this,t,arguments.length>1?arguments[1]:void 0)}});var Oh=xr,Es=function(t){return Oh[t+"Prototype"]},AW=Es("Array").includes,wW=Ur,bW=J,OW=bn("match"),tb=function(t){var e;return wW(t)&&((e=t[OW])!==void 0?!!e:bW(t)=="RegExp")},NW=tb,PW=TypeError,eb={};eb[bn("toStringTag")]="z";var HT=String(eb)==="[object z]",DW=HT,kW=ee,g_=J,LW=bn("toStringTag"),MW=Object,UW=g_(function(){return arguments}())=="Arguments",To=DW?g_:function(t){var e,n,r;return t===void 0?"Undefined":t===null?"Null":typeof(n=function(i,o){try{return i[o]}catch{}}(e=MW(t),LW))=="string"?n:UW?g_(e):(r=g_(e))=="Object"&&kW(e.callee)?"Arguments":r},xW=To,VW=String,ts=function(t){if(xW(t)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return VW(t)},FW=bn("match"),BW=Me,jW=function(t){if(NW(t))throw PW("The method doesn't accept regular expressions");return t},GW=Yr,nb=ts,WW=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[FW]=!1,"/./"[t](e)}catch{}}return!1},HW=tt("".indexOf);BW({target:"String",proto:!0,forced:!WW("includes")},{includes:function(t){return!!~HW(nb(GW(this)),nb(jW(t)),arguments.length>1?arguments[1]:void 0)}});var KW=Es("String").includes,rb=st,qW=AW,YW=KW,KT=Array.prototype,qT=String.prototype,zW=function(t){var e=t.includes;return t===KT||rb(KT,t)&&e===KT.includes?qW:typeof t=="string"||t===qT||rb(qT,t)&&e===qT.includes?YW:e},ft=_(zW),JW=Fr,XW=gi,QW=Hn,$W=Qn,ZW=TypeError,t5=function(t){return function(e,n,r,i){JW(n);var o=XW(e),a=QW(o),d=$W(o),l=t?d-1:0,h=t?-1:1;if(r<2)for(;;){if(l in a){i=a[l],l+=h;break}if(l+=h,t?l<0:d<=l)throw ZW("Reduce of empty array with no initial value")}for(;t?l>=0:d>l;l+=h)l in a&&(i=n(i,a[l],l,o));return i}},e5={left:t5(!1)},n5=g,T_=function(t,e){var n=[][t];return!!n&&n5(function(){n.call(null,e||function(){return 1},1)})},Dl=typeof process<"u"&&J(process)=="process",r5=e5.left;Me({target:"Array",proto:!0,forced:!Dl&&$i>79&&$i<83||!T_("reduce")},{reduce:function(t){var e=arguments.length;return r5(this,t,e,e>1?arguments[1]:void 0)}});var i5=Es("Array").reduce,s5=st,o5=i5,YT=Array.prototype,a5=function(t){var e=t.reduce;return t===YT||s5(YT,t)&&e===YT.reduce?o5:e},ib=a5,Ws=_(ib),c5=J,Nh=Array.isArray||function(t){return c5(t)=="Array"},d5=Me,l5=Nh,u5=tt([].reverse),sb=[1,2];d5({target:"Array",proto:!0,forced:String(sb)===String(sb.reverse())},{reverse:function(){return l5(this)&&(this.length=this.length),u5(this)}});var h5=Es("Array").reverse,p5=st,f5=h5,zT=Array.prototype,_5=function(t){var e=t.reverse;return t===zT||p5(zT,t)&&e===zT.reverse?f5:e},ob=_5,ab=_(ob),m5=Th,cb=wn("keys"),S_=function(t){return cb[t]||(cb[t]=m5(t))},E5=!g(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),g5=or,T5=ee,S5=gi,v5=E5,db=S_("IE_PROTO"),JT=Object,y5=JT.prototype,XT=v5?JT.getPrototypeOf:function(t){var e=S5(t);if(g5(e,db))return e[db];var n=e.constructor;return T5(n)&&e instanceof n?n.prototype:e instanceof JT?y5:null},R5=tt,I5=Fr,C5=ee,A5=String,w5=TypeError,b5=function(t,e,n){try{return R5(I5(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}},O5=br,N5=function(t){if(typeof t=="object"||C5(t))return t;throw w5("Can't set "+A5(t)+" as a prototype")},P5=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=b5(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(r,i){return O5(r),N5(i),e?t(r,i):r.__proto__=i,r}}():void 0),v_={},y_={},QT=or,D5=Qi,k5=Ni.indexOf,L5=y_,lb=tt([].push),ub=function(t,e){var n,r=D5(t),i=0,o=[];for(n in r)!QT(L5,n)&&QT(r,n)&&lb(o,n);for(;e.length>i;)QT(r,n=e[i++])&&(~k5(o,n)||lb(o,n));return o},$T=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],M5=ub,U5=$T.concat("length","prototype");v_.f=Object.getOwnPropertyNames||function(t){return M5(t,U5)};var Ph={};Ph.f=Object.getOwnPropertySymbols;var x5=pn,V5=v_,F5=Ph,B5=br,j5=tt([].concat),G5=x5("Reflect","ownKeys")||function(t){var e=V5.f(B5(t)),n=F5.f;return n?j5(e,n(t)):e},hb=or,W5=G5,H5=xn,K5=xi,ZT={},q5=ub,Y5=$T,R_=Object.keys||function(t){return q5(t,Y5)},z5=ne,J5=s_,X5=xi,Q5=br,$5=Qi,Z5=R_;ZT.f=z5&&!J5?Object.defineProperties:function(t,e){Q5(t);for(var n,r=$5(e),i=Z5(e),o=i.length,a=0;o>a;)X5.f(t,n=i[a++],r[n]);return t};var I_,pb=pn("document","documentElement"),t6=br,e6=ZT,fb=$T,n6=y_,r6=pb,i6=Rl,tS="prototype",eS="script",_b=S_("IE_PROTO"),nS=function(){},mb=function(t){return"<"+eS+">"+t+"</"+eS+">"},Eb=function(t){t.write(mb("")),t.close();var e=t.parentWindow.Object;return t=null,e},C_=function(){try{I_=new ActiveXObject("htmlfile")}catch{}var t,e,n;C_=typeof document<"u"?document.domain&&I_?Eb(I_):(e=i6("iframe"),n="java"+eS+":",e.style.display="none",r6.appendChild(e),e.src=String(n),(t=e.contentWindow.document).open(),t.write(mb("document.F=Object")),t.close(),t.F):Eb(I_);for(var r=fb.length;r--;)delete C_[tS][fb[r]];return C_()};n6[_b]=!0;var Dh=Object.create||function(t,e){var n;return t!==null?(nS[tS]=t6(t),n=new nS,nS[tS]=null,n[_b]=t):n=C_(),e===void 0?n:e6.f(n,e)},s6=Ur,o6=Gs,gb=Error,a6=tt("".replace),c6=String(gb("zxcasd").stack),Tb=/\n\s*at [^:]*:[^\n]*/,d6=Tb.test(c6),l6=ie,u6=!g(function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",l6(1,7)),t.stack!==7)}),h6=Gs,p6=function(t,e){if(d6&&typeof t=="string"&&!gb.prepareStackTrace)for(;e--;)t=a6(t,Tb,"");return t},f6=u6,Sb=Error.captureStackTrace,nd={},_6=nd,m6=bn("iterator"),E6=Array.prototype,vb=function(t){return t!==void 0&&(_6.Array===t||E6[m6]===t)},g6=To,yb=$a,T6=jt,S6=nd,v6=bn("iterator"),A_=function(t){if(!T6(t))return yb(t,v6)||yb(t,"@@iterator")||S6[g6(t)]},y6=an,R6=Fr,I6=br,C6=ms,A6=A_,w6=TypeError,rS=function(t,e){var n=arguments.length<2?A6(t):e;if(R6(n))return I6(y6(n,t));throw w6(C6(t)+" is not iterable")},b6=an,Rb=br,O6=$a,Ib=function(t,e,n){var r,i;Rb(t);try{if(!(r=O6(t,"return"))){if(e==="throw")throw n;return n}r=b6(r,t)}catch(o){i=!0,r=o}if(e==="throw")throw n;if(i)throw r;return Rb(r),n},N6=On,P6=an,D6=br,k6=ms,L6=vb,M6=Qn,Cb=st,U6=rS,x6=A_,Ab=Ib,V6=TypeError,w_=function(t,e){this.stopped=t,this.result=e},wb=w_.prototype,kh=function(t,e,n){var r,i,o,a,d,l,h,f=n&&n.that,m=!(!n||!n.AS_ENTRIES),T=!(!n||!n.IS_RECORD),S=!(!n||!n.IS_ITERATOR),w=!(!n||!n.INTERRUPTED),I=N6(e,f),C=function(P){return r&&Ab(r,"normal",P),new w_(!0,P)},N=function(P){return m?(D6(P),w?I(P[0],P[1],C):I(P[0],P[1])):w?I(P,C):I(P)};if(T)r=t.iterator;else if(S)r=t;else{if(!(i=x6(t)))throw V6(k6(t)+" is not iterable");if(L6(i)){for(o=0,a=M6(t);a>o;o++)if((d=N(t[o]))&&Cb(wb,d))return d;return new w_(!1)}r=U6(t,i)}for(l=T?t.next:r.next;!(h=P6(l,r)).done;){try{d=N(h.value)}catch(P){Ab(r,"throw",P)}if(typeof d=="object"&&d&&Cb(wb,d))return d}return new w_(!1)},F6=ts,B6=Me,j6=st,G6=XT,b_=P5,W6=function(t,e,n){for(var r=W5(e),i=K5.f,o=H5.f,a=0;a<r.length;a++){var d=r[a];hb(t,d)||n&&hb(n,d)||i(t,d,o(e,d))}},bb=Dh,iS=Gs,sS=ie,H6=function(t,e){s6(e)&&"cause"in e&&o6(t,"cause",e.cause)},K6=function(t,e,n,r){f6&&(Sb?Sb(t,e):h6(t,"stack",p6(n,r)))},q6=kh,Y6=function(t,e){return t===void 0?arguments.length<2?"":e:F6(t)},z6=bn("toStringTag"),O_=Error,J6=[].push,kl=function(t,e){var n,r=j6(oS,this);b_?n=b_(O_(),r?G6(this):oS):(n=r?this:bb(oS),iS(n,z6,"Error")),e!==void 0&&iS(n,"message",Y6(e)),K6(n,kl,n.stack,1),arguments.length>2&&H6(n,arguments[2]);var i=[];return q6(t,J6,{that:i}),iS(n,"errors",i),n};b_?b_(kl,O_):W6(kl,O_,{name:!0});var oS=kl.prototype=bb(O_.prototype,{constructor:sS(1,kl),message:sS(1,""),name:sS(1,"AggregateError")});B6({global:!0},{AggregateError:kl});var N_,Lh,P_,X6=ee,Ob=yt.WeakMap,Q6=X6(Ob)&&/native code/.test(String(Ob)),Nb=yt,$6=Ur,Z6=Gs,aS=or,cS=gr,tH=S_,eH=y_,Pb="Object already initialized",dS=Nb.TypeError,nH=Nb.WeakMap;if(Q6||cS.state){var So=cS.state||(cS.state=new nH);So.get=So.get,So.has=So.has,So.set=So.set,N_=function(t,e){if(So.has(t))throw dS(Pb);return e.facade=t,So.set(t,e),e},Lh=function(t){return So.get(t)||{}},P_=function(t){return So.has(t)}}else{var Ll=tH("state");eH[Ll]=!0,N_=function(t,e){if(aS(t,Ll))throw dS(Pb);return e.facade=t,Z6(t,Ll,e),e},Lh=function(t){return aS(t,Ll)?t[Ll]:{}},P_=function(t){return aS(t,Ll)}}var rd,Db,kb,id={set:N_,get:Lh,has:P_,enforce:function(t){return P_(t)?Lh(t):N_(t,{})},getterFor:function(t){return function(e){var n;if(!$6(e)||(n=Lh(e)).type!==t)throw dS("Incompatible receiver, "+t+" required");return n}}},lS=ne,rH=or,Lb=Function.prototype,iH=lS&&Object.getOwnPropertyDescriptor,Mb=rH(Lb,"name"),Ub={PROPER:Mb&&(function(){}).name==="something",CONFIGURABLE:Mb&&(!lS||lS&&iH(Lb,"name").configurable)},sH=Gs,ic=function(t,e,n,r){return r&&r.enumerable?t[e]=n:sH(t,e,n),t},oH=g,aH=ee,cH=Ur,dH=Dh,xb=XT,lH=ic,uS=bn("iterator"),Vb=!1;[].keys&&("next"in(kb=[].keys())?(Db=xb(xb(kb)))!==Object.prototype&&(rd=Db):Vb=!0);var uH=!cH(rd)||oH(function(){var t={};return rd[uS].call(t)!==t});aH((rd=uH?{}:dH(rd))[uS])||lH(rd,uS,function(){return this});var Fb={IteratorPrototype:rd,BUGGY_SAFARI_ITERATORS:Vb},hH=To,pH=HT?{}.toString:function(){return"[object "+hH(this)+"]"},fH=HT,_H=xi.f,mH=Gs,EH=or,gH=pH,Bb=bn("toStringTag"),sc=function(t,e,n,r){if(t){var i=n?t:t.prototype;EH(i,Bb)||_H(i,Bb,{configurable:!0,value:e}),r&&!fH&&mH(i,"toString",gH)}},TH=Fb.IteratorPrototype,SH=Dh,vH=ie,yH=sc,RH=nd,IH=function(){return this},hS=function(t,e,n,r){var i=e+" Iterator";return t.prototype=SH(TH,{next:vH(+!r,n)}),yH(t,i,!1,!0),RH[i]=IH,t},CH=Me,AH=an,wH=Ub,bH=hS,OH=XT,NH=sc,jb=ic,Gb=nd,PH=Fb,DH=wH.PROPER,D_=PH.BUGGY_SAFARI_ITERATORS,pS=bn("iterator"),Wb="keys",k_="values",Hb="entries",kH=function(){return this},Kb=function(t,e,n,r,i,o,a){bH(n,e,r);var d,l,h,f=function(N){if(N===i&&I)return I;if(!D_&&N in S)return S[N];switch(N){case Wb:case k_:case Hb:return function(){return new n(this,N)}}return function(){return new n(this)}},m=e+" Iterator",T=!1,S=t.prototype,w=S[pS]||S["@@iterator"]||i&&S[i],I=!D_&&w||f(i),C=e=="Array"&&S.entries||w;if(C&&(d=OH(C.call(new t)))!==Object.prototype&&d.next&&(NH(d,m,!0,!0),Gb[m]=kH),DH&&i==k_&&w&&w.name!==k_&&(T=!0,I=function(){return AH(w,this)}),i)if(l={values:f(k_),keys:o?I:f(Wb),entries:f(Hb)},a)for(h in l)(D_||T||!(h in S))&&jb(S,h,l[h]);else CH({target:e,proto:!0,forced:D_||T},l);return a&&S[pS]!==I&&jb(S,pS,I,{}),Gb[e]=I,l},fS=function(t,e){return{value:t,done:e}},LH=Qi,qb=nd,Yb=id;xi.f;var MH=Kb,zb=fS,Jb="Array Iterator",UH=Yb.set,xH=Yb.getterFor(Jb);MH(Array,"Array",function(t,e){UH(this,{type:Jb,target:LH(t),index:0,kind:e})},function(){var t=xH(this),e=t.target,n=t.kind,r=t.index++;return!e||r>=e.length?(t.target=void 0,zb(void 0,!0)):zb(n=="keys"?r:n=="values"?e[r]:[r,e[r]],!1)},"values"),qb.Arguments=qb.Array;var VH=xi,L_=function(t,e,n){return VH.f(t,e,n)},FH=pn,BH=L_,jH=ne,Xb=bn("species"),GH=st,WH=TypeError,_S=function(t,e){if(GH(e,t))return t;throw WH("Incorrect invocation")},HH=ee,mS=gr,KH=tt(Function.toString);HH(mS.inspectSource)||(mS.inspectSource=function(t){return KH(t)});var Qb=mS.inspectSource,qH=tt,YH=g,$b=ee,zH=To,JH=Qb,Zb=function(){},XH=[],tO=pn("Reflect","construct"),ES=/^\s*(?:class|function)\b/,QH=qH(ES.exec),$H=!ES.exec(Zb),Mh=function(t){if(!$b(t))return!1;try{return tO(Zb,XH,t),!0}catch{return!1}},eO=function(t){if(!$b(t))return!1;switch(zH(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return $H||!!QH(ES,JH(t))}catch{return!0}};eO.sham=!0;var Uh,Ml,nO,gS,M_=!tO||YH(function(){var t;return Mh(Mh.call)||!Mh(Object)||!Mh(function(){t=!0})||t})?eO:Mh,ZH=M_,tK=ms,eK=TypeError,rO=br,nK=function(t){if(ZH(t))return t;throw eK(tK(t)+" is not a constructor")},rK=jt,iK=bn("species"),TS=function(t,e){var n,r=rO(t).constructor;return r===void 0||rK(n=rO(r)[iK])?e:nK(n)},U_=tt([].slice),sK=TypeError,Ul=function(t,e){if(t<e)throw sK("Not enough arguments");return t},iO=/(?:ipad|iphone|ipod).*applewebkit/i.test(bi),es=yt,oK=oe,aK=On,sO=ee,cK=or,oO=g,aO=pb,dK=U_,cO=Rl,lK=Ul,uK=iO,hK=Dl,SS=es.setImmediate,vS=es.clearImmediate,pK=es.process,yS=es.Dispatch,fK=es.Function,dO=es.MessageChannel,_K=es.String,RS=0,xh={},lO="onreadystatechange";oO(function(){Uh=es.location});var IS=function(t){if(cK(xh,t)){var e=xh[t];delete xh[t],e()}},CS=function(t){return function(){IS(t)}},uO=function(t){IS(t.data)},hO=function(t){es.postMessage(_K(t),Uh.protocol+"//"+Uh.host)};SS&&vS||(SS=function(t){lK(arguments.length,1);var e=sO(t)?t:fK(t),n=dK(arguments,1);return xh[++RS]=function(){oK(e,void 0,n)},Ml(RS),RS},vS=function(t){delete xh[t]},hK?Ml=function(t){pK.nextTick(CS(t))}:yS&&yS.now?Ml=function(t){yS.now(CS(t))}:dO&&!uK?(gS=(nO=new dO).port2,nO.port1.onmessage=uO,Ml=aK(gS.postMessage,gS)):es.addEventListener&&sO(es.postMessage)&&!es.importScripts&&Uh&&Uh.protocol!=="file:"&&!oO(hO)?(Ml=hO,es.addEventListener("message",uO,!1)):Ml=lO in cO("script")?function(t){aO.appendChild(cO("script"))[lO]=function(){aO.removeChild(this),IS(t)}}:function(t){setTimeout(CS(t),0)});var x_={set:SS,clear:vS},pO=function(){this.head=null,this.tail=null};pO.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var xl,AS,wS,bS,fO,_O=pO,mK=/ipad|iphone|ipod/i.test(bi)&&typeof Pebble<"u",EK=/web0s(?!.*chrome)/i.test(bi),sd=yt,mO=On,gK=xn.f,OS=x_.set,TK=_O,SK=iO,vK=mK,yK=EK,NS=Dl,EO=sd.MutationObserver||sd.WebKitMutationObserver,gO=sd.document,TO=sd.process,V_=sd.Promise,SO=gK(sd,"queueMicrotask"),PS=SO&&SO.value;if(!PS){var F_=new TK,B_=function(){var t,e;for(NS&&(t=TO.domain)&&t.exit();e=F_.get();)try{e()}catch(n){throw F_.head&&xl(),n}t&&t.enter()};SK||NS||yK||!EO||!gO?!vK&&V_&&V_.resolve?((bS=V_.resolve(void 0)).constructor=V_,fO=mO(bS.then,bS),xl=function(){fO(B_)}):NS?xl=function(){TO.nextTick(B_)}:(OS=mO(OS,sd),xl=function(){OS(B_)}):(AS=!0,wS=gO.createTextNode(""),new EO(B_).observe(wS,{characterData:!0}),xl=function(){wS.data=AS=!AS}),PS=function(t){F_.head||xl(),F_.add(t)}}var vO=PS,Vl=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},od=yt.Promise,yO=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",RK=!yO&&!Dl&&typeof window=="object"&&typeof document=="object",IK=yt,Vh=od,CK=ee,AK=ec,wK=Qb,bK=bn,OK=RK,NK=yO,DS=$i,RO=Vh&&Vh.prototype,PK=bK("species"),IO=CK(IK.PromiseRejectionEvent),DK=AK("Promise",function(){var t=wK(Vh),e=t!==String(Vh);if(!e&&DS===66||!RO.catch||!RO.finally)return!0;if(!DS||DS<51||!/native code/.test(t)){var n=new Vh(function(i){i(1)}),r=function(i){i(function(){},function(){})};if((n.constructor={})[PK]=r,!(n.then(function(){})instanceof r))return!0}return!e&&(OK||NK)&&!IO}),Fh={CONSTRUCTOR:DK,REJECTION_EVENT:IO},vo={},CO=Fr,kK=TypeError,LK=function(t){var e,n;this.promise=new t(function(r,i){if(e!==void 0||n!==void 0)throw kK("Bad Promise constructor");e=r,n=i}),this.resolve=CO(e),this.reject=CO(n)};vo.f=function(t){return new LK(t)};var kS,AO,MK=Me,j_=Dl,oc=yt,Bh=an,UK=ic,xK=sc,VK=function(t){var e=FH(t);jH&&e&&!e[Xb]&&BH(e,Xb,{configurable:!0,get:function(){return this}})},FK=Fr,LS=ee,BK=Ur,jK=_S,GK=TS,wO=x_.set,MS=vO,WK=function(t,e){try{arguments.length==1?console.error(t):console.error(t,e)}catch{}},HK=Vl,KK=_O,bO=id,US=od,OO=Fh,NO=vo,G_="Promise",PO=OO.CONSTRUCTOR,qK=OO.REJECTION_EVENT,xS=bO.getterFor(G_),YK=bO.set,zK=US&&US.prototype,jh=US,VS=zK,DO=oc.TypeError,FS=oc.document,BS=oc.process,jS=NO.f,JK=jS,XK=!!(FS&&FS.createEvent&&oc.dispatchEvent),kO="unhandledrejection",LO=function(t){var e;return!(!BK(t)||!LS(e=t.then))&&e},MO=function(t,e){var n,r,i,o=e.value,a=e.state==1,d=a?t.ok:t.fail,l=t.resolve,h=t.reject,f=t.domain;try{d?(a||(e.rejection===2&&$K(e),e.rejection=1),d===!0?n=o:(f&&f.enter(),n=d(o),f&&(f.exit(),i=!0)),n===t.promise?h(DO("Promise-chain cycle")):(r=LO(n))?Bh(r,n,l,h):l(n)):h(o)}catch(m){f&&!i&&f.exit(),h(m)}},UO=function(t,e){t.notified||(t.notified=!0,MS(function(){for(var n,r=t.reactions;n=r.get();)MO(n,t);t.notified=!1,e&&!t.rejection&&QK(t)}))},xO=function(t,e,n){var r,i;XK?((r=FS.createEvent("Event")).promise=e,r.reason=n,r.initEvent(t,!1,!0),oc.dispatchEvent(r)):r={promise:e,reason:n},!qK&&(i=oc["on"+t])?i(r):t===kO&&WK("Unhandled promise rejection",n)},QK=function(t){Bh(wO,oc,function(){var e,n=t.facade,r=t.value;if(VO(t)&&(e=HK(function(){j_?BS.emit("unhandledRejection",r,n):xO(kO,n,r)}),t.rejection=j_||VO(t)?2:1,e.error))throw e.value})},VO=function(t){return t.rejection!==1&&!t.parent},$K=function(t){Bh(wO,oc,function(){var e=t.facade;j_?BS.emit("rejectionHandled",e):xO("rejectionhandled",e,t.value)})},Fl=function(t,e,n){return function(r){t(e,r,n)}},Bl=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,UO(t,!0))},GS=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw DO("Promise can't be resolved itself");var r=LO(e);r?MS(function(){var i={done:!1};try{Bh(r,e,Fl(GS,i,t),Fl(Bl,i,t))}catch(o){Bl(i,o,t)}}):(t.value=e,t.state=1,UO(t,!1))}catch(i){Bl({done:!1},i,t)}}};PO&&(VS=(jh=function(t){jK(this,VS),FK(t),Bh(kS,this);var e=xS(this);try{t(Fl(GS,e),Fl(Bl,e))}catch(n){Bl(e,n)}}).prototype,(kS=function(t){YK(this,{type:G_,done:!1,notified:!1,parent:!1,reactions:new KK,rejection:!1,state:0,value:void 0})}).prototype=UK(VS,"then",function(t,e){var n=xS(this),r=jS(GK(this,jh));return n.parent=!0,r.ok=!LS(t)||t,r.fail=LS(e)&&e,r.domain=j_?BS.domain:void 0,n.state==0?n.reactions.add(r):MS(function(){MO(r,n)}),r.promise}),AO=function(){var t=new kS,e=xS(t);this.promise=t,this.resolve=Fl(GS,e),this.reject=Fl(Bl,e)},NO.f=jS=function(t){return t===jh||t===void 0?new AO(t):JK(t)}),MK({global:!0,wrap:!0,forced:PO},{Promise:jh}),xK(jh,G_,!1,!0),VK(G_);var FO=bn("iterator"),BO=!1;try{var ZK=0,jO={next:function(){return{done:!!ZK++}},return:function(){BO=!0}};jO[FO]=function(){return this},Array.from(jO,function(){throw 2})}catch{}var tq=od,eq=function(t,e){if(!BO)return!1;var n=!1;try{var r={};r[FO]=function(){return{next:function(){return{done:n=!0}}}},t(r)}catch{}return n},W_=Fh.CONSTRUCTOR||!eq(function(t){tq.all(t).then(void 0,function(){})}),nq=an,rq=Fr,iq=vo,sq=Vl,oq=kh;Me({target:"Promise",stat:!0,forced:W_},{all:function(t){var e=this,n=iq.f(e),r=n.resolve,i=n.reject,o=sq(function(){var a=rq(e.resolve),d=[],l=0,h=1;oq(t,function(f){var m=l++,T=!1;h++,nq(a,e,f).then(function(S){T||(T=!0,d[m]=S,--h||r(d))},i)}),--h||r(d)});return o.error&&i(o.value),n.promise}});var aq=Me,cq=Fh.CONSTRUCTOR;od&&od.prototype,aq({target:"Promise",proto:!0,forced:cq,real:!0},{catch:function(t){return this.then(void 0,t)}});var dq=an,lq=Fr,uq=vo,hq=Vl,pq=kh;Me({target:"Promise",stat:!0,forced:W_},{race:function(t){var e=this,n=uq.f(e),r=n.reject,i=hq(function(){var o=lq(e.resolve);pq(t,function(a){dq(o,e,a).then(n.resolve,r)})});return i.error&&r(i.value),n.promise}});var fq=an,_q=vo;Me({target:"Promise",stat:!0,forced:Fh.CONSTRUCTOR},{reject:function(t){var e=_q.f(this);return fq(e.reject,void 0,t),e.promise}});var mq=br,Eq=Ur,gq=vo,GO=function(t,e){if(mq(t),Eq(e)&&e.constructor===t)return e;var n=gq.f(t);return(0,n.resolve)(e),n.promise},Tq=Me,Sq=od,vq=Fh.CONSTRUCTOR,yq=GO,Rq=pn("Promise"),Iq=!vq;Tq({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return yq(Iq&&this===Rq?Sq:this,t)}});var Cq=an,Aq=Fr,wq=vo,bq=Vl,Oq=kh;Me({target:"Promise",stat:!0,forced:W_},{allSettled:function(t){var e=this,n=wq.f(e),r=n.resolve,i=n.reject,o=bq(function(){var a=Aq(e.resolve),d=[],l=0,h=1;Oq(t,function(f){var m=l++,T=!1;h++,Cq(a,e,f).then(function(S){T||(T=!0,d[m]={status:"fulfilled",value:S},--h||r(d))},function(S){T||(T=!0,d[m]={status:"rejected",reason:S},--h||r(d))})}),--h||r(d)});return o.error&&i(o.value),n.promise}});var Nq=an,Pq=Fr,Dq=pn,kq=vo,Lq=Vl,Mq=kh,WO="No one promise resolved";Me({target:"Promise",stat:!0,forced:W_},{any:function(t){var e=this,n=Dq("AggregateError"),r=kq.f(e),i=r.resolve,o=r.reject,a=Lq(function(){var d=Pq(e.resolve),l=[],h=0,f=1,m=!1;Mq(t,function(T){var S=h++,w=!1;f++,Nq(d,e,T).then(function(I){w||m||(m=!0,i(I))},function(I){w||m||(w=!0,l[S]=I,--f||o(new n(l,WO)))})}),--f||o(new n(l,WO))});return a.error&&o(a.value),r.promise}});var Uq=Me,WS=od,xq=g,Vq=pn,Fq=ee,Bq=TS,HO=GO,jq=WS&&WS.prototype;Uq({target:"Promise",proto:!0,real:!0,forced:!!WS&&xq(function(){jq.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=Bq(this,Vq("Promise")),n=Fq(t);return this.then(n?function(r){return HO(e,t()).then(function(){return r})}:t,n?function(r){return HO(e,t()).then(function(){throw r})}:t)}});var HS=tt,Gq=go,Wq=ts,Hq=Yr,Kq=HS("".charAt),KO=HS("".charCodeAt),qq=HS("".slice),qO=function(t){return function(e,n){var r,i,o=Wq(Hq(e)),a=Gq(n),d=o.length;return a<0||a>=d?t?"":void 0:(r=KO(o,a))<55296||r>56319||a+1===d||(i=KO(o,a+1))<56320||i>57343?t?Kq(o,a):r:t?qq(o,a,a+2):i-56320+(r-55296<<10)+65536}},KS={codeAt:qO(!1),charAt:qO(!0)},Yq=KS.charAt,zq=ts,YO=id,Jq=Kb,zO=fS,JO="String Iterator",Xq=YO.set,Qq=YO.getterFor(JO);Jq(String,"String",function(t){Xq(this,{type:JO,string:zq(t),index:0})},function(){var t,e=Qq(this),n=e.string,r=e.index;return r>=n.length?zO(void 0,!0):(t=Yq(n,r),e.index+=t.length,zO(t,!1))});var $q=xr.Promise,Zq={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},t9=yt,e9=To,n9=Gs,XO=nd,QO=bn("toStringTag");for(var qS in Zq){var $O=t9[qS],YS=$O&&$O.prototype;YS&&e9(YS)!==QO&&n9(YS,QO,qS),XO[qS]=XO.Array}var ZO=$q,mt=_(ZO),r9=Es("Array").values,i9=To,s9=or,o9=st,a9=r9,zS=Array.prototype,c9={DOMTokenList:!0,NodeList:!0},d9=function(t){var e=t.values;return t===zS||o9(zS,t)&&e===zS.values||s9(c9,i9(t))?a9:e},Vi=_(d9),l9=g,u9=bn("iterator"),JS=!l9(function(){var t=new URL("b?a=1&b=2&c=3","http://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2"),r="";return t.pathname="c%20d",e.forEach(function(i,o){e.delete("b"),r+=o+i}),n.delete("a",2),!t.toJSON||!n.has("a",1)||n.has("a",2)||!e.size&&!0||!e.sort||t.href!=="http://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[u9]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://тест").host!=="xn--e1aybc"||new URL("http://a#б").hash!=="#%D0%B1"||r!=="a1c3"||new URL("http://x",void 0).host!=="x"}),h9=ic,p9=da,f9=xi,_9=ie,H_=function(t,e,n){var r=p9(e);r in t?f9.f(t,r,_9(0,n)):t[r]=n},t0=B,m9=Qn,E9=H_,g9=Array,T9=Math.max,XS=function(t,e,n){for(var r=m9(t),i=t0(e,r),o=t0(n===void 0?r:n,r),a=g9(T9(o-i,0)),d=0;i<o;i++,d++)E9(a,d,t[i]);return a.length=d,a},e0=XS,S9=Math.floor,QS=function(t,e){var n=t.length,r=S9(n/2);return n<8?v9(t,e):y9(t,QS(e0(t,0,r),e),QS(e0(t,r),e),e)},v9=function(t,e){for(var n,r,i=t.length,o=1;o<i;){for(r=o,n=t[o];r&&e(t[r-1],n)>0;)t[r]=t[--r];r!==o++&&(t[r]=n)}return t},y9=function(t,e,n,r){for(var i=e.length,o=n.length,a=0,d=0;a<i||d<o;)t[a+d]=a<i&&d<o?r(e[a],n[d])<=0?e[a++]:n[d++]:a<i?e[a++]:n[d++];return t},n0=QS,$S=Me,jl=yt,K_=an,yo=tt,Gl=ne,r0=JS,i0=ic,R9=L_,I9=function(t,e,n){for(var r in e)n&&n.unsafe&&t[r]?t[r]=e[r]:h9(t,r,e[r],n);return t},C9=sc,A9=hS,ZS=id,s0=_S,tv=ee,w9=or,b9=On,O9=To,N9=br,o0=Ur,Pi=ts,P9=Dh,a0=ie,ev=rS,D9=A_,Wl=Ul,k9=n0,L9=bn("iterator"),Gh="URLSearchParams",c0=Gh+"Iterator",d0=ZS.set,gs=ZS.getterFor(Gh),M9=ZS.getterFor(c0),U9=Object.getOwnPropertyDescriptor,nv=function(t){if(!Gl)return jl[t];var e=U9(jl,t);return e&&e.value},l0=nv("fetch"),q_=nv("Request"),Wh=nv("Headers"),rv=q_&&q_.prototype,u0=Wh&&Wh.prototype,x9=jl.RegExp,V9=jl.TypeError,h0=jl.decodeURIComponent,F9=jl.encodeURIComponent,B9=yo("".charAt),p0=yo([].join),ad=yo([].push),iv=yo("".replace),j9=yo([].shift),f0=yo([].splice),_0=yo("".split),G9=yo("".slice),W9=/\+/g,m0=Array(4),H9=function(t){return m0[t-1]||(m0[t-1]=x9("((?:%[\\da-f]{2}){"+t+"})","gi"))},K9=function(t){try{return h0(t)}catch{return t}},E0=function(t){var e=iv(t,W9," "),n=4;try{return h0(e)}catch{for(;n;)e=iv(e,H9(n--),K9);return e}},q9=/[!'()~]|%20/g,Y9={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},z9=function(t){return Y9[t]},g0=function(t){return iv(F9(t),q9,z9)},sv=A9(function(t,e){d0(this,{type:c0,iterator:ev(gs(t).entries),kind:e})},"Iterator",function(){var t=M9(this),e=t.kind,n=t.iterator.next(),r=n.value;return n.done||(n.value=e==="keys"?r.key:e==="values"?r.value:[r.key,r.value]),n},!0),T0=function(t){this.entries=[],this.url=null,t!==void 0&&(o0(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?B9(t,0)==="?"?G9(t,1):t:Pi(t)))};T0.prototype={type:Gh,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,r,i,o,a,d,l=D9(t);if(l)for(n=(e=ev(t,l)).next;!(r=K_(n,e)).done;){if(o=(i=ev(N9(r.value))).next,(a=K_(o,i)).done||(d=K_(o,i)).done||!K_(o,i).done)throw V9("Expected sequence with length 2");ad(this.entries,{key:Pi(a.value),value:Pi(d.value)})}else for(var h in t)w9(t,h)&&ad(this.entries,{key:h,value:Pi(t[h])})},parseQuery:function(t){if(t)for(var e,n,r=_0(t,"&"),i=0;i<r.length;)(e=r[i++]).length&&(n=_0(e,"="),ad(this.entries,{key:E0(j9(n)),value:E0(p0(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],r=0;r<e.length;)t=e[r++],ad(n,g0(t.key)+"="+g0(t.value));return p0(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Y_=function(){s0(this,Hl);var t=d0(this,new T0(arguments.length>0?arguments[0]:void 0));Gl||(this.size=t.entries.length)},Hl=Y_.prototype;if(I9(Hl,{append:function(t,e){var n=gs(this);Wl(arguments.length,2),ad(n.entries,{key:Pi(t),value:Pi(e)}),Gl||this.length++,n.updateURL()},delete:function(t){for(var e=gs(this),n=Wl(arguments.length,1),r=e.entries,i=Pi(t),o=n<2?void 0:arguments[1],a=o===void 0?o:Pi(o),d=0;d<r.length;){var l=r[d];if(l.key!==i||a!==void 0&&l.value!==a)d++;else if(f0(r,d,1),a!==void 0)break}Gl||(this.size=r.length),e.updateURL()},get:function(t){var e=gs(this).entries;Wl(arguments.length,1);for(var n=Pi(t),r=0;r<e.length;r++)if(e[r].key===n)return e[r].value;return null},getAll:function(t){var e=gs(this).entries;Wl(arguments.length,1);for(var n=Pi(t),r=[],i=0;i<e.length;i++)e[i].key===n&&ad(r,e[i].value);return r},has:function(t){for(var e=gs(this).entries,n=Wl(arguments.length,1),r=Pi(t),i=n<2?void 0:arguments[1],o=i===void 0?i:Pi(i),a=0;a<e.length;){var d=e[a++];if(d.key===r&&(o===void 0||d.value===o))return!0}return!1},set:function(t,e){var n=gs(this);Wl(arguments.length,1);for(var r,i=n.entries,o=!1,a=Pi(t),d=Pi(e),l=0;l<i.length;l++)(r=i[l]).key===a&&(o?f0(i,l--,1):(o=!0,r.value=d));o||ad(i,{key:a,value:d}),Gl||(this.size=i.length),n.updateURL()},sort:function(){var t=gs(this);k9(t.entries,function(e,n){return e.key>n.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,n=gs(this).entries,r=b9(t,arguments.length>1?arguments[1]:void 0),i=0;i<n.length;)r((e=n[i++]).value,e.key,this)},keys:function(){return new sv(this,"keys")},values:function(){return new sv(this,"values")},entries:function(){return new sv(this,"entries")}},{enumerable:!0}),i0(Hl,L9,Hl.entries,{}),i0(Hl,"toString",function(){return gs(this).serialize()},{enumerable:!0}),Gl&&R9(Hl,"size",{get:function(){return gs(this).entries.length},configurable:!0,enumerable:!0}),C9(Y_,Gh),$S({global:!0,forced:!r0},{URLSearchParams:Y_}),!r0&&tv(Wh)){var J9=yo(u0.has),X9=yo(u0.set),S0=function(t){if(o0(t)){var e,n=t.body;if(O9(n)===Gh)return e=t.headers?new Wh(t.headers):new Wh,J9(e,"content-type")||X9(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),P9(t,{body:a0(0,Pi(n)),headers:a0(0,e)})}return t};if(tv(l0)&&$S({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return l0(t,arguments.length>1?S0(arguments[1]):{})}}),tv(q_)){var ov=function(t){return s0(this,rv),new q_(t,arguments.length>1?S0(arguments[1]):{})};rv.constructor=ov,ov.prototype=rv,$S({global:!0,dontCallGetSet:!0,forced:!0},{Request:ov})}}var Ts,Q9={URLSearchParams:Y_,getState:gs},$9=xr.URLSearchParams,v0=ne,Z9=tt,tY=an,eY=g,av=R_,nY=Ph,rY=Pt,iY=gi,sY=Hn,Kl=Object.assign,y0=Object.defineProperty,oY=Z9([].concat),aY=!Kl||eY(function(){if(v0&&Kl({b:1},Kl(y0({},"a",{enumerable:!0,get:function(){y0(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},n=Symbol(),r="abcdefghijklmnopqrst";return t[n]=7,r.split("").forEach(function(i){e[i]=i}),Kl({},t)[n]!=7||av(Kl({},e)).join("")!=r})?function(t,e){for(var n=iY(t),r=arguments.length,i=1,o=nY.f,a=rY.f;r>i;)for(var d,l=sY(arguments[i++]),h=o?oY(av(l),o(l)):av(l),f=h.length,m=0;f>m;)d=h[m++],v0&&!tY(a,l,d)||(n[d]=l[d]);return n}:Kl,cY=br,dY=Ib,lY=On,uY=an,hY=gi,pY=function(t,e,n,r){try{return r?e(cY(n)[0],n[1]):e(n)}catch(i){dY(t,"throw",i)}},fY=vb,_Y=M_,mY=Qn,R0=H_,EY=rS,gY=A_,I0=Array,cd=tt,cv=2147483647,TY=/[^\0-\u007E]/,C0=/[.\u3002\uFF0E\uFF61]/g,A0="Overflow: input needs wider integers to process",w0=RangeError,SY=cd(C0.exec),ql=Math.floor,dv=String.fromCharCode,b0=cd("".charCodeAt),O0=cd([].join),ac=cd([].push),vY=cd("".replace),yY=cd("".split),RY=cd("".toLowerCase),N0=function(t){return t+22+75*(t<26)},IY=function(t,e,n){var r=0;for(t=n?ql(t/700):t>>1,t+=ql(t/e);t>455;)t=ql(t/35),r+=36;return ql(r+36*t/(t+38))},CY=function(t){var e=[];t=function(N){for(var P=[],x=0,W=N.length;x<W;){var H=b0(N,x++);if(H>=55296&&H<=56319&&x<W){var j=b0(N,x++);(64512&j)==56320?ac(P,((1023&H)<<10)+(1023&j)+65536):(ac(P,H),x--)}else ac(P,H)}return P}(t);var n,r,i=t.length,o=128,a=0,d=72;for(n=0;n<t.length;n++)(r=t[n])<128&&ac(e,dv(r));var l=e.length,h=l;for(l&&ac(e,"-");h<i;){var f=cv;for(n=0;n<t.length;n++)(r=t[n])>=o&&r<f&&(f=r);var m=h+1;if(f-o>ql((cv-a)/m))throw w0(A0);for(a+=(f-o)*m,o=f,n=0;n<t.length;n++){if((r=t[n])<o&&++a>cv)throw w0(A0);if(r==o){for(var T=a,S=36;;){var w=S<=d?1:S>=d+26?26:S-d;if(T<w)break;var I=T-w,C=36-w;ac(e,dv(N0(w+I%C))),T=ql(I/C),S+=36}ac(e,dv(N0(T))),d=IY(a,m,h==l),a=0,h++}}a++,o++}return O0(e,"")},AY=Me,lv=ne,wY=JS,uv=yt,P0=On,Ss=tt,z_=ic,vs=L_,bY=_S,hv=or,pv=aY,Yl=function(t){var e=hY(t),n=_Y(this),r=arguments.length,i=r>1?arguments[1]:void 0,o=i!==void 0;o&&(i=lY(i,r>2?arguments[2]:void 0));var a,d,l,h,f,m,T=gY(e),S=0;if(!T||this===I0&&fY(T))for(a=mY(e),d=n?new this(a):I0(a);a>S;S++)m=o?i(e[S],S):e[S],R0(d,S,m);else for(f=(h=EY(e,T)).next,d=n?new this:[];!(l=uY(f,h)).done;S++)m=o?pY(h,i,[l.value,S],!0):l.value,R0(d,S,m);return d.length=S,d},Hs=XS,OY=KS.codeAt,NY=function(t){var e,n,r=[],i=yY(vY(RY(t),C0,"."),".");for(e=0;e<i.length;e++)n=i[e],ac(r,SY(TY,n)?"xn--"+CY(n):n);return O0(r,".")},_a=ts,PY=sc,DY=Ul,D0=Q9,k0=id,kY=k0.set,J_=k0.getterFor("URL"),LY=D0.URLSearchParams,MY=D0.getState,Hh=uv.URL,fv=uv.TypeError,X_=uv.parseInt,UY=Math.floor,L0=Math.pow,ys=Ss("".charAt),Ks=Ss(/./.exec),Kh=Ss([].join),xY=Ss(1 .toString),VY=Ss([].pop),zl=Ss([].push),_v=Ss("".replace),FY=Ss([].shift),BY=Ss("".split),qh=Ss("".slice),Q_=Ss("".toLowerCase),jY=Ss([].unshift),mv="Invalid scheme",dd="Invalid host",M0="Invalid port",U0=/[a-z]/i,GY=/[\d+-.a-z]/i,Ev=/\d/,WY=/^0x/i,HY=/^[0-7]+$/,KY=/^\d+$/,x0=/^[\da-f]+$/i,qY=/[\0\t\n\r #%/:<>?@[\\\]^|]/,YY=/[\0\t\n\r #/:<>?@[\\\]^|]/,zY=/^[\u0000-\u0020]+/,JY=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,XY=/[\t\n\r]/g,Yh=function(t){var e,n,r,i;if(typeof t=="number"){for(e=[],n=0;n<4;n++)jY(e,t%256),t=UY(t/256);return Kh(e,".")}if(typeof t=="object"){for(e="",r=function(o){for(var a=null,d=1,l=null,h=0,f=0;f<8;f++)o[f]!==0?(h>d&&(a=l,d=h),l=null,h=0):(l===null&&(l=f),++h);return h>d&&(a=l,d=h),a}(t),n=0;n<8;n++)i&&t[n]===0||(i&&(i=!1),r===n?(e+=n?":":"::",i=!0):(e+=xY(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},$_={},V0=pv({},$_,{" ":1,'"':1,"<":1,">":1,"`":1}),F0=pv({},V0,{"#":1,"?":1,"{":1,"}":1}),gv=pv({},F0,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),cc=function(t,e){var n=OY(t,0);return n>32&&n<127&&!hv(e,t)?t:encodeURIComponent(t)},Z_={ftp:21,file:null,http:80,https:443,ws:80,wss:443},zh=function(t,e){var n;return t.length==2&&Ks(U0,ys(t,0))&&((n=ys(t,1))==":"||!e&&n=="|")},B0=function(t){var e;return t.length>1&&zh(qh(t,0,2))&&(t.length==2||(e=ys(t,2))==="/"||e==="\\"||e==="?"||e==="#")},QY=function(t){return t==="."||Q_(t)==="%2e"},Tv={},j0={},Sv={},G0={},W0={},vv={},H0={},K0={},tm={},em={},yv={},Rv={},Iv={},Cv={},q0={},Av={},Jl={},Ro={},Y0={},ld={},ma={},wv=function(t,e,n){var r,i,o,a=_a(t);if(e){if(i=this.parse(a))throw fv(i);this.searchParams=null}else{if(n!==void 0&&(r=new wv(n,!0)),i=this.parse(a,null,r))throw fv(i);(o=MY(new LY)).bindURL(this),this.searchParams=o}};wv.prototype={type:"URL",parse:function(t,e,n){var r,i,o,a,d,l=this,h=e||Tv,f=0,m="",T=!1,S=!1,w=!1;for(t=_a(t),e||(l.scheme="",l.username="",l.password="",l.host=null,l.port=null,l.path=[],l.query=null,l.fragment=null,l.cannotBeABaseURL=!1,t=_v(t,zY,""),t=_v(t,JY,"$1")),t=_v(t,XY,""),r=Yl(t);f<=r.length;){switch(i=r[f],h){case Tv:if(!i||!Ks(U0,i)){if(e)return mv;h=Sv;continue}m+=Q_(i),h=j0;break;case j0:if(i&&(Ks(GY,i)||i=="+"||i=="-"||i=="."))m+=Q_(i);else{if(i!=":"){if(e)return mv;m="",h=Sv,f=0;continue}if(e&&(l.isSpecial()!=hv(Z_,m)||m=="file"&&(l.includesCredentials()||l.port!==null)||l.scheme=="file"&&!l.host))return;if(l.scheme=m,e)return void(l.isSpecial()&&Z_[l.scheme]==l.port&&(l.port=null));m="",l.scheme=="file"?h=Cv:l.isSpecial()&&n&&n.scheme==l.scheme?h=G0:l.isSpecial()?h=K0:r[f+1]=="/"?(h=W0,f++):(l.cannotBeABaseURL=!0,zl(l.path,""),h=Y0)}break;case Sv:if(!n||n.cannotBeABaseURL&&i!="#")return mv;if(n.cannotBeABaseURL&&i=="#"){l.scheme=n.scheme,l.path=Hs(n.path),l.query=n.query,l.fragment="",l.cannotBeABaseURL=!0,h=ma;break}h=n.scheme=="file"?Cv:vv;continue;case G0:if(i!="/"||r[f+1]!="/"){h=vv;continue}h=tm,f++;break;case W0:if(i=="/"){h=em;break}h=Ro;continue;case vv:if(l.scheme=n.scheme,i==Ts)l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Hs(n.path),l.query=n.query;else if(i=="/"||i=="\\"&&l.isSpecial())h=H0;else if(i=="?")l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Hs(n.path),l.query="",h=ld;else{if(i!="#"){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Hs(n.path),l.path.length--,h=Ro;continue}l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=Hs(n.path),l.query=n.query,l.fragment="",h=ma}break;case H0:if(!l.isSpecial()||i!="/"&&i!="\\"){if(i!="/"){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,h=Ro;continue}h=em}else h=tm;break;case K0:if(h=tm,i!="/"||ys(m,f+1)!="/")continue;f++;break;case tm:if(i!="/"&&i!="\\"){h=em;continue}break;case em:if(i=="@"){T&&(m="%40"+m),T=!0,o=Yl(m);for(var I=0;I<o.length;I++){var C=o[I];if(C!=":"||w){var N=cc(C,gv);w?l.password+=N:l.username+=N}else w=!0}m=""}else if(i==Ts||i=="/"||i=="?"||i=="#"||i=="\\"&&l.isSpecial()){if(T&&m=="")return"Invalid authority";f-=Yl(m).length+1,m="",h=yv}else m+=i;break;case yv:case Rv:if(e&&l.scheme=="file"){h=Av;continue}if(i!=":"||S){if(i==Ts||i=="/"||i=="?"||i=="#"||i=="\\"&&l.isSpecial()){if(l.isSpecial()&&m=="")return dd;if(e&&m==""&&(l.includesCredentials()||l.port!==null))return;if(a=l.parseHost(m))return a;if(m="",h=Jl,e)return;continue}i=="["?S=!0:i=="]"&&(S=!1),m+=i}else{if(m=="")return dd;if(a=l.parseHost(m))return a;if(m="",h=Iv,e==Rv)return}break;case Iv:if(!Ks(Ev,i)){if(i==Ts||i=="/"||i=="?"||i=="#"||i=="\\"&&l.isSpecial()||e){if(m!=""){var P=X_(m,10);if(P>65535)return M0;l.port=l.isSpecial()&&P===Z_[l.scheme]?null:P,m=""}if(e)return;h=Jl;continue}return M0}m+=i;break;case Cv:if(l.scheme="file",i=="/"||i=="\\")h=q0;else{if(!n||n.scheme!="file"){h=Ro;continue}if(i==Ts)l.host=n.host,l.path=Hs(n.path),l.query=n.query;else if(i=="?")l.host=n.host,l.path=Hs(n.path),l.query="",h=ld;else{if(i!="#"){B0(Kh(Hs(r,f),""))||(l.host=n.host,l.path=Hs(n.path),l.shortenPath()),h=Ro;continue}l.host=n.host,l.path=Hs(n.path),l.query=n.query,l.fragment="",h=ma}}break;case q0:if(i=="/"||i=="\\"){h=Av;break}n&&n.scheme=="file"&&!B0(Kh(Hs(r,f),""))&&(zh(n.path[0],!0)?zl(l.path,n.path[0]):l.host=n.host),h=Ro;continue;case Av:if(i==Ts||i=="/"||i=="\\"||i=="?"||i=="#"){if(!e&&zh(m))h=Ro;else if(m==""){if(l.host="",e)return;h=Jl}else{if(a=l.parseHost(m))return a;if(l.host=="localhost"&&(l.host=""),e)return;m="",h=Jl}continue}m+=i;break;case Jl:if(l.isSpecial()){if(h=Ro,i!="/"&&i!="\\")continue}else if(e||i!="?")if(e||i!="#"){if(i!=Ts&&(h=Ro,i!="/"))continue}else l.fragment="",h=ma;else l.query="",h=ld;break;case Ro:if(i==Ts||i=="/"||i=="\\"&&l.isSpecial()||!e&&(i=="?"||i=="#")){if((d=Q_(d=m))===".."||d==="%2e."||d===".%2e"||d==="%2e%2e"?(l.shortenPath(),i=="/"||i=="\\"&&l.isSpecial()||zl(l.path,"")):QY(m)?i=="/"||i=="\\"&&l.isSpecial()||zl(l.path,""):(l.scheme=="file"&&!l.path.length&&zh(m)&&(l.host&&(l.host=""),m=ys(m,0)+":"),zl(l.path,m)),m="",l.scheme=="file"&&(i==Ts||i=="?"||i=="#"))for(;l.path.length>1&&l.path[0]==="";)FY(l.path);i=="?"?(l.query="",h=ld):i=="#"&&(l.fragment="",h=ma)}else m+=cc(i,F0);break;case Y0:i=="?"?(l.query="",h=ld):i=="#"?(l.fragment="",h=ma):i!=Ts&&(l.path[0]+=cc(i,$_));break;case ld:e||i!="#"?i!=Ts&&(i=="'"&&l.isSpecial()?l.query+="%27":l.query+=i=="#"?"%23":cc(i,$_)):(l.fragment="",h=ma);break;case ma:i!=Ts&&(l.fragment+=cc(i,V0))}f++}},parseHost:function(t){var e,n,r;if(ys(t,0)=="["){if(ys(t,t.length-1)!="]"||(e=function(i){var o,a,d,l,h,f,m,T=[0,0,0,0,0,0,0,0],S=0,w=null,I=0,C=function(){return ys(i,I)};if(C()==":"){if(ys(i,1)!=":")return;I+=2,w=++S}for(;C();){if(S==8)return;if(C()!=":"){for(o=a=0;a<4&&Ks(x0,C());)o=16*o+X_(C(),16),I++,a++;if(C()=="."){if(a==0||(I-=a,S>6))return;for(d=0;C();){if(l=null,d>0){if(!(C()=="."&&d<4))return;I++}if(!Ks(Ev,C()))return;for(;Ks(Ev,C());){if(h=X_(C(),10),l===null)l=h;else{if(l==0)return;l=10*l+h}if(l>255)return;I++}T[S]=256*T[S]+l,++d!=2&&d!=4||S++}if(d!=4)return;break}if(C()==":"){if(I++,!C())return}else if(C())return;T[S++]=o}else{if(w!==null)return;I++,w=++S}}if(w!==null)for(f=S-w,S=7;S!=0&&f>0;)m=T[S],T[S--]=T[w+f-1],T[w+--f]=m;else if(S!=8)return;return T}(qh(t,1,-1)),!e))return dd;this.host=e}else if(this.isSpecial()){if(t=NY(t),Ks(qY,t)||(e=function(i){var o,a,d,l,h,f,m,T=BY(i,".");if(T.length&&T[T.length-1]==""&&T.length--,(o=T.length)>4)return i;for(a=[],d=0;d<o;d++){if((l=T[d])=="")return i;if(h=10,l.length>1&&ys(l,0)=="0"&&(h=Ks(WY,l)?16:8,l=qh(l,h==8?1:2)),l==="")f=0;else{if(!Ks(h==10?KY:h==8?HY:x0,l))return i;f=X_(l,h)}zl(a,f)}for(d=0;d<o;d++)if(f=a[d],d==o-1){if(f>=L0(256,5-o))return null}else if(f>255)return null;for(m=VY(a),d=0;d<a.length;d++)m+=a[d]*L0(256,3-d);return m}(t),e===null))return dd;this.host=e}else{if(Ks(YY,t))return dd;for(e="",n=Yl(t),r=0;r<n.length;r++)e+=cc(n[r],$_);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return hv(Z_,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme=="file"&&e==1&&zh(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,r=t.password,i=t.host,o=t.port,a=t.path,d=t.query,l=t.fragment,h=e+":";return i!==null?(h+="//",t.includesCredentials()&&(h+=n+(r?":"+r:"")+"@"),h+=Yh(i),o!==null&&(h+=":"+o)):e=="file"&&(h+="//"),h+=t.cannotBeABaseURL?a[0]:a.length?"/"+Kh(a,"/"):"",d!==null&&(h+="?"+d),l!==null&&(h+="#"+l),h},setHref:function(t){var e=this.parse(t);if(e)throw fv(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t=="blob")try{return new Xl(t.path[0]).origin}catch{return"null"}return t!="file"&&this.isSpecial()?t+"://"+Yh(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(_a(t)+":",Tv)},getUsername:function(){return this.username},setUsername:function(t){var e=Yl(_a(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=cc(e[n],gv)}},getPassword:function(){return this.password},setPassword:function(t){var e=Yl(_a(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=cc(e[n],gv)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?Yh(t):Yh(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,yv)},getHostname:function(){var t=this.host;return t===null?"":Yh(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,Rv)},getPort:function(){var t=this.port;return t===null?"":_a(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=_a(t))==""?this.port=null:this.parse(t,Iv))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Kh(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,Jl))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=_a(t))==""?this.query=null:(ys(t,0)=="?"&&(t=qh(t,1)),this.query="",this.parse(t,ld)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=_a(t))!=""?(ys(t,0)=="#"&&(t=qh(t,1)),this.fragment="",this.parse(t,ma)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Xl=function(t){var e=bY(this,Di),n=DY(arguments.length,1)>1?arguments[1]:void 0,r=kY(e,new wv(t,!1,n));lv||(e.href=r.serialize(),e.origin=r.getOrigin(),e.protocol=r.getProtocol(),e.username=r.getUsername(),e.password=r.getPassword(),e.host=r.getHost(),e.hostname=r.getHostname(),e.port=r.getPort(),e.pathname=r.getPathname(),e.search=r.getSearch(),e.searchParams=r.getSearchParams(),e.hash=r.getHash())},Di=Xl.prototype,Rs=function(t,e){return{get:function(){return J_(this)[t]()},set:e&&function(n){return J_(this)[e](n)},configurable:!0,enumerable:!0}};if(lv&&(vs(Di,"href",Rs("serialize","setHref")),vs(Di,"origin",Rs("getOrigin")),vs(Di,"protocol",Rs("getProtocol","setProtocol")),vs(Di,"username",Rs("getUsername","setUsername")),vs(Di,"password",Rs("getPassword","setPassword")),vs(Di,"host",Rs("getHost","setHost")),vs(Di,"hostname",Rs("getHostname","setHostname")),vs(Di,"port",Rs("getPort","setPort")),vs(Di,"pathname",Rs("getPathname","setPathname")),vs(Di,"search",Rs("getSearch","setSearch")),vs(Di,"searchParams",Rs("getSearchParams")),vs(Di,"hash",Rs("getHash","setHash"))),z_(Di,"toJSON",function(){return J_(this).serialize()},{enumerable:!0}),z_(Di,"toString",function(){return J_(this).serialize()},{enumerable:!0}),Hh){var z0=Hh.createObjectURL,J0=Hh.revokeObjectURL;z0&&z_(Xl,"createObjectURL",P0(z0,Hh)),J0&&z_(Xl,"revokeObjectURL",P0(J0,Hh))}PY(Xl,"URL"),AY({global:!0,forced:!wY,sham:!lv},{URL:Xl});var $Y=Me,ZY=g,t8=Ul,X0=ts,e8=JS,Q0=pn("URL");$Y({target:"URL",stat:!0,forced:!(e8&&ZY(function(){Q0.canParse()}))},{canParse:function(t){var e=t8(arguments.length,1),n=X0(t),r=e<2||arguments[1]===void 0?void 0:X0(arguments[1]);try{return!!new Q0(n,r)}catch{return!1}}});var nm=_(xr.URL);let $0=!0,Z0=!0;function rm(t,e,n){const r=t.match(e);return r&&r.length>=n&&parseInt(r[n],10)}function ud(t,e,n){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(a,d){if(a!==e)return i.apply(this,arguments);const l=h=>{const f=n(h);f&&(d.handleEvent?d.handleEvent(f):d(f))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(d,l),i.apply(this,[a,l])};const o=r.removeEventListener;r.removeEventListener=function(a,d){if(a!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(d))return o.apply(this,arguments);const l=this._eventMap[e].get(d);return this._eventMap[e].delete(d),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[a,l])},Object.defineProperty(r,"on"+e,{get(){return this["_on"+e]},set(a){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),a&&this.addEventListener(e,this["_on"+e]=a)},enumerable:!0,configurable:!0})}function n8(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):($0=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function r8(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Z0=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function tN(){if(typeof window=="object"){if($0)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function bv(t,e){Z0&&console.warn(t+" is deprecated, please use "+e+" instead.")}function eN(t){return Object.prototype.toString.call(t)==="[object Object]"}function nN(t){var e;return eN(t)?Ws(e=Object.keys(t)).call(e,function(n,r){const i=eN(t[r]),o=i?nN(t[r]):t[r],a=i&&!Object.keys(o).length;return o===void 0||a?n:Object.assign(n,{[r]:o})},{}):t}function Ov(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(r=>{r.endsWith("Id")?Ov(t,t.get(e[r]),n):r.endsWith("Ids")&&e[r].forEach(i=>{Ov(t,t.get(i),n)})}))}function rN(t,e,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(e===null)return i;const o=[];return t.forEach(a=>{a.type==="track"&&a.trackIdentifier===e.id&&o.push(a)}),o.forEach(a=>{t.forEach(d=>{d.type===r&&d.trackId===a.id&&Ov(t,d,i)})}),i}const iN=tN;function sN(t,e){const n=t&&t.navigator;if(!n.mediaDevices)return;const r=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const d={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const h=typeof a[l]=="object"?a[l]:{ideal:a[l]};h.exact!==void 0&&typeof h.exact=="number"&&(h.min=h.max=h.exact);const f=function(m,T){return m?m+T.charAt(0).toUpperCase()+T.slice(1):T==="deviceId"?"sourceId":T};if(h.ideal!==void 0){d.optional=d.optional||[];let m={};typeof h.ideal=="number"?(m[f("min",l)]=h.ideal,d.optional.push(m),m={},m[f("max",l)]=h.ideal,d.optional.push(m)):(m[f("",l)]=h.ideal,d.optional.push(m))}h.exact!==void 0&&typeof h.exact!="number"?(d.mandatory=d.mandatory||{},d.mandatory[f("",l)]=h.exact):["min","max"].forEach(m=>{h[m]!==void 0&&(d.mandatory=d.mandatory||{},d.mandatory[f(m,l)]=h[m])})}),a.advanced&&(d.optional=(d.optional||[]).concat(a.advanced)),d},i=function(a,d){if(e.version>=61)return d(a);if((a=JSON.parse(JSON.stringify(a)))&&typeof a.audio=="object"){const l=function(h,f,m){f in h&&!(m in h)&&(h[m]=h[f],delete h[f])};l((a=JSON.parse(JSON.stringify(a))).audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=r(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const h=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||h)){let f;if(delete a.video.facingMode,l.exact==="environment"||l.ideal==="environment"?f=["back","rear"]:l.exact!=="user"&&l.ideal!=="user"||(f=["front"]),f)return n.mediaDevices.enumerateDevices().then(m=>{let T=(m=m.filter(S=>S.kind==="videoinput")).find(S=>f.some(w=>{var I;return ft(I=S.label.toLowerCase()).call(I,w)}));return!T&&m.length&&ft(f).call(f,"back")&&(T=m[m.length-1]),T&&(a.video.deviceId=l.exact?{exact:T.deviceId}:{ideal:T.deviceId}),a.video=r(a.video),iN("chrome: "+JSON.stringify(a)),d(a)})}a.video=r(a.video)}return iN("chrome: "+JSON.stringify(a)),d(a)},o=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(a,d,l){i(a,h=>{n.webkitGetUserMedia(h,d,f=>{l&&l(o(f))})})}).bind(n),n.mediaDevices.getUserMedia){const a=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(d){return i(d,l=>a(l).then(h=>{if(l.audio&&!h.getAudioTracks().length||l.video&&!h.getVideoTracks().length)throw h.getTracks().forEach(f=>{f.stop()}),new DOMException("","NotFoundError");return h},h=>mt.reject(o(h))))}}}function oN(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function aN(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):{track:r.track};const o=new Event("track");o.track=r.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.id):{track:r};const o=new Event("track");o.track=r,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else ud(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function cN(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(i,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=i.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:i}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(a,d){let l=i.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(a){o.apply(this,arguments);const d=this._senders.indexOf(a);d!==-1&&this._senders.splice(d,1)}}const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],n.apply(this,[i]),i.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],r.apply(this,[i]),i.getTracks().forEach(o=>{const a=this._senders.find(d=>d.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function dN(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[n,r,i]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);const o=function(d){const l={};return d.result().forEach(h=>{const f={id:h.id,timestamp:h.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[h.type]||h.type};h.names().forEach(m=>{f[m]=h.stat(m)}),l[f.id]=f}),l},a=function(d){return new Map(Object.keys(d).map(l=>[l,d[l]]))};if(arguments.length>=2){const d=function(l){r(a(o(l)))};return e.apply(this,[d,n])}return new mt((d,l)=>{e.apply(this,[function(h){d(a(o(h)))},l])}).then(r,i)}}function lN(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const i=n.apply(this,[]);return i.forEach(o=>o._pc=this),i});const r=t.RTCPeerConnection.prototype.addTrack;r&&(t.RTCPeerConnection.prototype.addTrack=function(){const i=r.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){const i=this;return this._pc.getStats().then(o=>rN(o,i.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(i=>i._pc=this),r}),ud(t,"track",r=>(r.receiver._pc=r.srcElement,r)),t.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(i=>rN(i,r.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const n=arguments[0];let r,i,o;return this.getSenders().forEach(a=>{a.track===n&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===n&&(i?o=!0:i=a),a.track===n)),o||r&&i?mt.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():mt.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function uN(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const d=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(d)===-1&&this._shimmedLocalStreams[a.id].push(d):this._shimmedLocalStreams[a.id]=[a,d],d};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(f=>f.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();n.apply(this,arguments);const d=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(d)};const r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};const i=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const d=this._shimmedLocalStreams[a].indexOf(o);d!==-1&&this._shimmedLocalStreams[a].splice(d,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),i.apply(this,arguments)}}function hN(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return uN(t);const n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const l=n.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(h=>this._reverseStreams[h.id])};const r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(l){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.getTracks().forEach(h=>{if(this.getSenders().find(m=>m.track===h))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[l.id]){const h=new t.MediaStream(l.getTracks());this._streams[l.id]=h,this._reverseStreams[h.id]=l,l=h}r.apply(this,[l])};const i=t.RTCPeerConnection.prototype.removeStream;function o(l,h){let f=h.sdp;return Object.keys(l._reverseStreams||[]).forEach(m=>{const T=l._reverseStreams[m],S=l._streams[T.id];f=f.replace(new RegExp(S.id,"g"),T.id)}),new RTCSessionDescription({type:h.type,sdp:f})}t.RTCPeerConnection.prototype.removeStream=function(l){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[l.id]||l]),delete this._reverseStreams[this._streams[l.id]?this._streams[l.id].id:l.id],delete this._streams[l.id]},t.RTCPeerConnection.prototype.addTrack=function(l,h){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(S=>S===l))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(S=>S.track===l))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const T=this._streams[h.id];if(T)T.addTrack(l),mt.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const S=new t.MediaStream([l]);this._streams[h.id]=S,this._reverseStreams[S.id]=h,this.addStream(S)}return this.getSenders().find(S=>S.track===l)},["createOffer","createAnswer"].forEach(function(l){const h=t.RTCPeerConnection.prototype[l],f={[l](){const m=arguments;return arguments.length&&typeof arguments[0]=="function"?h.apply(this,[T=>{const S=o(this,T);m[0].apply(null,[S])},T=>{m[1]&&m[1].apply(null,T)},arguments[2]]):h.apply(this,arguments).then(T=>o(this,T))}};t.RTCPeerConnection.prototype[l]=f[l]});const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(l,h){let f=h.sdp;return Object.keys(l._reverseStreams||[]).forEach(m=>{const T=l._reverseStreams[m],S=l._streams[T.id];f=f.replace(new RegExp(T.id,"g"),S.id)}),new RTCSessionDescription({type:h.type,sdp:f})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const d=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const l=d.get.apply(this);return l.type===""?l:o(this,l)}}),t.RTCPeerConnection.prototype.removeTrack=function(l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!l._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(l._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let h;this._streams=this._streams||{},Object.keys(this._streams).forEach(f=>{this._streams[f].getTracks().find(m=>l.track===m)&&(h=this._streams[f])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(l.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Nv(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const r=t.RTCPeerConnection.prototype[n],i={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=i[n]})}function pN(t,e){ud(t,"negotiationneeded",n=>{const r=n.target;if(!(e.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")||r.signalingState==="stable")return n})}var fN=Object.freeze({__proto__:null,fixNegotiationNeeded:pN,shimAddTrackRemoveTrack:hN,shimAddTrackRemoveTrackWithNative:uN,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(r=>{const i=n.video&&n.video.width,o=n.video&&n.video.height,a=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:a||3}},i&&(n.video.mandatory.maxWidth=i),o&&(n.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:cN,shimGetStats:dN,shimGetUserMedia:sN,shimMediaStream:oN,shimOnTrack:aN,shimPeerConnection:Nv,shimSenderReceiverGetStats:lN});function _N(t,e){const n=t&&t.navigator,r=t&&t.MediaStreamTrack;if(n.getUserMedia=function(i,o,a){bv("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(i).then(o,a)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const i=function(a,d,l){d in a&&!(l in a)&&(a[l]=a[d],delete a[d])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),i(a.audio,"autoGainControl","mozAutoGainControl"),i(a.audio,"noiseSuppression","mozNoiseSuppression")),o(a)},r&&r.prototype.getSettings){const a=r.prototype.getSettings;r.prototype.getSettings=function(){const d=a.apply(this,arguments);return i(d,"mozAutoGainControl","autoGainControl"),i(d,"mozNoiseSuppression","noiseSuppression"),d}}if(r&&r.prototype.applyConstraints){const a=r.prototype.applyConstraints;r.prototype.applyConstraints=function(d){return this.kind==="audio"&&typeof d=="object"&&(d=JSON.parse(JSON.stringify(d)),i(d,"autoGainControl","mozAutoGainControl"),i(d,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[d])}}}}function mN(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Pv(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const o=t.RTCPeerConnection.prototype[i],a={[i](){return arguments[0]=new(i==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[i]=a[i]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[i,o,a]=arguments;return r.apply(this,[i||null]).then(d=>{if(e.version<53&&!o)try{d.forEach(l=>{l.type=n[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;d.forEach((h,f)=>{d.set(f,Object.assign({},h,{type:n[h.type]||h.type}))})}return d}).then(o,a)}}function EN(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):mt.resolve(new Map)}}function gN(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n}),ud(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function TN(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){bv("removeStream","removeTrack"),this.getSenders().forEach(n=>{var r;n.track&&ft(r=e.getTracks()).call(r,n.track)&&this.removeTrack(n)})})}function SN(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function vN(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const r=n.length>0;r&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=e.apply(this,arguments);if(r){const{sender:o}=i,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return i})}function yN(t){if(typeof t!="object"||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function RN(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?mt.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function IN(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?mt.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var CN=Object.freeze({__proto__:null,shimAddTransceiver:vN,shimCreateAnswer:IN,shimCreateOffer:RN,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,mt.reject(r)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:yN,shimGetUserMedia:_N,shimOnTrack:mN,shimPeerConnection:Pv,shimRTCDataChannel:SN,shimReceiverGetStats:gN,shimRemoveStream:TN,shimSenderGetStats:EN});function AN(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var r;this._localStreams||(this._localStreams=[]),ft(r=this._localStreams).call(r,n)||this._localStreams.push(n),n.getAudioTracks().forEach(i=>e.call(this,i,n)),n.getVideoTracks().forEach(i=>e.call(this,i,n))},t.RTCPeerConnection.prototype.addTrack=function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i&&i.forEach(a=>{var d;this._localStreams?ft(d=this._localStreams).call(d,a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);const r=e.getTracks();this.getSenders().forEach(i=>{ft(r).call(r,i.track)&&this.removeTrack(i)})})}}function wN(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(i=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),ft(o=this._remoteStreams).call(o,i))return;this._remoteStreams.push(i);const a=new Event("addstream");a.stream=i,this.dispatchEvent(a)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(i=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(i)>=0)return;n._remoteStreams.push(i);const o=new Event("addstream");o.stream=i,n.dispatchEvent(o)})}),e.apply(n,arguments)}}}function bN(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,n=e.createOffer,r=e.createAnswer,i=e.setLocalDescription,o=e.setRemoteDescription,a=e.addIceCandidate;e.createOffer=function(l,h){const f=arguments.length>=2?arguments[2]:arguments[0],m=n.apply(this,[f]);return h?(m.then(l,h),mt.resolve()):m},e.createAnswer=function(l,h){const f=arguments.length>=2?arguments[2]:arguments[0],m=r.apply(this,[f]);return h?(m.then(l,h),mt.resolve()):m};let d=function(l,h,f){const m=i.apply(this,[l]);return f?(m.then(h,f),mt.resolve()):m};e.setLocalDescription=d,d=function(l,h,f){const m=o.apply(this,[l]);return f?(m.then(h,f),mt.resolve()):m},e.setRemoteDescription=d,d=function(l,h,f){const m=a.apply(this,[l]);return f?(m.then(h,f),mt.resolve()):m},e.addIceCandidate=d}function ON(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,r=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=i=>r(NN(i))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(n,r,i){e.mediaDevices.getUserMedia(n).then(r,i)}).bind(e))}function NN(t){return t&&t.video!==void 0?Object.assign({},t,{video:nN(t.video)}):t}function PN(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,r){if(n&&n.iceServers){const i=[];for(let o=0;o<n.iceServers.length;o++){let a=n.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(bv("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,i.push(a)):i.push(n.iceServers[o])}n.iceServers=i}return new e(n,r)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function DN(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function kN(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveAudio!==!0||r||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const i=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveVideo!==!0||i||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function LN(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var MN=Object.freeze({__proto__:null,shimAudioContext:LN,shimCallbacksAPI:bN,shimConstraints:NN,shimCreateOfferLegacy:kN,shimGetUserMedia:ON,shimLocalStreamsAPI:AN,shimRTCIceServerUrls:PN,shimRemoteStreamsAPI:wN,shimTrackEventTransceiver:DN}),UN=`	
\v\f\r                　\u2028\u2029\uFEFF`,i8=Yr,s8=ts,Dv=UN,xN=tt("".replace),o8=RegExp("^["+Dv+"]+"),a8=RegExp("(^|[^"+Dv+"])["+Dv+"]+$"),c8=function(t){return function(e){var n=s8(i8(e));return 1&t&&(n=xN(n,o8,"")),2&t&&(n=xN(n,a8,"$1")),n}},d8={trim:c8(3)},l8=Ub.PROPER,u8=g,VN=UN,h8=d8.trim;Me({target:"String",proto:!0,forced:function(t){return u8(function(){return!!VN[t]()||"​᠎"[t]()!=="​᠎"||l8&&VN[t].name!==t})}("trim")},{trim:function(){return h8(this)}});var p8=Es("String").trim,f8=st,_8=p8,kv=String.prototype,m8=function(t){var e=t.trim;return typeof t=="string"||t===kv||f8(kv,t)&&e===kv.trim?_8:e},Br=_(m8),FN={exports:{}};(function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(r=>r.trim())},e.splitSections=function(n){return n.split(`
m=`).map((r,i)=>(i>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(n){const r=e.splitSections(n);return r&&r[0]},e.getMediaSections=function(n){const r=e.splitSections(n);return r.shift(),r},e.matchPrefix=function(n,r){return e.splitLines(n).filter(i=>i.indexOf(r)===0)},e.parseCandidate=function(n){let r;r=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const i={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let o=8;o<r.length;o+=2)switch(r[o]){case"raddr":i.relatedAddress=r[o+1];break;case"rport":i.relatedPort=parseInt(r[o+1],10);break;case"tcptype":i.tcpType=r[o+1];break;case"ufrag":i.ufrag=r[o+1],i.usernameFragment=r[o+1];break;default:i[r[o]]===void 0&&(i[r[o]]=r[o+1])}return i},e.writeCandidate=function(n){const r=[];r.push(n.foundation);const i=n.component;i==="rtp"?r.push(1):i==="rtcp"?r.push(2):r.push(i),r.push(n.protocol.toUpperCase()),r.push(n.priority),r.push(n.address||n.ip),r.push(n.port);const o=n.type;return r.push("typ"),r.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(r.push("raddr"),r.push(n.relatedAddress),r.push("rport"),r.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(r.push("ufrag"),r.push(n.usernameFragment||n.ufrag)),"candidate:"+r.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let r=n.substring(9).split(" ");const i={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),i.name=r[0],i.clockRate=parseInt(r[1],10),i.channels=r.length===3?parseInt(r[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(n){let r=n.payloadType;n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType);const i=n.channels||n.numChannels||1;return"a=rtpmap:"+r+" "+n.name+"/"+n.clockRate+(i!==1?"/"+i:"")+`\r
`},e.parseExtmap=function(n){const r=n.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){const r={};let i;const o=n.substring(n.indexOf(" ")+1).split(";");for(let a=0;a<o.length;a++)i=o[a].trim().split("="),r[i[0].trim()]=i[1];return r},e.writeFmtp=function(n){let r="",i=n.payloadType;if(n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const o=[];Object.keys(n.parameters).forEach(a=>{n.parameters[a]!==void 0?o.push(a+"="+n.parameters[a]):o.push(a)}),r+="a=fmtp:"+i+" "+o.join(";")+`\r
`}return r},e.parseRtcpFb=function(n){const r=n.substring(n.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},e.writeRtcpFb=function(n){let r="",i=n.payloadType;return n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{r+="a=rtcp-fb:"+i+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),r},e.parseSsrcMedia=function(n){const r=n.indexOf(" "),i={ssrc:parseInt(n.substring(7,r),10)},o=n.indexOf(":",r);return o>-1?(i.attribute=n.substring(r+1,o),i.value=n.substring(o+1)):i.attribute=n.substring(r+1),i},e.parseSsrcGroup=function(n){const r=n.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(i=>parseInt(i,10))}},e.getMid=function(n){const r=e.matchPrefix(n,"a=mid:")[0];if(r)return r.substring(6)},e.parseFingerprint=function(n){const r=n.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},e.getDtlsParameters=function(n,r){return{role:"auto",fingerprints:e.matchPrefix(n+r,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,r){let i="a=setup:"+r+`\r
`;return n.fingerprints.forEach(o=>{i+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),i},e.parseCryptoLine=function(n){const r=n.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const r=n.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,r){return e.matchPrefix(n+r,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,r){const i=e.matchPrefix(n+r,"a=ice-ufrag:")[0],o=e.matchPrefix(n+r,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(n){let r="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(r+=`a=ice-lite\r
`),r},e.parseRtpParameters=function(n){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=e.splitLines(n)[0].split(" ");r.profile=i[2];for(let a=3;a<i.length;a++){const d=i[a],l=e.matchPrefix(n,"a=rtpmap:"+d+" ")[0];if(l){const h=e.parseRtpMap(l),f=e.matchPrefix(n,"a=fmtp:"+d+" ");switch(h.parameters=f.length?e.parseFmtp(f[0]):{},h.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+d+" ").map(e.parseRtcpFb),r.codecs.push(h),h.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(h.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach(a=>{r.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return r.codecs.forEach(a=>{o.forEach(d=>{a.rtcpFeedback.find(l=>l.type===d.type&&l.parameter===d.parameter)||a.rtcpFeedback.push(d)})}),r},e.writeRtpDescription=function(n,r){let i="";i+="m="+n+" ",i+=r.codecs.length>0?"9":"0",i+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=r.codecs.map(a=>a.preferredPayloadType!==void 0?a.preferredPayloadType:a.payloadType).join(" ")+`\r
`,i+=`c=IN IP4 0.0.0.0\r
`,i+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(a=>{i+=e.writeRtpMap(a),i+=e.writeFmtp(a),i+=e.writeRtcpFb(a)});let o=0;return r.codecs.forEach(a=>{a.maxptime>o&&(o=a.maxptime)}),o>0&&(i+="a=maxptime:"+o+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(a=>{i+=e.writeExtmap(a)}),i},e.parseRtpEncodingParameters=function(n){const r=[],i=e.parseRtpParameters(n),o=i.fecMechanisms.indexOf("RED")!==-1,a=i.fecMechanisms.indexOf("ULPFEC")!==-1,d=e.matchPrefix(n,"a=ssrc:").map(T=>e.parseSsrcMedia(T)).filter(T=>T.attribute==="cname"),l=d.length>0&&d[0].ssrc;let h;const f=e.matchPrefix(n,"a=ssrc-group:FID").map(T=>T.substring(17).split(" ").map(S=>parseInt(S,10)));f.length>0&&f[0].length>1&&f[0][0]===l&&(h=f[0][1]),i.codecs.forEach(T=>{if(T.name.toUpperCase()==="RTX"&&T.parameters.apt){let S={ssrc:l,codecPayloadType:parseInt(T.parameters.apt,10)};l&&h&&(S.rtx={ssrc:h}),r.push(S),o&&(S=JSON.parse(JSON.stringify(S)),S.fec={ssrc:l,mechanism:a?"red+ulpfec":"red"},r.push(S))}}),r.length===0&&l&&r.push({ssrc:l});let m=e.matchPrefix(n,"b=");return m.length&&(m=m[0].indexOf("b=TIAS:")===0?parseInt(m[0].substring(7),10):m[0].indexOf("b=AS:")===0?1e3*parseInt(m[0].substring(5),10)*.95-16e3:void 0,r.forEach(T=>{T.maxBitrate=m})),r},e.parseRtcpParameters=function(n){const r={},i=e.matchPrefix(n,"a=ssrc:").map(d=>e.parseSsrcMedia(d)).filter(d=>d.attribute==="cname")[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const o=e.matchPrefix(n,"a=rtcp-rsize");r.reducedSize=o.length>0,r.compound=o.length===0;const a=e.matchPrefix(n,"a=rtcp-mux");return r.mux=a.length>0,r},e.writeRtcpParameters=function(n){let r="";return n.reducedSize&&(r+=`a=rtcp-rsize\r
`),n.mux&&(r+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(r+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),r},e.parseMsid=function(n){let r;const i=e.matchPrefix(n,"a=msid:");if(i.length===1)return r=i[0].substring(7).split(" "),{stream:r[0],track:r[1]};const o=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="msid");return o.length>0?(r=o[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},e.parseSctpDescription=function(n){const r=e.parseMLine(n),i=e.matchPrefix(n,"a=max-message-size:");let o;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);const a=e.matchPrefix(n,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substring(12),10),protocol:r.fmt,maxMessageSize:o};const d=e.matchPrefix(n,"a=sctpmap:");if(d.length>0){const l=d[0].substring(10).split(" ");return{port:parseInt(l[0],10),protocol:l[1],maxMessageSize:o}}},e.writeSctpDescription=function(n,r){let i=[];return i=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&i.push("a=max-message-size:"+r.maxMessageSize+`\r
`),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,r,i){let o;const a=r!==void 0?r:2;return o=n||e.generateSessionId(),`v=0\r
o=`+(i||"thisisadapterortc")+" "+o+" "+a+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,r){const i=e.splitLines(n);for(let o=0;o<i.length;o++)switch(i[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[o].substring(2)}return r?e.getDirection(r):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){const r=e.splitLines(n)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(n){const r=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const r=e.splitLines(n);for(let i=0;i<r.length;i++)if(r[i].length<2||r[i].charAt(1)!=="=")return!1;return!0},t.exports=e})(FN);var BN=FN.exports,Ql=_(BN),E8=c({__proto__:null,default:Ql},[BN]);function im(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const r=new e(n),i=Ql.parseCandidate(n.candidate),o=Object.assign(r,i);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,ud(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n))}function Lv(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||ud(t,"icecandidate",e=>{if(e.candidate){const n=Ql.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function sm(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(d){if(!d||!d.sdp)return!1;const l=Ql.splitSections(d.sdp);return l.shift(),l.some(h=>{const f=Ql.parseMLine(h);return f&&f.kind==="application"&&f.protocol.indexOf("SCTP")!==-1})},r=function(d){const l=d.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(l===null||l.length<2)return-1;const h=parseInt(l[1],10);return h!=h?-1:h},i=function(d){let l=65536;return e.browser==="firefox"&&(l=e.version<57?d===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),l},o=function(d,l){let h=65536;e.browser==="firefox"&&e.version===57&&(h=65535);const f=Ql.matchPrefix(d.sdp,"a=max-message-size:");return f.length>0?h=parseInt(f[0].substr(19),10):e.browser==="firefox"&&l!==-1&&(h=2147483637),h},a=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:d}=this.getConfiguration();d==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const d=r(arguments[0]),l=i(d),h=o(arguments[0],d);let f;f=l===0&&h===0?Number.POSITIVE_INFINITY:l===0||h===0?Math.max(l,h):Math.min(l,h);const m={};Object.defineProperty(m,"maxMessageSize",{get:()=>f}),this._sctp=m}return a.apply(this,arguments)}}function om(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(r,i){const o=r.send;r.send=function(){const a=arguments[0],d=a.length||a.size||a.byteLength;if(r.readyState==="open"&&i.sctp&&d>i.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+i.sctp.maxMessageSize+" bytes)");return o.apply(r,arguments)}}const n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const r=n.apply(this,arguments);return e(r,this),r},ud(t,"datachannel",r=>(e(r.channel,r.target),r))}function Mv(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const r=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=i=>{const o=i.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const a=new Event("connectionstatechange",i);o.dispatchEvent(a)}return i},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function Uv(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const i=r.sdp.split(`
`).filter(o=>Br(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&r instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:r.type,sdp:i}):r.sdp=i}return n.apply(this,arguments)}}function am(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?mt.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),mt.resolve())})}function cm(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return n.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||r.type!=="offer"&&r.type!=="answer"?n.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(i=>n.apply(this,[i]))})}var g8=Object.freeze({__proto__:null,removeExtmapAllowMixed:Uv,shimAddIceCandidateNullOrEmpty:am,shimConnectionState:Mv,shimMaxMessageSize:sm,shimParameterlessSetLocalDescription:cm,shimRTCIceCandidate:im,shimRTCIceCandidateRelayProtocol:Lv,shimSendThrowTypeError:om});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=tN,r=function(o){const a={browser:null,version:null};if(o===void 0||!o.navigator)return a.browser="Not a browser.",a;const{navigator:d}=o;if(d.mozGetUserMedia)a.browser="firefox",a.version=rm(d.userAgent,/Firefox\/(\d+)\./,1);else if(d.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)a.browser="chrome",a.version=rm(d.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!d.userAgent.match(/AppleWebKit\/(\d+)\./))return a.browser="Not a supported browser.",a;a.browser="safari",a.version=rm(d.userAgent,/AppleWebKit\/(\d+)\./,1),a.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return a}(t),i={browserDetails:r,commonShim:g8,extractVersion:rm,disableLog:n8,disableWarnings:r8,sdp:E8};switch(r.browser){case"chrome":if(!fN||!Nv||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),i;if(r.version===null)return n("Chrome shim can not determine version, not shimming."),i;n("adapter.js shimming chrome."),i.browserShim=fN,am(t,r),cm(t),sN(t,r),oN(t),Nv(t,r),aN(t),hN(t,r),cN(t),dN(t),lN(t),pN(t,r),im(t),Lv(t),Mv(t),sm(t,r),om(t),Uv(t,r);break;case"firefox":if(!CN||!Pv||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),i;n("adapter.js shimming firefox."),i.browserShim=CN,am(t,r),cm(t),_N(t,r),Pv(t,r),mN(t),TN(t),EN(t),gN(t),SN(t),vN(t),yN(t),RN(t),IN(t),im(t),Mv(t),sm(t,r),om(t);break;case"safari":if(!MN||!e.shimSafari)return n("Safari shim is not included in this adapter release."),i;n("adapter.js shimming safari."),i.browserShim=MN,am(t,r),cm(t),PN(t),kN(t),bN(t),AN(t),wN(t),DN(t),ON(t),LN(t),im(t),Lv(t),sm(t,r),om(t),Uv(t,r);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var jN=ms,T8=TypeError,GN=bi.match(/firefox\/(\d+)/i),S8=!!GN&&+GN[1],v8=/MSIE|Trident/.test(bi),WN=bi.match(/AppleWebKit\/(\d+)\./),y8=!!WN&&+WN[1],R8=Me,HN=tt,I8=Fr,C8=gi,KN=Qn,A8=function(t,e){if(!delete t[e])throw T8("Cannot delete property "+jN(e)+" of "+jN(t))},qN=ts,xv=g,w8=n0,b8=T_,YN=S8,O8=v8,zN=$i,JN=y8,dc=[],XN=HN(dc.sort),N8=HN(dc.push),P8=xv(function(){dc.sort(void 0)}),D8=xv(function(){dc.sort(null)}),k8=b8("sort"),QN=!xv(function(){if(zN)return zN<70;if(!(YN&&YN>3)){if(O8)return!0;if(JN)return JN<603;var t,e,n,r,i="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)dc.push({k:e+r,v:n})}for(dc.sort(function(o,a){return a.v-o.v}),r=0;r<dc.length;r++)e=dc[r].k.charAt(0),i.charAt(i.length-1)!==e&&(i+=e);return i!=="DGBEFHACIJK"}});R8({target:"Array",proto:!0,forced:P8||!D8||!k8||!QN},{sort:function(t){t!==void 0&&I8(t);var e=C8(this);if(QN)return t===void 0?XN(e):XN(e,t);var n,r,i=[],o=KN(e);for(r=0;r<o;r++)r in e&&N8(i,e[r]);for(w8(i,function(a){return function(d,l){return l===void 0?-1:d===void 0?1:a!==void 0?+a(d,l)||0:qN(d)>qN(l)?1:-1}}(t)),n=KN(i),r=0;r<n;)e[r]=i[r++];for(;r<o;)A8(e,r++);return e}});var L8=Es("Array").sort,M8=st,U8=L8,Vv=Array.prototype,x8=function(t){var e=t.sort;return t===Vv||M8(Vv,t)&&e===Vv.sort?U8:e},Jh=_(x8),Fv=yt;Me({global:!0,forced:Fv.globalThis!==Fv},{globalThis:Fv});var $N=_(yt),Bv={exports:{}};(function(t,e){(function(n,r){var i="function",o="undefined",a="object",d="string",l="major",h="model",f="name",m="type",T="vendor",S="version",w="architecture",I="console",C="mobile",N="tablet",P="smarttv",x="wearable",W="embedded",H="Amazon",j="Apple",$="ASUS",ct="BlackBerry",Et="Browser",Tt="Chrome",he="Firefox",pe="Google",Xe="Huawei",Mn="LG",Cn="Microsoft",pi="Motorola",it="Opera",ut="Samsung",At="Sharp",ot="Sony",R="Xiaomi",U="Zebra",F="Facebook",lt="Chromium OS",Xt="Mac OS",We=function(zn){for(var sr={},sn=0;sn<zn.length;sn++)sr[zn[sn].toUpperCase()]=zn[sn];return sr},ir=function(zn,sr){return typeof zn===d&&Ii(sr).indexOf(Ii(zn))!==-1},Ii=function(zn){return zn.toLowerCase()},ka=function(zn,sr){if(typeof zn===d)return zn=zn.replace(/^\s\s*/,""),typeof sr===o?zn:zn.substring(0,350)},Gd=function(zn,sr){for(var sn,Mi,Go,Un,Pe,Ci,Pc=0;Pc<sr.length&&!Pe;){var so=sr[Pc],CV=sr[Pc+1];for(sn=Mi=0;sn<so.length&&!Pe&&so[sn];)if(Pe=so[sn++].exec(zn))for(Go=0;Go<CV.length;Go++)Ci=Pe[++Mi],typeof(Un=CV[Go])===a&&Un.length>0?Un.length===2?typeof Un[1]==i?this[Un[0]]=Un[1].call(this,Ci):this[Un[0]]=Un[1]:Un.length===3?typeof Un[1]!==i||Un[1].exec&&Un[1].test?this[Un[0]]=Ci?Ci.replace(Un[1],Un[2]):r:this[Un[0]]=Ci?Un[1].call(this,Ci,Un[2]):r:Un.length===4&&(this[Un[0]]=Ci?Un[3].call(this,Ci.replace(Un[1],Un[2])):r):this[Un]=Ci||r;Pc+=2}},$p=function(zn,sr){for(var sn in sr)if(typeof sr[sn]===a&&sr[sn].length>0){for(var Mi=0;Mi<sr[sn].length;Mi++)if(ir(sr[sn][Mi],zn))return sn==="?"?r:sn}else if(ir(sr[sn],zn))return sn==="?"?r:sn;return zn},sg={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},og={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[S,[f,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[S,[f,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[f,S],[/opios[\/ ]+([\w\.]+)/i],[S,[f,it+" Mini"]],[/\bopr\/([\w\.]+)/i],[S,[f,it]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[f,S],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[S,[f,"UC"+Et]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[S,[f,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[S,[f,"WeChat"]],[/konqueror\/([\w\.]+)/i],[S,[f,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[S,[f,"IE"]],[/yabrowser\/([\w\.]+)/i],[S,[f,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[f,/(.+)/,"$1 Secure "+Et],S],[/\bfocus\/([\w\.]+)/i],[S,[f,he+" Focus"]],[/\bopt\/([\w\.]+)/i],[S,[f,it+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[S,[f,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[S,[f,"Dolphin"]],[/coast\/([\w\.]+)/i],[S,[f,it+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[S,[f,"MIUI "+Et]],[/fxios\/([-\w\.]+)/i],[S,[f,he]],[/\bqihu|(qi?ho?o?|360)browser/i],[[f,"360 "+Et]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[f,/(.+)/,"$1 "+Et],S],[/(comodo_dragon)\/([\w\.]+)/i],[[f,/_/g," "],S],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[f,S],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[f],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[f,F],S],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[f,S],[/\bgsa\/([\w\.]+) .*safari\//i],[S,[f,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[S,[f,Tt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[f,Tt+" WebView"],S],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[S,[f,"Android "+Et]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[f,S],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[S,[f,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[S,f],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[f,[S,$p,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[f,S],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[f,"Netscape"],S],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[S,[f,he+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[f,S],[/(cobalt)\/([\w\.]+)/i],[f,[S,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[w,"amd64"]],[/(ia32(?=;))/i],[[w,Ii]],[/((?:i[346]|x)86)[;\)]/i],[[w,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[w,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[w,"armhf"]],[/windows (ce|mobile); ppc;/i],[[w,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[w,/ower/,"",Ii]],[/(sun4\w)[;\)]/i],[[w,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[w,Ii]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[h,[T,ut],[m,N]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[h,[T,ut],[m,C]],[/\((ip(?:hone|od)[\w ]*);/i],[h,[T,j],[m,C]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[h,[T,j],[m,N]],[/(macintosh);/i],[h,[T,j]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[h,[T,At],[m,C]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[h,[T,Xe],[m,N]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[h,[T,Xe],[m,C]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[h,/_/g," "],[T,R],[m,C]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[h,/_/g," "],[T,R],[m,N]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[h,[T,"OPPO"],[m,C]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[h,[T,"Vivo"],[m,C]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[h,[T,"Realme"],[m,C]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[h,[T,pi],[m,C]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[h,[T,pi],[m,N]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[h,[T,Mn],[m,N]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[h,[T,Mn],[m,C]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[h,[T,"Lenovo"],[m,N]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[h,/_/g," "],[T,"Nokia"],[m,C]],[/(pixel c)\b/i],[h,[T,pe],[m,N]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[h,[T,pe],[m,C]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[h,[T,ot],[m,C]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[h,"Xperia Tablet"],[T,ot],[m,N]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[h,[T,"OnePlus"],[m,C]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[h,[T,H],[m,N]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[h,/(.+)/g,"Fire Phone $1"],[T,H],[m,C]],[/(playbook);[-\w\),; ]+(rim)/i],[h,T,[m,N]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[h,[T,ct],[m,C]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[h,[T,$],[m,N]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[h,[T,$],[m,C]],[/(nexus 9)/i],[h,[T,"HTC"],[m,N]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[T,[h,/_/g," "],[m,C]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[h,[T,"Acer"],[m,N]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[h,[T,"Meizu"],[m,C]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[T,h,[m,C]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[T,h,[m,N]],[/(surface duo)/i],[h,[T,Cn],[m,N]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[h,[T,"Fairphone"],[m,C]],[/(u304aa)/i],[h,[T,"AT&T"],[m,C]],[/\bsie-(\w*)/i],[h,[T,"Siemens"],[m,C]],[/\b(rct\w+) b/i],[h,[T,"RCA"],[m,N]],[/\b(venue[\d ]{2,7}) b/i],[h,[T,"Dell"],[m,N]],[/\b(q(?:mv|ta)\w+) b/i],[h,[T,"Verizon"],[m,N]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[h,[T,"Barnes & Noble"],[m,N]],[/\b(tm\d{3}\w+) b/i],[h,[T,"NuVision"],[m,N]],[/\b(k88) b/i],[h,[T,"ZTE"],[m,N]],[/\b(nx\d{3}j) b/i],[h,[T,"ZTE"],[m,C]],[/\b(gen\d{3}) b.+49h/i],[h,[T,"Swiss"],[m,C]],[/\b(zur\d{3}) b/i],[h,[T,"Swiss"],[m,N]],[/\b((zeki)?tb.*\b) b/i],[h,[T,"Zeki"],[m,N]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[T,"Dragon Touch"],h,[m,N]],[/\b(ns-?\w{0,9}) b/i],[h,[T,"Insignia"],[m,N]],[/\b((nxa|next)-?\w{0,9}) b/i],[h,[T,"NextBook"],[m,N]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[T,"Voice"],h,[m,C]],[/\b(lvtel\-)?(v1[12]) b/i],[[T,"LvTel"],h,[m,C]],[/\b(ph-1) /i],[h,[T,"Essential"],[m,C]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[h,[T,"Envizen"],[m,N]],[/\b(trio[-\w\. ]+) b/i],[h,[T,"MachSpeed"],[m,N]],[/\btu_(1491) b/i],[h,[T,"Rotor"],[m,N]],[/(shield[\w ]+) b/i],[h,[T,"Nvidia"],[m,N]],[/(sprint) (\w+)/i],[T,h,[m,C]],[/(kin\.[onetw]{3})/i],[[h,/\./g," "],[T,Cn],[m,C]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[h,[T,U],[m,N]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[h,[T,U],[m,C]],[/smart-tv.+(samsung)/i],[T,[m,P]],[/hbbtv.+maple;(\d+)/i],[[h,/^/,"SmartTV"],[T,ut],[m,P]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[T,Mn],[m,P]],[/(apple) ?tv/i],[T,[h,j+" TV"],[m,P]],[/crkey/i],[[h,Tt+"cast"],[T,pe],[m,P]],[/droid.+aft(\w)( bui|\))/i],[h,[T,H],[m,P]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[h,[T,At],[m,P]],[/(bravia[\w ]+)( bui|\))/i],[h,[T,ot],[m,P]],[/(mitv-\w{5}) bui/i],[h,[T,R],[m,P]],[/Hbbtv.*(technisat) (.*);/i],[T,h,[m,P]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[T,ka],[h,ka],[m,P]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[m,P]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[T,h,[m,I]],[/droid.+; (shield) bui/i],[h,[T,"Nvidia"],[m,I]],[/(playstation [345portablevi]+)/i],[h,[T,ot],[m,I]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[h,[T,Cn],[m,I]],[/((pebble))app/i],[T,h,[m,x]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[h,[T,j],[m,x]],[/droid.+; (glass) \d/i],[h,[T,pe],[m,x]],[/droid.+; (wt63?0{2,3})\)/i],[h,[T,U],[m,x]],[/(quest( 2| pro)?)/i],[h,[T,F],[m,x]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[T,[m,W]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[h,[m,C]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[h,[m,N]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[m,N]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[m,C]],[/(android[-\w\. ]{0,9});.+buil/i],[h,[T,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[S,[f,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[S,[f,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[f,S],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[S,f]],os:[[/microsoft (windows) (vista|xp)/i],[f,S],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[f,[S,$p,sg]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,"Windows"],[S,$p,sg]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[S,/_/g,"."],[f,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[f,Xt],[S,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[S,f],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[f,S],[/\(bb(10);/i],[S,[f,ct]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[S,[f,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[S,[f,he+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[S,[f,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[S,[f,"watchOS"]],[/crkey\/([\d\.]+)/i],[S,[f,Tt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[f,lt],S],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[f,S],[/(sunos) ?([\w\.\d]*)/i],[[f,"Solaris"],S],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[f,S]]},hs=function(zn,sr){if(typeof zn===a&&(sr=zn,zn=r),!(this instanceof hs))return new hs(zn,sr).getResult();var sn=typeof n!==o&&n.navigator?n.navigator:r,Mi=zn||(sn&&sn.userAgent?sn.userAgent:""),Go=sn&&sn.userAgentData?sn.userAgentData:r,Un=sr?function(Pe,Ci){var Pc={};for(var so in Pe)Ci[so]&&Ci[so].length%2==0?Pc[so]=Ci[so].concat(Pe[so]):Pc[so]=Pe[so];return Pc}(og,sr):og;return this.getBrowser=function(){var Pe={};return Pe[f]=r,Pe[S]=r,Gd.call(Pe,Mi,Un.browser),Pe[l]=function(Ci){return typeof Ci===d?Ci.replace(/[^\d\.]/g,"").split(".")[0]:r}(Pe[S]),sn&&sn.brave&&typeof sn.brave.isBrave==i&&(Pe[f]="Brave"),Pe},this.getCPU=function(){var Pe={};return Pe[w]=r,Gd.call(Pe,Mi,Un.cpu),Pe},this.getDevice=function(){var Pe={};return Pe[T]=r,Pe[h]=r,Pe[m]=r,Gd.call(Pe,Mi,Un.device),!Pe[m]&&Go&&Go.mobile&&(Pe[m]=C),Pe[h]=="Macintosh"&&sn&&typeof sn.standalone!==o&&sn.maxTouchPoints&&sn.maxTouchPoints>2&&(Pe[h]="iPad",Pe[m]=N),Pe},this.getEngine=function(){var Pe={};return Pe[f]=r,Pe[S]=r,Gd.call(Pe,Mi,Un.engine),Pe},this.getOS=function(){var Pe={};return Pe[f]=r,Pe[S]=r,Gd.call(Pe,Mi,Un.os),!Pe[f]&&Go&&Go.platform!="Unknown"&&(Pe[f]=Go.platform.replace(/chrome os/i,lt).replace(/macos/i,Xt)),Pe},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Mi},this.setUA=function(Pe){return Mi=typeof Pe===d&&Pe.length>350?ka(Pe,350):Pe,this},this.setUA(Mi),this};hs.VERSION="0.7.34",hs.BROWSER=We([f,S,l]),hs.CPU=We([w]),hs.DEVICE=We([h,T,m,I,C,P,N,x,W]),hs.ENGINE=hs.OS=We([f,S]),t.exports&&(e=t.exports=hs),e.UAParser=hs;var Nc=typeof n!==o&&(n.jQuery||n.Zepto);if(Nc&&!Nc.ua){var Wd=new hs;Nc.ua=Wd.getResult(),Nc.ua.get=function(){return Wd.getUA()},Nc.ua.set=function(zn){Wd.setUA(zn);var sr=Wd.getResult();for(var sn in sr)Nc.ua[sn]=sr[sn]}}})(typeof window=="object"?window:p)})(Bv,Bv.exports);var V8=_(Bv.exports),F8=To,B8=or,j8=jt,G8=nd,W8=bn("iterator"),H8=Object,K8=function(t){if(j8(t))return!1;var e=H8(t);return e[W8]!==void 0||"@@iterator"in e||B8(G8,F8(e))},q8=_(K8),ZN=x_.clear;Me({global:!0,bind:!0,forced:yt.clearImmediate!==ZN},{clearImmediate:ZN});var Y8=typeof Bun=="function"&&Bun&&typeof Bun.version=="string",tP=yt,z8=oe,J8=ee,X8=Y8,Q8=bi,$8=U_,Z8=Ul,tz=tP.Function,ez=/MSIE .\./.test(Q8)||X8&&function(){var t=tP.Bun.version.split(".");return t.length<3||t[0]==0&&(t[1]<3||t[1]==3&&t[2]==0)}(),nz=Me,eP=yt,nP=x_.set,rz=function(t,e){var n=1;return ez?function(r,i){var o=Z8(arguments.length,1)>n,a=J8(r)?r:tz(r),d=o?$8(arguments,n):[],l=o?function(){z8(a,this,d)}:a;return t(l)}:t},rP=eP.setImmediate?rz(nP):nP;nz({global:!0,bind:!0,forced:eP.setImmediate!==rP},{setImmediate:rP});var iP=_(xr.setImmediate),iz=Me,sz=vO,oz=Fr,az=Ul,cz=Dl,dz=yt.process;iz({global:!0,dontCallGetSet:!0},{queueMicrotask:function(t){az(arguments.length,1),oz(t);var e=cz&&dz.domain;sz(e?e.bind(t):t)}});var sP=_(xr.queueMicrotask);function oP(t,e){return function(){return t.apply(e,arguments)}}const{toString:lz}=Object.prototype,{getPrototypeOf:jv}=Object,dm=(Gv=Object.create(null),t=>{const e=lz.call(t);return Gv[e]||(Gv[e]=e.slice(8,-1).toLowerCase())});var Gv;const qs=t=>(t=t.toLowerCase(),e=>dm(e)===t),lm=t=>e=>typeof e===t,{isArray:$l}=Array,Xh=lm("undefined"),aP=qs("ArrayBuffer"),uz=lm("string"),ns=lm("function"),cP=lm("number"),um=t=>t!==null&&typeof t=="object",hm=t=>{if(dm(t)!=="object")return!1;const e=jv(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in t||q8(t))},hz=qs("Date"),pz=qs("File"),fz=qs("Blob"),_z=qs("FileList"),mz=qs("URLSearchParams"),[Ez,gz,Tz,Sz]=["ReadableStream","Request","Response","Headers"].map(qs);function Qh(t,e){let n,r,{allOwnKeys:i=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),$l(t))for(n=0,r=t.length;n<r;n++)e.call(null,t[n],n,t);else{const o=i?Object.getOwnPropertyNames(t):Object.keys(t),a=o.length;let d;for(n=0;n<a;n++)d=o[n],e.call(null,t[d],d,t)}}function dP(t,e){e=e.toLowerCase();const n=Object.keys(t);let r,i=n.length;for(;i-- >0;)if(r=n[i],e===r.toLowerCase())return r;return null}const hd=$N!==void 0?$N:typeof self<"u"?self:typeof window<"u"?window:ag,lP=t=>!Xh(t)&&t!==hd,vz=(Wv=typeof Uint8Array<"u"&&jv(Uint8Array),t=>Wv&&t instanceof Wv);var Wv;const yz=qs("HTMLFormElement"),uP=(t=>{let{hasOwnProperty:e}=t;return(n,r)=>e.call(n,r)})(Object.prototype),Rz=qs("RegExp"),hP=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};Qh(n,(i,o)=>{let a;(a=e(i,o,t))!==!1&&(r[o]=a||i)}),Object.defineProperties(t,r)},Hv="abcdefghijklmnopqrstuvwxyz",pP="0123456789",fP={DIGIT:pP,ALPHA:Hv,ALPHA_DIGIT:Hv+Hv.toUpperCase()+pP},Iz=qs("AsyncFunction"),_P=(mP=typeof iP=="function",EP=ns(hd.postMessage),mP?iP:EP?(Kv="axios@".concat(Math.random()),pm=[],hd.addEventListener("message",t=>{let{source:e,data:n}=t;e===hd&&n===Kv&&pm.length&&pm.shift()()},!1),t=>{pm.push(t),hd.postMessage(Kv,"*")}):t=>setTimeout(t));var mP,EP,Kv,pm;const Cz=sP!==void 0?sP.bind(hd):typeof process<"u"&&process.nextTick||_P;var _t={isArray:$l,isArrayBuffer:aP,isBuffer:function(t){return t!==null&&!Xh(t)&&t.constructor!==null&&!Xh(t.constructor)&&ns(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||ns(t.append)&&((e=dm(t))==="formdata"||e==="object"&&ns(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&aP(t.buffer),e},isString:uz,isNumber:cP,isBoolean:t=>t===!0||t===!1,isObject:um,isPlainObject:hm,isReadableStream:Ez,isRequest:gz,isResponse:Tz,isHeaders:Sz,isUndefined:Xh,isDate:hz,isFile:pz,isBlob:fz,isRegExp:Rz,isFunction:ns,isStream:t=>um(t)&&ns(t.pipe),isURLSearchParams:mz,isTypedArray:vz,isFileList:_z,forEach:Qh,merge:function t(){const{caseless:e}=lP(this)&&this||{},n={},r=(i,o)=>{const a=e&&dP(n,o)||o;hm(n[a])&&hm(i)?n[a]=t(n[a],i):hm(i)?n[a]=t({},i):$l(i)?n[a]=i.slice():n[a]=i};for(let i=0,o=arguments.length;i<o;i++)arguments[i]&&Qh(arguments[i],r);return n},extend:function(t,e,n){let{allOwnKeys:r}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Qh(e,(i,o)=>{n&&ns(i)?t[o]=oP(i,n):t[o]=i},{allOwnKeys:r}),t},trim:t=>Br(t)?Br(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},toFlatObject:(t,e,n,r)=>{let i,o,a;const d={};if(e=e||{},t==null)return e;do{for(i=Object.getOwnPropertyNames(t),o=i.length;o-- >0;)a=i[o],r&&!r(a,t,e)||d[a]||(e[a]=t[a],d[a]=!0);t=n!==!1&&jv(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:dm,kindOfTest:qs,endsWith:(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const r=t.indexOf(e,n);return r!==-1&&r===n},toArray:t=>{if(!t)return null;if($l(t))return t;let e=t.length;if(!cP(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{const n=(t&&t[Symbol.iterator]).call(t);let r;for(;(r=n.next())&&!r.done;){const i=r.value;e.call(t,i[0],i[1])}},matchAll:(t,e)=>{let n;const r=[];for(;(n=t.exec(e))!==null;)r.push(n);return r},isHTMLForm:yz,hasOwnProperty:uP,hasOwnProp:uP,reduceDescriptors:hP,freezeMethods:t=>{hP(t,(e,n)=>{if(ns(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=t[n];ns(r)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(t,e)=>{const n={},r=i=>{i.forEach(o=>{n[o]=!0})};return $l(t)?r(t):r(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,r){return n.toUpperCase()+r}),noop:()=>{},toFiniteNumber:(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,findKey:dP,global:hd,isContextDefined:lP,ALPHABET:fP,generateString:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:fP.ALPHA_DIGIT,n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n},isSpecCompliantForm:function(t){return!!(t&&ns(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])},toJSONObject:t=>{const e=new Array(10),n=(r,i)=>{if(um(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[i]=r;const o=$l(r)?[]:{};return Qh(r,(a,d)=>{const l=n(a,i+1);!Xh(l)&&(o[d]=l)}),e[i]=void 0,o}}return r};return n(t,0)},isAsyncFn:Iz,isThenable:t=>t&&(um(t)||ns(t))&&ns(t.then)&&ns(t.catch),setImmediate:_P,asap:Cz};function je(t,e,n,r,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),i&&(this.response=i,this.status=i.status?i.status:null)}_t.inherits(je,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:_t.toJSONObject(this.config),code:this.code,status:this.status}}});const gP=je.prototype,TP={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{TP[t]={value:t}}),Object.defineProperties(je,TP),Object.defineProperty(gP,"isAxiosError",{value:!0}),je.from=(t,e,n,r,i,o)=>{const a=Object.create(gP);return _t.toFlatObject(t,a,function(d){return d!==Error.prototype},d=>d!=="isAxiosError"),je.call(a,t.message,e,n,r,i),a.cause=t,a.name=t.name,o&&Object.assign(a,o),a};function qv(t){return _t.isPlainObject(t)||_t.isArray(t)}function SP(t){return _t.endsWith(t,"[]")?t.slice(0,-2):t}function vP(t,e,n){return t?t.concat(e).map(function(r,i){return r=SP(r),!n&&i?"["+r+"]":r}).join(n?".":""):e}const Az=_t.toFlatObject(_t,{},null,function(t){return/^is[A-Z]/.test(t)});function fm(t,e,n){if(!_t.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const r=(n=_t.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(T,S){return!_t.isUndefined(S[T])})).metaTokens,i=n.visitor||h,o=n.dots,a=n.indexes,d=(n.Blob||typeof Blob<"u"&&Blob)&&_t.isSpecCompliantForm(e);if(!_t.isFunction(i))throw new TypeError("visitor must be a function");function l(T){if(T===null)return"";if(_t.isDate(T))return T.toISOString();if(!d&&_t.isBlob(T))throw new je("Blob is not supported. Use a Buffer instead.");return _t.isArrayBuffer(T)||_t.isTypedArray(T)?d&&typeof Blob=="function"?new Blob([T]):Buffer.from(T):T}function h(T,S,w){let I=T;if(T&&!w&&typeof T=="object"){if(_t.endsWith(S,"{}"))S=r?S:S.slice(0,-2),T=JSON.stringify(T);else if(_t.isArray(T)&&function(C){return _t.isArray(C)&&!C.some(qv)}(T)||(_t.isFileList(T)||_t.endsWith(S,"[]"))&&(I=_t.toArray(T)))return S=SP(S),I.forEach(function(C,N){!_t.isUndefined(C)&&C!==null&&e.append(a===!0?vP([S],N,o):a===null?S:S+"[]",l(C))}),!1}return!!qv(T)||(e.append(vP(w,S,o),l(T)),!1)}const f=[],m=Object.assign(Az,{defaultVisitor:h,convertValue:l,isVisitable:qv});if(!_t.isObject(t))throw new TypeError("data must be an object");return function T(S,w){if(!_t.isUndefined(S)){if(f.indexOf(S)!==-1)throw Error("Circular reference detected in "+w.join("."));f.push(S),_t.forEach(S,function(I,C){(!(_t.isUndefined(I)||I===null)&&i.call(e,I,_t.isString(C)?Br(C).call(C):C,w,m))===!0&&T(I,w?w.concat(C):[C])}),f.pop()}}(t),e}function yP(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Yv(t,e){this._pairs=[],t&&fm(t,this,e)}const RP=Yv.prototype;function wz(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function IP(t,e,n){if(!e)return t;const r=n&&n.encode||wz;_t.isFunction(n)&&(n={serialize:n});const i=n&&n.serialize;let o;if(o=i?i(e,n):_t.isURLSearchParams(e)?e.toString():new Yv(e,n).toString(r),o){const a=t.indexOf("#");a!==-1&&(t=t.slice(0,a)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}RP.append=function(t,e){this._pairs.push([t,e])},RP.toString=function(t){const e=t?function(n){return t.call(this,n,yP)}:yP;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var CP=class{constructor(){this.handlers=[]}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){_t.forEach(this.handlers,function(e){e!==null&&t(e)})}},AP={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},wP={exports:{}},bz=Me,Oz=ne,bP=xi.f;bz({target:"Object",stat:!0,forced:Object.defineProperty!==bP,sham:!Oz},{defineProperty:bP});var OP=xr.Object,Nz=wP.exports=function(t,e,n){return OP.defineProperty(t,e,n)};OP.defineProperty.sham&&(Nz.sham=!0);var NP=_(wP.exports),Pz=TypeError,PP=Nh,Dz=M_,kz=Ur,Lz=bn("species"),DP=Array,Mz=function(t){var e;return PP(t)&&(e=t.constructor,(Dz(e)&&(e===DP||PP(e.prototype))||kz(e)&&(e=e[Lz])===null)&&(e=void 0)),e===void 0?DP:e},kP=function(t,e){return new(Mz(t))(e===0?0:e)},Uz=g,xz=$i,Vz=bn("species"),LP=function(t){return xz>=51||!Uz(function(){var e=[];return(e.constructor={})[Vz]=function(){return{foo:1}},e[t](Boolean).foo!==1})},Fz=Me,Bz=g,jz=Nh,Gz=Ur,Wz=gi,Hz=Qn,MP=function(t){if(t>9007199254740991)throw Pz("Maximum allowed index exceeded");return t},UP=H_,Kz=kP,qz=LP,Yz=$i,xP=bn("isConcatSpreadable"),zz=Yz>=51||!Bz(function(){var t=[];return t[xP]=!1,t.concat()[0]!==t}),Jz=function(t){if(!Gz(t))return!1;var e=t[xP];return e!==void 0?!!e:jz(t)};Fz({target:"Array",proto:!0,forced:!zz||!qz("concat")},{concat:function(t){var e,n,r,i,o,a=Wz(this),d=Kz(a,0),l=0;for(e=-1,r=arguments.length;e<r;e++)if(Jz(o=e===-1?a:arguments[e]))for(i=Hz(o),MP(l+i),n=0;n<i;n++,l++)n in o&&UP(d,l,o[n]);else MP(l+1),UP(d,l++,o);return d.length=l,d}});var VP={},Xz=J,Qz=Qi,FP=v_.f,$z=XS,BP=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];VP.f=function(t){return BP&&Xz(t)=="Window"?function(e){try{return FP(e)}catch{return $z(BP)}}(t):FP(Qz(t))};var Zl={},Zz=bn;Zl.f=Zz;var jP=xr,t7=or,e7=Zl,n7=xi.f,Tr=function(t){var e=jP.Symbol||(jP.Symbol={});t7(e,t)||n7(e,t,{value:e7.f(t)})},r7=an,i7=pn,s7=bn,o7=ic,GP=function(){var t=i7("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,r=s7("toPrimitive");e&&!e[r]&&o7(e,r,function(i){return r7(n,this)},{})},a7=On,c7=Hn,d7=gi,l7=Qn,u7=kP,WP=tt([].push),h7=function(t){var e=t==1,n=t==2,r=t==3,i=t==4,o=t==6,a=t==7,d=t==5||o;return function(l,h,f,m){for(var T,S,w=d7(l),I=c7(w),C=a7(h,f),N=l7(I),P=0,x=m||u7,W=e?x(l,N):n||a?x(l,0):void 0;N>P;P++)if((d||P in I)&&(S=C(T=I[P],P,w),t))if(e)W[P]=S;else if(S)switch(t){case 3:return!0;case 5:return T;case 6:return P;case 2:WP(W,T)}else switch(t){case 4:return!1;case 7:WP(W,T)}return o?-1:r||i?i:W}},HP={forEach:h7(0)},_m=Me,zv=yt,Jv=an,p7=tt,tu=ne,eu=fs,f7=g,Qr=or,_7=st,Xv=br,mm=Qi,Qv=da,m7=ts,$v=ie,$h=Dh,KP=R_,E7=v_,qP=VP,g7=Ph,YP=xn,zP=xi,T7=ZT,JP=Pt,XP=ic,S7=L_,Zv=wn,QP=y_,$P=Th,v7=bn,y7=Zl,R7=Tr,I7=GP,C7=sc,ZP=id,Em=HP.forEach,Fi=S_("hidden"),gm="Symbol",Zh="prototype",A7=ZP.set,tD=ZP.getterFor(gm),Ys=Object[Zh],pd=zv.Symbol,Tm=pd&&pd[Zh],w7=zv.TypeError,ty=zv.QObject,eD=YP.f,fd=zP.f,nD=qP.f,b7=JP.f,rD=p7([].push),Ea=Zv("symbols"),tp=Zv("op-symbols"),O7=Zv("wks"),ey=!ty||!ty[Zh]||!ty[Zh].findChild,ny=tu&&f7(function(){return $h(fd({},"a",{get:function(){return fd(this,"a",{value:7}).a}})).a!=7})?function(t,e,n){var r=eD(Ys,e);r&&delete Ys[e],fd(t,e,n),r&&t!==Ys&&fd(Ys,e,r)}:fd,ry=function(t,e){var n=Ea[t]=$h(Tm);return A7(n,{type:gm,tag:t,description:e}),tu||(n.description=e),n},Sm=function(t,e,n){t===Ys&&Sm(tp,e,n),Xv(t);var r=Qv(e);return Xv(n),Qr(Ea,r)?(n.enumerable?(Qr(t,Fi)&&t[Fi][r]&&(t[Fi][r]=!1),n=$h(n,{enumerable:$v(0,!1)})):(Qr(t,Fi)||fd(t,Fi,$v(1,{})),t[Fi][r]=!0),ny(t,r,n)):fd(t,r,n)},iy=function(t,e){Xv(t);var n=mm(e),r=KP(n).concat(aD(n));return Em(r,function(i){tu&&!Jv(iD,n,i)||Sm(t,i,n[i])}),t},iD=function(t){var e=Qv(t),n=Jv(b7,this,e);return!(this===Ys&&Qr(Ea,e)&&!Qr(tp,e))&&(!(n||!Qr(this,e)||!Qr(Ea,e)||Qr(this,Fi)&&this[Fi][e])||n)},sD=function(t,e){var n=mm(t),r=Qv(e);if(n!==Ys||!Qr(Ea,r)||Qr(tp,r)){var i=eD(n,r);return!i||!Qr(Ea,r)||Qr(n,Fi)&&n[Fi][r]||(i.enumerable=!0),i}},oD=function(t){var e=nD(mm(t)),n=[];return Em(e,function(r){Qr(Ea,r)||Qr(QP,r)||rD(n,r)}),n},aD=function(t){var e=t===Ys,n=nD(e?tp:mm(t)),r=[];return Em(n,function(i){!Qr(Ea,i)||e&&!Qr(Ys,i)||rD(r,Ea[i])}),r};eu||(pd=function(){if(_7(Tm,this))throw w7("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?m7(arguments[0]):void 0,e=$P(t),n=function(r){this===Ys&&Jv(n,tp,r),Qr(this,Fi)&&Qr(this[Fi],e)&&(this[Fi][e]=!1),ny(this,e,$v(1,r))};return tu&&ey&&ny(Ys,e,{configurable:!0,set:n}),ry(e,t)},XP(Tm=pd[Zh],"toString",function(){return tD(this).tag}),XP(pd,"withoutSetter",function(t){return ry($P(t),t)}),JP.f=iD,zP.f=Sm,T7.f=iy,YP.f=sD,E7.f=qP.f=oD,g7.f=aD,y7.f=function(t){return ry(v7(t),t)},tu&&S7(Tm,"description",{configurable:!0,get:function(){return tD(this).description}})),_m({global:!0,wrap:!0,forced:!eu,sham:!eu},{Symbol:pd}),Em(KP(O7),function(t){R7(t)}),_m({target:gm,stat:!0,forced:!eu},{useSetter:function(){ey=!0},useSimple:function(){ey=!1}}),_m({target:"Object",stat:!0,forced:!eu,sham:!tu},{create:function(t,e){return e===void 0?$h(t):iy($h(t),e)},defineProperty:Sm,defineProperties:iy,getOwnPropertyDescriptor:sD}),_m({target:"Object",stat:!0,forced:!eu},{getOwnPropertyNames:oD}),I7(),C7(pd,gm),QP[Fi]=!0;var cD=fs&&!!Symbol.for&&!!Symbol.keyFor,N7=Me,P7=pn,D7=or,k7=ts,dD=wn,L7=cD,sy=dD("string-to-symbol-registry"),M7=dD("symbol-to-string-registry");N7({target:"Symbol",stat:!0,forced:!L7},{for:function(t){var e=k7(t);if(D7(sy,e))return sy[e];var n=P7("Symbol")(e);return sy[e]=n,M7[n]=e,n}});var U7=Me,x7=or,V7=Vs,F7=ms,B7=cD,lD=wn("symbol-to-string-registry");U7({target:"Symbol",stat:!0,forced:!B7},{keyFor:function(t){if(!V7(t))throw TypeError(F7(t)+" is not a symbol");if(x7(lD,t))return lD[t]}});var uD=Nh,j7=ee,hD=J,G7=ts,pD=tt([].push),W7=Me,fD=pn,_D=oe,H7=an,ep=tt,mD=g,ED=ee,gD=Vs,TD=U_,K7=function(t){if(j7(t))return t;if(uD(t)){for(var e=t.length,n=[],r=0;r<e;r++){var i=t[r];typeof i=="string"?pD(n,i):typeof i!="number"&&hD(i)!="Number"&&hD(i)!="String"||pD(n,G7(i))}var o=n.length,a=!0;return function(d,l){if(a)return a=!1,l;if(uD(this))return l;for(var h=0;h<o;h++)if(n[h]===d)return l}}},q7=fs,Y7=String,lc=fD("JSON","stringify"),vm=ep(/./.exec),SD=ep("".charAt),z7=ep("".charCodeAt),J7=ep("".replace),X7=ep(1 .toString),Q7=/[\uD800-\uDFFF]/g,vD=/^[\uD800-\uDBFF]$/,yD=/^[\uDC00-\uDFFF]$/,RD=!q7||mD(function(){var t=fD("Symbol")();return lc([t])!="[null]"||lc({a:t})!="{}"||lc(Object(t))!="{}"}),ID=mD(function(){return lc("\uDF06\uD834")!=='"\\udf06\\ud834"'||lc("\uDEAD")!=='"\\udead"'}),$7=function(t,e){var n=TD(arguments),r=K7(e);if(ED(r)||t!==void 0&&!gD(t))return n[1]=function(i,o){if(ED(r)&&(o=H7(r,this,Y7(i),o)),!gD(o))return o},_D(lc,null,n)},Z7=function(t,e,n){var r=SD(n,e-1),i=SD(n,e+1);return vm(vD,t)&&!vm(yD,i)||vm(yD,t)&&!vm(vD,r)?"\\u"+X7(z7(t,0),16):t};lc&&W7({target:"JSON",stat:!0,forced:RD||ID},{stringify:function(t,e,n){var r=TD(arguments),i=_D(RD?$7:lc,null,r);return ID&&typeof i=="string"?J7(i,Q7,Z7):i}});var CD=Ph,tJ=gi;Me({target:"Object",stat:!0,forced:!fs||g(function(){CD.f(1)})},{getOwnPropertySymbols:function(t){var e=CD.f;return e?e(tJ(t)):[]}}),Tr("asyncIterator"),Tr("hasInstance"),Tr("isConcatSpreadable"),Tr("iterator"),Tr("match"),Tr("matchAll"),Tr("replace"),Tr("search"),Tr("species"),Tr("split");var eJ=GP;Tr("toPrimitive"),eJ();var nJ=pn,rJ=sc;Tr("toStringTag"),rJ(nJ("Symbol"),"Symbol"),Tr("unscopables"),sc(yt.JSON,"JSON",!0);var iJ=xr.Symbol,sJ=bn,oJ=xi.f,AD=sJ("metadata"),wD=Function.prototype;wD[AD]===void 0&&oJ(wD,AD,{value:null}),Tr("dispose"),Tr("metadata");var aJ=iJ;Tr("asyncDispose");var cJ=tt,oy=pn("Symbol"),dJ=oy.keyFor,lJ=cJ(oy.prototype.valueOf),bD=oy.isRegisteredSymbol||function(t){try{return dJ(lJ(t))!==void 0}catch{return!1}};Me({target:"Symbol",stat:!0},{isRegisteredSymbol:bD});for(var uJ=wn,OD=pn,hJ=tt,pJ=Vs,fJ=bn,ym=OD("Symbol"),ND=ym.isWellKnownSymbol,PD=OD("Object","getOwnPropertyNames"),_J=hJ(ym.prototype.valueOf),DD=uJ("wks"),ay=0,kD=PD(ym),mJ=kD.length;ay<mJ;ay++)try{var LD=kD[ay];pJ(ym[LD])&&fJ(LD)}catch{}var MD=function(t){if(ND&&ND(t))return!0;try{for(var e=_J(t),n=0,r=PD(DD),i=r.length;n<i;n++)if(DD[r[n]]==e)return!0}catch{}return!1};Me({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:MD}),Tr("matcher"),Tr("observable"),Me({target:"Symbol",stat:!0},{isRegistered:bD}),Me({target:"Symbol",stat:!0,forced:!0},{isWellKnown:MD}),Tr("metadataKey"),Tr("patternMatch"),Tr("replaceAll");var nu=_(aJ),UD=_(Zl.f("iterator"));function np(t){return np=typeof nu=="function"&&typeof UD=="symbol"?function(e){return typeof e}:function(e){return e&&typeof nu=="function"&&e.constructor===nu&&e!==nu.prototype?"symbol":typeof e},np(t)}var EJ=_(Zl.f("toPrimitive"));function gJ(t){var e=function(n,r){if(np(n)!=="object"||n===null)return n;var i=n[EJ];if(i!==void 0){var o=i.call(n,r);if(np(o)!=="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(n)}(t,"string");return np(e)==="symbol"?e:String(e)}function b(t,e,n){return(e=gJ(e))in t?NP(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var xD=_($9),TJ={isBrowser:!0,classes:{URLSearchParams:xD!==void 0?xD:Yv,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const cy=typeof window<"u"&&typeof document<"u",dy=typeof navigator=="object"&&navigator||void 0,SJ=cy&&(!dy||["ReactNative","NativeScript","NS"].indexOf(dy.product)<0),vJ=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",yJ=cy&&window.location.href||"http://localhost";function VD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function FD(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?VD(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):VD(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}var Ti=FD(FD({},Object.freeze({__proto__:null,hasBrowserEnv:cy,hasStandardBrowserEnv:SJ,hasStandardBrowserWebWorkerEnv:vJ,navigator:dy,origin:yJ})),TJ),RJ=br,IJ=an,CJ=or,AJ=st,wJ=function(){var t=RJ(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},BD=RegExp.prototype,jD=function(t){var e=t.flags;return e!==void 0||"flags"in BD||CJ(t,"flags")||!AJ(BD,t)?e:IJ(wJ,t)},bJ=KS.charAt,GD=an,OJ=br,NJ=ee,PJ=J,DJ=/./.exec,kJ=TypeError,LJ=Me,WD=an,HD=Z,MJ=hS,Rm=fS,KD=Yr,qD=Ft,rp=ts,UJ=br,xJ=jt,VJ=J,FJ=tb,YD=jD,BJ=$a,jJ=g,GJ=TS,WJ=function(t,e,n){return e+(n?bJ(t,e).length:1)},HJ=function(t,e){var n=t.exec;if(NJ(n)){var r=GD(n,t,e);return r!==null&&OJ(r),r}if(PJ(t)==="RegExp")return GD(DJ,t,e);throw kJ("RegExp#exec called on incompatible receiver")},zD=id,KJ=bn("matchAll"),JD="RegExp String",XD=JD+" Iterator",qJ=zD.set,YJ=zD.getterFor(XD),zJ=TypeError,ly=HD("".indexOf),Im=HD("".matchAll),uy=!!Im&&!jJ(function(){Im("a",/./)}),JJ=MJ(function(t,e,n,r){qJ(this,{type:XD,regexp:t,string:e,global:n,unicode:r,done:!1})},JD,function(){var t=YJ(this);if(t.done)return Rm(void 0,!0);var e=t.regexp,n=t.string,r=HJ(e,n);return r===null?(t.done=!0,Rm(void 0,!0)):t.global?(rp(r[0])===""&&(e.lastIndex=WJ(n,qD(e.lastIndex),t.unicode)),Rm(r,!1)):(t.done=!0,Rm(r,!1))}),QD=function(t){var e,n,r,i=UJ(this),o=rp(t),a=GJ(i,RegExp),d=rp(YD(i));return e=new a(a===RegExp?i.source:i,d),n=!!~ly(d,"g"),r=!!~ly(d,"u"),e.lastIndex=qD(i.lastIndex),new JJ(e,o,n,r)};LJ({target:"String",proto:!0,forced:uy},{matchAll:function(t){var e,n,r,i,o=KD(this);if(xJ(t)){if(uy)return Im(o,t)}else{if(FJ(t)&&(e=rp(KD(YD(t))),!~ly(e,"g")))throw zJ("`.matchAll` does not allow non-global regexes");if(uy)return Im(o,t);if((r=BJ(t,KJ))===void 0&&VJ(t)=="RegExp"&&(r=QD),r)return WD(r,t,o)}return n=rp(o),i=new RegExp(t,"g"),WD(QD,i,n)}});var XJ=Es("String").matchAll,QJ=st,$J=XJ,hy=String.prototype,ZJ=function(t){var e=t.matchAll;return typeof t=="string"||t===hy||QJ(hy,t)&&e===hy.matchAll?$J:e},tX=_(ZJ);function $D(t){function e(n,r,i,o){let a=n[o++];if(a==="__proto__")return!0;const d=Number.isFinite(+a),l=o>=n.length;return a=!a&&_t.isArray(i)?i.length:a,l?(_t.hasOwnProp(i,a)?i[a]=[i[a],r]:i[a]=r,!d):(i[a]&&_t.isObject(i[a])||(i[a]=[]),e(n,r,i[a],o)&&_t.isArray(i[a])&&(i[a]=function(h){const f={},m=Object.keys(h);let T;const S=m.length;let w;for(T=0;T<S;T++)w=m[T],f[w]=h[w];return f}(i[a])),!d)}if(_t.isFormData(t)&&_t.isFunction(t.entries)){const n={};return _t.forEachEntry(t,(r,i)=>{e(function(o){return tX(_t).call(_t,/\w+|\[(\w*)]/g,o).map(a=>a[0]==="[]"?"":a[1]||a[0])}(r),i,n,0)}),n}return null}const py={transitional:AP,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const n=e.getContentType()||"",r=n.indexOf("application/json")>-1,i=_t.isObject(t);if(i&&_t.isHTMLForm(t)&&(t=new FormData(t)),_t.isFormData(t))return r?JSON.stringify($D(t)):t;if(_t.isArrayBuffer(t)||_t.isBuffer(t)||_t.isStream(t)||_t.isFile(t)||_t.isBlob(t)||_t.isReadableStream(t))return t;if(_t.isArrayBufferView(t))return t.buffer;if(_t.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(a,d){return fm(a,new Ti.classes.URLSearchParams,Object.assign({visitor:function(l,h,f,m){return Ti.isNode&&_t.isBuffer(l)?(this.append(h,l.toString("base64")),!1):m.defaultVisitor.apply(this,arguments)}},d))}(t,this.formSerializer).toString();if((o=_t.isFileList(t))||n.indexOf("multipart/form-data")>-1){const a=this.env&&this.env.FormData;return fm(o?{"files[]":t}:t,a&&new a,this.formSerializer)}}return i||r?(e.setContentType("application/json",!1),function(a,d,l){if(_t.isString(a))try{return(d||JSON.parse)(a),Br(_t).call(_t,a)}catch(h){if(h.name!=="SyntaxError")throw h}return(l||JSON.stringify)(a)}(t)):t}],transformResponse:[function(t){const e=this.transitional||py.transitional,n=e&&e.forcedJSONParsing,r=this.responseType==="json";if(_t.isResponse(t)||_t.isReadableStream(t))return t;if(t&&_t.isString(t)&&(n&&!this.responseType||r)){const i=!(e&&e.silentJSONParsing)&&r;try{return JSON.parse(t)}catch(o){if(i)throw o.name==="SyntaxError"?je.from(o,je.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Ti.classes.FormData,Blob:Ti.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};_t.forEach(["delete","get","head","post","put","patch"],t=>{py.headers[t]={}});var fy=py;const eX=_t.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),ZD=Symbol("internals");function ip(t){var e;return t&&Br(e=String(t)).call(e).toLowerCase()}function Cm(t){return t===!1||t==null?t:_t.isArray(t)?t.map(Cm):String(t)}function _y(t,e,n,r,i){return _t.isFunction(r)?r.call(this,e,n):(i&&(e=n),_t.isString(e)?_t.isString(r)?e.indexOf(r)!==-1:_t.isRegExp(r)?r.test(e):void 0:void 0)}class Am{constructor(e){e&&this.set(e)}set(e,n,r){const i=this;function o(l,h,f){const m=ip(h);if(!m)throw new Error("header name must be a non-empty string");const T=_t.findKey(i,m);(!T||i[T]===void 0||f===!0||f===void 0&&i[T]!==!1)&&(i[T||h]=Cm(l))}const a=(l,h)=>_t.forEach(l,(f,m)=>o(f,m,h));if(_t.isPlainObject(e)||e instanceof this.constructor)a(e,n);else if(_t.isString(e)&&(e=Br(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(Br(d=e).call(d)))a((l=>{const h={};let f,m,T;return l&&l.split(`
`).forEach(function(S){var w,I;T=S.indexOf(":"),f=Br(w=S.substring(0,T)).call(w).toLowerCase(),m=Br(I=S.substring(T+1)).call(I),!f||h[f]&&eX[f]||(f==="set-cookie"?h[f]?h[f].push(m):h[f]=[m]:h[f]=h[f]?h[f]+", "+m:m)}),h})(e),n);else if(_t.isHeaders(e))for(const[l,h]of e.entries())o(h,l,r);else e!=null&&o(n,e,r);var d;return this}get(e,n){if(e=ip(e)){const r=_t.findKey(this,e);if(r){const i=this[r];if(!n)return i;if(n===!0)return function(o){const a=Object.create(null),d=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let l;for(;l=d.exec(o);)a[l[1]]=l[2];return a}(i);if(_t.isFunction(n))return n.call(this,i,r);if(_t.isRegExp(n))return n.exec(i);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=ip(e)){const r=_t.findKey(this,e);return!(!r||this[r]===void 0||n&&!_y(0,this[r],r,n))}return!1}delete(e,n){const r=this;let i=!1;function o(a){if(a=ip(a)){const d=_t.findKey(r,a);!d||n&&!_y(0,r[d],d,n)||(delete r[d],i=!0)}}return _t.isArray(e)?e.forEach(o):o(e),i}clear(e){const n=Object.keys(this);let r=n.length,i=!1;for(;r--;){const o=n[r];e&&!_y(0,this[o],o,e,!0)||(delete this[o],i=!0)}return i}normalize(e){const n=this,r={};return _t.forEach(this,(i,o)=>{var a;const d=_t.findKey(r,o);if(d)return n[d]=Cm(i),void delete n[o];const l=e?function(h){return Br(h).call(h).toLowerCase().replace(/([a-z\d])(\w*)/g,(f,m,T)=>m.toUpperCase()+T)}(o):Br(a=String(o)).call(a);l!==o&&delete n[o],n[l]=Cm(i),r[l]=!0}),this}concat(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return this.constructor.concat(this,...n)}toJSON(e){const n=Object.create(null);return _t.forEach(this,(r,i)=>{r!=null&&r!==!1&&(n[i]=e&&_t.isArray(r)?r.join(", "):r)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[n,r]=e;return n+": "+r}).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const n=new this(e);for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i.forEach(a=>n.set(a)),n}static accessor(e){const n=(this[ZD]=this[ZD]={accessors:{}}).accessors,r=this.prototype;function i(o){const a=ip(o);n[a]||(function(d,l){const h=_t.toCamelCase(" "+l);["get","set","has"].forEach(f=>{Object.defineProperty(d,f+h,{value:function(m,T,S){return this[f].call(this,l,m,T,S)},configurable:!0})})}(r,o),n[a]=!0)}return _t.isArray(e)?e.forEach(i):i(e),this}}Am.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),_t.reduceDescriptors(Am.prototype,(t,e)=>{let{value:n}=t,r=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(i){this[r]=i}}}),_t.freezeMethods(Am);var zs=Am;function my(t,e){const n=this||fy,r=e||n,i=zs.from(r.headers);let o=r.data;return _t.forEach(t,function(a){o=a.call(n,o,i.normalize(),e?e.status:void 0)}),i.normalize(),o}function tk(t){return!(!t||!t.__CANCEL__)}function ru(t,e,n){je.call(this,t??"canceled",je.ERR_CANCELED,e,n),this.name="CanceledError"}function ek(t,e,n){const r=n.config.validateStatus;n.status&&r&&!r(n.status)?e(new je("Request failed with status code "+n.status,[je.ERR_BAD_REQUEST,je.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):t(n)}_t.inherits(ru,je,{__CANCEL__:!0});const wm=function(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,r=0;const i=function(o,a){o=o||10;const d=new Array(o),l=new Array(o);let h,f=0,m=0;return a=a!==void 0?a:1e3,function(T){const S=Date.now(),w=l[m];h||(h=S),d[f]=T,l[f]=S;let I=m,C=0;for(;I!==f;)C+=d[I++],I%=o;if(f=(f+1)%o,f===m&&(m=(m+1)%o),S-h<a)return;const N=w&&S-w;return N?Math.round(1e3*C/N):void 0}}(50,250);return function(o,a){let d,l,h=0,f=1e3/a;const m=function(T){h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),d=null,l&&(clearTimeout(l),l=null),o.apply(null,T)};return[function(){const T=Date.now(),S=T-h;for(var w=arguments.length,I=new Array(w),C=0;C<w;C++)I[C]=arguments[C];S>=f?m(I,T):(d=I,l||(l=setTimeout(()=>{l=null,m(d)},f-S)))},()=>d&&m(d)]}(o=>{const a=o.loaded,d=o.lengthComputable?o.total:void 0,l=a-r,h=i(l);r=a,t({loaded:a,total:d,progress:d?a/d:void 0,bytes:l,rate:h||void 0,estimated:h&&d&&a<=d?(d-a)/h:void 0,event:o,lengthComputable:d!=null,[e?"download":"upload"]:!0})},n)},nk=(t,e)=>{const n=t!=null;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},rk=t=>function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return _t.asap(()=>t(...n))};var nX=Ti.hasStandardBrowserEnv?((t,e)=>n=>(n=new nm(n,Ti.origin),t.protocol===n.protocol&&t.host===n.host&&(e||t.port===n.port)))(new nm(Ti.origin),Ti.navigator&&/(msie|trident)/i.test(Ti.navigator.userAgent)):()=>!0,rX=Ti.hasStandardBrowserEnv?{write(t,e,n,r,i,o){const a=[t+"="+encodeURIComponent(e)];_t.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),_t.isString(r)&&a.push("path="+r),_t.isString(i)&&a.push("domain="+i),o===!0&&a.push("secure"),document.cookie=a.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function ik(t,e){return t&&!function(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}(e)?function(n,r){return r?n.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):n}(t,e):e}function sk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}const ok=t=>t instanceof zs?function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?sk(Object(r),!0).forEach(function(i){b(e,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):sk(Object(r)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(r,i))})}return e}({},t):t;function _d(t,e){e=e||{};const n={};function r(h,f,m,T){return _t.isPlainObject(h)&&_t.isPlainObject(f)?_t.merge.call({caseless:T},h,f):_t.isPlainObject(f)?_t.merge({},f):_t.isArray(f)?f.slice():f}function i(h,f,m,T){return _t.isUndefined(f)?_t.isUndefined(h)?void 0:r(void 0,h,0,T):r(h,f,0,T)}function o(h,f){if(!_t.isUndefined(f))return r(void 0,f)}function a(h,f){return _t.isUndefined(f)?_t.isUndefined(h)?void 0:r(void 0,h):r(void 0,f)}function d(h,f,m){return m in e?r(h,f):m in t?r(void 0,h):void 0}const l={url:o,method:o,data:o,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:d,headers:(h,f,m)=>i(ok(h),ok(f),0,!0)};return _t.forEach(Object.keys(Object.assign({},t,e)),function(h){const f=l[h]||i,m=f(t[h],e[h],h);_t.isUndefined(m)&&f!==d||(n[h]=m)}),n}var ak=t=>{const e=_d({},t);let n,{data:r,withXSRFToken:i,xsrfHeaderName:o,xsrfCookieName:a,headers:d,auth:l}=e;if(e.headers=d=zs.from(d),e.url=IP(ik(e.baseURL,e.url),t.params,t.paramsSerializer),l&&d.set("Authorization","Basic "+btoa((l.username||"")+":"+(l.password?unescape(encodeURIComponent(l.password)):""))),_t.isFormData(r)){if(Ti.hasStandardBrowserEnv||Ti.hasStandardBrowserWebWorkerEnv)d.setContentType(void 0);else if((n=d.getContentType())!==!1){const[h,...f]=n?n.split(";").map(m=>Br(m).call(m)).filter(Boolean):[];d.setContentType([h||"multipart/form-data",...f].join("; "))}}if(Ti.hasStandardBrowserEnv&&(i&&_t.isFunction(i)&&(i=i(e)),i||i!==!1&&nX(e.url))){const h=o&&a&&rX.read(a);h&&d.set(o,h)}return e},iX=typeof XMLHttpRequest<"u"&&function(t){return new mt(function(e,n){const r=ak(t);let i=r.data;const o=zs.from(r.headers).normalize();let a,d,l,h,f,{responseType:m,onUploadProgress:T,onDownloadProgress:S}=r;function w(){h&&h(),f&&f(),r.cancelToken&&r.cancelToken.unsubscribe(a),r.signal&&r.signal.removeEventListener("abort",a)}let I=new XMLHttpRequest;function C(){if(!I)return;const P=zs.from("getAllResponseHeaders"in I&&I.getAllResponseHeaders());ek(function(x){e(x),w()},function(x){n(x),w()},{data:m&&m!=="text"&&m!=="json"?I.response:I.responseText,status:I.status,statusText:I.statusText,headers:P,config:t,request:I}),I=null}I.open(r.method.toUpperCase(),r.url,!0),I.timeout=r.timeout,"onloadend"in I?I.onloadend=C:I.onreadystatechange=function(){I&&I.readyState===4&&(I.status!==0||I.responseURL&&I.responseURL.indexOf("file:")===0)&&setTimeout(C)},I.onabort=function(){I&&(n(new je("Request aborted",je.ECONNABORTED,t,I)),I=null)},I.onerror=function(){n(new je("Network Error",je.ERR_NETWORK,t,I)),I=null},I.ontimeout=function(){let P=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const x=r.transitional||AP;r.timeoutErrorMessage&&(P=r.timeoutErrorMessage),n(new je(P,x.clarifyTimeoutError?je.ETIMEDOUT:je.ECONNABORTED,t,I)),I=null},i===void 0&&o.setContentType(null),"setRequestHeader"in I&&_t.forEach(o.toJSON(),function(P,x){I.setRequestHeader(x,P)}),_t.isUndefined(r.withCredentials)||(I.withCredentials=!!r.withCredentials),m&&m!=="json"&&(I.responseType=r.responseType),S&&([l,f]=wm(S,!0),I.addEventListener("progress",l)),T&&I.upload&&([d,h]=wm(T),I.upload.addEventListener("progress",d),I.upload.addEventListener("loadend",h)),(r.cancelToken||r.signal)&&(a=P=>{I&&(n(!P||P.type?new ru(null,t,I):P),I.abort(),I=null)},r.cancelToken&&r.cancelToken.subscribe(a),r.signal&&(r.signal.aborted?a():r.signal.addEventListener("abort",a)));const N=function(P){const x=/^([-+\w]{1,25})(:?\/\/|:)/.exec(P);return x&&x[1]||""}(r.url);N&&Ti.protocols.indexOf(N)===-1?n(new je("Unsupported protocol "+N+":",je.ERR_BAD_REQUEST,t)):I.send(i||null)})},sX=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r,i=new AbortController;const o=function(h){if(!r){r=!0,d();const f=h instanceof Error?h:this.reason;i.abort(f instanceof je?f:new ru(f instanceof Error?f.message:f))}};let a=e&&setTimeout(()=>{a=null,o(new je("timeout ".concat(e," of ms exceeded"),je.ETIMEDOUT))},e);const d=()=>{t&&(a&&clearTimeout(a),a=null,t.forEach(h=>{h.unsubscribe?h.unsubscribe(o):h.removeEventListener("abort",o)}),t=null)};t.forEach(h=>h.addEventListener("abort",o));const{signal:l}=i;return l.unsubscribe=()=>_t.asap(d),l}},oX=ZO,aX=vo;Me({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=aX.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var cX=vo,dX=Vl;Me({target:"Promise",stat:!0,forced:!0},{try:function(t){var e=cX.f(this),n=dX(t);return(n.error?e.reject:e.resolve)(n.value),e.promise}});var Ey=_(oX),ck=Zl.f("asyncIterator"),lX=_(ck);function gy(t,e){this.v=t,this.k=e}function sp(t){var e,n;function r(o,a){try{var d=t[o](a),l=d.value,h=l instanceof gy;Ey.resolve(h?l.v:l).then(function(f){if(h){var m=o==="return"?"return":"next";if(!l.k||f.done)return r(m,f);f=t[m](f).value}i(d.done?"return":"normal",f)},function(f){r("throw",f)})}catch(f){i("throw",f)}}function i(o,a){switch(o){case"return":e.resolve({value:a,done:!0});break;case"throw":e.reject(a);break;default:e.resolve({value:a,done:!1})}(e=e.next)?r(e.key,e.arg):n=null}this._invoke=function(o,a){return new Ey(function(d,l){var h={key:o,arg:a,resolve:d,reject:l,next:null};n?n=n.next=h:(e=n=h,r(o,a))})},typeof t.return!="function"&&(this.return=void 0)}function rs(t){return function(){return new sp(t.apply(this,arguments))}}function Se(t){return new gy(t,0)}function bm(t){var e={},n=!1;function r(i,o){return n=!0,{done:!1,value:new gy(o=new Ey(function(a){a(t[i](o))}),1)}}return e[nu!==void 0&&UD||"@@iterator"]=function(){return this},e.next=function(i){return n?(n=!1,i):r("next",i)},typeof t.throw=="function"&&(e.throw=function(i){if(n)throw n=!1,i;return r("throw",i)}),typeof t.return=="function"&&(e.return=function(i){return n?(n=!1,i):r("return",i)}),e}sp.prototype[typeof nu=="function"&&lX||"@@asyncIterator"]=function(){return this},sp.prototype.next=function(t){return this._invoke("next",t)},sp.prototype.throw=function(t){return this._invoke("throw",t)},sp.prototype.return=function(t){return this._invoke("return",t)};var Ty=_(ck);function Sy(t){var e,n,r,i=2;for(typeof Symbol<"u"&&(n=Ty,r=Symbol.iterator);i--;){if(n&&(e=t[n])!=null)return e.call(t);if(r&&(e=t[r])!=null)return new Om(e.call(t));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Om(t){function e(n){if(Object(n)!==n)return mt.reject(new TypeError(n+" is not an object."));var r=n.done;return mt.resolve(n.value).then(function(i){return{value:i,done:r}})}return Om=function(n){this.s=n,this.n=n.next},Om.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?mt.resolve({value:n,done:!0}):e(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?mt.reject(n):e(r.apply(this.s,arguments))}},new Om(t)}const uX=function*(t,e){let n=t.byteLength;if(!e||n<e)return void(yield t);let r,i=0;for(;i<n;)r=i+e,yield t.slice(i,r),i=r},hX=function(){var t=rs(function*(e,n){var r,i=!1,o=!1;try{for(var a,d=Sy(pX(e));i=!(a=yield Se(d.next())).done;i=!1){const l=a.value;yield*bm(Sy(uX(l,n)))}}catch(l){o=!0,r=l}finally{try{i&&d.return!=null&&(yield Se(d.return()))}finally{if(o)throw r}}});return function(e,n){return t.apply(this,arguments)}}(),pX=function(){var t=rs(function*(e){if(e[Ty])return void(yield*bm(Sy(e)));const n=e.getReader();try{for(;;){const{done:r,value:i}=yield Se(n.read());if(r)break;yield i}}finally{yield Se(n.cancel())}});return function(e){return t.apply(this,arguments)}}(),dk=(t,e,n,r)=>{const i=hX(t,e);let o,a=0,d=l=>{o||(o=!0,r&&r(l))};return new ReadableStream({async pull(l){try{const{done:h,value:f}=await i.next();if(h)return d(),void l.close();let m=f.byteLength;if(n){let T=a+=m;n(T)}l.enqueue(new Uint8Array(f))}catch(h){throw d(h),h}},cancel:l=>(d(l),i.return())},{highWaterMark:2})};function lk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function uk(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lk(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lk(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const Nm=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",hk=Nm&&typeof ReadableStream=="function",fX=Nm&&(typeof TextEncoder=="function"?(pk=new TextEncoder,t=>pk.encode(t)):async t=>new Uint8Array(await new Response(t).arrayBuffer()));var pk;const fk=function(t){try{for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return!!t(...n)}catch{return!1}},_X=hk&&fk(()=>{let t=!1;const e=new Request(Ti.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),vy=hk&&fk(()=>_t.isReadableStream(new Response("").body)),Pm={stream:vy&&(t=>t.body)};var _k;Nm&&(_k=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!Pm[t]&&(Pm[t]=_t.isFunction(_k[t])?e=>e[t]():(e,n)=>{throw new je("Response type '".concat(t,"' is not supported"),je.ERR_NOT_SUPPORT,n)})}));const mX=async(t,e)=>{const n=_t.toFiniteNumber(t.getContentLength());return n??(async r=>r==null?0:_t.isBlob(r)?r.size:_t.isSpecCompliantForm(r)?(await new Request(Ti.origin,{method:"POST",body:r}).arrayBuffer()).byteLength:_t.isArrayBufferView(r)||_t.isArrayBuffer(r)?r.byteLength:(_t.isURLSearchParams(r)&&(r+=""),_t.isString(r)?(await fX(r)).byteLength:void 0))(e)};var EX=Nm&&(async t=>{let{url:e,method:n,data:r,signal:i,cancelToken:o,timeout:a,onDownloadProgress:d,onUploadProgress:l,responseType:h,headers:f,withCredentials:m="same-origin",fetchOptions:T}=ak(t);h=h?(h+"").toLowerCase():"text";let S,w=sX([i,o&&o.toAbortSignal()],a);const I=w&&w.unsubscribe&&(()=>{w.unsubscribe()});let C;try{if(l&&_X&&n!=="get"&&n!=="head"&&(C=await mX(f,r))!==0){let H,j=new Request(e,{method:"POST",body:r,duplex:"half"});if(_t.isFormData(r)&&(H=j.headers.get("content-type"))&&f.setContentType(H),j.body){const[$,ct]=nk(C,wm(rk(l)));r=dk(j.body,65536,$,ct)}}_t.isString(m)||(m=m?"include":"omit");const N="credentials"in Request.prototype;S=new Request(e,uk(uk({},T),{},{signal:w,method:n.toUpperCase(),headers:f.normalize().toJSON(),body:r,duplex:"half",credentials:N?m:void 0}));let P=await fetch(S);const x=vy&&(h==="stream"||h==="response");if(vy&&(d||x&&I)){const H={};["status","statusText","headers"].forEach(Et=>{H[Et]=P[Et]});const j=_t.toFiniteNumber(P.headers.get("content-length")),[$,ct]=d&&nk(j,wm(rk(d),!0))||[];P=new Response(dk(P.body,65536,$,()=>{ct&&ct(),I&&I()}),H)}h=h||"text";let W=await Pm[_t.findKey(Pm,h)||"text"](P,t);return!x&&I&&I(),await new mt((H,j)=>{ek(H,j,{data:W,headers:zs.from(P.headers),status:P.status,statusText:P.statusText,config:t,request:S})})}catch(N){throw I&&I(),N&&N.name==="TypeError"&&/fetch/i.test(N.message)?Object.assign(new je("Network Error",je.ERR_NETWORK,t,S),{cause:N.cause||N}):je.from(N,N&&N.code,t,S)}});const yy={http:null,xhr:iX,fetch:EX};_t.forEach(yy,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const mk=t=>"- ".concat(t),gX=t=>_t.isFunction(t)||t===null||t===!1;var Ek={getAdapter:t=>{t=_t.isArray(t)?t:[t];const{length:e}=t;let n,r;const i={};for(let o=0;o<e;o++){let a;if(n=t[o],r=n,!gX(n)&&(r=yy[(a=String(n)).toLowerCase()],r===void 0))throw new je("Unknown adapter '".concat(a,"'"));if(r)break;i[a||"#"+o]=r}if(!r){const o=Object.entries(i).map(a=>{let[d,l]=a;return"adapter ".concat(d," ")+(l===!1?"is not supported by the environment":"is not available in the build")});throw new je("There is no suitable adapter to dispatch the request "+(e?o.length>1?`since :
`+o.map(mk).join(`
`):" "+mk(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:yy};function Ry(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new ru(null,t)}function gk(t){return Ry(t),t.headers=zs.from(t.headers),t.data=my.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Ek.getAdapter(t.adapter||fy.adapter)(t).then(function(e){return Ry(t),e.data=my.call(t,t.transformResponse,e),e.headers=zs.from(e.headers),e},function(e){return tk(e)||(Ry(t),e&&e.response&&(e.response.data=my.call(t,t.transformResponse,e.response),e.response.headers=zs.from(e.response.headers))),mt.reject(e)})}const Tk="1.7.9",Dm={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{Dm[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const Sk={};Dm.transitional=function(t,e,n){function r(i,o){return"[Axios v"+Tk+"] Transitional option '"+i+"'"+o+(n?". "+n:"")}return(i,o,a)=>{if(t===!1)throw new je(r(o," has been removed"+(e?" in "+e:"")),je.ERR_DEPRECATED);return e&&!Sk[o]&&(Sk[o]=!0,console.warn(r(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(i,o,a)}},Dm.spelling=function(t){return(e,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(t)),!0)};var km={assertOptions:function(t,e,n){if(typeof t!="object")throw new je("options must be an object",je.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let i=r.length;for(;i-- >0;){const o=r[i],a=e[o];if(a){const d=t[o],l=d===void 0||a(d,o,t);if(l!==!0)throw new je("option "+o+" must be "+l,je.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new je("Unknown option "+o,je.ERR_BAD_OPTION)}},validators:Dm};const Io=km.validators;let Lm=class{constructor(t){this.defaults=t,this.interceptors={request:new CP,response:new CP}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let r={};Error.captureStackTrace?Error.captureStackTrace(r):r=new Error;const i=r.stack?r.stack.replace(/^.+\n/,""):"";try{n.stack?i&&!String(n.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+i):n.stack=i}catch{}}throw n}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=_d(this.defaults,e);const{transitional:n,paramsSerializer:r,headers:i}=e;n!==void 0&&km.assertOptions(n,{silentJSONParsing:Io.transitional(Io.boolean),forcedJSONParsing:Io.transitional(Io.boolean),clarifyTimeoutError:Io.transitional(Io.boolean)},!1),r!=null&&(_t.isFunction(r)?e.paramsSerializer={serialize:r}:km.assertOptions(r,{encode:Io.function,serialize:Io.function},!0)),km.assertOptions(e,{baseUrl:Io.spelling("baseURL"),withXsrfToken:Io.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=i&&_t.merge(i.common,i[e.method]);i&&_t.forEach(["delete","get","head","post","put","patch","common"],S=>{delete i[S]}),e.headers=zs.concat(o,i);const a=[];let d=!0;this.interceptors.request.forEach(function(S){typeof S.runWhen=="function"&&S.runWhen(e)===!1||(d=d&&S.synchronous,a.unshift(S.fulfilled,S.rejected))});const l=[];let h;this.interceptors.response.forEach(function(S){l.push(S.fulfilled,S.rejected)});let f,m=0;if(!d){const S=[gk.bind(this),void 0];for(S.unshift.apply(S,a),S.push.apply(S,l),f=S.length,h=mt.resolve(e);m<f;)h=h.then(S[m++],S[m++]);return h}f=a.length;let T=e;for(m=0;m<f;){const S=a[m++],w=a[m++];try{T=S(T)}catch(I){w.call(this,I);break}}try{h=gk.call(this,T)}catch(S){return mt.reject(S)}for(m=0,f=l.length;m<f;)h=h.then(l[m++],l[m++]);return h}getUri(t){return IP(ik((t=_d(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};_t.forEach(["delete","get","head","options"],function(t){Lm.prototype[t]=function(e,n){return this.request(_d(n||{},{method:t,url:e,data:(n||{}).data}))}}),_t.forEach(["post","put","patch"],function(t){function e(n){return function(r,i,o){return this.request(_d(o||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:r,data:i}))}}Lm.prototype[t]=e(),Lm.prototype[t+"Form"]=e(!0)});var Mm=Lm;class Iy{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new mt(function(i){n=i});const r=this;this.promise.then(i=>{if(!r._listeners)return;let o=r._listeners.length;for(;o-- >0;)r._listeners[o](i);r._listeners=null}),this.promise.then=i=>{let o;const a=new mt(d=>{r.subscribe(d),o=d}).then(i);return a.cancel=function(){r.unsubscribe(o)},a},e(function(i,o,a){r.reason||(r.reason=new ru(i,o,a),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new Iy(function(r){e=r}),cancel:e}}}var TX=Iy;const Cy={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(Cy).forEach(t=>{let[e,n]=t;Cy[n]=e});var SX=Cy;const Lr=function t(e){const n=new Mm(e),r=oP(Mm.prototype.request,n);return _t.extend(r,Mm.prototype,n,{allOwnKeys:!0}),_t.extend(r,n,null,{allOwnKeys:!0}),r.create=function(i){return t(_d(e,i))},r}(fy);Lr.Axios=Mm,Lr.CanceledError=ru,Lr.CancelToken=TX,Lr.isCancel=tk,Lr.VERSION=Tk,Lr.toFormData=fm,Lr.AxiosError=je,Lr.Cancel=Lr.CanceledError,Lr.all=function(t){return mt.all(t)},Lr.spread=function(t){return function(e){return t.apply(null,e)}},Lr.isAxiosError=function(t){return _t.isObject(t)&&t.isAxiosError===!0},Lr.mergeConfig=_d,Lr.AxiosHeaders=zs,Lr.formToJSON=t=>$D(_t.isHTMLForm(t)?new FormData(t):t),Lr.getAdapter=Ek.getAdapter,Lr.HttpStatusCode=SX,Lr.default=Lr;var ai=Lr;const vX=()=>{};function op(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:vX};return t.promise=new mt((e,n)=>{t.resolve=r=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(r),t.value=r)},t.reject=r=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(r))}}),t}const Um=new Map,xm=new Map,Co=new Map;let er=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),Oe=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({});const vk=new V8;let Js=vk.getResult(),Ay=null;function ve(t){if(!Ay){Js=vk.getResult();const e=function(d){if(d.engine.name==="Blink"&&d.browser.name!=="WeChat")return Oe.CHROME;switch(d.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Oe.CHROME;case"Safari":case"Mobile Safari":return Oe.SAFARI;case"Edge":return Oe.EDGE;case"Firefox":return Oe.FIREFOX;case"QQ":case"QQBrowser":return Oe.QQ;case"Opera":return Oe.OPERA;case"WeChat":return Oe.WECHAT;default:return d.browser.name||""}}(Js),n=yk(Js),r=function(d){return d.os.name==="Windows"?d.os.version?d.os.name+" "+d.os.version:d.os.name:d.os.name||""}(Js),i=Js.os.version,o=yk(Js,!1),a=Js.device.type;if(!(e&&n&&r&&i))return{name:e,version:n,os:r,osVersion:i,browserVersion:o,deviceType:a};Ay={name:e,version:n,os:r,osVersion:i,browserVersion:o,deviceType:a}}return Ay}function yk(t){let e,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",n?e.split(".")[0]:e}function Vm(){return ve().os}function Rk(){const t=ve();return"".concat(t.os," ").concat(t.osVersion)}function Fm(){const t=ve();return!!(Js.engine.name==="WebKit"&&t.os===er.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==Oe.SAFARI||$r()&&t.name!==Oe.SAFARI)}function ga(){return ve().name===Oe.CHROME}function Sr(){return ve().name===Oe.SAFARI}function Ik(){return ve().name===Oe.EDGE}function Tn(){return ve().name===Oe.FIREFOX}function $r(){return ve().os===er.IOS}function ap(t){const e=ve();return!(e.name!==Oe.CHROME||!e.osVersion)&&Number(e.version)>=t}function Ck(t){const e=ve();return!(e.name!==Oe.CHROME||!e.osVersion)&&Number(e.version)<t}function wy(t,e,n){const r=ve();return!(r.name!==t||!r.osVersion)&&(n?Number(r.version)>=e&&Number(r.version)<=n:Number(r.version)===e)}function by(t){const e=ve();return!(e.name!==Oe.EDGE||!e.osVersion)&&Number(e.version)>=t}function Ak(t){const e=ve();return!(e.name!==Oe.SAFARI||!e.osVersion)&&Number(e.version)>=t}function wk(t,e,n){const r=ve();if(r.os!==er.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return e&&Number(i[0])===t&&Number(i[1])<e||Number(i[0])<t}function bk(t,e,n){const r=ve();if(r.name!==Oe.SAFARI||!r.osVersion||!r.browserVersion)return!1;const i=r.browserVersion.split(".");return n?e&&Number(i[0])===t&&Number(i[1])<e||Number(i[0])<t:e?Number(i[0])===t&&Number(i[1])<=e||Number(i[0])<t:Number(i[0])<=t}function Oy(t){const e=ve();return!(e.name!==Oe.OPERA||!e.osVersion)&&Number(e.version)>=t}function Ok(){const t=ve();if(t.os!==er.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function iu(){const t=ve();if(t.os!==er.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15}function Ny(){const t=ve();if(t.os!==er.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===16}function Nk(){const t=ve();if(t.os!==er.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Is(){return Sr()&&navigator.maxTouchPoints>0}function Pk(){return ve().name===Oe.WECHAT}function Dk(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Py(){const t=Vm();return function(){const{deviceType:e}=ve();return e==="mobile"||e==="tablet"}()||t===er.ANDROID||t===er.IOS||t===er.HARMONY_OS}function Ta(){const t=ve();return t.name!==Oe.EDGE&&t.name!==Oe.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Bm(){return Vm()===er.ANDROID}function cp(){const t=ve();return Bm()&&(t.name===Oe.CHROME||t.name===Oe.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function kk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function St(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?kk(Object(n),!0).forEach(function(r){Yt(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):kk(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Yt(t,e,n){return(e=function(r){var i=function(o,a){if(typeof o!="object"||o===null)return o;var d=o[Symbol.toPrimitive];if(d!==void 0){var l=d.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:String(i)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}let D=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({}),et=class extends Error{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(e),Yt(this,"code",void 0),Yt(this,"message",void 0),Yt(this,"data",void 0),Yt(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return t==="error"&&(e||console).error(this.toString()),t==="warning"&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function Sa(t,e){if(typeof t!="boolean")throw new et(D.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function tr(t,e,n){if(!ft(n).call(n,t))throw new et(D.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function Ge(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<n||t>r||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(i){return typeof i=="number"&&i%1==0}(t))throw new et(D.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(r,"]. integer only"))}function Dy(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new et(D.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Ge(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Ge(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Ge(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Ge(t.ideal,"".concat(e,".ideal"),1,1/0)}else Ge(t,e,1,1/0)}function ur(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,i=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new et(D.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!Lk(t,n,r,i))throw new et(D.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(r,"].").concat(i?" ASCII characters only.":""))}function va(t,e){if(!Array.isArray(t))throw new et(D.INVALID_PARAMS,"".concat(e," should be an array"))}function Sn(t){return t==null}function Lk(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=n&&t.length>=e&&(!r||function(i){if(typeof i!="string")return!1;for(let o=0;o<i.length;o+=1){const a=i.charCodeAt(o);if(a<0||a>255)return!1}return!0}(t))}var dp=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(dp||{}),ky=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(ky||{});const Mk=new class{constructor(){Yt(this,"_clientSize",null),Yt(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),Yt(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),Yt(this,"getStyle",t=>window.getComputedStyle(t,null)),Yt(this,"checkCssVisibleProperty",t=>{var e;let n=!0;const r=this.getStyle(t),{display:i,visibility:o,opacity:a,filter:d}=r;return(i==="none"||ft(e=["hidden","collapse"]).call(e,o)||Number(a)<.1)&&(n=!1),!!n&&(d&&d.split(" ").filter(l=>{var h;const f=l.split("(")[0];return ft(h=["brightness","blur","opacity"]).call(h,f)}).map(l=>{const[h,f]=l.split(/\(|\)/);return[h,Number(f.match(/^[0-9\.]+/))]}).forEach(l=>{const[h,f]=l;switch(h){case"brightness":(f<.1||f>3)&&(n=!1);break;case"blur":f>3&&(n=!1);break;case"opacity":f<.1&&(n=!1)}}),n)}),Yt(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let n=!0,r=!0;const i=a=>e(a);let o=t;for(;o&&r;)i(o)||(n=!1,r=!1),o=o.parentElement,o||(r=!1);return n}),Yt(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),Yt(this,"getSizeAboutClient",t=>{const{width:e,height:n,left:r,right:i,top:o,bottom:a}=t.getBoundingClientRect(),d=this.getClientWidth(),l=this.getClientHeight();return{width:e,height:n,left:r,right:i,top:o,bottom:a,clientWidth:d,clientHeight:l,clientMin:Math.min(d,l)}}),Yt(this,"checkActualSize",()=>{const{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)}),Yt(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),Yt(this,"checkCoverForAPoint",(t,e,n)=>{const r=this.elementFromPoint(t,e);return r!==null&&r!==n}),Yt(this,"getPointPositionList",()=>{const{width:t,height:e,left:n,top:r}=this._clientSize,i=t/6,o=e/6,a=[],d=10**6;for(let l=0;l<5;l++)for(let h=0;h<5;h++){const f=(n*d+(l===0?.1:l===4?(i*l*d-1e5)/d:i*l)*d)/d,m=(r*d+(h===0?.1:h===4?(o*h*d-1e5)/d:o*h)*d)/d;a.push({x:f,y:m})}return[...a]}),Yt(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),Yt(this,"checkSizeIsVisible",(t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10)),Yt(this,"checkSizeOfPartInClient",()=>{const{left:t,right:e,top:n,bottom:r,clientHeight:i,clientWidth:o,clientMin:a}=this._clientSize;let d,l,h,f;if(t<0)d=0;else{if(!(t<o))return!1;d=t}if(e<0)return!1;if(l=e<o?e:o,n<0)h=0;else{if(!(n<i))return!1;h=n}if(r<0)return!1;f=r<i?r:i;const m=l-d,T=f-h;return this.checkSizeIsVisible(m,T,a)}),Yt(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),Yt(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(dp.COVERED);{const e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(dp.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(dp.SIZE)}}return this.returnHiddenResult(dp.STYLE)}return this.returnHiddenResult(ky.UNMOUNTED)}return this.returnHiddenResult(ky.INVALID_HTML_ELEMENT)}),Yt(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function Ly(t){return new TextEncoder().encode(t)}const Uk=function(t,e){const n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},My=async t=>function(e,n){let r="";return new Uint8Array(e).forEach(i=>{r+=i.toString(n).padStart(2,"0")}),r}(await crypto.subtle.digest("SHA-256",Ly(t)),16);let _n=class{constructor(){Yt(this,"_events",{}),Yt(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const n=this._events[t],r=this._indexOfListener(n,e);r!==-1&&n.splice(r,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map(o=>o);for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(let o=0;o<e.length;o+=1){const a=e[o];a.once&&this.off(t,a.listener),a.listener.apply(this,r||[])}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];[...this._events[t]||[]].forEach(i=>{i.once&&this.off(t,i.listener);try{i.listener.apply(this,n)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return-1}},lp=null;function xk(){if(lp)return lp;if(window.electron)return lp=window.electron;if(!window.require)return null;try{return lp=window.require("electron"),lp}catch{return null}}let Kn=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",t}({}),vn=function(t){return t.TRACER="tracer",t}({});function Vk(t){return Ge(t.timeout,"config.timeout",0,1e5),Ge(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Ge(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Ge(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let yX=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),ke=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function up(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function Fk(t){return ur(t.turnServerURL,"turnServerURL"),ur(t.username,"username"),ur(t.password,"password"),t.udpport&&Ge(t.udpport,"udpport",1,99999,!0),t.forceturn&&Sa(t.forceturn,"forceturn"),t.security&&Sa(t.security,"security"),t.tcpport&&Ge(t.tcpport,"tcpport",1,99999,!0),!0}function Uy(t){return t.level!==void 0&&tr(t.level,"level",[1,2,3]),t.delay!==void 0&&Ge(t.delay,"delay",0,3e3,!0),!0}let de=function(t){return t.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",t.AUDIO_METADATA="audio-metadata",t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),vr=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",t}({}),ki=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),su=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function yr(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t.getListeners(e).length===0?mt.reject(new et(D.UNEXPECTED_ERROR,"can not emit promise")):new mt((o,a)=>{t.emit(e,...r,o,a)})}function Ye(t,e){if(t.getListeners(e).length===0)return mt.resolve();for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return yr(t,e,...r)}function Bi(t,e){if(t.getListeners(e).length===0)return null;for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return hp(t,e,...r)}function hp(t,e){let n=null,r=null;for(var i=arguments.length,o=new Array(i>2?i-2:0),a=2;a<i;a++)o[a-2]=arguments[a];if(t.emit(e,...o,d=>{n=d},d=>{r=d}),r!==null)throw r;if(n===null)throw new et(D.UNEXPECTED_ERROR,"handler is not sync");return n}const Fn=new class extends _n{set networkState(t){this.emit(su.NETWORK_STATE_CHANGE,t,this._networkState),t===ki.ONLINE?this.emit(su.ONLINE):t===ki.OFFLINE&&(this.onlineWaiter=new mt(e=>{this.once(su.ONLINE,()=>{this.onlineWaiter=void 0,e(ki.ONLINE)})}),this.emit(su.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===ki.ONLINE}constructor(){super(),Yt(this,"_moduleName","network-indicator"),Yt(this,"_networkState",ki.ONLINE),Yt(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=ki.ONLINE}),window.addEventListener("offline",()=>{this.networkState=ki.OFFLINE})}};function jm(t,e){const n=t.indexOf(e);n!==-1&&t.splice(n,1)}function ou(t){const e=[];return t.forEach(n=>{e.indexOf(n)===-1&&e.push(n)}),e}function Gm(t){mt!==void 0?mt.resolve().then(t):setTimeout(t,0)}function yn(t){return JSON.parse(JSON.stringify(t))}function md(t){try{return yn(t)}catch{return t}}const Bk={};function uc(t,e){Bk[e]||(Bk[e]=!0,t())}function Ed(t){const e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let r=0;r<e.length;r+=1)n[r]=e.charCodeAt(r);return n}function hc(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function jk(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){const r=new Uint8Array(e);r.set(n),n=r}return n}function Gk(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=Ws(e).call(e,(a,d)=>a+d.length,0),i=new Uint8Array(new ArrayBuffer(r));let o=0;return e.forEach(a=>{i.set(a,o),o+=a.length}),i}function Ao(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function Wk(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(n=>{e+=typeof n=="string"?Ao(n):n.size}),e+138}function RX(t){const e=new et(D.TIMEOUT,"timeout");return new mt((n,r)=>{window.setTimeout(()=>r(e),t)})}function hr(t){return new mt(e=>{window.setTimeout(e,t)})}function ze(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+ze(t-n.length,"")}function gd(){return ze(32,"").toUpperCase()}const Wm=()=>{},Hk=new class{constructor(){Yt(this,"fnMap",new Map)}throttleByKey(t,e,n,r){for(var i=arguments.length,o=new Array(i>4?i-4:0),a=4;a<i;a++)o[a-4]=arguments[a];if(this.fnMap.has(e)){const d=this.fnMap.get(e);if(d.threshold!==n){d.fn(...d.args),clearTimeout(d.timer);const l=window.setTimeout(()=>{const h=this.fnMap.get(e);h&&h.fn(...h.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:l,args:o,skipFn:r})}else d.skipFn&&d.skipFn(...d.args),this.fnMap.set(e,St(St({},d),{},{fn:t,args:o,skipFn:r}))}else{const d=window.setTimeout(()=>{const l=this.fnMap.get(e);l&&l.fn(...l.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:d,args:o,skipFn:r})}}},Kk=Hk.throttleByKey.bind(Hk);function qk(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function xy(t,e){if(!qk(t)||!qk(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const n=[...t];for(let r=0;r<e.length;r++)n[r]=xy(t[r],e[r]);return n}{const n=St({},t);for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(Object.prototype.hasOwnProperty.call(t,r)?n[r]=xy(t[r],e[r]):n[r]=e[r]);return n}}function Yk(t,e){let n=[0];if(n=new Array(e).fill(0),t===0)return n;let r=0;for(;t>0&&(n[r]=255&t,t>>=8,r++,r!==e););return n}function Vy(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function zk(t){const e="0123456789abcdef";function n(x){let W,H="";for(W=0;W<=3;W++)H+=e.charAt(x>>8*W+4&15)+e.charAt(x>>8*W&15);return H}function r(x,W){const H=(65535&x)+(65535&W);return(x>>16)+(W>>16)+(H>>16)<<16|65535&H}function i(x,W,H,j,$,ct){return r(function(Et,Tt){return Et<<Tt|Et>>>32-Tt}(r(r(W,x),r(j,ct)),$),H)}function o(x,W,H,j,$,ct,Et){return i(W&H|~W&j,x,W,$,ct,Et)}function a(x,W,H,j,$,ct,Et){return i(W&j|H&~j,x,W,$,ct,Et)}function d(x,W,H,j,$,ct,Et){return i(W^H^j,x,W,$,ct,Et)}function l(x,W,H,j,$,ct,Et){return i(H^(W|~j),x,W,$,ct,Et)}const h=function(x){let W;const H=1+(x.length+8>>6),j=new Array(16*H);for(W=0;W<16*H;W++)j[W]=0;for(W=0;W<x.length;W++)j[W>>2]|=x.charCodeAt(W)<<W%4*8;return j[W>>2]|=128<<W%4*8,j[16*H-2]=8*x.length,j}(t);let f,m,T,S,w,I=1732584193,C=-271733879,N=-1732584194,P=271733878;for(f=0;f<h.length;f+=16)m=I,T=C,S=N,w=P,I=o(I,C,N,P,h[f+0],7,-680876936),P=o(P,I,C,N,h[f+1],12,-389564586),N=o(N,P,I,C,h[f+2],17,606105819),C=o(C,N,P,I,h[f+3],22,-1044525330),I=o(I,C,N,P,h[f+4],7,-176418897),P=o(P,I,C,N,h[f+5],12,1200080426),N=o(N,P,I,C,h[f+6],17,-1473231341),C=o(C,N,P,I,h[f+7],22,-45705983),I=o(I,C,N,P,h[f+8],7,1770035416),P=o(P,I,C,N,h[f+9],12,-1958414417),N=o(N,P,I,C,h[f+10],17,-42063),C=o(C,N,P,I,h[f+11],22,-1990404162),I=o(I,C,N,P,h[f+12],7,1804603682),P=o(P,I,C,N,h[f+13],12,-40341101),N=o(N,P,I,C,h[f+14],17,-1502002290),C=o(C,N,P,I,h[f+15],22,1236535329),I=a(I,C,N,P,h[f+1],5,-165796510),P=a(P,I,C,N,h[f+6],9,-1069501632),N=a(N,P,I,C,h[f+11],14,643717713),C=a(C,N,P,I,h[f+0],20,-373897302),I=a(I,C,N,P,h[f+5],5,-701558691),P=a(P,I,C,N,h[f+10],9,38016083),N=a(N,P,I,C,h[f+15],14,-660478335),C=a(C,N,P,I,h[f+4],20,-405537848),I=a(I,C,N,P,h[f+9],5,568446438),P=a(P,I,C,N,h[f+14],9,-1019803690),N=a(N,P,I,C,h[f+3],14,-187363961),C=a(C,N,P,I,h[f+8],20,1163531501),I=a(I,C,N,P,h[f+13],5,-1444681467),P=a(P,I,C,N,h[f+2],9,-51403784),N=a(N,P,I,C,h[f+7],14,1735328473),C=a(C,N,P,I,h[f+12],20,-1926607734),I=d(I,C,N,P,h[f+5],4,-378558),P=d(P,I,C,N,h[f+8],11,-2022574463),N=d(N,P,I,C,h[f+11],16,1839030562),C=d(C,N,P,I,h[f+14],23,-35309556),I=d(I,C,N,P,h[f+1],4,-1530992060),P=d(P,I,C,N,h[f+4],11,1272893353),N=d(N,P,I,C,h[f+7],16,-155497632),C=d(C,N,P,I,h[f+10],23,-1094730640),I=d(I,C,N,P,h[f+13],4,681279174),P=d(P,I,C,N,h[f+0],11,-358537222),N=d(N,P,I,C,h[f+3],16,-722521979),C=d(C,N,P,I,h[f+6],23,76029189),I=d(I,C,N,P,h[f+9],4,-640364487),P=d(P,I,C,N,h[f+12],11,-421815835),N=d(N,P,I,C,h[f+15],16,530742520),C=d(C,N,P,I,h[f+2],23,-995338651),I=l(I,C,N,P,h[f+0],6,-198630844),P=l(P,I,C,N,h[f+7],10,1126891415),N=l(N,P,I,C,h[f+14],15,-1416354905),C=l(C,N,P,I,h[f+5],21,-57434055),I=l(I,C,N,P,h[f+12],6,1700485571),P=l(P,I,C,N,h[f+3],10,-1894986606),N=l(N,P,I,C,h[f+10],15,-1051523),C=l(C,N,P,I,h[f+1],21,-2054922799),I=l(I,C,N,P,h[f+8],6,1873313359),P=l(P,I,C,N,h[f+15],10,-30611744),N=l(N,P,I,C,h[f+6],15,-1560198380),C=l(C,N,P,I,h[f+13],21,1309151649),I=l(I,C,N,P,h[f+4],6,-145523070),P=l(P,I,C,N,h[f+11],10,-1120210379),N=l(N,P,I,C,h[f+2],15,718787259),C=l(C,N,P,I,h[f+9],21,-343485551),I=r(I,m),C=r(C,T),N=r(N,S),P=r(P,w);return n(I)+n(C)+n(N)+n(P)}let IX=1,Jk=console,Or=class{static setLogger(t){Jk=t}constructor(t,e){Yt(this,"id",void 0),Yt(this,"lockingPromise",mt.resolve()),Yt(this,"locks",0),Yt(this,"name",""),Yt(this,"lockId",void 0),this.lockId=IX++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),r=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");Jk.debug("".concat(n," ").concat(r))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);const n=new mt(i=>{e=()=>{this.locks-=1,this.logger("unlocked",t),i()}}),r=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),r}};function au(t,e){return function(n,r,i){const o=i.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const a=this[e];if(!a)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const d=await a.lock("From ".concat(t,".").concat(r));try{for(var l=arguments.length,h=new Array(l),f=0;f<l;f++)h[f]=arguments[f];return await o.apply(this,h)}finally{d()}},i}}const qn={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Fy(t,e){const n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function Xs(t,e,n,r){const i=Object.assign({},qn,r);let o=i.timeout;const a=async()=>{await function(h){return new mt(f=>{window.setTimeout(f,h)})}(o),o*=i.timeoutFactor,o=Math.min(i.maxRetryTimeout,o)};let d=!1;const l=new mt(async(h,f)=>{e=e||(()=>!1),n=n||(()=>!0);for(let m=0;m<i.maxRetryCount;m+=1){if(d)return f(new et(D.OPERATION_ABORTED));try{const T=await t();if(!e(T,m)||m+1===i.maxRetryCount)return h(T);await a()}catch(T){if(!n(T,m)||m+1===i.maxRetryCount)return f(T);await a()}}});return l.cancel=()=>d=!0,l}let Hm,Xk=class{constructor(t){Yt(this,"input",[]),Yt(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:Ws(t=this.input).call(t,(e,n)=>e+n)/this.input.length}},Km=0,By=0;function jy(t,e,n,r){return new mt((i,o)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),Km+=Ao(e.data)):n&&(e.data.size?Km+=e.data.size:e.data instanceof FormData?Km+=Wk(e.data):Km+=Ao(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,ai.request(e).then(a=>{typeof a.data=="string"?By+=Ao(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?By+=a.data.byteLength:By+=Ao(JSON.stringify(a.data)),i(a.data)}).catch(a=>{ai.isCancel(a)?o(new et(D.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?o(new et(D.NETWORK_TIMEOUT,a.message)):a.response?o(new et(D.NETWORK_RESPONSE_ERROR,a.response.status)):o(new et(D.NETWORK_ERROR,a.message))})})}async function CX(t,e){const n=new Blob([e.data],{type:"buffer"});return await jy(t,St(St({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Qk=()=>window.isSecureContext!==void 0;function Cs(t){if(Array.isArray(t))return t.map(n=>n);if(!$k(t))return t;const e={};for(const n in t){const r=t[n];$k(r)||Array.isArray(r)?e[n]=Cs(r):e[n]=r}return e}function $k(t){return!(typeof t!="object"||Array.isArray(t)||!t)}let Gy=class{constructor(t){Yt(this,"input",[]),Yt(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const wo={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},pp={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:wo,remoteCandidate:wo},updateInterval:0},Zk={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},tL={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},eL={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},nL={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0};let Wy=class{constructor(t,e){Yt(this,"onFirstVideoReceived",void 0),Yt(this,"onFirstVideoDecoded",void 0),Yt(this,"onFirstAudioReceived",void 0),Yt(this,"onFirstVideoDecodedTimeout",void 0),Yt(this,"onFirstAudioDecoded",void 0),Yt(this,"onSelectedLocalCandidateChanged",void 0),Yt(this,"onSelectedRemoteCandidateChanged",void 0),Yt(this,"videoIsReady",!1),Yt(this,"videoIsReady2",{}),Yt(this,"pc",void 0),Yt(this,"options",void 0),Yt(this,"intervalTimer",void 0),Yt(this,"stats",Cs(pp)),Yt(this,"isFirstVideoReceived",{}),Yt(this,"isFirstVideoDecoded",{}),Yt(this,"isFirstAudioReceived",{}),Yt(this,"isFirstAudioDecoded",{}),Yt(this,"isFirstVideoDecodedTimeout",{}),Yt(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new mt(t=>{t({local:St({},wo),remote:St({},wo)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,i=0,o=0,a=0;for(const d of n)t[d].forEach((l,h)=>{if(!this.lossRateWindowStats[e-1][d][h]||!this.lossRateWindowStats[0][d][h])return;const f=this.lossRateWindowStats[e-1][d][h].packets-this.lossRateWindowStats[0][d][h].packets,m=this.lossRateWindowStats[e-1][d][h].packetsLost-this.lossRateWindowStats[0][d][h].packetsLost;d==="videoSend"||d==="audioSend"?(r+=f,o+=m):(i+=f,a+=m),Number.isNaN(f)||Number.isNaN(f)?l.packetLostRate=0:l.packetLostRate=f<=0||m<=0?0:m/(f+m)});t.sendPacketLossRate=r<=0||o<=0?0:o/(r+o),t.recvPacketLossRate=i<=0||a<=0?0:a/(i+a)}},AX=class extends Wy{constructor(){super(...arguments),Yt(this,"_stats",pp),Yt(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=Cs(pp);const n=e.filter(i=>i.type==="ssrc");this.processSSRCStats(n);const r=e.find(i=>i.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var n;const r=ft(n=e.id).call(n,"send");switch("".concat(e.mediaType,"_").concat(r?"send":"recv")){case"video_send":{const i=Cs(tL);i.codec=e.googCodecName,i.adaptionChangeReason="none",e.googCpuLimitedResolution&&(i.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(i.adaptionChangeReason="bandwidth"),i.avgEncodeMs=Number(e.googAvgEncodeMs),i.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},i.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},i.firsCount=Number(e.googFirReceived),i.nacksCount=Number(e.googNacksReceived),i.plisCount=Number(e.googPlisReceived),i.frameCount=Number(e.framesEncoded),i.bytes=Number(e.bytesSent),i.packets=Number(e.packetsSent),i.packetsLost=Number(e.packetsLost),i.ssrc=Number(e.ssrc),i.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(i),this._stats.rtt=i.rttMs;break}case"video_recv":{const i=Cs(Zk),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(i.codec=e.googCodecName,i.targetDelayMs=Number(e.googTargetDelayMs),i.renderDelayMs=Number(e.googRenderDelayMs),i.currentDelayMs=Number(e.googCurrentDelayMs),i.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),i.decodeMs=Number(e.googDecodeMs),i.maxDecodeMs=Number(e.googMaxDecodeMs),i.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},i.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},i.decodeFrameRate=Number(e.googFrameRateDecoded),i.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},i.jitterBufferMs=Number(e.googJitterBufferMs),i.firsCount=Number(e.googFirsSent),i.nacksCount=Number(e.googNacksSent),i.plisCount=Number(e.googPlisSent),i.framesDecodeCount=Number(e.framesDecoded),i.bytes=Number(e.bytesReceived),i.packets=Number(e.packetsReceived),i.packetsLost=Number(e.packetsLost),i.ssrc=Number(e.ssrc),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,i.decodedFrame.width,i.decodedFrame.height),this.isFirstVideoDecoded[i.ssrc]=!0),o){const a=o.stats,d=Date.now()-o.lts;i.framesDecodeFreezeTime=a.framesDecodeFreezeTime,i.framesDecodeInterval=a.framesDecodeInterval,i.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(o.lts=Date.now(),i.framesDecodeInterval=d,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):i.framesDecodeCount<o.stats.framesDecodeCount&&(i.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:St({},i),lts:Date.now()}),this._stats.videoRecv.push(i);break}case"audio_recv":{const i=Cs(nL);i.codec=e.googCodecName,i.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,i.decodingCNG=Number(e.googDecodingCNG),i.decodingCTN=Number(e.googDecodingCTN),i.decodingCTSG=Number(e.googDecodingCTSG),i.decodingNormal=Number(e.googDecodingNormal),i.decodingPLC=Number(e.googDecodingPLC),i.decodingPLCCNG=Number(e.googDecodingPLCCNG),i.expandRate=Number(e.googExpandRate),i.accelerateRate=Number(e.googAccelerateRate),i.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),i.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),i.speechExpandRate=Number(e.googSpeechExpandRate),i.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),i.jitterBufferMs=Number(e.googJitterBufferMs),i.jitterMs=Number(e.googJitterReceived),i.bytes=Number(e.bytesReceived),i.packets=Number(e.packetsReceived),i.packetsLost=Number(e.packetsLost),i.ssrc=Number(e.ssrc),i.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),i.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.decodingNormal>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),this._stats.audioRecv.push(i);break}case"audio_send":{const i=Cs(eL);i.codec=e.googCodecName,i.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,i.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),i.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),i.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),i.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),i.bytes=Number(e.bytesSent),i.packets=Number(e.packetsSent),i.packetsLost=Number(e.packetsLost),i.ssrc=Number(e.ssrc),i.rttMs=Number(e.googRtt||0),this._stats.rtt=i.rttMs,this._stats.audioSend.push(i);break}}})}_getStats(){return new mt((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){const e=[];return t.result().forEach(n=>{const r={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach(i=>{r[i]=n.stat(i)}),e.push(r)}),e}},fp=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({}),qm=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),Hy=function(t){return t[t.new=0]="new",t[t.connecting=1]="connecting",t[t.connected=2]="connected",t[t.disconnected=3]="disconnected",t[t.failed=4]="failed",t[t.closed=5]="closed",t}({}),ji=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({});var cu=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(cu||{});function _p(t,e,n,r){let i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:cu.kNone;if(!e)return;const o=Number(e[n]);if(typeof o!="number")return;const a=Number(e[r]);if(typeof a!="number")return;if(!t)return a?o/a*i:void 0;const d=Number(t[n]);if(typeof d!="number")return;const l=Number(t[r]);if(typeof l!="number")return;const h=a-l;return h?(o-d)/h*i:void 0}let rL=class extends Wy{constructor(){super(...arguments),Yt(this,"_stats",pp),Yt(this,"report",void 0),Yt(this,"lastDecodeVideoReceiverStats",new Map),Yt(this,"lastVideoFramesRecv",new Map),Yt(this,"lastVideoFramesSent",new Map),Yt(this,"lastVideoFramesDecode",new Map),Yt(this,"lastVideoFramesOutput",new Map),Yt(this,"lastVideoJBDelay",new Map),Yt(this,"lastAudioJBDelay",new Map),Yt(this,"mediaBytesSent",new Map),Yt(this,"mediaBytesRetransmit",new Map),Yt(this,"mediaBytesTargetEncode",new Map),Yt(this,"lastDecodeAudioReceiverStats",new Map),Yt(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Cs(pp),this.report.forEach(t=>{switch(t.type){case ji.OUTBOUND:case ji.INBOUND:{const e=t.mediaType||t.kind,n=!e&&"frameWidth"in t,r=!e&&!("frameWidth"in t);t.type===ji.OUTBOUND?e==="audio"||r?this.processAudioOutboundStats(t):(e==="video"||n)&&this.processVideoOutboundStats(t):t.type===ji.INBOUND&&(e==="audio"||r?this.processAudioInboundStats(t):(e==="video"||n)&&this.processVideoInboundStats(t));break}case ji.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case ji.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:St({},wo),remote:St({},wo)};return t.forEach(n=>{let r;if(n.type===ji.TRANSPORT&&(r=t.get(n.selectedCandidatePairId)),n.type===ji.CANDIDATE_PAIR&&n.selected&&(r=n),r){const i=(o,a)=>{o.type=a.type,o.id=a.id,a.address&&(o.address=a.address),a.candidateType&&(o.candidateType=a.candidateType),a.port&&(o.port=a.port),a.priority&&(o.priority=a.priority),a.protocol&&(o.protocol=a.protocol),a.relayProtocol&&(o.relayProtocol=a.relayProtocol)};if(r.localCandidateId){const o=t.get(r.localCandidateId);o&&i(e.local,o)}if(r.remoteCandidateId){const o=t.get(r.remoteCandidateId);o&&i(e.remote,o)}}}),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===ji.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===ji.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===ji.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(St({},e),St({},this.stats.selectedCandidatePair.localCandidate)),t.type===ji.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(St({},e),St({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(r=>r.ssrc===t.ssrc);e||(e=Cs(nL),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.packetsDiscarded=t.packetsDiscarded,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.totalProcessingDelay=t.totalProcessingDelay,e.jitterBufferEmittedCount=t.jitterBufferEmittedCount;const n=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=_p(n,e,"totalProcessingDelay","jitterBufferEmittedCount",cu.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,St({},e))}processVideoInboundStats(t){let e=this._stats.videoRecv.find(a=>a.ssrc===t.ssrc);e||(e=Cs(Zk),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.framesDroppedCount=t.framesDropped,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,e.totalFreezesDuration=t.totalFreezesDuration,e.totalProcessingDelay=t.totalProcessingDelay,e.packetsDiscarded=t.packetsDiscarded,e.framesAssembledFromMultiplePackets=t.framesAssembledFromMultiplePackets,e.totalAssemblyTime=t.totalAssemblyTime,e.keyFramesDecoded=t.keyFramesDecoded,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived;const n=this.lastDecodeVideoReceiverStats.get(e.ssrc),r=this.lastVideoFramesDecode.get(e.ssrc),i=this.lastVideoFramesOutput.get(e.ssrc),o=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const a=e.decodedFrame?e.decodedFrame.width:0,d=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,a,d),this.isFirstVideoDecoded[e.ssrc]=!0}if(n){const a=n.stats,d=o-n.lts;e.framesDecodeFreezeTime=a.framesDecodeFreezeTime,e.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&d>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(n.lts=Date.now(),e.framesDecodeInterval=d,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<a.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(n.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-n.qpSum)/(t.framesDecoded-n.stats.framesDecodeCount))}t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime,e.avgDecodeMs=_p(n==null?void 0:n.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=_p(n==null?void 0:n.stats,e,"totalProcessingDelay","framesDecodeCount",cu.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=_p(n==null?void 0:n.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",cu.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=_p(n==null?void 0:n.stats,e,"totalInterFrameDelay","framesDecodeCount",cu.kMillisecondsFromSeconds),r&&o-r.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:e.decodeFrameRate})):r?e.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:0}),e.framesDroppedCount&&t.framesReceived&&(i&&o-i.lts>=800?(e.outputFrameRate=Math.round((t.framesReceived-e.framesDroppedCount-i.count)/((o-i.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:Math.max(e.outputFrameRate,0)})):i?e.outputFrameRate=i.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:0})),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:St({},e),lts:n?n.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(r=>r.ssrc===t.ssrc);e||(e=Cs(tL),this._stats.videoSend.push(e));const n=this.mediaBytesSent.get(t.ssrc);if(n)n.add(t.bytesSent);else{const r=new Gy(10);r.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,r)}if(t.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(t.ssrc);if(r)r.add(t.retransmittedBytesSent);else{const i=new Gy(10);i.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,i)}}if(t.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(t.ssrc);if(r)r.add(t.totalEncodedBytesTarget);else{const i=new Gy(10);i.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,i)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,e.hugeFramesSent=t.hugeFramesSent,e.keyFramesEncoded=t.keyFramesEncoded,t.totalEncodeTime&&t.framesEncoded){const r=this.lastEncoderMs.get(t.ssrc);if(!r||r.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const i=t.framesEncoded-r.lastFrameCount,o=t.totalEncodeTime-r.lastEncoderTime;e.avgEncodeMs=1e3*o/i}}if(t.framesEncoded&&t.qpSum){const r=this.lastEncoderMs.get(t.ssrc);!r||r.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-r.lastQpSum)/(t.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const r=this.findRemoteStatsId(t.ssrc,ji.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(n=>n.ssrc===t.ssrc);if(e||(e=Cs(eL),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const n=this.findRemoteStatsId(t.ssrc,ji.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}findRemoteStatsId(t,e){var n;const r=Array.from(Vi(n=this.report).call(n)).find(i=>i.type===e&&i.ssrc===t);return r?r.id:null}processVideoMediaSource(t,e){const n=this.report.get(t);n&&n.width&&n.height&&n.framesPerSecond&&(e.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(t,e){const n=this.report.get(t);n&&(e.inputLevel=n.audioLevel)}processVideoTrackSenderStats(t,e,n){var r,i,o,a;const d=e?this.report.get(e):void 0,l=(r=d==null?void 0:d.framesSent)!==null&&r!==void 0?r:t.framesSent;if(typeof l!="number")return;let h=(i=d==null?void 0:d.frameWidth)!==null&&i!==void 0?i:t.frameWidth,f=(o=d==null?void 0:d.frameHeight)!==null&&o!==void 0?o:t.frameHeight,m=(a=d==null?void 0:d.framesPerSecond)!==null&&a!==void 0?a:t.framesPerSecond;if(typeof h=="number"&&typeof f=="number"||(h=0,f=0),m==null){const T=Date.now(),S=this.lastVideoFramesSent.get(n.ssrc);S&&T-S.lts>=800?(m=Math.round((l-S.count)/((T-S.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:l,lts:T,rate:m})):S?m=S.rate:this.lastVideoFramesSent.set(n.ssrc,{count:l,lts:T,rate:0})}n.sentFrame={width:h,height:f,frameRate:Math.max(0,m)}}processVideoTrackReceiverStats(t,e,n){var r,i,o,a,d;const l=e?this.report.get(e):void 0,h=(r=l==null?void 0:l.framesReceived)!==null&&r!==void 0?r:t.framesReceived,f=(i=l==null?void 0:l.frameWidth)!==null&&i!==void 0?i:t.frameWidth,m=(o=l==null?void 0:l.frameHeight)!==null&&o!==void 0?o:t.frameHeight,T=(a=l==null?void 0:l.jitterBufferDelay)!==null&&a!==void 0?a:t.jitterBufferDelay,S=(d=l==null?void 0:l.jitterBufferEmittedCount)!==null&&d!==void 0?d:t.jitterBufferEmittedCount;if(typeof h=="number"){const w=this.lastVideoFramesRecv.get(n.ssrc),I=Date.now();n.framesReceivedCount=h;let C=0;w&&I-w.lts>=800?(C=Math.round((h-w.count)/((I-w.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:h,lts:I,rate:C})):w?C=w.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:h,lts:I,rate:0}),n.receivedFrame={width:f||0,height:m||0,frameRate:C||0},n.decodedFrame={width:f||0,height:m||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:f||0,height:m||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(T&&S){const w=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let I=w.jitterBufferMs;const C=S-w.jitterBufferEmittedCount;C>0&&(I=1e3*(T-w.jitterBufferDelay)/C),n.jitterBufferMs=I,n.currentDelayMs=Math.round(I),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:T,jitterBufferEmittedCount:S,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(t,e,n){var r,i,o,a;const d=e?this.report.get(e):void 0,l=(r=(i=d==null?void 0:d.echoReturnLoss)!==null&&i!==void 0?i:t.echoReturnLoss)!==null&&r!==void 0?r:0,h=(o=(a=d==null?void 0:d.echoReturnLossEnhancement)!==null&&a!==void 0?a:t.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;n.aecReturnLoss=l,n.aecReturnLossEnhancement=h}processAudioTrackReceiverStats(t,e,n){var r,i,o,a,d,l,h;const f=e?this.report.get(e):void 0,m=(r=f==null?void 0:f.removedSamplesForAcceleration)!==null&&r!==void 0?r:t.removedSamplesForAcceleration,T=(i=f==null?void 0:f.totalSamplesReceived)!==null&&i!==void 0?i:t.totalSamplesReceived,S=(o=f==null?void 0:f.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,w=(a=f==null?void 0:f.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount,I=(d=f==null?void 0:f.audioLevel)!==null&&d!==void 0?d:t==null?void 0:t.audioLevel,C=(l=f==null?void 0:f.totalSamplesDuration)!==null&&l!==void 0?l:t==null?void 0:t.totalSamplesDuration,N=(h=f==null?void 0:f.concealedSamples)!==null&&h!==void 0?h:t.concealedSamples;if(typeof T=="number"&&(n.totalSamplesReceived=T),m&&T&&(n.accelerateRate=m/T),S&&w){const x=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let W=x.jitterBufferMs;const H=w-x.jitterBufferEmittedCount;H>0&&(W=1e3*(S-x.jitterBufferDelay)/H),n.jitterBufferMs=Math.round(W),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:S,jitterBufferEmittedCount:w,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=I;let P=1920;C&&T&&(P=T/C/50,n.receivedFrames=Math.round(T/P)),N&&(n.droppedFrames=Math.round(N/P))}processRemoteInboundStats(t,e){const n=this.report.get(t);n&&(e.packetsLost=n.packetsLost,n.roundTripTime&&(e.rttMs=1e3*n.roundTripTime),n.jitter&&(e.jitterMs=1e3*n.jitter),n.timestamp&&(e.timestamp=n.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const n=e.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let t=0,e=null,n=null;this.mediaBytesSent.forEach(i=>{t+=i.diffMean()}),this.mediaBytesRetransmit.forEach(i=>{e=e===null?i.diffMean():e+i.diffMean()}),this.mediaBytesTargetEncode.forEach(i=>{n=n===null?i.diffMean():n+i.diffMean()});const r=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},wX=class extends Wy{updateStats(){return mt.resolve()}};function Ky(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const o=function(){const a=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return a&&a[0]?Number(a[0].split("/")[1]):null}();return o?o<76?new AX(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new rL(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):function(a){if(!window.RTCStatsReport)return!1;const d=a.getStats();return!!(d instanceof mt||function(l){return!!l&&(typeof l=="object"||typeof l=="function")&&typeof l.then=="function"}(d))}(t)?new rL(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new wX(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i})}const iL="websdk_ng_install_id";function qy(){try{if(M("INSTALL_ID"))return M("INSTALL_ID");let t=window.localStorage.getItem(iL);return t||(t=gd(),window.localStorage.setItem(iL,t)),Fe("INSTALL_ID",t),t}catch{return}}const is=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){const n=e[1],r=e[2];return"".concat(n,".").concat(r)}return"4.0.0.999"}("4.23.2"),Yy=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let Td=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({});const Rr=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const r=n.join(""),i=[];for(let d=0;d<6;d++)i.push("1");const o=i.join(""),a={};return a[t]=r,a[e]=o,Object.assign(a,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Rr;const Ym={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_AUT_FEEDBACK:!1,SVC_EXTENDED:["VP9"]},zy={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Jy="v4.23.2-0-g1599fdac-dirty(3/4/2025, 5:13:36 PM)",Xy={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!1,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",USE_TURN_IP:!1,NEW_TURN_MODE:void 0,NEW_FORCE_TURN:!1},tn=St(St(St({},Xy),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS_METADATA:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:zy,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},Ym),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1},{INSTALL_ID:""});function Fe(t,e,n){var r,i,o;ft(r=Object.keys(tn)).call(r,t)&&(!n&&ft(i=Object.keys(Qs)).call(i,t)||(tn[t]=e,t!=="ENABLE_VIDEO_SEI"&&t!=="ENABLE_AUDIO_TOPN"&&t!=="ENABLE_AUDIO_METADATA"&&t!=="ENABLE_AUDIO_PTS_METADATA"||e!==!0||(tn.ENABLE_ENCODED_TRANSFORM=!0,t==="ENABLE_AUDIO_PTS_METADATA"&&(tn.ENABLE_AUDIO_METADATA=!0)),t==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,tn.USE_NEW_NETWORK_CONFIG=o,o&&(tn.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],tn.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],tn.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],tn.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],tn.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",tn.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",tn.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&e&&(tn.ENABLE_INSTANT_VIDEO=!0,tn.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&e&&(tn.ENABLE_AUT_CC=!0),t==="NEW_FORCE_TURN"&&e&&(tn.NEW_TURN_MODE||(tn.NEW_TURN_MODE=4))))}function M(t){return tn[t]}Yy||(tn.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],tn.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],tn.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],tn.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],tn.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],tn.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],tn.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",tn.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",tn.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",tn.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",tn.AREAS=["NORTH_AMERICA","OVERSEA"]);let sL=function(t){return t[t.REALTIME=1]="REALTIME",t}({});const Qs={};var le=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(le||{});let zm=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});const oL=128,bX=96,aL=1e3,du=10;let OX=0;var cL=(()=>{var t={8:(r,i,o)=>{o.r(i),o.d(i,{Parser:()=>Et,Printer:()=>Mn,parse:()=>ut,print:()=>At});const a=`
`,d="".concat("\r").concat(a),l=" ";let h;function f(ot){return ot>="0"&&ot<="9"}function m(ot){return ot>="!"&&ot<="~"}function T(ot){return m(ot)||ot>=""&&ot<="ÿ"}function S(ot){return ot==="!"||ot>="#"&&ot<="'"||ot>="*"&&ot<="+"||ot>="-"&&ot<="."||ot>="0"&&ot<="9"||ot>="A"&&ot<="Z"||ot>="^"&&ot<="~"}function w(ot){return ot>="1"&&ot<="9"}function I(ot){return ot>="A"&&ot<="Z"||ot>="a"&&ot<="z"}function C(ot){return ot==="d"||ot==="h"||ot==="m"||ot==="s"}function N(ot){return ot>""&&ot<"	"||ot>"\v"&&ot<"\f"||ot>""&&ot<"ÿ"}function P(ot){return I(ot)||f(ot)||ot==="+"||ot==="/"}function x(ot){return f(ot)||I(ot)||ot==="+"||ot==="/"||ot==="-"||ot==="_"}function W(ot){return I(ot)||f(ot)||ot==="+"||ot==="/"}function H(ot,R){var U=Object.keys(ot);if(Object.getOwnPropertySymbols){var F=Object.getOwnPropertySymbols(ot);R&&(F=F.filter(function(lt){return Object.getOwnPropertyDescriptor(ot,lt).enumerable})),U.push.apply(U,F)}return U}function j(ot){for(var R=1;R<arguments.length;R++){var U=arguments[R]!=null?arguments[R]:{};R%2?H(Object(U),!0).forEach(function(F){$(ot,F,U[F])}):Object.getOwnPropertyDescriptors?Object.defineProperties(ot,Object.getOwnPropertyDescriptors(U)):H(Object(U)).forEach(function(F){Object.defineProperty(ot,F,Object.getOwnPropertyDescriptor(U,F))})}return ot}function $(ot,R,U){return R in ot?Object.defineProperty(ot,R,{value:U,enumerable:!0,configurable:!0,writable:!0}):ot[R]=U,ot}(function(ot){ot.VERSION="v",ot.ORIGIN="o",ot.SESSION_NAME="s",ot.INFORMATION="i",ot.URI="u",ot.EMAIL="e",ot.PHONE="p",ot.CONNECTION="c",ot.BANDWIDTH="b",ot.TIME="t",ot.REPEAT="r",ot.ZONE_ADJUSTMENTS="z",ot.KEY="k",ot.ATTRIBUTE="a",ot.MEDIA="m"})(h||(h={}));class ct{consumeText(R,U){let F=U;for(;F<R.length;){const lt=R[F];if(lt==="\0"||lt==="\r"||lt===a)break;F+=1}if(F-U==0)throw new Error("Invalid text, at ".concat(R));return F}consumeUnicastAddress(R,U,F){return this.consumeTill(R,U,l)}consumeOneOrMore(R,U,F){let lt=U;for(;F(R[lt]);)lt++;if(lt-U==0)throw new Error("Invalid rule at ".concat(U,"."));return lt}consumeSpace(R,U){if(R[U]===l)return U+1;throw new Error("Invalid space at ".concat(U,"."))}consumeIP4Address(R,U){let F=U;for(let lt=0;lt<4;lt++)if(F=this.consumeDecimalUChar(R,F),lt!==3){if(R[F]!==".")throw new Error("Invalid IP4 address.");F++}return F}consumeDecimalUChar(R,U){let F=U;for(let Xt=0;Xt<3&&f(R[F]);Xt++,F++);if(F-U==0)throw new Error("Invalid decimal uchar.");const lt=parseInt(R.slice(U,F));if(lt>=0&&lt<=255)return F;throw new Error("Invalid decimal uchar")}consumeIP6Address(R,U){let F=this.consumeHexpart(R,U);return R[F]===":"&&(F+=1,F=this.consumeIP4Address(R,F)),F}consumeHexpart(R,U){let F=U;if(R[F]===":"&&R[F+1]===":"){F+=2;try{F=this.consumeHexseq(R,F)}catch{}return F}if(F=this.consumeHexseq(R,F),R[F]===":"&&R[F+1]===":"){F+=2;try{F=this.consumeHexseq(R,F)}catch{}return F}return F}consumeHexseq(R,U){let F=U;for(;F=this.consumeHex4(R,F),R[F]===":"&&R[F+1]!==":";)F+=1;return F}consumeHex4(R,U){let F=0;for(;F<4;F++)if(!((lt=R[U+F])>="0"&&lt<="9"||lt>="a"&&lt<="f"||lt>="A"&&lt<="F")){if(F===0)throw new Error("Invalid hex 4");break}var lt;return U+F}consumeFQDN(R,U){let F=U;for(;f(R[F])||I(R[F])||R[F]==="-"||R[F]===".";)F+=1;if(F-U<4)throw new Error("Invalid FQDN");return F}consumeExtnAddr(R,U){return this.consumeOneOrMore(R,U,T)}consumeMulticastAddress(R,U,F){switch(F){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(R,U);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(R,U);default:try{return this.consumeFQDN(R,U)}catch{return this.consumeExtnAddr(R,U)}}}consumeIP6MulticastAddress(R,U){const F=this.consumeHexpart(R,U);return R[F]==="/"?this.consumeInteger(R,F+1):F}consumeIP4MulticastAddress(R,U){let F=U+3;const lt=R.slice(U,F),Xt=parseInt(lt);if(Xt<224||Xt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let We=0;We<3;We++){if(R[F]!==".")throw new Error("Invalid IP4 multicast address.");F+=1,F=this.consumeDecimalUChar(R,F)}return R[F]==="/"&&(F+=1),F=this.consumeTTL(R,F),R[F]==="/"&&(F=this.consumeInteger(R,F)),F}consumeInteger(R,U){if(!w(R[U]))throw new Error("Invalid integer.");for(U+=1;f(R[U]);)U+=1;return U}consumeTTL(R,U){if(R[U]==="0")return U+1;if(!w(R[U]))throw new Error("Invalid TTL.");U+=1;for(let F=0;F<2&&f(R[U]);F++)U+=1;return U}consumeToken(R,U){return this.consumeOneOrMore(R,U,S)}consumeTime(R,U){let F=U;if(R[F]==="0")return F+1;for(w(R[F])&&(F+=1);f(R[F]);)F++;if(F-U<10)throw new Error("Invalid time");return F}consumeAddress(R,U){return this.consumeTill(R,U,l)}consumeTypedTime(R,U){let F=U;return F=this.consumeOneOrMore(R,F,f),C(R[F])?F+1:F}consumeRepeatInterval(R,U){if(!w(R[U]))throw new Error("Invalid repeat interval");for(U+=1;f(R[U]);)U+=1;return C(R[U])&&(U+=1),U}consumePort(R,U){return this.consumeOneOrMore(R,U,f)}consume(R,U,F){for(let lt=0;lt<F.length;lt++){if(U+lt>=R.length)throw new Error("consume exceeding value length");if(R[U+lt]!==F[lt])throw new Error("consume ".concat(F," failed at ").concat(lt))}return U+F.length}consumeTill(R,U,F){let lt=U;for(;lt<R.length&&(typeof F!="string"||R[lt]!==F)&&(typeof F!="function"||!F(R[lt]));)lt++;return lt}}class Et extends ct{constructor(){super(),$(this,"records",[]),$(this,"currentLine",0)}parse(R){const U=this.probeEOL(R);this.records=R.split(U).filter(Wd=>!!Br(Wd).call(Wd)).map(this.parseLine),this.currentLine=0;const F=this.parseVersion(),lt=this.parseOrigin(),Xt=this.parseSessionName(),We=this.parseInformation(),ir=this.parseUri(),Ii=this.parseEmail(),ka=this.parsePhone(),Gd=this.parseConnection(),$p=this.parseBandWidth(),sg=this.parseTimeFields(),og=this.parseKey(),hs=this.parseSessionAttribute(),Nc=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:F,origin:lt,sessionName:Xt,information:We,uri:ir,emails:Ii,phones:ka,connection:Gd,bandwidths:$p,timeFields:sg,key:og,attributes:hs,mediaDescriptions:Nc}}getCurrentRecord(){const R=this.records[this.currentLine];if(!R)throw new Error("Record doesn't exit.");return R}probeEOL(R){for(let U=0;U<R.length;U++)if(R[U]===a)return R[U-1]==="\r"?d:a;throw new Error("Invalid newline character.")}parseLine(R,U){if(R.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const F=R[0];if(R[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:F,value:R.slice(2),line:U,cur:0}}parseSessionAttribute(){const R=new he;for(;this.currentLine<this.records.length;){const U=this.getCurrentRecord();if(U.type!==h.ATTRIBUTE)break;const F={attField:this.extractOneOrMore(U,lt=>S(lt)&&lt!==":"),_cur:0};U.value[U.cur]===":"&&(U.cur+=1,F.attValue=this.extractOneOrMore(U,N)),R.parse(F),this.currentLine++}return R.digest()}parseMediaAttributes(R){const U=new pe(R);for(;this.currentLine<this.records.length;){const F=this.getCurrentRecord();if(F.type!==h.ATTRIBUTE)break;const lt={attField:this.extractOneOrMore(F,Xt=>S(Xt)&&Xt!==":"),_cur:0};F.value[F.cur]===":"&&(F.cur+=1,lt.attValue=this.extractOneOrMore(F,N)),U.parse(lt),this.currentLine++}return U.digest()}parseKey(){const R=this.getCurrentRecord();if(R.type===h.KEY){if(R.value==="prompt"||R.value==="clear:"||R.value==="base64:"||R.value==="uri:")return R.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const R=this.getCurrentRecord();if(R.type===h.ZONE_ADJUSTMENTS){const U=[];for(;;)try{const F=this.extract(R,this.consumeTime);this.consumeSpaceForRecord(R);let lt=!1;R.value[R.cur]==="-"&&(lt=!0,R.cur+=1);const Xt=this.extract(R,this.consumeTypedTime);U.push({time:F,typedTime:Xt,back:lt})}catch{break}if(U.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,U}return[]}parseRepeat(){const R=[];for(;;){const U=this.getCurrentRecord();if(U.type!==h.REPEAT)break;{const F=this.extract(U,this.consumeRepeatInterval),lt=this.parseTypedTime(U);R.push({repeatInterval:F,typedTimes:lt}),this.currentLine++}}return R}parseTypedTime(R){const U=[];for(;;)try{this.consumeSpaceForRecord(R),U.push(this.extract(R,this.consumeTypedTime))}catch{break}if(U.length===0)throw new Error("Invalid typed time.");return U}parseTime(){const R=this.getCurrentRecord(),U=this.extract(R,this.consumeTime);this.consumeSpaceForRecord(R);const F=this.extract(R,this.consumeTime);return this.currentLine++,{startTime:U,stopTime:F}}parseBandWidth(){const R=[];for(;this.currentLine<this.records.length;){const U=this.getCurrentRecord();if(U.type!==h.BANDWIDTH)break;{const F=this.extractOneOrMore(U,S);if(U.value[U.cur]!==":")throw new Error("Invalid bandwidth field.");U.cur++;const lt=this.extractOneOrMore(U,f);R.push({bwtype:F,bandwidth:lt}),this.currentLine++}}return R}parseVersion(){const R=this.getCurrentRecord();if(R.type!==h.VERSION)throw new Error("first sdp record must be version");const U=R.value.slice(0,this.consumeOneOrMore(R.value,0,f));if(U.length!==R.value.length)throw new Error('invalid proto version, "v='.concat(R.value,'"'));return this.currentLine++,U}parseOrigin(){const R=this.getCurrentRecord();if(R.type!==h.ORIGIN)throw new Error("second line of sdp must be origin");const U=this.extractOneOrMore(R,T);this.consumeSpaceForRecord(R);const F=this.extractOneOrMore(R,f);this.consumeSpaceForRecord(R);const lt=this.extractOneOrMore(R,f);this.consumeSpaceForRecord(R);const Xt=this.extractOneOrMore(R,S);this.consumeSpaceForRecord(R);const We=this.extractOneOrMore(R,S);this.consumeSpaceForRecord(R);const ir=this.extract(R,this.consumeUnicastAddress);return this.currentLine++,{username:U,sessId:F,sessVersion:lt,nettype:Xt,addrtype:We,unicastAddress:ir}}parseSessionName(){const R=this.getCurrentRecord();if(R.type===h.SESSION_NAME){const U=this.extract(R,this.consumeText);return this.currentLine++,U}}parseInformation(){const R=this.getCurrentRecord();if(R.type!==h.INFORMATION)return;const U=this.extract(R,this.consumeText);return this.currentLine++,U}parseUri(){const R=this.getCurrentRecord();if(R.type===h.URI)return this.currentLine++,R.value}parseEmail(){const R=[];for(;;){const U=this.getCurrentRecord();if(U.type!==h.EMAIL)break;R.push(U.value),this.currentLine++}return R}parsePhone(){const R=[];for(;;){const U=this.getCurrentRecord();if(U.type!==h.PHONE)break;R.push(U.value),this.currentLine++}return R}parseConnection(){const R=this.getCurrentRecord();if(R.type===h.CONNECTION){const U=this.extractOneOrMore(R,S);this.consumeSpaceForRecord(R);const F=this.extractOneOrMore(R,S);this.consumeSpaceForRecord(R);const lt=this.extract(R,this.consumeAddress);return this.currentLine++,{nettype:U,addrtype:F,address:lt}}}parseMedia(){const R=this.getCurrentRecord(),U=this.extract(R,this.consumeToken);this.consumeSpaceForRecord(R);let F=this.extract(R,this.consumePort);R.value[R.cur]==="/"&&(R.cur+=1,F+=this.extract(R,this.consumeInteger)),this.consumeSpaceForRecord(R);const lt=[];for(lt.push(this.extract(R,this.consumeToken));R.value[R.cur]==="/";)R.cur+=1,lt.push(this.extract(R,this.consumeToken));if(lt.length===0)throw new Error("Invalid proto");const Xt=this.parseFmt(R);return this.currentLine++,{mediaType:U,port:F,protos:lt,fmts:Xt}}parseTimeFields(){const R=[];for(;this.getCurrentRecord().type===h.TIME;){const U=this.parseTime(),F=this.parseRepeat(),lt=this.parseZone();R.push({time:U,repeats:F,zones:lt})}return R}parseMediaDescription(){const R=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===h.MEDIA;){const U=this.parseMedia(),F=this.parseInformation(),lt=this.parseConnections(),Xt=this.parseBandWidth(),We=this.parseKey(),ir=this.parseMediaAttributes(U);R.push({media:U,information:F,connections:lt,bandwidths:Xt,key:We,attributes:ir})}return R}parseConnections(){const R=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===h.CONNECTION;)R.push(this.parseConnection());return R}parseFmt(R){const U=[];for(;;)try{this.consumeSpaceForRecord(R),U.push(this.extract(R,this.consumeToken))}catch{break}if(U.length===0)throw new Error("Invalid fmts");return U}extract(R,U){for(var F=arguments.length,lt=new Array(F>2?F-2:0),Xt=2;Xt<F;Xt++)lt[Xt-2]=arguments[Xt];const We=U.call(this,R.value,R.cur,...lt),ir=R.value.slice(R.cur,We);return R.cur=We,ir}extractOneOrMore(R,U){const F=this.consumeOneOrMore(R.value,R.cur,U),lt=R.value.slice(R.cur,F);return R.cur=F,lt}consumeSpaceForRecord(R){if(R.value[R.cur]!==l)throw new Error("Invalid space at ".concat(R.cur,"."));R.cur+=1}}class Tt extends ct{constructor(){super(...arguments),$(this,"attributes",void 0),$(this,"digested",!1)}extractOneOrMore(R,U,F){const lt=this.consumeOneOrMore(R.attValue,R._cur,U),Xt=R.attValue.slice(R._cur,lt),[We,ir]=F||[];if(typeof We=="number"&&Xt.length<We)throw new Error("error in length, should be more or equal than ".concat(We," characters."));if(typeof ir=="number"&&Xt.length>ir)throw new Error("error in length, should be less or equal than ".concat(ir," characters."));return R._cur=lt,Xt}consumeAttributeSpace(R){if(R.attValue[R._cur]!==l)throw new Error("Invalid space at ".concat(R._cur,"."));R._cur+=1}extract(R,U){if(!R.attValue)throw new Error("Nothing to extract from attValue.");for(var F=arguments.length,lt=new Array(F>2?F-2:0),Xt=2;Xt<F;Xt++)lt[Xt-2]=arguments[Xt];const We=U.call(this,R.attValue,R._cur,...lt),ir=R.attValue.slice(R._cur,We);return R._cur=We,ir}atEnd(R){if(!R.attValue)throw new Error;return R._cur>=R.attValue.length}peekChar(R){if(!R.attValue)throw new Error;return R.attValue[R._cur]}peek(R,U){if(!R.attValue)throw new Error;for(let F=0;F<U.length;F++)if(U[F]!==R.attValue[R._cur+F])return!1;return!0}parseIceUfrag(R){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(R,P,[4,256])}parseIcePwd(R){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(R,P,[22,256])}parseIceOptions(R){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const U=[];for(;!this.atEnd(R);){U.push(this.extractOneOrMore(R,P));try{this.consumeAttributeSpace(R)}catch(F){if(this.atEnd(R))break;throw F}}this.attributes.iceOptions=U}parseFingerprint(R){const U=this.extract(R,this.consumeToken);this.consumeAttributeSpace(R);const F=this.extract(R,this.consumeTill);this.attributes.fingerprints.push({hashFunction:U,fingerprint:F})}parseExtmap(R){const U=this.extractOneOrMore(R,f);let F;this.peekChar(R)==="/"&&(this.extract(R,this.consume,"/"),F=this.extract(R,this.consumeToken)),this.consumeAttributeSpace(R);const lt=this.extract(R,this.consumeTill,l),Xt=j(j({entry:parseInt(U,10)},F&&{direction:F}),{},{extensionName:lt});this.peekChar(R)===l&&(this.consumeAttributeSpace(R),Xt.extensionAttributes=this.extract(R,this.consumeTill)),this.attributes.extmaps.push(Xt)}parseSetup(R){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const U=this.extract(R,this.consumeTill);if(U!=="active"&&U!=="passive"&&U!=="actpass"&&U!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=U}}class he extends Tt{constructor(){super(...arguments),$(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(R){if(this.digested)throw new Error("already digested");try{switch(R.attField){case"group":this.parseGroup(R);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(R);break;case"ice-pwd":this.parseIcePwd(R);break;case"ice-options":this.parseIceOptions(R);break;case"fingerprint":this.parseFingerprint(R);break;case"setup":this.parseSetup(R);break;case"tls-id":this.parseTlsId(R);break;case"identity":this.parseIdentity(R);break;case"extmap":this.parseExtmap(R);break;case"msid-semantic":this.parseMsidSemantic(R);break;default:R.ignored=!0,this.attributes.unrecognized.push(R)}}catch(U){throw console.error("parsing session attribute ".concat(R.attField,' error, "a=').concat(R.attField,":").concat(R.attValue,'"')),U}if(!R.ignored&&R.attValue&&!this.atEnd(R))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(R){const U=this.extract(R,this.consumeToken),F=[];for(;!this.atEnd(R)&&this.peekChar(R)===l;)this.consumeAttributeSpace(R),F.push(this.extract(R,this.consumeToken));this.attributes.groups.push({semantic:U,identificationTag:F})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(R){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(R,x)}parseIdentity(R){const U=this.extractOneOrMore(R,W),F=[];for(;!this.atEnd(R)&&this.peekChar(R)===l;){this.consumeAttributeSpace(R);const lt=this.extract(R,this.consumeToken);this.extract(R,this.consume,"=");const Xt=this.extractOneOrMore(R,We=>We!==l&&N(We));F.push({name:lt,value:Xt})}this.attributes.identities.push({assertionValue:U,extensions:F})}parseMsidSemantic(R){this.peekChar(R)===l&&this.consumeAttributeSpace(R);const U={semantic:this.extract(R,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(R)}catch{break}if(this.peekChar(R)==="*"){this.extract(R,this.consume,"*"),U.applyForAll=!0;break}{const F=this.extract(R,this.consumeTill,l);U.identifierList.push(F)}}this.attributes.msidSemantic=U}}class pe extends Tt{constructor(R){super(),$(this,"attributes",void 0),R.protos.indexOf("RTP")!==-1||R.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(R){if(this.digested)throw new Error("already digested");try{switch(R.attField){case"extmap":this.parseExtmap(R);break;case"setup":this.parseSetup(R);break;case"ice-ufrag":this.parseIceUfrag(R);break;case"ice-pwd":this.parseIcePwd(R);break;case"ice-options":this.parseIceOptions(R);break;case"candidate":this.parseCandidate(R);break;case"remote-candidate":this.parseRemoteCandidate(R);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(R);break;case"rtpmap":this.parseRtpmap(R);break;case"ptime":this.parsePtime(R);break;case"maxptime":this.parseMaxPtime(R);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(R);break;case"ssrc":this.parseSSRC(R);break;case"fmtp":this.parseFmtp(R);break;case"rtcp-fb":this.parseRtcpFb(R);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(R);break;case"mid":this.parseMid(R);break;case"msid":this.parseMsid(R);break;case"imageattr":this.parseImageAttr(R);break;case"rid":this.parseRid(R);break;case"simulcast":this.parseSimulcast(R);break;case"sctp-port":this.parseSctpPort(R);break;case"max-message-size":this.parseMaxMessageSize(R);break;case"ssrc-group":this.parseSSRCGroup(R);break;default:R.ignored=!0,this.attributes.unrecognized.push(R)}}catch(U){throw console.error("parsing media attribute ".concat(R.attField,' error, "a=').concat(R.attField,":").concat(R.attValue,'"')),U}if(!R.ignored&&R.attValue&&!this.atEnd(R))throw new Error("attribute parsing error")}parseCandidate(R){const U=this.extractOneOrMore(R,P,[1,32]);this.consumeAttributeSpace(R);const F=this.extractOneOrMore(R,f,[1,5]);this.consumeAttributeSpace(R);const lt=this.extract(R,this.consumeToken);this.consumeAttributeSpace(R);const Xt=this.extractOneOrMore(R,f,[1,10]);this.consumeAttributeSpace(R);const We=this.extract(R,this.consumeAddress);this.consumeAttributeSpace(R);const ir=this.extract(R,this.consumePort);this.consumeAttributeSpace(R),this.extract(R,this.consume,"typ"),this.consumeAttributeSpace(R);const Ii={foundation:U,componentId:F,transport:lt,priority:Xt,connectionAddress:We,port:ir,type:this.extract(R,this.consumeToken),extension:{}};for(this.peek(R," raddr")&&(this.extract(R,this.consume," raddr"),this.consumeAttributeSpace(R),Ii.relAddr=this.extract(R,this.consumeAddress)),this.peek(R," rport")&&(this.extract(R,this.consume," rport"),this.consumeAttributeSpace(R),Ii.relPort=this.extract(R,this.consumePort));this.peekChar(R)===l;){this.consumeAttributeSpace(R);const ka=this.extract(R,this.consumeToken);this.consumeAttributeSpace(R),Ii.extension[ka]=this.extractOneOrMore(R,m)}this.attributes.candidates.push(Ii)}parseRemoteCandidate(R){const U=[];for(;;){const F=this.extractOneOrMore(R,f,[1,5]);this.consumeAttributeSpace(R);const lt=this.extract(R,this.consumeAddress);this.consumeAttributeSpace(R);const Xt=this.extract(R,this.consumePort);U.push({componentId:F,connectionAddress:lt,port:Xt});try{this.consumeAttributeSpace(R)}catch{break}}this.attributes.remoteCandidatesList.push(U)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(R){const U=this.extract(R,this.consumeToken);this.consumeAttributeSpace(R);const F=this.extract(R,this.consumeTill,"/");this.extract(R,this.consume,"/");const lt={encodingName:F,clockRate:this.extractOneOrMore(R,f)};this.atEnd(R)||this.peekChar(R)!=="/"||(this.extract(R,this.consume,"/"),lt.encodingParameters=parseInt(this.extract(R,this.consumeTill),10));const Xt=this.attributes.payloads.find(We=>We.payloadType===parseInt(U,10));Xt?Xt.rtpMap=lt:this.attributes.payloads.push({payloadType:parseInt(U,10),rtpMap:lt,rtcpFeedbacks:[]})}parsePtime(R){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(R,this.consumeTill)}parseMaxPtime(R){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(R,this.consumeTill)}parseDirection(R){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=R.attField}parseSSRC(R){const U=this.extractOneOrMore(R,f);this.consumeAttributeSpace(R);const F=this.extract(R,this.consumeTill,":");let lt;this.peekChar(R)===":"&&(this.extract(R,this.consume,":"),lt=this.extract(R,this.consumeTill));const Xt=this.attributes.ssrcs.find(We=>We.ssrcId===parseInt(U,10));Xt?Xt.attributes[F]=lt:this.attributes.ssrcs.push({ssrcId:parseInt(U,10),attributes:{[F]:lt}})}parseFmtp(R){const U=this.extract(R,this.consumeTill,l);this.consumeAttributeSpace(R);const F=this.extract(R,this.consumeTill),lt={};F.split(";").forEach(We=>{let[ir,Ii]=We.split("=");ir=Br(ir).call(ir);const ka=typeof Ii=="string"?Br(Ii).call(Ii):null;typeof ir=="string"&&ir.length>0&&(lt[ir]=ka)});const Xt=this.attributes.payloads.find(We=>We.payloadType===parseInt(U,10));Xt?Xt.fmtp={parameters:lt}:this.attributes.payloads.push({payloadType:parseInt(U,10),rtcpFeedbacks:[],fmtp:{parameters:lt}})}parseFmtParameters(R){const U={},F=this.extract(R,this.consumeTill,"=");R._cur++;const lt=this.extract(R,this.consumeTill,";");for(U[F]=lt;R.attValue[R._cur]===";";){const Xt=this.extract(R,this.consumeTill,"=");R._cur++;const We=this.extract(R,this.consumeTill,";");U[Xt]=We}return U}parseRtcpFb(R){let U="";U=this.peekChar(R)==="*"?this.extract(R,this.consume,"*"):this.extract(R,this.consumeTill,l),this.consumeAttributeSpace(R);const F=this.extract(R,this.consumeTill,l);let lt;if(F==="trr-int")lt={type:F,interval:this.extract(R,this.consumeTill)};else{const Xt={type:F};this.peekChar(R)===l&&(this.consumeAttributeSpace(R),Xt.parameter=this.extract(R,this.consumeToken),this.peekChar(R)===l&&(Xt.additional=this.extract(R,this.consumeTill))),lt=Xt}if(U==="*")this.attributes.rtcpFeedbackWildcards.push(lt);else{const Xt=this.attributes.payloads.find(We=>We.payloadType===parseInt(U,10));Xt?Xt.rtcpFeedbacks.push(lt):this.attributes.payloads.push({payloadType:parseInt(U,10),rtcpFeedbacks:[lt]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(R){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const U={port:this.extract(R,this.consumePort)};this.peekChar(R)===l&&(this.consumeAttributeSpace(R),U.netType=this.extractOneOrMore(R,S),this.consumeAttributeSpace(R),U.addressType=this.extractOneOrMore(R,S),this.consumeAttributeSpace(R),U.address=this.extract(R,this.consumeAddress)),this.attributes.rtcp=U}parseMsid(R){const U={id:this.extractOneOrMore(R,S,[1,64])};this.peekChar(R)===l&&(this.consumeAttributeSpace(R),U.appdata=this.extractOneOrMore(R,S,[1,64])),this.attributes.msids.push(U)}parseImageAttr(R){this.attributes.imageattr.push(R.attValue)}parseRid(R){const U=this.extractOneOrMore(R,lt=>I(lt)||f(lt)||lt==="_"||lt==="-");this.consumeAttributeSpace(R);const F={id:U,direction:this.extract(R,this.consumeToken),params:[]};if(this.peekChar(R)===l){if(this.consumeAttributeSpace(R),this.peek(R,"pt=")){this.extract(R,this.consume,"pt=");const lt=[];for(;;){const Xt=this.extract(R,this.consumeToken);lt.push(Xt);try{this.extract(R,this.consume,",")}catch{break}}F.payloads=lt,this.peekChar(R)===l&&this.extract(R,this.consume,l)}for(;;){const lt=this.extract(R,this.consumeToken);switch(lt){case"depend":{const Xt={type:lt,rids:this.extract(R,this.consume,"=").split(",")};F.params.push(Xt);break}default:{const Xt={type:lt};this.peekChar(R)==="="&&(this.extract(R,this.consume,"="),Xt.val=this.extract(R,this.consumeTill,";")),F.params.push(Xt)}}try{this.extract(R,this.consume,";")}catch{break}}}this.attributes.rids.push(F)}parseSimulcast(R){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=R.attValue,this.extract(R,this.consumeTill)}parseSctpPort(R){this.attributes.sctpPort=this.extractOneOrMore(R,f,[1,5])}parseMaxMessageSize(R){this.attributes.maxMessageSize=this.extractOneOrMore(R,f,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(R){this.attributes.mid=this.extract(R,this.consumeToken)}parseSSRCGroup(R){const U=this.extract(R,this.consumeToken),F=[];for(;;)try{this.consumeAttributeSpace(R);const lt=this.extract(R,this.consumeInteger);F.push(parseInt(lt,10))}catch{break}this.attributes.ssrcGroups.push({semantic:U,ssrcIds:F})}}function Xe(ot,R,U){return R in ot?Object.defineProperty(ot,R,{value:U,enumerable:!0,configurable:!0,writable:!0}):ot[R]=U,ot}class Mn{constructor(){Xe(this,"eol",d)}print(R,U){let F="";return U&&(this.eol=U),F+=this.printVersion(R.version),F+=this.printOrigin(R.origin),F+=this.printSessionName(R.sessionName),F+=this.printInformation(R.information),F+=this.printUri(R.uri),F+=this.printEmail(R.emails),F+=this.printPhone(R.phones),F+=this.printConnection(R.connection),F+=this.printBandwidth(R.bandwidths),F+=this.printTimeFields(R.timeFields),F+=this.printKey(R.key),F+=this.printSessionAttributes(R.attributes),F+=this.printMediaDescription(R.mediaDescriptions),F}printVersion(R){return"v=".concat(R).concat(this.eol)}printOrigin(R){return"o=".concat(R.username," ").concat(R.sessId," ").concat(R.sessVersion," ").concat(R.nettype," ").concat(R.addrtype," ").concat(R.unicastAddress).concat(this.eol)}printSessionName(R){return R?"s=".concat(R).concat(this.eol):""}printInformation(R){return R?"i=".concat(R).concat(this.eol):""}printUri(R){return R?"u=".concat(R).concat(this.eol):""}printEmail(R){let U="";for(const F of R)U+="e=".concat(F).concat(this.eol);return U}printPhone(R){let U="";for(const F of R)U+="e=".concat(F).concat(this.eol);return U}printConnection(R){return R?"c=".concat(R.nettype," ").concat(R.addrtype," ").concat(R.address).concat(this.eol):""}printBandwidth(R){let U="";for(const F of R)U+="b=".concat(F.bwtype,":").concat(F.bandwidth).concat(this.eol);return U}printTimeFields(R){let U="";for(const F of R){U+="t=".concat(F.time.startTime," ").concat(F.time.startTime).concat(this.eol);for(const lt of F.repeats)U+="r=".concat(lt.repeatInterval," ").concat(lt.typedTimes.join(" ")).concat(this.eol);F.zoneAdjustments&&(U+="z=",U+="z=".concat(F.zoneAdjustments.map(lt=>"".concat(lt.time," ").concat(lt.back?"-":""," ").concat(lt.typedTime)).join(" ")).concat(this.eol),U+=this.eol)}return U}printKey(R){return R?"k=".concat(R).concat(this.eol):""}printAttributes(R){let U="";for(const F of R)U+="a=".concat(F.attField).concat(F.attValue?":".concat(F.attValue):"").concat(this.eol);return U}printMediaDescription(R){let U="";for(const F of R)U+=this.printMedia(F.media),U+=this.printInformation(F.information),U+=this.printConnections(F.connections),U+=this.printBandwidth(F.bandwidths),U+=this.printKey(F.key),U+=this.printMediaAttributes(F);return U}printConnections(R){let U="";for(const F of R)U+=this.printConnection(F);return U}printMedia(R){return"m=".concat(R.mediaType," ").concat(R.port," ").concat(R.protos.join("/")," ").concat(R.fmts.join(" ")).concat(this.eol)}printSessionAttributes(R){return new pi(this.eol).print(R)}printMediaAttributes(R){return new it(this.eol).print(R)}}class Cn{constructor(R){Xe(this,"eol",void 0),this.eol=R}printIceUfrag(R){return R===void 0?"":"a=ice-ufrag:".concat(R).concat(this.eol)}printIcePwd(R){return R===void 0?"":"a=ice-pwd:".concat(R).concat(this.eol)}printIceOptions(R){return R===void 0?"":"a=ice-options:".concat(R.join(l)).concat(this.eol)}printFingerprints(R){return R.length>0?R.map(U=>"a=fingerprint:".concat(U.hashFunction).concat(l).concat(U.fingerprint)).join(this.eol)+this.eol:""}printExtmap(R){return R.map(U=>"a=extmap:".concat(U.entry).concat(U.direction?"/".concat(U.direction):"").concat(l).concat(U.extensionName).concat(U.extensionAttributes?"".concat(l).concat(U.extensionAttributes):"").concat(this.eol)).join("")}printSetup(R){return R===void 0?"":"a=setup:".concat(R).concat(this.eol)}printUnrecognized(R){return R.map(U=>"a=".concat(U.attField).concat(U.attValue?":".concat(U.attValue):"").concat(this.eol)).join("")}}class pi extends Cn{print(R){let U="";return U+=this.printGroups(R.groups),U+=this.printMsidSemantic(R.msidSemantic),U+=this.printIceLite(R.iceLite),U+=this.printIceUfrag(R.iceUfrag),U+=this.printIcePwd(R.icePwd),U+=this.printIceOptions(R.iceOptions),U+=this.printFingerprints(R.fingerprints),U+=this.printSetup(R.setup),U+=this.printTlsId(R.tlsId),U+=this.printIdentity(R.identities),U+=this.printExtmap(R.extmaps),U+=this.printUnrecognized(R.unrecognized),U}printGroups(R){let U="";return R.length>0&&(U+=R.map(F=>"a=group:".concat(F.semantic).concat(F.identificationTag.map(lt=>"".concat(l).concat(lt)).join("")).concat(this.eol)).join("")),U}printIceLite(R){return R===void 0?"":"a=ice-lite"+this.eol}printTlsId(R){return R?"a=tls-id:".concat(R).concat(this.eol):""}printIdentity(R){return R.length===0?"":R.map(U=>"a=identity:".concat(U.assertionValue).concat(U.extensions.map(F=>"".concat(l).concat(F.name).concat(F.value?"=".concat(F.value):"")))).join(this.eol)+this.eol}printMsidSemantic(R){if(!R)return"";let U="a=msid-semantic:".concat(R.semantic);return R.applyForAll?U+="".concat(l,"*"):R.identifierList.length>0&&(U+=R.identifierList.map(F=>"".concat(l).concat(F))),U+this.eol}}class it extends Cn{print(R){const U=R.attributes;let F="";return F+=this.printRTCP(U.rtcp),F+=this.printIceUfrag(U.iceUfrag),F+=this.printIcePwd(U.icePwd),F+=this.printIceOptions(U.iceOptions),F+=this.printCandidates(U.candidates),F+=this.printRemoteCandidatesList(U.remoteCandidatesList),F+=this.printEndOfCandidates(U.endOfCandidates),F+=this.printFingerprints(U.fingerprints),F+=this.printSetup(U.setup),F+=this.printMid(U.mid),F+=this.printExtmap(U.extmaps),F+=this.printRTPRelated(U),F+=this.printPtime(U.ptime),F+=this.printMaxPtime(U.maxPtime),F+=this.printDirection(U.direction),F+=this.printSSRCGroups(U.ssrcGroups),F+=this.printSSRC(U.ssrcs),F+=this.printRTCPMux(U.rtcpMux),F+=this.printRTCPMuxOnly(U.rtcpMuxOnly),F+=this.printRTCPRsize(U.rtcpRsize),F+=this.printMSId(U.msids),F+=this.printImageattr(U.imageattr),F+=this.printRid(U.rids),F+=this.printSimulcast(U.simulcast),F+=this.printSCTPPort(U.sctpPort),F+=this.printMaxMessageSize(U.maxMessageSize),F+=this.printUnrecognized(U.unrecognized),F}printCandidates(R){return R.map(U=>"a=candidate:".concat(U.foundation).concat(l).concat(U.componentId).concat(l).concat(U.transport).concat(l).concat(U.priority).concat(l).concat(U.connectionAddress).concat(l).concat(U.port).concat(l,"typ").concat(l).concat(U.type).concat(U.relAddr?"".concat(l,"raddr").concat(l).concat(U.relAddr):"").concat(U.relPort?"".concat(l,"rport").concat(l).concat(U.relPort):"").concat(Object.keys(U.extension).map(F=>"".concat(l).concat(F).concat(l).concat(U.extension[F])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(R){return R.map(U=>"a=remote-candidates:".concat(U.join(l)).concat(this.eol)).join("")}printEndOfCandidates(R){return R===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(R){if(!R.payloads)return"";const U=R.payloads;let F="";F+=R.rtcpFeedbackWildcards.map(lt=>this.printRTCPFeedback("*",lt)).join("");for(const lt of U)F+=this.printRtpMap(lt.payloadType,lt.rtpMap),F+=this.printFmtp(lt.payloadType,lt.fmtp),F+=lt.rtcpFeedbacks.map(Xt=>this.printRTCPFeedback(lt.payloadType,Xt)).join("");return F}printFmtp(R,U){if(!U)return"";const F=Object.keys(U.parameters);return F.length===1&&U.parameters[F[0]]===null?"a=fmtp:".concat(R).concat(l).concat(F[0]).concat(this.eol):"a=fmtp:".concat(R).concat(l).concat(Object.keys(U.parameters).map(lt=>"".concat(lt,"=").concat(U.parameters[lt])).join(";")).concat(this.eol)}printRtpMap(R,U){return U?"a=rtpmap:".concat(R).concat(l).concat(U.encodingName,"/").concat(U.clockRate).concat(U.encodingParameters?"/".concat(U.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(R,U){let F="a=rtcp-fb:".concat(R).concat(l),lt=U;return lt.type==="trr-int"?F+="ttr-int".concat(l).concat(lt.interval):(F+="".concat(lt.type),lt.parameter&&(F+="".concat(l).concat(lt.parameter),lt.additional&&(F+="".concat(l).concat(lt.additional)))),F+this.eol}printPtime(R){return R===void 0?"":"a=ptime:".concat(R).concat(this.eol)}printMaxPtime(R){return R===void 0?"":"a=maxptime:".concat(R).concat(this.eol)}printDirection(R){return R===void 0?"":"a=".concat(R).concat(this.eol)}printSSRC(R){return R.map(U=>Object.keys(U.attributes).map(F=>"a=ssrc:".concat(U.ssrcId.toString(10)).concat(l).concat(F).concat(U.attributes[F]?":".concat(U.attributes[F]):"").concat(this.eol)).join("")).join("")}printRTCPMux(R){return R===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(R){return R===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(R){return R===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(R){if(R===void 0)return"";let U="a=rtcp:".concat(R.port);return R.netType&&(U+="".concat(l).concat(R.netType)),R.addressType&&(U+="".concat(l).concat(R.addressType)),R.address&&(U+="".concat(l).concat(R.address)),U+this.eol}printMSId(R){return R.map(U=>"a=msid:".concat(U.id).concat(U.appdata?"".concat(l).concat(U.appdata):"").concat(this.eol)).join("")}printImageattr(R){return R.map(U=>"a=imageattr:".concat(U).concat(this.eol)).join("")}printRid(R){return R.map(U=>{let F="a=rid:".concat(U.id).concat(l).concat(U.direction);return U.payloads&&(F+="".concat(l,"pt=").concat(U.payloads.join(","))),U.params.length>0&&(F+="".concat(l).concat(U.params.map(lt=>lt.type==="depend"?"depend=".concat(lt.rids.join(",")):"".concat(lt.type,"=").concat(lt.val)).join(";"))),F+this.eol}).join("")}printSimulcast(R){return R===void 0?"":"a=simulcast:".concat(R).concat(this.eol)}printSCTPPort(R){return R===void 0?"":"a=sctp-port:".concat(R).concat(this.eol)}printMaxMessageSize(R){return R===void 0?"":"a=max-message-size:".concat(R).concat(this.eol)}printMid(R){return R===void 0?"":"a=mid:".concat(R).concat(this.eol)}printSSRCGroups(R){return R.map(U=>"a=ssrc-group:".concat(U.semantic).concat(U.ssrcIds.map(F=>"".concat(l).concat(F.toString(10))).join("")).concat(this.eol)).join("")}}function ut(ot){return new Et().parse(ot)}function At(ot,R){return new Mn().print(ot,R)}}},e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={exports:{}};return t[r](i,i.exports,n),i.exports}return n.d=(r,i)=>{for(var o in i)n.o(i,o)&&!n.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:i[o]})},n.o=(r,i)=>Object.prototype.hasOwnProperty.call(r,i),n.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n(8)})();function Si(t){return cL.parse(t)}function pc(t,e){return cL.print(t,e)}var NX=Es("Array").keys,PX=To,DX=or,kX=st,LX=NX,Qy=Array.prototype,MX={DOMTokenList:!0,NodeList:!0},UX=function(t){var e=t.keys;return t===Qy||kX(Qy,t)&&e===Qy.keys||DX(MX,PX(t))?LX:e},Gi=_(UX);function dL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function $t(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?dL(Object(n),!0).forEach(function(r){Rn(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):dL(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Rn(t,e,n){return(e=function(r){var i=function(o,a){if(typeof o!="object"||o===null)return o;var d=o[Symbol.toPrimitive];if(d!==void 0){var l=d.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:String(i)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const lL=new class extends _n{constructor(){super(...arguments),Rn(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class xX{constructor(e){Rn(this,"logger",void 0),Rn(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function $y(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function uL(){const t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const ss={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Jm=Date.now(),mp=t=>{for(const e in ss)if(Object.prototype.hasOwnProperty.call(ss,e)&&ss[e]===t)return e;return"DEFAULT"},v=new class{constructor(){Rn(this,"proxyServerURL",void 0),Rn(this,"logLevel",ss.DEBUG),Rn(this,"uploadState","collecting"),Rn(this,"uploadLogWaitingList",[]),Rn(this,"uploadLogUploadingList",[]),Rn(this,"uploadErrorCount",0),Rn(this,"currentLogID",0),Rn(this,"url",void 0),Rn(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[ss.DEBUG].concat(e);this.log.apply(this,r)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[ss.INFO].concat(e);this.log.apply(this,r)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[ss.WARNING].concat(e);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[ss.ERROR].concat(e);this.log.apply(this,r)}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[ss.DEBUG].concat(e);this.uploadLog.apply(this,r)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Fe("UPLOAD_LOG",!0)}disableLogUpload(){Fe("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new xX(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Jm<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Jm);const r=Math.max(0,Math.min(4,e[0]));if(e[0]=$y()+" Agora-SDK [".concat(mp(r),"]:"),this.appendLogToWaitingList(r,...e),r<this.logLevel)return;const i=$y()+" %cAgora-SDK [".concat(mp(r),"]:");let o=[];if(!M("USE_NEW_LOG"))switch(r){case ss.DEBUG:o=[i,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case ss.INFO:o=[i,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case ss.WARNING:o=[i,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case ss.ERROR:o=[i,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Jm<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Jm);const r=Math.max(0,Math.min(4,e[0]));e[0]=$y()+" Agora-SDK [".concat(mp(r),"]:"),this.appendLogToWaitingList(r,...e)}appendLogToWaitingList(t){if(!M("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];Array.isArray(n[0])?n[0][0]=uL()+" Agora-SDK [".concat(mp(t),"]:"):n[0]=uL()+" Agora-SDK [".concat(mp(t),"]:");let i="";n.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),i+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:i,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:is,process_id:M("PROCESS_ID"),payload:JSON.stringify(t)};return Xs(async()=>{const n=await ai.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(M("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(M("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){const r=new Error("unexpected upload log response");throw r.response=n,r}},()=>(this.uploadLogUploadingList=[],!1),n=>{const r={status:-1,message:n.message,errorRange:t.map(i=>i.log_item_id)};return n.response?(r.status=n.response.status,r.data=n.response.data,r.headers=n.response.headers):n.request&&(r.status=n.request.status),lL.reportLogUploadError(r),!0},{timeout:M("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:M("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,M("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),M("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),M("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),M("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var hL;function VX(t){return ur(t.reportId,"params.reportId",0,100,!1),ur(t.category,"params.category",0,100,!1),ur(t.event,"params.event",0,100,!1),ur(t.label,"params.label",0,100,!1),Ge(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(hL={}).FREE="free",hL.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});const FX={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let nr=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t.AB_TEST="ab_test",t}({}),cn=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t.AB_TEST="io.agora.pb.Wrtc.ABTest",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let BX=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function xt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,r){const i=r.value;if(typeof i=="function"){const o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);r.value=function(){for(var a,d=arguments.length,l=new Array(d),h=0;h<d;h++)l[h]=arguments[h];let f=l;if(t.argsMap)try{f=t.argsMap(this,...l)}catch(T){v.warning(T),f=[]}try{JSON.stringify(f)}catch{v.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),f=[]}const m=(t.report||bt).reportApiInvoke(this._sessionId||null,{id:this._clientId||((a=this.store)===null||a===void 0?void 0:a.clientId)||this._ID,name:"".concat(o,".").concat(String(n)),options:f,tag:vn.TRACER,reportResult:t.reportResult},t.throttleTime);try{const T=i.apply(this,l);return T instanceof mt?T.then(S=>(m.onSuccess(t.reportResult&&S),S)).catch(S=>{throw m.onError(S),S}):(m.onSuccess(t.reportResult&&T),T)}catch(T){throw m.onError(T),T}}}return r}}const bt=new class{constructor(){Rn(this,"baseInfoMap",new Map),Rn(this,"proxyServer",void 0),Rn(this,"eventUploadTimer",void 0),Rn(this,"setSessionIdTimer",void 0),Rn(this,"url",void 0),Rn(this,"sids",new Set),Rn(this,"backupUrl",void 0),Rn(this,"_appId",void 0),Rn(this,"_aid",0),Rn(this,"keyEventUploadPendingItems",[]),Rn(this,"normalEventUploadPendingItems",[]),Rn(this,"apiInvokeUploadPendingItems",[]),Rn(this,"apiInvokeCount",0),Rn(this,"apiInvokeLoggedCount",0),Rn(this,"ltsList",[]),Rn(this,"lastSendNormalEventTime",Date.now()),Rn(this,"customReportCounterTimer",void 0),Rn(this,"customReportCount",0),Rn(this,"extApiInvoke",async t=>{for(const e of t){const n=$t($t({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:vn.TRACER});this.sendApiInvoke(n)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),M("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),M("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t,this._aid=parseInt(t.replace(/[a-fA-F0-9]{8}/g,e=>{let[n,r]=e;return n+r}),16)||0}reportApiInvoke(t,e,n){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const r=Date.now();this.apiInvokeCount+=1;const i=this.apiInvokeCount,o=!!M("SHOW_REPORT_INVOKER_LOG"),a=!!M("SHOW_REPORT_USER_INVOKER_LOG"),d=o||a&&e.id;d&&(this.apiInvokeLoggedCount+=1);const l=this.apiInvokeLoggedCount;function h(S,w){if(d){let I="[apiInvoke-".concat(l,"]");e.id&&(I+="[".concat(e.id,"]")),e.name&&(I+="[".concat(e.name,"]")),v.info("".concat(I," ").concat(S),S==="start"?e.options:w||"")}}const f=()=>({tag:e.tag,invokeId:i,sid:t,name:e.name,apiInvokeTime:r,options:e.options,states:e.states||null});h("start");let m=!1;hr(e.timeout).then(()=>{m||(this.sendApiInvoke($t($t({},f()),{},{error:D.API_INVOKE_TIMEOUT,success:!1})),h("timeout"))});const T=new et(D.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:S=>{const w=()=>{if(m)throw T;return m=!0,this.sendApiInvoke($t($t({},f()),{},{success:!0},e.reportResult&&{result:S})),h("onSuccess"),S};return n?Kk(w,e.name+"Success",n,()=>m=!0):w()},onError:S=>{const w=()=>{if(m)throw S;m=!0,this.sendApiInvoke($t($t({},f()),{},{success:!1,error:S})),h("onFailure",S.toString())};return n?Kk(w,e.name+"Error",n,()=>m=!0):w()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const n=Date.now(),r=this.createBaseInfo(t,n);r.cname=e.cname;const i=Object.assign({},{willUploadConsoleLog:M("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Yy?"global":"oversea",areas:M("AREAS")&&M("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:a,channelMode:d,isABTestSuccess:l,lsid:h,clientRole:f}=e,m=Date.now(),T=$t($t({},r),{},{eventType:nr.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:Jy,lts:m,elapse:m-n,extend:JSON.stringify(i),mode:e.mode,process:M("PROCESS_ID"),appType:M("APP_TYPE"),success:!0,version:is,stringUid:o,channelProfile:a,channelMode:d,isABTestSuccess:l,lsid:h,clientType:ft(S=window.navigator.userAgent).call(S,"AgoraWebView")?42:20,clientRole:f,serviceId:M("PROCESS_ID"),extensionID:M("PLUGIN_INFO").join(",")||""});var S;this.send({type:cn.SESSION,data:T},!0)}joinChooseServer(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{role:e.role,eventType:nr.JOIN_CHOOSE_SERVER,lts:i,eventElapse:e.elapse||i-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:i-n.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0});this.send({type:cn.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{eventType:nr.REQ_USER_ACCOUNT,lts:i,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||i-n.startTime,eventElapse:i-e.lts,extend:JSON.stringify(e.extend)});this.send({type:cn.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info;e.vid&&(r.vid=e.vid),r.uid=e.uid,r.cid=e.cid;const i=Date.now(),{firstSuccess:o,avoidJoinStartTime:a,addr:d,isProxy:l}=e,h=i-(o&&a?a:n.startTime),f=$t($t({},r),{},{eventType:nr.JOIN_GATEWAY,lts:i,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:h,eventElapse:i-e.lts,firstSuccess:o,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:qy(),isABTestSuccess:e.isABTestSuccess?1:0}),m=f.success?1:0;if(e.succ&&(n.lastJoinSuccessTime=i),o)this.send({type:cn.JOIN_GATEWAY,data:f},!0);else{let T;if(d)if(l){const w=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),I=d.match(/p=[0-9]{1,6}/g);T={isSuccess:m,gatewayIp:w&&w.length?w[0].split("=")[1].replace(/-/g,"."):"",port:I&&I.length?I[0].split("=")[1]:"",isProxy:l?1:0}}else{const w=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),I=d.match(/(:|p=)[0-9]{1,6}/g);T={isSuccess:m,gatewayIp:w&&w.length?w[0].split("//")[1].replace(/-/g,"."):"",port:I&&I.length?I[0].split(/:|p=/g)[1]:"",isProxy:l?1:0}}else T={isSuccess:m,gatewayIp:"",port:"",isProxy:l?1:0};delete f.success,delete f.eventType,delete f.firstSuccess,f.vid=Number(f.vid);const S=Object.assign({},f,T,{eventType:nr.REJOIN_GATEWAY});this.send({type:cn.RE_JOIN_GATEWAY,data:S},!0)}}joinChannelTimeout(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=Date.now(),i=$t($t({},n.info),{},{lts:r,timeout:e,elapse:r-n.startTime});this.send({type:cn.JOIN_CHANNEL_TIMEOUT,data:i},!0)}publish(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{eventType:nr.PUBLISH,lts:i,eventElapse:e.eventElapse,elapse:i-n.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:cn.PUBLISH,data:o},!0)}subscribe(t,e,n){const r=this.baseInfoMap.get(t);if(!r)return;const i=r.info,o=Date.now(),a=$t($t({},i),{},{eventType:nr.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?a.peerSuid=e.peerid:a.peer=e.peerid,this.send({type:cn.SUBSCRIBE,data:a},!0)}wsCompressorInit(t){var e;const n=[...Gi(e=this.baseInfoMap).call(e)],r=n.length?n[0]:"UnableToGetSid",i=this.baseInfoMap.get(r);if(!i)return;const o=i.info,a=Date.now(),d=$t($t({},o),{},{eventType:nr.WS_COMPRESSOR_INIT,lts:a,eventElapse:t.eventElapse,elapse:a-i.startTime,status:t.status?1:2});this.send({type:cn.WS_COMPRESSOR_INIT,data:d},!0)}firstRemoteVideoDecode(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,a=Date.now(),d=$t($t($t({},o),r),{},{elapse:a-i.startTime,eventType:e,lts:a,firstDecodeFrame:Math.max((r.firstFrame||a)-i.startTime,0),apEnd:Math.max(r.apEnd-i.startTime,0),apStart:Math.max(r.apStart-i.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-i.startTime,0),joinGwStart:Math.max(r.joinGwStart-i.startTime,0),pcEnd:Math.max(r.pcEnd-i.startTime,0),pcStart:Math.max(r.pcStart-i.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-i.startTime,0),subscriberStart:Math.max(r.subscriberStart-i.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-i.startTime,0)});this.send({type:n,data:d},!0)}firstRemoteFrame(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,a=Date.now(),d=$t($t($t({},o),r),{},{elapse:a-i.startTime,eventType:e,lts:a});this.send({type:n,data:d},!0)}abTest(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:i-n.startTime,eventType:nr.AB_TEST,lts:i});this.send({type:cn.AB_TEST,data:o},!0)}pcStats(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:i-n.startTime,eventType:nr.PC_STATS,lts:i,preallocation:e.preallocation?1:0});this.send({type:cn.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:nr.UPDATE_REMOTE_RTPCAPABILITIES,lts:i});this.send({type:cn.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,a=Date.now(),d=$t($t($t({},o),r),{},{eventType:e,lts:a});this.send({type:n,data:d},!0)}streamSwitch(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{eventType:nr.STREAM_SWITCH,lts:i,isDual:e.isdual,elapse:i-n.startTime,success:e.succ});this.send({type:cn.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{eventType:nr.REQUEST_PROXY_APPCENTER,lts:i,eventElapse:i-e.lts,elapse:i-n.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:cn.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{eventType:nr.REQUEST_PROXY_WORKER_MANAGER,lts:i,eventElapse:i-e.lts,elapse:i-n.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:cn.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?v.debug("reportProxyServerurl: ".concat(t)):v.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t({},r),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:i,elapse:i-n.startTime,joinChannelSuccessElapse:i-(n.lastJoinSuccessTime||i),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:cn.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now();(function(o,a,d){const l=o[a];if(!l||typeof l!="string")return[o];o[a]="";const h=Ao(JSON.stringify(o));let f=0;const m=[];let T=0;for(let S=0;S<l.length;S++)T+=l.charCodeAt(S)<=127?1:3,T<=d-h||(m[m.length]=St(St({},o),{},{[a]:l.substring(f,S)}),f=S,T=l.charCodeAt(S)<=127?1:3);return f!==l.length-1&&(m[m.length]=St(St({},o),{},{[a]:l.substring(f)})),m})($t($t($t({},r),e),{},{elapse:i-n.startTime,lts:i,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:cn.WORKER_EVENT,data:o},!0))}apworkerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{elapse:i-n.startTime,lts:i});this.send({type:cn.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{elapse:i-n.startTime,lts:i,extend:e.extend||void 0});this.send({type:cn.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=$t($t($t({},r),e),{},{elapse:i-n.startTime,lts:i});this.send({type:cn.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>M("CUSTOM_REPORT_LIMIT"))throw new et(D.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const n=Date.now(),r=e.map(i=>({type:cn.USER_ANALYTICS,data:$t($t({sid:t},i),{},{lts:n})}));try{M("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(i){throw v.error("send custom report message failed",i.toString()),new et(D.CUSTOM_REPORT_SEND_FAILED,i.message)}}sendApiInvoke(t){const e=M("NOT_REPORT_EVENT");if(t.tag&&ft(e)&&ft(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const n=this.baseInfoMap.get(t.sid);if(!n)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:r,uid:i,cid:o}=n.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof et){const{code:l,message:h}=t.error;a=l||h||t.error.toString()}else a=t.error.toString();const d={invokeId:t.invokeId,sid:t.sid,cname:r,cid:o,uid:i,lts:t.lts,success:t.success,elapse:t.lts-n.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:cn.API_INVOKE,data:d},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){const t=this.apiInvokeUploadPendingItems;if(t.length===0)return;const e=Array.from(this.sids).find(n=>n!==null);e&&t.forEach(n=>{n&&(n.sid=e,this.sendApiInvoke(Object.assign({},n)))}),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>M("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const n=[],r=[];for(;t.length;){const o=t.shift();n.length<20?n.push(o):r.push(o)}t.push(...r);for(const o of[...n]){var i;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Jh(i=this.ltsList).call(i,(a,d)=>a-d))}return e||(this.lastSendNormalEventTime=Date.now()),M("ENABLE_EVENT_REPORT")&&n.length&&(M("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((o=>a=>{M("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>M("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-M("NORMAL_EVENT_QUEUE_CAPACITY")),v.warning("report: drop normal events"))))})(n)),t}async postDataToStatsCollector2(t){Fn.networkState===ki.OFFLINE&&await mt.race([Fn.onlineWaiter,hr(2*qn.maxRetryTimeout)]);const e=i=>{let o=new Uint8Array;return i.forEach(a=>{const d=Ly(JSON.stringify(a.data)),l=new ArrayBuffer(5),h=(m=>{let T=0;return Object.entries(cn).forEach(S=>{let[w,I]=S;I===m.type&&(T=BX[w])}),T})(a),f=new DataView(l);f.setUint16(0,d.byteLength,!0),f.setUint8(2,255&h),f.setUint8(3,h>>>8&255),f.setUint8(4,h>>>16&255),o=Uk(o,new Uint8Array(l)),o=Uk(o,d)}),o},n="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(M("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(M("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let i=0;i<2;i+=1){i===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(M("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(M("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await jy(r,{timeout:1e4,data:e(t),headers:$t($t({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(i===1)throw o;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=(d=>{const l=d&&d.data.sid&&this.baseInfoMap.get(d.data.sid);return l&&l.info.vid&&+l.info.vid||0})(t[0]),r=n?void 0:this._aid,i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(d=>JSON.stringify(d)),vid:n,aid:r};Fn.networkState===ki.OFFLINE&&await mt.race([Fn.onlineWaiter,hr(2*qn.maxRetryTimeout)]);const o=e?"/events/proto-raws":"/events/messages";let a=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(M("EVENT_REPORT_DOMAIN"),"&p=").concat(M("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(M("EVENT_REPORT_DOMAIN"),":").concat(M("STATS_COLLECTOR_PORT")).concat(o));for(let d=0;d<2;d+=1){d===1&&(a=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(M("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(M("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(M("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(M("STATS_COLLECTOR_PORT")).concat(o)));try{e?await CX(a,{timeout:1e4,data:i}):await jy(a,{timeout:1e4,data:i})}catch(l){if(d===1)throw l;continue}return}}createBaseInfo(t,e){const n=Object.assign({},FX);return n.sid=t,this.baseInfoMap.set(t,{info:n,startTime:e}),n}reportResourceTiming(t,e){const n=performance.getEntriesByName(t),r=n[n.length-1];r&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:r,tag:vn.TRACER}).onSuccess()}};lL.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Fn.networkState,bt.reportApiInvoke(null,{name:"logUploadError",options:t,tag:vn.TRACER}).onSuccess("logUploadError")});class z extends et{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Rn(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,v)}throw(){super.throw(v)}}const pr={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function Ie(){return pr}function pL(){return"setSinkId"in HTMLAudioElement.prototype&&(!M("RESTRICTION_SET_PLAYBACK_DEVICE")||(ga()||Ik())&&!Py())}function fL(){return!pr.supportUnifiedPlan||M("CHROME_FORCE_PLAN_B")&&Ta()}let fr=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function lu(t,e,n){return{sampleRate:t,stereo:e,bitrate:n}}function ye(t,e,n,r,i){return{width:t,height:e,frameRate:n,bitrateMin:r,bitrateMax:i}}function As(t,e,n,r,i){return{width:{max:t},height:{max:e},frameRate:n,bitrateMin:r,bitrateMax:i}}function Zy(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}const jX={"90p":ye(160,90),"90p_1":ye(160,90),"120p":ye(160,120,15,30,65),"120p_1":ye(160,120,15,30,65),"120p_3":ye(120,120,15,30,50),"120p_4":ye(212,120),"180p":ye(320,180,15,30,140),"180p_1":ye(320,180,15,30,140),"180p_3":ye(180,180,15,30,100),"180p_4":ye(240,180,15,30,120),"240p":ye(320,240,15,40,200),"240p_1":ye(320,240,15,40,200),"240p_3":ye(240,240,15,40,140),"240p_4":ye(424,240,15,40,220),"360p":ye(640,360,15,80,400),"360p_1":ye(640,360,15,80,400),"360p_3":ye(360,360,15,80,260),"360p_4":ye(640,360,30,80,600),"360p_6":ye(360,360,30,80,400),"360p_7":ye(480,360,15,80,320),"360p_8":ye(480,360,30,80,490),"360p_9":ye(640,360,15,80,800),"360p_10":ye(640,360,24,80,800),"360p_11":ye(640,360,24,80,1e3),"480p":ye(640,480,15,100,500),"480p_1":ye(640,480,15,100,500),"480p_2":ye(640,480,30,100,1e3),"480p_3":ye(480,480,15,100,400),"480p_4":ye(640,480,30,100,750),"480p_6":ye(480,480,30,100,600),"480p_8":ye(848,480,15,100,610),"480p_9":ye(848,480,30,100,930),"480p_10":ye(640,480,10,100,400),"720p":ye(1280,720,15,120,1130),"720p_auto":ye(1280,720,30,900,3e3),"720p_1":ye(1280,720,15,120,1130),"720p_2":ye(1280,720,30,120,2e3),"720p_3":ye(1280,720,30,120,1710),"720p_5":ye(960,720,15,120,910),"720p_6":ye(960,720,30,120,1380),"1080p":ye(1920,1080,15,120,2080),"1080p_1":ye(1920,1080,15,120,2080),"1080p_2":ye(1920,1080,30,120,3e3),"1080p_3":ye(1920,1080,30,120,3150),"1080p_5":ye(1920,1080,60,120,4780),"1440p":ye(2560,1440,30,120,4850),"1440p_1":ye(2560,1440,30,120,4850),"1440p_2":ye(2560,1440,60,120,7350),"4k":ye(3840,2160,30,120,8910),"4k_1":ye(3840,2160,30,120,8910),"4k_3":ye(3840,2160,60,120,13500)},GX={"480p":As(640,480,5),"480p_1":As(640,480,5),"480p_2":As(640,480,30),"480p_3":As(640,480,15),"720p":As(1280,720,5),"720p_auto":ye(1280,720,30,900,3e3),"720p_1":As(1280,720,5),"720p_2":As(1280,720,30),"720p_3":As(1280,720,15),"1080p":As(1920,1080,5),"1080p_1":As(1920,1080,5),"1080p_2":As(1920,1080,30),"1080p_3":As(1920,1080,15)},WX={"1SL1TL":Zy(1,1),"3SL3TL":Zy(3,3),"2SL3TL":Zy(2,3)};function bo(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},jX[t]):t}function tR(t){return typeof t=="string"?Object.assign({},GX[t]):t}function Xm(t){return typeof t=="string"?Object.assign({},WX[t]):t}const HX={speech_low_quality:lu(16e3,!1),speech_standard:lu(32e3,!1,18),music_standard:lu(48e3,!1),standard_stereo:lu(48e3,!0,56),high_quality:lu(48e3,!1,128),high_quality_stereo:lu(48e3,!0,192)};function Qm(t){return typeof t=="string"?Object.assign({},HX[t]):t}const uu=[];function _L(t){return tr(t,"mediaSource",["screen","window","application"]),!0}let Rt=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),Je=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),hu=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),KX=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),qX=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),Sd=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),pu=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),fu=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),_u=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),Wi=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});const eR={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},nR={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},mL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},YX={uplinkNetworkQuality:0,downlinkNetworkQuality:0},EL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Zr=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),Hi=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Ep=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),vd=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),jr=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),Oo=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({});const rR={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let $m=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function gL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function dn(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?gL(Object(n),!0).forEach(function(r){Y(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):gL(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Y(t,e,n){return(e=function(r){var i=function(o,a){if(typeof o!="object"||o===null)return o;var d=o[Symbol.toPrimitive];if(d!==void 0){var l=d.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:String(i)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Re(t,e,n,r,i){var o,a,d={};return Object.keys(r).forEach(function(l){d[l]=r[l]}),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=Ws(o=ab(a=n.slice()).call(a)).call(o,function(l,h){return h(t,e,l)||l},d),i&&d.initializer!==void 0&&(d.value=d.initializer?d.initializer.call(i):void 0,d.initializer=void 0),d.initializer===void 0&&(Object.defineProperty(t,e,d),d=null),d}class TL extends _n{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(Sd.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),Y(this,"trackMediaType",void 0),Y(this,"_ID",void 0),Y(this,"_rtpTransceiver",void 0),Y(this,"_lowRtpTransceiver",void 0),Y(this,"_hints",[]),Y(this,"_isClosed",!1),Y(this,"_originMediaStreamTrack",void 0),Y(this,"mediaStreamTrack",void 0),Y(this,"_external",{}),this._ID=n||ze(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(r){ft(uu).call(uu,r)||uu.push(r)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||uc(()=>{var n;bt.reportApiInvoke(null,{name:Kn.GET_MEDIA_STREAM_TRACK,options:[],tag:vn.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===hu.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const n=uu.indexOf(e);n!==-1&&uu.splice(n,1)}(this),this.emit(pu.CLOSED),this.removeAllListeners(Sd.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===hu.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(Sd.TRANSCEIVER_UPDATED,e,n)}}class mu extends TL{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),Y(this,"_enabled",!0),Y(this,"_muted",!1),Y(this,"_isExternalTrack",!1),Y(this,"_isClosed",!1),Y(this,"_enabledMutex",void 0),Y(this,"processor",void 0),Y(this,"_processorContext",void 0),Y(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Or("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return(e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,v.debug("[".concat(this.getTrackId(),"] close")),this.emit(Rt.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=r,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ye(this,Rt.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){v.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pu.TRACK_ENDED)}stateCheck(e,n){if(v.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),Sa(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new et(D.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",v);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new et(D.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",v)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():mt.resolve([])}}const SL=window.AudioContext||window.webkitAudioContext;let Ki=null;const Be=new class extends _n{constructor(){super(...arguments),Y(this,"prevState",void 0),Y(this,"curState",void 0),Y(this,"currentTime",void 0),Y(this,"currentTimeStuckAt",void 0),Y(this,"interruptDetectorTrack",void 0),Y(this,"onLocalAudioTrackMute",()=>{v.info("ios15-interruption-start"),this.emit(fr.IOS_15_16_INTERRUPTION_START)}),Y(this,"onLocalAudioTrackUnmute",async()=>{v.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?v.info("ios15-interruption-end-canceled"):(Ki&&await Ki.suspend(),this.emit(fr.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){v.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){v.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Eu(){if(!Ki){if(function(){if(!SL)return void v.error("your browser is not support web audio");v.info("create audio context");const t=dn({},M("WEBAUDIO_INIT_OPTIONS"));v.debug("audio context init option:",JSON.stringify(t)),Ki=new SL(t),Be.curState=Ki.state,Ki.onstatechange=()=>{Be.prevState=Be.curState,Be.curState=Ki?Ki.state:void 0;const{prevState:e,curState:n}=Be,r=n==="running",i=n==="interrupted",o=e==="running",a=e==="suspended",d=e==="interrupted",l=ve().osVersion;($r()||Is())&&o&&i&&(v.info("ios".concat(l,"-interruption-start")),Be.emit(fr.IOS_INTERRUPTION_START)),($r()||Is())&&(a||d)&&r&&(v.info("ios".concat(l,"-interruption-end")),Be.emit(fr.IOS_INTERRUPTION_END)),e!==n&&Be.emit(fr.STATE_CHANGE,n,e)},setInterval(()=>{var e;const n=(e=Ki)===null||e===void 0?void 0:e.currentTime;Be.currentTime!==n?(Be.currentTimeStuckAt&&(v.debug("AudioContext current time resume at ".concat(n)),Be.currentTimeStuckAt=void 0),Be.currentTime=n):(n!==Be.currentTimeStuckAt&&(bt.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:vn.TRACER}).onSuccess(),v.warning("AudioContext current time stuck at ".concat(n))),Be.currentTimeStuckAt=n)},5e3),async function(e){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let r,i=!1,o=!1,a=!1;function d(I){e.state==="running"?l(!1):$r()||Is()?e.state==="suspended"&&(l(!0),I&&e.resume().then(h,h)):e.state!=="closed"&&(l(!0),I&&e.resume().then(h,h))}function l(I){if(i!==I){i=I;for(let C=0,N=n;C<N.length;C+=1){const P=N[C];I?window.addEventListener(P,f,{capture:!0,passive:!0}):window.removeEventListener(P,f,{capture:!0,passive:!0})}}}function h(){d(!1)}function f(){d(!0)}function m(I){if(!a)if(r.paused)if(I){let C;T(!1),a=!0;try{C=r.play(),C?C.then(S,S):(r.addEventListener("playing",S),r.addEventListener("abort",S),r.addEventListener("error",S))}catch{S()}}else T(!0);else T(!1)}function T(I){if(o!==I){o=I;for(let C=0,N=n;C<N.length;C++){const P=N[C];I?window.addEventListener(P,w,{capture:!0,passive:!0}):window.removeEventListener(P,w,{capture:!0,passive:!0})}}}function S(){r.removeEventListener("playing",S),r.removeEventListener("abort",S),r.removeEventListener("error",S),a=!1,m(!1)}function w(){m(!0)}if($r()){const I=e.createMediaStreamDestination(),C=document.createElement("div");C.innerHTML="<audio x-webkit-airplay='deny'></audio>",r=C.children.item(0),r.controls=!1,r.disableRemotePlayback=!0,r.preload="auto",r.srcObject=I.stream,m(!0)}Be.on(fr.STATE_CHANGE,function(){d(!0)}),d(!1)}(Ki)}(),!Ki)throw new et(D.NOT_SUPPORTED,"can not create audio context");return Ki}return Ki}function yd(t){if(function(){if(iR!==null)return iR;const r=Eu(),i=r.createBufferSource(),o=r.createGain(),a=r.createGain();i.connect(o),i.connect(a),i.disconnect(o);let d=!1;try{i.disconnect(o)}catch{d=!0}return i.disconnect(),iR=d,d}())return;const e=t.connect,n=t.disconnect;t.connect=(r,i,o)=>{var a;return t._inputNodes||(t._inputNodes=[]),ft(a=t._inputNodes).call(a,r)||(r instanceof AudioNode?(t._inputNodes.push(r),e.call(t,r,i,o)):e.call(t,r,i)),t},t.disconnect=(r,i,o)=>{n.call(t),r?jm(t._inputNodes,r):t._inputNodes=[];for(const a of t._inputNodes)e.call(t,a)}}let iR=null;function sR(t,e){let n=!1;const r=1/e;if(M("DISABLE_WEBAUDIO")){const i=window.setInterval(()=>{n?window.clearInterval(i):t(performance.now()/1e3)},1e3*r)}else{const i=Eu();let o=i.createGain();o.gain.value=0,o.connect(i.destination);const a=()=>{if(n)return void(o=null);const d=i.createOscillator();d.onended=a,d.connect(o),d.start(0),d.stop(i.currentTime+r),t(i.currentTime)};a()}return()=>{n=!0}}class vL{constructor(){Y(this,"context",void 0),Y(this,"analyserNode",void 0),Y(this,"sourceNode",void 0),this.context=Eu(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||$r()||Is()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let i=0;i<e.length;++i)e[i]=r[i]/128-1}const n=Ws(e).call(e,(r,i)=>r+i*i,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{v.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class yL extends _n{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var r;(r=this.sourceNode)===null||r===void 0||r.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),Y(this,"outputNode",void 0),Y(this,"outputTrack",void 0),Y(this,"isPlayed",!1),Y(this,"sourceNode",void 0),Y(this,"context",void 0),Y(this,"audioBufferNode",void 0),Y(this,"destNode",void 0),Y(this,"audioOutputLevel",0),Y(this,"volumeLevelAnalyser",void 0),Y(this,"_processedNode",void 0),Y(this,"playNode",void 0),Y(this,"isDestroyed",!1),Y(this,"onNoAudioInput",void 0),Y(this,"isNoAudioInput",!1),Y(this,"_noAudioInputCount",0),this.context=Eu(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),yd(this.outputNode),this.volumeLevelAnalyser=new vL}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(Wi.ON_AUDIO_BUFFER,function(r){for(let i=0;i<r.outputBuffer.numberOfChannels;i+=1){const o=r.outputBuffer.getChannelData(i);for(let a=0;a<o.length;a+=1)o[a]=0}return r.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Ie().webAudioMediaStreamDest)throw new et(D.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Gm(()=>{Be.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;$r()||Is()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let r;n.getFloatTimeDomainData?(r=new Float32Array(n.fftSize),n.getFloatTimeDomainData(r)):(r=new Uint8Array(n.fftSize),n.getByteTimeDomainData(r));let i=!1;for(let o=0;o<r.length;o++)r[o]!==0&&(i=!0);return i?(this.isNoAudioInput=!1,!0):(await hr(200),await this.checkHasAudioInput(e?e+1:1)&&i)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class RL extends yL{get isFreeze(){return!1}constructor(e,n,r){var i;if(super(),Y(this,"sourceNode",void 0),Y(this,"track",void 0),Y(this,"clonedTrack",void 0),Y(this,"audioElement",void 0),Y(this,"isCurrentTrackCloned",!1),Y(this,"isRemoteTrack",!1),Y(this,"originVolumeLevelAnalyser",void 0),Y(this,"rebuildWebAudio",async()=>{if(v.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void v.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>v.info("resume success")),v.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const d=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?d.stop():this.isCurrentTrackCloned=!0;const l=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(l),yd(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const h=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(h,this.context.currentTime),yd(this.outputNode),this.emit(Wi.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=l,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new et(D.UNEXPECTED_ERROR);this.track=e;const o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),yd(this.sourceNode),r){const d=r.clone();d.enabled=!0,this.clonedTrack=d,v.debug("create an unmuted track ".concat(d.id," from the original track ").concat(r.id," to get the volume"));const l=this.context.createMediaStreamSource(new MediaStream([d]));yd(l),this.originVolumeLevelAnalyser=new vL,this.originVolumeLevelAnalyser.updateSource(l)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;const a=ve();n&&a.os===er.IOS&&Number((i=a.osVersion)===null||i===void 0?void 0:i.split(".")[0])<15&&(Be.on(fr.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(d=>{d||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),yd(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Wi.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Be.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),v.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));const r=this.context.createMediaStreamSource(new MediaStream([n]));yd(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function IL(t,e,n){const r=(o,a)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||a:o:a,i={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:r(e.height,1080),maxWidth:r(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(i.video.mandatory.maxFrameRate=e.frameRate.max,i.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(i.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(i)}async function zX(t,e){const n=await CL(t.mediaSource),{sourceId:r,audio:i}=await function(o){let a=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new mt((d,l)=>{const h=document.createElement("div");h.innerText="share screen",h.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const f=document.createElement("div");f.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const m=document.createElement("div");m.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",m.setAttribute("style","height: 12%;");const T=document.createElement("div");T.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const S=document.createElement("div");S.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const w=document.createElement("button");w.innerHTML="cancel",w.setAttribute("style","width: 85px;"),w.onclick=()=>{document.body.removeChild(N);const P=new Error("NotAllowedError");P.name="NotAllowedError",l(P)};let I=a;const C=document.createElement("div");if(a){const P=document.createElement("input");P.setAttribute("type","checkbox");const x=document.createElement("span");P.setAttribute("style","margin-right: 6px;"),x.innerText="Share audio",P.checked=I,P.onchange=()=>{I=P.checked},C.appendChild(P),C.appendChild(x)}S.appendChild(C),S.appendChild(w),f.appendChild(m),f.appendChild(T),f.appendChild(S);const N=document.createElement("div");N.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),N.appendChild(h),N.appendChild(f),document.body.appendChild(N),o.map(P=>{if(P.id){const x=document.createElement("div");x.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let W=P.thumbnail;try{const{width:H}=W.getSize();H>1920&&(W=W.resize({width:1920}))}catch(H){throw H&&H.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),H}x.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+W.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+P.name.replace(/[\u00A0-\u9999<>\&]/g,function(H){return"&#"+H.charCodeAt(0)+";"})+"</span>",x.onclick=()=>{document.body.removeChild(N),d({sourceId:P.id,audio:I})},T.appendChild(x)}})})}(n,e);return await IL(r,t,i)}async function CL(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);const n=xk();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new et(D.ELECTRON_IS_NULL);let r=null;try{var i;r=((i=n.desktopCapturer)===null||i===void 0?void 0:i.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{r=null}r&&r.then||(r=new mt((o,a)=>{n.desktopCapturer.getSources({types:e},(d,l)=>{d?a(d):o(l)})}));try{return await r}catch(o){throw new et(D.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}const oR=new Or("safari");let AL=!1,wL=!1;async function qi(t,e){let n=0,r=null;for(;n<2;)try{r=await JX(t,e,n>0);break}catch(i){if(i instanceof et)throw v.error("[".concat(e,"] ").concat(i.toString())),i;const o=Zm(i.name||i.code||i,i.message);if(o.code===D.MEDIA_OPTION_INVALID){v.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await hr(500);continue}throw v.error("[".concat(e,"] ").concat(o.toString())),o}if(!r)throw new et(D.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}async function JX(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new et(D.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const r=Ie(),i=new MediaStream;if(t.audioSource&&i.addTrack(t.audioSource),t.videoSource&&i.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return v.debug("Using Video Source/ Audio Source"),i;if(t.screen)if(xk())t.screen.sourceId?gu(i,await IL(t.screen.sourceId,t.screen,!!t.screenAudio)):gu(i,await zX(t.screen,!!t.screenAudio));else if(ga()&&t.screen.extensionId&&t.screen.mandatory){if(!r.getStreamFromExtension)throw new et(D.NOT_SUPPORTED,"This browser does not support screen sharing");v.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const T=await(a=t.screen.extensionId,d=e,new mt((S,w)=>{try{chrome.runtime.sendMessage(a,{getStream:!0},I=>{if(!I||!I.streamId)return v.error("[".concat(d,"] No response from Chrome Plugin. Plugin not installed properly"),I),void w(new et(D.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));S(I.streamId)})}catch(I){v.error("[".concat(d,"] AgoraRTC screensharing plugin is not accessible(").concat(a,")"),I.toString()),w(new et(D.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=T,gu(i,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(r.getDisplayMedia){var o;t.screen.mediaSource&&_L(t.screen.mediaSource);const T={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:S,surfaceSwitching:w,systemAudio:I,preferCurrentTab:C}=t.screen,N={selfBrowserSurface:S,surfaceSwitching:w,systemAudio:I,preferCurrentTab:C};!S&&delete N.selfBrowserSurface,!w&&delete N.surfaceSwitching,!I&&delete N.systemAudio,!C&&delete N.preferCurrentTab,v.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:T,audio:t.screenAudio,controls:N})),gu(i,await navigator.mediaDevices.getDisplayMedia(dn({video:T,audio:t.screenAudio},N)))}else{if(!Tn())throw v.error("[".concat(e,"] This browser does not support screenSharing")),new et(D.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&_L(t.screen.mediaSource);const T={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};v.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(T))),gu(i,await navigator.mediaDevices.getUserMedia(T))}}var a,d;if(!t.video&&!t.audio)return i;let l={video:t.video,audio:t.audio},h=M("MEDIA_DEVICE_CONSTRAINTS");if(h)try{typeof h=="string"&&(h=JSON.parse(h)),l=xy(l,h)}catch{}v.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(l)),ve();let f,m=null;(Sr()||$r()||Fm())&&(m=await oR.lock());try{f=await navigator.mediaDevices.getUserMedia(l)}catch(T){throw m&&m(),T}return l.audio&&(AL=!0),l.video&&(wL=!0),gu(i,f),m&&m(),i}function Zm(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new et(D.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new et(D.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new et(D.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new et(D.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new et(D.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new et(D.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return v.error("getUserMedia unexpected error",t),new et(D.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function gu(t,e){const n=t.getVideoTracks()[0],r=t.getAudioTracks()[0],i=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(r&&t.removeTrack(r),t.addTrack(o)),i&&(n&&t.removeTrack(n),t.addTrack(i))}const Yi=new class extends _n{get state(){return this._state}set state(t){t!==this._state&&(this.emit(vd.STATE_CHANGE,t),this._state=t)}constructor(){super(),Y(this,"_state",Ep.IDLE),Y(this,"isAccessMicrophonePermission",!1),Y(this,"isAccessCameraPermission",!1),Y(this,"lastAccessMicrophonePermission",!1),Y(this,"lastAccessCameraPermission",!1),Y(this,"checkdeviceMatched",!1),Y(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(M("ENUMERATE_DEVICES_INTERVAL")||(Bm()||Vm()===er.HARMONY_OS)&&Ta())&&this.updateDevicesInfo()},M("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>v.error(t.toString()))}async enumerateDevices(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new et(D.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const r=await navigator.mediaDevices.enumerateDevices(),i=this.checkMediaDeviceInfoIsOk(r);let o=!this.isAccessMicrophonePermission&&t,a=!this.isAccessCameraPermission&&e;i.audio&&(o=!1),i.video&&(a=!1);let d=null,l=null,h=null;if(!n&&(o||a)){if(oR.isLocked&&(v.debug("[device manager] wait GUM lock"),(await oR.lock())(),v.debug("[device manager] GUM unlock")),AL&&(o=!1,this.isAccessMicrophonePermission=!0),wL&&(a=!1,this.isAccessCameraPermission=!0),v.debug("[device manager] check media device permissions",t,e,o,a),o&&a){try{h=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(f){const m=Zm(f.name||f.code||f,f.message);if(m.code===D.PERMISSION_DENIED)throw m;v.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{d=await navigator.mediaDevices.getUserMedia({audio:t})}catch(f){const m=Zm(f.name||f.code||f,f.message);if(m.code===D.PERMISSION_DENIED)throw m;v.warning("getUserMedia failed in getDevices",m)}this.isAccessMicrophonePermission=!0}else if(a){try{l=await navigator.mediaDevices.getUserMedia({video:e})}catch(f){const m=Zm(f.name||f.code||f,f.message);if(m.code===D.PERMISSION_DENIED)throw m;v.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0}v.debug("[device manager] mic permission",t,"cam permission",e)}try{const f=await navigator.mediaDevices.enumerateDevices();return d&&d.getTracks().forEach(m=>m.stop()),l&&l.getTracks().forEach(m=>m.stop()),h&&h.getTracks().forEach(m=>m.stop()),d=null,l=null,h=null,f}catch(f){return d&&d.getTracks().forEach(m=>m.stop()),l&&l.getTracks().forEach(m=>m.stop()),h&&h.getTracks().forEach(m=>m.stop()),d=null,l=null,h=null,new et(D.ENUMERATE_DEVICES_FAILED,f.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===t&&(e=n.device.deviceId)}),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===t);if(!e)throw new et(D.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Ep.INITING;try{await this.updateDevicesInfo(),this.state=Ep.INITEND}catch(t){throw v.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Ep.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new et(D.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const i=t.find(a=>a.kind==="audioinput"&&a.deviceId==="default"),o=t.find(a=>a.kind==="audiooutput"&&a.deviceId==="default");i&&o?o.groupId===i.groupId?v.debug("[device-check] default input ".concat(i.label," and output ").concat(o.label," is the same group")):v.debug("[device-check] default input ".concat(i.label," and output ").concat(o.label," is not the same group")):v.debug("[device-check] default input or output not found")}const r=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(i=>{if(!i.deviceId)return;const o=this.deviceInfoMap.get("".concat(i.kind,"_").concat(i.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){const a={initAt:e,updateAt:e,device:i,state:"ACTIVE"};this.deviceInfoMap.set("".concat(i.kind,"_").concat(i.deviceId),a),n.push(a)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((i,o)=>{i.state==="ACTIVE"&&i.updateAt!==e&&(i.state="INACTIVE",n.push(i))}),this.state!==Ep.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(i=>{switch(i.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(vd.RECORDING_DEVICE_CHANGED,i);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(vd.CAMERA_DEVICE_CHANGED,i);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(vd.PLAYOUT_DEVICE_CHANGED,i)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter(i=>i.kind==="audioinput"),n=t.filter(i=>i.kind==="videoinput"),r={audio:!1,video:!1};for(const i of e)if(i.label&&i.deviceId){r.audio=!0;break}for(const i of n)if(i.label&&i.deviceId){r.video=!0;break}return r}};let aR=!1;const zi=new class extends _n{constructor(){super(...arguments),Y(this,"onAutoplayFailed",void 0),Y(this,"onAudioAutoplayFailed",void 0)}};function bL(){if(ve(),!aR){const t=e=>{e.preventDefault(),aR=!1,cp()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};aR=!0,cp()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),v.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),zi.onAutoplayFailed?zi.onAutoplayFailed():zi.onAudioAutoplayFailed?v.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):v.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),zi.emit("autoplay-failed")}}function OL(t,e,n,r){if(!t)return;const i=bt.getBaseInfoBySessionId(t);if(!i)return;const o=i.info,a=Date.now(),d=dn(dn({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:a,elapse:a-i.startTime,cbRegistered:zi.onAutoplayFailed||zi.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:r,extend:void 0});bt.send({type:cn.AUTOPLAY_FAILED,data:d},!0)}const XX=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ci=new class{constructor(){Y(this,"onAutoplayFailed",void 0),Y(this,"elementMap",new Map),Y(this,"elementStateMap",new Map),Y(this,"elementsNeedToResume",[]),Y(this,"sinkIdMap",new Map),Y(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[n,r]=e;const i=this.elementStateMap.get(n),o=r.srcObject.getAudioTracks()[0],a=o&&o.readyState;if(v.debug("resume after interrupted, ele: ".concat(i," audio: ").concat(a," ").concat(t)),a==="live"){if(t)return r.pause(),void r.play();if(Be.curState==="running")return iu()?(r.pause(),void r.play()):void(i&&i==="paused"&&r.play())}})}),Y(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t;const r=n.srcObject.getAudioTracks()[0];r&&r.readyState==="live"&&(v.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),Be.on(fr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Be.on(fr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Be.on(fr.STATE_CHANGE,()=>{$r()&&Be.prevState==="suspended"&&Be.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,e){const n=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),n)try{await n.setSinkId(e)}catch(r){throw new et(D.PERMISSION_DENIED,"can not set sink id: "+r.toString())}}play(t,e,n,r){if(this.elementMap.has(e))return;const i=document.createElement("audio");i.autoplay=!0,i.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,i),this.elementMap.set(e,i),this.elementStateMap.set(e,jr.INIT),this.setVolume(e,n);const o=this.sinkIdMap.get(e);if(o)try{i.setSinkId(o).catch(d=>{v.warning("[".concat(e,"] set sink id failed"),d.toString())})}catch(d){v.warning("[".concat(e,"] set sink id failed"),d.toString())}const a=i.play();a&&a.then&&a.catch(d=>{r&&OL(r,"audio",d.message,e),v.warning("audio element play warning",d.toString()),this.elementMap.has(e)&&d.name==="NotAllowedError"&&(v.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(i),Gm(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),bL()}))})}updateTrack(t,e){const n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){const n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){XX.forEach(n=>{e.addEventListener(n,r=>{const i=this.elementStateMap.get(t),o=r.type==="pause"?"paused":r.type;if(v.debug("[".concat(t,"] audio-element-status change ").concat(i," => ").concat(o)),r.type==="error"){const a=e==null?void 0:e.error;a&&v.error("[".concat(t,"] media error, code: ").concat(a.code,", message: ").concat(a.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{v.debug("Auto resume audio element success")}).catch(n=>{v.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new mt(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{cp()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function kn(){return function(t,e,n){const r=n.value;return typeof r=="function"&&(n.value=function(){this._isClosed&&new et(D.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",v);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];const d=r.apply(this,o);return d instanceof mt?new mt((l,h)=>{d.then(l).catch(h)}):d}),n}}class NL extends _n{constructor(e){super(),Y(this,"name","VideoProcessorDestination"),Y(this,"ID","0"),Y(this,"_source",void 0),Y(this,"videoContext",void 0),Y(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new et(D.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new et(D.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Zr.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Zr.ON_TRACK,void 0)}}class PL extends _n{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),Y(this,"constraintsMap",new Map),Y(this,"statsRegistry",[]),Y(this,"usageRegistry",[]),Y(this,"trackId",void 0),Y(this,"direction",void 0),Y(this,"_chained",!1),this.trackId=e,this.direction=n}async getConstraints(){return await yr(this,Hi.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var r;return v.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Ye(this,Hi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vi(r=this.constraintsMap).call(r)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return v.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Ye(this,Hi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vi(n=this.constraintsMap).call(n)))}registerStats(e,n,r){this.statsRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:r})}unregisterStats(e,n){const r=this.statsRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const a=o();e.push({processorID:n,processorName:r,type:i,stats:a})}catch(a){v.error(new et(D.UNEXPECTED_ERROR,a.message))}return e}registerUsage(e,n){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let r=n();r instanceof mt&&(r=await r),e.push(dn(dn({},r),{},{direction:this.direction}))}catch(r){v.error("gather extension usage error",r)}return e}getDirection(){return this.direction}}class DL extends _n{constructor(e){super(),Y(this,"name","AudioProcessorDestination"),Y(this,"ID","0"),Y(this,"inputTrack",void 0),Y(this,"inputNode",void 0),Y(this,"audioProcessorContext",void 0),Y(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new et(D.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new et(D.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Zr.ON_TRACK,void 0),this.emit(Zr.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Zr.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Zr.ON_NODE,this.inputNode))}}class kL extends _n{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,r){super(),Y(this,"constraintsMap",new Map),Y(this,"statsRegistry",[]),Y(this,"audioContext",void 0),Y(this,"trackId",void 0),Y(this,"direction",void 0),Y(this,"usageRegistry",[]),Y(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=r}async getConstraints(){return yr(this,Hi.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var r;return v.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Ye(this,Hi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vi(r=this.constraintsMap).call(r)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Ye(this,Hi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Vi(n=this.constraintsMap).call(n)))}registerStats(e,n,r){this.statsRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:r})}unregisterStats(e,n){const r=this.statsRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const a=o();e.push({processorID:n,processorName:r,type:i,stats:a})}catch(a){v.error(new et(D.UNEXPECTED_ERROR,a.message))}return e}registerUsage(e,n){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let r=n();r instanceof mt&&(r=await r),e.push(dn(dn({},r),{},{direction:this.direction}))}catch(r){v.error("gather extension usage error",r)}return e}getDirection(){return this.direction}}class cR extends _n{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),Y(this,"context",void 0),Y(this,"processSourceNode",void 0),Y(this,"outputTrack",void 0),Y(this,"processedNode",void 0),Y(this,"clonedTrack",void 0),Y(this,"outputNode",void 0),this.outputNode=new QX}setVolume(){}createOutputTrack(){throw new et(D.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class QX{disconnect(){}connect(){}}function LL(t){return new mt((e,n)=>{let r=!1;const i=document.createElement("video");i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.muted=!0,i.autoplay=!0,i.setAttribute("playsinline",""),i.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(i);const o=$r()?"canplay":"playing";i.addEventListener(o,()=>{const a=i.videoWidth,d=i.videoHeight;!a&&Tn()||(r=!0,i.srcObject=null,i.remove(),e([a,d]))}),i.srcObject=new MediaStream([t]),i.play().catch(Wm),setTimeout(()=>{r||(i.srcObject=null,i.remove(),e([i.videoWidth,i.videoHeight]))},4e3)})}function tE(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const n=bo(t.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!Dk()&&n.frameRate&&(e.frameRate=n.frameRate),Ik()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),Tn()&&(e.frameRate={ideal:30,max:30}),e}function ML(t){const e={};return Dk()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,ga()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function UL(t){const e=ML(t);if(t.encoderConfig){const n=Qm(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),Bm()&&(e.sampleRate=void 0),e}const $X=t=>{const e=t._encoderConfig;if(!e)return;const{frameRate:n,width:r,height:i}=t.getMediaStreamTrackSettings();let{frameRate:o=n,width:a=r,height:d=i}=e;if(!o||!a||!d)return;a=Vy(a),d=Vy(d),o=Vy(o);const{max:l,min:h}=function(S,w,I){const C=200*Math.pow(I/15,.6)*Math.pow(S*w/640/360,.75);return{min:Math.floor(C),max:Math.floor(4*C)}}(a,d,o),{bitrateMax:f,bitrateMin:m}=e||{};f||v.debug("calculate bitrate: [w: ".concat(a,", h: ").concat(d,", fps: ").concat(o,"] => [brMax: ").concat(f,", brMin: ").concat(m,"]"));const{maxFramerate:T}=M("ENCODER_CONFIG_LIMIT");return T&&typeof T=="number"&&(o=Math.min(o,T)),{frameRate:o,bitrateMax:f||l,bitrateMin:m||h,scaleResolutionDownBy:1,scale:0}},xL=async(t,e,n)=>await(async(r,i,o)=>{const a=function(h){const f=[];for(let m=0;m<h.length;m+=2)f.push(parseInt(h.slice(m,m+2),16));return Uint8Array.from(f)}(zk(""+i+o)).slice(0,16),d=a.slice(0,12),l=await window.crypto.subtle.importKey("raw",a,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:d},l,r))})(t.buffer,e,n),dR=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new mt((n,r)=>{e.toBlob(async i=>{if(e.remove(),i){const o=await VL(i);n({buffer:o,width:e.width,height:e.height})}else r(new et(D.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},VL=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};var FL,BL,jL,GL,WL,HL,KL,qL,YL,zL,JL,XL,QL,$L,ZL,tM,eM,nM,mn,rM,iM,sM,oM,aM,cM,No,dM,lM,uM,hM,pM,fM,_M,mM,EM,gM,TM,SM,vM,Ir;let In=(FL=xt({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),BL=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),jL=kn(),GL=au("LocalAudioTrack","_enabledMutex"),WL=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),HL=kn(),KL=au("LocalAudioTrack","_enabledMutex"),qL=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),YL=kn(),zL=kn(),JL=kn(),XL=xt({argsMap:t=>[t.getTrackId()]}),QL=kn(),$L=xt({argsMap:t=>[t.getTrackId()]}),ZL=kn(),tM=xt({argsMap:t=>[t.getTrackId()]}),eM=xt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),nM=xt({argsMap:t=>[t.getTrackId()]}),Re((mn=class extends mu{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?ci.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,r){super(t,n),Y(this,"trackMediaType",_u.AUDIO),Y(this,"_encoderConfig",void 0),Y(this,"_trackSource",void 0),Y(this,"metadata",[]),Y(this,"_enabled",!0),Y(this,"_volume",100),Y(this,"_useAudioElement",!0),Y(this,"_bypassWebAudio",!1),Y(this,"processor",void 0),Y(this,"_processorContext",void 0),Y(this,"_processorDestination",void 0),Y(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!r,this._trackSource=new cR,M("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),M("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Sr()&&!Ki?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){Ge(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&ci.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void v.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Ye(this,Rt.NEED_REPLACE_TRACK,this).then(()=>{v.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{v.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!pL())throw new et(D.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ci.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(v.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Ye(this,Rt.NEED_ENABLE_TRACK,this),v.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(r){throw n||(this._enabled=!1),v.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Ye(this,Rt.NEED_DISABLE_TRACK,this)}catch(r){throw n||(this._enabled=!0),v.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,v.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Ye(this,Rt.NEED_MUTE_TRACK,this):await Ye(this,Rt.NEED_UNMUTE_TRACK,this))}getStats(){return uc(()=>{v.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Bi(this,Rt.GET_STATS)||dn({},eR)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),this._source.on(Wi.ON_AUDIO_BUFFER,n=>t(n))}play(){v.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(v.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ci.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){v.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ci.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];v.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ci.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ye(this,Rt.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return mt.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new et(D.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new et(D.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(Zr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Ye(this,Rt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ye(this,Rt.NEED_REPLACE_TRACK,this))}),t.on(Zr.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(t){t.removeAllListeners(Zr.ON_TRACK),t.removeAllListeners(Zr.ON_NODE)}bindProcessorContextEvents(t){t.on(Hi.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(t){t.removeAllListeners(Hi.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof cR&&(this._trackSource=new RL(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new kL(this._source.context,this.getTrackId(),"local"),e=new DL(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(Wi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(ci.stop(this.getTrackId()),this._source.play()),Ye(this,Rt.NEED_REPLACE_MIXING_TRACK,this).then(()=>{v.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{v.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[FL],Object.getOwnPropertyDescriptor(mn.prototype,"setVolume"),mn.prototype),Re(mn.prototype,"setPlaybackDevice",[BL,jL],Object.getOwnPropertyDescriptor(mn.prototype,"setPlaybackDevice"),mn.prototype),Re(mn.prototype,"setEnabled",[GL,WL,HL],Object.getOwnPropertyDescriptor(mn.prototype,"setEnabled"),mn.prototype),Re(mn.prototype,"setMuted",[KL,qL,YL],Object.getOwnPropertyDescriptor(mn.prototype,"setMuted"),mn.prototype),Re(mn.prototype,"getStats",[zL],Object.getOwnPropertyDescriptor(mn.prototype,"getStats"),mn.prototype),Re(mn.prototype,"setAudioFrameCallback",[JL],Object.getOwnPropertyDescriptor(mn.prototype,"setAudioFrameCallback"),mn.prototype),Re(mn.prototype,"play",[XL,QL],Object.getOwnPropertyDescriptor(mn.prototype,"play"),mn.prototype),Re(mn.prototype,"stop",[$L,ZL],Object.getOwnPropertyDescriptor(mn.prototype,"stop"),mn.prototype),Re(mn.prototype,"close",[tM],Object.getOwnPropertyDescriptor(mn.prototype,"close"),mn.prototype),Re(mn.prototype,"pipe",[eM],Object.getOwnPropertyDescriptor(mn.prototype,"pipe"),mn.prototype),Re(mn.prototype,"unpipe",[nM],Object.getOwnPropertyDescriptor(mn.prototype,"unpipe"),mn.prototype),mn),eE=(rM=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),iM=kn(),sM=au("MicrophoneAudioTrack","_enabledMutex"),oM=xt({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),aM=kn(),cM=xt({argsMap:t=>[t.getTrackId()]}),Re((No=class extends In{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,r){super(t,e.encoderConfig?Qm(e.encoderConfig):{},r,M("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),Y(this,"_config",void 0),Y(this,"_deviceName","default"),Y(this,"_constraints",void 0),Y(this,"_originalConstraints",void 0),Y(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(iu()||Ny())&&Be.bindInterruptDetectorTrack(this)}async setDevice(t){if(v.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await Yi.getDeviceById(t),n={};n.audio=dn({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let r=null;try{r=await qi(n,this.getTrackId())}catch(i){throw v.error("[".concat(this.getTrackId(),"] setDevice failed"),i.toString()),r=await qi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),i}await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw v.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await Yi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw v.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}v.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,n){if(e)return v.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(v.info("[".concat(this.getTrackId(),"] start setEnabled"),t),M("AUTO_RESET_AUDIO_ROUTE")&&($r()||Is())){const a=navigator.audioSession;a&&(t||(a.type="playback"),a.type="auto")}if(!t){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),n||(this._enabled=!1);try{await Ye(this,Rt.NEED_DISABLE_TRACK,this)}catch(a){throw v.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}const i=dn({},this._constraints),o=Yi.searchDeviceIdByName(this._deviceName);o&&!i.deviceId&&(i.deviceId=o);try{n||(this._enabled=!0);const a=await qi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),await Ye(this,Rt.NEED_ENABLE_TRACK,this)}catch(a){throw n||(this._enabled=!1),v.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}v.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(iu()||Ny())&&Be.unbindInterruptDetectorTrack(this)}onTrackEnded(){if(($r()||Is())&&this._enabled&&!this._isClosed&&Be.duringInterruption){const t=async()=>{Be.off(fr.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(v.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Be.on(fr.IOS_INTERRUPTION_END,t)}else v.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pu.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,n=Yi.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const r=await qi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(Hi.REQUEST_UPDATE_CONSTRAINTS,async(e,n,r)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),n()}catch(i){r(i)}})}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(Hi.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[rM,iM],Object.getOwnPropertyDescriptor(No.prototype,"setDevice"),No.prototype),Re(No.prototype,"setEnabled",[sM,oM,aM],Object.getOwnPropertyDescriptor(No.prototype,"setEnabled"),No.prototype),Re(No.prototype,"close",[cM],Object.getOwnPropertyDescriptor(No.prototype,"close"),No.prototype),No),ZX=(dM=xt({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),lM=kn(),uM=xt({argsMap:t=>[t.getTrackId()]}),hM=kn(),pM=xt({argsMap:t=>[t.getTrackId()]}),fM=kn(),_M=xt({argsMap:t=>[t.getTrackId()]}),mM=kn(),EM=xt({argsMap:t=>[t.getTrackId()]}),gM=kn(),TM=xt({argsMap:t=>[t.getTrackId()]}),SM=xt({argsMap:t=>[t.getTrackId()]}),vM=kn(),Re((Ir=class extends In{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,r){super(e.createOutputTrack(),n,r),Y(this,"source",void 0),Y(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(Wi.AUDIO_SOURCE_STATE_CHANGE,i=>{this.safeEmit(pu.SOURCE_STATE_CHANGE,i)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Ge(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[dM,lM],Object.getOwnPropertyDescriptor(Ir.prototype,"startProcessAudioBuffer"),Ir.prototype),Re(Ir.prototype,"pauseProcessAudioBuffer",[uM,hM],Object.getOwnPropertyDescriptor(Ir.prototype,"pauseProcessAudioBuffer"),Ir.prototype),Re(Ir.prototype,"seekAudioBuffer",[pM,fM],Object.getOwnPropertyDescriptor(Ir.prototype,"seekAudioBuffer"),Ir.prototype),Re(Ir.prototype,"resumeProcessAudioBuffer",[_M,mM],Object.getOwnPropertyDescriptor(Ir.prototype,"resumeProcessAudioBuffer"),Ir.prototype),Re(Ir.prototype,"stopProcessAudioBuffer",[EM,gM],Object.getOwnPropertyDescriptor(Ir.prototype,"stopProcessAudioBuffer"),Ir.prototype),Re(Ir.prototype,"close",[TM],Object.getOwnPropertyDescriptor(Ir.prototype,"close"),Ir.prototype),Re(Ir.prototype,"setAudioBufferPlaybackSpeed",[SM,vM],Object.getOwnPropertyDescriptor(Ir.prototype,"setAudioBufferPlaybackSpeed"),Ir.prototype),Ir);class $n extends In{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Eu().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,ze(8,"track-mix-")),Y(this,"trackList",void 0),Y(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(v.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):v.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){v.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}jm(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof $n?n.emit(Sd.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)}))}}class tQ extends yL{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(Wi.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),Y(this,"audioBuffer",void 0),Y(this,"sourceNode",void 0),Y(this,"startPlayTime",0),Y(this,"startPlayOffset",0),Y(this,"pausePlayTime",0),Y(this,"options",void 0),Y(this,"currentLoopCount",0),Y(this,"currentPlaybackSpeed",100),Y(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):v.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const yM=new Map;class lR{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const e=this.renderStats.curTs-this.renderStats.lastTs,n=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/e;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,n}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(v.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(e){Y(this,"trackId",void 0),Y(this,"config",void 0),Y(this,"onFirstVideoFrameDecoded",void 0),Y(this,"onVideoStateChanged",void 0),Y(this,"freezeTimeCounterList",[]),Y(this,"renderFreezeAccTime",0),Y(this,"isKeepLastFrame",!1),Y(this,"timeUpdatedCount",0),Y(this,"freezeTime",0),Y(this,"playbackTime",0),Y(this,"lastTimeUpdatedTime",0),Y(this,"autoplayFailed",!1),Y(this,"videoTrack",void 0),Y(this,"videoElement",void 0),Y(this,"cacheVideoElement",void 0),Y(this,"renderStats",void 0),Y(this,"_videoState",Oo.VideoStateStopped),Y(this,"videoElementCheckInterval",void 0),Y(this,"videoElementFreezeTimeout",void 0),Y(this,"_videoElementStatus",jr.NONE),Y(this,"isGettingVideoDimensions",!1),Y(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return v.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),Y(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Be.curState==="running"&&(v.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Rk())),Nk()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),Y(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=jr.PLAYING;break;case"loadeddata":if(this.videoState=Oo.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=jr.CANPLAY;break;case"stalled":this.videoElementStatus=jr.STALLED;break;case"suspend":this.videoElementStatus=jr.SUSPEND;break;case"pause":this.videoElementStatus=jr.PAUSED,$r()||Is()||Sr()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(v.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=jr.WAITING;break;case"abort":this.videoElementStatus=jr.ABORT;break;case"ended":this.videoElementStatus=jr.ENDED;break;case"emptied":this.videoElementStatus=jr.EMPTIED;break;case"error":{const r=this.videoElement.error;r&&(this.videoElementStatus=jr.ERROR,v.error("[".concat(this.trackId,"] media error: ").concat(r.message," (").concat(r.code,")")));break}case"timeupdate":{const r=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);const i=r-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,ya.lastVisibleTime<ya.lastHiddenTime||o<ya.lastHiddenTime||o<ya.lastVisibleTime)return;for(i>M("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=i),this.playbackTime+=i;this.playbackTime>=6e3;){this.playbackTime-=6e3;const a=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(a),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),Y(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(v.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Rk())),Nk()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Be.on(fr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Be.on(fr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const n=this.videoElement.play();n&&n.catch&&n.catch(i=>{e&&OL(e,"video",i.message,this.trackId),i.name==="NotAllowedError"?(v.warning("detected video element autoplay failed",i),this.autoplayFailed=!0,this.handleAutoPlayFailed()):v.warning("[".concat(this.trackId,"] play warning: "),i)});const r=ve();if((r.name==="Safari"&&Number(r.version)===15||iu())&&n&&n.then){const i=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(i).catch(i)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const n=e.getContext("2d");if(!n)return v.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);const r=n.getImageData(0,0,e.width,e.height);return e.remove(),r}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;const i=r.getContext("2d");return i?(i.drawImage(this.videoElement,0,0,r.width,r.height),new mt((o,a)=>{r.toBlob(async d=>{if(r.remove(),d){const l=await VL(d);o({buffer:l,width:r.width,height:r.height})}else a(new et(D.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,n<0?.1:n>1?1:n)})):await dR(e)}destroy(){this.renderStats=void 0,Be.off(fr.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Be.off(fr.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Oo.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=jr.INIT,!this.videoElementCheckInterval&&(RM.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=jr.DESTROYED)},1e3),M("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let o;const a=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",a),this.videoElementFreezeTimeout=window.setTimeout(d,M("VIDEO_FREEZE_DURATION")))},d=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Oo.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Oo.VideoStateFrozen:document.addEventListener("visibilitychange",a))},l=(h,f)=>{if(this.videoElementStatus===jr.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=f.mediaTime):this.renderStats={lastTs:f.mediaTime,curTs:f.mediaTime,lastRenderNum:0,renderNum:0},o){const S=f.presentationTime-o.presentationTime;this.videoState===Oo.VideoStateStarting&&(this.videoState=Oo.VideoStateDecoding),this.videoState===Oo.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(d,M("VIDEO_FREEZE_DURATION"))),S<M("VIDEO_FREEZE_DURATION")&&this.videoState===Oo.VideoStateFrozen&&(this.videoState=Oo.VideoStateDecoding),S>M("VIDEO_FREEZE_DURATION")&&ya.lastVisibleTime>=ya.lastHiddenTime&&o.timestamp>ya.lastVisibleTime&&o.timestamp>ya.lastHiddenTime&&(this.renderFreezeAccTime+=S)}o=dn(dn({},f),{},{timestamp:h})}var m,T;M("ENABLE_VIDEO_FRAME_CALLBACK")&&((m=(T=this.videoElement).requestVideoFrameCallback)===null||m===void 0||m.call(T,l))};(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(n,l)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Bm()&&!M("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const r=ve();r.name==="Safari"&&Number(r.version)===15||iu()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Tn()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Tn()&&this.videoElement.load());const i=this.videoElement.play();i!==void 0&&i.catch(o=>{v.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){RM.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=jr.NONE}handleAutoPlayFailed(){const e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{v.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{v.error(r)}),this.autoplayFailed=!1,cp()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};cp()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),bL()}}const RM=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class IM extends lR{constructor(e){super(e),Y(this,"container",void 0),Y(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const n=e.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,r):await dR(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",M("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var CM,AM,wM,bM,OM,NM,PM,DM,kM,LM,MM,UM,xM,VM,FM,BM,jM,GM,WM,HM,KM,qM,YM,zM,Ee,JM,XM,QM,$M,ZM,t1,e1,n1,Ji;let en=(CM=xt({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),AM=kn(),wM=xt({argsMap:t=>[t.getTrackId()]}),bM=au("LocalVideoTrack","_enabledMutex"),OM=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),NM=kn(),PM=au("LocalVideoTrack","_enabledMutex"),DM=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),kM=kn(),LM=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),MM=kn(),UM=kn(),xM=xt({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),VM=kn(),FM=kn(),BM=kn(),jM=kn(),GM=kn(),WM=kn(),HM=kn(),KM=xt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),qM=xt({argsMap:t=>[t.getTrackId()]}),YM=xt({argsMap:t=>[t.getTrackId()]}),zM=xt({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),Ee=class AV extends mu{get videoHeight(){if(Sr()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Sr()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==jr.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,r,i,o,a){if(super(e,o),Y(this,"trackMediaType",_u.VIDEO),Y(this,"_player",void 0),Y(this,"isUseScaleResolutionDownBy",!1),Y(this,"_videoVisibleTimer",null),Y(this,"_previousVideoVisibleStatus",void 0),Y(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),Y(this,"_encoderConfig",void 0),Y(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),Y(this,"_optimizationMode",void 0),Y(this,"_videoHeight",void 0),Y(this,"_videoWidth",void 0),Y(this,"_forceBitrateLimit",void 0),Y(this,"_enabled",!0),Y(this,"_processorDestination",void 0),Y(this,"_processorContext",void 0),Sr()){const{width:d,height:l}=e.getSettings();this._videoWidth=d,this._videoHeight=l}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=r,this._optimizationMode=i,this._hints=a||[],this._hints.indexOf(Je.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(wy(Oe.CHROME,115)&&Vm().indexOf("Windows")!==-1){const d=function(l,h){if("VideoFrame"in window&&"TransformStream"in window&&Ie().supportWebRTCInsertableStream){const f=new MediaStreamTrackProcessor(l),m=new MediaStreamTrackGenerator({kind:"video"});let T,S,w=Date.now();const I=()=>{C&&(clearInterval(C),C=void 0),T&&(T.close(),T=void 0),l.stop(),S=void 0,m.removeEventListener("ended",I)};let C=window.setInterval(()=>{if(S&&T&&Date.now()-w>1e3)try{m.readyState==="live"?S.enqueue(T.clone()):I()}catch{I()}},1e3);const N=new TransformStream({transform:(P,x)=>{m.readyState==="live"?(S=x,w=Date.now(),T===void 0?(T=P,x.enqueue(P.clone())):(x.enqueue(T),T=P)):P.close()}});return m.addEventListener("ended",I),f.readable.pipeThrough(N).pipeTo(m.writable),m}}(e);d&&(v.info("local screen video track begin to inject frame"),this._mediaStreamTrack=d)}n&&this._hints.indexOf(Je.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new PL(this.getTrackId(),"local"),this._processorDestination=new NL(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const i=document.getElementById(e);i?e=i:(v.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}v.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const r=dn(dn(dn({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(r):(e instanceof HTMLVideoElement?this._player=new lR(r):this._player=new IM(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(pu.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},M("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,v.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(v.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Ye(this,Rt.NEED_DISABLE_TRACK,this)}catch(r){throw v.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}return n||(this._enabled=!1),void v.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Ye(this,Rt.NEED_ENABLE_TRACK,this)}catch(r){throw v.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}v.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,v.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Ye(this,Rt.NEED_MUTE_TRACK,this):await Ye(this,Rt.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,n){if(!this._enabled)throw new et(D.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=bo(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const r=tE({encoderConfig:e});(Sr()||$r()||Is())&&(r.deviceId=void 0),v.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(i){const o=new et(D.UNEXPECTED_ERROR,i.toString());throw v.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(Je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ye(this,Rt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(v)}}getStats(){return uc(()=>{v.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Bi(this,Rt.GET_STATS)||dn({},nR)}async setBeautyEffect(e){v.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await dR(e)}async setBitrateLimit(e){v.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void v.error(D.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=e,await Ye(this,Rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(r){throw this._optimizationMode=n,v.error("[".concat(this.getTrackId(),"] set optimization mode failed"),r.toString()),r}v.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return v.error(D.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,v.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){LL(this._originMediaStreamTrack).then(e=>{let[n,r]=e;this._videoHeight=r,this._videoWidth=n}).catch(Wm)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new et(D.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");v.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=bo(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ye(this,Rt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(v)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:n,frameRate:r}=this.getMediaStreamTrackSettings();if(!e||!n||!r)return;const{bitrateMax:i,bitrateMin:o}=this._encoderConfig;if(o==null||i==null){const{max:a,min:d}=function(l,h,f,m,T){const S=M("BITRATE_ADAPTER_TYPE");if(S==="DEFAULT_BITRATE")return{min:m,max:T};if(T===void 0){var w;const C=Math.floor(200*Math.pow(f/15,.6)*Math.pow(l*h/640/360,.75));T=S==="STANDARD_BITRATE"?4*C:2*C,m=(w=m)!==null&&w!==void 0?w:C}else{var I;m=(I=m)!==null&&I!==void 0?I:Math.floor(T/10)}return{min:m,max:T}}(e,n,r,o,i);this._encoderConfig.bitrateMin=d,this._encoderConfig.bitrateMax=a,v.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(r,"] => [brMax: ").concat(a,", brMin: ").concat(d,"]"))}}getVideoElementVisibleStatus(){try{var e,n;const r=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),i={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:o,slot:a}=i;if(this.isPlaying&&o instanceof HTMLVideoElement&&a instanceof HTMLElement){const d=Mk.checkOneElementVisible(o),l=Object.assign({},d);if(l.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=l.visible;const h=bt.reportApiInvoke(null,{tag:vn.TRACER,name:Kn.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});l.visible?h.onSuccess("Video is visible"):h.onSuccess("Invisible because of ".concat(l.reason))}return l}return}catch(r){throw new et(D.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new et(D.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;e&&(r=dn(dn({},r),bo(e))),r=md(r);const i=ze(8,"track-video-cloned-"),o=new AV(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,md(this._scalabilityMode),this._optimizationMode,i,md(this._hints));return e&&r&&o.setEncoderConfiguration(r),v.debug("clone video track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new et(D.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new et(D.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(e){if(uc(()=>{bt.reportApiInvoke(null,{name:Kn.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:vn.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!M("ENABLE_VIDEO_SEI")||!M("ENABLE_ENCODED_TRANSFORM"))return void v.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new et(D.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void v.warning("Video track is not published, SEI can not be send");const r=n.sender.getParameters();if(r.codecs.length===0)return;const i=r.codecs[0].mimeType.toLocaleLowerCase();i==="video/h264"?this.safeEmit("sei-to-send",e):v.warning("SEI is not supported by ".concat(i))}bindProcessorDestinationEvents(){this.processorDestination.on(Zr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Ye(this,Rt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ye(this,Rt.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Zr.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Hi.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Hi.REQUEST_CONSTRAINTS)}},Re(Ee.prototype,"play",[CM,AM],Object.getOwnPropertyDescriptor(Ee.prototype,"play"),Ee.prototype),Re(Ee.prototype,"stop",[wM],Object.getOwnPropertyDescriptor(Ee.prototype,"stop"),Ee.prototype),Re(Ee.prototype,"setEnabled",[bM,OM,NM],Object.getOwnPropertyDescriptor(Ee.prototype,"setEnabled"),Ee.prototype),Re(Ee.prototype,"setMuted",[PM,DM,kM],Object.getOwnPropertyDescriptor(Ee.prototype,"setMuted"),Ee.prototype),Re(Ee.prototype,"setEncoderConfiguration",[LM,MM],Object.getOwnPropertyDescriptor(Ee.prototype,"setEncoderConfiguration"),Ee.prototype),Re(Ee.prototype,"getStats",[UM],Object.getOwnPropertyDescriptor(Ee.prototype,"getStats"),Ee.prototype),Re(Ee.prototype,"setBeautyEffect",[xM,VM],Object.getOwnPropertyDescriptor(Ee.prototype,"setBeautyEffect"),Ee.prototype),Re(Ee.prototype,"getCurrentFrameData",[FM],Object.getOwnPropertyDescriptor(Ee.prototype,"getCurrentFrameData"),Ee.prototype),Re(Ee.prototype,"getCurrentFrameImage",[BM],Object.getOwnPropertyDescriptor(Ee.prototype,"getCurrentFrameImage"),Ee.prototype),Re(Ee.prototype,"setBitrateLimit",[jM],Object.getOwnPropertyDescriptor(Ee.prototype,"setBitrateLimit"),Ee.prototype),Re(Ee.prototype,"setOptimizationMode",[GM],Object.getOwnPropertyDescriptor(Ee.prototype,"setOptimizationMode"),Ee.prototype),Re(Ee.prototype,"setScalabiltyMode",[WM],Object.getOwnPropertyDescriptor(Ee.prototype,"setScalabiltyMode"),Ee.prototype),Re(Ee.prototype,"updateMediaStreamTrackResolution",[HM],Object.getOwnPropertyDescriptor(Ee.prototype,"updateMediaStreamTrackResolution"),Ee.prototype),Re(Ee.prototype,"pipe",[KM],Object.getOwnPropertyDescriptor(Ee.prototype,"pipe"),Ee.prototype),Re(Ee.prototype,"unpipe",[qM],Object.getOwnPropertyDescriptor(Ee.prototype,"unpipe"),Ee.prototype),Re(Ee.prototype,"close",[YM],Object.getOwnPropertyDescriptor(Ee.prototype,"close"),Ee.prototype),Re(Ee.prototype,"replaceTrack",[zM],Object.getOwnPropertyDescriptor(Ee.prototype,"replaceTrack"),Ee.prototype),Ee),uR=(JM=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),XM=kn(),QM=au("CameraVideoTrack","_enabledMutex"),$M=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),ZM=kn(),t1=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),e1=kn(),n1=xt({argsMap:t=>[t.getTrackId()]}),Ji=class wV extends en{get __className__(){return"CameraVideoTrack"}constructor(e,n,r,i,o,a){super(e,bo(n.encoderConfig),i,o,a),Y(this,"_config",void 0),Y(this,"_originalConstraints",void 0),Y(this,"_constraints",void 0),Y(this,"_enabled",!0),Y(this,"_deviceName","default"),Y(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(iu()||Ny())&&!function(){const d=ve();if(d.os!==er.IOS||!d.osVersion)return!1;const l=d.osVersion.split(".");return Number(l[0])===15&&Number(l[1])>=2}()&&Pk()&&this._enabled&&!this._isClosed&&(v.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=r,this._constraints=r,this._deviceName=e.label,this._encoderConfig=bo(this._config.encoderConfig),Be.on(fr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Be.on(fr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(v.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const n=await Yi.getDeviceById(e),r={};r.video=dn({},this._constraints),r.video.deviceId={exact:e},r.video.facingMode=void 0,this._originMediaStreamTrack.stop();let i=null;try{i=await qi(r,this.getTrackId())}catch(o){throw v.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),i=await qi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw v.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await Yi.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw v.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}v.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){v.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const n={video:dn(dn({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let r=null;try{r=await qi(n,this.getTrackId())}catch(i){throw v.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),i.toString()),r=await qi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),i}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=dn({},n.video),v.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(v.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const r=await qi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1)}await Ye(this,Rt.NEED_ENABLE_TRACK,this)}catch(r){throw v.error("[".concat(this.getTrackId(),"] setEnabled true error"),r.toString()),r}this.updateMediaStreamTrackResolution(),v.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Ye(this,Rt.NEED_DISABLE_TRACK,this)}catch(r){throw v.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}v.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new et(D.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=bo(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);const r=yn(this._config);r.encoderConfig=e;const i=tE(r);(Sr()||$r()||Is())&&(i.deviceId=void 0),v.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(o){const a=new et(D.UNEXPECTED_ERROR,o.toString());throw v.error("[".concat(this.getTrackId(),"] applyConstraints error"),a.toString()),a}this._config=r,this._constraints=i,this._originalConstraints=i,this._encoderConfig=e,this._hints.indexOf(Je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ye(this,Rt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(v)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if(($r()||Is())&&this._enabled&&!this._isClosed&&Be.duringInterruption){const e=async()=>{Be.off(fr.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(v.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Be.on(fr.IOS_INTERRUPTION_END,e)}else v.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(pu.TRACK_ENDED)}async renewMediaStreamTrack(e){const n=e||this._constraints,r=Yi.searchDeviceIdByName(this._deviceName);if(r&&!n.deviceId&&(n.deviceId={exact:r}),this._enabled){const i=await qi({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Be.off(fr.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Be.off(fr.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;e&&(r=dn(dn({},r),bo(e))),r=md(r);const i=ze(8,"track-cam-cloned-"),o=new wV(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,md(dn(dn({},this._config),{},{encoderConfig:r})),md(this._constraints),md(this._scalabilityMode),this._optimizationMode,i);return e&&r&&o.setEncoderConfiguration(r),v.debug("clone track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(Hi.REQUEST_UPDATE_CONSTRAINTS,async(e,n,r)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),n()}catch(i){r(i)}}),this.processorContext.on(Hi.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}},Re(Ji.prototype,"setDevice",[JM,XM],Object.getOwnPropertyDescriptor(Ji.prototype,"setDevice"),Ji.prototype),Re(Ji.prototype,"setEnabled",[QM,$M,ZM],Object.getOwnPropertyDescriptor(Ji.prototype,"setEnabled"),Ji.prototype),Re(Ji.prototype,"setEncoderConfiguration",[t1,e1],Object.getOwnPropertyDescriptor(Ji.prototype,"setEncoderConfiguration"),Ji.prototype),Re(Ji.prototype,"close",[n1],Object.getOwnPropertyDescriptor(Ji.prototype,"close"),Ji.prototype),Ji);function hR(t,e,n,r){n.optimizationMode&&(r&&r.width&&r.height?(n.encoderConfig=dn(dn({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?v.debug("[".concat(t,"] set content hint to"),n.optimizationMode):v.debug("[".concat(t,"] set content hint failed")))):v.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var r1,i1,s1,o1,os,a1,c1,d1,l1,u1,h1,Gr;class p1 extends TL{getUserId(){return this._userId}constructor(e,n,r,i){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(i.clientId,"_").concat(ze(5,""))),Y(this,"_userId",void 0),Y(this,"_uintId",void 0),Y(this,"_isDestroyed",!1),Y(this,"store",void 0),Y(this,"processor",void 0),Y(this,"processorContext",void 0),this._userId=n,this._uintId=r,this.store=i}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,v.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Tu=(r1=xt({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),i1=xt({argsMap:t=>[t.getTrackId()]}),s1=xt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),o1=xt({argsMap:t=>[t.getTrackId()]}),Re((os=class extends p1{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==jr.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,r){super(t,e,n,r),Y(this,"_videoVisibleTimer",null),Y(this,"_previousVideoVisibleStatus",void 0),Y(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),Y(this,"trackMediaType",_u.VIDEO),Y(this,"_videoWidth",void 0),Y(this,"_videoHeight",void 0),Y(this,"_player",void 0),Y(this,"processorDestination",void 0),Y(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new PL(this.getTrackId(),"remote"),this.processorDestination=new NL(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return uc(()=>{v.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Bi(this,Rt.GET_STATS)||dn({},EL)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(v.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}v.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=dn(dn({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new lR(n):this._player=new IM(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(fu.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=r=>{this.safeEmit(fu.VIDEO_STATE_CHANGED,r)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(fu.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},M("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,v.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){LL(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Wm)}_updatePlayerSource(){v.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:i,slot:o}=r;if(this.isPlaying&&i instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=Mk.checkOneElementVisible(i),d=Object.assign({},a);if(d.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=d.visible;const l=bt.reportApiInvoke(null,{tag:vn.TRACER,name:Kn.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});d.visible?l.onSuccess("Video is visible"):l.onSuccess("Invisible because of ".concat(d.reason))}return d}return}catch(n){throw new et(D.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new et(D.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Zr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Zr.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(Sd.SEI_RECEIVED,t)}}).prototype,"play",[r1],Object.getOwnPropertyDescriptor(os.prototype,"play"),os.prototype),Re(os.prototype,"stop",[i1],Object.getOwnPropertyDescriptor(os.prototype,"stop"),os.prototype),Re(os.prototype,"pipe",[s1],Object.getOwnPropertyDescriptor(os.prototype,"pipe"),os.prototype),Re(os.prototype,"unpipe",[o1],Object.getOwnPropertyDescriptor(os.prototype,"unpipe"),os.prototype),os),Su=(a1=xt({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),c1=xt({argsMap:(t,e)=>[t.getTrackId(),e]}),d1=xt({argsMap:t=>[t.getTrackId()]}),l1=xt({argsMap:t=>[t.getTrackId()]}),u1=xt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),h1=xt({argsMap:t=>[t.getTrackId()]}),Re((Gr=class extends p1{get isPlaying(){return this._useAudioElement?ci.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,r){super(t,e,n,r),Y(this,"trackMediaType",_u.AUDIO),Y(this,"_source",void 0),Y(this,"_useAudioElement",!0),Y(this,"_volume",100),Y(this,"processorContext",void 0),Y(this,"processorDestination",void 0),Y(this,"_played",!1),Y(this,"_bypassWebAudio",!1),M("DISABLE_WEBAUDIO")?(this._source=new cR,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new RL(t,!0),M("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Wi.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(fu.FIRST_FRAME_DECODED)}),this.processorContext=new kL(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new DL(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Wi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),this._source.on(Wi.ON_AUDIO_BUFFER,n=>t(n))}setVolume(t){this._volume=t,this._useAudioElement?ci.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!pL())throw new et(D.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ci.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return uc(()=>{v.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Bi(this,Rt.GET_STATS)||dn({},mL)}play(){v.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(v.debug("[".concat(this.getTrackId(),"] use audio element to play")),ci.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){v.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ci.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];v.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ci.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new et(D.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new et(D.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new et(D.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Zr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Zr.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Zr.ON_TRACK),this.processorDestination.removeAllListeners(Zr.ON_NODE)}}).prototype,"setVolume",[a1],Object.getOwnPropertyDescriptor(Gr.prototype,"setVolume"),Gr.prototype),Re(Gr.prototype,"setPlaybackDevice",[c1],Object.getOwnPropertyDescriptor(Gr.prototype,"setPlaybackDevice"),Gr.prototype),Re(Gr.prototype,"play",[d1],Object.getOwnPropertyDescriptor(Gr.prototype,"play"),Gr.prototype),Re(Gr.prototype,"stop",[l1],Object.getOwnPropertyDescriptor(Gr.prototype,"stop"),Gr.prototype),Re(Gr.prototype,"pipe",[u1],Object.getOwnPropertyDescriptor(Gr.prototype,"pipe"),Gr.prototype),Re(Gr.prototype,"unpipe",[h1],Object.getOwnPropertyDescriptor(Gr.prototype,"unpipe"),Gr.prototype),Gr);const ya=new class extends _n{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),Y(this,"_lastHiddenTime",0),Y(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),v.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};class f1 extends _n{constructor(e,n){super(),Y(this,"trackMediaType",_u.DATA),Y(this,"_version",1),Y(this,"_type",3),Y(this,"_config",void 0),Y(this,"_originDataChannel",void 0),Y(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),Y(this,"_dataStreamPacketHandler",{serialize:r=>r,deserialize:r=>r}),Y(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return M("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new mt((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const r=setTimeout(()=>{var i;n(new et(D.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((i=this._originDataChannel)===null||i===void 0?void 0:i.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(r),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(r),new et(D.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new et(D.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[$m.OPEN,$m.CLOSE,$m.ERROR].forEach(n=>{const r=()=>{this.emit(n)};this._datachannelEventMap.set(n,r),e.addEventListener(n,r)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[r,i]=n;e.removeEventListener(r,i)}),this._datachannelEventMap.clear()}}class eQ extends f1{constructor(e){super(e),Y(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const r=n.data.slice(0,this._dataStreamPacketHeader.byteLength),i=new DataView(r).getUint8(3);if(i!==this.id)return void(M("SHOW_DATASTREAM2_LOG")&&v.debug("invalid datachannel id: ".concat(i," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit($m.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class nQ extends f1{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);const r=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}function nE(){const t=new Blob([atob("ZnVuY3Rpb24gdCh0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLG89W10scj0wO2Zvcig7by5sZW5ndGg8bjspciszPG4mJjA9PT1hW3JdJiYwPT09YVtyKzFdJiYzPT09YVtyKzJdJiYoMD09PWFbciszXXx8MT09PWFbciszXXx8Mj09PWFbciszXXx8Mz09PWFbciszXSk/KG8ucHVzaChhW3JdLGFbcisxXSxhW3IrM10pLHIrPTQpOihvLnB1c2goYVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobyl9ZnVuY3Rpb24gZSh0LGUpe2NvbnN0IG49ZnVuY3Rpb24odCl7Y29uc3QgZT10Lmxlbmd0aDtsZXQgbj1bXSxhPTA7Zm9yKDthPGU7KWErMjxlJiYwPT09dFthXSYmMD09PXRbYSsxXSYmKDA9PT10W2ErMl18fDE9PT10W2ErMl18fDI9PT10W2ErMl18fDM9PT10W2ErMl0pPyhuLnB1c2godFthXSx0W2ErMV0sMyx0W2ErMl0pLGErPTMpOihuLnB1c2godFthXSksYSsrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxyPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNitvKzErYSt0LmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8bzspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1yLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNitpK2EpLHMuYnVmZmVyfWNvbnN0IG49NzEsYT0xLG89MixyPTEscz0yO3ZhciBpOyFmdW5jdGlvbih0KXt0W3QuQVVESU9fTEVWRUw9MV09IkFVRElPX0xFVkVMIix0W3QuTUVUQURBVEE9Ml09Ik1FVEFEQVRBIix0W3QuQVVESU9fNjRfQklUX1BUUz0zXT0iQVVESU9fNjRfQklUX1BUUyJ9KGl8fChpPXt9KSk7bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJTYWZhcmkiKT4tMSYmLTE9PT1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpJiYoc2VsZi5vbnJ0Y3RyYW5zZm9ybT1mPT57Y29uc3QgdT1mLnRyYW5zZm9ybWVyO2xldCBkPVtdLGw9W107dS5vcHRpb25zLnBvcnQub25tZXNzYWdlPXQ9Pnt0LmRhdGEuc2VpJiZkLnB1c2godC5kYXRhLnNlaSksdC5kYXRhLm1ldGFkYXRhJiZsLnB1c2godC5kYXRhLm1ldGFkYXRhKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IGc9dS5yZWFkYWJsZS5nZXRSZWFkZXIoKSxjPXUud3JpdGFibGUuZ2V0V3JpdGVyKCk7InNlaS1yeCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiBlKG4pe2cucmVhZCgpLnRoZW4oKGE9PntpZighYS5kb25lKXtpZihhLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IGU9ZnVuY3Rpb24oZSl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcoZS5kYXRhKTtsZXQgYT0wO2Zvcig7YSs0PGUuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PW4uZ2V0VWludDgoYSswKSYmMD09PW4uZ2V0VWludDgoYSsxKSYmMD09PW4uZ2V0VWludDgoYSsyKSYmMT09PW4uZ2V0VWludDgoYSszKSYmNj09PW4uZ2V0VWludDgoYSs0KSl7bGV0IG89YSs2LHI9MCxzPTA7Zm9yKDsyNTU9PT0ocz1uLmdldFVpbnQ4KG8rKykpOylyKz0yNTU7cis9cztjb25zdCBpPXQoZS5kYXRhLG8scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGkpfWErK31yZXR1cm4gbnVsbH0oYS52YWx1ZSk7ZSYmbi5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3NlaTplfSl9Yy53cml0ZShhLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0odSk6InNlaS10eCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2cucmVhZCgpLnRoZW4oKGE9PntpZighYS5kb25lKXtpZihhLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZC5zaGlmdCgpO3QmJihhLnZhbHVlLmRhdGE9ZShhLnZhbHVlLmRhdGEsdCkpfWMud3JpdGUoYS52YWx1ZSksbi5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3RyYW5zZm9ybWVkOiEwfSksdChuKX19KSl9KHUpOiJhdWRpby1tZXRhZGF0YS1yeCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KGUpe2cucmVhZCgpLnRoZW4oKGY9PntpZighZi5kb25lKXtpZihmLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZEF1ZGlvRnJhbWUpe2NvbnN0IHQ9ZnVuY3Rpb24odCxlPSExKXtjb25zdCBmPXQuZ2V0VWludDgoMCk7aWYoZiE9PW4pcmV0dXJuO2NvbnN0IHU9dC5nZXRVaW50MTYoMSksZD1hK28rdSxsPW5ldyBVaW50OEFycmF5KHQuYnl0ZUxlbmd0aC1kKTtsLnNldChuZXcgVWludDhBcnJheSh0LmJ1ZmZlcixkLHQuYnl0ZUxlbmd0aC1kKSk7Y29uc3QgZz17bTpmLHRsdkxlbjp1LHRsdjpbXSxmcmFtZTpsfTtsZXQgYz1hK287Zm9yKDtjPGQ7KXtjb25zdCBuPXQuZ2V0VWludDgoYyksYT10LmdldFVpbnQxNihjK3IpLG89citzO2lmKG49PT1pLkFVRElPX0xFVkVMKXtsZXQgcj10LmdldFVpbnQ4KGMrbyk7Zm9yKGxldCBlPTE7ZTxhO2UrKylyPXI8PDh8dC5nZXRVaW50OChjK28rZSk7Zy50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZT8xMjdecj4+MToxMjcmcn0pfWVsc2UgaWYobj09PWkuTUVUQURBVEF8fG49PT1pLkFVRElPXzY0X0JJVF9QVFMpe2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkoYSk7Zm9yKGxldCBuPTA7bjxhO24rKyllW25dPXQuZ2V0VWludDgoYytvK24pO2cudGx2LnB1c2goe3RhZzpuLGxlbmd0aDphLHZhbHVlOmV9KX1jKz1vK2F9cmV0dXJuIGd9KG5ldyBEYXRhVmlldyhmLnZhbHVlLmRhdGEpKTtpZih0KXtjb25zdCBuPXQudGx2LmZpbmQoKHQ9PnQudGFnPT09aS5NRVRBREFUQXx8dC50YWc9PT1pLkFVRElPXzY0X0JJVF9QVFMpKTtuJiZuLnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe21ldGFkYXRhOm4udmFsdWV9KSxmLnZhbHVlLmRhdGE9dC5mcmFtZS5idWZmZXJ9fWMud3JpdGUoZi52YWx1ZSksZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3RyYW5zZm9ybWVkOiEwfSksdChlKX19KSl9KHUpOiJhdWRpby1tZXRhZGF0YS10eCI9PT11Lm9wdGlvbnMubmFtZSYmZnVuY3Rpb24gdChlKXtnLnJlYWQoKS50aGVuKChmPT57aWYoIWYuZG9uZSl7aWYoZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe2dldE1ldGFkYXRhOiEwfSksZi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PWwuc2hpZnQoKTt0JiYoZi52YWx1ZS5kYXRhPWZ1bmN0aW9uKHQsZSxpKXtjb25zdCBmPWkuYnl0ZUxlbmd0aCx1PWYrcitzLGQ9YStvK3UsbD1uZXcgQXJyYXlCdWZmZXIodC5ieXRlTGVuZ3RoK2QpLGc9bmV3IERhdGFWaWV3KGwpO2cuc2V0VWludDgoMCxuKSxnLnNldFVpbnQxNigxLHUpLGcuc2V0VWludDgoMyxlKSxnLnNldFVpbnQxNig0LGYpO2ZvcihsZXQgdD0wO3Q8Zjt0KyspZy5zZXRVaW50OCg2K3QsaVt0XSk7Y29uc3QgYz1uZXcgVWludDhBcnJheShnLmJ1ZmZlcik7cmV0dXJuIGMuc2V0KG5ldyBVaW50OEFycmF5KHQpLGQpLGMuYnVmZmVyfShmLnZhbHVlLmRhdGEsaS5BVURJT182NF9CSVRfUFRTLHQpKX1jLndyaXRlKGYudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfSh1KX0sc2VsZi5wb3N0TWVzc2FnZSgicmVnaXN0ZXJlZCIpKTsK")],{type:"text/javascript"});return setTimeout(()=>nm.revokeObjectURL(t),0),new Worker(nm.createObjectURL(t))}const _1=71,pR=1,fR=2,_R=1,m1=2;var Ra=function(t){return t[t.AUDIO_LEVEL=1]="AUDIO_LEVEL",t[t.METADATA=2]="METADATA",t[t.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",t}(Ra||{});function E1(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=t.getUint8(0);if(n!==_1)return;const r=t.getUint16(1),i=pR+fR+r,o=new Uint8Array(t.byteLength-i);o.set(new Uint8Array(t.buffer,i,t.byteLength-i));const a={m:n,tlvLen:r,tlv:[],frame:o};let d=pR+fR;for(;d<i;){const l=t.getUint8(d),h=t.getUint16(d+_R),f=_R+m1;if(l===Ra.AUDIO_LEVEL){let m=t.getUint8(d+f);for(let T=1;T<h;T++)m=m<<8|t.getUint8(d+f+T);a.tlv.push({tag:l,length:h,value:e?127^m>>1:127&m})}else if(l===Ra.METADATA||l===Ra.AUDIO_64_BIT_PTS){const m=new Uint8Array(h);for(let T=0;T<h;T++)m[T]=t.getUint8(d+f+T);a.tlv.push({tag:l,length:h,value:m})}d+=f+h}return a}const rE=new Map,iE=127,Rd=1e-10,mR=139/13,sE=new Map;function ER(t,e,n){const r="".concat(t,"-").concat(e,"-").concat(n);let i=0;return sE.has(r)?i=sE.get(r):(i=Math.log(function(a,d){const l=a-d;d<l&&(d=l);let h=1;for(let f=a,m=1;f>d;f--,m++)h=h*f/m;return h}(e,t))+t*Math.log(.5)+(e-t)*Math.log(1-.5)-Math.log(n)+n*t,sE.set(r,i)),i<Rd&&(i=Rd),i}function g1(t,e,n){const r=e.length,i=t.length/r;let o=!1;for(let a=0,d=0;a<r;a++){let l=0;for(let h=d+i;d<h;d++)t[d]>n&&l++;e[a]!==l&&(e[a]=l,o=!0)}return o}window.cache=sE;let rQ=0;class T1{constructor(e){Y(this,"id",void 0),Y(this,"immediates",[]),Y(this,"lastNonSilence",-1),Y(this,"immediateSpeechActivityScore",Rd),Y(this,"lastLevelChangedTime",Date.now()),Y(this,"levels",[]),Y(this,"longs",[]),Y(this,"longSpeechActivityScore",Rd),Y(this,"mediums",[]),Y(this,"mediumSpeechActivityScore",Rd),Y(this,"minLevel",0),Y(this,"nextMinLevel",0),Y(this,"nextMinLevelWindowLength",0),Y(this,"energyScore",0),this.id=e||"".concat(rQ++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const e=this.immediates,n=this.levels,r=this.minLevel+mR;let i=!1;for(let o=0;o<e.length;++o){let a=n[o];a<r&&(a=0);const d=Math.floor(a/mR);e[o]!==d&&(e[o]=d,i=!0)}return i}computeLongs(){return g1(this.mediums,this.longs,4)}computeMediums(){return g1(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=ER(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=ER(this.longs[0],10,47),this.longSpeechActivityScore>Rd&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=ER(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(ab(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let r=e;return e<0&&(r=0),e>iE&&(r=iE),this.levels.unshift(r),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(r),r>=this.minLevel+mR?r:r/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>iE&&(n=iE),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class iQ{constructor(e){Y(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{const n=this.algorithm.runInDecisionMaker(this);n<=0?e=!0:setTimeout(this.execute.bind(this),n)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class gR{constructor(e,n,r){Y(this,"isDominant",void 0),Y(this,"energyRanking",void 0),Y(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=n,this.energyScore=r}}class sQ extends _n{constructor(e){super(),Y(this,"dominantId",null),Y(this,"lastDecisionTime",0),Y(this,"lastLevelChangedTime",0),Y(this,"lastLevelIdleTime",0),Y(this,"relativeSpeechActivities",[]),Y(this,"speakers",new Map),Y(this,"enableSilence",!1),Y(this,"timeoutToSilenceInterval",0),Y(this,"decisionMaker",null),Y(this,"loudest",[]),Y(this,"numLoudestToTrack",3),Y(this,"energyExpireTimeMs",250),Y(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,n!=null&&(this.energyExpireTimeMs=n),r!=null&&(this.energyAlphaPct=r),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some(n=>n.id===e)}levelChanged(e,n){const r=Date.now(),i=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<r&&(this.lastLevelChangedTime=r,this.maybeStartDecisionMaker());const o=i.levelChanged(n,r);return this.updateLoudestList(i,o,r)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach(n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)})}removeSpeakers(e){e.forEach(n=>{this.speakers.delete(n.id)})}getOrCreateSpeaker(e){let n=this.speakers.get(e);return n||(n=new T1(e),this.speakers.set(e,n),this.maybeStartDecisionMaker()),n}updateLoudestList(e,n,r){const i=e.id===this.dominantId;if(n<0){let l=0;for(;l<this.loudest.length&&this.loudest[l]!==e;)++l;return new gR(i,l,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new gR(i,0,e.energyScore);const o=r-this.energyExpireTimeMs;let a=0;for(;a<this.loudest.length;){const l=this.loudest[a];if(l.getLastLevelChangedTime()<o&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(a,1);else if(l.id!==e.id)++a;else if(this.loudest.splice(a,1),this.loudest.length<this.numLoudestToTrack)break}let d=0;for(;d<this.loudest.length&&!(this.loudest[d].energyScore<e.energyScore);)++d;return d<this.numLoudestToTrack&&(this.loudest.splice(d,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new gR(i,d,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new iQ(this),this.decisionMaker.execute())}makeDecision(e){let n=null,r=null;const i=this.speakers.size;let o=null;if(i===0)o=null;else if(i===1){var a;const d=Vi(a=this.speakers).call(a).next().value;this.enableSilence&&d&&(o=d.id,d.evaluateSpeechActivityScores(e),e-d.lastNonSilence>this.timeoutToSilenceInterval&&(o=null))}else{let d=this.dominantId==null?null:this.speakers.get(this.dominantId);if(d==null){const f=this.speakers.entries().next();f.value&&(o=f.value[0],d=f.value[1])}else o=d.id;d!=null&&d.evaluateSpeechActivityScores(e);const l=this.relativeSpeechActivities;let h=2;for(const f of this.speakers.entries()){const[m,T]=f;if(T===d)continue;T.evaluateSpeechActivityScores(e);for(let C=0;C<l.length;++C){const N=d==null?Rd:d.getSpeechActivityScore(C);l[C]=Math.log(T.getSpeechActivityScore(C)/N)}const S=l[0],w=l[1],I=l[2];S>3&&w>2&&I>0&&w>h&&(h=w,o=m)}this.enableSilence&&d!=null&&o===d.id&&e-d.lastNonSilence>this.timeoutToSilenceInterval&&(o=null)}o==null&&!this.enableSilence||o===this.dominantId||(n=this.dominantId,this.dominantId=o,r=this.dominantId),r==null&&!this.enableSilence||r===n||this.emit("ActiveSpeakerChanged",r)}_runInDecisionMaker(){const e=Date.now(),n=300-(e-this.lastLevelIdleTime);let r=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):r=n;let i=300-(e-this.lastDecisionTime);return i<=0&&(this.lastDecisionTime=e,this.makeDecision(e),i=300-(Date.now()-e)),i>0&&r>i&&(r=i),r}timeoutIdleLevels(e){const n=[];for(const i of Vi(r=this.speakers).call(r)){var r;const o=e-i.getLastLevelChangedTime();36e5<o&&(this.dominantId==null||i.id!==this.dominantId)?n.push(i.id):300<o&&i.levelTimedOut()}n.forEach(i=>this.speakers.delete(i))}}const vu=new Map;let $s=null,oE=null;const S1=3;let Id=[];const Zs=new Map,aE=new Map;class oQ{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,n){Y(this,"id",void 0),Y(this,"track",void 0),Y(this,"score",0),Y(this,"active",!0),Y(this,"muted",!1),Y(this,"timer",0),Y(this,"actives",0),Y(this,"inactives",0),this.id=e,this.track=n,this.setActive(Zs.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const e=this.active;this.active=this.activeRate>=.8;const{actives:n,inactives:r}=function(){const i=[],o=[];return Array.from(Vi(Zs).call(Zs)).forEach(a=>{a.active?i.push(a):o.push(a)}),{actives:i,inactives:o}}();if(n.length>3){let i;n.forEach(o=>{(!i||i.score>o.score)&&(i=o)}),i&&i.setActive(!1)}if(n.length<3&&r.length>0){let i;r.forEach(o=>{(!i||i.score<o.score)&&o.id!==this.id&&(i=o)}),i&&e&&!this.active&&(i.samples>40&&i.activeRate-this.activeRate>.4?i.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const e=function(n){let r;return Array.from(Vi(Zs).call(Zs)).forEach(i=>{!i.active||i.id===n||i.samples<40||(!r||i.score<r.score)&&(r=i)}),r}(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const e=function(n){let r;return Array.from(Vi(Zs).call(Zs)).forEach(i=>{i.active||i.id===n||i.samples<40||(!r||i.score>r.score)&&(r=i)}),r}(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let cE;function v1(t){const e=Zs.get(t);e&&(Zs.delete(t),e.clearTimer())}const dE=new Map,aQ=new Map;function cQ(t,e,n){let r=new Uint8Array(t,e,n),i=[],o=0;for(;i.length<n;)o+3<n&&r[o]===0&&r[o+1]===0&&r[o+2]===3&&(r[o+3]===0||r[o+3]===1||r[o+3]===2||r[o+3]===3)?(i.push(r[o],r[o+1],r[o+3]),o+=4):(i.push(r[o]),o++);return new Uint8Array(i)}const lE=new Map,gp=new Map;(function(){const t=ve();pr.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),pr.getStreamFromExtension=t.name===Oe.CHROME&&Number(t.version)>34,pr.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n}(),pr.supportMinBitrate=t.name===Oe.CHROME||t.name===Oe.EDGE,pr.supportSetRtpSenderParameters=function(){const e=ve();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Ta()||!(!Sr()&&!Fm())||e.name===Oe.FIREFOX&&Number(e.version)>=64)}(),t.name===Oe.SAFARI&&(Number(t.version)>=14?pr.supportDualStream=!0:pr.supportDualStream=!1),pr.webAudioMediaStreamDest=function(){const e=ve();return!(e.name===Oe.SAFARI&&Number(e.version)<12)}(),pr.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",pr.supportWebGL=typeof WebGLRenderingContext<"u",pr.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ta()||(pr.webAudioWithAEC=!0),pr.supportShareAudio=function(){const e=ve();return(e.os===er.WIN_10||e.os===er.WIN_81||e.os===er.WIN_7||e.os===er.LINUX||e.os===er.MAC_OS||e.os===er.CHROMIUM_OS)&&e.name===Oe.CHROME&&Number(e.version)>=74}(),pr.supportDataChannel=!!(ap(76)||function(e){const n=ve();return!(n.name!==Oe.FIREFOX||!n.osVersion)&&Number(n.version)>=e}(68)||Ak(14)),pr.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!Tn()&&!!e&&e.prototype.setConfiguration instanceof Function}(),pr.supportWebRTCEncodedTransform=function(){const e=ve();return e.name==="Chrome"&&Number(e.version)>=87||e.name==="Safari"&&Number(e.version)>=15}(),pr.supportWebRTCInsertableStream=function(){const e=ve();return(e.name===Oe.CHROME||e.name===Oe.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),pr.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,pr.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,Gm(()=>{pr.supportDualStreamEncoding=function(){const e=ve();return!!M("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&M("CHROME_DUAL_STREAM_USE_ENCODING"))}(),v.debug("browser ua: ",navigator.userAgent),v.info("browser info: ",t),v.info("browser compatibility: ",pr)})})();const dQ=["CHINA","GLOBAL"],y1=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Cd=[],yu=[];function Ad(t,e){return!!e&&Cd.some(n=>n.uid===t&&n.channelName===e)}function TR(){return yu.length>0}var lQ=HP.forEach,R1=T_("forEach")?[].forEach:function(t){return lQ(this,t,arguments.length>1?arguments[1]:void 0)};Me({target:"Array",proto:!0,forced:[].forEach!=R1},{forEach:R1});var uQ=Es("Array").forEach,hQ=To,pQ=or,fQ=st,_Q=uQ,SR=Array.prototype,mQ={DOMTokenList:!0,NodeList:!0},EQ=function(t){var e=t.forEach;return t===SR||fQ(SR,t)&&e===SR.forEach||pQ(mQ,hQ(t))?_Q:e},gQ=_(EQ),TQ=gi,I1=R_;Me({target:"Object",stat:!0,forced:g(function(){I1(1)})},{keys:function(t){return I1(TQ(t))}});var C1=_(xr.Object.keys),SQ=_(ib),vQ=_(ob),yQ=Me,A1=Nh,RQ=M_,IQ=Ur,w1=B,CQ=Qn,AQ=Qi,wQ=H_,bQ=bn,OQ=U_,NQ=LP("slice"),PQ=bQ("species"),vR=Array,DQ=Math.max;yQ({target:"Array",proto:!0,forced:!NQ},{slice:function(t,e){var n,r,i,o=AQ(this),a=CQ(o),d=w1(t,a),l=w1(e===void 0?a:e,a);if(A1(o)&&(n=o.constructor,(RQ(n)&&(n===vR||A1(n.prototype))||IQ(n)&&(n=n[PQ])===null)&&(n=void 0),n===vR||n===void 0))return OQ(o,d,l);for(r=new(n===void 0?vR:n)(DQ(l-d,0)),i=0;d<l;d++,i++)d in o&&wQ(r,i,o[d]);return r.length=i,r}});var kQ=Es("Array").slice,LQ=st,MQ=kQ,yR=Array.prototype,UQ=function(t){var e=t.slice;return t===yR||LQ(yR,t)&&e===yR.slice?MQ:e},xQ=_(UQ);function Ct(t,e,n,r,i){var o,a,d,l={};return gQ(o=C1(r)).call(o,function(h){l[h]=r[h]}),l.enumerable=!!l.enumerable,l.configurable=!!l.configurable,("value"in l||l.initializer)&&(l.writable=!0),l=SQ(a=vQ(d=xQ(n).call(n)).call(d)).call(a,function(h,f){return f(t,e,h)||h},l),i&&l.initializer!==void 0&&(l.value=l.initializer?l.initializer.call(i):void 0,l.initializer=void 0),l.initializer===void 0&&(NP(t,e,l),l=null),l}let uE=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),RR=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),ws=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),ti=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),Ut=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),Qe=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),qt=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t}({}),Wt=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),Tp=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),ue=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),ei=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),Qt=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});function hE(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw v.error("Invalid Channel Name ".concat(t)),new z(D.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function pE(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||Lk(t,1,255)))throw new z(D.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&v.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ia=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({});const VQ={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},IR={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function CR(t,e){ur(t.url,"".concat(e,".url"),1,1e3,!1),Sn(t.x)||Ge(t.x,"".concat(e,".x"),0,1e4),Sn(t.y)||Ge(t.y,"".concat(e,".y"),0,1e4),Sn(t.width)||Ge(t.width,"".concat(e,".width"),0,1e4),Sn(t.height)||Ge(t.height,"".concat(e,".height"),0,1e4),Sn(t.zOrder)||Ge(t.zOrder,"".concat(e,".zOrder"),0,255),Sn(t.alpha)||Ge(t.alpha,"".concat(e,".alpha"),0,1,!1)}const FQ={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let fc=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),AR=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),Zn=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function b1(t){if(!t.channelName)throw new z(D.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new z(D.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&ur(t.token,"info.token",1,2047),pE(t.uid),hE(t.channelName),!0}let ni=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),Ca=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),vi=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),Ru=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),Ue=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),ar=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t.UPDATE_GATEWAY_CONFIG="update-gateway-config",t}({}),fE=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),rr=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),Ne=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({});const O1=[Ne.AFRICA,Ne.ASIA,Ne.CHINA,Ne.EUROPE,Ne.GLOBAL,Ne.INDIA,Ne.JAPAN,Ne.NORTH_AMERICA,Ne.OCEANIA,Ne.OVERSEA,Ne.SOUTH_AMERICA];let Nr=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({});const _E={CHINA:{},ASIA:{CODE:Nr.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Nr.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Nr.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Nr.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Nr.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Nr.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Nr.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Nr.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Nr.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Nr.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Nr.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Nr.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Nr.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Yy&&(_E.CHINA={CODE:Nr.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Sp=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",t}({});function N1(t){return!!t&&!(!t.uplink||!t.id)&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0}class P1 extends _n{constructor(e,n){super(),b(this,"onICEConnectionStateChange",void 0),b(this,"onConnectionStateChange",void 0),b(this,"onDTLSTransportStateChange",void 0),b(this,"onDTLSTransportError",void 0),b(this,"onICETransportStateChange",void 0),b(this,"onFirstAudioReceived",void 0),b(this,"onFirstVideoReceived",void 0),b(this,"onFirstAudioDecoded",void 0),b(this,"onFirstVideoDecoded",void 0),b(this,"onFirstVideoDecodedTimeout",void 0),b(this,"onSelectedLocalCandidateChanged",void 0),b(this,"onSelectedRemoteCandidateChanged",void 0),b(this,"onICECandidateError",void 0),b(this,"getLocalVideoStats",void 0)}}class D1 extends P1{constructor(e,n){super(e,n),b(this,"establishPromise",void 0)}}let vt=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),Pr=function(t){return t.UDP_RELAY="udp_relay",t.UDP_TCP_RELAY="udp_tcp_relay",t.TCP_RELAY="tcp_relay",t.RELAY="relay",t}({}),Aa=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.TCP_RESTART=3]="TCP_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({});const k1=["disconnected","failed"];let at=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),Le=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),Mt=function(t){return t.AudioMetadata="audioMetadata",t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),bs=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Os=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),cr=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),L1=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),Po=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),as=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),to=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Iu=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),Ln=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),Cu=function(t){return t.ABORT="abort",t}({}),_c=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),BQ=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({});const jQ={[uE.ACCESS_POINT]:{[ti.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[ti.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[ti.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[ti.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[ti.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[ti.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[ti.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[uE.UNILBS]:{[ws.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ws.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ws.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ws.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ws.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ws.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ws.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ws.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ws.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ws.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ws.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ws.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[uE.STRING_UID_ALLOCATOR]:{[RR.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[RR.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[RR.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Au(t){const e=jQ[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};const n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===uE.ACCESS_POINT){const r=t%1e4;if(r.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(r.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const GQ={[Ut.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Ut.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Ut.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Ut.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Ut.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Ut.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Ut.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Ut.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Ut.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Ut.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Ut.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Ut.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Ut.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Ut.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Ut.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Ut.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Ut.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Ut.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Ut.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Ut.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Ut.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Ut.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Ut.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Ut.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Ut.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Ut.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Ut.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Ut.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Ut.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Ut.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Ut.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Ut.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Ut.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Ut.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Ut.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Ut.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Ut.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Ut.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Ut.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Ut.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Ut.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Ut.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ut.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ut.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Ut.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Ut.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Ut.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Ut.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Ut.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Ut.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Ut.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Ut.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Ut.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Ut.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Ut.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Ut.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Ut.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Ut.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Ut.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Ut.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Ut.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Ut.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Ut.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Ut.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function vp(t){return GQ[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function M1(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function wR(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?M1(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):M1(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function U1(t,e){if(typeof t=="string")return t;const{proxy:n,host:r,port:i}=t;if(e){const o=M("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(r,"/ws/?p=").concat(Number(i)+150):"wss://".concat(r,":").concat(o,"/ws/?p=").concat(Number(i)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(r,"&p=").concat(i):"wss://".concat(r,":").concat(i)}const WQ=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,HQ=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,KQ=/wss:\/\/(.+):([0-9]+)\/?/,qQ=/wss:\/\/(.[^\/]+)\/?/;let YQ=0;class zQ{constructor(e,n){b(this,"id",0),b(this,"store",void 0),b(this,"recordIndex",void 0),b(this,"websockets",[]),b(this,"try443PortDuration",2e3),b(this,"forceCloseWSDuration",5e3),b(this,"try443PortTimeout",null),b(this,"forceCloseTimeout",null),b(this,"isTry443PortFailed",!1),b(this,"isNormalPortFailed",!1),b(this,"useDoubleDomain",!1),b(this,"useProxy",!1),b(this,"startTime",Date.now()),this.id=++YQ,this.try443PortDuration=M("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;const n=Date.now()-this.startTime;for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];v.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...i)}createWebSocket(e,n,r){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:r});const i=M("GATEWAY_DOMAINS"),o=Date.now(),a=[],d=i.find(T=>{var S;return ft(S=e.host).call(S,T)});d||(this.useDoubleDomain=!1);const l=[];if(this.useDoubleDomain)i.forEach(T=>{l.push(U1(wR(wR({},e),{},{host:e.host.replace(d,T)}),n))});else{const T=wR({},e);if(n&&d){const S=i.find(w=>w!==d);S&&(T.host=T.host.replace(d,S))}l.push(U1(T,n))}try{l.forEach(T=>{const S=new WebSocket(T);S.binaryType="arraybuffer",a.push(S),this.logger("ws is connecting:",S.url)})}catch(T){if(this.logger("ws create failed"),a.forEach(S=>S.close()),a.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,r);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,r);throw new z(D.WS_ERR,"init websocket failed! Error: ".concat(T.toString()))}const h=op();this.store&&this.store.recordJoinChannelService({urls:a.map(T=>T.url),service:"gateway"},this.recordIndex),a.forEach(T=>{T.onopen=()=>{this.logger("onopen: ws ".concat(T.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(S=>{S!==T&&(S.onopen=null,S.onclose=null,S.onmessage=null,S.close(),this.logger("close backup websocket: ".concat(S.url)))}),this.websockets.length=0,h.resolve(T)},T.onclose=S=>{this.logger("onclose: ws ".concat(T.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(T.readyState));const w=a.every(I=>I.readyState===WebSocket.CLOSED||I.readyState===WebSocket.CLOSING);this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(w)),w&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(S.reason)),h.reject({code:S.code,reason:fE.A_ROUND_WS_FAILED})):!n&&w&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),m()),n?this.isTry443PortFailed=w:this.isNormalPortFailed=w},T.onmessage=S=>this.logger("".concat(T.url," onmessage: ").concat(S.data))}),this.websockets.push(...a);const f=()=>{this.websockets.forEach(T=>T.readyState!==WebSocket.OPEN&&T.close())},m=()=>{if(h.isResolved)return f();ve().os===er.MAC_OS&&Tn()&&f(),this.createWebSocket(e,!0,!0).then(T=>{h.resolve(T)}).catch(T=>{this.isNormalPortFailed&&h.reject(T),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",h.isResolved),this.forceCloseTimeout=null,f()},this.forceCloseWSDuration)};return r||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,f()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",h.isResolved),this.try443PortTimeout=null,m()},this.try443PortDuration)})(),h.promise}chooseBestWebsocket(e,n,r,i){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=function(o){let a,d,l;return[,a,d,l]=o.match(WQ)||[],a||([,d,l]=o.match(HQ)||[]),d&&l||([,d,l]=o.match(KQ)||[]),d&&l||([,d]=o.match(qQ)||[]),d||v.warning("un-destructible url: ",o),{proxy:a,host:d,port:l||"443"}}(e)),this.recordIndex=i,this.useProxy=!!e.proxy,r&&this.useProxy&&(v.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(e,!!r,!1).finally(()=>this.clearTimeout())}}function x1(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}class V1 extends _n{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;ft(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Qt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Qt.CONNECTED):this._state==="closed"?this.emit(Qt.CLOSED):this._state==="failed"&&this.emit(Qt.FAILED))}resetReconnectCount(e){v.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],a=arguments.length>5?arguments[5]:void 0;super(),b(this,"connectionID",0),b(this,"currentURLIndex",0),b(this,"urls",[]),b(this,"_reconnectMode","tryNext"),b(this,"reconnectReason",void 0),b(this,"_initMutex",void 0),b(this,"name",void 0),b(this,"_state","closed"),b(this,"reconnectInterrupter",void 0),b(this,"websocket",void 0),b(this,"retryConfig",void 0),b(this,"reconnectCount",0),b(this,"forceCloseTimeout",5e3),b(this,"onlineReconnectListener",void 0),b(this,"useCompress",void 0),b(this,"tryDoubleDomain",!1),b(this,"use443PortOnly",!1),b(this,"wsInflateLength",0),b(this,"wsDeflateLength",0),b(this,"closeEstablishingWs",()=>{}),b(this,"store",void 0),b(this,"joinGatewayRecordIndex",void 0),this.store=a,this.name=e,this.retryConfig=function(m){for(var T=1;T<arguments.length;T++){var S=arguments[T]!=null?arguments[T]:{};T%2?x1(Object(S),!0).forEach(function(w){b(m,w,S[w])}):Object.getOwnPropertyDescriptors?Object.defineProperties(m,Object.getOwnPropertyDescriptors(S)):x1(Object(S)).forEach(function(w){Object.defineProperty(m,w,Object.getOwnPropertyDescriptor(S,w))})}return m}({},n),this.useCompress=r,this.tryDoubleDomain=i,this.use443PortOnly=o,this._initMutex=new Or("websocket",a?a.clientId:void 0);const{timeout:d,timeoutFactor:l}=n,h=Math.max(300,Math.floor(3*d/5)),f=Math.max(1.2,Math.floor(8*l)/10);ki.ONLINE&&(this.retryConfig.timeout=h,this.retryConfig.timeoutFactor=f),Fn.on(su.NETWORK_STATE_CHANGE,(m,T)=>{m!==T&&(this.resetReconnectCount("network state change: ".concat(T," -> ").concat(m)),m===ki.ONLINE?(this.retryConfig.timeout=h,this.retryConfig.timeoutFactor=f):(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l))})}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const r=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{const i=op(),o=this.urls[this.currentURLIndex];M("ENABLE_PREALLOC_PC")&&this.emit(L1.PRE_CONNECT_PC),this.createWebSocketConnection(o).then(i.resolve).catch(i.reject),this.once(Qt.CLOSED,()=>{i.reject(new et(D.WS_DISCONNECT))}),this.once(Qt.CONNECTED,i.resolve),await i.promise}catch{}finally{r()}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const r=this.websocket;n?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void v.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),v.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new et(D.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(r){throw new et(D.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var n;const r=op();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const i=f=>{var m;(m=this.store)===null||m===void 0||m.signalChannelOpen(),v.debug("[".concat(this.name,"] websocket opened:"),f),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),r.resolve()},o=async f=>{var m;if(v.debug("[".concat(this.name,"] websocket close ").concat((m=this.websocket)===null||m===void 0?void 0:m.url,", code: ").concat(f.code,", reason: ").concat(f.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)r.reject(new et(D.WS_DISCONNECT,"websocket close: ".concat(f.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=f.reason,this.state="reconnecting");const T=Bi(this,Qt.WILL_RECONNECT,this.reconnectMode,f.reason)||this.reconnectMode,S=await this.reconnectWithAction(T);if(this.state==="closed")return void v.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!S)return r.reject(new et(D.WS_DISCONNECT,"websocket reconnect failed: ".concat(f.code))),this.close(!0);r.resolve()}},a=f=>{this.emit(Qt.ON_MESSAGE,f)},d=f=>{v.warn("[".concat(this.connectionID,"] ws open error ").concat(f))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),M("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=M("GATEWAY_WSS_ADDRESS")),v.debug("[".concat(this.name,"] start connect, url:"),e);const l=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var h;const f=await this.chooseBestWebsocketConnection(e);this.websocket=f,i&&i(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=a,this.websocket.onerror=d,(h=this.store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},l),this.joinGatewayRecordIndex=l}catch(f){const m=this.state==="closed",T=f instanceof et,S=T&&f.code===D.WS_ABORT,w=T&&f.code===D.WS_ERR,I=T?f.message:f&&(f.reason||f.toString());v.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(I)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:S?"aborted":"error",errors:[f]},l),m||w?(r.reject(m?new et(D.WS_DISCONNECT,"websocket is closed: ".concat(I)):new et(D.WS_ERR,"init websocket failed: ".concat(I))),w&&v.error("[".concat(this.name,"] init websocket failed: ").concat(I))):o&&o(f)}return r.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;v.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Fn.isOnline||!Fn.onlineWaiter||(this.onlineReconnectListener=Fn.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,n){const a=Fy(this.reconnectCount,this.retryConfig);v.debug("[".concat(this.name,"] wait ").concat(a,"ms to reconnect websocket, mode: ").concat(e)),await mt.race([hr(a),this.onlineReconnectListener||new mt(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;const i=async(a,d)=>{this.emit(Qt.RECONNECT_CREATE_CONNECTION,d),await this.createWebSocketConnection(a)};try{if(e==="retry")await i(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);v.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await i(this.urls[this.currentURLIndex],e)}else e==="recover"&&(v.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await yr(this,Qt.REQUEST_NEW_URLS),this.currentURLIndex=0,await i(this.urls[this.currentURLIndex],e))}catch(a){var o;v.error("[".concat(this.name,"] reconnect failed ").concat(a&&a.toString()));const d=a==null||(o=a.data)===null||o===void 0?void 0:o.desc;return Array.isArray(d)&&ft(d).call(d,"dynamic key expired")?(this.emit(Qt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,n)}return!0}}class bR extends V1{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){const r=op(),i=function(a,d){return new zQ(a,d)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{v.debug("[choose-best-ws] close establishing websockets"),i.closeAllWebsockets(),r.reject(new et(D.WS_ABORT,"choose best websocket aborted"))};const o=M("GATEWAY_DOMAINS");return v.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),i.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(r.resolve).catch(r.reject),r.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class yp extends V1{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){return new mt((r,i)=>{let o=!1;const a=[];this.closeEstablishingWs=()=>{v.debug("[choose-best-ws] close establishing websockets"),a.forEach(w=>{w.onclose=null,w.onopen=null,w.onmessage=null,w.close()}),i(new et(D.WS_ABORT,"choose best websocket aborted"))};const d=M("GATEWAY_DOMAINS");let l;const h=e.indexOf("?h="),f=d.find(w=>h!==-1?ft(e).call(e,w,h):ft(e).call(e,w));v.debug("[choose-best-ws] currentDomain: ",f,", domains: ",d);let m=!this.tryDoubleDomain||!f;if(!m&&f){var T;const w=Date.now();try{d.forEach(I=>{const C=h===-1?e.replace(f,I):e.substr(0,h)+e.substr(h).replace(f,I),N=new WebSocket(C);N.binaryType="arraybuffer",a.push(N),v.debug("[choose-best-ws] ws is connecting:",N.url)})}catch{for(v.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach(C=>C.close());a.length;)a.pop();m=!0}(T=this.store)===null||T===void 0||T.recordJoinChannelService({urls:a.map(I=>I.url),service:"gateway"},n),a.forEach(I=>{I.onopen=()=>{if(o)return;const C=Date.now()-w;v.debug("[choose-best-ws] ws open cost ".concat(C,"ms")),a.filter(N=>N!==I).forEach(N=>{v.debug("[choose-best-ws]close backup websocket: ".concat(N.url)),N.close()}),o=!0,r(I)},I.onclose=C=>{l=C,!o&&(a.find(N=>!(N.readyState===WebSocket.CLOSED||N.readyState===WebSocket.CLOSING))||(v.debug("[choose-best-ws] all websocket is closed"),o=!0,i(l)))},I.onmessage=C=>{v.debug("[choose-best-ws]".concat(I.url," onmessage: ").concat(C.data))}}),hr(this.forceCloseTimeout).then(()=>{a.forEach(I=>{I.readyState!==WebSocket.OPEN&&I.close()})})}if(m){var S;let w;v.debug("[choose-best-ws] use single url: ",e),(S=this.store)===null||S===void 0||S.recordJoinChannelService({urls:[e],service:"gateway"},n);try{w=new WebSocket(e),a.push(w),w.binaryType="arraybuffer"}catch(I){const C=new et(D.WS_ERR,"init websocket failed! Error: ".concat(I.toString()));return v.error("[".concat(this.name,"]").concat(C)),void i(C)}w.onopen=()=>{r(w)},w.onclose=I=>{i(I)},w.onmessage=I=>{v.debug("[choose-best-ws]".concat(w.url," onmessage: ").concat(I.data))},hr(this.forceCloseTimeout).then(()=>{w&&w.readyState!==WebSocket.OPEN&&w.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class JQ extends _n{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Qe.CONNECTED?this.emit(qt.WS_CONNECTED):e===Qe.RECONNECTING?this.emit(qt.WS_RECONNECTING,this._websocketReconnectReason):e===Qe.CLOSED&&this.emit(qt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),b(this,"_disconnectedReason",void 0),b(this,"_websocketReconnectReason",void 0),b(this,"_connectionState",Qe.CLOSED),b(this,"reconnectToken",void 0),b(this,"websocket",void 0),b(this,"openConnectionTime",void 0),b(this,"clientId",void 0),b(this,"lastMsgTime",Date.now()),b(this,"uploadCache",[]),b(this,"uploadCacheInterval",void 0),b(this,"rttRolling",new Xk(5)),b(this,"pingpongTimer",void 0),b(this,"wsInflateDataTimer",void 0),b(this,"pingpongTimeoutCount",0),b(this,"joinResponse",void 0),b(this,"multiIpOption",void 0),b(this,"initError",void 0),b(this,"spec",void 0),b(this,"store",void 0),b(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(qt.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){if(this.emit(i._type,i._message),i._type===ue.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===ue.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(ke.UID_BANNED);break;case 15:this.close(ke.IP_BANNED);break;case 16:this.close(ke.CHANNEL_BANNED)}if(i._type===ue.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case Ut.ERR_LICENSE_MISSING:this.close(ke.LICENSE_MISSING);break;case Ut.ERR_LICENSE_EXPIRED:this.close(ke.LICENSE_EXPIRED);break;case Ut.ERR_LICENSE_MINUTES_EXCEEDED:this.close(ke.LICENSE_MINUTES_EXCEEDED);break;case Ut.ERR_LICENSE_PERIOD_INVALID:this.close(ke.LICENSE_PERIOD_INVALID);break;case Ut.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(ke.LICENSE_MULTIPLE_SDK_SERVICE);break;case Ut.ERR_LICENSE_ILLEGAL:this.close(ke.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new bR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,M("JOIN_GATEWAY_USE_DUAL_DOMAIN"),M("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Qe.CONNECTED&&this.reconnect("retry",vr.OFFLINE)})}async request(e,n,r,i){const o=ze(6,""),a={_id:o,_type:e,_message:n},d=this.websocket.connectionID,l=()=>new mt((w,I)=>{if(this.connectionState===Qe.CONNECTED)return w();const C=()=>{this.off(qt.WS_CLOSED,N),w()},N=()=>{this.off(qt.WS_CONNECTED,C),I(new z(D.WS_ABORT))};this.once(qt.WS_CONNECTED,C),this.once(qt.WS_CLOSED,N),e!==Wt.PUBLISH&&e!==Wt.PUBLISH_DATASTREAM&&e!==Wt.SUBSCRIBE&&e!==Wt.SUBSCRIBE_DATASTREAM&&e!==Wt.UNSUBSCRIBE&&e!==Wt.UNSUBSCRIBE_DATASTREAM&&e!==Wt.UNPUBLISH&&e!==Wt.UNPUBLISH_DATASTREAM&&e!==Wt.CONTROL&&e!==Wt.RESTART_ICE||this.once(qt.DISCONNECT_P2P,()=>{I(new z(D.DISCONNECT_P2P))}),e!==Wt.PUBLISH&&e!==Wt.RESTART_ICE||this.once(qt.ABORT_P2P_EXECUTION,()=>{I(new z(D.DISCONNECT_P2P))})});if(this.connectionState!==Qe.CONNECTING&&this.connectionState!==Qe.RECONNECTING||e===Wt.JOIN||e===Wt.REJOIN||await l(),this.websocket.sendMessage(a,!0),i)return;const h=new mt((w,I)=>{let C=!1;const N=(x,W)=>{C=!0,w({isSuccess:x==="success",message:W||{}}),this.off(qt.WS_CLOSED,P),this.off(qt.WS_RECONNECTING,P),this.emit(qt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),N);const P=()=>{I(new z(D.WS_ABORT,"type: ".concat(e))),this.off(qt.WS_CLOSED,P),this.off(qt.WS_RECONNECTING,P),this.off("res-@".concat(o),N)};this.once(qt.WS_CLOSED,P),this.once(qt.WS_RECONNECTING,P),hr(M("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==d||C||(v.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(qt.REQUEST_TIMEOUT,e,n))})});let f=null;try{f=await h}catch(w){if(this.connectionState===Qe.CLOSED||e===Wt.LEAVE)throw new z(D.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?w.throw():e===Wt.JOIN||e===Wt.REJOIN?null:(await l(),await this.request(e,n))}if(f.isSuccess)return f.message;const m=Number(f.message.error_code||f.message.code),T=vp(m),S=new z(D.UNEXPECTED_RESPONSE,"".concat(T.desc,": ").concat(f.message.error_str),{code:m,data:f.message,desc:T.desc});return T.action==="success"?f.message:(v.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(m,", message: ").concat(T.desc,", action: ").concat(T.action)),m===Ut.ERR_TOO_MANY_BROADCASTERS?((e===Wt.JOIN||e===Wt.REJOIN)&&(this.initError=S,this.close()),S.throw()):T.action==="failed"?S.throw():T.action==="quit"?(this.initError=S,this.close(),S.throw()):(m===Ut.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=f.message.option,v.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",vr.MULTI_IP)):this.reconnect(T.action,vr.SERVER_ERROR),e===Wt.JOIN||e===Wt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new mt(r=>{const i=o=>{(!n||n(o))&&(this.off(e,i),r(o))};this.on(e,i)})}uploadWRTCStats(e){if(!this.store.sessionId)return void v.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Tp.WRTC_STATS,n)}upload(e,n){const r={_type:e,_message:n};try{this.websocket.sendMessage(r)}catch{const o=M("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Qe.CONNECTED)return;const a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},M("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const r={_type:e,_message:n};this.websocket.sendMessage(r)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new mt((n,r)=>{this.once(qt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(qt.WS_CLOSED,i=>r(this.initError||new z(D.WS_ABORT,i))),this.connectionState=Qe.CONNECTING,this.websocket.init(e).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||ke.LEAVE,this.connectionState=Qe.CLOSED,v.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(qt.ABORT_P2P_EXECUTION);const e=await yr(this,qt.REQUEST_JOIN_INFO),n=await this.request(Wt.JOIN,e);if(!n)return this.emit(qt.REPORT_JOIN_GATEWAY,fE.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(qt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Qe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new z(D.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=hp(this,qt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(Wt.REJOIN,e);return!!n&&(this.connectionState=Qe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(r=>{this.emit(ue.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(ue.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(ue.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(ue.MUTE_AUDIO,{uid:r.uid}):this.emit(ue.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(ue.MUTE_VIDEO,{uid:r.uid}):this.emit(ue.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(ue.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(ue.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(ue.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(ue.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(ue.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){v.debug("[".concat(this.clientId,"] receive notification: "),e);const n=vp(e.code);if(e.code===28&&"detail"in e&&(v.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(qt.RECOVER_NOTIFICATION,e.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(ke.UID_BANNED),void this.close()):void this.reconnect(n.action,vr.SERVER_ERROR);v.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=M("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(v.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>M("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",vr.TIMEOUT):this.request(Wt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),M("REPORT_STATS")&&this.send(Wt.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(Tp.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Qt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(qt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Qt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Qt.CLOSED,()=>{this.connectionState=Qe.CLOSED}),this.websocket.on(Qt.FAILED,()=>{this._disconnectedReason=ke.NETWORK_ERROR,this.connectionState=Qe.CLOSED}),this.websocket.on(Qt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Qe.CONNECTED?this.connectionState=Qe.RECONNECTING:this.connectionState=Qe.CONNECTING}),this.websocket.on(Qt.WILL_RECONNECT,(e,n,r)=>{const i=hp(this,qt.IS_P2P_DISCONNECTED),o=i||e!=="retry";i&&e==="retry"&&(v.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=fE.P2P_DISCONNECTED),o&&(v.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(qt.REPORT_JOIN_GATEWAY,n||fE.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(qt.DISCONNECT_P2P)),r(e)}),this.websocket.on(Qt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{v.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",vr.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(qt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof z){if(e.code===D.UNEXPECTED_RESPONSE&&e.data.code===Ut.ERR_NO_AUTHORIZED)return this.initError=new z(D.TOKEN_EXPIRE,"dynamic key expired"),void this.close(ke.TOKEN_EXPIRE);v.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",vr.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(Qt.REQUEST_NEW_URLS,(e,n)=>{yr(this,qt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Qt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(L1.PRE_CONNECT_PC,()=>{this.emit(qt.PRE_CONNECT_PC)})}}let XQ=function(t){return t.NATIVE_RTC="native_rtc",t.NATIVE_RTM="native_rtm",t.WEB_RTC="web_rtc",t.WEB_RTM="web_rtm",t}({}),Bn=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function F1(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function mE(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?F1(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):F1(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function mc(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(M("TURN_DOMAIN")):(v.debug("Cannot recognized as ip address: ".concat(t,", use as host")),t)}function OR(t,e){t.addresses||(t.addresses=[]);const n=function(d,l){if(M("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return d.map(m=>{let{ip:T,port:S}=m;return{address:"".concat(T,":").concat(S)}});const h=M("GATEWAY_DOMAINS");let f=h[1]&&ft(l).call(l,h[1])?1:0;return d.map(m=>{let{domain_prefix:T,port:S,ip:w}=m;if(T)return{address:"".concat(T,".").concat(h[f++%h.length],":").concat(S)};const I=/^[\.\:\d]+$/.test(w),C=I?"".concat(w.replace(/[^\d]/g,"-"),".").concat(h[f++%h.length],":").concat(S):"".concat(w,":").concat(S);return I||v.debug("Cannot recognized as ip address: ".concat(w,", use as host")),{ip:w,port:S,address:C}})}(t.addresses,e),r=Array.isArray(t.detail)&&t.detail[18];if(r&&typeof r=="string"){const d=r.split(";");for(let l=0;l<d.length;l++){var i;const h=Br(i=d[l]).call(i);n[l]&&h&&(n[l].ip6=h)}}const o=t.detail&&t.detail.candidate;let a;if(o){const[d,l]=o.split(":");d&&l&&(a={port:Number(l),ip:d,address:"".concat(d,":").concat(l)})}return{gatewayAddrs:n,apGatewayAddress:a,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Li(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function B1(t){const e=t._encoderConfig;if(!e)return{};const n={resolution:e.width&&e.height?"".concat(Li(e.width),"x").concat(Li(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function j1(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function Rp(t,e){let n,r,i;switch(e){case Bn.CHOOSE_SERVER:r=4096,i="choose server";break;case Bn.CLOUD_PROXY:r=1048576,i="proxy";break;case Bn.CLOUD_PROXY_5:r=4194304,i="proxy5";break;case Bn.CLOUD_PROXY_FALLBACK:r=4194310,i="proxy fallback";break;default:throw new z(D.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===r&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(a=>mE(mE({},a),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:mE(mE({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!n)throw new z(D.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(i," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}async function G1(t,e){return await mt.all(t.addresses.map(async n=>({address:M("USE_TURN_IP")?n.ip:mc(n.ip),tcpport:n.port,udpport:n.port,username:e&&M("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Rr.username,password:e&&M("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await My(e.toString()):Rr.password})))}function NR(t,e){const n=e.getMediaStreamTrack(!0).getSettings(),r=e.videoHeight||n.height,i=e.videoWidth||n.width;return r&&i?Math.max(Math.min(r,i)/Math.min(Li(t.height),Li(t.width)),1):(v.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Ec(t){let{candidateType:e,relayProtocol:n,type:r,address:i,port:o,protocol:a}=t;const d={candidateType:e,relayProtocol:n,protocol:a};if(r!=="local-candidate"){const l=i.split(".");l.length>=4&&(l[1]="*",l[2]="*"),d.address=l.join("."),d.port=o}return d}function EE(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:M("SVC_MODE");if(M("ENABLE_SVC"))return function(e){return e in qm}(t)?t:qm.L1T3}const W1={[vt.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[vt.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function gE(t,e,n){e.forEach(r=>{var i;const o=W1[t].find(d=>{var l;let{key:h}=d;return ft(l=r.extensionName).call(l,h)});if(!o)return;const a=n.find(d=>{let{extensionName:l}=d;return ft(l).call(l,o.key)});a&&ft(i=a.extensionName).call(i,"gdpr_forbidden")&&(r.extensionName=a.extensionName)})}function wu(t,e){e.forEach(n=>{var r;const i=W1[t].find(o=>{var a;let{key:d}=o;return ft(a=n.extensionName).call(a,d)});ft(r=n.extensionName).call(r,"gdpr_forbidden")&&i&&(n.extensionName=i.extensionName)})}function H1(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||ft(t).call(t,"abs-send-time")}function TE(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||ft(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function K1(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function q1(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?K1(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):K1(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Ip(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;const{filterRTX:i,filterVideoFec:o,filterAudioFec:a,filterAudioCodec:d,filterVideoCodec:l}=e,{useXR:h}=n;let f=[],m=[],T=[],S=[],w=!1,I=!1;if(Si(t).mediaDescriptions.forEach(N=>{r&&r!==N.attributes.direction||(N.media.mediaType!=="video"||w||(m=N.attributes.payloads,S=N.attributes.extmaps,w=!0),N.media.mediaType!=="audio"||I||(f=N.attributes.payloads,T=N.attributes.extmaps,I=!0))}),!S||m.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!T||f.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(m.forEach(N=>{var P;(P=N.rtpMap)!==null&&P!==void 0&&P.clockRate&&(N.rtpMap.clockRate=parseInt(N.rtpMap.clockRate)),h&&N.rtcpFeedbacks.push({type:"rrtr"})}),f.forEach(N=>{var P;(P=N.rtpMap)!==null&&P!==void 0&&P.clockRate&&(N.rtpMap.clockRate=parseInt(N.rtpMap.clockRate)),h&&N.rtcpFeedbacks.push({type:"rrtr"})}),i&&(f=f.filter(N=>{var P;return((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())!=="rtx"}),m=m.filter(N=>{var P;return((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())!=="rtx"})),o&&(m=m.filter(N=>{var P;return!/(red)|(ulpfec)|(flexfec)/i.test(((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName)||"")})),a&&(f=f.filter(N=>{var P;return!/(red)|(ulpfec)|(flexfec)/i.test(((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName)||"")})),d&&(d==null?void 0:d.length)>0&&(f=f.filter(N=>{var P;return ft(d).call(d,((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())||"")})),l&&(l==null?void 0:l.length)>0){const N=m.filter(P=>{var x;return ft(l).call(l,((x=P.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())||"")});m=N.concat(i?[]:kR(N,m))}const C=M("UNSUPPORTED_VIDEO_CODEC");return C&&C.length>0&&(m=m.filter(N=>!(N.rtpMap&&ft(C).call(C,N.rtpMap.encodingName.toLowerCase())))),{audioCodecs:f,videoCodecs:m,audioExtensions:T,videoExtensions:S}}function gc(t){const e=Si(t);let n,r;for(const i of e.mediaDescriptions){if(!n){const o=i.attributes.iceUfrag,a=i.attributes.icePwd;if(!o||!a)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:a}}if(!r){const o=i.attributes.fingerprints;o.length>0&&(r={fingerprints:o})}}if(!r&&e.attributes.fingerprints.length>0&&(r={fingerprints:e.attributes.fingerprints}),!r||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:r}}function Y1(t,e){const n=[],r=t.attributes.ssrcGroups.filter(a=>a.semantic==="FID"),i=t.attributes.ssrcGroups.find(a=>a.semantic==="SIM"),o=t.attributes.ssrcs;if(i)i.ssrcIds.forEach(a=>{var d;const l=(d=r.find(h=>h.ssrcIds[0]===a))===null||d===void 0?void 0:d.ssrcIds[1];n.push({ssrcId:a,rtx:e?l:void 0})});else if(r.length>0){const a=r[0].ssrcIds[0],d=r[0].ssrcIds[1];n.push({ssrcId:a,rtx:e?d:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function z1(t,e,n){const{cname:r}=t;let i=[];e&&(i=J1(e)),i.length===0&&(i=t.iceParameters.candidates.map(f=>({foundation:f.foundation,componentId:"1",transport:f.protocol,priority:f.priority.toString(),connectionAddress:f.ip,port:f.port.toString(),type:f.type,extension:{}})),v.debug("Using candidates from gateway."));const o={fingerprints:t.dtlsParameters.fingerprints.map(f=>({hashFunction:f.algorithm,fingerprint:f.fingerprint}))},a={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let d;switch(t.dtlsParameters.role){case"server":d="passive";break;case"client":d="active";break;case"auto":d="actpass"}const l=vE(t.rtpCapabilities),h=[];return Array.isArray(n)&&n.length>0&&n.forEach(f=>{h.push({kind:vt.VIDEO,ssrcId:f.v,rtx:f.v_rtx,mslabel:"".concat(f.v,"_").concat(f.a)},{kind:vt.AUDIO,ssrcId:f.a,mslabel:"".concat(f.v,"_").concat(f.a)})}),{dtlsParameters:o,iceParameters:a,candidates:i,rtpCapabilities:l,setup:d,cname:r,preSSRCs:h}}function J1(t){let e=[];return t.ip&&typeof t.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],v.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),v.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))),e}function wd(t,e,n){const r=[],i=[];return t.forEach(o=>{let{ssrcId:a,rtx:d}=o;const l=ze(8,"track-"),h={ssrcId:a,attributes:q1({label:l,mslabel:n=n||ze(10,""),msid:"".concat(n," ").concat(l)},e&&{cname:e})};if(r.push(h),d!==void 0){const f={ssrcId:d,attributes:q1({label:l,mslabel:n,msid:"".concat(n," ").concat(l)},e&&{cname:e})};r.push(f),i.push({semantic:"FID",ssrcIds:[a,d]})}}),t.length>1&&i.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:a}=o;return a})}),{ssrcs:r,ssrcGroups:i}}function bu(t,e){e instanceof In&&t.attributes.payloads.forEach(n=>{var r;const i=(r=n.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase();if(!i||["opus","pcmu","pcma","g722"].indexOf(i)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const o=e._encoderConfig;o&&i!=="pcmu"&&i!=="pcma"&&i!=="g722"&&(o.bitrate&&!Tn()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"))})}function PR(t){const e=t.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function DR(t,e){var n;if(!(e instanceof en&&e._encoderConfig&&e._hints.indexOf(Je.SCREEN_TRACK)===-1))return;const r=e._encoderConfig;Ie().supportMinBitrate&&r.bitrateMin&&t.attributes.payloads.forEach(i=>{var o,a;ft(o=["h264","h265","vp8","vp9","av1"]).call(o,((a=i.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),Ie().supportMinBitrate&&!ft(n=e._hints).call(n,Je.LOW_STREAM)&&r.bitrateMax&&t.attributes.payloads.forEach(i=>{var o,a;ft(o=["h264","h265","vp8","vp9","av1"]).call(o,((a=i.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-start-bitrate"]="".concat(M("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function X1(t){if(t.media.mediaType!=="video")return;const e=ve();if(e.name!==Oe.SAFARI&&e.os!==er.IOS)return;const n=t.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));n!==-1&&t.attributes.extmaps.splice(n,1)}function SE(t,e,n){if(!e)return;let r,i;if(t.media.mediaType==="video"?(r=n.videoExtensions,i=n.videoCodecs):(r=n.audioExtensions,i=n.audioCodecs),e.twcc===!0){const o=r.find(a=>TE(a.extensionName));if(o){const a=o.extensionName;t.attributes.extmaps.find(l=>TE(l.extensionName))||t.attributes.extmaps.push({entry:o.entry,extensionName:a}),function(l,h){return h.filter(f=>!!l.find(m=>m.payloadType===f.payloadType&&!!m.rtcpFeedbacks.find(T=>T.type==="transport-cc")))}(i,t.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(h=>h.type==="transport-cc")||l.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(e.twcc===!1){const o=t.attributes.extmaps.findIndex(a=>TE(a.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(a=>{const d=a.rtcpFeedbacks.findIndex(l=>l.type==="transport-cc");d!==-1&&a.rtcpFeedbacks.splice(d,1)})}if(e.remb===!0){const o=r.find(a=>H1(a.extensionName));if(o){const a=o.extensionName;t.attributes.extmaps.find(l=>l.extensionName===a)||t.attributes.extmaps.push({entry:o.entry,extensionName:a}),function(l,h){return h.filter(f=>!!l.find(m=>m.payloadType===f.payloadType&&!!m.rtcpFeedbacks.find(T=>T.type==="goog-remb")))}(i,t.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(h=>h.type==="goog-remb")||l.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(e.remb===!1){const o=t.attributes.extmaps.findIndex(a=>H1(a.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(a=>{const d=a.rtcpFeedbacks.findIndex(l=>l.type==="goog-remb");d!==-1&&a.rtcpFeedbacks.splice(d,1)})}}function Q1(t,e,n){if(Tn()||t.media.mediaType!=="video"||!(e instanceof en)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!M("SIMULCAST")||n==="vp9"&&M("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const r=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,i=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(d=>d.semantic==="FID"&&d.ssrcIds[0]===i.ssrcId),a={semantic:"SIM",ssrcIds:[i.ssrcId]};for(let d=1;d<r;d++)t.attributes.ssrcs.push({ssrcId:i.ssrcId+d,attributes:yn(i.attributes)}),a.ssrcIds.push(i.ssrcId+d),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+d,attributes:yn(i.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[i.ssrcId+d,o.ssrcIds[1]+d]}));t.attributes.ssrcGroups.unshift(a)}async function $1(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const r=(await n.createOffer()).sdp,{send:i,recv:o,sendrecv:a}=function(){let d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},h=arguments.length>2?arguments[2]:void 0;const f=Ip(h,d,l,"sendonly"),m=Ip(h,d,l,"recvonly"),T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},w={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(f,m,"videoExtensions",T,S,w),Ns(f,m,"videoCodecs",T,S,w),Ns(f,m,"audioExtensions",T,S,w),Ns(f,m,"audioCodecs",T,S,w),M("RAISE_H264_BASELINE_PRIORITY")){const I=[],C=[];w.videoCodecs.forEach((N,P)=>{var x;if(((x=N.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"){var W,H;const j=w.videoCodecs[P+1],$=j&&rU(N,j),ct=(W=N.fmtp)===null||W===void 0?void 0:W.parameters["profile-level-id"],Et=(H=N.fmtp)===null||H===void 0?void 0:H.parameters["packetization-mode"];!ct||ct!==M("FIRST_H264_PROFILE_LEVEL_ID")||M("FIRST_PACKETIZATION_MODE")&&Et!==M("FIRST_PACKETIZATION_MODE")?$?C.push([N,j]):C.push([N]):$?I.push([N,j]):I.push([N])}}),I.length>0&&C.length>0&&(v.debug("raising H264 baseline profile priority"),w.videoCodecs.forEach((N,P)=>{var x;if(((x=N.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"){const W=rU(N,w.videoCodecs[P+1]),H=I.shift()||C.shift()||[];H.length>0&&(W?w.videoCodecs.splice(P,2,...H):w.videoCodecs.splice(P,1,...H))}}),S.videoCodecs=S.videoCodecs.filter(N=>{var P,x;return!(((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName.toLocaleLowerCase())==="h264"&&((x=N.fmtp)===null||x===void 0?void 0:x.parameters["profile-level-id"])!==M("FIRST_H264_PROFILE_LEVEL_ID"))}),M("FILTER_SEND_H264_BASELINE")&&(T.videoCodecs=T.videoCodecs.filter(N=>{var P,x;return!(((P=N.rtpMap)===null||P===void 0?void 0:P.encodingName.toLocaleLowerCase())==="h264"&&((x=N.fmtp)===null||x===void 0?void 0:x.parameters["profile-level-id"])!==M("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:T,recv:S,sendrecv:w}}(t,e,r);try{n.close()}catch{}return{send:i,recv:o,sendrecv:a}}function Z1(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Ip(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(t,e,"videoExtensions",n,r,i),Ns(t,e,"videoCodecs",n,r,i),Ns(t,e,"audioExtensions",n,r,i),Ns(t,e,"audioCodecs",n,r,i),M("RAISE_H264_BASELINE_PRIORITY")){const o=i.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){const a=i.videoCodecs.findIndex(d=>d.rtpMap&&d.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(a<o){v.debug("raising H264 baseline profile priority");const d=i.videoCodecs[o];i.videoCodecs.splice(o,1),i.videoCodecs.splice(a,0,d)}a!==-1&&(r.videoCodecs=r.videoCodecs.filter(d=>!(d.rtpMap&&d.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&d.fmtp&&d.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:r,sendrecv:i}}function Ns(t,e,n,r,i,o){if(n==="videoExtensions"||n==="audioExtensions"){const a=[];return t[n].forEach(d=>{e[n].some((l,h)=>{if(d.entry===l.entry&&d.extensionName===l.extensionName)return a.push(h),!0})?o[n].push(d):r[n].push(d)}),void e[n].forEach((d,l)=>{a.indexOf(l)===-1&&i[n].push(d)})}if(n==="videoCodecs"||n==="audioCodecs"){const a=[];return t[n].forEach(d=>{e[n].some((l,h)=>{if(d.payloadType===l.payloadType&&JSON.stringify(d)===JSON.stringify(l))return a.push(h),!0})?o[n].push(d):r[n].push(d)}),void e[n].forEach((d,l)=>{a.indexOf(l)===-1&&i[n].push(d)})}}function vE(t){const{send:e,recv:n,sendrecv:r}=t;if(!r){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let i,o;return e?(i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i.audioCodecs=[...e.audioCodecs,...r.audioCodecs],i.videoCodecs=[...e.videoCodecs,...r.videoCodecs],i.audioExtensions=[...e.audioExtensions,...r.audioExtensions],i.videoExtensions=[...e.videoExtensions,...r.videoExtensions]):i=r,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...r.audioCodecs],o.videoCodecs=[...n.videoCodecs,...r.videoCodecs],o.audioExtensions=[...n.audioExtensions,...r.audioExtensions],o.videoExtensions=[...n.videoExtensions,...r.videoExtensions]):o=r,{send:i,recv:o}}function Ou(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var n;return((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Cp(t,e,n,r){let i=[];if(t===vt.VIDEO){if(M("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(i=e.videoCodecs.filter(o=>{var a;return ft(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,r)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===M("H264_PROFILE_LEVEL_ID")})),!Array.isArray(i)||i.length===0){let o=[];const a=[],d=[],l=[];if(n.videoCodecs.forEach(h=>{const f=h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"";ft(f).call(f,r)?o.push(h):ft(f).call(f,"vp9")?a.push(h):ft(f).call(f,"vp8")?d.push(h):ft(f).call(f,"h264")&&l.push(h)}),o.length===0){let h="";a.length!==0?(o=a,h="vp9"):d.length!==0?(o=d,h="vp8"):l.length!==0&&(o=l,h="h264"),v.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(h))}o.length!==0&&(i=e.videoCodecs.filter(h=>o.some(f=>f.payloadType===h.payloadType)))}if(i.length===0&&(v.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),i=e.videoCodecs),M("USE_PUB_RTX")||M("USE_SUB_RTX")){const o=kR(i,e.videoCodecs);i=[...i,...o]}}else i=e.audioCodecs.filter(o=>{var a;return ft(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,r)}),i.length===0&&(v.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),i=e.audioCodecs.filter(o=>{var a;return ft(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")}));return i}function kR(t,e){const n=t.map(r=>r.payloadType.toString());return e.filter(r=>r.rtpMap&&r.rtpMap.encodingName==="rtx"&&r.fmtp&&r.fmtp.parameters.apt&&ft(n).call(n,r.fmtp&&r.fmtp.parameters.apt))}async function Ap(t,e,n){const r=e.toString(),i=eU(r,"offer","remote","exchangeSDP");await t.setRemoteDescription({type:"offer",sdp:r});const o=await t.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let a=o.sdp;a=tU(a,n||{}),i==null||i(a||""),await t.setLocalDescription({type:"answer",sdp:a})}function tU(t,e,n){const r=Si(t),{useXR:i}=e;return r.mediaDescriptions.forEach(o=>{var a;o.attributes.mid&&(Array.isArray(n)&&!ft(n).call(n,o.attributes.mid)||(o.media.mediaType==="audio"&&Ou(o),i&&ft(a=["audio","video"]).call(a,o.media.mediaType)&&o.attributes.payloads.forEach(d=>{d.rtcpFeedbacks.findIndex(l=>l.type==="rrtr")===-1&&d.rtcpFeedbacks.push({type:"rrtr"})})))}),pc(r)}function eU(t,e,n,r){if(M("SDP_LOGGING"))return v.upload("exchanging ".concat(n," ").concat(e," SDP during P2PConnection.").concat(r,`
`),t),e==="offer"?i=>{eU(i,"answer",n==="local"?"remote":"local",r)}:void 0}function nU(t){const e=M("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(n=>ft(t).call(t,n))}function rU(t,e){try{var n;return((n=t.fmtp)===null||n===void 0?void 0:n.parameters.apt)===e.payloadType.toString()}catch{return!1}}function iU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function cs(t,e){return typeof M(t)===e?M(t):void 0}function QQ(){try{const t=M("EXPERIMENTS")||{};return typeof t=="string"||Array.isArray(t)?{}:function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?iU(Object(r),!0).forEach(function(i){b(e,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):iU(Object(r)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(r,i))})}return e}({},t)}catch(t){return v.debug("handle gateway attributes failed: ",t),{}}}const sU={};function Tc(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&v.debug("install service ".concat(t.name)),sU[t.name]=t}function wa(t){const e=sU[t];if(!e)throw new et(D.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function oU(t,e){return wa("DataStream").create(t,e)}function yE(){return wa("InterceptFrame").create()}function aU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function ba(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?aU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const LR=new Map;class $Q extends _n{get state(){return this._state}set state(e){if(e===this._state)return;const n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(ar.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(ar.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){v.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){var r,i,o;super(),b(this,"store",void 0),b(this,"joinInfo",void 0),b(this,"key",void 0),b(this,"ntpOffset",0),b(this,"signal",void 0),b(this,"role",void 0),b(this,"inChannelInfo",{joinAt:null,duration:0}),b(this,"spec",void 0),b(this,"_state","DISCONNECTED"),b(this,"_statsCollector",void 0),b(this,"_disconnectedReason",void 0),b(this,"isSignalRecover",!1),b(this,"hasChangeBGPAddress",!1),b(this,"trafficStatsInterval",void 0),b(this,"networkQualityInterval",void 0),b(this,"_joinGatewayStartTime",0),b(this,"_signalTimeout",!1),b(this,"_clientRoleOptions",void 0),b(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?(r={spec:ba(ba({},n),{},{retryConfig:n.websocketRetryConfig}),store:e},(i=(o=wa("P2PChannel")).createSubmodule)===null||i===void 0?void 0:i.call(o,r)):new JQ(ba(ba({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}async join(e,n,r){this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const i=Date.now();let o=LR.get(e.cname);if(o||(o=new Map,LR.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){const h=new z(D.UID_CONFLICT);throw bt.joinGateway(e.sid,{lts:i,succ:!1,ec:h.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:"0",preload:e.preload}),h}o.set(e.uid,!0),this.joinInfo=e,this.key=n;let a=0;this.joinGatewayStartTime=i;const d=e.proxyServer;try{v.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(a));const h=e.gatewayAddrs.map(f=>{let{address:m}=f;const[T,S]=m.split(":"),w={host:T,port:S};return e.proxyServer&&(w.proxy=e.proxyServer),w});a=(await this.signal.init(h)).uid,v.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(a," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(h){var l;throw v.error("[".concat(this.store.clientId,"] User join failed"),h.toString()),bt.joinGateway(e.sid,{lts:i,succ:!1,ec:((l=h.data)===null||l===void 0?void 0:l.desc)||h.code,errorMsg:h.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!d,signalChannel:"0",preload:e.preload}),o.delete(e.uid),this.signal.close(),h}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),v.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(h=>{v.warning("[".concat(this.store.clientId,"] get traffic stats error"),h.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(ar.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(ar.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(ar.NETWORK_QUALITY,{uplinkNetworkQuality:j1(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:j1(this._statsCollector.trafficStats.B_dnq)}):this.emit(ar.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),a}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==ke.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Qe.CONNECTED||await function(r,i){return i===1/0?r:mt.race([r,RX(i)])}(this.signal.request(Wt.LEAVE,void 0,!0),3e3)}catch(r){v.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),r)}this.signal.close(n),n!==ke.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const i={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:M("PUB_EXTEND"),twcc:!!M("PUBLISH_TWCC"),rtx:!!M("USE_PUB_RTX")};try{return(await this.signal.request(Wt.PUBLISH,i,!0))._message}catch(o){if(r&&o.data&&o.data.code===Ut.ERR_PUBLISH_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw o}}async publishDataChannel(e,n,r){var i;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(i=n.maxRetransmits)!==null&&i!==void 0?i:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(Wt.PUBLISH_DATASTREAM,o,!0)}catch(a){if(r&&a.data&&a.data.code===Ut.ERR_PUBLISH_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),a.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw a}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Wt.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(r){v.warning("[".concat(this.store.clientId,"] unpublish warning: "),r)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await mt.all(e.map(n=>this.signal.request(Wt.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){v.warning("unpublish datachannels warning: ",n)}}async presubscribe(e,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!M("SUBSCRIBE_TWCC"),rtx:!!M("USE_SUB_RTX")||void 0,extend:M("SUB_EXTEND"),svc:Array.isArray(M("SVC"))&&M("SVC").length!==0?M("SVC"):void 0};try{return await this.signal.request(Wt.PRE_SUBSCRIBE,i,!0)}catch(o){if(r&&o.data&&o.data.code===Ut.ERR_SUBSCRIBE_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,n,!1);throw o}}async subscribe(e,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!M("SUBSCRIBE_TWCC"),rtx:!!M("USE_SUB_RTX"),extend:M("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(M("SVC"))&&M("SVC").length!==0?M("SVC"):void 0};try{return(await this.signal.request(Wt.SUBSCRIBE,i,!0))._message}catch(o){if(r&&o.data&&o.data.code===Ut.ERR_SUBSCRIBE_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw o}}async subscribeDataChannel(e,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const i={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(Wt.SUBSCRIBE_DATASTREAM,i,!0)}catch(o){if(r&&o.data&&o.data.code===Ut.ERR_SUBSCRIBE_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw o}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const r={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!M("USE_SUB_RTX"),twcc:!!M("SUBSCRIBE_TWCC"),svc:Array.isArray(M("SVC"))&&M("SVC").length!==0?M("SVC"):void 0};try{return await this.signal.request(Wt.SUBSCRIBE_STREAMS,r,!0)}catch(i){if(n&&i.data&&i.data.code===Ut.ERR_SUBSCRIBE_REQUEST_INVALID)return v.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw i}}async setVideoProfile(e){const n=function(r){if(!(r.bitrateMax&&r.bitrateMin&&r.frameRate&&r.height&&r.width))return;let i=r.frameRate,o=r.width,a=r.height,d=!0;return typeof i!="number"&&(i=i.exact||i.ideal||i.max||i.min||0,i||(d=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(d=!1)),typeof a!="number"&&(a=a.exact||a.ideal||a.max||a.min||0,i||(d=!1)),d?{stream_type:0,width:o,height:a,fps:i,start_bps:1e3*r.bitrateMax,min_bps:1e3*r.bitrateMin,target_bps:1e3*r.bitrateMax}:void 0}(e);if(n)return this.signal.request(Wt.SET_VIDEO_PROFILE,n);v.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,n){try{await this.signal.request(Wt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0)}catch(r){v.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),r)}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await mt.all(e.map(r=>this.signal.request(Wt.UNSUBSCRIBE_DATASTREAM,{stream_id:r,uid:n},!0)))}catch(r){v.warning("unsubscribeDataChannel warning: ",r)}}async massUnsubscribe(e){try{await this.signal.request(Wt.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){v.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(e){const{iceParameters:n,dtlsParameters:r,rtpCapabilities:i}=e;return{gatewayEstablishParams:await this.signal.request(Wt.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:r,rtpCapabilities:i}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Wt.GATEWAY_INFO)}async renewToken(e){await this.signal.request(Wt.RENEW_TOKEN,e),this.key=e.token}updateClientRole(e,n){n&&(this._clientRoleOptions=Object.assign({},n)),M("CLIENT_ROLE_OPTIONS")&&(v.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(M("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},M("CLIENT_ROLE_OPTIONS"))),this.role=e}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),M("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},M("CLIENT_ROLE_OPTIONS")),v.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(M("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let r,i=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(r=this._clientRoleOptions.delay,i=1):i=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:i=0,await this.signal.request(Wt.SET_CLIENT_ROLE,{role:e,level:i,delay:r,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,n){await this.signal.request(Wt.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(Wt.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,n){await this.signal.request(Wt.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})}async pickSVCLayer(e,n){await this.signal.request(Wt.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(e){await this.signal.request(Wt.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,n,r){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,n,r)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),ba({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Wt.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=LR.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(n){let r;return r=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:Rr.username,password:Rr.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(ba(ba({},Rr),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(Wt.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(n=>{const r=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(i=>i.peer_uid===n.peer_uid);r&&r.B_st!==n.B_st&&Gm(()=>{this.emit(ar.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new z(D.UNEXPECTED_ERROR,"can not generate join message, no join info");const n=Object.assign({},this.joinInfo.apResponse);let r=M("REPORT_APP_SCENARIO");if(typeof r!="string")try{r=JSON.stringify(r)}catch{r=void 0}var i;r&&r.length>128&&(r=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(ar.UPDATE_GATEWAY_CONFIG),i=this.store.clientId,ft(yu).call(yu,i)||yu.push(i);const o=!(Tn()||Ck(87)||fL())&&typeof M("ENABLE_PRE_SUB")=="boolean"&&M("ENABLE_PRE_SUB"),a=!fL()&&cs("ENABLE_PREALLOC_PC","boolean"),d=QQ(),l=ap(87)||function(){const f=ve();if(f.name!==Oe.SAFARI||!f.browserVersion)return!1;const m=f.browserVersion.split(".");return Number(m[0])>15||Number(m[0])===15&&Number(m[1])>=4}(),h=ba({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:is,browser:navigator.userAgent,process_id:M("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:M("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:r,attributes:{userAttributes:ba({enableEncodedTransform:!!M("ENABLE_AUDIO_METADATA")&&l||!!M("ENABLE_AUDIO_TOPN")&&wy(Oe.CHROME,87,116)||void 0,enableAudioMetadata:!!M("ENABLE_AUDIO_METADATA")&&l,enableAudioPts:!!M("ENABLE_AUDIO_PTS_METADATA")&&l,topnSmoothLevel:M("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:M("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:M("TOPN_SWITCH_HOLD_MS"),topnAudioGain:M("TOPN_AUDIO_GAIN"),enablePublishedUserList:M("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:M("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:cs("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:cs("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:cs("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:M("USE_PUB_RTX")===!0||M("USE_SUB_RTX")===!0||void 0,disableFEC:M("DISABLE_FEC"),enableNTPReport:!!M("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!M("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!M("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:cs("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!M("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!M("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:cs("USE_XR","boolean"),enableLossbasedBwe:cs("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!M("ENABLE_AUT_CC")||void 0,enableCCFallback:cs("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:a,preSubNum:o?cs("PRE_SUB_NUM","number"):void 0,enablePubTWCC:cs("PUBLISH_TWCC","boolean"),enableSubTWCC:cs("SUBSCRIBE_TWCC","boolean"),enablePubRTX:cs("USE_PUB_RTX","boolean"),enableSubRTX:cs("USE_SUB_RTX","boolean"),enableSubSVC:M("ENABLE_SVC")?M("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(M("SVC"))&&M("SVC").length!==0?M("SVC"):void 0,enableSvcExtended:M("ENABLE_SVC")&&Array.isArray(M("SVC_EXTENDED"))&&M("SVC_EXTENDED").length!==0?M("SVC_EXTENDED"):void 0},d)},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(h.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(h.aes_mode=this.joinInfo.aesmode,M("ENCRYPT_AES")?(h.aes_secret=this.joinInfo.aespassword,h.aes_encrypt=!0):h.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(h.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(h.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(h.default_video_stream=this.joinInfo.defaultVideoStream),h}getRejoinMessage(){if(!this.joinInfo)throw new z(D.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(qt.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(qt.WS_RECONNECTING,e=>{this.joinInfo&&bt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||vr.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",bt.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(qt.WS_CLOSED,e=>{let n;switch(e){case ke.LEAVE:n=vr.LEAVE;break;case ke.UID_BANNED:case ke.IP_BANNED:case ke.CHANNEL_BANNED:case ke.SERVER_ERROR:n=vr.SERVER_ERROR;break;case ke.FALLBACK:n=vr.FALLBACK;break;case ke.LICENSE_MISSING:case ke.LICENSE_EXPIRED:case ke.LICENSE_MINUTES_EXCEEDED:case ke.LICENSE_PERIOD_INVALID:case ke.LICENSE_MULTIPLE_SDK_SERVICE:case ke.LICENSE_ILLEGAL:case ke.TOKEN_EXPIRE:n=e;break;default:n=vr.NETWORK_ERROR}v.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+vr.NETWORK_ERROR)),this.joinInfo&&bt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===ke.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==ke.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(qt.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const e=M("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(v.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(bt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void v.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Fe("EVENT_REPORT_DOMAIN",e[1]),Fe("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Fe("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}}),this.signal.on(ue.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(qt.REQUEST_RECOVER,(e,n,r)=>{if(!this.joinInfo)return r(new z(D.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,yr(this,ar.REQUEST_NEW_GATEWAY_LIST).then(n).catch(r)}),this.signal.on(qt.REQUEST_JOIN_INFO,async(e,n,r)=>{var i;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const o=yn((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(M("NEW_TURN_MODE")&&o){let h=o.servers,f=o.serversFromGateway;const m=this.signal.currentURLIndex;h.length>0&&(h=[h[m%h.length]],o.servers=h),Array.isArray(f)&&f.length>0&&(f=[f[0]],o.serversFromGateway=f),v.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(m))}const{iceParameters:a,dtlsParameters:d,rtpCapabilities:l}=await yr(this,ar.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:o});try{e(this.getJoinMessage({ortc:{iceParameters:a,dtlsParameters:d,rtpCapabilities:l,version:"2"}}))}catch(h){n(h)}}),this.signal.on(qt.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(qt.REPORT_JOIN_GATEWAY,(e,n)=>{if(!this.joinInfo)return;let r,i="";var o;e instanceof z?(r=((o=e.data)===null||o===void 0?void 0:o.desc)||e.code,i=e.message):r=e,bt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:r,errorMsg:i,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload})}),this.signal.on(qt.IS_P2P_DISCONNECTED,e=>{e(hp(this,ar.IS_P2P_DISCONNECTED))}),this.signal.on(qt.DISCONNECT_P2P,()=>{this.emit(ar.DISCONNECT_P2P)}),this.signal.on(qt.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(qt.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(qt.JOIN_RESPONSE,e=>{const n=this.getCurrentGatewayAddress();this.emit(ar.JOIN_RESPONSE,e,n)}),this.signal.on(qt.PRE_CONNECT_PC,async()=>{if(this.joinInfo){this.updateTurnConfigFromSignal();const e=this.getCurrentGatewayAddress(),n=M("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(e&&n){const r=J1(e);this.emit(ar.PRE_CONNECT_PC,{candidates:r,fingerprint:n})}}}),this.signal.on(qt.RECOVER_NOTIFICATION,e=>{this.joinInfo&&typeof M("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(M("AP_REQUEST_DETAIL"),";").concat(e))})}async tryUnsubBeforeResub(e,n){try{await this.signal.request(Wt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(r){throw v.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),r),r}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(Wt.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(r){throw v.warning("unsubscribe datachannel warning",r),r}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(Wt.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(r){throw v.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),r),r}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(Wt.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(r){throw v.warning("unpublish datastream warning: ",r),r}}async tryMassUnsubBeforeResub(e){const n={users:e.map(r=>({stream_id:r.stream_id,stream_type:r.stream_type}))};try{await this.signal.request(Wt.UNSUBSCRIBE_STREAMS,n,!0)}catch(r){throw v.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),r),r}}async muteLocal(e,n){const r={action:e.find(i=>i.stream_type===Ue.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Wt.CONTROL,r,!0,!0)}catch(i){throw v.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),i),i}}async unmuteLocal(e,n){const r={action:e.find(i=>i.stream_type===Ue.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Wt.CONTROL,r,!0,!0)}catch(i){throw v.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),i),i}}async muteRemote(e,n){const r={action:e===vt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Wt.CONTROL,r,!0,!0)}catch(i){throw v.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),i),i}}async unmuteRemote(e,n){const r={action:e===vt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Wt.CONTROL,r,!0,!0)}catch(i){throw v.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),i),i}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(Wt.RESTART_ICE,n,!0)}catch(r){throw v.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),r),r}}reconnect(e,n){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,n||vr.P2P_FAILED)}getCurrentGatewayAddress(){var e,n;if(!M("GATEWAY_WSS_ADDRESS"))return M("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(v.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(Wt.SET_PARAMETER,{enablePublishAudioFilter:e})}}let RE=0,MR=0;function eo(t,e,n,r){return new mt((i,o)=>{e.timeout=e.timeout||M("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),RE+=Ao(e.data)):n&&(e.data.size?RE+=e.data.size:e.data instanceof FormData?RE+=Wk(e.data):RE+=Ao(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,ai.request(e).then(a=>{typeof a.data=="string"?MR+=Ao(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?MR+=a.data.byteLength:MR+=Ao(JSON.stringify(a.data)),r&&i({data:a.data,headers:a.headers}),i(a.data)}).catch(a=>{ai.isCancel(a)?o(new z(D.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?o(new z(D.NETWORK_TIMEOUT,a.message)):a.response?o(new z(D.NETWORK_RESPONSE_ERROR,a.response.status)):o(new z(D.NETWORK_ERROR,a.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var t;function e(it){var ut=0;return function(){return ut<it.length?{done:!1,value:it[ut++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(it,ut,At){return it==Array.prototype||it==Object.prototype||(it[ut]=At.value),it},r,i=function(it){it=[typeof globalThis=="object"&&globalThis,it,typeof window=="object"&&window,typeof self=="object"&&self,typeof p=="object"&&p];for(var ut=0;ut<it.length;++ut){var At=it[ut];if(At&&At.Math==Math)return At}throw Error("Cannot find global object")}(this);function o(it,ut){if(ut)t:{var At=i;it=it.split(".");for(var ot=0;ot<it.length-1;ot++){var R=it[ot];if(!(R in At))break t;At=At[R]}(ut=ut(ot=At[it=it[it.length-1]]))!=ot&&ut!=null&&n(At,it,{configurable:!0,writable:!0,value:ut})}}function a(it){return(it={next:it})[Symbol.iterator]=function(){return this},it}function d(it){var ut=typeof Symbol<"u"&&Symbol.iterator&&it[Symbol.iterator];return ut?ut.call(it):{next:e(it)}}if(o("Symbol",function(it){function ut(R,U){this.A=R,n(this,"description",{configurable:!0,writable:!0,value:U})}if(it)return it;ut.prototype.toString=function(){return this.A};var At="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",ot=0;return function R(U){if(this instanceof R)throw new TypeError("Symbol is not a constructor");return new ut(At+(U||"")+"_"+ot++,U)}}),o("Symbol.iterator",function(it){if(it)return it;it=Symbol("Symbol.iterator");for(var ut="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),At=0;At<ut.length;At++){var ot=i[ut[At]];typeof ot=="function"&&typeof ot.prototype[it]!="function"&&n(ot.prototype,it,{configurable:!0,writable:!0,value:function(){return a(e(this))}})}return it}),typeof Object.setPrototypeOf=="function")r=Object.setPrototypeOf;else{var l;t:{var h={};try{h.__proto__={a:!0},l=h.a;break t}catch{}l=!1}r=l?function(it,ut){if(it.__proto__=ut,it.__proto__!==ut)throw new TypeError(it+" is not extensible");return it}:null}var f=r;function m(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function T(it){if(it.m)throw new TypeError("Generator is already running");it.m=!0}function S(it,ut){return it.h=3,{value:ut}}function w(it){this.g=new m,this.G=it}function I(it,ut,At,ot){try{var R=ut.call(it.g.j,At);if(!(R instanceof Object))throw new TypeError("Iterator result "+R+" is not an object");if(!R.done)return it.g.m=!1,R;var U=R.value}catch(F){return it.g.j=null,it.g.s(F),C(it)}return it.g.j=null,ot.call(it.g,U),C(it)}function C(it){for(;it.g.h;)try{var ut=it.G(it.g);if(ut)return it.g.m=!1,{value:ut.value,done:!1}}catch(At){it.g.v=void 0,it.g.s(At)}if(it.g.m=!1,it.g.l){if(ut=it.g.l,it.g.l=null,ut.F)throw ut.D;return{value:ut.return,done:!0}}return{value:void 0,done:!0}}function N(it){this.next=function(ut){return it.o(ut)},this.throw=function(ut){return it.s(ut)},this.return=function(ut){return function(At,ot){T(At.g);var R=At.g.j;return R?I(At,"return"in R?R.return:function(U){return{value:U,done:!0}},ot,At.g.return):(At.g.return(ot),C(At))}(it,ut)},this[Symbol.iterator]=function(){return this}}function P(it,ut){return ut=new N(new w(ut)),f&&it.prototype&&f(ut,it.prototype),ut}if(m.prototype.o=function(it){this.v=it},m.prototype.s=function(it){this.l={D:it,F:!0},this.h=this.C||this.u},m.prototype.return=function(it){this.l={return:it},this.h=this.u},w.prototype.o=function(it){return T(this.g),this.g.j?I(this,this.g.j.next,it,this.g.o):(this.g.o(it),C(this))},w.prototype.s=function(it){return T(this.g),this.g.j?I(this,this.g.j.throw,it,this.g.o):(this.g.s(it),C(this))},o("Array.prototype.entries",function(it){return it||function(){return function(ut,At){ut instanceof String&&(ut+="");var ot=0,R=!1,U={next:function(){if(!R&&ot<ut.length){var F=ot++;return{value:At(F,ut[F]),done:!1}}return R=!0,{done:!0,value:void 0}}};return U[Symbol.iterator]=function(){return U},U}(this,function(ut,At){return[ut,At]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var x=function(it,ut){for(var At=0;At<it.length;At++)ut(it[At])},W=function(it){return it.replace(/\r?\n|\r/g,`\r
`)},H=function(it,ut,At){return ut instanceof Blob?(At=At!==void 0?At+"":typeof ut.name=="string"?ut.name:"blob",ut.name===At&&Object.prototype.toString.call(ut)!=="[object Blob]"||(ut=new File([ut],At)),[String(it),ut]):[String(it),String(ut)]},j=function(it,ut){if(it.length<ut)throw new TypeError(ut+" argument required, but only "+it.length+" present.")},$=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,ct=$.FormData,Et=$.XMLHttpRequest&&$.XMLHttpRequest.prototype.send,Tt=$.Request&&$.fetch,he=$.navigator&&$.navigator.sendBeacon,pe=$.Element&&$.Element.prototype,Xe=$.Symbol&&Symbol.toStringTag;Xe&&(Blob.prototype[Xe]||(Blob.prototype[Xe]="Blob"),"File"in $&&!File.prototype[Xe]&&(File.prototype[Xe]="File"));try{new File([],"")}catch{$.File=function(ut,At,ot){return ut=new Blob(ut,ot||{}),Object.defineProperties(ut,{name:{value:At},lastModified:{value:+(ot&&ot.lastModified!==void 0?new Date(ot.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Xe&&Object.defineProperty(ut,Xe,{value:"File"}),ut}}var Mn=function(it){return it.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Cn=function(it){this.i=[];var ut=this;it&&x(it.elements,function(At){if(At.name&&!At.disabled&&At.type!=="submit"&&At.type!=="button"&&!At.matches("form fieldset[disabled] *"))if(At.type==="file"){var ot=At.files&&At.files.length?At.files:[new File([],"",{type:"application/octet-stream"})];x(ot,function(R){ut.append(At.name,R)})}else At.type==="select-multiple"||At.type==="select-one"?x(At.options,function(R){!R.disabled&&R.selected&&ut.append(At.name,R.value)}):At.type==="checkbox"||At.type==="radio"?At.checked&&ut.append(At.name,At.value):(ot=At.type==="textarea"?W(At.value):At.value,ut.append(At.name,ot))})};if((t=Cn.prototype).append=function(it,ut,At){j(arguments,2),this.i.push(H(it,ut,At))},t.delete=function(it){j(arguments,1);var ut=[];it=String(it),x(this.i,function(At){At[0]!==it&&ut.push(At)}),this.i=ut},t.entries=function it(){var ut,At=this;return P(it,function(ot){if(ot.h==1&&(ut=0),ot.h!=3)return ut<At.i.length?ot=S(ot,At.i[ut]):(ot.h=0,ot=void 0),ot;ut++,ot.h=2})},t.forEach=function(it,ut){j(arguments,1);for(var At=d(this),ot=At.next();!ot.done;ot=At.next()){var R=d(ot.value);ot=R.next().value,R=R.next().value,it.call(ut,R,ot,this)}},t.get=function(it){j(arguments,1);var ut=this.i;it=String(it);for(var At=0;At<ut.length;At++)if(ut[At][0]===it)return ut[At][1];return null},t.getAll=function(it){j(arguments,1);var ut=[];return it=String(it),x(this.i,function(At){At[0]===it&&ut.push(At[1])}),ut},t.has=function(it){j(arguments,1),it=String(it);for(var ut=0;ut<this.i.length;ut++)if(this.i[ut][0]===it)return!0;return!1},t.keys=function it(){var ut,At,ot,R,U=this;return P(it,function(F){if(F.h==1&&(ut=d(U),At=ut.next()),F.h!=3)return At.done?void(F.h=0):(ot=At.value,R=d(ot),S(F,R.next().value));At=ut.next(),F.h=2})},t.set=function(it,ut,At){j(arguments,2),it=String(it);var ot=[],R=H(it,ut,At),U=!0;x(this.i,function(F){F[0]===it?U&&(U=!ot.push(R)):ot.push(F)}),U&&ot.push(R),this.i=ot},t.values=function it(){var ut,At,ot,R,U=this;return P(it,function(F){if(F.h==1&&(ut=d(U),At=ut.next()),F.h!=3)return At.done?void(F.h=0):(ot=At.value,(R=d(ot)).next(),S(F,R.next().value));At=ut.next(),F.h=2})},Cn.prototype._asNative=function(){for(var it=new ct,ut=d(this),At=ut.next();!At.done;At=ut.next()){var ot=d(At.value);At=ot.next().value,ot=ot.next().value,it.append(At,ot)}return it},Cn.prototype._blob=function(){var it="----formdata-polyfill-"+Math.random(),ut=[],At="--"+it+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(ot,R){return typeof ot=="string"?ut.push(At+Mn(W(R))+`"\r
\r
`+W(ot)+`\r
`):ut.push(At+Mn(W(R))+'"; filename="'+Mn(ot.name)+`"\r
Content-Type: `+(ot.type||"application/octet-stream")+`\r
\r
`,ot,`\r
`)}),ut.push("--"+it+"--"),new Blob(ut,{type:"multipart/form-data; boundary="+it})},Cn.prototype[Symbol.iterator]=function(){return this.entries()},Cn.prototype.toString=function(){return"[object FormData]"},pe&&!pe.matches&&(pe.matches=pe.matchesSelector||pe.mozMatchesSelector||pe.msMatchesSelector||pe.oMatchesSelector||pe.webkitMatchesSelector||function(it){for(var ut=(it=(this.document||this.ownerDocument).querySelectorAll(it)).length;0<=--ut&&it.item(ut)!==this;);return-1<ut}),Xe&&(Cn.prototype[Xe]="FormData"),Et){var pi=$.XMLHttpRequest.prototype.setRequestHeader;$.XMLHttpRequest.prototype.setRequestHeader=function(it,ut){pi.call(this,it,ut),it.toLowerCase()==="content-type"&&(this.B=!0)},$.XMLHttpRequest.prototype.send=function(it){it instanceof Cn?(it=it._blob(),this.B||this.setRequestHeader("Content-Type",it.type),Et.call(this,it)):Et.call(this,it)}}Tt&&($.fetch=function(it,ut){return ut&&ut.body&&ut.body instanceof Cn&&(ut.body=ut.body._blob()),Tt.call(this,it,ut)}),he&&($.navigator.sendBeacon=function(it,ut){return ut instanceof Cn&&(ut=ut._asNative()),he.call(this,it,ut)}),$.FormData=Cn}})();const wp=()=>{const t=M("AREAS");return t.length===0&&t.push(Ne.GLOBAL),Ws(t).call(t,(e,n,r)=>{const i=cU(n);return i?r===0?i:"".concat(e,",").concat(i):e},"")},cU=t=>t===Ne.OVERSEA?"".concat(Nr.ASIA,",").concat(Nr.EUROPE,",").concat(Nr.AFRICA,",").concat(Nr.NORTH_AMERICA,",").concat(Nr.SOUTH_AMERICA,",").concat(Nr.OCEANIA):Nr[t],ZQ=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(n=>{const r=_E[n],i=Object.keys(r);i&&i.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(r[o]))})}),e},IE={GLOBAL:{ASIA:[Ne.CHINA,Ne.JAPAN,Ne.INDIA,Ne.KOREA,Ne.HKMC],EUROPE:[],NORTH_AMERICA:[Ne.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},CE=Object.keys(IE[Ne.GLOBAL]),UR=[Ne.CHINA,Ne.NORTH_AMERICA,Ne.EUROPE,Ne.ASIA,Ne.JAPAN,Ne.INDIA,Ne.OCEANIA,Ne.SOUTH_AMERICA,Ne.AFRICA,Ne.KOREA,Ne.HKMC,Ne.US],t$=function(t,e){let n=[];if(ft(t).call(t,Ne.GLOBAL)){const o=[Ne.GLOBAL,Ne.OVERSEA],a=Object.keys(_E);if(e===Ne.GLOBAL)throw new z(D.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===Ne.CHINA)n=[Ne.OVERSEA];else if(i=e,ft(CE).call(CE,i)){const d=(r=e,IE[Ne.GLOBAL][r]||[]),l=[...o,e,...d];n=a.filter(h=>!ft(l).call(l,h))}else if(function(d){let l=!1;return CE.forEach(h=>{var f;ft(f=IE[Ne.GLOBAL][h]).call(f,d)&&(l=!0)}),l}(e)){const d=function(h){let f;return CE.forEach(m=>{var T;ft(T=IE[Ne.GLOBAL][m]).call(T,h)&&(f=m)}),f}(e),l=[...o,d,e];n=a.filter(h=>!ft(l).call(l,h))}else n=t;n=function(d){const l=[];return UR.forEach(h=>{ft(d).call(d,h)&&l.push(h)}),l.concat(d.filter(h=>!ft(UR).call(UR,h)))}(n)}else n=t;var r,i;return n};function dU(t){var e,n;if(!t&&ft(e=M("AREAS")).call(e,Ne.EXTENSIONS))return v.debug("update area from ap : reset"),void xR(dQ,!0);if(!ft(n=M("AREAS")).call(n,Ne.GLOBAL)||!t)return;let r=_E.EXTENSIONS;r&&(r={CODE:cU(Ne.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},v.debug("update area from ap success: ".concat(t,",config is "),r),Fe("AREAS",[Ne.EXTENSIONS],!0),Object.keys(r).map(i=>{i==="LOG_UPLOAD_SERVER"||i==="EVENT_REPORT_DOMAIN"||i==="EVENT_REPORT_BACKUP_DOMAIN"||i==="PROXY_SERVER_TYPE3"?Fe(i,r[i][0]):Fe(i,r[i])}))}function xR(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=bt.reportApiInvoke(null,{name:Kn.SET_AREA,options:t,tag:vn.TRACER});try{let r=[];if(typeof t=="string"&&(r=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!ft(O1).call(O1,o))throw new z(D.INVALID_PARAMS,"invalid area code")}),r=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:o,excludedArea:a}=t;if(!o)throw new z(D.INVALID_PARAMS,"area code is needed");let d=o;typeof o=="string"&&(d=[o]),r=a?t$(d,a):d}if(!e){if(Qs.AREAS){const o=new z(D.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void v.warning("setArea is prohibited because of config-distribute")}if(ft(r).call(r,Ne.GLOBAL)&&M("AREAS")===Ne.EXTENSIONS){const o=new z(D.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void v.warning("setArea is prohibited because of ap extensions")}}Fe("AREAS",r,e);const i=ZQ(r);Object.keys(i).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?Fe(o,i[o][0]):Fe(o,i[o])}),v.debug("set area success:",r.join(","))}catch(r){throw n.onError(r),r}n.onSuccess()}function lU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Do(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let VR=1;function e$(t,e,n,r,i){VR+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:VR,requestId:VR,version:is,cname:n.cname},a={service_name:e,json_body:JSON.stringify(o)};let d,l,h=t[0];return Xs(async()=>{d=Date.now();const f=await eo(h,{data:a,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-d,f.code!==0){const S=new z(D.UNEXPECTED_RESPONSE,"live streaming ap error, code"+f.code,{retry:!0,responseTime:l});throw v.error(S.toString()),S}const m=JSON.parse(f.json_body);if(m.code!==200){const S=new z(D.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(m.code,", reason: ").concat(m.reason),{code:m.code,responseTime:l});throw v.error(S.toString()),S}if(!m.servers||m.servers.length===0){const S=new z(D.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:m.code,responseTime:l});throw v.error(S.toString()),S}const T=function(S,w){return{addressList:S.servers.map(I=>"wss://".concat(I.address.replace(/\./g,"-"),".").concat(M("WORKER_DOMAIN"),":").concat(I.wss,"?serviceName=").concat(encodeURIComponent(w))),workerToken:S.workerToken,vid:S.vid}}(m,e);return M("LIVE_STREAMING_ADDRESS")&&(T.addressList=M("LIVE_STREAMING_ADDRESS")instanceof Array?M("LIVE_STREAMING_ADDRESS"):[M("LIVE_STREAMING_ADDRESS")]),Do(Do({},T),{},{responseTime:l})},(f,m)=>(bt.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(f.addressList),firstSuccess:m===0,responseTime:l,serverIp:t[m%t.length]}),!1),(f,m)=>(bt.apworkerEvent(n.sid,{success:!1,sc:f.data&&f.data.code||200,serviceName:e,responseTime:l,serverIp:t[m%t.length]}),!!(f.code!==D.OPERATION_ABORTED&&f.code!==D.UNEXPECTED_RESPONSE||f.data&&f.data.retry)&&(h=t[(m+1)%t.length],!0)),i)}let FR=1;function uU(t,e,n,r){let{url:i,areaCode:o}=t;const{clientId:a,sid:d}=e,l=Date.now();let h;const f=e.role,[m,T]=jR(e,o,[Bn.CHOOSE_SERVER]);let S=Fn.networkState;return Xs(async()=>{S&&Fn.networkState===ki.OFFLINE&&Fn.onlineWaiter&&await mt.race([Fn.onlineWaiter,hr(r&&r.maxRetryTimeout||qn.maxRetryTimeout)]),S=Fn.networkState;const{data:w,headers:I}=await eo(i,{data:m,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);h=I.http3==="1"?1:-1,bt.reportResourceTiming(i,d),pU(w,i,e,l,[Bn.CHOOSE_SERVER],h);const C=Rp(w,Bn.CHOOSE_SERVER);return BR(C),OR(C,i)},w=>(w&&bt.joinChooseServer(d,{role:f,lts:l,succ:!0,csAddr:i,opid:T,serverList:w.gatewayAddrs.map(I=>I.address),ec:null,cid:w.cid.toString(),uid:w.uid.toString(),csIp:w.csIp,unilbsServerIds:[Bn.CHOOSE_SERVER].toString(),isHttp3:h,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:w.res.detail&&w.res.detail[38]}),!1),w=>w.code!==D.OPERATION_ABORTED&&(w.code===D.CAN_NOT_GET_GATEWAY_SERVER?w.data.retry:(bt.joinChooseServer(d,{role:f,lts:l,succ:!1,csAddr:i,serverList:null,opid:T,ec:w.code,csIp:w.data&&w.data.csIp,unilbsServerIds:[Bn.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:S}),isHttp3:h,corssRegionTagReq:e.apRequestDetail}),v.warning("[".concat(a||"sid-".concat(d.slice(0,6)),"] Choose server network error, retry"),w),!0)),r)}function hU(t,e,n,r){let i,{url:o,areaCode:a,serviceIds:d}=t;const l=Date.now(),h=e.role,[f,m]=jR(e,a,d);let T;return Xs(async()=>{T&&Fn.networkState===ki.OFFLINE&&Fn.onlineWaiter&&await mt.race([Fn.onlineWaiter,hr(r&&r.maxRetryTimeout||qn.maxRetryTimeout)]),T=Fn.networkState;const{data:S,headers:w}=await eo(o,{data:f,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);i=w.http3==="1"?1:-1,bt.reportResourceTiming(o,e.sid),pU(S,o,e,l,d,i);const I=Rp(S,Bn.CHOOSE_SERVER),C=Rp(S,e.cloudProxyServer==="proxy5"?Bn.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Bn.CLOUD_PROXY:Bn.CLOUD_PROXY_FALLBACK);return BR(I),{gatewayInfo:OR(I,o),proxyInfo:C,url:o}},S=>(S.gatewayInfo&&bt.joinChooseServer(e.sid,{role:h,lts:l,succ:!0,csAddr:o,serverList:S.gatewayInfo.gatewayAddrs.map(w=>w.address),ec:null,opid:m,cid:S.gatewayInfo.cid.toString(),uid:S.gatewayInfo.uid.toString(),csIp:S.gatewayInfo.csIp,unilbsServerIds:d.toString(),isHttp3:i,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:S.gatewayInfo.res.detail&&S.gatewayInfo.res.detail[38]}),S.proxyInfo&&bt.joinWebProxyAP(e.sid,{lts:l,sucess:1,apServerAddr:o,turnServerAddrList:S.proxyInfo.addresses.map(w=>w.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:d.toString()}),!1),S=>S.code!==D.OPERATION_ABORTED&&(S.code===D.CAN_NOT_GET_GATEWAY_SERVER?S.data.retry:(bt.joinWebProxyAP(e.sid,{lts:l,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:S.code,eventType:e.cloudProxyServer,unilbsServerIds:d.toString(),extend:JSON.stringify({networkState:T})}),v.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),S),!0)),r)}const pU=(t,e,n,r,i,o)=>{const{sid:a,clientId:d,cloudProxyServer:l}=n,h=[],f=m=>{m.flag===4096?bt.joinChooseServer(a,{role:n.role,lts:r,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:m.error.message,csIp:m.error.data&&m.error.data.csIp,unilbsServerIds:i.toString(),isHttp3:o,corssRegionTagReq:n.apRequestDetail}):m.flag!==1048576&&m.flag!==4194304&&m.flag!==4194310||bt.joinWebProxyAP(a,{lts:r,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:m.error.code,eventType:l,unilbsServerIds:i.toString()})};if(t.response_body.forEach(m=>{const T=m.buffer.code;if(m.uri===23&&T===0&&!m.buffer.edges_services)if(m.buffer.flag===4194310)v.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),m.buffer.edges_services=[];else{const S={error:new z(D.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:m.buffer.flag};h.push(S),f(S)}if(T!==0){const S=Au(T),w={error:new z(D.CAN_NOT_GET_GATEWAY_SERVER,S.desc,{desc:S.desc,retry:S.retry,csIp:t.detail[502]}),flag:m.buffer.flag};m.buffer.flag===4194310?v.warning(w.error.toString()):h.push(w),f(w)}}),h.length)throw v.warning("[".concat(d||"sid-".concat(a.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(h.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message,", retry: ").concat(m.error.data.retry)).join(" | "))),new z(D.CAN_NOT_GET_GATEWAY_SERVER,h.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message)).join(" | "),{retry:!!h.find(m=>m.error.data.retry),csIp:t.detail[502],desc:[...new Set(h.map(m=>{var T;return m==null||(T=m.error)===null||T===void 0||(T=T.data)===null||T===void 0?void 0:T.desc}).filter(m=>!!m))]})},BR=t=>{var e,n,r,i;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new z(D.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(M("AP_AREA")&&((r=t.detail)!==null&&r!==void 0&&r[23]&&typeof((i=t.detail)===null||i===void 0?void 0:i[23])=="string"?dU(t.detail[23].toLowerCase()):dU()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((n=t.detail)===null||n===void 0?void 0:n[19])=="string"){const a=t.detail[19],d=a==null?void 0:a.split(";");for(let l=0;l<d.length;l++){var o;const h=Br(o=d[l]).call(o);t.addresses[l]&&d&&(t.addresses[l].fingerprint=h)}}if(M("GATEWAY_ADDRESS")&&M("GATEWAY_ADDRESS").length>0){v.debug("assign gateway address to",M("GATEWAY_ADDRESS"));const a=M("GATEWAY_ADDRESS").map(d=>{var l,h;const f=(l=(h=t.addresses.find(m=>m.ip===d.ip&&m.port===d.port))===null||h===void 0?void 0:h.fingerprint)!==null&&l!==void 0?l:"";return{ip:d.ip,port:d.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:f}});t.addresses=a}},n$=(t,e)=>{if(t.response_body&&t.response_body.length){const n=t.response_body[0];if(n.buffer.code!==0){const r=Au(n.buffer.code);throw new z(D.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return n.buffer.ticket}throw v.debug("update ticket request received ap response without response body:",e),new z(D.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},jR=(t,e,n)=>{const r=Math.floor(Math.random()*1e12),i=t.role==="host"?"1":t.role==="audience"?"2":void 0,o={appid:t.appId,client_ts:Date.now(),opid:r,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:Do(Do(Do({6:t.stringUid,11:e,12:M("USE_NEW_TOKEN")?"1":void 0},i?{17:i}:{}),{},{22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};o.request_bodies.forEach(d=>{t.multiIP&&t.multiIP.gateway_ip&&(d.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const a=new FormData;return a.append("request",JSON.stringify(o)),[a,r]},r$=(t,e)=>{const n=Math.floor(Math.random()*1e12),r={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},i=new FormData;return i.append("request",JSON.stringify(r)),[i,n]};let Nu=0;function Pu(t){return mt.all(t.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}const bp=async t=>{let{fragementLength:e,referenceList:n,asyncMapHandler:r,allFailedhandler:i,promisesCollector:o}=t,a=0;const d=e;let l,h=0;const f=async()=>{const m=(()=>{const T=a*d,S=T+d;return n.slice(T,S).map(r)})();o&&o.push(...m);try{l=await Pu(m)}catch(T){if(h+=d,a++,!(h>=n.length))return void await f();i(T)}m.forEach(T=>T.cancel())};return await f(),l},fU=async t=>{let{referenceList:e,asyncMapHandler:n,closeFn:r}=t;const i=e.length;let o=0;const a=async()=>{const d=n(e.shift());try{return await d}catch(l){if(o++,o>=i||r!=null&&r(l))throw l;return a()}};return a()};async function GR(t,e,n,r){return{gatewayInfo:await async function(o,a,d,l){let h=null;const f=[],m=async()=>{const S=M("WEBCS_DOMAIN").slice(0,M("AJAX_REQUEST_CONCURRENT")).map(C=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(C+"/api/v2/transpond/webrtc?v=2"):"https://".concat(C,"/api/v2/transpond/webrtc?v=2"),areaCode:wp()})),w=l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(C=>C.url)}),I=await bp({fragementLength:M("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:C=>(v.debug("[".concat(o.clientId,"] Connect to choose_server:"),C.url),uU(C,o,a,d)),allFailedhandler:C=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},w),C[0]},promisesCollector:f});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},w),I},T=async()=>{if(await hr(1e3),h!==null)return h;const S=M("WEBCS_DOMAIN_BACKUP_LIST").map(C=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(C+"/api/v2/transpond/webrtc?v=2"):"https://".concat(C,"/api/v2/transpond/webrtc?v=2"),areaCode:wp()})),w=l.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(C=>C.url)}),I=await bp({fragementLength:M("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:C=>(v.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),C.url),uU(C,o,a,d)),allFailedhandler:C=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},w),C[0]},promisesCollector:f});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},w),I};try{return h=await Pu([m(),T()]),f.length&&f.forEach(S=>S.cancel&&typeof S.cancel=="function"&&S.cancel()),h}catch(S){throw S[0]}}(t,e,n,r)}}async function _U(t,e,n,r,i){const o=t.cloudProxyServer;if(o==="disabled"){if(t.useLocalAccessPoint)return await GR(t,e,n,i);if(M("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:T,proxyInfo:S}=await gU(t,e,n,i);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:T};const w=S.map(I=>({turnServerURL:I.address,tcpport:I.tcpport||Rr.tcpport,udpport:I.udpport||Rr.udpport,username:I.username||Rr.username,password:I.password||Rr.password,forceturn:!1,security:!0}));if(i.useP2P){var a;const I=(a=t.uid)!==null&&a!==void 0?a:T.uid,C="glb:".concat(I.toString()),N=await My(C),P=S.map(x=>({turnServerURL:x.address,tcpport:x.tcpport||Rr.tcpport,udpport:x.udpport||Rr.udpport,username:C,password:N,forceturn:!1,security:!0}));w.push(...P)}return t.turnServer={mode:"manual",servers:w},{gatewayInfo:T}}return await GR(t,e,n,i)}const{proxyInfo:d,gatewayInfo:l}=await gU(t,e,n,i),h={gatewayInfo:l},f=d.map(T=>({turnServerURL:T.address,tcpport:o==="proxy3"?void 0:T.tcpport?T.tcpport:Rr.tcpport,udpport:o==="proxy4"?void 0:T.udpport?T.udpport:Rr.udpport,username:T.username||Rr.username,password:T.password||Rr.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(i.useP2P){var m;const T=(m=t.uid)!==null&&m!==void 0?m:l.uid,S="glb:".concat(T.toString()),w=await My(S),I=d.map(C=>({turnServerURL:C.address,tcpport:o==="proxy3"?void 0:C.tcpport||Rr.tcpport,udpport:o==="proxy4"?void 0:C.udpport||Rr.udpport,username:S,password:w,forceturn:o!=="proxy4",security:o==="proxy5"}));f.push(...I)}return t.turnServer={mode:"manual",servers:f},v.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),h}async function mU(t,e,n,r,i){const o=M("ACCOUNT_REGISTER").slice(0,M("AJAX_REQUEST_CONCURRENT"));let a=[];a=e.proxyServer?o.map(l=>"https://".concat(e.proxyServer,"/ap/?url=").concat(l+"/api/v1")):o.map(l=>"https://".concat(l,"/api/v1"));const d=i==null?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:a});try{const l=await async function(h,f,m,T,S){const w=Date.now(),I={sid:m.sid,opid:10,appid:m.appId,string_uid:f};let C=h[0];const N=await Xs(()=>eo(C+"".concat(C.indexOf("?")===-1?"?":"&","action=stringuid"),{data:I,cancelToken:T,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(P,x)=>{if(P.code===0){if(P.uid<=0||P.uid>=Math.pow(2,32))throw v.error("Invalid Uint Uid ".concat(f," => ").concat(P.uid),P),bt.reqUserAccount(I.sid,{lts:w,success:!1,serverAddr:C,stringUid:I.string_uid,uid:P.uid,errorCode:D.INVALID_UINT_UID_FROM_STRING_UID,extend:I}),new z(D.INVALID_UINT_UID_FROM_STRING_UID);return bt.reqUserAccount(I.sid,{lts:w,success:!0,serverAddr:C,stringUid:I.string_uid,uid:P.uid,errorCode:null,extend:I}),!1}const W=Au(P.code);return W.retry&&(C=h[(x+1)%h.length]),bt.reqUserAccount(I.sid,{lts:w,success:!1,serverAddr:C,stringUid:I.string_uid,uid:P.uid,errorCode:W.desc,extend:I}),W.retry},(P,x)=>P.code!==D.OPERATION_ABORTED&&(bt.reqUserAccount(I.sid,{lts:w,success:!1,serverAddr:C,stringUid:I.string_uid,uid:null,errorCode:P.code,extend:I}),C=h[(x+1)%h.length],!0),S);if(N.code!==0){const P=Au(N.code);throw new z(D.UNEXPECTED_RESPONSE,P.desc)}return N}(a,t,e,n,r);return i==null||i.recordJoinChannelService({status:"success",endTs:Date.now()},d),l.uid}catch(l){throw i==null||i.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[l]},d),l}}async function i$(t,e,n){const r=M("ACCOUNT_REGISTER");let i=[];i=e.proxyServer?r.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):r.map(o=>"https://".concat(o,"/api/v1"));try{return await fU({referenceList:i,asyncMapHandler:a=>async function(d,l,h,f){const m=Date.now(),T={sid:h.sid,opid:10,appid:h.appId,string_uid:l};try{const S=await eo(d+"".concat(d.indexOf("?")===-1?"?":"&","action=stringuid"),{data:T,cancelToken:f,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(S.code!==0){const w=Au(S.code);throw new z(D.UNEXPECTED_RESPONSE,"preload sua error:".concat(w.desc),w)}if(S.uid<=0||S.uid>=Math.pow(2,32))throw new z(D.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:m,url:d,req:T,uid:S.uid,elapse:Date.now()-m}}catch(S){throw S}}(a,t,e,n),closeFn:a=>a.code===D.OPERATION_ABORTED||a.code===D.UNEXPECTED_RESPONSE&&!a.data.retry})}catch(o){throw o}}async function s$(t,e,n){const r=M("CDS_AP").slice(0,M("AJAX_REQUEST_CONCURRENT")).map(l=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(l+"/api/v1"):"https://".concat(l,"/api/v1?action=config")),i=r.map(l=>function(h,f,m,T){const S=ve(),w={flag:64,cipher_method:0,features:Do(Do(Do(Do(Do({install_id:qy(),device:S.name,system:S.os,system_general:navigator.userAgent,vendor:f.appId,version:is,cname:f.cname,session_id:f.sid,proxyServer:f.proxyServer,sdk_type:XQ.WEB_RTC,browser_name:S.name,browser_version:S.version,user_agent:navigator.userAgent,channel_name:f.cname},f.stringUid&&{string_uid:f.stringUid}),f.uid&&{uid:f.uid+""}),S.os&&{os_name:S.os}),S.osVersion&&{os_version:S.osVersion}),{},{detail:""})};return Xs(()=>eo(h,{data:w,timeout:1e3,cancelToken:m,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,I=>I.code!==D.OPERATION_ABORTED,T)}(l,t,e,n));let o=null,a=null,d={};try{o=await Pu(i)}catch(l){if(l.code===D.OPERATION_ABORTED)throw l;a=l}if(i.forEach(l=>l.cancel()),bt.reportApiInvoke(t.sid,{name:Kn.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:o}}).onSuccess(),o&&o.test_tags)try{d=function(l){if(!l.test_tags)return{};const h=l.test_tags,f=Object.keys(h),m={};return f.forEach(T=>{var S;const w=Br(S=T.slice(4)).call(S),I=JSON.parse(h[T]),C=I[1];m[w]={tag:I[0]||"",value:C}}),m}(o)}catch{}return d}async function EU(t,e){const n=M("WEBCS_DOMAIN").concat(M("WEBCS_DOMAIN_BACKUP_LIST")).map(r=>({url:"https://".concat(r,"/api/v2/transpond/webrtc?v=2"),areaCode:wp(),serviceIds:[Bn.CHOOSE_SERVER,Bn.CLOUD_PROXY_FALLBACK]}));try{return await fU({referenceList:n,asyncMapHandler:i=>async function(o,a,d){let l,{url:h,areaCode:f,serviceIds:m}=o;const T=Date.now(),[S,w]=jR(a,f,m);let I=Fn.networkState;try{I&&Fn.networkState===ki.OFFLINE&&Fn.onlineWaiter&&await mt.race([Fn.onlineWaiter,hr(qn.maxRetryTimeout)]),I=Fn.networkState;const{data:C,headers:N}=await eo(h,{data:S,cancelToken:d,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=N.http3==="1"?1:-1,(H=>{const j=[];if(H.response_body.forEach($=>{const ct=$.buffer.code;if($.uri===23&&ct===0&&!$.buffer.edges_services)if($.buffer.flag===4194310)$.buffer.edges_services=[];else{const Et={error:new z(D.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:H.detail[502]}),flag:$.buffer.flag};j.push(Et)}if(ct!==0){const Et=Au(ct),Tt={error:new z(D.CAN_NOT_GET_GATEWAY_SERVER,Et.desc,{desc:Et.desc,retry:Et.retry,csIp:H.detail[502]}),flag:$.buffer.flag};$.buffer.flag===4194310?v.warning(Tt.error.toString()):j.push(Tt)}}),j.length)throw new z(D.CAN_NOT_GET_GATEWAY_SERVER,j.map($=>"flag: ".concat($.flag,", message: ").concat($.error.message)).join(" | "),{retry:!!j.find($=>$.error.data.retry),csIp:H.detail[502],desc:[...new Set(j.map($=>{var ct;return $==null||(ct=$.error)===null||ct===void 0||(ct=ct.data)===null||ct===void 0?void 0:ct.desc}).filter($=>!!$))]})})(C);const x=Rp(C,Bn.CHOOSE_SERVER),W=Rp(C,Bn.CLOUD_PROXY_FALLBACK);return BR(x),{gatewayInfo:OR(x,h),proxyInfo:W,opid:w,requestTime:T,url:h,isHttp3:l,elapse:Date.now()-T}}catch(C){throw C}}(i,t,e),closeFn:i=>i.code===D.OPERATION_ABORTED||i.code===D.CAN_NOT_GET_GATEWAY_SERVER&&!i.data.retry})}catch(r){throw r}}async function gU(t,e,n,r){const i=M("PROXY_SERVER_TYPE3"),o=(S,w,I)=>{let C=I||i;return Array.isArray(C)&&(C=w%2==0?i[1]:i[0]),"https://".concat(C,"/ap/?url=").concat(S)};let a=null;const d=[],l=async()=>{const S=M("WEBCS_DOMAIN").slice(0,M("AJAX_REQUEST_CONCURRENT")).map((C,N)=>{let P;return P=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(C,"/api/v2/transpond/webrtc?v=2"),N,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(C,"/api/v2/transpond/webrtc?v=2"):o("".concat(C,"/api/v2/transpond/webrtc?v=2"),N),{url:P,areaCode:wp(),serviceIds:[Bn.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Bn.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Bn.CLOUD_PROXY:Bn.CLOUD_PROXY_FALLBACK]}}),w=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(C=>C.url)}),I=await bp({fragementLength:M("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:C=>(v.debug("[".concat(t.clientId,"] Connect to choose_server:"),C.url),hU(C,t,e,n)),allFailedhandler:C=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},w),C[0]},promisesCollector:d});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},w),I},h=async()=>{if(await hr(1e3),a!==null)return a;const S=M("WEBCS_DOMAIN_BACKUP_LIST").map((C,N)=>{let P;return P=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(C,"/api/v2/transpond/webrtc?v=2"),N,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(C,"/api/v2/transpond/webrtc?v=2"):o("".concat(C,"/api/v2/transpond/webrtc?v=2"),N),{url:P,areaCode:wp(),serviceIds:[Bn.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Bn.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Bn.CLOUD_PROXY:Bn.CLOUD_PROXY_FALLBACK]}}),w=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(C=>C.url)}),I=await bp({fragementLength:M("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:C=>(v.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),C.url),hU(C,t,e,n)),allFailedhandler:C=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},w),C[0]},promisesCollector:d});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},w),I};let f,m,T;try{({gatewayInfo:f,proxyInfo:m,url:T}=await Pu([l(),h()]))}catch(S){throw S[0]}if(d.length&&d.forEach(S=>S.cancel&&typeof S.cancel=="function"&&S.cancel()),!f||!m)throw new z(D.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=T,t.cloudProxyServer!=="disabled"&&Array.isArray(i)&&T){const S=/^https?:\/\/(.+?)(\/.*)?$/.exec(T)[1];ft(i).call(i,S)&&(t.proxyServer=S,v.setProxyServer(S),bt.setProxyServer(S))}return a={gatewayInfo:f,proxyInfo:await G1(m,f.uid)},a}async function o$(t,e,n){const r=M("UAP_AP").slice(0,M("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),i=r.map(o=>function(a,d,l,h){const f={command:"convergeAllocateEdge",sid:d.sid,appId:d.appId,token:d.token,ts:Date.now(),version:is,cname:d.cname,uid:d.uid.toString(),requestId:FR,seq:FR};FR+=1;const m={service_name:"tele_channel",json_body:JSON.stringify(f)};return Xs(async()=>{const T=await eo(a,{data:m,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(T.code!==0){const w=new z(D.UNEXPECTED_RESPONSE,"cross channel ap error, code"+T.code,{retry:!0});throw v.error(w.toString()),w}const S=JSON.parse(T.json_body);if(S.code!==200){const w=new z(D.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(S.code,", reason: ").concat(S.reason));throw v.error(w.toString()),w}if(!S.servers||S.servers.length===0){const w=new z(D.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw v.error(w.toString()),w}return{vid:S.vid,workerToken:S.workerToken,addressList:(M("CHANNEL_MEDIA_RELAY_SERVERS")||S.servers).map(w=>"wss://".concat(w.address.replace(/\./g,"-"),".").concat(M("WORKER_DOMAIN"),":").concat(w.wss))}},void 0,T=>!!(T.code!==D.OPERATION_ABORTED&&T.code!==D.UNEXPECTED_RESPONSE||T.data&&T.data.retry),h)}(o,t,e,n));try{const o=await Pu(i);return i.forEach(a=>a.cancel()),o}catch(o){throw o[0]}}async function a$(t,e,n){let r=null;const i=[],o=async a=>{const d=M(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(l=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(l+"/api/v2/transpond/webrtc?v=2"):"https://".concat(l,"/api/v2/transpond/webrtc?v=2"));return a&&(await hr(1e3),r!==null)?r:await bp({fragementLength:M("FRAGEMENT_LENGTH"),referenceList:d,asyncMapHandler:l=>(v.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),l),function(h,f,m,T){const[S]=r$(f,[Bn.CHOOSE_SERVER]);let w=Fn.networkState;return Xs(async()=>{w&&Fn.networkState===ki.OFFLINE&&Fn.onlineWaiter&&await mt.race([Fn.onlineWaiter,hr(T&&T.maxRetryTimeout||qn.maxRetryTimeout)]),w=Fn.networkState;const I=await eo(h,{data:S,cancelToken:m,headers:{"Content-Type":"multipart/form-data;"}},!0);return n$(I,h)},()=>!1,I=>I.code!==D.OPERATION_ABORTED&&(I.code===D.UPDATE_TICKET_FAILED?I.data.retry:(v.warning("[".concat(f.clientId,"] update ticket network error, retry"),I),!0)),T)}(l,t,e,n)),allFailedhandler:l=>{throw l[0]},promisesCollector:i})};try{return r=await Pu([o(!1),o(!0)]),i.length&&i.forEach(a=>a.cancel&&typeof a.cancel=="function"&&a.cancel()),r}catch(a){throw a[0]}}function TU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function WR(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?TU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):TU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class c$ extends _n{get isSuccess(){return!!this.configs}constructor(e,n){super(),b(this,"configs",void 0),b(this,"store",void 0),b(this,"joinInfo",void 0),b(this,"cancelToken",void 0),b(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),b(this,"interval",void 0),b(this,"mutex",void 0),b(this,"mutableParamsRead",!1),b(this,"configCache",{}),b(this,"limit_bitrate",void 0),this.mutex=new Or("config-distribute",e),this.store=n}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),M("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},M("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,bt.reportApiInvoke(null,{options:void 0,name:Kn.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:vn.TRACER}).onSuccess(JSON.stringify(Qs))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void v.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await s$(this.joinInfo,this.cancelToken,this.retryConfig),v.debug("[config-distribute] get config distribute",JSON.stringify(e));const r=function(i){var o;const a=Jh(o=Object.keys(i).filter(h=>/^webrtc_ng_global_parameter/.test(h))).call(o);for(let h=0;h<a.length;h++)for(let f=a.length-1;f>h;f--){const m=a[f],T=i[m].value;if(typeof T.__priority=="number"){const S=T.__priority,w=a[f-1],I=i[w].value;if(typeof I.__priority=="number"){if(!(S>I.__priority))continue;{const C=m;a[f]=a[f-1],a[f-1]=C}}else{const C=m;a[f]=a[f-1],a[f-1]=C}}}const d=Date.now();let l={};return a.forEach(h=>{const f=i[h].value.__expires;f&&f<=d||(l[h]=i[h])}),l}(e);this.cacheGlobalParameterConfig(r),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=r}catch(r){const i=new z(D.NETWORK_RESPONSE_ERROR,r);v.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){N1(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(Sp.UPDATE_BITRATE_LIMIT,e):this.emit(Sp.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&WR({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{const n={},r=Object.keys(e),i=[];r.forEach(o=>{const a=e[o].value;n[o]=a;const d=a.__id;if(d&&this.configCache[o]&&this.configCache[o].__id===d)return;const l=a.__type,h=e[o].value,f=e[o].tag;let m=0;l?l===sL.REALTIME&&(m=1):Object.keys(h).some(T=>Object.prototype.hasOwnProperty.call(Xy,T)||!TR()&&Object.prototype.hasOwnProperty.call(Ym,T)?(m=1,!0):void 0),i.push({tag:f,isApplied:m,feature:o,params:JSON.stringify(a)})}),i.forEach(o=>{let{tag:a,feature:d,params:l,isApplied:h}=o;this.store.sessionId&&bt.abTest(this.store.sessionId,{intSucc:1,isApplied:h,tag:a,feature:d,params:l,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=n}catch(n){v.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(e){const n=function(i){const o={};return Object.keys(i).forEach(a=>{const d=i[a].value,l=d.__expires,h=d.__type;Object.keys(d).forEach(f=>{f==="__id"||f==="__type"||f==="__priority"||f==="__expires"||Object.prototype.hasOwnProperty.call(o,f)||(o[f]=WR(WR({value:d[f]},l&&{expires:l}),h&&{type:h}))})}),o}(e);try{var r;const i=(r=n.LIMIT_BITRATE)===null||r===void 0?void 0:r.value;delete n.LIMIT_BITRATE,i&&N1(i)&&this.handleBitrateLimit(i),this.limit_bitrate=i,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(e),function(d){try{const l=Date.now();Object.keys(d).forEach(h=>{const{value:f,type:m,expires:T}=d[h];T&&T<=l||((m===sL.REALTIME||Object.prototype.hasOwnProperty.call(Xy,h))&&(Qs[h]=f,tn[h]=f,v.debug("Update realtime parameters from config distribute",h,f)),m||TR()||!Object.prototype.hasOwnProperty.call(Ym,h)||(Qs[h]=f,tn[h]=f,v.debug("Update gateway parameters from config distribute",h,f)))})}catch(l){v.error("Error update config immediately: ".concat(d),l.message)}}(n);const o=JSON.stringify(n),a=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",a),v.debug("Caching global parameters ".concat(o))}catch(i){v.error("Error caching global parameters:",i.message)}}handleGlobalParameterConfig(e){try{const n=Date.now();Object.keys(e).forEach(r=>{if(r==="CLIENT_ROLE_OPTIONS"&&Object.prototype.hasOwnProperty.call(tn,r)){const{value:i,expires:o}=e[r];if(o&&o<=n)return;(function(a,d){try{return typeof a=="object"&&typeof d=="object"&&JSON.stringify(a)===JSON.stringify(d)}catch{return!1}})(tn[r],i)||(Qs[r]=i,tn[r]=i,this.emit(Sp.UPDATE_CLIENT_ROLE_OPTIONS,i),v.debug("Updating client role options: ".concat(JSON.stringify(i))))}})}catch(n){v.error("Error handling global parameter config:",n.message)}}}class d$ extends _n{constructor(){super(...arguments),b(this,"resultStorage",new Map)}setLocalAudioStats(e,n,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(r,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(r,n))}setLocalVideoStats(e,n,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(r,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(r,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(r))}setRemoteAudioStats(e,n){const r=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){const r=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(n))}record(e,n,r){if(M("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const i=this.resultStorage.get(e);if(i&&(i.result.push(r),i.result.length>=5)){var o;const a=ft(o=i.result).call(o,!0);i.isPrevNormal&&!a&&this.emit("exception",SU[e],e,n),!i.isPrevNormal&&a&&this.emit("exception",SU[e]+2e3,e+"_RECOVER",n),i.isPrevNormal=a,i.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof $n&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let r=null;n._encoderConfig&&n._encoderConfig.frameRate&&(r=Li(n._encoderConfig.frameRate));const i=e.captureFrameRate;return!r||!i||!(r>10&&i<5||r<10&&r>=5&&i<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,n){return!!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof $n&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const SU={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Dr=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}};function vU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function bd(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class Op{constructor(e){b(this,"store",void 0),b(this,"onStatsException",void 0),b(this,"onUploadPublishDuration",void 0),b(this,"onStatsChanged",void 0),b(this,"localStats",new Map),b(this,"remoteStats",new Map),b(this,"updateStatsInterval",void 0),b(this,"trafficStats",void 0),b(this,"trafficStatsPeerList",[]),b(this,"uplinkStats",void 0),b(this,"exceptionMonitor",void 0),b(this,"p2pChannel",void 0),b(this,"scalabilityMode",qm.L1T1),b(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new d$,this.exceptionMonitor.on("exception",(n,r,i)=>{this.onStatsException&&this.onStatsException(n,r,i)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(at.LocalAudioTrack)||bd({},eR)}getLocalVideoTrackStats(){return this.localStats.get(at.LocalVideoTrack)||bd({},nR)}getRemoteAudioTrackStats(e){const n=(o,a)=>{if(!this.trafficStats)return a;const d=this.trafficStats.peer_delay.find(l=>l.peer_uid===o);return d&&(a.publishDuration=d.B_ppad+(Date.now()-this.trafficStats.timestamp)),a},r={};if(e){var i;const o=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.audioStats;o&&(r[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[a,{audioStats:d}]=o;d&&(r[a]=n(a,d))});return r}getRemoteNetworkQualityStats(e){const n={};if(e){var r;const i=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.networkStats;i&&(n[e]=i)}else Array.from(this.remoteStats.entries()).forEach(i=>{let[o,{networkStats:a}]=i;a&&(n[o]=a)});return n}getRemoteVideoTrackStats(e){const n=(o,a)=>{if(!this.trafficStats)return a;const d=this.trafficStats.peer_delay.find(l=>l.peer_uid===o);return d&&(a.publishDuration=d.B_ppvd+(Date.now()-this.trafficStats.timestamp)),a},r={};if(e){var i;const o=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.videoStats;o&&(r[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[a,{videoStats:d}]=o;d&&(r[a]=n(a,d))});return r}getRTCStats(){let e=0,n=0,r=0,i=0;const o=this.localStats.get(at.LocalAudioTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);const a=this.localStats.get(at.LocalVideoTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate);const d=this.localStats.get(at.LocalVideoLowTrack);d&&(e+=d.sendBytes,n+=d.sendBitrate),this.remoteStats.forEach(h=>{let{audioStats:f,videoStats:m}=h;f&&(r+=f.receiveBytes,i+=f.receiveBitrate),m&&(r+=m.receiveBytes,i+=m.receiveBitrate)});let l=1;return this.trafficStats&&(l+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:l,SendBitrate:n,SendBytes:e,RecvBytes:r,RecvBitrate:i,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),e.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var r;const i=(r=this.p2pChannel)===null||r===void 0?void 0:r.getRemoteMedia(n.peer_uid),o=i!=null&&i.videoSSRC?Dr.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,a=i!=null&&i.audioSSRC?Dr.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>a?o:a),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&v.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,r){if(!e)return!1;const i=!!r&&n.framesDecodeFreezeTime>r.framesDecodeFreezeTime,o=!r||n.framesDecodeCount>r.framesDecodeCount;return i||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[r,i]=n;switch(r){case at.LocalVideoTrack:case at.LocalVideoLowTrack:{const a=i,d=bd({},nR),l=e.getStats(),h=e.getLocalMedia(r);if(l){const f=l.videoSend.find(m=>m.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(f){const m=e.getLocalVideoSize(),T=e.getEncoderConfig(at.LocalVideoTrack);f.codec!=="H264"&&f.codec!=="H265"&&f.codec!=="VP8"&&f.codec!=="VP9"&&f.codec!=="AV1X"&&f.codec!=="AV1"||(d.codecType=f.codec),d.sendBytes=f.bytes,d.sendBitrate=a?8*Math.max(0,d.sendBytes-a.sendBytes):0,f.inputFrame?(d.captureFrameRate=f.inputFrame.frameRate,d.captureResolutionHeight=f.inputFrame.height,d.captureResolutionWidth=f.inputFrame.width):m&&(d.captureResolutionWidth=m.width,d.captureResolutionHeight=m.height),f.sentFrame?(d.sendFrameRate=f.sentFrame.frameRate,d.sendResolutionHeight=f.sentFrame.height,d.sendResolutionWidth=f.sentFrame.width):m&&(d.sendResolutionWidth=m.width,d.sendResolutionHeight=m.height),f.avgEncodeMs&&(d.encodeDelay=f.avgEncodeMs),T&&T.bitrateMax&&(d.targetSendBitrate=1e3*T.bitrateMax),d.sendPackets=f.packets,d.sendPacketsLost=f.packetsLost,d.sendJitterMs=f.jitterMs,d.sendRttMs=f.rttMs,d.totalDuration=a?a.totalDuration+1:1,d.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(f)&&(d.totalFreezeTime+=1),f.scalabilityMode&&this.scalabilityMode!==f.scalabilityMode&&(v.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(f.scalabilityMode)),this.scalabilityMode=f.scalabilityMode)}this.trafficStats&&(d.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(r,d),((a==null?void 0:a.sendResolutionWidth)!==d.sendResolutionWidth||(a==null?void 0:a.sendResolutionHeight)!==d.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:d.sendResolutionWidth,height:d.sendResolutionHeight})),d&&h&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,h.track,d);break}case at.LocalAudioTrack:{const a=i,d=bd({},eR),l=e.getStats(),h=e.getLocalMedia(r);if(l){const f=l.audioSend.find(m=>m.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(f){if(f.codec!=="opus"&&f.codec!=="aac"&&f.codec!=="PCMU"&&f.codec!=="PCMA"&&f.codec!=="G722"||(d.codecType=f.codec),f.inputLevel)d.sendVolumeLevel=Math.round(32767*f.inputLevel);else{const m=e.getLocalAudioVolume();m&&(d.sendVolumeLevel=Math.round(32767*m))}d.sendBytes=f.bytes,d.sendPackets=f.packets,d.sendPacketsLost=f.packetsLost,d.sendJitterMs=f.jitterMs,d.sendRttMs=f.rttMs,d.sendBitrate=a?8*Math.max(0,d.sendBytes-a.sendBytes):0}}this.trafficStats&&(d.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(at.LocalAudioTrack,d),d&&h&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,h.track,d);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var r,i;let[o,{videoStats:a,audioStats:d,videoPcStats:l}]=n;const h=d,f=a,m=l,T=bd({},mL),S=bd({},EL),w=bd({},YX),{audioTrack:I,videoTrack:C,audioSSRC:N,videoSSRC:P}=e.getRemoteMedia(o);let x;x=this.store.useP2P?e.getStats(!0):e.getStats();const W=(r=x)===null||r===void 0?void 0:r.audioRecv.find(ct=>ct.ssrc===N),H=(i=x)===null||i===void 0?void 0:i.videoRecv.find(ct=>ct.ssrc===P),j=this.trafficStats&&this.trafficStats.peer_delay.find(ct=>ct.peer_uid===o);if(W&&(W.codec!=="opus"&&W.codec!=="aac"&&W.codec!=="PCMU"&&W.codec!=="PCMA"&&W.codec!=="G722"||(T.codecType=W.codec),W.outputLevel?T.receiveLevel=Math.round(32767*W.outputLevel):I&&(T.receiveLevel=Math.round(32767*I.getVolumeLevel())),T.receiveBytes=W.bytes,T.receivePackets=W.packets,T.receivePacketsLost=W.packetsLost,T.receivePacketsDiscarded=W.packetsDiscarded,T.packetLossRate=T.receivePacketsLost/(T.receivePackets+T.receivePacketsLost),T.receiveBitrate=h?8*Math.max(0,T.receiveBytes-h.receiveBytes):0,T.totalDuration=h?h.totalDuration+1:1,T.totalFreezeTime=h?h.totalFreezeTime:0,T.freezeRate=T.totalFreezeTime/T.totalDuration,T.receiveDelay=W.jitterBufferMs,T.totalDuration>10&&Op.isRemoteAudioFreeze(I)&&(T.totalFreezeTime+=1)),H){var $;H.codec!=="H264"&&H.codec!=="H265"&&H.codec!=="VP8"&&H.codec!=="VP9"&&H.codec!=="AV1X"&&H.codec!=="AV1"||(S.codecType=H.codec),S.receiveBytes=H.bytes,S.receiveBitrate=f?8*Math.max(0,S.receiveBytes-f.receiveBytes):0,S.decodeFrameRate=H.decodeFrameRate<0?0:H.decodeFrameRate,S.renderFrameRate=H.decodeFrameRate<0?0:H.decodeFrameRate,H.outputFrame&&(S.renderFrameRate=H.outputFrame.frameRate),H.receivedFrame?(S.receiveFrameRate=H.receivedFrame.frameRate,S.receiveResolutionHeight=H.receivedFrame.height,S.receiveResolutionWidth=H.receivedFrame.width):C&&(S.receiveResolutionHeight=C._videoHeight||0,S.receiveResolutionWidth=C._videoWidth||0),H.framesRateFirefox!==void 0&&(S.receiveFrameRate=Math.round(H.framesRateFirefox)),S.receivePackets=H.packets,S.receivePacketsLost=H.packetsLost,S.packetLossRate=S.receivePacketsLost/(S.receivePackets+S.receivePacketsLost);const ct=f?f.totalFreezeTime:0,Et=f?f.totalDuration:0;S.totalDuration=f?f.totalDuration+1:1,S.totalFreezeTime=($=H.totalFreezesDuration)!==null&&$!==void 0?$:ct||0,S.receiveDelay=H.jitterBufferMs||0;const Tt=!!P&&e.getRemoteVideoIsReady(P);H.totalFreezesDuration===void 0&&C&&Tt&&Op.isRemoteVideoFreeze(C,H,m)&&(S.totalFreezeTime+=1),S.freezeRate=Math.max(0,Math.min((S.totalFreezeTime-ct)/(S.totalDuration-Et),1))}j&&(T.end2EndDelay=j.B_ad,S.end2EndDelay=j.B_vd,T.transportDelay=j.B_ed,S.transportDelay=j.B_ed,T.currentPacketLossRate=j.B_ealr4/100,S.currentPacketLossRate=j.B_evlr4/100,w.uplinkNetworkQuality=j.B_punq?j.B_punq:0,w.downlinkNetworkQuality=j.B_pdnq?j.B_pdnq:0),this.remoteStats.set(o,{audioStats:T,videoStats:S,videoPcStats:H,networkStats:w}),I&&this.exceptionMonitor.setRemoteAudioStats(I,T),C&&this.exceptionMonitor.setRemoteVideoStats(C,S)})}}class yU{constructor(){b(this,"destChannelMediaInfos",new Map),b(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){b1(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){b1(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){hE(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function RU(t){if(!(t instanceof yU))return new z(D.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();if(!e)return new z(D.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new z(D.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Sc{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){b(this,"uid",void 0),b(this,"_uintid",void 0),b(this,"_trust_in_room_",!0),b(this,"_trust_audio_enabled_state_",!0),b(this,"_trust_video_enabled_state_",!0),b(this,"_trust_audio_mute_state_",!0),b(this,"_trust_video_mute_state_",!0),b(this,"_audio_muted_",!1),b(this,"_video_muted_",!1),b(this,"_audio_enabled_",!0),b(this,"_video_enabled_",!0),b(this,"_audio_added_",!1),b(this,"_video_added_",!1),b(this,"_is_pre_created",!1),b(this,"_video_pre_subscribed",!1),b(this,"_audio_pre_subscribed",!1),b(this,"_trust_video_stream_added_state_",!0),b(this,"_trust_audio_stream_added_state_",!0),b(this,"_audioTrack",void 0),b(this,"_videoTrack",void 0),b(this,"_dataChannels",[]),b(this,"_audioSSRC",void 0),b(this,"_videoSSRC",void 0),b(this,"_audioOrtc",void 0),b(this,"_videoOrtc",void 0),b(this,"_cname",void 0),b(this,"_rtxSsrcId",void 0),b(this,"_videoMid",void 0),b(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}function IU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function CU(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?IU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):IU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const Np="9",AU=4e4;function wU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Oa(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?wU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}var Du=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(Du||{});const AE=new Map;function bU(t,e,n,r){let{scale:i}=t;if(i===0&&r===Du.UP||i>=e.length-1&&r===Du.DOWN)return t;let o=Oa(Oa({},t),{},{scale:r===Du.DOWN?++i:--i});switch(n){case"maintain-framerate":o=Oa(Oa({},o),e[i].motion);break;case"maintain-resolution":o=Oa(Oa({},o),e[i].detail);break;case"balanced":o=Oa(Oa({},o),e[i].balanced)}return o}function OU(t,e){if(e){const n={overUse:0,underUse:0,adaptationList:NU(e)};AE.set(t,n)}else AE.delete(t)}function NU(t){const e=Oa({},t),{bitrateMax:n,frameRate:r,scaleResolutionDownBy:i,bitrateMin:o}=e,{MIN_FRAME_RATE:a,MAX_THRESHOLD_FRAMERATE:d,MAX_SCALE:l,BITRATE_MIN_THRESHOLD:h,BITRATE_MAX_THRESHOLD:f,BWE_SCALE_UP_THRESHOLD:m,BWE_SCALE_DOWN_THRESHOLD:T,PERF_SCALE_DOWN_THRESHOLD:S,PERF_SCALE_UP_THRESHOLD:w,BALANCE_BITRATE_FACTOR:I,BALANCE_FRAMERATE_FACTOR:C,BALANCE_RESOLUTION_FACTOR:N,MOTION_RESOLUTION_FACTOR:P,MOTION_BITRATE_FACTOR:x,DETAIL_FRAMERATE_FACTOR:W,DETAIL_BITRATE_FACTOR:H}=zy,j=Math.min(e.frameRate,d),$=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(T,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(S,1)*j),fps_up:r},balanced:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o}}];for(let ct=1;ct<=l;ct++){const Et={bwe_up:Math.round(Math.pow(m,ct)*n),bwe_down:Math.round(Math.pow(T,ct+1)*n),fps_up:Math.round(Math.pow(w,ct)*j),fps_down:Math.round(Math.pow(S,ct+1)*j)},Tt={scaleResolutionDownBy:i/Math.pow(N,ct),frameRate:Math.max(Math.round(Math.pow(C,ct)*r),a),bitrateMax:Math.max(Math.round(Math.pow(I,ct)*n),f),bitrateMin:Math.max(Math.round(Math.pow(I,ct)*o),h)},he={scaleResolutionDownBy:i/Math.pow(P,ct),frameRate:r,bitrateMax:Math.max(Math.round(Math.pow(x,ct)*n),f),bitrateMin:Math.max(Math.round(Math.pow(x,ct)*o),h)},pe={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(W,ct)*r),a),bitrateMax:Math.max(Math.round(Math.pow(H,ct)*n),f),bitrateMin:Math.max(Math.round(Math.pow(H,ct)*o),h)};$.push({scale:ct,threshold:Et,balanced:Tt,motion:he,detail:pe})}return $}function l$(t,e,n,r,i,o){const a=AE.get(t)||{overUse:0,underUse:0,adaptationList:NU(i)},{adaptationList:d}=a;AE.set(t,a);const{OVERUSE_TIMES_THRESHOLD:l,UNDERUSE_TIMES_THRESHOLD:h}=zy,{scale:f}=r;let m,T;return typeof e=="number"&&e>0&&function(S,w,I,C){if(w>=I.length)return!1;let{threshold:{fps_down:N}}=I[w];return M("FORCE_AG_HIGH_FRAMERATE")&&C==="maintain-framerate"&&(N=I[0].threshold.fps_down),S<N}(e,f,d,o)&&(a.overUse++,T=fp.CPU,a.overUse>l)||typeof n=="number"&&n>0&&function(S,w,I){if(w>=I.length)return!1;const{threshold:{bwe_down:C}}=I[w];return S<C}(n,f,d)&&(a.overUse++,T=fp.BANDWIDTH,a.overUse>l)?(a.overUse=0,a.underUse=0,m=bU(r,d,o,Du.DOWN),[m,T]):(typeof e=="number"&&e>0&&typeof n=="number"&&n>0&&function(S,w,I,C){if(w===0)return;let{threshold:{fps_up:N}}=I[w];return M("FORCE_AG_HIGH_FRAMERATE")&&C==="maintain-framerate"&&(N=I[1].threshold.fps_up),S>N}(e,f,d,o)&&function(S,w,I){if(w===0)return;const{threshold:{bwe_up:C}}=I[w];return S>C}(n,f,d)&&(a.underUse++,a.underUse>h&&(a.overUse=0,a.underUse=0,m=bU(r,d,o,Du.UP),m.scale===0&&(T=fp.NONE))),[m,T])}function PU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function HR(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?PU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):PU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function u$(t){var e;return!!M("ENABLE_AG_ADAPTATION")&&!!(t instanceof uR||ft(e=t._hints).call(e,Je.CUSTOM_TRACK))&&(!!M("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(n){const r=ve();if(r.os!==er.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return Number(i[0])>=n}(14)&&wk(17,4)||Ak(14)&&bk(17,4,!0)))}const wE=new Map;function bE(t,e){const n=wE.get(t);if(n){const{timer:r}=n;window.clearTimeout(r),wE.delete(t)}e.qualityLimitationReason=fp.NONE,OU(t)}function h$(t,e){var n;let r;switch(e){case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoTrack:r=ft(n=t._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:r=Ue.Low}return r}function KR(t){const e=Ie();if(t.some(n=>n._bypassWebAudio))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function qR(t,e){KR(t);const n=new $n;return t.forEach(r=>n.addAudioTrack(r)),n}const p$=!Ie().supportUnifiedPlan||M("CHROME_FORCE_PLAN_B")&&Ta();function OE(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n;return p$?(n={spec:e,store:t},wa("PlanBConnection").create(n)):new ko(e,t)}function YR(t){return t&&(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")}function DU(t){try{if(t.iceServers)return!1;if(t.turnServer&&t.turnServer.mode!=="off"){if(up(t.turnServer.servers))return!1;if(M("FORCE_TURN_TCP")||t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).some(e=>e.forceturn))return!0}return!1}catch{return!1}}var ge;function kU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function no(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?kU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):kU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let ko=(ge=class Hd extends D1{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return ft(n=Object.keys(zm)).call(n,e)}))]}constructor(e,n){super(e,n),b(this,"id",ze(5,"connection-")),b(this,"store",void 0),b(this,"peerConnection",void 0),b(this,"forceTurn",!1),b(this,"remoteSDP",void 0),b(this,"initialOffer",void 0),b(this,"transportEventReceiver",void 0),b(this,"statsFilter",void 0),b(this,"extension",{useXR:M("USE_XR")}),b(this,"localCapabilities",void 0),b(this,"remoteCodecs",void 0),b(this,"localCandidateCount",0),b(this,"allCandidatesReceived",!1),b(this,"isPreallocation",!1),b(this,"preSSRCMap",new Map),b(this,"dataStreamChannelMap",new Map),b(this,"establishPromise",void 0),b(this,"recoveredDataChannelIds",[]),b(this,"currentDataChannelId",1),b(this,"supportAV1RtpSpec",!1),b(this,"mutex",void 0),b(this,"qualityLimitationReason",fp.NONE),b(this,"isFirstConnected",!1),this.store=n,this.forceTurn=DU(e),this.mutex=new Or("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Hd.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=Ky(this.peerConnection,M("STATS_UPDATE_INTERVAL"),void 0,Tn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){const n=this.preSSRCMap.get(e);if(n!==void 0){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);if(r)return{transceiver:r,track:r.receiver.track,id:n}}}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void v.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else v.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=gc(r.sdp),o=await $1({filterRTX:!M("USE_PUB_RTX")&&!M("USE_SUB_RTX"),filterVideoFec:M("FILTER_VIDEO_FEC"),filterAudioFec:M("FILTER_AUDIO_FEC"),filterVideoCodec:M("FILTER_VIDEO_CODEC")},this.extension);if(this.localCapabilities=vE(o),this.initialOffer=r,M("ENABLE_SVC")&&this.store.codec=="av1"){const d=await async function(){try{const l=new RTCPeerConnection;l.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:qm.L1T3}]});const h=await l.createOffer();if(!h.sdp)return void l.close();const f=Si(h.sdp).mediaDescriptions[0];if(!f)return;const m=f.attributes.extmaps.find(T=>T.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return l.close(),m}catch{return}}();var e;d&&(this.supportAV1RtpSpec=!0,(e=o.send)===null||e===void 0||e.videoExtensions.push(d))}let a;return r.sdp&&nU(r.sdp)&&(a=yn(o),(n=a).send&&(wu(vt.VIDEO,n.send.videoExtensions),wu(vt.AUDIO,n.send.audioExtensions)),n.recv&&(wu(vt.VIDEO,n.recv.videoExtensions),wu(vt.AUDIO,n.recv.audioExtensions)),n.sendrecv&&(wu(vt.VIDEO,n.sendrecv.videoExtensions),wu(vt.AUDIO,n.sendrecv.audioExtensions))),no(no({},i),{},{rtpCapabilities:a||o,offerSDP:r.sdp})}catch(r){throw new et(D.GET_LOCAL_CONNECTION_PARAMS_FAILED,r.toString())}var n}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&nU(this.initialOffer.sdp)&&(n=e.rtpCapabilities,r=this.localCapabilities,n.send&&(gE(vt.VIDEO,n.send.videoExtensions,r.send.videoExtensions),gE(vt.AUDIO,n.send.audioExtensions,r.send.audioExtensions)),n.recv&&(gE(vt.VIDEO,n.recv.videoExtensions,r.recv.videoExtensions),gE(vt.AUDIO,n.recv.audioExtensions,r.recv.audioExtensions))),this.remoteSDP=new class{get localCapabilities(){return yn(this._localCapabilities)}get rtpCapabilities(){return yn(this._rtpCapabilities)}get candidates(){return yn(this._candidates)}get iceParameters(){return yn(this._iceParameters)}get dtlsParameters(){return yn(this._dtlsParameters)}constructor(h){let f=arguments.length>1&&arguments[1]!==void 0&&arguments[1];b(this,"sessionDesc",void 0),b(this,"_localCapabilities",void 0),b(this,"_rtpCapabilities",void 0),b(this,"_candidates",void 0),b(this,"_originCandidates",void 0),b(this,"_iceParameters",void 0),b(this,"_isUseExtmapAllowMixed",void 0),b(this,"_dtlsParameters",void 0),b(this,"setup",void 0),b(this,"currentMidIndex",void 0),b(this,"cname",void 0),b(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=f,h=yn(h);const{iceParameters:m,dtlsParameters:T,candidates:S,rtpCapabilities:w,setup:I,localCapabilities:C,cname:N}=h;this._rtpCapabilities=w,this._candidates=S,this._originCandidates=yn(S),this._iceParameters=m,this._dtlsParameters=T,this._localCapabilities=C,this.setup=I,this.cname=N,this.sessionDesc=this.updateRemoteRTPCapabilities(w),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(h){const f=this.candidates,m=this.dtlsParameters,T=this.iceParameters,S=this.rtpCapabilities.send;let w=this.sessionDesc.mediaDescriptions.length-1;for(let I=1;I<h;I++){const C=2*I+2e4,N=2*I+AU,{ssrcs:P,ssrcGroups:x}=wd([{ssrcId:C}],this.cname),{ssrcs:W,ssrcGroups:H}=wd([{ssrcId:N,rtx:M("USE_SUB_RTX")?N+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Np,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.videoCodecs.map(j=>j.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:T.iceUfrag,icePwd:T.icePwd,unrecognized:[],candidates:f,extmaps:S.videoExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:W,ssrcGroups:H,rtcpFeedbackWildcards:[],payloads:S.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++w)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Np,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.audioCodecs.map(j=>j.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:T.iceUfrag,icePwd:T.icePwd,unrecognized:[],candidates:f,extmaps:S.audioExtensions,fingerprints:m.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:P,ssrcGroups:x,rtcpFeedbackWildcards:[],payloads:S.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++w)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return pc(this.sessionDesc)}send(h,f,m,T){const{ssrcs:S,ssrcGroups:w}=wd(f,this.cname,M("SYNC_GROUP")?m:void 0),I=this.findPreloadMediaDesc(S);if(I){if(Tn()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,I.attributes.mid),T&&(T.twcc||T.remb)){const C=this.sessionDesc.mediaDescriptions.indexOf(I);return this.sessionDesc.mediaDescriptions[C]=this.mungSendMediaDesc(I,T),{mid:I.attributes.mid,needExchangeSDP:!0}}return{mid:I.attributes.mid,needExchangeSDP:!1}}{const C=this.findAvailableMediaIndex(h,S);let N;return C===-1||C===1&&(Sr()||function(){const P=ve();return!(P.name!==Oe.CHROME||!P.osVersion)&&Number(P.version)<=90}()||M("ENABLE_ENCODED_TRANSFORM")&&ga())||C===0&&M("USE_SUB_RTX")||Ok()?(N=this.createOrRecycleSendMedia(h,S,w,"sendonly",T),this.updateBundleMids()):(N=yn(this.sessionDesc.mediaDescriptions[C]),N.attributes.direction="sendonly",N.attributes.ssrcs=S,N.attributes.ssrcGroups=w,this.sessionDesc.mediaDescriptions[C]=this.mungSendMediaDesc(N,T)),Tn()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,N.attributes.mid),{mid:N.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:h,needExchangeSDP:f}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:h.attributes.mid,needExchangeSDP:f}}batchSend(h){const f=h.map(S=>{let{kind:w,ssrcMsg:I,mslabel:C}=S;return this.send(w,I,C)}),m=[];let T=!1;return f.forEach(S=>{let{mid:w,needExchangeSDP:I}=S;I&&(T=!0),m.push(w)}),{mids:m,needExchangeSDP:T}}stopSending(h){const f=this.sessionDesc.mediaDescriptions.filter(m=>m.attributes.mid&&h.indexOf(m.attributes.mid)!==-1);if(f.length!==h.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");f.forEach(m=>{m.attributes.mid==="0"||Tn()||Ok()?m.attributes.ssrcs=[]:(m.attributes.ssrcs=[],m.attributes.direction="inactive",m.media.port="0")}),this.updateBundleMids()}mute(h){const f=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===h);if(!f)throw new Error("mediaDescription not found with ".concat(h," in remote SDP when calling RemoteSDP.mute."));f.attributes.direction="inactive"}unmute(h){const f=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===h);if(!f)throw new Error("mediaDescription not found with ".concat(h," in remote SDP when calling RemoteSDP.unmute."));f.attributes.direction="sendonly"}muteRemote(h){const f=this.sessionDesc.mediaDescriptions.filter(m=>ft(h).call(h,m.attributes.mid||""));if(f.length!==h.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");f.forEach(m=>{m.attributes.direction="inactive"})}unmuteRemote(h){const f=this.sessionDesc.mediaDescriptions.filter(m=>ft(h).call(h,m.attributes.mid||""));if(f.length!==h.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");f.forEach(m=>{m.attributes.direction="recvonly"})}receive(h,f,m,T){h.forEach((S,w)=>{this.createOrRecycleRecvMedia(S,[],"recvonly",f,m,T[w])}),this.updateBundleMids()}stopReceiving(h){const f=this.sessionDesc.mediaDescriptions.filter(m=>h.indexOf(m.attributes.mid)!==-1);if(f.length!==h.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");f.forEach(m=>{m.media.port="0",m.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(h){const f=this.sessionDesc||Si((m=this._isUseExtmapAllowMixed,`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(m?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var m;this._rtpCapabilities=h;const T=this.rtpCapabilities.send,S=this.localCapabilities.send;for(const w of f.mediaDescriptions){if(w.attributes.iceUfrag=this._iceParameters.iceUfrag,w.attributes.icePwd=this._iceParameters.icePwd,w.attributes.fingerprints=this._dtlsParameters.fingerprints,w.attributes.candidates=this._candidates,w.attributes.setup=this.setup,w.media.mediaType==="application"&&(w.attributes.sctpPort="5000"),w.media.mediaType==="video"){if(T.videoCodecs.length===0){const I=S.videoCodecs.filter(C=>{var N,P;return(N=C.rtpMap)===null||N===void 0?void 0:ft(P=N.encodingName.toLowerCase()).call(P,"vp8")})||[S.videoCodecs[0]];w.media.fmts=I.map(C=>C.payloadType.toString(10)),w.attributes.payloads=I,w.attributes.extmaps=[]}else if(w.media.fmts=T.videoCodecs.map(I=>I.payloadType.toString(10)),w.attributes.payloads=T.videoCodecs,w.attributes.extmaps=T.videoExtensions,M("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:I,ssrcGroups:C}=wd([{ssrcId:AU,rtx:M("USE_SUB_RTX")?40001:void 0}],this.cname);w.attributes.ssrcs=I,w.attributes.ssrcGroups=C}}if(w.media.mediaType==="audio"){if(T.audioCodecs.length===0){const I=S.audioCodecs.filter(C=>{var N,P;return(N=C.rtpMap)===null||N===void 0?void 0:ft(P=N.encodingName.toLowerCase()).call(P,"opus")})||[S.audioCodecs[0]];w.media.fmts=I.map(C=>C.payloadType.toString(10)),w.attributes.payloads=I,w.attributes.extmaps=[]}else if(w.media.fmts=T.audioCodecs.map(I=>I.payloadType.toString(10)),w.attributes.payloads=T.audioCodecs,w.attributes.extmaps=T.audioExtensions,Ou(w),M("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:I,ssrcGroups:C}=wd([{ssrcId:2e4}],this.cname);w.attributes.ssrcs=I,w.attributes.ssrcGroups=C}}}return this.sessionDesc=f,this.currentMidIndex=f.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(h){const f=this._originCandidates.filter(T=>T.transport==="udp"),m=[];if(f.forEach(T=>{m.push(CU(CU({},T),{},{foundation:"tcpcandidate",priority:Number(T.priority)-1+"",transport:"tcp",port:Number(T.port)+90+""}))}),f.length!==0){switch(h){case Pr.TCP_RELAY:this._candidates=m;break;case Pr.UDP_TCP_RELAY:case Pr.RELAY:this._candidates=[...f,...m];break;default:this._candidates=f}for(const T of this.sessionDesc.mediaDescriptions)T.attributes.candidates=this.candidates}}restartICE(h){h=yn(h),this._iceParameters=h,this.sessionDesc.mediaDescriptions.forEach(f=>{f.attributes.iceUfrag=h.iceUfrag,f.attributes.icePwd=h.icePwd})}predictReceivingMids(h){const f=[];for(let m=0;m<h;m++)f.push((this.currentMidIndex+m+1).toString(10));return f}findAvailableMediaIndex(h,f){return this.sessionDesc.mediaDescriptions.findIndex(m=>{const T=m.media.mediaType===h&&m.media.port!=="0"&&(m.attributes.direction==="sendonly"||m.attributes.direction==="sendrecv")&&m.attributes.ssrcs.length===0;if(Tn()){if(T){const S=this.firefoxSsrcMidMap.get(f[0].ssrcId);return!(S||m.attributes.mid!=="0"&&m.attributes.mid!=="1")||!(!S||S!==m.attributes.mid)}return!1}return T})}createOrRecycleDataChannel(){for(const m of this.sessionDesc.mediaDescriptions)if(m.media.mediaType==="application")return{mediaDesc:m,needExchangeSDP:!1};this.currentMidIndex+=1;const h="".concat(this.currentMidIndex),f={media:{mediaType:"application",port:Np,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(h),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(f),{mediaDesc:f,needExchangeSDP:!0}}createOrRecycleRecvMedia(h,f,m,T,S,w){const I=h._mediaStreamTrack.kind,C=this.rtpCapabilities.recv,N=Cp(I,C,this.localCapabilities.send,I===vt.VIDEO?T:S),P=I===vt.VIDEO?C.videoExtensions:C.audioExtensions;this.currentMidIndex+=1;const x="".concat(this.currentMidIndex);let W={media:{mediaType:I,port:Np,protos:["UDP","TLS","RTP","SAVPF"],fmts:N.map(j=>j.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:P,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:f,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:N,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:m,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(x)}};W=this.mungRecvMediaDsec(W,h,w);const H=this.findFirstClosedMedia(I);if(H){const j=this.sessionDesc.mediaDescriptions.indexOf(H);this.sessionDesc.mediaDescriptions[j]=W}else this.sessionDesc.mediaDescriptions.push(W);return W}updateRemoteCodec(h,f,m){const T=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(W=>W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||"").filter(W=>{var H;return ft(H=Object.keys(zm)).call(H,W)}))],S=new Set(f);if(T.every(W=>S.has(W)))return v.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(f)),!1;const w=this._rtpCapabilities.recv.videoCodecs.filter(W=>f.some(H=>{var j;return ft(j=W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||"").call(j,H)}));if(w.length===0)return v.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(T," codecs: ").concat(f)),!1;const I=[...new Set(w.map(W=>W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||""))];let C;if(v.debug("updateRemoteCodec, from ".concat(T," to ").concat(I)),h.length===0)C=this.sessionDesc.mediaDescriptions.filter(W=>W.media.mediaType==="video"&&W.attributes.direction==="recvonly");else if(C=this.sessionDesc.mediaDescriptions.filter(W=>W.attributes.mid&&ft(h).call(h,W.attributes.mid)&&W.attributes.direction==="recvonly"),C.length!==h.length)return v.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(h,", codecs: ").concat(f)),!1;if(M("USE_PUB_RTX")||M("USE_SUB_RTX")){const W=kR(w,this.rtpCapabilities.recv.videoCodecs);w.push(...W)}this._rtpCapabilities.recv.videoCodecs=w;const N=this.localCapabilities.send,P=this.rtpCapabilities.recv,x=Cp(vt.VIDEO,P,N,m);return C.forEach(W=>{const H=x.map(j=>j.payloadType.toString(10));v.debug("updateRemoteCodec mid: ".concat(W.attributes.mid,", from"),W.attributes.payloads,"to",x),W.attributes.payloads=x,W.media.fmts=H}),!0}createOrRecycleSendMedia(h,f,m,T,S){const w=this.rtpCapabilities.send,I=h===vt.VIDEO?w.videoCodecs:w.audioCodecs,C=h===vt.VIDEO?w.videoExtensions:w.audioExtensions;this.currentMidIndex+=1;const N="".concat(this.currentMidIndex);let P={media:{mediaType:h,port:Np,protos:["UDP","TLS","RTP","SAVPF"],fmts:I.map(W=>W.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:C,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:f,ssrcGroups:m,rtcpFeedbackWildcards:[],payloads:I,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:T,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(N)}};P=this.mungSendMediaDesc(P,S);const x=this.findFirstClosedMedia(h);if(x){const W=this.sessionDesc.mediaDescriptions.indexOf(x);this.sessionDesc.mediaDescriptions[W]=P}else this.sessionDesc.mediaDescriptions.push(P);return P}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(h=>h.media.port!=="0").map(h=>h.attributes.mid)}mungRecvMediaDsec(h,f,m){const T=yn(h);return PR(T),bu(T,f),DR(T,f),X1(T),SE(T,m,this.localCapabilities.send),T}mungSendMediaDesc(h,f){const m=yn(h);return SE(m,f,this.localCapabilities.recv),Ou(m),m}updateRecvMedia(h,f){const m=this.sessionDesc.mediaDescriptions.findIndex(T=>T.attributes.mid===h);if(m!==-1){const T=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[m],f);this.sessionDesc.mediaDescriptions[m]=T}}bumpMid(h){this.currentMidIndex+=h}findFirstClosedMedia(h){return this.sessionDesc.mediaDescriptions.find(f=>Tn()?f.media.port==="0"&&f.media.mediaType===h:f.media.port==="0")}findPreloadMediaDesc(h){return this.sessionDesc.mediaDescriptions.find(f=>{var m;return((m=f.attributes)===null||m===void 0||(m=m.ssrcs[0])===null||m===void 0?void 0:m.ssrcId)===h[0].ssrcId})}getSSRC(h){var f;return(f=this.sessionDesc.mediaDescriptions.find(m=>m.attributes.mid===h))===null||f===void 0?void 0:f.attributes.ssrcs}}(no(no({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const i=this.remoteSDP.toString(),o=tU(this.initialOffer.sdp,this.extension),a=this.logSDPExchange(o||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:o}),a==null||a(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i});const d=this.peerConnection.getTransceivers()[0];if(d!=null&&d.receiver&&this.tryBindTransportEvents(d.receiver),M("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(M("PRELOAD_MEDIA_COUNT"));const h=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:h});const f=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(f)}const{preSSRCs:l}=e;if(Array.isArray(l)&&l.length>0){const{mids:h}=this.remoteSDP.batchSend(l.map(f=>({kind:f.kind,ssrcMsg:[{ssrcId:f.ssrcId,rtx:f.rtx}],mslabel:f.mslabel})));h.forEach((f,m)=>{this.preSSRCMap.set(l[m].ssrcId,f)}),await Ap(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(i){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}var n,r}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:n}=e;this.remoteSDP.updateRemoteRTPCapabilities(n),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:r}=e;if(Array.isArray(r)&&r.length>0){const{mids:i}=this.remoteSDP.batchSend(r.map(o=>Object.assign({},{kind:o.kind,ssrcMsg:[{ssrcId:o.ssrcId,rtx:o.rtx}],mslabel:o.mslabel})));i.forEach((o,a)=>{this.preSSRCMap.set(r[a].ssrcId,o)})}await Ap(this.peerConnection,this.remoteSDP,this.extension),v.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(e,n,r){var i=this;return rs(function*(){const o=yield Se(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const a=[],d=EE();e.forEach(C=>{const N=i.peerConnection.addTransceiver(C._mediaStreamTrack,no({direction:"sendonly"},C.trackMediaType==="video"&&i.supportAV1RtpSpec&&d?{sendEncodings:[{scalabilityMode:d}]}:{}));a.push(N),C._updateRtpTransceiver(N)}),Tn()&&M("SIMULCAST")===!0&&(yield Se(i.applySimulcastForFirefox(a,e)));const l=yield Se(i.peerConnection.createOffer()),h=i.remoteSDP.predictReceivingMids(e.length),f=i.mungSendOfferSDP(l.sdp,e,h),m=Si(f),T=h.map(C=>{const N=m.mediaDescriptions.find(P=>P.attributes.mid===C);if(!N)throw new Error("Cannot extract ssrc from mediaDescription.");return Y1(N,M("USE_PUB_RTX"))});let S;try{S=yield T}catch(C){S=[],i.remoteSDP.receive(e,n,r,S);const N=i.remoteSDP.toString();throw yield Se(i.peerConnection.setLocalDescription({type:"offer",sdp:f})),yield Se(i.peerConnection.setRemoteDescription({type:"answer",sdp:N})),yield Se(i.stopSending(h,!0)),C}i.remoteSDP.receive(e,n,r,S);const w=i.remoteSDP.toString(),I=i.logSDPExchange(f,"offer","local","send");return yield Se(i.peerConnection.setLocalDescription({type:"offer",sdp:f})),yield Se(i.applySimulcastEncodings(a,e)),yield Se(i.applySendEncodings(a,e)),I==null||I(w),yield Se(i.peerConnection.setRemoteDescription({type:"answer",sdp:w})),a.map((C,N)=>{const P=h[N];return{localSSRC:T[N],id:P,transceiver:C}})}catch(a){throw a instanceof et?a:new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{o()}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(e);if(r&&r.readyState==="open")v.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:M("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,r)}n.forEach(o=>{o._updateOriginDataChannel(r)});const{needExchangeSDP:i}=this.remoteSDP.sendDataChannel();if(i){const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),v.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else v.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof et?r:new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof et?n:new et(D.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){const r=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getTransceivers().filter(l=>e.indexOf(l.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(l=>{var h;bE(this.id+l.mid,this),l.direction="inactive",(h=l.stop)===null||h===void 0||h.call(l)});const o=await this.peerConnection.createOffer(),a=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const d=this.remoteSDP.toString();a==null||a(d),await this.peerConnection.setRemoteDescription({type:"answer",sdp:d})}catch(i){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}finally{r&&r()}}async receive(e,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,n,r,i);a&&(await Ap(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const d=this.peerConnection.getTransceivers().find(l=>l.mid===o);if(!d)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:d.receiver.track,id:o,transceiver:d}}catch(o){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:r}=this.remoteSDP.batchSend(e);return r&&(await Ap(this.peerConnection,this.remoteSDP,this.extension),v.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map(i=>{const o=this.peerConnection.getTransceivers().find(a=>a.mid===i);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:i,transceiver:o}})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preSSRCMap.entries()).some(a=>{let[d,l]=a;if(l===o)return this.preSSRCMap.delete(d),!0})}),this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(a=>a.mid&&e.indexOf(a.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(a=>{a.direction="inactive"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(a=>a.mid&&e.indexOf(a.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(a,d)=>{a.direction="sendonly"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return rs(function*(){const r=yield Se(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const i=Ie().supportPCSetConfiguration,o=M("FORCE_TURN_TCP")||n.forceTurn;if(e===Pr.RELAY&&!i)return;if(i&&!o){const m=e===Pr.RELAY?"relay":"all",T=n.peerConnection.getConfiguration();T.iceTransportPolicy!==m&&(v.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(T.iceTransportPolicy,"] to [").concat(m,"]")),T.iceTransportPolicy=m,n.peerConnection.setConfiguration(T))}n.remoteSDP.updateCandidates(e);const a=yield Se(n.peerConnection.createOffer({iceRestart:!0}));if(!a.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const d=gc(a.sdp),{remoteIceParameters:l}=yield d.iceParameters;n.remoteSDP.restartICE(l);const h=n.remoteSDP.toString(),f=n.logSDPExchange(a.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Se(n.peerConnection.setLocalDescription(a)),f==null||f(h),yield Se(n.peerConnection.setRemoteDescription({type:"answer",sdp:h}))}catch(i){v.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const e=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(Pr.TCP_RELAY),await Ap(this.peerConnection,this.remoteSDP,this.extension)}catch(n){v.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{bE(this.id+n.mid,this)}),this.preSSRCMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return no(no({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const o=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),a==null||a(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new et(D.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,n){const r=this.peerConnection.getTransceivers().filter(i=>i.mid===e);r.length===1&&(this.isVP8Simulcast(n)?Tn()||await this.applySimulcastEncodings(r,[n]):await this.applySendEncodings(r,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);r&&await r.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:r,remote:i}=n.getSelectedCandidatePair();return{local:no(no({},wo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:no(no({},wo),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var n;const r="code: ".concat(e.errorCode,", message: ").concat(e.errorText),i=e.port?"local: ".concat(e.port):"";v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(r,"), url: ").concat(e.url||"",", host_candidate:").concat(i)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,r)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},M("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&(up(e.turnServer.servers)?n.iceServers=e.turnServer.servers:M("NEW_TURN_MODE")&&n.iceServers?(M("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&n.iceServers.push(...Hd.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):n.iceServers.push(...Hd.newTurnServerConfigToIceServers(e.turnServer.servers)),M("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Hd.turnServerConfigToIceServers(e.turnServer.servers)),M("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Hd.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),M("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),M("ENABLE_ENCODED_TRANSFORM")&&Ie().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(mc(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!M("FORCE_TURN_TCP")&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}static newTurnServerConfigToIceServers(e){const n=[];return e.forEach(r=>{const i=M("NEW_TURN_MODE");i===1?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}):i===2?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}):i===3?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(mc(r.turnServerURL),":443?transport=tcp")}):i===4&&(n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(mc(r.turnServerURL),":443?transport=tcp")}))}),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var i;n!=null&&n.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,n.state))},n.onerror=i=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in i?i.error:i)};const r=n.iceTransport;r&&(r.onstatechange=()=>{const i=n==null?void 0:n.iceTransport.state;var o;i&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,i))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:i,remote:o}=r.getSelectedCandidatePair();v.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var r,i;if(n||(n=this.peerConnection.getSenders().find(C=>C.track===e._mediaStreamTrack)),!n)return v.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return v.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ie().supportSetRtpSenderParameters)return v.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},a={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const d=function(I,C){return I.getTransceivers().find(N=>N.sender.track===C||N.receiver.track===C)}(this.peerConnection,e._mediaStreamTrack),l=$X(e);if(u$(e)&&d&&n&&l&&this.getLocalVideoStats&&ft(r=["vp8","vp9"]).call(r,this.store.codec)){var h;const I=o.degradationPreference||(ft(h=e._hints).call(h,Je.CUSTOM_TRACK)?M("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(C,N,P,x,W,H){if(bE(C,P),W(N),x!=="balanced"&&x!=="maintain-framerate"&&x!=="maintain-resolution")return;let j=-1;OU(C,N);const $=window.setInterval(()=>{const Et=wE.get(C);if(!M("ENABLE_AG_ADAPTATION")||!Et)return bE(C,P),void W(N);const Tt=H();if(Tt.sendPackets>0&&Tt.OutgoingAvailableBandwidth>0){if(j===-1)return void(j=Date.now());if(Date.now()-j<1e3)return;const he=Tt.sendFrameRate,pe=Tt.OutgoingAvailableBandwidth,[Xe,Mn]=l$(C,he,pe,Et.adaptationConfig,N,x);Mn&&(P.qualityLimitationReason=Mn),Xe&&Et.adaptationConfig.scale!==Xe.scale&&(v.debug("[".concat(C,"] applyAdaptation: ").concat(P.qualityLimitationReason,`
           sendFps `).concat(he,", bwe ").concat(pe,", switch from ").concat(Et.adaptationConfig.scale," to ").concat(Xe.scale," ")),Et.adaptationConfig=HR(HR({},Et.adaptationConfig),Xe),W(Xe))}},M("CHECK_LOCAL_STATS_INTERVAL")),ct=HR({},N);wE.set(C,{timer:$,adaptationConfig:ct,originConfig:N,adaptationFunc:W}),v.debug("[".concat(C,"] start adaptation, originConfig: ").concat(JSON.stringify(N),", degradationPreference: ").concat(x))})(this.id+d.mid,l,this,I,C=>{n&&this.updateAdaptation(n,C)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var f;const{bitrateMax:I,frameRate:C,scaleResolutionDownBy:N}=e._encoderConfig;I&&(a.maxBitrate=1e3*I),(ft(f=e._hints).call(f,Je.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(C&&(a.maxFramerate=Li(C)),N&&N>=1&&(a.scaleResolutionDownBy=N))}const{maxFramerate:m}=M("ENCODER_CONFIG_LIMIT");if(m&&typeof m=="number"&&(a.maxFramerate=a.maxFramerate?Math.min(a.maxFramerate,m):m),M("DSCP_TYPE")&&Ta()){var T;const I=M("DSCP_TYPE");ft(T=["very-low","low","medium","high"]).call(T,I)&&(a.networkPriority=I)}const S=n.getParameters(),w=(i=S.encodings)===null||i===void 0?void 0:i[0];Tn()&&!w&&(o.encodings=[a]),w&&Object.assign(w,a),Object.assign(S,o),v.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(S.encodings))),await n.setParameters(S),await async function(I,C,N){try{var P;if(!Ie().supportSetRtpSenderParameters||!function($){return $==="vp9"||$==="av1"}(I)||!M("ENABLE_SVC"))return;const x={},W={},H=C.getParameters(),j=(P=H.encodings)===null||P===void 0?void 0:P[0];W.scalabilityMode=EE(N),j&&Object.assign(j,W),Object.assign(H,x),await C.setParameters(H),v.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(H.encodings)))}catch(x){v.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",x)}}(this.store.codec,n,M("SVC_MODE"))}async updateAdaptation(e,n){var r,i;if(!e)return v.debug("[updateAdaptation] no rtpSender found");if(!Ie().supportSetRtpSenderParameters)return v.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:a,frameRate:d,scaleResolutionDownBy:l}=n;a&&(o.maxBitrate=1e3*a),d&&(o.maxFramerate=Li(d)),l&&l>=1&&ft(r=["vp8","vp9"]).call(r,this.store.codec)&&(o.scaleResolutionDownBy=l);const h=e.getParameters(),f=(i=h.encodings)===null||i===void 0?void 0:i[0];f&&Object.assign(f,o),Object.assign(h,{});try{await e.setParameters(h),v.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(h.encodings)))}catch(m){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?v.debug("[updateAdaptation] peerConnection not connected}"):v.debug("[updateAdaptation] updateRtpSenderEncodings failed",m):v.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!Ie().supportSetRtpSenderParameters||e.length!==n.length)return;for(let r=0;r<e.length;r++){const i=e[r],o=n[r];o instanceof en&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch{v.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,r){const i=Si(e);return n.forEach((o,a)=>{const d=r[a],l=i.mediaDescriptions.find(h=>h.attributes.mid===d);l&&(bu(l,o),Q1(l,o,this.store.codec))}),pc(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let l=0;l<e.length;l++){var r,i,o,a,d;const h=e[l],f=n[l];if(f instanceof en&&!ft(r=f._hints).call(r,Je.LOW_STREAM)&&(i=f._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((o=f._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(a=f._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((d=f._scalabilityMode)===null||d===void 0?void 0:d.numSpatialLayers)>1&&this.store.codec==="vp8"){const m={},T={high:1e3*(f._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:T.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:T.high}];const S=h.sender.getParameters();await h.sender.setParameters(Object.assign(S,m))}}}async applySimulcastEncodings(e,n){if(!Tn()&&e.length===n.length)for(let r=0;r<e.length;r++){const i=n[r];if(i instanceof en&&this.isVP8Simulcast(i)){const o=e[r],a={},d={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:d.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:d.medium,scaleResolutionDownBy:4}];const l=o.sender.getParameters();await o.sender.setParameters(Object.assign(l,a))}}}isVP8Simulcast(e){var n,r,i,o,a;return!!(e instanceof en&&M("SIMULCAST")&&this.store.codec==="vp8"&&!ft(n=e._hints).call(n,Je.LOW_STREAM)&&(r=e._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=e._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=e._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(e,n,r,i){if(M("SDP_LOGGING"))return v.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(e){if(Ie().supportPCSetConfiguration){const n=Hd.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},Ct(ge.prototype,"updateRemoteRTPCapabilities",[di],Object.getOwnPropertyDescriptor(ge.prototype,"updateRemoteRTPCapabilities"),ge.prototype),Ct(ge.prototype,"connect",[di],Object.getOwnPropertyDescriptor(ge.prototype,"connect"),ge.prototype),Ct(ge.prototype,"updateRemoteConnect",[di],Object.getOwnPropertyDescriptor(ge.prototype,"updateRemoteConnect"),ge.prototype),Ct(ge.prototype,"createDataChannels",[di],Object.getOwnPropertyDescriptor(ge.prototype,"createDataChannels"),ge.prototype),Ct(ge.prototype,"receive",[di],Object.getOwnPropertyDescriptor(ge.prototype,"receive"),ge.prototype),Ct(ge.prototype,"batchReceive",[di],Object.getOwnPropertyDescriptor(ge.prototype,"batchReceive"),ge.prototype),Ct(ge.prototype,"stopReceiving",[di],Object.getOwnPropertyDescriptor(ge.prototype,"stopReceiving"),ge.prototype),Ct(ge.prototype,"muteRemote",[di],Object.getOwnPropertyDescriptor(ge.prototype,"muteRemote"),ge.prototype),Ct(ge.prototype,"unmuteRemote",[di],Object.getOwnPropertyDescriptor(ge.prototype,"unmuteRemote"),ge.prototype),Ct(ge.prototype,"muteLocal",[di],Object.getOwnPropertyDescriptor(ge.prototype,"muteLocal"),ge.prototype),Ct(ge.prototype,"unmuteLocal",[di],Object.getOwnPropertyDescriptor(ge.prototype,"unmuteLocal"),ge.prototype),Ct(ge.prototype,"close",[di],Object.getOwnPropertyDescriptor(ge.prototype,"close"),ge.prototype),Ct(ge.prototype,"updateEncoderConfig",[di],Object.getOwnPropertyDescriptor(ge.prototype,"updateEncoderConfig"),ge.prototype),Ct(ge.prototype,"updateSendParameters",[di],Object.getOwnPropertyDescriptor(ge.prototype,"updateSendParameters"),ge.prototype),Ct(ge.prototype,"replaceTrack",[di],Object.getOwnPropertyDescriptor(ge.prototype,"replaceTrack"),ge.prototype),Ct(ge.prototype,"updateAdaptation",[di],Object.getOwnPropertyDescriptor(ge.prototype,"updateAdaptation"),ge.prototype),Ct(ge.prototype,"getRemoteSSRC",[di],Object.getOwnPropertyDescriptor(ge.prototype,"getRemoteSSRC"),ge.prototype),ge);function di(t,e,n){const r=t[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PConnection.".concat(e));try{for(var a=arguments.length,d=new Array(a),l=0;l<a;l++)d[l]=arguments[l];return await r.apply(this,d)}finally{o()}},n}function zR(t,e){let n=document.createElement("video"),r=document.createElement("canvas");n.setAttribute("style","display:none"),r.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),r.width=Li(e.width),r.height=Li(e.height);const i=Li(e.framerate||15);document.body.append(n),document.body.append(r);let o=t._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const a=r.getContext("2d");if(!a)throw new z(D.UNEXPECTED_ERROR,"can not get canvas context");const d=Ie(),l=r.captureStream(d.supportRequestFrame?0:i).getVideoTracks()[0];l.canvas||(l.canvas=r),r.startCapture=()=>{if(!n)return r.stopCapture&&r.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const f=n.videoWidth,m=n.videoHeight/f,T=r.width*m;Math.abs(T-r.height)>=2&&(v.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(T)),r.height=T)}a.drawImage(n,0,0,r.width,r.height),l.requestFrame&&l.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,n.srcObject=new MediaStream([o]))},r.stopCapture=sR(()=>r.startCapture&&r.startCapture(),i);const h=l.stop;return l.stop=()=>{h.call(l),n&&(n.remove(),n.srcObject=null,n=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),v.debug("clean low stream renderer")},l}var NE=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(NE||{}),jn=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t[t.BYTES_RETRANSMIT=2173]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2172]="PACKAGES_RETRANSMIT",t[t.HUGE_FRAME_SENT=2174]="HUGE_FRAME_SENT",t[t.KEY_FRAMES_ENCODED=2207]="KEY_FRAMES_ENCODED",t}(jn||{}),Od=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(Od||{}),Gn=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t[t.FRAMES_DROPPED=2181]="FRAMES_DROPPED",t[t.BYTES_RETRANSMIT=2175]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2176]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2198]="PACKAGES_DISCARDED",t[t.AVG_DECODE=2200]="AVG_DECODE",t[t.AVG_PROCESSING_DELAY=2202]="AVG_PROCESSING_DELAY",t[t.AVG_ASSEMBLY_TIME=2203]="AVG_ASSEMBLY_TIME",t[t.AVG_INTER_FRAME_DELAY=2204]="AVG_INTER_FRAME_DELAY",t[t.KEY_FRAMES_DECODED=2206]="KEY_FRAMES_DECODED",t}(Gn||{}),Nd=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(Nd||{}),LU=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(LU||{}),Lo=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t[t.BYTES_RETRANSMIT=2179]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2180]="PACKAGES_RETRANSMIT",t}(Lo||{}),li=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t[t.BYTES_RETRANSMIT=2178]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2177]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2199]="PACKAGES_DISCARDED",t[t.AVG_PROCESSING_DELAY=2201]="AVG_PROCESSING_DELAY",t[t.TOTAL_SAMPLES_RECEIVED=2224]="TOTAL_SAMPLES_RECEIVED",t}(li||{}),MU=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(MU||{}),ui=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(ui||{}),PE=function(t){return t[t.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t}(PE||{});const Pd=1e3,Dd=6,DE=3,f$=Math.max(Dd,DE);function Gt(t,e,n){n!=null&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)))}function UU(t){const e={[ui.CONN_TYPE]:0,[ui.RTT]:t.rtt,[ui.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=t.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[ui.CONN_TYPE]=1),n==="tcp"&&(e[ui.CONN_TYPE]=3),n==="tls"&&(e[ui.CONN_TYPE]=4);break}case"srflx":e[ui.CONN_TYPE]=2;break;case"unknown":e[ui.CONN_TYPE]=5;break;default:e[ui.CONN_TYPE]=0}return e}function xU(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class VU extends _n{constructor(e){super(),b(this,"store",void 0),b(this,"uploadWRTCStatsTimer",void 0),b(this,"uploadOutboundDenoiserStatsTimer",void 0),b(this,"uploadExtStatsTimer",void 0),b(this,"uploadExtUsageStatsTimer",void 0),b(this,"uploadInboundExtStatsTimer",void 0),b(this,"requestStats",void 0),b(this,"requestTransportStats",void 0),b(this,"requestLocalMedia",void 0),b(this,"requestRemoteMedia",void 0),b(this,"requestAllTracks",void 0),b(this,"requestVideoIsReady",void 0),b(this,"requestUploadStats",void 0),b(this,"requestUpload",void 0),b(this,"uploadOutboundStarted",!1),b(this,"uploadInboundStarted",!1),b(this,"uploadTransportStarted",!1),b(this,"uploadBaseStatsStarted",!1),b(this,"uploadExtensionUsageStarted",!1),b(this,"lastRecvStats",void 0),b(this,"lastSendStats",void 0),b(this,"lastRefRecvStats",void 0),b(this,"lastRefSendStats",void 0),b(this,"lastFullRecvStats",void 0),b(this,"lastFullSendStats",void 0),b(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;const n=e%DE==0,r=e%Dd==0;let i,o;if(this.uploadTransportStarted&&(i=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!i&&this.uploadOutboundStarted&&(i=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),i||o){var a;const d={};if(this.uploadTransportStarted&&i){const h=this.getTransportStats(i,o,n);h&&(d.misc=[h])}if(this.uploadOutboundStarted&&i){const h=this.getOutboundStats(i,r?this.lastFullSendStats:n?this.lastRefSendStats:this.lastSendStats,n,r);h&&(d.outbound=[h])}if(this.uploadInboundStarted&&o){const h=this.getInboundStats(o,r?this.lastFullRecvStats:n?this.lastRefRecvStats:this.lastRecvStats,n,r);h&&(d.inbound=h)}const l=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;l&&(Array.isArray(d.misc)?d.misc[0]&&d.misc[0].addition&&(d.misc[0].addition[PE.RTC_PEER_CONNECTION_STATE]=Hy[l]):d.misc=[{addition:{[PE.RTC_PEER_CONNECTION_STATE]:Hy[l]}}]),this.requestUploadStats(d)}this.lastRecvStats=o,this.lastSendStats=i,r&&(this.lastFullRecvStats=o,this.lastFullSendStats=i),n&&(this.lastRefRecvStats=o,this.lastRefSendStats=i)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,r;const i=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(i&&((r=this.requestUploadStats)===null||r===void 0||r.call(this,{misc:[{addition:{[PE.RTC_PEER_CONNECTION_STATE]:Hy[i.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===f$+1&&(e=1)},Pd)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,n,r){if(!this.requestStats)return;if(!r)return e.rtt==null?void 0:{addition:{[ui.RTT]:e.rtt,[ui.CONN_TYPE]:void 0,[ui.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};const i=UU(e);if(this.store.useP2P){if(n){const o=UU(n);i[ui.CONN_TYPE]+=o[ui.CONN_TYPE]<<3}i[ui.CONN_TYPE]+=110}else i[ui.CONN_TYPE]+=100;return{addition:i}}getOutboundStats(e,n,r,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const o=this.requestLocalMedia();if(!o||o.length===0)return;let a,d,l;return o.forEach(h=>{let[f,{track:m,ssrcs:T}]=h;switch(f){case at.LocalVideoLowTrack:case at.LocalVideoTrack:if(f===at.LocalVideoTrack){const S=function(C,N,P,x,W,H){const j=N.videoSend.find(Tt=>Tt.ssrc===C);if(!j)return;const $={},{sentFrame:ct,inputFrame:Et}=j;if(H&&(Gt($,jn.QP_SUM,j.qpSumPerFrame),Et&&ct)){const Tt=Et.frameRate,he=ct.frameRate;$[jn.FREEZE]=function(pe,Xe){let Mn=!0;return Mn=!(pe<=5)&&(pe<=10?Xe<3:pe<=20?Xe<4:Xe<5),Mn}(Tt,he)?1:0}if(W){switch(ct&&(Gt($,jn.HEIGHT,ct.height),Gt($,jn.WIDTH,ct.width),Gt($,jn.FRAME_RATE,ct.frameRate)),$[jn.DISABLED]=x._originMediaStreamTrack&&!x._originMediaStreamTrack.enabled||x._mediaStreamTrack&&!x._mediaStreamTrack.enabled?1:0,j.adaptionChangeReason){case"none":$[jn.ADAPTATION]=0;break;case"cpu":$[jn.ADAPTATION]=1;break;case"bandwidth":$[jn.ADAPTATION]=2;break;case"other":$[jn.ADAPTATION]=3}let Tt=0;j.adaptionChangeReason&&(Tt+=xU(j.adaptionChangeReason)),N.qualityLimitationReason&&(Tt+=xU(N.qualityLimitationReason)<<3),$[jn.ADAPTATION]=Tt,$[jn.PLAYER_STATUS]=rR[x._player?x._player.videoElementStatus:"uninit"],Gt($,jn.NACKS,j.nacksCount),Gt($,jn.PLIS,j.plisCount),Gt($,jn.FIRS,j.firsCount),Gt($,jn.AVG_ENCODE,j.avgEncodeMs),Gt($,jn.HUGE_FRAME_SENT,j.hugeFramesSent),Gt($,jn.BYTES_RETRANSMIT,j.retransmittedBytesSent),Gt($,jn.PACKAGES_RETRANSMIT,j.retransmittedPacketsSent),Gt($,jn.KEY_FRAMES_ENCODED,j.keyFramesEncoded);const he=P&&P.videoSend.find(pe=>pe.ssrc===C);if(he){let pe=W?Pd:Pd*Dd;he.timestamp&&j.timestamp&&(pe=j.timestamp-he.timestamp),he.packets!=null&&j.packets!=null&&Gt($,jn.PACKAGE_RATE,1e3*(j.packets-he.packets)/pe),j.packetsLost!=null&&he.packetsLost!=null&&Gt($,jn.PACKAGE_LOST,j.packetsLost-he.packetsLost),he.bytes!=null&&j.bytes!=null&&Gt($,jn.BITRATE,8*(j.bytes-he.bytes)/pe)}}return $}(T[0].ssrcId,e,n,m,r,i),w=m&&function(C,N,P,x){const W=N.videoSend.find(j=>j.ssrc===C);if(!W)return null;const H={};if(x){const j=W.inputFrame,$=j&&j.height||P.videoHeight||0,ct=j&&j.width||P.videoWidth||0,Et=j&&j.frameRate||0;Gt(H,NE.HEIGHT,$),Gt(H,NE.WIDTH,ct),Gt(H,NE.FRAME_RATE,Et)}return H}(T[0].ssrcId,e,m,r),I=function(C,N){const P={};return N&&(Gt(P,jn.RETRANSMIT,C.bitrate.retransmit),Gt(P,jn.TARGET_ENCODED,C.bitrate.targetEncoded),Gt(P,jn.ACTUAL_ENCODED,C.bitrate.actualEncoded),Gt(P,jn.TRANSMIT,C.bitrate.transmit),Gt(P,jn.BANDWIDTH,C.sendBandwidth)),P}(e,r);d=Object.assign({},S,w,I)}else l=function(S,w,I,C){const N=w.videoSend.find(x=>x.ssrc===S);if(!N)return;const P={};if(C){const x=N.sentFrame;if(x&&(Gt(P,Od.HEIGHT,x.height),Gt(P,Od.WIDTH,x.width),Gt(P,Od.FRAME_RATE,x.frameRate)),I){const W=I.videoSend.find(H=>H.ssrc===S);if(W){let H=Pd*Dd;W.timestamp&&N.timestamp&&(H=N.timestamp-W.timestamp),W.packets!=null&&N.packets!=null&&Gt(P,Od.PACKAGE_RATE,1e3*(N.packets-W.packets)/H),N.packetsLost!=null&&W.packetsLost!=null&&Gt(P,Od.PACKAGE_LOST,N.packetsLost-W.packetsLost),W.bytes!=null&&N.bytes!=null&&Gt(P,Od.BITRATE,8*(N.bytes-W.bytes)/H)}}}return P}(T[0].ssrcId,e,n,r);break;case at.LocalAudioTrack:a=m&&function(S,w,I,C,N){const P=w.audioSend.find(W=>W.ssrc===S);if(!P)return;const x={};if(N){x[Lo.DISABLED]=C._originMediaStreamTrack&&!C._originMediaStreamTrack.enabled||C._mediaStreamTrack&&!C._mediaStreamTrack.enabled?1:0;const W=100*C._source.getAccurateVolumeLevel(),H=P.inputLevel;if(H!=null){const $=Math.ceil(50*Math.log10(100*H+1));Gt(x,Lo.LEVEL,$)}Gt(x,LU.PCM_LEVEL,W),Gt(x,Lo.AEC_RETURN_LOSS,P.aecReturnLoss),Gt(x,Lo.AEC_RETURN_LOSS_ENH,P.aecReturnLossEnhancement),Gt(x,Lo.BYTES_RETRANSMIT,P.retransmittedBytesSent),Gt(x,Lo.PACKAGES_RETRANSMIT,P.retransmittedPacketsSent),x[Lo.FREEZE]=0;const j=I&&I.audioSend.find($=>$.ssrc===S);if(j){let $=Pd*Dd;j.timestamp&&P.timestamp&&($=P.timestamp-j.timestamp),j.bytes!=null&&P.bytes!=null&&Gt(x,Lo.BITRATE,8*(P.bytes-j.bytes)/$),j.packets!=null&&P.packets!=null&&Gt(x,Lo.PACKAGE_RATE,1e3*(P.packets-j.packets)/$)}}return x}(T[0].ssrcId,e,n,m,r)}}),{high:d,low:l,audio:a}}getInboundStats(e,n,r,i){if(!this.requestRemoteMedia)return;const o=this.requestRemoteMedia()||[],a=[];return o.forEach(d=>{let[l,h]=d;const f={peer:l.uid};if(h.has(vt.VIDEO)&&l.videoTrack){const m=l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)||!1,T=l.videoTrack?function(S,w,I,C,N,P,x,W){const H=w.videoRecv.find(pe=>pe.ssrc===S);if(!H)return;const j={},{receivedFrame:$,outputFrame:ct,decodeFrameRate:Et}=H,Tt=I&&I.videoRecv.find(pe=>pe.ssrc===S);if(Gt(j,Nd.FRAME_RATE_DECODE,Et),H.framesRateFirefox&&Gt(j,Gn.FRAME_RATE,H.framesRateFirefox),$&&Gt(j,Gn.FRAME_RATE,$.frameRate),Gt(j,Gn.FRAMES_DROPPED,H.framesDroppedCount),Gt(j,Gn.BYTES_RETRANSMIT,H.retransmittedBytesReceived),Gt(j,Gn.PACKAGES_RETRANSMIT,H.retransmittedPacketsReceived),Gt(j,Gn.PACKAGES_DISCARDED,H.packetsDiscarded),Gt(j,Gn.AVG_DECODE,H.avgDecodeMs),Gt(j,Gn.AVG_PROCESSING_DELAY,H.avgProcessingDelayMs),Gt(j,Gn.AVG_ASSEMBLY_TIME,H.avgFramesAssembledFromMultiplePacketsMs),Gt(j,Gn.AVG_INTER_FRAME_DELAY,H.avgInterFrameDelayMs),Gt(j,Gn.KEY_FRAMES_DECODED,H.keyFramesDecoded),Tt){const pe=w.timestamp-I.timestamp||Pd*(W?Dd:x?DE:1);H.packetsLost!=null&&Tt.packetsLost!=null&&Gt(j,Gn.PACKAGE_LOST,H.packetsLost-Tt.packetsLost),Tt.bytes!=null&&H.bytes!=null&&Gt(j,Gn.BITRATE,8*(H.bytes-Tt.bytes)/pe),Tt.packets!=null&&H.packets!=null&&Gt(j,Gn.PACKAGE_RATE,1e3*(H.packets-Tt.packets)/pe)}if(W&&(Gt(j,Gn.QP_SUM,H.qpSumPerFrame),j[Gn.FREEZE]=N&&Op.isRemoteVideoFreeze(C,H,Tt)?1:0),x){var he;$?(Gt(j,Gn.HEIGHT,$.height),Gt(j,Gn.WIDTH,$.width)):C&&(Gt(j,Gn.HEIGHT,C._videoHeight||0),Gt(j,Gn.WIDTH,C._videoWidth||0)),ct&&Gt(j,Nd.FRAME_RATE_OUTPUT,ct.frameRate);const pe=(he=C._player)===null||he===void 0?void 0:he.rendFrameRate.toFixed(0);if(pe&&Gt(j,Nd.FRAME_RATE_RENDER,+pe),Gt(j,Gn.JITTER_BUFFER,H.jitterBufferMs),Gt(j,Gn.CURRENT_DELAY,H.currentDelayMs),Gt(j,Gn.FIRS,H.firsCount),Gt(j,Gn.NACKS,H.nacksCount),Gt(j,Gn.PLIS,H.plisCount),C){j[Gn.DISABLED]=C._originMediaStreamTrack.enabled&&C._mediaStreamTrack.enabled?0:1;const Xe=C._player;if(Xe){const{freezeTimeCounterList:Mn,renderFreezeAccTime:Cn,videoElementStatus:pi}=Xe;if(Mn&&Mn.length>0&&Gt(j,Nd.FREEZE_TIME,Mn.splice(0,1)[0]),P&&ya.visibility==="visible"&&pi===jr.PLAYING&&Ie().supportRequestVideoFrameCallback){const it=Math.min(6e3,Cn);Xe.renderFreezeAccTime=Math.max(0,Cn-it),Gt(j,Nd.FREEZE_TIME_RENDER,it)}if(typeof H.totalFreezesDuration=="number"){const it=Tt&&Tt.totalFreezesDuration?H.totalFreezesDuration-Tt.totalFreezesDuration:H.totalFreezesDuration;Gt(j,Nd.FREEZE_DURATION,1e3*it)}}}if(j[Gn.PLAYER_STATUS]=rR[C._player?C._player.videoElementStatus:"uninit"],Tt&&H.totalInterFrameDelay!==void 0&&H.totalSquaredInterFrameDelay!==void 0&&Tt.totalInterFrameDelay!==void 0&&Tt.totalSquaredInterFrameDelay!==void 0){const Xe=H.totalInterFrameDelay-Tt.totalInterFrameDelay,Mn=H.totalSquaredInterFrameDelay-Tt.totalSquaredInterFrameDelay,Cn=H.framesDecodeCount-Tt.framesDecodeCount,pi=Xe/Cn*1e3,it=Math.round(1e3*Math.sqrt((Mn-Math.pow(Xe,2)/Cn)/Cn));!isNaN(it)&&pi+it>Math.max(3*pi,pi+150)&&(j[Gn.I_FRAME_DELAY]=it)}}return j}(l._videoSSRC,e,n,l.videoTrack,m===!0,this.needUploadRenderFreezeTime,r,i):void 0;T&&(f.video=T)}if(h.has(vt.AUDIO)&&l.audioTrack){const m=l.audioTrack?function(T,S,w,I,C,N){const P=S.audioRecv.find(j=>j.ssrc===T);if(!P)return;const x={},W=w&&w.audioRecv.find(j=>j.ssrc===T);if(Gt(x,li.JITTER,P.jitterMs),Gt(x,li.BYTES_RETRANSMIT,P.retransmittedBytesReceived),Gt(x,li.PACKAGES_RETRANSMIT,P.retransmittedPacketsReceived),Gt(x,li.PACKAGES_DISCARDED,P.packetsDiscarded),Gt(x,li.AVG_PROCESSING_DELAY,P.avgProcessingDelayMs),W){const j=S.timestamp-w.timestamp||Pd*(N?Dd:C?DE:1);P.packets!=null&&W.packets!=null&&Gt(x,li.PACKAGE_RATE,1e3*(P.packets-W.packets)/j),C&&W.bytes!=null&&P.bytes!=null&&Gt(x,li.BITRATE,8*(P.bytes-W.bytes)/j),P.packetsLost!=null&&W.packetsLost!=null&&Gt(x,li.PACKAGE_LOST,P.packetsLost-W.packetsLost)}if(N){const{receivedFrames:j,droppedFrames:$}=P;j!=null&&$!=null&&(x[li.FREEZE]=(H=j)===0||100*$/H>20?1:0)}var H;if(C){const j=100*I._source.getAccurateVolumeLevel(),$=P.outputLevel;if($!=null){const ct=Math.ceil(50*Math.log10(100*$+1));Gt(x,MU.LEVEL,ct)}if(Gt(x,li.PCM_LEVEL,j),I&&(x[li.DISABLED]=I._originMediaStreamTrack.enabled&&I._mediaStreamTrack.enabled?0:1),Gt(x,li.JITTER_BUFFER,P.jitterBufferMs),Gt(x,li.CURRENT_DELAY,P.jitterBufferMs),x[li.PLAYER_STATUS]=rR[ci.getPlayerState(I.getTrackId())],W){const ct=P.concealedSamples-W.concealedSamples;ct>0&&Gt(x,li.CONCEALED_SAMPLES,ct);const Et=P.totalSamplesReceived-W.totalSamplesReceived;Et>0&&Gt(x,li.TOTAL_SAMPLES_RECEIVED,Et)}}return x}(l._audioSSRC,e,n,l.audioTrack,r,i):void 0;m&&(f.audio=m)}(f.video||f.audio)&&a.push(f)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,a}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(n=>n instanceof eE);if(e&&e._external.getDenoiserStats){const n=e._external.getDenoiserStats();n&&this.requestUpload(Tp.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,r]=e;r.has(vt.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)}),r.has(vt.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const n=Date.now(),r={connectionInterval:M("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let i=[];const o=this.requestAllTracks&&this.requestAllTracks()||[];for(const h of o)!h.muted&&h.enabled&&(i=i.concat(await h.getProcessorUsage()));const a=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[h,f]of a)f.has(vt.VIDEO)&&h.videoTrack&&(i=i.concat(await h.videoTrack.getProcessorUsage())),f.has(vt.AUDIO)&&h.audioTrack&&(i=i.concat(await h.audioTrack.getProcessorUsage()));if(i.length===0)return;r.details=function(h,f){const m={};for(const{id:I,value:C,level:N,direction:P}of h){var T;const x=(T=f.get(I))!==null&&T!==void 0?T:0,W=C===2?x+M("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:x;var S,w;f.set(I,W),m[I]?(C===2&&(m[I].value=C),N>m[I].level&&(m[I].level=N),P==="remote"&&(m[I].remoteUidCount+=1),m[I].totalTs=(S=f.get(I))!==null&&S!==void 0?S:0):m[I]={value:C,level:N,remoteUidCount:P==="local"?0:1,totalTs:(w=f.get(I))!==null&&w!==void 0?w:0}}return Object.keys(m).map(I=>{const{level:C,value:N,totalTs:P}=m[I];return{id:I,level:C,value:N,totalTs:P}})}(i,e);const d=Date.now(),l=d>n?d:n+1;this.requestUpload&&this.requestUpload(Tp.EXTENSION_USAGE_STATS,{usageStats:r,sendTs:l})},M("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1}}const _$=M("ICE_RESTART_INTERVAL");let kE=new Map,ku=new Map,vc=[Pr.UDP_TCP_RELAY,Pr.TCP_RELAY,Pr.RELAY],JR=M("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ie().supportPCSetConfiguration;function FU(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=kE.get(t.id);n&&(window.clearTimeout(n),kE.delete(t.id));const r=ku.get(t.id);e&&r&&r.index===vc.length-1&&(v.debug("[".concat(t.id,"] reset ICE restart policy")),ku.delete(t.id))}function BU(t,e,n){if(kE.size===0&&ku.size===0&&(Array.isArray(M("RESTART_SEQUENCE"))&&M("RESTART_SEQUENCE").length>0&&!function(d,l){if(d.length!==l.length)return!1;for(let h=0;h<d.length;h+=1){const f=d[h];if(d.filter(m=>m===f).length!==l.filter(m=>m===f).length)return!1}return!0}(vc,M("RESTART_SEQUENCE"))&&(vc=M("RESTART_SEQUENCE").filter(d=>{var l;if(ft(l=Object.values(Pr)).call(l,d))return!0}),v.debug("use reconnection policy from config distribution, queues: ".concat(vc.join(" => ")))),JR=M("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ie().supportPCSetConfiguration),vc.length===0)return void n();let r,{index:i=0,type:o}=ku.get(t.id)||{};if(JR&&o===Pr.RELAY)return void n();let a=o&&i>=vc.length-1;if(JR)o=Pr.RELAY;else{if(a)return void n();o?(i++,o=vc[i]):(o=vc[0],i=0)}v.debug("[".concat(t.id,"] choose ICE restart policy: ").concat(o,", index: ").concat(i)),e(o),ku.set(t.id,{index:i,type:o}),r=window.setTimeout(()=>BU(t,e,n),_$),kE.set(t.id,r)}var ce;function jU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Mo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?jU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):jU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function GU(t){var e,n,r,i=2;for(typeof Symbol<"u"&&(n=Ty,r=Symbol.iterator);i--;){if(n&&(e=t[n])!=null)return e.call(t);if(r&&(e=t[r])!=null)return new LE(e.call(t));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function LE(t){function e(n){if(Object(n)!==n)return mt.reject(new TypeError(n+" is not an object."));var r=n.done;return mt.resolve(n.value).then(function(i){return{value:i,done:r}})}return LE=function(n){this.s=n,this.n=n.next},LE.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?mt.resolve({value:n,done:!0}):e(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?mt.reject(n):e(r.apply(this.s,arguments))}},new LE(t)}let Pp=(ce=class extends _n{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Mt.StateChange,e,this._state)}constructor(t,e){super(),b(this,"isPlanB",void 0),b(this,"store",void 0),b(this,"statsUploader",void 0),b(this,"connection",void 0),b(this,"localTrackMap",new Map),b(this,"remoteUserMap",new Map),b(this,"localDataChannels",[]),b(this,"remoteDataChannelMap",new Map),b(this,"pendingLocalTracks",[]),b(this,"pendingRemoteTracks",[]),b(this,"pendingLocalDataChannels",[]),b(this,"pendingRemoteDataChannels",[]),b(this,"statsCollector",void 0),b(this,"shouldForwardP2PCreation",void 0),b(this,"iceFailedCount",0),b(this,"dtlsFailedCount",0),b(this,"mutex",void 0),b(this,"_state",Le.Disconnected),b(this,"_pcStatsUploadType",M("NEW_ICE_RESTART")?Aa.FIRST_CONNECTION:Aa.OLD_FIRST_CONNECTION),b(this,"_isStartRestartIce",!1),b(this,"_restartTimer",void 0),b(this,"_isTryConnecting",!1),b(this,"_iceError",null),b(this,"_forceTurn",!1),b(this,"_isWaitPcToRePub",!1),b(this,"handleMuteLocalTrack",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Le.Connected)return void i(new et(D.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const a=this.filterTobeMutedTracks(n);if(a.length===0)return void r();const d=a.find(h=>h[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(a.map(h=>{let[,{id:f}]=h;return f}));const l=this.createMuteMessage(a);await Ye(this,Mt.RequestMuteLocal,l),r()}catch(a){i(a)}finally{o()}}),b(this,"handleUnmuteLocalTrack",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Le.Connected)return void i(new et(D.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const a=this.filterTobeUnmutedTracks(n);if(a.length===0)return void r();const d=a.find(h=>h[0]==="videoLowTrack");if(d){const h=d[1];if(h.track._originMediaStreamTrack.stop(),!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding){const f=n._mediaStreamTrack.clone();h.track._mediaStreamTrack=f,h.track._originMediaStreamTrack=f}else{const f=zR(n,hp(this,Mt.RequestLowStreamParameter));h.track._mediaStreamTrack=f,h.track._originMediaStreamTrack=f}await new mt((f,m)=>{this.handleReplaceTrack(h.track,f,m,!0)})}await this.connection.unmuteLocal(a.map(h=>{let[,{id:f}]=h;return f}));const l=this.createUnmuteMessage(a);await Ye(this,Mt.RequestUnmuteLocal,l),r()}catch(a){i(a)}finally{o()}}),b(this,"handleUpdateVideoEncoder",async(n,r,i,o)=>{let a;o||(a=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get(at.LocalVideoTrack);if(!this.connection||!l||l.track!==n||this.state!==Le.Connected)return void r();const{id:h,track:f}=l;await this.connection.updateSendParameters(h,f),await this.connection.updateEncoderConfig(h,f),this.emit(Mt.UpdateVideoEncoder,f),r()}catch(l){i(l)}finally{var d;(d=a)===null||d===void 0||d()}}),b(this,"handleUpdateVideoSendParameters",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const a=this.localTrackMap.get(at.LocalVideoTrack);if(!this.connection||!a||a.track!==n||this.state!==Le.Connected)return void r();const{id:d,track:l}=a;await this.connection.updateSendParameters(d,l),r()}catch(a){i(a)}finally{o()}}),b(this,"handleReplaceMixingTrack",async(n,r,i,o)=>{if(!this.connection||this.state!==Le.Connected)return void r();const a=qR([n]);let d;v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(a.getTrackId(),"]")),typeof o=="boolean"&&o||(d=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,a),r()}catch(h){i(h)}finally{var l;(l=d)===null||l===void 0||l()}}),b(this,"handleReplaceTrack",async(n,r,i,o)=>{let a;v.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var d;const h=Array.from(this.localTrackMap.entries()).find(f=>{let[,{track:m}]=f;return n===m});if(!this.connection||!h||this.state!==Le.Connected)return void r();if(await((d=this.connection)===null||d===void 0?void 0:d.replaceTrack(n,h[1].id)),this.isPlanB){const f=h[1];f.id=n._mediaStreamTrack.id,this.localTrackMap.set(h[0],f)}if(h[0]===at.LocalVideoTrack&&!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding){const f=this.localTrackMap.get(at.LocalVideoLowTrack);if(f){const m=n._mediaStreamTrack.clone();f.track._originMediaStreamTrack.stop(),f.track._mediaStreamTrack=m,f.track._originMediaStreamTrack=m,await new mt((T,S)=>{this.handleReplaceTrack(f.track,T,S,!0)})}}r()}catch(h){i(h)}finally{var l;(l=a)===null||l===void 0||l()}}),b(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats())}),b(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),b(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),b(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),b(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new VU(this.store),this.bindStatsUploaderEvents(),this.mutex=new Or("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Ie().supportUnifiedPlan||M("CHROME_FORCE_PLAN_B")&&Ta(),this.shouldForwardP2PCreation=M("FORWARD_P2P_CREATION")&&Ie().supportPCSetConfiguration&&Py(),this.shouldForwardP2PCreation&&(this.connection=OE(this.store),this.emit(Mt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(t){var e;this.state=Le.New,this._forceTurn=DU(t),v.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const n=this.shouldForwardP2PCreation&&((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&(v.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=OE(this.store,t),this.emit(Mt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new et(D.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=M("NEW_ICE_RESTART")?Aa.FIRST_CONNECTION:Aa.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t){if(!this.connection)throw new et(D.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");M("ENABLE_PREALLOC_PC")&&this.state===Le.Connected?await this.connection.updateRemoteConnect(t):(this.store.peerConnectionStart(),await this.connection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Le.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(i=>{var o;let[a]=i;return ft(o=[at.LocalVideoLowTrack,at.LocalVideoTrack]).call(o,a)}),n=e.map(i=>{let[,{id:o}]=i;return o}),r=e.map(i=>{let[o]=i;return o});if(this.connection instanceof ko){if(bt.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!ft(t).call(t,this.store.codec)){const i=["vp9","vp8","h264"].find(o=>ft(t).call(t,o));i&&(this.store.codec=i,v.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}async getEstablishParams(){var t;if(this.connection instanceof ko&&this.connection.peerConnectionState!=="closed"&&ft(t=[Le.New,Le.Connected]).call(t,this.state))return this.connection.establishPromise}async publishDataChannel(t){if(!this.connection||this.state!==Le.Connected){if(this.state===Le.Disconnected)throw new et(D.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(n=>{var r;ft(r=this.pendingLocalDataChannels).call(r,n)||this.pendingLocalDataChannels.push(n)}),[]}const e=this.filterTobePublishedDataChannels(t);return e.length===0?[]:(e.forEach(n=>{const r=Date.now();this.store.publish(n.id.toString(),"datachannel",r)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(n=>{this.localDataChannels.push(n);const r=Date.now();this.store.publish(n.id+"","datachannel",void 0,r)}),t.map(n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId})))}publish(t,e,n){var r=this;return rs(function*(){const i=yield Se(r.mutex.lock("From P2PChannel.publish"));try{var o;const a=r.connection&&ft(o=["disconnected","failed"]).call(o,r.connection.peerConnectionState);if(!r.connection||r.state!==Le.Connected||a){if(r.state===Le.Disconnected)throw new et(D.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(t);const l=t.filter(h=>r.pendingLocalTracks.indexOf(h)===-1);return r.pendingLocalTracks=r.pendingLocalTracks.concat(l),void(a&&(r._isWaitPcToRePub=!0))}r.store.pubId=r.store.pubId+1,Dr.markPublishStart(r.store.clientId,r.store.pubId);const d=r.filterTobePublishedTracks(t,e,n);if(d.length===0)return void(yield Se(r.tryToUnmuteAudio(t)));yield*bm(GU(r.doPublish(r.connection,d)))}finally{i()}})()}doPublish(t,e){var n=this;return rs(function*(){e.forEach(T=>{let{track:S,type:w}=T;const I=Date.now();n.store.publish(S.getTrackId(),w===at.LocalAudioTrack?"audio":"video",I)}),n.bindLocalTrackEvents(e);const r=e.map(T=>{let{track:S}=T;return S}),i=yield Se(t.send(r,n.store.codec,n.store.audioCodec)),o=(yield Se(i.next())).value,a=n.createGatewayPublishMessage(e,o);let d;try{d=yield a}catch(T){throw i.throw(T),(T==null?void 0:T.code)===D.WS_ABORT&&e.forEach(S=>{let{track:w}=S;n.pendingLocalTracks.indexOf(w)===-1&&n.pendingLocalTracks.push(w)}),n.unbindLocalTrackEvents(e),T}const l=n.mapPubResToRemoteConfig(a,d,r),h=(yield Se(i.next(l))).value;if(n.state===Le.Disconnected)throw new et(D.UNEXPECTED_ERROR,"PeerConnection already disconnected.");M("ENABLE_VIDEO_SEI");const f=M("ENABLE_ENCODED_TRANSFORM"),m=M("ENABLE_AUDIO_METADATA");r.forEach(async T=>{const S=T.getRTCRtpTransceiver();if(!S||!f)return;const{interceptLocalVideoFrame:w,interceptLocalAudioFrame:I}=yE();T.trackMediaType===vt.VIDEO?await w(S.sender,T):T.trackMediaType===vt.AUDIO&&await I(S.sender,{metadata:m?()=>{const C=T.metadata.shift();return C&&C.value}:void 0})}),e.forEach(T=>{let{type:S}=T;n.statsCollector.addLocalStats(S)}),n.assignLocalTracks(e,h),n.statsUploader.startUploadOutboundStats(),e.forEach(T=>{let{track:S,type:w}=T;const I=Date.now();n.store.publish(S.getTrackId(),w===at.LocalAudioTrack?"audio":"video",void 0,I)})})()}async updateVideoStreamParameter(t,e){const n=this.localTrackMap.get(e);if(!n||!this.connection)return;if(!(n.track instanceof en))return v.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:r}=n,i=function(o,a){const d={};return o.height&&o.width&&(d.scaleResolutionDownBy=NR(o,a)),d.maxFramerate=o.framerate?Li(o.framerate):void 0,d.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,d}(t,r);if(r._encoderConfig||(r._encoderConfig={}),e!==at.LocalVideoLowTrack||!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding)i.scaleResolutionDownBy!=null&&(r._encoderConfig.scaleResolutionDownBy=i.scaleResolutionDownBy);else{const o=r._originMediaStreamTrack;if(!o.canvas)return v.warn("[".concat(r.getTrackId(),"] no canvas on track"));(function(a,d){const l=a.canvas;d.width&&(l.width=Li(d.width)),d.height&&(l.height=Li(d.height)),d.framerate&&(l.stopCapture&&l.stopCapture(),l.stopCapture=sR(()=>{!l.startCapture&&l.stopCapture&&l.stopCapture(),l.startCapture&&l.startCapture()},Li(d.framerate)))})(o,t)}i.maxBitrate!=null&&(r._encoderConfig.bitrateMax=i.maxBitrate/1e3),i.maxFramerate!=null&&(r._encoderConfig.frameRate&&typeof r._encoderConfig.frameRate=="object"?r._encoderConfig.frameRate.max=i.maxFramerate:r._encoderConfig.frameRate={max:i.maxFramerate}),v.debug("[".concat(r.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(r._encoderConfig))),await this.connection.updateRtpSenderEncodings(r)}publishLowStream(t){var e=this;return rs(function*(){if(!e.connection||e.state!==Le.Connected)return;const n=yield Se(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=e.localTrackMap.get(at.LocalVideoTrack);if(!i)throw new et(D.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(at.LocalVideoLowTrack))throw new et(D.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(i.track,t),type:at.LocalVideoLowTrack}];if(yield*bm(GU(e.doPublish(e.connection,o))),i.track.muted||!i.track.enabled){var r;const a=(r=e.localTrackMap.get(at.LocalVideoLowTrack))===null||r===void 0?void 0:r.id;a!==void 0&&(yield Se(e.connection.muteLocal([a])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(v.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await yr(this,Mt.RequestRePublish,this.pendingLocalTracks),this.emit(Mt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(v.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await yr(this,Mt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:n,kind:r}=this.pendingRemoteTracks[e];(r!==vt.AUDIO||n._audio_added_&&n._audioSSRC)&&(r!==vt.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await yr(this,Mt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===vt.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:n}=e;this.emit(Mt.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==Le.Connected)return void t.forEach(r=>{const i=this.pendingLocalTracks.indexOf(r);i!==-1&&this.pendingLocalTracks.splice(i,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(r=>r[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==Le.Connected)return void t.forEach(n=>{const r=this.pendingLocalDataChannels.indexOf(n);r!==-1&&this.pendingLocalDataChannels.splice(r,1)});const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(n=>{const r=this.localDataChannels.indexOf(n);r!==-1&&this.localDataChannels.splice(r,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Le.Connected)return;const t=this.localTrackMap.get(at.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[at.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(r=>{let[,{id:i}]=r;return i})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[i,{track:o}]=r;return{type:i,track:o}})),e.forEach(r=>{let[i]=r;this.statsCollector.removeLocalStats(i)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==Le.Connected)throw new et(D.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=e.filter(r=>{var i;return!((i=this.remoteDataChannelMap.get(t))!==null&&i!==void 0&&i.get(r.id))});if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach(r=>{var i;this.remoteDataChannelMap.has(t)?(i=this.remoteDataChannelMap.get(t))===null||i===void 0||i.set(r.id,r):this.remoteDataChannelMap.set(t,new Map([[r.id,r]]));const o=this.pendingRemoteDataChannels.findIndex(a=>{let{user:d,id:l}=a;return d.uid===t.uid&&l===r.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(r=>r.id)}async subscribe(t,e,n,r,i){var o;if(!this.connection||this.state!==Le.Connected)throw new et(D.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let a,d,l;const h=this.connection.getPreMedia(n);if(h)v.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),l=h.transceiver,a=h.track,d=h.id;else if(i){const T=i.find(w=>{let{stream_type:I}=w;return I===e});if(!T)throw new et(D.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const S=await this.connection.receive(e,T.ssrcs,String(t._uintid),T.attributes);this.connection instanceof ko&&(l=S.transceiver),a=S.track,d=S.id}else{const T=await this.connection.receive(e,[{ssrcId:n,rtx:r}],String(t._uintid),void 0);this.connection instanceof ko&&(l=T.transceiver),a=T.track,d=T.id}if(e===vt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(a):(t._audioTrack=new Su(a,t.uid,t._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),l&&t._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(a):(t._videoTrack=new Tu(a,t.uid,t._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),l&&t._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(t,t._videoTrack)),l&&M("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:T,interceptRemoteAudioFrame:S}=yE();e==vt.VIDEO?await T(l.receiver,{onSei:M("ENABLE_VIDEO_SEI")&&(w=>{var I;return(I=t._videoTrack)===null||I===void 0?void 0:I._onSei(w)})}):e==vt.AUDIO&&await S(l.receiver,{enableTopn:!!M("ENABLE_AUDIO_TOPN"),enableMetadata:!!M("ENABLE_AUDIO_METADATA"),onMetadata:w=>{this.safeEmit(Mt.AudioMetadata,w)}})}const f=this.remoteUserMap.get(t);f?f.set(e,d):this.remoteUserMap.set(t,new Map([[e,d]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const m=this.pendingRemoteTracks.findIndex(T=>{let{user:S,kind:w}=T;return S.uid===t.uid&&e===w});m!==-1&&(this.pendingRemoteTracks.splice(m,1),this.emit(Mt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==Le.Connected)throw new et(D.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(i=>{var o;let{user:a,mediaType:d}=i;return!((o=this.remoteUserMap.get(a))!==null&&o!==void 0&&o.has(d))});const e=[],n=new Map;t.forEach(i=>{if(!this.connection)return;const o=this.connection.getPreMedia(i.ssrcId);o?n.set(i.ssrcId,o):e.push(i)});const r=await this.connection.batchReceive(e.map(i=>{let{user:o,mediaType:a,ssrcId:d,rtxSsrcId:l}=i;return{kind:a,ssrcMsg:[{ssrcId:d,rtx:l}],mslabel:String(o._uintid)}}));e.forEach((i,o)=>{n.set(i.ssrcId,r[o])});for(const{user:i,mediaType:o,ssrcId:a}of t){const d=n.get(a);if(!d)return void v.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(i.uid," subscribe data,").concat(o,", ").concat(a));const{track:l,id:h,transceiver:f}=d;if(f&&M("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:S,interceptRemoteAudioFrame:w}=yE();o==vt.VIDEO?await S(f.receiver,{onSei:M("ENABLE_VIDEO_SEI")&&(I=>{var C;return(C=i._videoTrack)===null||C===void 0?void 0:C._onSei(I)})}):o==vt.AUDIO&&await w(f.receiver,{enableTopn:!!M("ENABLE_AUDIO_TOPN"),enableMetadata:!!M("ENABLE_AUDIO_METADATA"),onMetadata:I=>{this.safeEmit(Mt.AudioMetadata,I)}})}if(o===vt.AUDIO?(i._audioTrack?i._audioTrack._updateOriginMediaStreamTrack(l):(i._audioTrack=new Su(l,i.uid,i._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(i._audioTrack.getTrackId()))),f&&i._audioTrack._updateRtpTransceiver(f),this.bindRemoteTrackEvents(i,i._audioTrack)):(i._videoTrack?i._videoTrack._updateOriginMediaStreamTrack(l):(i._videoTrack=new Tu(l,i.uid,i._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(i._videoTrack.getTrackId()))),f&&i._videoTrack._updateRtpTransceiver(f),this.bindRemoteTrackEvents(i,i._videoTrack)),M("ENABLE_VIDEO_SEI")&&f){const{interceptRemoteVideoFrame:S,interceptRemoteAudioFrame:w}=yE();o==vt.VIDEO?await S(f.receiver,{onSei:I=>{var C;(C=i._videoTrack)===null||C===void 0||C._onSei(I)}}):o==vt.AUDIO&&await w(f.receiver)}const m=this.remoteUserMap.get(i);m?m.set(o,h):this.remoteUserMap.set(i,new Map([[o,h]])),this.statsCollector.addRemoteStats(i.uid),this.statsUploader.startUploadInboundStats();const T=this.pendingRemoteTracks.findIndex(S=>{let{user:w,kind:I}=S;return w.uid===i.uid&&o===I});T!==-1&&(this.pendingRemoteTracks.splice(T,1),this.emit(Mt.MediaReconnectEnd,i.uid))}}async unsubscribe(t,e,n){const r=this.pendingRemoteTracks.filter(a=>{let{user:d,kind:l}=a;return e!==void 0?d.uid===t.uid&&e===l:d.uid===t.uid});if(r.forEach(a=>{const d=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(d,1)}),this.connection&&this.state===Le.Connected||n||r.forEach(a=>{let{kind:d}=a;var l;if(d===vt.AUDIO)(l=t._audioTrack)===null||l===void 0||l._destroy(),t._audioTrack=void 0;else if(d===vt.VIDEO){var h;(h=t._videoTrack)===null||h===void 0||h._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==Le.Connected)return;const i=this.filterTobeUnSubscribedTracks(t,e);if(i.length===0)return;await this.connection.stopReceiving(i.map(a=>{let[,{id:d}]=a;return d}));const o=this.createUnsubscribeMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(a=>{let[d,{kind:l}]=a;var h,f;if(l===vt.VIDEO&&d._videoSSRC&&((h=this.connection)===null||h===void 0||h.setStatsRemoteVideoIsReady(d._videoSSRC,!1)),l===vt.VIDEO)this.unbindRemoteTrackEvents(d._videoTrack),n||((f=d._videoTrack)===null||f===void 0||f._destroy(),d._videoTrack=void 0);else if(l===vt.AUDIO){var m;this.unbindRemoteTrackEvents(d._audioTrack),!n&&((m=d._audioTrack)===null||m===void 0||m._destroy(),d._audioTrack=void 0)}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(i=>{const o=this.pendingRemoteDataChannels.findIndex(a=>a.id===i.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach(i=>{i._close()});const r=this.remoteDataChannelMap.get(t);return n.forEach(i=>{r&&r.delete(i.id)}),r&&r.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map(i=>i.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:i,mediaType:o}of t){const a=this.pendingRemoteTracks.filter(d=>{let{user:l,kind:h}=d;return o!==void 0?l.uid===i.uid&&o===h:l.uid===i.uid});a.forEach(d=>{const l=this.pendingRemoteTracks.indexOf(d);this.pendingRemoteTracks.splice(l,1)}),e=e.concat(a)}if(!this.connection||this.state!==Le.Connected)return void e.forEach(i=>{let{user:o,kind:a}=i;var d;if(a===vt.AUDIO)(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0;else if(a===vt.VIDEO){var l;(l=o._videoTrack)===null||l===void 0||l._destroy(),o._videoTrack=void 0}});const n=Ws(t).call(t,(i,o)=>{let{user:a,mediaType:d}=o;const l=this.filterTobeUnSubscribedTracks(a,d);return i.concat(l)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(i=>{let[,{id:o}]=i;return o}));const r=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(i=>{let[o,{kind:a}]=i;var d,l;if(a===vt.VIDEO&&o._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===vt.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(l=o._videoTrack)===null||l===void 0||l._destroy(),o._videoTrack=void 0;else if(a===vt.AUDIO){var h;this.unbindRemoteTrackEvents(o._audioTrack),(h=o._audioTrack)===null||h===void 0||h._destroy(),o._audioTrack=void 0}}),r}isPreSubScribe(t){return!this.connection||this.state!==Le.Connected?!1:!!this.connection.getPreMedia(t)}async muteRemote(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void v.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void v.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const r=e===vt.VIDEO?t._videoSSRC:t._audioSSRC;r!==void 0&&this.connection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void v.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||v.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}addAudioMetadata(t){const e=this.localTrackMap.get(at.LocalAudioTrack),n=e&&e.track;n&&n.metadata.push(t)}getAllTracks(t){const e=this.localTrackMap.get(at.LocalAudioTrack);if((e==null?void 0:e.track)instanceof $n){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==at.LocalAudioTrack}).filter(r=>{let[i]=r;return!(t&&i===at.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(t&&r===at.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,r,i){if(t){const a=this.localTrackMap.get(at.LocalAudioTrack),d=r?this.localTrackMap.get(at.LocalVideoLowTrack):this.localTrackMap.get(at.LocalVideoTrack);bt.publish(this.store.sessionId,{eventElapse:Dr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:d==null?void 0:d.track.getTrackLabel(),screenshare:(d==null?void 0:d.track._hints.indexOf(Je.SCREEN_TRACK))!==-1,audio:!!a,video:!!d,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const a=n.find(l=>l instanceof In),d=r?(o=this.localTrackMap.get(at.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(l=>l instanceof en);bt.publish(this.store.sessionId,{eventElapse:Dr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:d==null?void 0:d.getTrackLabel(),screenshare:(d==null?void 0:d._hints.indexOf(Je.SCREEN_TRACK))!==-1,audio:!!a,video:!!d,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(t,e,n,r){const i=r===vt.VIDEO?n._videoSSRC:n._audioSSRC;i&&bt.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===vt.VIDEO,audio:r===vt.AUDIO,peerid:n.uid,subscribeRequestid:i,p2pid:this.store.p2pId,eventElapse:Dr.measureFromSubscribeStart(this.store.clientId,i),preSsrc:this.isPreSubScribe(i)})}reset(){v.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Or("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=OE(this.store),this.emit(Mt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(at.LocalAudioTrack);if((t==null?void 0:t.track)instanceof $n){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Le.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(at.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(at.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof en||e&&e.track instanceof In?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Gi(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(at.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Jh(t).call(t,(n,r)=>n.level-r.level),t}async disconnectForReconnect(){this.connection&&(v.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Le.Reconnecting,M("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=OE(this.store),this.emit(Mt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:r}]=t;switch(n){case at.LocalVideoTrack:ft(e=r._hints).call(e,Je.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case at.LocalAudioTrack:r instanceof $n?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case at.LocalVideoLowTrack:}}),this.emit(Mt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Gi(n).call(n)).forEach(r=>{this.setPendingRemoteMedia(e,r)}),this.emit(Mt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Gi(n).call(n)).forEach(r=>{this.setPendingRemoteDataChannel(e,r)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),v.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const n of this.pendingRemoteDataChannels){const{user:r,id:i}=n;if((t instanceof Sc?t.uid:t)===r.uid&&i===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((t instanceof Sc?t.uid:t)===r.uid&&e===i)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return rs(function*(){if(!e.connection||e.state!==Le.Connected)return;const n=yield Se(e.mutex.lock("From P2PChannel.restartICE"));let r;try{r=yield Se(e.connection.restartICE(t));const o=yield Se(r.next());if(o.done)return;const a=o.value,d=yield a;switch(YR(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),t){case Pr.UDP_TCP_RELAY:e._pcStatsUploadType=Aa.UDP_TCP_RESTART;break;case Pr.TCP_RELAY:e._pcStatsUploadType=Aa.TCP_RESTART;break;case Pr.RELAY:e._pcStatsUploadType=Aa.RELAY_RESTART;break;default:e._pcStatsUploadType=Aa.OLD_RESTART}e._isTryConnecting=!0,r.next(d)}catch(o){var i;(i=r)===null||i===void 0||i.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(at.LocalVideoTrack),n=this.localTrackMap.get(at.LocalAudioTrack),r=t.videoSend.find(S=>S.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),i=t.audioSend.find(S=>S.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId));if(!r||!i)return 1;const o=Bi(this,Mt.NeedSignalRTT),a=r?r.rttMs:void 0,d=i?i.rttMs:void 0,l=a&&d?(a+d)/2:a||d,h=(l&&o?(l+o)/2:l||o)||0,f=100*t.sendPacketLossRate*.7/50+.3*h/1500,m=f<.17?1:f<.36?2:f<.59?3:f<.1?4:5,T=e==null?void 0:e.track;if(T&&T._encoderConfig&&T._hints.indexOf(Je.SCREEN_TRACK)===-1){const S=T._encoderConfig.bitrateMax,w=t.bitrate.actualEncoded;if(S&&w){const I=(1e3*S-w)/(1e3*S);return y1[I<.15?0:I<.3?1:I<.45?2:I<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,a=t.audioRecv.find(w=>w.ssrc===i),d=t.videoRecv.find(w=>w.ssrc===o);if(!a&&!d)return void(e+=1);const l=Bi(this,Mt.NeedSignalRTT),h=t.rtt,f=(h&&l?(h+l)/2:h||l)||0,m=a?a.jitterMs:void 0,T=t.recvPacketLossRate;let S=.7*T*100/50+.3*f/1500;m&&(S=.6*T*100/50+.2*f/1500+.2*m/400),e+=S<.1?1:S<.17?2:S<.36?3:S<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new mt((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}async replaceTrack(t,e){var n;if(v.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==Le.Connected)return;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:a}]=o;return t===a});if(!r)return;const i=r[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:i}]),this.bindLocalTrackEvents([{track:e,type:i}]),r[1].track=e),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(e,r[1].id)),this.isPlanB){const o=r[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(i,o)}if(i===at.LocalVideoTrack&&!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding){const o=this.localTrackMap.get(at.LocalVideoLowTrack);if(o){const a=t._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=a,o.track._originMediaStreamTrack=a,await new mt((d,l)=>{this.handleReplaceTrack(o.track,d,l,!0)})}}}filterTobePublishedTracks(t,e,n){const r=[],i=this.getAllTracks();t=ou(t=t.filter(l=>i.indexOf(l)===-1));let o,a=!1;const d=this.localTrackMap.get(at.LocalAudioTrack);for(const l of t){if(l instanceof en&&(this.localTrackMap.has(at.LocalVideoTrack)||a?new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:l,type:at.LocalVideoTrack}),a=!0),e)){const h=this.getLowVideoTrack(l,n);r.push({track:h,type:at.LocalVideoLowTrack})}if(l instanceof In)if(d){const h=d.track;if(h instanceof $n)KR([l]),h.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0);else{const f=qR([h,l]);v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(f.getTrackId(),"]")),this.replaceTrack(h,f)}}else o instanceof $n?(KR([l]),o.addAudioTrack(l)):o||!l._useAudioElement&&Ie().webAudioMediaStreamDest&&!l._bypassWebAudio?o=qR(o?[l,o]:[l]):o=l}return o&&(v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),r.push({track:o,type:at.LocalAudioTrack})),r}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=ou(t=t.filter(r=>n.indexOf(r)!==-1));for(const r of t){if(r instanceof In){const i=this.localTrackMap.get(at.LocalAudioTrack);if(!i)continue;i.track instanceof $n?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),i.track.trackList.length===0&&(e.push([at.LocalAudioTrack,i]),i.track.close())):e.push([at.LocalAudioTrack,i])}if(r instanceof en){const i=this.localTrackMap.get(at.LocalVideoTrack);if(!i)continue;e.push([at.LocalVideoTrack,i]);const o=this.localTrackMap.get(at.LocalVideoLowTrack);o&&e.push([at.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=ou(t)).filter(e=>this.localDataChannels.findIndex(n=>n.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=ou(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:r}=e;switch(r){case at.LocalVideoTrack:n.addListener(Rt.GET_STATS,this.handleGetLocalVideoStats),n.addListener(Rt.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(Rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case at.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case at.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof $n?t.trackList.forEach(n=>{n.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Rt.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Rt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Rt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:r}]=e;return{track:r,type:n}})),t.forEach(e=>{let{track:n,type:r}=e;switch(r){case at.LocalVideoTrack:n.off(Rt.GET_STATS,this.handleGetLocalVideoStats),n.off(Rt.GET_RTC_STATS,this.handleGetRTCStats),n.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(Rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case at.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case at.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof $n?t.trackList.forEach(e=>{e.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Rt.GET_STATS,this.handleGetLocalAudioStats),e.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Rt.GET_STATS,this.handleGetLocalAudioStats),t.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Rt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Tu&&e.addListener(Rt.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof Su&&e.addListener(Rt.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Rt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(vt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(vt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,r)=>{var i;let o,a,{track:d,type:l}=n;switch(l){case at.LocalAudioTrack:o=Ue.Audio,a={dtx:d instanceof eE&&d._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case at.LocalVideoTrack:o=ft(i=d._hints).call(i,Je.SCREEN_TRACK)?Ue.Screen:Ue.High,a=Mo(Mo({},B1(d)),{},{codec:this.store.codec,svc_mode:EE()});break;case at.LocalVideoLowTrack:o=Ue.Low,a=Mo(Mo({},B1(d)),{},{codec:this.store.codec,svc_mode:EE()})}return{stream_type:o,attributes:a,ssrcs:e[r]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}assignLocalTracks(t,e){t.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(Mt.PeerConnectionStateChange,e),e==="connecting"&&t instanceof ko&&!Tn()&&M("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{e==="connecting"&&t.extendCandidate()},M("FIRST_TCP_CANDIDATE_INTERVAL")),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),t instanceof ko&&FU(t,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=Aa.DISCONNECTED_OR_FAILED,Bi(this,Mt.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const n=this.pendingLocalTracks.map(i=>i.getTrackId()),r=this.pendingLocalDataChannels.map(i=>"dc_".concat(i.id));bt.reportApiInvoke(this.store.sessionId,{name:Kn.REPUB_AFTER_PC_CONNECTED,options:n.concat(r),tag:vn.TRACER}).onSuccess(),this.republish()}if(M("NEW_ICE_RESTART")&&t instanceof ko&&!Tn()&&!this._forceTurn){if(ft(k1).call(k1,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=i=>{YR(t)&&(v.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(i)),Bi(this,Mt.QueryClientConnectionState)==="CONNECTED"&&this.emit(Mt.RequestRestartICE,i))},r=()=>{YR(t)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),v.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(Mt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{BU(t,n,r)},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&M("ICE_RESTART")&&Bi(this,Mt.QueryClientConnectionState)==="CONNECTED"&&this.emit(Mt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(Mt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(v.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(Mt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),bt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:vn.TRACER}).onSuccess(),this.emit(Mt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var i;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(i=r.audioTrack)===null||i===void 0||i.emit(fu.FIRST_FRAME_DECODED),bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_AUDIO_DECODE,cn.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(i=>i._audioSSRC===e);r&&bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_AUDIO_RECEIVED,cn.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,r)=>{this.reportVideoFirstFrameDecoded(e,n,r)},t.onFirstVideoReceived=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===e);r&&bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_VIDEO_RECEIVED,cn.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const r=e.candidateType==="relay",i=n.candidateType==="relay";n.candidateType!=="unknown"&&r===i||this.emit(Mt.ConnectionTypeChange,r),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ec(n))," -> ").concat(JSON.stringify(Ec(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ec(n))," -> ").concat(JSON.stringify(Ec(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return Mo(Mo({},e),n)},t.onICECandidateError=e=>{this._iceError=e}}resetConnection(t){t instanceof ko&&function(e){ku.delete(e.id),FU(e)}(t),t.close(),this.emit(Mt.PeerConnectionStateChange,"closed"),function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}(t),this._isWaitPcToRePub=!1}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(at.LocalAudioTrack);if(t instanceof In&&(n==null?void 0:n.track)instanceof $n)return n.track.isActive||e.push([at.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r&&(e.push(r),r[0]===at.LocalVideoTrack)){const i=this.localTrackMap.get(at.LocalVideoLowTrack);i&&e.push([at.LocalVideoLowTrack,i])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(at.LocalAudioTrack);if(t instanceof In&&(n==null?void 0:n.track)instanceof $n)return n.track.isActive&&e.push([at.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r)if(r[0]===at.LocalVideoTrack){e.push(r);const i=this.localTrackMap.get(at.LocalVideoLowTrack);i&&e.push([at.LocalVideoLowTrack,i])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}createUnmuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}filterTobeUnSubscribedTracks(t,e){const n=[],r=this.remoteUserMap.get(t);if(!r)return n;if(e){const i=r.get(e);if(!i)return n;n.push([t,{kind:e,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,a]=i;n.push([t,{kind:o,id:a}])});return n}filterTobeUnSubscribedDataChannels(t,e){const n=[];return e.forEach(r=>{var i;(i=this.remoteDataChannelMap.get(t))!==null&&i!==void 0&&i.has(r.id)&&n.push(r)}),n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[r,{kind:i,id:o}]=n;switch(i){case vt.VIDEO:return void(r._videoSSRC&&e.push({stream_type:vt.VIDEO,ssrcId:r._videoSSRC}));case vt.AUDIO:return void(r._audioSSRC&&e.push({stream_type:vt.AUDIO,ssrcId:r._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(n=>{let[r,{kind:i}]=n;if(e.has(r)){let o=e.get(r);i===vt.VIDEO?o|=rr.Video:o|=rr.Audio,e.set(r,o)}else i===vt.VIDEO?e.set(r,rr.Video):e.set(r,rr.Audio)}),{users:Array.from(e.entries()).map(n=>{let[r,i]=n;return{stream_id:r.uid,stream_type:i}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:r}]=e;const i=this.remoteUserMap.get(n);i&&(i.delete(r),Array.from(i.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(at.LocalVideoTrack),n=this.localTrackMap.get(at.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new mt((r,i)=>{this.handleUpdateVideoEncoder(e.track,r,i,!0)})),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new mt((r,i)=>{this.handleUpdateVideoEncoder(n.track,r,i,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e,n){return t.map((r,i)=>{var o;let{stream_type:a}=r;const d=(o=e.find(l=>{let{stream_type:h}=l;return a===h}))===null||o===void 0?void 0:o.attributes;if(d&&M("DISABLE_SCREEN_SHARE_REMB")){const l=n[i]._hints;(ft(l).call(l,Je.SCREEN_TRACK)||ft(l).call(l,Je.SCREEN_LOW_TRACK))&&(d.remb=!1,v.debug("disable remb for screen share, hints:",l))}return d})}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof In){var e;const r=this.filterTobeUnmutedTracks(t[n]);if(r.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(r.map(o=>{let[,{id:a}]=o;return a})));const i=this.createUnmuteMessage(r);return void await Ye(this,Mt.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Mt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Mt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var t;return{connectState:((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await hr(Fy(this.dtlsFailedCount,qn)),this.emit(Mt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await yr(this,Mt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(Mt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(at.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof en)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof en).length>1)throw new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof In).length>1&&(t.some(e=>e instanceof In&&e._bypassWebAudio)||!Ie().webAudioMediaStreamDest))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof en&&this.pendingLocalTracks.some(n=>n instanceof en))throw new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof In&&this.pendingLocalTracks.some(n=>n instanceof In)&&(!Ie().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof In&&n._bypassWebAudio)))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var n;const r=!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding,i=Mo(Mo({},{width:160,height:120,framerate:15,bitrate:50}),e);let o;o=r?t._mediaStreamTrack.clone():zR(t,i);const a=ze(8,"track-low-"),d=new en(o,Mo(Mo({},r&&{scaleResolutionDownBy:NR(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,a);return d.on(Sd.TRANSCEIVER_UPDATED,l=>{t._updateRtpTransceiver(l,hu.LOW_STREAM)}),d._hints.push(Je.LOW_STREAM),ft(n=t._hints).call(n,Je.SCREEN_TRACK)&&d._hints.push(Je.SCREEN_LOW_TRACK),t.on("sei-to-send",l=>{d.emit("sei-to-send",l)}),t.addListener(Rt.NEED_CLOSE,()=>{d.close()}),d}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof ko){var i,o,a,d;const l=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:h,dtlsTransportState:f,peerConnectionState:m}=this.connection,{local:T,remote:S}=await this.connection.getSelectedCandidatePair();bt.pcStats(this.store.sessionId,{startTime:l,eventElapse:t-l||0,iceconnectionsate:h,dtlsstate:f,connectionstate:m,intSucc:e?1:2,error:this._iceError||r||"",selectedLocalCandidateProtocol:(i=T==null?void 0:T.protocol)!==null&&i!==void 0?i:"",selectedLocalCandidateType:(o=T.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(T.address,":").concat(T.port),selectedRemoteCandidateProtocol:(a=S.protocol)!==null&&a!==void 0?a:"",selectedRemoteCandidateType:(d=S.candidateType)!==null&&d!==void 0?d:"",selectedRemoteCandidateAddress:"".concat(S.address,":").concat(S.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameDecoded(t,e,n,r){var i;const o=Array.from(Gi(i=this.remoteUserMap).call(i)).find(a=>a._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find(l=>l.userId===o.uid&&l.type==="video");bt.firstRemoteVideoDecode(this.store.sessionId,nr.FIRST_VIDEO_DECODE,cn.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(d==null?void 0:d.subscribeEnd)||0,subscriberStart:(d==null?void 0:d.subscribeStart)||0,videoAddNotify:(d==null?void 0:d.streamAdded)||0,state:r?1:0,firstFrame:(d==null?void 0:d.firstFrame)||0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return!1;const r=this.remoteUserMap.get(t);if(!r)return!1;const i=r.get(e);if(!i)return!1;const o=await this.connection.getRemoteSSRC(i);return o!==void 0&&o!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===at.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,hu.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},Ct(ce.prototype,"startP2PConnection",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"startP2PConnection"),ce.prototype),Ct(ce.prototype,"connect",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"connect"),ce.prototype),Ct(ce.prototype,"updateRemoteRTPCapabilities",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"updateRemoteRTPCapabilities"),ce.prototype),Ct(ce.prototype,"publishDataChannel",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"publishDataChannel"),ce.prototype),Ct(ce.prototype,"unpublish",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unpublish"),ce.prototype),Ct(ce.prototype,"unpublishDataChannel",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unpublishDataChannel"),ce.prototype),Ct(ce.prototype,"unpublishLowStream",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unpublishLowStream"),ce.prototype),Ct(ce.prototype,"subscribeDataChannel",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"subscribeDataChannel"),ce.prototype),Ct(ce.prototype,"subscribe",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"subscribe"),ce.prototype),Ct(ce.prototype,"massSubscribe",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"massSubscribe"),ce.prototype),Ct(ce.prototype,"unsubscribe",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unsubscribe"),ce.prototype),Ct(ce.prototype,"unsubscribeDataChannel",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unsubscribeDataChannel"),ce.prototype),Ct(ce.prototype,"massUnsubscribe",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"massUnsubscribe"),ce.prototype),Ct(ce.prototype,"muteRemote",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"muteRemote"),ce.prototype),Ct(ce.prototype,"unmuteRemote",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"unmuteRemote"),ce.prototype),Ct(ce.prototype,"hasRemoteMediaWithLock",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"hasRemoteMediaWithLock"),ce.prototype),Ct(ce.prototype,"disconnectForReconnect",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"disconnectForReconnect"),ce.prototype),Ct(ce.prototype,"updateBitrateLimit",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"updateBitrateLimit"),ce.prototype),Ct(ce.prototype,"remoteMediaSsrcChanged",[Wr],Object.getOwnPropertyDescriptor(ce.prototype,"remoteMediaSsrcChanged"),ce.prototype),ce);function Wr(t,e,n){const r=t[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PChannel.".concat(e));try{for(var a=arguments.length,d=new Array(a),l=0;l<a;l++)d[l]=arguments[l];return await r.apply(this,d)}finally{o()}},n}function WU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function HU(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?WU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):WU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const m$=Date.now(),E$=20,XR=new Map,ME=new Map;async function KU(t){const e=XR.get(t),n=Array.isArray(e)&&e[e.length-1],r=ME.get(t);if(!n)return void(r.isSyncing=!1);const i={uid:n.uid,payload:n.payload};r.firstRecvTs===0&&(r.firstRecvTs=n.recvTs,r.firstSendTs=n.sendTs);const o=n.sendTs-r.firstSendTs,a=o-(Date.now()-r.firstRecvTs);a>0&&(r.firstRecvTs=Date.now()-o);let d=n.mediaDelay+a;d<=0?(e.pop(),qU(n.context,i),d=0):d=Math.min(d,E$),setTimeout(()=>e.length&&KU(t),d)}function qU(t,e){t.safeEmit(de.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function g$(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return qU(n,{uid:t.uid,payload:t.payload});const r="".concat(n.id,"-").concat(t.uid),i=XR.get(r)||[],o=i.findIndex(h=>t.sendTs>=h.sendTs),a=HU(HU({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});o===-1?i.push(a):i.splice(o,0,a),XR.set(r,i);let d=!1;var l;ME.has(r)?d=!((l=ME.get(r))===null||l===void 0||!l.isSyncing):ME.set(r,{isSyncing:d,firstRecvTs:0,firstSendTs:0}),d||KU(r)}const T$=ve().name;function YU(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function zU(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?YU(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):YU(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const Lu="websdk_ng_cache_parameter",S$=M("MAX_PRELOAD_ASYNC_LENGTH"),v$=1e4,kd=new Map,Ld=[];let QR=null,$R=0,ZR=0;const UE=new Map,y$=function(t,e){const n=[];let r=0;const i=async()=>{const o=n.shift();o&&await o(),n.length>0&&r<e?i():r--};return async function(){for(var o=arguments.length,a=new Array(o),d=0;d<o;d++)a[d]=arguments[d];return new mt(async(l,h)=>{n.push(async()=>{try{const f=await t(...a);l(f)}catch(f){h(f)}}),r<e&&(r++,i())})}}(JU,S$),tI=ai.CancelToken.source();async function JU(t,e,n,r,i,o){try{if(!M("ENABLE_PRELOAD"))return;if(!Ie().supportWebCrypto)return void uc(()=>{v.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new et(D.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&ur(n,"token",1,2047),ur(t,"appid",1,2047),hE(e),r&&pE(r);const a=gd();v.debug("preload channel ".concat(e,", uid is ").concat(r));const d={appId:t,cname:e,token:n||t,uid:typeof r!="string"?r:null,sid:a,proxyServer:i};let l,h;typeof r=="string"?(d.stringUid=r,[h,l]=await mt.all([i$(r,{sid:a,appId:t},tI.token),EU(zU(zU({},d),{},{token:n||t,uid:0}),tI.token)]),d.uid=h.uid,l.gatewayInfo.uid=d.uid,l.gatewayInfo.res.uid=d.uid):(o&&(d.stringUid=o),l=await EU(d,tI.token));const f={sid:a,appId:t,cname:e,token:n||t,uid:d.stringUid||r,intUid:d.uid||l.gatewayInfo.uid,stringUid:d.stringUid,ts:Date.now(),sua:h,ap:l};await async function(m){let T;try{m.uid&&QU({appId:m.appId,cname:m.cname,token:m.token,uid:m.uid,stringUid:m.stringUid});const S=e2(m),w=await async function(C,N){try{const P=await window.crypto.subtle.importKey("raw",jk(N),"AES-GCM",!1,["encrypt"]),x=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},P,Ed(window.btoa(JSON.stringify(C))));return hc(new Uint8Array(x))}catch{return}}(m,m.token||m.appId);if(!w)return;T=t2(Lu);const I=T?JSON.parse(T):[];I.push({[S]:w}),I.length>M("AP_CACHE_NUM")&&I.shift(),xE(Lu,JSON.stringify(I))}catch(S){v.warn("Error caching server parameters:",S.message),xE(Lu,"")}}(f),$R++}catch(a){throw ZR++,function(d){QR||(QR=window.setTimeout(()=>{let h="";UE.forEach((f,m)=>{h+="".concat(m,": ").concat(f," ;")}),bt.reportApiInvoke(null,{name:Kn.PRELOAD,options:{success:$R,failed:ZR,err:h}}).onError(d),$R=0,ZR=0,UE.clear(),QR=null},v$));const l=UE.get(d.code)||0;UE.set(d.code,l+1)}(a),a}}async function XU(t){try{if(M("AP_REQUEST_DETAIL")||M("ENABLE_ROLE_SELECT_EDGE"))return;const e=QU(t);if(!e||t.cloudProxyServer!=="disabled")return;const n=await async function(r,i){try{const o=await window.crypto.subtle.importKey("raw",jk(i),"AES-GCM",!1,["decrypt"]),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,Ed(r));return JSON.parse(window.atob(hc(new Uint8Array(a))))}catch{return}}(e,t.token||t.appId);if(!n||!function(r,i){return r.cname===i.cname&&r.appId===i.appId&&r.token===i.token?i.stringUid?r.stringUid===i.stringUid:typeof i.uid=="number"?r.uid===i.uid:r.uid==i.uid:!1}(n,t))return;if(n&&Date.now()-n.ts<M("AP_CACHE_LIFETIME"))return n}catch(e){v.warn("Error get preloadInfo",e.message)}}function QU(t){let e;try{if(e=t2(Lu),!e)return;const n=JSON.parse(e),r=e2(t),i=function(a,d){for(let l=a.length-1;l>=0;l--)if(d(a[l]))return l;return-1}(n,a=>r in a);if(i===-1)return;const o=n.splice(i,1)[0];return xE(Lu,JSON.stringify(n)),o[r]}catch(n){v.warn("Error delete preload info: ".concat(e),n.message),xE(Lu,"")}}function eI(t){if(t){let e=kd.get(t);e&&(window.clearTimeout(e),e=null,kd.delete(t)),ft(Ld).call(Ld,t)||t.cloudProxyServer!=="disabled"||Ld.push(t)}if(kd.size<M("AP_CACHE_NUM")&&Ld.length>0){const e=Ld.shift();kd.set(e,window.setTimeout(async()=>{const{appId:n,cname:r,token:i,stringUid:o,uid:a,proxyServer:d}=e;try{await y$(n,r,i,a,d,o),kd.has(e)&&eI(e)}catch(l){v.warn("update preload failed",l.message),$U(e)}},M("AP_UPDATE_INTERVAL")))}}function $U(t){const e=Ld.indexOf(t);e!==-1&&Ld.splice(e,1);let n=kd.get(t);n&&(window.clearTimeout(n),n=null,kd.delete(t),eI())}function ZU(t,e){const n=t.sua,r=t.ap;e&&n&&bt.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),bt.reportResourceTiming(t.ap.url,t.sid),bt.joinWebProxyAP(t.sid,{lts:r.requestTime,elapse:r.elapse,sucess:1,apServerAddr:r.url,turnServerAddrList:r.proxyInfo.addresses.map(i=>i.ip).join(","),eventType:"disabled",unilbsServerIds:[Bn.CHOOSE_SERVER,Bn.CLOUD_PROXY_FALLBACK].toString()}),bt.joinChooseServer(t.sid,{lts:r.requestTime,elapse:r.elapse,succ:!0,csAddr:r.url,opid:r.opid,serverList:r.gatewayInfo.gatewayAddrs.map(i=>i.address),ec:null,cid:r.gatewayInfo.cid.toString(),uid:r.gatewayInfo.uid.toString(),csIp:r.gatewayInfo.csIp,unilbsServerIds:[Bn.CHOOSE_SERVER].toString(),isHttp3:r.isHttp3})}function t2(t){return window.atob(window.localStorage.getItem(t)||"")}function xE(t,e){window.localStorage.setItem(t,window.btoa(e))}function e2(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),zk(e)}function R$(t){let e=function(){const n=A$.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,r){let i=n.appId;i!==void 0&&(Wn(r,10),yc(r,i));let o=n.cid;o!==void 0&&(Wn(r,16),Wn(r,o));let a=n.cname;a!==void 0&&(Wn(r,26),yc(r,a));let d=n.deviceId;d!==void 0&&(Wn(r,34),yc(r,d));let l=n.elapse;l!==void 0&&(Wn(r,40),Rc(r,l));let h=n.fileSize;h!==void 0&&(Wn(r,48),Rc(r,Mu(h)));let f=n.height;f!==void 0&&(Wn(r,56),Rc(r,Mu(f)));let m=n.jpg;m!==void 0&&(Wn(r,66),Wn(r,m.length),r2(r,m));let T=n.networkType;T!==void 0&&(Wn(r,72),Rc(r,Mu(T)));let S=n.osType;S!==void 0&&(Wn(r,80),Rc(r,Mu(S)));let w=n.requestId;w!==void 0&&(Wn(r,90),yc(r,w));let I=n.sdkVersion;I!==void 0&&(Wn(r,98),yc(r,I));let C=n.sequence;C!==void 0&&(Wn(r,104),Rc(r,Mu(C)));let N=n.sid;N!==void 0&&(Wn(r,114),yc(r,N));let P=n.timestamp;P!==void 0&&(Wn(r,120),Rc(r,P));let x=n.uid;x!==void 0&&(Wn(r,128),Wn(r,x));let W=n.vid;W!==void 0&&(Wn(r,136),Wn(r,W));let H=n.width;H!==void 0&&(Wn(r,144),Rc(r,Mu(H)));let j=n.service;j!==void 0&&(Wn(r,152),Wn(r,j));let $=n.callbackData;$!==void 0&&(Wn(r,162),Wn(r,$.length),r2(r,$));let ct=n.ticket;ct!==void 0&&(Wn(r,170),yc(r,ct));let Et=n.vendorConfigs;Et!==void 0&&(Wn(r,178),yc(r,Et))}(t,e),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(e)}function I$(t){return function(n){let r={};t:for(;!w$(n);){let i=Dp(n);switch(i>>>3){case 0:break t;case 1:r.code=Dp(n);break;case 2:r.msg=i2(n,Dp(n));break;case 3:r.requestId=i2(n,Dp(n));break;case 4:r.timestamp=b$(n,!1);break;default:C$(n,7&i)}}return r}({bytes:e=t,offset:0,limit:e.length});var e}function C$(t,e){switch(e){case 0:for(;128&Ps(t););break;case 2:nI(t,Dp(t));break;case 5:nI(t,4);break;case 1:nI(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function Mu(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let A$=[];function nI(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function w$(t){return t.offset>=t.limit}function VE(t,e){let n=t.bytes,r=t.offset,i=t.limit,o=r+e;if(o>n.length){let a=new Uint8Array(2*o);a.set(n),t.bytes=a}return t.offset=o,o>i&&(t.limit=o),r}function n2(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function r2(t,e){let n=VE(t,e.length);t.bytes.set(e,n)}function i2(t,e){let n=n2(t,e),r=String.fromCharCode,i=t.bytes,o="�",a="";for(let d=0;d<e;d++){let l,h,f,m,T=i[d+n];(128&T)==0?a+=r(T):(224&T)==192?d+1>=e?a+=o:(l=i[d+n+1],(192&l)!=128?a+=o:(m=(31&T)<<6|63&l,m<128?a+=o:(a+=r(m),d++))):(240&T)==224?d+2>=e?a+=o:(l=i[d+n+1],h=i[d+n+2],(49344&(l|h<<8))!=32896?a+=o:(m=(15&T)<<12|(63&l)<<6|63&h,m<2048||m>=55296&&m<=57343?a+=o:(a+=r(m),d+=2))):(248&T)==240?d+3>=e?a+=o:(l=i[d+n+1],h=i[d+n+2],f=i[d+n+3],(12632256&(l|h<<8|f<<16))!=8421504?a+=o:(m=(7&T)<<18|(63&l)<<12|(63&h)<<6|63&f,m<65536||m>1114111?a+=o:(m-=65536,a+=r(55296+(m>>10),56320+(1023&m)),d+=3))):a+=o}return a}function yc(t,e){let n=e.length,r=0;for(let a=0;a<n;a++){let d=e.charCodeAt(a);d>=55296&&d<=56319&&a+1<n&&(d=(d<<10)+e.charCodeAt(++a)-56613888),r+=d<128?1:d<2048?2:d<65536?3:4}Wn(t,r);let i=VE(t,r),o=t.bytes;for(let a=0;a<n;a++){let d=e.charCodeAt(a);d>=55296&&d<=56319&&a+1<n&&(d=(d<<10)+e.charCodeAt(++a)-56613888),d<128?o[i++]=d:(d<2048?o[i++]=d>>6&31|192:(d<65536?o[i++]=d>>12&15|224:(o[i++]=d>>18&7|240,o[i++]=d>>12&63|128),o[i++]=d>>6&63|128),o[i++]=63&d|128)}}function Ps(t){return t.bytes[n2(t,1)]}function s2(t,e){let n=VE(t,1);t.bytes[n]=e}function Dp(t){let e,n=0,r=0;do e=Ps(t),n<32&&(r|=(127&e)<<n),n+=7;while(128&e);return r}function Wn(t,e){for(e>>>=0;e>=128;)s2(t,127&e|128),e>>>=7;s2(t,e)}function b$(t,e){let n,r=0,i=0,o=0;return n=Ps(t),r=127&n,128&n&&(n=Ps(t),r|=(127&n)<<7,128&n&&(n=Ps(t),r|=(127&n)<<14,128&n&&(n=Ps(t),r|=(127&n)<<21,128&n&&(n=Ps(t),i=127&n,128&n&&(n=Ps(t),i|=(127&n)<<7,128&n&&(n=Ps(t),i|=(127&n)<<14,128&n&&(n=Ps(t),i|=(127&n)<<21,128&n&&(n=Ps(t),o=127&n,128&n&&(n=Ps(t),o|=(127&n)<<7))))))))),{low:r|i<<28,high:i>>>4|o<<24,unsigned:e}}function Rc(t,e){let n=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,i=e.high>>>24,o=i===0?r===0?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,a=VE(t,o),d=t.bytes;switch(o){case 10:d[a+9]=i>>>7&1;case 9:d[a+8]=o!==9?128|i:127&i;case 8:d[a+7]=o!==8?r>>>21|128:r>>>21&127;case 7:d[a+6]=o!==7?r>>>14|128:r>>>14&127;case 6:d[a+5]=o!==6?r>>>7|128:r>>>7&127;case 5:d[a+4]=o!==5?128|r:127&r;case 4:d[a+3]=o!==4?n>>>21|128:n>>>21&127;case 3:d[a+2]=o!==3?n>>>14|128:n>>>14&127;case 2:d[a+1]=o!==2?n>>>7|128:n>>>7&127;case 1:d[a]=o!==1?128|n:127&n}}const o2={},a2={},FE=4294967296,O$=FE*FE,N$=O$/2;d2(0,!0);const c2=d2(0),P$=kp(0,-2147483648,!1),D$=kp(-1,2147483647,!1);function d2(t,e){let n,r,i;return e?(i=0<=(t>>>=0)&&t<256)&&(r=a2[t],r)?r:(n=kp(t,0,!0),i&&(a2[t]=n),n):(i=-128<=(t|=0)&&t<128)&&(r=o2[t],r)?r:(n=kp(t,t<0?-1:0,!1),i&&(o2[t]=n),n)}function kp(t,e,n){return{low:0|t,high:0|e,unsigned:!!n}}function l2(t,e){if(isNaN(t))return c2;{if(t<=-9223372036854776e3)return P$;if(t+1>=N$)return D$}return t<0?c2:kp(t%FE|0,t/FE|0,e)}function u2(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}class rI extends _n{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(to.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var n;super(),b(this,"name","AgoraRTCImageModeration"),b(this,"_connectionState",as.CONNECTING),b(this,"_sequence",0),b(this,"_moderationStartTime",void 0),b(this,"_workerConnection",void 0),b(this,"_workerMessageLengthLimit",void 0),b(this,"_qualityRatio",void 0),b(this,"_connectInfo",void 0),b(this,"_cancelTokenSource",ai.CancelToken.source()),b(this,"_retryConfig",void 0),b(this,"_moderationInterval",void 0),b(this,"_moderationTimer",null),b(this,"_moderationMode",1),b(this,"_quality",1),b(this,"_qualityTimer",null),b(this,"_ticket",void 0),b(this,"_moderationIntervalMinimum",void 0),b(this,"_uploadFailedNum",0),b(this,"_uploadNum",0),b(this,"_uploadTimer",null),b(this,"_extraInfo",void 0),b(this,"_vendor",""),b(this,"_encoder",new TextEncoder),b(this,"_moderationId",void 0),b(this,"inspectImage",()=>{if(this.connectionState!==as.CONNECTED)throw new z(D.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===as.CONNECTED?this.requestToInspectImage():v.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=ze(5,"image-moderation-"),this._workerMessageLengthLimit=M("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=M("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=M("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new yp("worker-"+this._moderationId,qn),this.on(to.STATE_CHANGE,(r,i)=>{v.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Iu[r]," ").concat(i||""))}),this.handleWorkerEvents()}async init(e,n){this.emit(to.STATE_CHANGE,Iu.CONNECT_AP),this._connectInfo=e;const r=this._cancelTokenSource.token;return this._retryConfig=n,new mt((i,o)=>{this.on(to.CONNECTION_STATE_CHANGE,(a,d)=>{a===as.CONNECTED&&i()}),this.requestAP(e,r,n).then(a=>{this.connectWorker(a)}).catch(a=>{o(a)})})}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),v.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===as.CONNECTED&&this.inspectImage()}async requestAP(e,n,r){const i=M("WEBCS_DOMAIN").map(l=>"https://".concat(l,"/api/v1")),o=await function(l,h,f,m){let{appId:T,areaCode:S,cname:w,sid:I,token:C,uid:N}=h;Nu++;const P="moderation_plugin",x={service_name:P,json_body:JSON.stringify({appId:T,areaCode:S,cname:w,command:"allocateEdge",requestId:Nu,seq:Nu,sid:I,appToken:C,ts:Date.now(),uid:N+""})};let W,H,j=l[0];return Xs(async()=>{W=Date.now();const $=await eo(j,{data:x,cancelToken:f,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(H=Date.now()-W,$.code!==0){const Tt=new z(D.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+$.code,{retry:!0,responseTime:H});throw v.error(Tt.toString()),Tt}const ct=JSON.parse($.json_body);if(ct.code!==200){const Tt=new z(D.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(ct.code,", reason: ").concat(ct.reason),{code:ct.code,responseTime:H});throw v.error(Tt.toString()),Tt}if(!ct.servers||!Array.isArray(ct.servers)||ct.servers.length===0){const Tt=new z(D.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:ct.code,responseTime:H});throw v.error(Tt.toString()),Tt}if(!ct.servers.some(Tt=>!!Tt.wss)){const Tt=new z(D.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:ct.code,responseTime:H});throw v.error(Tt.toString()),Tt}const Et=M("IMAGE_MODERATION_WORKER_HOST");return{addressList:ct.servers.map(Tt=>{let{address:he,wss:pe}=Tt;if(he&&pe)return"wss://".concat(he.replace(/\./g,"-"),".").concat(Et,":").concat(pe,"/moderation")}).filter(Tt=>!!Tt),workerToken:ct.workerToken,vid:ct.vid,ticket:ct.appTicket,responseTime:H}},($,ct)=>(bt.apworkerEvent(I,{success:!0,sc:200,serviceName:P,responseDetail:JSON.stringify($.addressList),firstSuccess:ct===0,responseTime:H,serverIp:l[ct%l.length]}),!1),($,ct)=>(bt.apworkerEvent(I,{success:!1,sc:$.data&&$.data.code||200,serviceName:P,responseTime:H,serverIp:l[ct%l.length]}),!!($.code!==D.OPERATION_ABORTED&&$.code!==D.UNEXPECTED_RESPONSE||$.data&&$.data.retry)&&(j=l[(ct+1)%l.length],!0)),m)}(i,e,n,r);this.emit(to.STATE_CHANGE,Iu.AP_CONNECTED);const{addressList:a,ticket:d}=o;return this._ticket=d,a}async connectWorker(e){this.emit(to.STATE_CHANGE,Iu.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Qt.CONNECTED,async()=>{this.emit(to.STATE_CHANGE,Iu.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=as.CONNECTED}),this._workerConnection.on(Qt.CLOSED,()=>{this.connectionState=as.CLOSED}),this._workerConnection.on(Qt.FAILED,()=>{this.connectionState=as.CLOSED}),this._workerConnection.on(Qt.RECONNECTING,()=>{this.connectionState=this.connectionState===as.CONNECTED?as.RECONNECTING:as.CONNECTING}),this._workerConnection.on(Qt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const n=I$(new Uint8Array(e.data));M("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&v.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,v.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{bt.reportApiInvoke(this._connectInfo.sid||null,{name:Kn.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:vn.TRACER}).onError(new z(D.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},M("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else v.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Qt.WILL_RECONNECT,(e,n,r)=>{e==="recover"&&r(e),r("tryNext")}),this._workerConnection.on(Qt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=Bi(this,to.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(M("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&v.debug("Only the track being played can be inspected"));this._sequence++;const r=await this.generateRequestData(e,n);this._workerConnection.sendMessage(r,!0,!0)}else M("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&v.debug("Only the track being published can be inspected")}async generateRequestData(e,n){let{appId:r,cname:i,cid:o,vid:a,sid:d,uid:l}=n;const h=Date.now(),f=await e.getCurrentFrameImage("image/jpeg",this.quality),m=await xL(f,r,i),T=this._sequence+"-"+o+"-"+l+"-"+h+"-"+ze(12,""),S={appId:r,cid:o,cname:i,deviceId:"",elapse:rI.intToLong(Number(h-this._moderationStartTime)),fileSize:f.buffer.byteLength,height:f.height,width:f.width,jpg:m,networkType:6,osType:7,requestId:T,sdkVersion:"4.23.2",sequence:this._sequence,sid:d,timestamp:l2(h),uid:l,vid:a,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete S.callbackData;const w=R$(S);if(w.byteLength<this._workerMessageLengthLimit){if(M("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const I=function(C){for(var N=1;N<arguments.length;N++){var P=arguments[N]!=null?arguments[N]:{};N%2?u2(Object(P),!0).forEach(function(x){b(C,x,P[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(C,Object.getOwnPropertyDescriptors(P)):u2(Object(P)).forEach(function(x){Object.defineProperty(C,x,Object.getOwnPropertyDescriptor(P,x))})}return C}({},S);delete I.jpg,v.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(I))}return w}{const I=this.quality*this._qualityRatio;return this.quality=I,await this.generateRequestData(e,{appId:r,cname:i,cid:o,vid:a,sid:d,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ai.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=as.CLOSED,this.emit(to.STATE_CHANGE,Iu.CLOSED)}}function h2(t){if(Ge(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new z(D.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new z(D.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const k$={name:"ImageModeration",create:function(t){let{config:e}=t;return h2(e),new rI(e)}};var p2,f2,_2,m2,E2,g2,T2,S2,v2,y2,R2,I2,C2,A2,w2,b2,O2,N2,P2,D2,k2,L2,M2,U2,x2,V2,F2,B2,j2,G2,W2,H2,K2,q2,Y2,z2,J2,X2,Q2,$2,Z2,gt;function tx(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Ds(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?tx(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tx(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}Or.setLogger(v);let L$=(p2=xt(),f2=xt({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof mu))return[e];e=[e]}return e.map(n=>n?Object(n).toString():"null")}}),_2=xt({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==_u.DATA?(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())):[e.getChannelId()])}),m2=xt({argsMap:(t,e,n,r)=>[typeof e=="object"?e.uid:e,n,r]}),E2=xt({argsMap:(t,e,n)=>[e,n]}),g2=xt({argsMap:(t,e)=>e.map(n=>{let{user:r,mediaType:i}=n;return[r==null?void 0:r.uid,i]})}),T2=xt({argsMap:(t,e,n,r)=>[typeof e=="object"?e.uid:e,n,r]}),S2=xt({argsMap:(t,e)=>e.map(n=>{let{user:r,mediaType:i}=n;return{uid:r==null?void 0:r.uid,mediaType:i}})}),v2=xt(),y2=xt(),R2=xt(),I2=xt(),C2=xt(),A2=xt(),w2=xt(),b2=xt(),O2=xt(),N2=xt(),P2=xt(),D2=xt(),k2=xt(),L2=xt(),M2=xt(),U2=xt({argsMap:(t,e)=>[e]}),x2=xt(),V2=xt(),F2=xt(),B2=xt(),j2=xt(),G2=xt(),W2=xt(),H2=xt(),K2=xt({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),q2=xt(),Y2=xt(),z2=xt(),J2=xt(),X2=xt(),Q2=xt(),$2=xt({reportResult:!0}),Z2=xt(),gt=class extends _n{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){let n;if(super(),b(this,"store",void 0),b(this,"_uid",void 0),b(this,"_channelName",void 0),b(this,"_uintUid",void 0),b(this,"_users",[]),b(this,"_config",void 0),b(this,"_clientId",void 0),b(this,"_appId",void 0),b(this,"_sessionId",null),b(this,"_key",void 0),b(this,"_rtmConfig",{}),b(this,"_joinInfo",void 0),b(this,"_gateway",void 0),b(this,"_statsCollector",void 0),b(this,"_configDistribute",void 0),b(this,"_leaveMutex",void 0),b(this,"_publishMutex",void 0),b(this,"_renewTokenMutex",void 0),b(this,"_subscribeMutex",void 0),b(this,"_encryptionMode","none"),b(this,"_encryptionSecret",null),b(this,"_encryptionSalt",null),b(this,"_encryptDataStream",!1),b(this,"_encryptDataStreamKey",null),b(this,"_encryptDataStreamIv",null),b(this,"_proxyServer",void 0),b(this,"_turnServer",{servers:[],mode:"auto"}),b(this,"_cloudProxyServerMode","disabled"),b(this,"_isDualStreamEnabled",!1),b(this,"_defaultStreamFallbackType",void 0),b(this,"_lowStreamParameter",void 0),b(this,"_streamFallbackTypeCacheMap",new Map),b(this,"_remoteStreamTypeCacheMap",new Map),b(this,"_axiosCancelSource",ai.CancelToken.source()),b(this,"_audioVolumeIndicationInterval",void 0),b(this,"_networkQualityInterval",void 0),b(this,"_userOfflineTimeout",void 0),b(this,"_streamRemovedTimeout",void 0),b(this,"_liveTranscodeStreamingClient",void 0),b(this,"_liveRawStreamingClient",void 0),b(this,"_channelMediaRelayClient",void 0),b(this,"_networkQualitySensitivity","normal"),b(this,"_p2pChannel",void 0),b(this,"_useLocalAccessPoint",!1),b(this,"_setLocalAPVersion",void 0),b(this,"_joinAndNotLeaveYet",!1),b(this,"_numberOfJoinCount",0),b(this,"_remoteDefaultVideoStreamType",void 0),b(this,"_inspect",void 0),b(this,"_moderation",void 0),b(this,"_license",void 0),b(this,"_pendingPublishedUsers",[]),b(this,"ntpAlignErrorCount",0),b(this,"remoteInboundOffset",0),b(this,"_peerConnectionState",void 0),b(this,"_handleLocalTrackEnable",(i,o,a)=>{this.publish(i,!1).then(o).catch(a)}),b(this,"_handleLocalTrackDisable",(i,o,a)=>{this.unpublish(i).then(o).catch(a)}),b(this,"_handleUserOnline",i=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(i.uid,this.channelName))return void v.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&typeof i.uid!="string"&&v.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const o=this._users.find(a=>a.uid===i.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(de.USER_JOINED,o));else{const a=new Sc(i.uid,i.uint_id||i.uid);this._users.push(a),v.debug("[".concat(this._clientId,"] user online"),i.uid),this.safeEmit(de.USER_JOINED,a)}}),b(this,"_handleUserOffline",i=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(i.uid,this.channelName))return;const o=this._users.find(a=>a.uid===i.uid);o&&(this._handleRemoveStream(i),this._handleRemoveDataChannels(i),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:jm(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),v.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.safeEmit(de.USER_LEAVED,o,i.reason))}),b(this,"_handleAddAudioOrVideoStream",(i,o,a,d,l,h,f)=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(o,this.channelName))return;const m=this._users.find(S=>S.uid===o);if(!m)return void v.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));v.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(m.uid,i,void 0,void 0,void 0,Date.now());const T=i==="audio"?m.hasAudio:m.hasVideo;m._uintid||(m._uintid=l||o),i==="audio"?m._trust_audio_stream_added_state_=!0:m._trust_video_stream_added_state_=!0,i==="audio"?(m._audio_added_=!0,a!==void 0&&(m._audioSSRC=a),d!==void 0&&(m._cname=d),h&&(m._audioOrtc=h)):(m._video_added_=!0,a!==void 0&&(m._videoSSRC=a),d!==void 0&&(m._cname=d),f!==void 0&&(m._rtxSsrcId=f),h&&(m._videoOrtc=h)),(i==="audio"?m.hasAudio:m.hasVideo)&&!T&&(v.info("[".concat(this._clientId,"] remote user ").concat(m.uid," published ").concat(i)),this.safeEmit(de.USER_PUBLISHED,m,i)),i==="video"?bt.onGatewayStream(this._sessionId,nr.ON_ADD_VIDEO_STREAM,cn.ON_ADD_VIDEO_STREAM,{peer:l||o,ssrc:m._videoSSRC}):bt.onGatewayStream(this._sessionId,nr.ON_ADD_AUDIO_STREAM,cn.ON_ADD_AUDIO_STREAM,{peer:l||o,ssrc:m._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(m,i,a).then(S=>{if(S&&(v.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(m.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Pp))return this._p2pChannel.unsubscribe(m,i,!0).then(()=>this._subscribe(m,i,!0).catch(w=>{v.error("[".concat(this._clientId,"] resubscribe error"),w.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(m,i)&&(v.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(m.uid," after reconnect.")),this._subscribe(m,i,!0).catch(S=>{v.error("[".concat(this._clientId,"] resubscribe error"),S.toString())}))}),b(this,"_handleRemoveStream",i=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(i.uid,this.channelName))return;const o=this._users.find(d=>d.uid===i.uid);if(!o)return void v.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));v.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let a=()=>{};o.hasAudio&&o.hasVideo?a=()=>{v.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(de.USER_UNPUBLISHED,o,"audio"),v.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(de.USER_UNPUBLISHED,o,"video")}:o.hasVideo?a=()=>{v.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(de.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(a=()=>{v.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(de.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Pp&&this._p2pChannel.unsubscribe(o).then(d=>{if(d)return this._gateway.unsubscribe(d,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),bt.onGatewayStream(this._sessionId,nr.ON_REMOVE_STREAM,cn.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),a()}),b(this,"_handleSetStreamLocalEnable",(i,o,a)=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(o,this.channelName))return;const d=this._users.find(f=>f.uid===o);if(!d)return void v.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));v.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(a?"enabled":"disabled"," with uid ").concat(o));const l=i==="audio"?d.hasAudio:d.hasVideo;if(i==="audio"){d._trust_audio_enabled_state_=!0;const f=d._audio_enabled_;if(d._audio_enabled_=a,d._audio_enabled_===f)return;{const m=d._audio_enabled_?"enable-local-audio":"disable-local-audio";v.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(m)),this.safeEmit(de.USER_INFO_UPDATED,o,m)}}else{d._trust_video_enabled_state_=!0;const f=d._video_enabled_;if(d._video_enabled_=a,d._video_enabled_===f)return;{const m=d._video_enabled_?"enable-local-video":"disable-local-video";v.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(m)),this.safeEmit(de.USER_INFO_UPDATED,o,m)}}const h=i==="audio"?d.hasAudio:d.hasVideo;return l!==h?!l&&h?(v.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(i)),void this.safeEmit(de.USER_PUBLISHED,d,i)):(i==="video"&&d._videoTrack&&d._videoTrack._destroy(),i==="audio"&&d._audioTrack,this._p2pChannel.muteRemote(d,i),v.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(i)),void this.safeEmit(de.USER_UNPUBLISHED,d,i)):void 0}),b(this,"_handleMuteStream",(i,o,a)=>{if(M("BLOCK_LOCAL_CLIENT")&&Ad(i,this.channelName))return;v.debug("[".concat(this._clientId,"] receive mute message"),i,o,a);const d=this._users.find(f=>f.uid===i);if(!d)return void v.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));const l=o==="audio"?d.hasAudio:d.hasVideo;if(o==="audio"){d._trust_audio_mute_state_=!0;const f=d._audio_muted_;if(d._audio_muted_=a,d._audio_muted_===f)return;{const m=d._audio_muted_?"mute-audio":"unmute-audio";v.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(m)),this.safeEmit(de.USER_INFO_UPDATED,i,m)}}else{d._trust_video_mute_state_=!0;const f=d._video_muted_;if(d._video_muted_=a,d._video_muted_===f)return;{const m=d._video_muted_?"mute-video":"unmute-video";v.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(m)),this.safeEmit(de.USER_INFO_UPDATED,i,m)}}const h=o==="audio"?d.hasAudio:d.hasVideo;if(l!==h){if(!l&&h)return(o==="audio"?d._audioSSRC:d._videoSSRC)?(v.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(o)),void this.safeEmit(de.USER_PUBLISHED,d,o)):void v.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));o==="video"&&d._videoTrack&&!d._video_pre_subscribed&&d._videoTrack._destroy(),o==="audio"&&d._audioTrack,this._p2pChannel.muteRemote(d,o),v.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(o)),this.safeEmit(de.USER_UNPUBLISHED,d,o)}}),b(this,"_handleP2PLost",async i=>{v.debug("[".concat(this._clientId,"] receive p2p lost"),i),parseInt(i.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():v.warning("[".concat(this._clientId,"] P2PLost stream not found"),i)}),b(this,"_handleTokenWillExpire",()=>{v.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(de.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),b(this,"_handleBeforeUnload",i=>{i.type==="beforeunload"&&i.returnValue!==void 0&&i.returnValue!==""||(this.leave(),v.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),b(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(de.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(de.NETWORK_QUALITY,i)}),b(this,"_handleP2PAddAudioOrVideoStream",(i,o,a,d)=>{const l=this._users.find(f=>f.uid===o);if(!l)return void v.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));v.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(l.uid,i,void 0,void 0,void 0,Date.now());const h=i==="audio"?l.hasAudio:l.hasVideo;i==="audio"?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,i==="audio"?(l._audio_added_=!0,a!==void 0&&(l._audioSSRC=a),d!==void 0&&(l._audioMid=d)):(l._video_added_=!0,a!==void 0&&(l._videoSSRC=a),d!==void 0&&(l._videoMid=d)),(i==="audio"?l.hasAudio:l.hasVideo)&&!h&&(v.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(i)),this.safeEmit(de.USER_PUBLISHED,l,i)),this._p2pChannel.hasPendingRemoteMedia(l,i)&&(v.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,i,!0).catch(f=>{v.error("[".concat(this._clientId,"] resubscribe error"),f.toString())}))}),this._config=t,this._clientId=e||ze(5,"client-"),this.store=new class{constructor(i,o,a,d){Yt(this,"state",void 0),this.state={codec:i,audioCodec:o,mode:a,clientId:d,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Td.Default,hasStartJoinChannel:!1,isABTestSuccess:!1}}dispatch(i){this.state=function(o,a){switch(a.type){case le.SET_SESSION_ID:return St(St({},o),{},{sessionId:a.sessionId});case le.SET_P2P_ID:return St(St({},o),{},{p2pId:a.p2pId});case le.SET_UID:return St(St({},o),{},{uid:a.uid});case le.SET_INT_UID:return St(St({},o),{},{intUid:a.intUid});case le.SET_PUB_ID:return St(St({},o),{},{pubId:a.pubId});case le.KEY_METRIC_CLIENT_CREATED:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{clientCreated:a.metric})});case le.KEY_METRIC_JOIN_START:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{joinStart:a.metric})});case le.AVOID_JOIN_START:return St(St({},o),{},{avoidJoinStart:a.avoidJoinStart});case le.KEY_METRIC_JOIN_END:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{joinEnd:a.metric})});case le.KEY_METRIC_REQUEST_AP_START:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{requestAPStart:a.metric})});case le.KEY_METRIC_REQUEST_AP_END:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{requestAPEnd:a.metric})});case le.KEY_METRIC_JOIN_GATEWAY_START:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{joinGatewayStart:a.metric})});case le.KEY_METRIC_JOIN_GATEWAY_END:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{joinGatewayEnd:a.metric})});case le.KEY_METRIC_PEER_CONNECTION_START:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{peerConnectionStart:a.metric})});case le.KEY_METRIC_PEER_CONNECTION_END:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{peerConnectionEnd:a.metric})});case le.KEY_METRIC_DESCRIPTION_START:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{descriptionStart:a.metric})});case le.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{signalChannelOpen:a.metric})});case le.KEY_METRIC_ICE_CONNECTION_END:return St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{iceConnectionEnd:a.metric})});case le.KEY_METRIC_PUBLISH:{const d=o.keyMetrics.publish,l=d.findIndex(h=>h.trackId===a.metric.trackId);return l!==-1?(d[l]=St(St({},d[l]),a.metric),St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{publish:[...d]})})):St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{publish:[...o.keyMetrics.publish,a.metric]})})}case le.KEY_METRIC_SUBSCRIBE:{const d=o.keyMetrics.subscribe,l=d.findIndex(h=>h.userId===a.metric.userId&&h.type===a.metric.type);return l!==-1?(d[l]=St(St({},d[l]),a.metric),St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{subscribe:[...d]})})):St(St({},o),{},{keyMetrics:St(St({},o.keyMetrics),{},{subscribe:[...o.keyMetrics.subscribe,a.metric]})})}case le.SET_CLOUD_PROXY_SERVER_MODE:return o.cloudProxyServerMode=a.mode,o;case le.RECORD_JOIN_CHANNEL_SERVICE:return typeof a.index!="number"?o.joinChannelServiceRecords=[...o.joinChannelServiceRecords,a.record]:(o.joinChannelServiceRecords[a.index]=St(St({},o.joinChannelServiceRecords[a.index]),a.record),o.joinChannelServiceRecords=[...o.joinChannelServiceRecords]),o;case le.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return o.joinChannelServiceRecords=[],o;case le.RESET_KEY_METRICS:return o.keyMetrics={publish:[],subscribe:[]},o;case le.SET_USE_P2P:return St(St({},o),{},{useP2P:a.val});case le.SET_TRANSPORT_TYPE:return St(St({},o),{},{p2pTransport:a.val});default:return o}}(this.state,i)}set sessionId(i){this.dispatch({type:le.SET_SESSION_ID,sessionId:i})}get sessionId(){return this.state.sessionId}set cid(i){this.state.cid=i}get cid(){return this.state.cid}set codec(i){this.state.codec=i}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(i){this.dispatch({type:le.SET_P2P_ID,p2pId:i})}get p2pId(){return this.state.p2pId}set dcId(i){this.dispatch({type:le.SET_DC_ID,dcId:i})}get dcId(){return this.state.dcId}set uid(i){this.dispatch({type:le.SET_UID,uid:i})}get uid(){return this.state.uid}set intUid(i){this.dispatch({type:le.SET_INT_UID,intUid:i})}get intUid(){return this.state.intUid}set pubId(i){this.dispatch({type:le.SET_PUB_ID,pubId:i})}get pubId(){return this.state.pubId}set cloudProxyServerMode(i){this.dispatch({type:le.SET_CLOUD_PROXY_SERVER_MODE,mode:i})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(i){this.dispatch({type:le.SET_USE_P2P,val:i})}get useP2P(){return this.state.useP2P}set p2pTransport(i){this.dispatch({type:le.SET_TRANSPORT_TYPE,val:i})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(i){this.state.hasStartJoinChannel=i}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(i){this.state.isABTestSuccess=i}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:le.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:le.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:le.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:le.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:le.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:le.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:le.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:le.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:le.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:le.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:le.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:le.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(i,o,a,d){this.dispatch({type:le.KEY_METRIC_PUBLISH,metric:St(St({trackId:i,type:o},a&&{publishStart:a}),d&&{publishEnd:d})})}subscribe(i,o,a,d,l,h,f){this.dispatch({type:le.KEY_METRIC_SUBSCRIBE,metric:St(St(St(St(St({userId:i,type:o},a&&{subscribeStart:a}),d&&{subscribeEnd:d}),l&&{firstFrame:l}),h&&{streamAdded:h}),f&&{firstDecoded:f})})}massSubscribe(i,o,a,d){i.forEach(l=>{this.dispatch({type:le.KEY_METRIC_SUBSCRIBE,metric:St(St(St({userId:l.userId,type:l.type},o&&{subscribeStart:o}),a&&{subscribeEnd:a}),d&&{firstFrame:d})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(i,o){i.service==="gateway"&&Array.isArray(i.urls)&&(i.urls=i.urls.map(a=>a.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof o!="number"?(this.dispatch({type:le.RECORD_JOIN_CHANNEL_SERVICE,record:St(St({},i),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(o<0||o>=this.state.joinChannelServiceRecords.length||this.dispatch({type:le.RECORD_JOIN_CHANNEL_SERVICE,record:i,index:o}),o)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:le.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:le.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(i){this.dispatch({type:le.AVOID_JOIN_START,avoidJoinStart:i})}}(t.codec,t.audioCodec,t.mode,this._clientId),this._leaveMutex=new Or("client-leave",this._clientId),this._publishMutex=new Or("client-publish",this._clientId),this._renewTokenMutex=new Or("client-renewtoken",this._clientId),this._subscribeMutex=new Or("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),v.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(is," build: ").concat(Jy,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Uy(t.clientRoleOptions),n=Object.assign({},t.clientRoleOptions)}catch(i){v.warning("[".concat(this._clientId,"] ").concat(i.toString()))}var r;this._statsCollector=new Op(this.store),this._statsCollector.onStatsException=(i,o,a)=>{v.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(o,", uid: ").concat(a)),this.safeEmit(de.EXCEPTION,{code:i,msg:o,uid:a})},this._statsCollector.onUploadPublishDuration=(i,o,a,d)=>{const l=this._users.find(h=>h.uid===i);l&&bt.peerPublishStatus(this._sessionId,{subscribeElapse:d,audioPublishDuration:o,videoPublishDuration:a,peer:l._uintid})},this.store.useP2P=t.mode==="p2p",this._gateway=new $Q(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||qn,httpRetryConfig:t.httpRetryConfig||qn,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:n}),this._configDistribute=new c$(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(r={store:this.store,statsCollector:this._statsCollector},wa("P2PChannel").create(r)),this._handleP2PEvents()):this._p2pChannel=new Pp(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,n,r,i){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],a=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Fe("JOIN_GATEWAY_USE_443PORT_ONLY",o),Fe("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const d=this._gateway.signal.websocket;return d instanceof bR&&(d.use443PortOnly=o,d.tryDoubleDomain=a),async function(l,h,f){Um.get(l)||Um.set(l,[]),xm.get(l)||xm.set(l,h),Co.get(l)||Co.set(l,0);const m=Um.get(l),T=xm.get(l);if(!m||!T)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Co.get(l)===T){const N=op();m.push(N),await N.promise}Co.set(l,Co.get(l)+1);for(var S=arguments.length,w=new Array(S>3?S-3:0),I=3;I<S;I++)w[I-3]=arguments[I];const C=await f(...w);return Co.set(l,Co.get(l)-1),Co.get(l)===T-1&&m.length>0&&(m[0].resolve(),m.shift()),Co.get(l)===0&&(Um.set(l,[]),xm.set(l,0),Co.set(l,0)),C}("client.join",M("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,r,i)}async join(t,e,n,r,i){const o=++this._numberOfJoinCount;this.store.joinStart(),r&&(this.store.uid=r);const a=(Hm||Hm||(Hm=(window.location.protocol.split(":")[0]||"").toUpperCase(),Hm))==="HTTPS",d=Qk()?window.isSecureContext:"Browser Not Support";(!Qk()&&!a||!window.isSecureContext)&&v.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),v.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),bt.setAppId(t);try{if(!n&&n!==null)throw new z(D.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&ur(n,"token",1,2047),ur(t,"appid",1,2047),hE(e),r&&pE(r),i&&ur(i,"optionalInfo",1,2047)}catch(I){throw bt.reportApiInvoke(gd(),{name:Kn.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:d},tag:vn.TRACER}).onError(I),I}if(this._leaveMutex.isLocked&&(v.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),v.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const I=new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw bt.reportApiInvoke(gd(),{name:Kn.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:d},tag:vn.TRACER}).onError(I),I}this._gateway.state="CONNECTING";const l=await XU({appId:t,cname:e,uid:r,stringUid:typeof r=="string"?r:void 0,token:n||t,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const h=(l==null?void 0:l.sid)||gd();v.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._sessionId||(this._sessionId=h,this.store.sessionId=this._sessionId);const f=bt.reportApiInvoke(h,{id:this._clientId,name:Kn.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:d},tag:vn.TRACER}),m=Ds(Ds(Ds({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof r!="string"?r:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:i,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!l},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:M("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(m.setLocalAPVersion=this._setLocalAPVersion),typeof r=="string"&&(m.stringUid=r,this._uintUid?(m.uid=this._uintUid,this._uintUid=void 0):m.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(m.aesmode=this._encryptionMode,m.aespassword=await(async I=>{const C=function(W){const H=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),j=new Uint8Array(new ArrayBuffer(H.length));for(let $=0;$<H.length;$+=1)j[$]=H.charCodeAt($);return j}(),N=await window.crypto.subtle.importKey("spki",C,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),P=Ly(I),x=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},N,P);return function(W){let H="";for(let j=0;j<W.length;j+=1)H+=String.fromCharCode(W[j]);return window.btoa(H)}(new Uint8Array(x))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(m.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const I=new TextEncoder,C=M("USE_PURE_ENCRYPTION_MASTER_KEY")?I.encode(m.appId+this._encryptionSecret+this._encryptionSecret):I.encode(m.appId+m.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(N,P,x){const W=await window.crypto.subtle.importKey("raw",P,"PBKDF2",!1,["deriveBits","deriveKey"]),H=N==="aes-128-gcm2"?128:256,j=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:aL,hash:"SHA-256",salt:x},W,H+bX);return new Uint8Array(j).subarray(H/8)}(this._encryptionMode,C,Ed(this._encryptionSalt)),this._encryptDataStreamKey=await async function(N,P,x){const W=await window.crypto.subtle.importKey("raw",P,"PBKDF2",!1,["deriveBits","deriveKey"]),H=N==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:aL,hash:"SHA-256",salt:x},W,{name:"AES-GCM",length:H},!0,["encrypt","decrypt"])}(this._encryptionMode,C,Ed(this._encryptionSalt))}else d?v.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):v.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,v.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:m.stringUid});const T=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&T===this._sessionId&&bt.joinChannelTimeout(this._sessionId,5)},5e3);try{var S;let I;const C=m.cloudProxyServer;if(ft(S=["proxy3","proxy4","proxy5"]).call(S,C)){const H=M("PROXY_SERVER_TYPE3");Array.isArray(H)?m.proxyServer=H[0]:m.proxyServer=H}if(bt.setProxyServer(m.proxyServer),v.setProxyServer(m.proxyServer),this.store.requestAPStart(),l){if(v.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(m.stringUid?", ".concat(m.stringUid," => ").concat(l.intUid):""," ")),m.stringUid&&!m.uid&&(m.uid=l.intUid),I={gatewayInfo:l.ap.gatewayInfo},M("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&m.turnServer.mode==="auto")if(l.ap.proxyInfo.addresses.length===0)v.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const H=(await G1(l.ap.proxyInfo,l.ap.gatewayInfo.uid)).map(j=>({turnServerURL:j.address,tcpport:j.tcpport||Rr.tcpport,udpport:j.udpport||Rr.udpport,username:j.username||Rr.username,password:j.password||Rr.password,forceturn:!1,security:!0}));m.turnServer={mode:"manual",servers:H}}ZU(l,m.stringUid)}else{if(m.stringUid&&!m.uid){let H;[H,I]=await mt.all([mU(m.stringUid,m,this._axiosCancelSource.token,this._config.httpRetryConfig||qn,this.store),_U(m,this._axiosCancelSource.token,this._config.httpRetryConfig||qn,!0,this.store)]),v.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(m.stringUid," => ").concat(H)),m.uid=H,I.gatewayInfo.uid=H,I.gatewayInfo.res.uid=H}else I=await _U(m,this._axiosCancelSource.token,this._config.httpRetryConfig||qn,!0,this.store);if(!this._joinAndNotLeaveYet)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(m,this._axiosCancelSource.token),this._configDistribute.on(Sp.UPDATE_BITRATE_LIMIT,H=>{this._p2pChannel.updateBitrateLimit(H)}),this._configDistribute.on(Sp.UPDATE_CLIENT_ROLE_OPTIONS,H=>{this._setClientRoleOptions(H)})},0),this._key=n||t;const N=I.gatewayInfo,P=m.uid?m.uid:N.uid;this._joinInfo=Ds(Ds({},m),{},{cid:N.cid,uid:P,vid:N.vid,apResponse:N.res,apGatewayAddress:N.apGatewayAddress,uni_lbs_ip:N.uni_lbs_ip,gatewayAddrs:N.gatewayAddrs}),this.store.intUid=P,this.store.cid=N.cid;const x=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));f.onSuccess(x),this._appId=t,this._channelName=m.cname,this._uid=x,this.store.uid=x,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Sr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const W=m.stringUid?"string uid: ".concat(m.stringUid,",uid: ").concat(m.uid):"uid: ".concat(this._uid);return v.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(W)),setTimeout(()=>{v.startUpload()},5e3),this.store.joinEnd(),w=this,ft(Cd).call(Cd,w)||Cd.push(w),this._cloudProxyServerMode==="disabled"&&Ie().supportWebCrypto&&M("ENABLE_PRELOAD")&&eI(this._joinInfo),x}catch(I){const C=Array.isArray(I)?I[0]:I;throw C&&C.code===D.OPERATION_ABORTED?v.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),C):v.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),C),C.code!==D.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),f.onError(C),C}var w}_joinGateway(){if(!this._joinInfo||!this._key)throw new z(D.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!M("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){v.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Sr()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const n=Cd.indexOf(e);n!==-1&&Cd.splice(n,1)}(this),this._statsCollector.stopUpdateStats();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return v.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",ke.LEAVE),v.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof mu))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new z(D.INVALID_PARAMS,"param list is empty");const n=t;if(this._gateway.role==="audience")throw new z(D.INVALID_OPERATION,"audience can not publish stream");for(const i of n){if(!(i instanceof mu))throw new z(D.INVALID_PARAMS,"parameter is not local track");if(!i._enabled&&e)throw new z(D.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(i.getTrackId()))}v.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(i=>"".concat(i.getTrackId()," "))));const r=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach(i=>{const o=this._configDistribute.getBitrateLimit();i instanceof en&&o&&i.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),v.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(i=>"".concat(i.getTrackId()," "))))}catch(i){throw v.error("[".concat(this._clientId,"] publish error"),i.toString()),i}finally{r()}}async _publishDataChannel(t){Ge(t.id,"id",0,65535,!0),Sa(t.ordered,"ordered"),ur(t.metadata,"metadata",0,512),v.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(i=>i.id===t.id)!==-1)throw new z(D.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new z(D.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&M("FORCE_TURN")&&!M("TURN_ENABLE_TCP")&&!M("TURN_ENABLE_UDP"))throw new z(D.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=function(i){return oU(i,!1)}(t),r=await this._p2pChannel.publishDataChannel([n]);if(r.length>0){if(typeof n._originDataChannelId!="number")throw v.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new z(D.CREATE_DATACHANNEL_ERROR);try{await mt.all(r.map(i=>this._uid&&this._gateway.publishDataChannel(this._uid,i,!0))),await n._waitTillOpen()}catch(i){if(i.code!==D.DISCONNECT_P2P)throw i}}return v.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw v.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new z(D.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof mu))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);v.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(r=>"".concat(r.getTrackId()," "))," "));const n=await this._publishMutex.lock();try{if(this.store.useP2P){const r=await this._p2pChannel.unpublish(e);r&&await this._gateway.sendExtensionMessage(Ln.UNPUBLISH,{unpubMsg:r},!0)}else{const r=await this._p2pChannel.unpublish(e);r&&await this._gateway.unpublish(r,this._uid),v.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(i=>"".concat(i.getTrackId()))))}}catch(r){throw v.error("[".concat(this._clientId,"] unpublish error"),r.toString()),r}finally{n&&n()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),v.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(n=>"".concat(n.id," "))," "));const e=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),v.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(r=>"".concat(r.id))))}catch(n){throw v.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e()}}async subscribe(t,e,n){if(!(t instanceof Sc)){const r=this.remoteUsers.find(i=>i.uid===t);if(!r)throw new z(D.INVALID_REMOTE_USER,"user is not in the channel");t=r}return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(tr(e,"mediaType",["audio","video"]),this.store.useP2P)throw new z(D.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new z(D.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=e===vt.AUDIO,r=e===vt.VIDEO,i=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:a,rtxSsrcId:d,cname:l,uint_id:h}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new z(D.UNEXPECTED_RESPONSE,"no ssrc id");let f=this._users.find(T=>T.uid===t);f||(f=new Sc(t,h||t),f._is_pre_created=!0,this._users.push(f)),l&&(f._cname=l),f._uintid||(f._uintid=h||t),n&&(f._audioSSRC=o,f._audio_pre_subscribed=!0,a&&(f._audioOrtc=a)),r&&(f._videoSSRC=o,f._video_pre_subscribed=!0,a&&(f._videoOrtc=a),d!=null&&(f._rtxSsrcId=d)),v.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(f,e,o,d,a);const m=n?f._audioTrack:f._videoTrack;if(!m)throw new z(D.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(f._trust_audio_stream_added_state_=!0,f._audio_added_=!0),r&&(f._trust_video_stream_added_state_=!0,f._video_added_=!0),m}catch(o){throw v.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{i()}}async _subscribeDataChannel(t,e){var n;if(Ge(e,"channelId",0,65535,!0),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t))throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new z(D.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new z(D.INVALID_REMOTE_USER,"user is not published");const i=(n=t._dataChannels)===null||n===void 0?void 0:n.find(d=>d.id===e);if(!i)throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new z(D.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();v.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const d=await this._p2pChannel.subscribeDataChannel(t,[i]);if(d&&ft(d).call(d,i.id))try{var a;if(typeof i._originDataChannelId!="number")throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new z(D.CREATE_DATACHANNEL_ERROR);const l={id:i.id,datachannelId:i._originDataChannelId,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:(a=i.metadata)!==null&&a!==void 0?a:""};await this._gateway.subscribeDataChannel(t.uid,l,!0),await i._waitTillOpen()}catch(l){if((l==null?void 0:l.code)!==D.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[i]),l;await this._p2pChannel.unsubscribeDataChannel(t,[i]),this._p2pChannel.setPendingRemoteDataChannel(t,i.id)}return v.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),i}finally{o()}}async _p2pSubscribe(t,e,n){if(tr(e,"mediaType",["audio","video"]),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===t)){const o=new z(D.INVALID_REMOTE_USER,"user is not in the channel");throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),o}if(!t.hasAudio&&!t.hasVideo){const o=new z(D.INVALID_REMOTE_USER,"user is not published");throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),o}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const o=new z(D.REMOTE_USER_IS_NOT_PUBLISHED);throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),o}const i=await this._subscribeMutex.lock();v.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const a=e==="audio"?t._audioSSRC:t._videoSSRC,d=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(t,e,a,d)}catch(a){throw a}v.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(a=>{v.warning("[".concat(this._clientId,"] auto set fallback failed"),a)});const o=e==="audio"?t._audioTrack:t._videoTrack;if(!o)throw new z(D.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw v.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),o),o}finally{i()}}async _subscribe(t,e,n){if(this.store.useP2P)return this._p2pSubscribe(t,e);if(tr(e,"mediaType",["audio","video"]),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(h=>h===t)){const h=new z(D.INVALID_REMOTE_USER,"user is not in the channel");throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),h}if(!t.hasAudio&&!t.hasVideo){const h=new z(D.INVALID_REMOTE_USER,"user is not published");throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),h}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const h=new z(D.REMOTE_USER_IS_NOT_PUBLISHED);throw v.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),h}let i=e==="audio"?t._audioSSRC:t._videoSSRC,o=e==="audio"?t._audioOrtc:t._videoOrtc,a=e==="video"?t._rtxSsrcId:void 0,d={stream_type:e==="audio"?vt.AUDIO:vt.VIDEO,ssrcId:i};const l=await this._subscribeMutex.lock();v.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const f=e==="audio"?t._audioSSRC:t._videoSSRC;f!==void 0&&f!==i&&(i=f,o=e==="audio"?t._audioOrtc:t._videoOrtc,a=e==="video"?t._rtxSsrcId:void 0,d={stream_type:e==="audio"?vt.AUDIO:vt.VIDEO,ssrcId:i}),Dr.markSubscribeStart(this.store.clientId,i),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,i,a,o);try{this._p2pChannel.isPreSubScribe(i)||await this._gateway.subscribe(t.uid,d,!0)}catch(m){if((m==null?void 0:m.code)!==D.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),m;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(f){throw this._p2pChannel.reportSubscribeEvent(!1,f==null?void 0:f.code,t,e),f}v.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(f=>{v.warning("[".concat(this._clientId,"] auto set fallback failed"),f)});const h=e==="audio"?t._audioTrack:t._videoTrack;if(!h)throw new z(D.UNEXPECTED_ERROR,"can not find remote track in user object");return h}catch(h){throw v.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),h),h}finally{l()}}async massSubscribe(t){if(va(t,"subscribeList"),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),n=new Map,r=await this._subscribeMutex.lock();v.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(d=>{let{user:l,mediaType:h}=d;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(h)}).join("; ")));const i=(t=[...t]).map(d=>{let{user:l,mediaType:h}=d;return{user:l,mediaType:h}}),o=await this._p2pChannel.globalLock();try{var a;for(let l=t.length-1;l>=0;l--){const h=t[l],{user:f,mediaType:m}=h;if(tr(m,"mediaType",["audio","video"]),!f){const I=new z(D.INVALID_PARAMS,"user property does not exist in subscribeList item");throw v.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),I}if(!this._users.find(I=>I===f)){const I=new z(D.INVALID_REMOTE_USER,"user is not in the channel");v.error("[".concat(this._clientId,"] can not massSubscribe ").concat(f.uid,", this user is not in the channel")),i[l].error=I,t.splice(l,1);continue}if(m==="audio"&&(!f.hasAudio||f._audioSSRC===void 0)||m==="video"&&(!f.hasVideo||f._videoSSRC===void 0)){const I=new z(D.REMOTE_USER_IS_NOT_PUBLISHED);v.error("[".concat(this._clientId,"] can not subscribe ").concat(f.uid," with mediaType ").concat(m,", remote user is not published")),i[l].error=I,t.splice(l,1);continue}const S=rr.Video|rr.LwoVideo,w=n.get(f);if(w){if(m==="video"?w&S:w&rr.Audio){t.splice(l,1),v.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(f.uid,", mediaType:").concat(m," twice"));continue}n.set(f,w|(m==="video"?S:rr.Audio))}else n.set(f,m==="video"?S:rr.Audio)}for(let l=t.length-1;l>=0;l--){const h=t[l],{user:f,mediaType:m}=h,T=rr.Video|rr.LwoVideo;if(this._p2pChannel.hasRemoteMedia(f,m)){await this._p2pChannel.unmuteRemoteNoLock(f,m);const S=n.get(f);n.set(f,m==="video"?S^T:S^rr.Audio),t.splice(l,1)}}this.store.massSubscribe(t.map(l=>({userId:l.user.uid,type:l.mediaType})),e);let d=Ws(a=Array.from(n.entries())).call(a,(l,h)=>{let[f,m]=h;if(m===0)return l;const T={stream_id:f.uid,stream_type:m};return m&rr.Audio&&(T.audio_ssrc=f._audioSSRC),m&rr.Video&&(T.video_ssrc=f._videoSSRC),l.push(T),l},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(h=>{let{user:f,mediaType:m}=h;return{user:f,mediaType:m,ssrcId:m===vt.VIDEO?f._videoSSRC:f._audioSSRC,rtxSsrcId:m===vt.VIDEO?f._rtxSsrcId:void 0}}));const l=new Map;if(d=d.filter(h=>h.video_ssrc&&!this._p2pChannel.isPreSubScribe(h.video_ssrc)||h.audio_ssrc&&!this._p2pChannel.isPreSubScribe(h.audio_ssrc)||!h.video_ssrc&&!h.audio_ssrc),d.length>0){const h=await this._gateway.subscribeAll(d,!0);((h==null?void 0:h.users)||[]).forEach(f=>{let{stream_id:m,video_error_code:T,audio_error_code:S,error_code:w}=f;(T||S||w)&&l.set(m,{video_error_code:T,audio_error_code:S,error_code:w})})}if(Array.from(l.entries()).length>0){const h=[];Array.from(l.entries()).forEach(f=>{let[m,T]=f;const S=this.remoteUsers.find(w=>w.uid===m);if(S){let w;T.error_code||T.video_error_code&&T.audio_error_code?w=void 0:T.video_error_code?w=vt.VIDEO:T.audio_error_code&&(w=vt.AUDIO),h.push({user:S,mediaType:w})}}),h.length>0&&await this._p2pChannel.massUnsubscribeNoLock(h)}for(const h of i){const f=l.get(h.user.uid);if(f){const m=f.error_code||h.mediaType==="audio"&&f.audio_error_code||h.mediaType==="video"&&f.video_error_code;if(m){const T=vp(m);v.error("user:".concat(h.user.uid," mediaType:").concat(h.mediaType," has massSubscribe error ").concat(T.desc)),h.error=new z(D.SUBSCRIBE_FAILED,"code ".concat(m,": ").concat(T.desc))}}h.error||(h.mediaType==="video"?h.track=h.user.videoTrack:h.track=h.user.audioTrack)}return this.store.massSubscribe(i.filter(h=>!h.error).map(h=>({userId:h.user.uid,type:h.mediaType})),void 0,Date.now()),i.forEach(h=>{var f;bt.subscribe(this.store.sessionId,{succ:!!h.error,ec:((f=h.error)===null||f===void 0?void 0:f.code)||null,video:h.mediaType===vt.VIDEO,audio:h.mediaType===vt.AUDIO,peerid:h.user.uid,subscribeRequestid:h.mediaType===vt.VIDEO?h.user._videoSSRC:h.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(h.user._videoSSRC)},!0)}),v.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(h=>{let{user:f,mediaType:m}=h;return"user: ".concat(f==null?void 0:f.uid,", mediaType: ").concat(m)}).join("; "))),i}catch(l){throw await this._p2pChannel.massUnsubscribeNoLock(t),l}}finally{o(),r()}}async unsubscribe(t,e,n){if(!(t instanceof Sc)){const o=this.remoteUsers.find(a=>a.uid===t);if(!o)throw new z(D.INVALID_REMOTE_USER,"user is not in the channel");t=o}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&tr(e,"mediaType",["audio","video"]),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===t)){const o=new z(D.INVALID_REMOTE_USER,"user is not in the channel");throw v.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}v.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const i=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(t,e);else{const o=await this._p2pChannel.unsubscribe(t,e);o&&await this._gateway.unsubscribe(o,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&jm(this._users,t),v.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(o){if(o.code===D.DISCONNECT_P2P)return void v.warning("disconnecting p2p, abort unsubscribe request.");throw v.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}finally{i()}}async _unsubscribeDataChannel(t,e){if(e&&Ge(e,"id",0,65535,!0),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(i=>i===t)){const i=new z(D.INVALID_REMOTE_USER,"user is not in the channel");throw v.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),i}let r;if(typeof e=="number"){const i=t._dataChannels.find(o=>o.id===e);i&&(r=[i])}else r=t._dataChannels;if(r===void 0){const i=new z(D.REMOTE_USER_IS_NOT_PUBLISHED);throw v.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),i}v.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r.map(i=>i.id)));try{const i=await this._p2pChannel.unsubscribeDataChannel(t,r);i&&await this._gateway.unsubscribeDataChannel(i,t.uid),v.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===D.DISCONNECT_P2P)return void v.warning("disconnecting p2p, abort unsubscribe request.");throw v.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),i.toString()),i}}async massUnsubscribe(t){if(va(t,"unsubscribeList"),!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");v.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(n=>{let{user:r,mediaType:i}=n;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(i,";")}).join())),t=[...t];const e=new Map;for(let n=t.length-1;n>=0;n--){const{user:r,mediaType:i}=t[n];if(!r){const d=new z(D.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw v.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),d}if(tr(i,"mediaType",["video","audio",void 0]),!this._users.find(d=>d===r)){v.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(r.uid,", user is not in the channel")),t.splice(n,1);continue}const a=rr.Video|rr.LwoVideo;if(e.has(r)){const d=e.get(r);let l;switch(i){case"video":l=d&a;break;case"audio":l=d&rr.Audio;break;default:l=d&(rr.Audio|a)}if(l){v.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(r.uid,",mediaType:").concat(i," twice.")),t.splice(n,1);continue}i?i==="audio"?e.set(r,d|rr.Audio):i==="video"&&e.set(r,d|a):e.set(r,d|rr.Audio|a)}else i?i==="audio"?e.set(r,rr.Audio):i==="video"&&e.set(r,a):e.set(r,rr.Audio|a)}try{const n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),v.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(r=>{let{user:i,mediaType:o}=r;return"user: ".concat(i==null?void 0:i.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===D.DISCONNECT_P2P)return void v.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw v.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){(function(n){if(!n)throw new et(D.INVALID_PARAMS);Sn(n.width)||Dy(n.width,"streamParameter.width"),Sn(n.height)||Dy(n.height,"streamParameter.height"),Sn(n.framerate)||Dy(n.framerate,"streamParameter.framerate"),Sn(n.bitrate)||Ge(n.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&v.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),v.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,at.LocalVideoLowTrack)}async enableDualStream(){if(!Ie().supportDualStream)throw bt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new z(D.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new z(D.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw bt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,bt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),v.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new z(D.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(at.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw bt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,bt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),v.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(r){tr(r,"role",["audience","host"])}(t),e&&Uy(e),this.mode==="rtc"||this.mode==="p2p")throw v.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new z(D.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new z(D.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new z(D.INVALID_OPERATION,"can not set client role to audience when publishing stream");const n=this._config.role;this._joinInfo&&(this._joinInfo.role=t),t!==n&&M("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(t,e),this._config.role=t,this._gateway.reconnect("recover",vr.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(t,e),this._config.role=t),v.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}async _setClientRoleOptions(t){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{t&&Uy(t),await this._gateway.setClientRole(this._config.role,t),e=!0}catch{}finally{v.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(t))}}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(ur(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new z(D.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new z(D.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,bt.setProxyServer(this._proxyServer),v.setProxyServer(this._proxyServer),v.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new z(D.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new z(D.INVALID_OPERATION,"You have already set the proxy")}if(up(t))return this._turnServer={servers:t,mode:"original-manual"},void v.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>Fk(n)),this._turnServer={servers:t,mode:"manual"},v.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new z(D.INVALID_OPERATION,"you should set license before join channel");if(ur(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new z(D.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,v.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new z(D.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new z(D.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new z(D.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new z(D.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,v.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new z(D.INVALID_OPERATION,"Stop proxy server after leave channel");bt.setProxyServer(),v.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",v.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new z(D.INVALID_PARAMS,"accessPoints is required.");va(t.accessPoints.serverList,"accessPoints.serverList"),ur(t.accessPoints.domain,"accessPoints.domain");const e=(T,S)=>{Ge(T,S,0,65535,!0)};let n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new z(D.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");M("CLOSE_AFB_FOR_LOCAL_AP")&&(Fe("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Fe("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,i=t.accessPoints.domain,o=t.accessPoints.serverList.map(T=>r.test(T)?"".concat(T.replace(/\./g,"-"),".").concat(i):T),a=o.map(T=>"".concat(T,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Fe("WEBCS_DOMAIN",a),Fe("WEBCS_DOMAIN_BACKUP_LIST",a),Fe("GATEWAY_DOMAINS",[i]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(va(t.report.hostname,"report.hostname"),Fe("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Fe("EVENT_REPORT_DOMAIN",o[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let d=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),d=t.report.port),Fe("STATS_COLLECTOR_PORT",d),t.report?Fe("ENABLE_EVENT_REPORT",!0):Fe("ENABLE_EVENT_REPORT",!1);let l="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(va(t.log.hostname,"log.hostname"),l=t.log.hostname[0]):l=o[0];let h=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),h=t.log.port),Fe("LOG_UPLOAD_SERVER","".concat(l,":").concat(h));let f=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(va(t.cds.hostname,"cds.hostname"),f=t.cds.hostname):f=o;let m=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),m=t.cds.port),Fe("CDS_AP",f.map(T=>"".concat(T,":").concat(m))),t.cds?Fe("ENABLE_CONFIG_DISTRIBUTE",!0):Fe("ENABLE_CONFIG_DISTRIBUTE",!1),v.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(va(t,"serverList"),ur(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new z(D.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(r=>n.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(e):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Fe("WEBCS_DOMAIN",t),Fe("WEBCS_DOMAIN_BACKUP_LIST",t),Fe("GATEWAY_DOMAINS",[e]),Fe("EVENT_REPORT_DOMAIN",t[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Fe("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),v.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(tr(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw v.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else v.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){tr(e,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const n=this._users.find(r=>r.uid===t);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw v.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}v.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){tr(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(n){throw v.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}v.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,n,r){(function(o){tr(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),ur(e,"secret");const i=["aes-128-gcm2","aes-256-gcm2"];if(ft(i).call(i,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new z(D.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new z(D.INVALID_PARAMS,"current encrypt mode does not need salt");if(r){if(Sa(r,"encryptDataStream"),!ft(i).call(i,t))throw new z(D.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||v.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=hc(n))}async renewToken(t){if(ur(t,"token",1,2047),!this._key||!this._joinInfo)throw new z(D.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const n=await this._renewTokenMutex.lock();try{if(M("USE_NEW_TOKEN")){v.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const r=await a$(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||qn);v.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:r})}else v.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});v.debug("[".concat(this._clientId,"] renewToken success"))}catch(r){throw this._key=e,this._joinInfo.token=e,v.error("[".concat(this._clientId,"] renewToken failed"),r.toString()),r}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?v.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(de.VOLUME_INDICATOR,t)},M("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new z(D.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new z(D.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new z(D.LIVE_STREAMING_TASK_CONFLICT);const n=e?Ia.TRANSCODE:Ia.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient(Ia.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(t));if(!e.length)throw new z(D.INVALID_PARAMS,"can not find live streaming url to stop");await mt.all(e.map(n=>n&&n.stopLiveStreamingTask(t)))}async startChannelMediaRelay(t){RU(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){RU(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(t){this._p2pChannel instanceof Pp&&this._p2pChannel.addAudioMetadata(t)}async sendStreamMessage(t){var e;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new z(D.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const i=new TextEncoder;t.payload=i.encode(t.payload)}let r=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&ft(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(r=!0,t.payload=await async function(i,o,a){var d;const l=Ws(d=Array.from(a)).call(d,(I,C)=>I+C,0),h={serverTs:0,seq:OX++,length:a.length,checkSum:l},f=new Uint8Array(Yk(l,2)),m=new ArrayBuffer(du),T=new DataView(m);T.setUint32(0,h.serverTs),T.setUint16(4,h.seq),T.setUint16(6,h.length),T.setUint16(8,h.checkSum);const S=16-a.length%16;a=Gk(a,new Uint8Array(S));const w=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i,tagLength:oL,additionalData:f},o,a);return Gk(new Uint8Array(m),new Uint8Array(w))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new z(D.INVALID_PARAMS,r?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Wt.DATA_STREAM,{payload:hc(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-m$},!n)}sendMetadata(t){if(!this._joinInfo)throw new z(D.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new z(D.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Wt.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:hc(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(VX),!this._joinInfo)throw new z(D.INVALID_OPERATION,"can not send custom report, not joined");await bt.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){tr(e.spatialLayer,"spatialLayer",[0,1,2,3]),tr(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(n){throw v.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:n}=t;if(Sa(e,"apRTM"),Ge(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,v.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(v.debug("[".concat(this._clientId,"] reset client")),function(t){const e=yu.indexOf(t);e!==-1&&yu.splice(e,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this._axiosCancelSource.cancel(),this._axiosCancelSource=ai.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&$U(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&bt.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Or("client-publish",this._clientId),this._subscribeMutex=new Or("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;const r=t||gd();t?v.debug("[".concat(this._clientId,"] new Session ").concat(r)):v.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));const i=t?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r,bt.addSid(r);const o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(e==null?void 0:e.stringUid)||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:i,clientRole:this.role==="audience"?2:1};bt.sessionInit(this._sessionId,Ds({cname:e.channel,appid:e.appId},o)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new z(D.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&M("FORCE_TURN")&&!M("TURN_ENABLE_TCP")&&!M("TURN_ENABLE_UDP"))throw new z(D.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");v.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const r=(await n.next()).value;if(r){try{await this._gateway.sendExtensionMessage(Ln.PUBLISH,r,!0)}catch(i){throw n.throw(i),i}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const r=(await n.next()).value;if(r){var e;let i;try{i=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==D.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((e=i)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const i of t)i instanceof en&&i._encoderConfig&&this._gateway.setVideoProfile(i._encoderConfig).catch(o=>{v.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!i.muted&&i.enabled||await this._p2pChannel.muteLocalTrack(i)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,t),(n==null?void 0:n.code)===D.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new z(D.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new z(D.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));v.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),r=(await n.next()).value;if(r){var e;let i;try{i=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==D.DISCONNECT_P2P)throw n.throw(o),o}n.next(((e=i)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,void 0,!0),(n==null?void 0:n.code)===D.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){const e=()=>{if(!this._joinInfo||!this._appId)return new z(D.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(r={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},wa("LiveStreaming").create(r));var r;return n.onLiveStreamError=(i,o)=>{bt.reportApiInvoke(this._sessionId,{name:Kn.ON_LIVE_STREAM_ERROR,options:[i,o],tag:vn.TRACER}).onSuccess(),this.safeEmit(de.LIVE_STREAMING_ERROR,i,o)},n.onLiveStreamWarning=(i,o)=>{bt.reportApiInvoke(this._sessionId,{name:Kn.ON_LIVE_STREAM_WARNING,options:[i,o],tag:vn.TRACER}).onSuccess(),this.safeEmit(de.LIVE_STREAMING_WARNING,i,o)},n.on(AR.REQUEST_WORKER_MANAGER_LIST,(i,o,a)=>{if(!this._joinInfo)return a(new z(D.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(d,l,h,f){const m=M("UAP_AP").slice(0,M("AJAX_REQUEST_CONCURRENT")).map(T=>l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(T+"/api/v1?action=uap"):"https://".concat(T,"/api/v1?action=uap"));return await e$(m,d,l,h,f)})(i,this._joinInfo,this._axiosCancelSource.token,qn).then(o).catch(a)}),n};return t===Ia.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new z(D.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:n}=this.getLocalVideoStats(),r=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:n}},wa("ChannelMediaRelay").create(t));r.on("state",i=>{i===vi.RELAY_STATE_FAILURE&&r&&r.dispose(),this.safeEmit(de.CHANNEL_MEDIA_RELAY_STATE,i)}),r.on("event",i=>{this.safeEmit(de.CHANNEL_MEDIA_RELAY_EVENT,i)}),this._channelMediaRelayClient=r,this._statsCollector.onStatsChanged=(i,o)=>{var a;i==="resolution"&&((a=this._channelMediaRelayClient)===null||a===void 0||a.setVideoProfile(o))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:n,deleted:r}=t,i=[];if(e){const o=[];this._users.forEach(a=>{a._dataChannels.forEach(d=>{n.every(l=>l.uid!==a._uintid||l.stream_id!==d.id)&&o.push({uid:a._uintid,stream_id:d.id,ordered:d.ordered,max_retrans_times:d.maxRetransmits,metadata:d.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(n)&&n.length>0&&n.forEach(o=>{const{uid:a,stream_id:d,ordered:l,max_retrans_times:h,metadata:f}=o,m=this._users.find(T=>T._uintid===a);if(!m)return void v.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(v.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(a)),ft(i).call(i,m)||i.push(m),m._uintid||(m._uintid=a),m._dataChannels.findIndex(T=>T.id===o.stream_id)===-1){const T={id:d,ordered:!!l,maxRetransmits:h,metadata:f},S=function(w){return oU(w,!0)}(T);m._dataChannels.push(S),v.info("[".concat(this._clientId,"] remote user ").concat(m.uid," published datachannel")),e||this.safeEmit(de.USER_PUBLISHED,m,"datachannel",T)}this._p2pChannel.hasPendingRemoteDataChannel(m,o.stream_id)&&(v.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(m.uid," after reconnect.")),this._subscribeDataChannel(m,o.stream_id).catch(T=>{v.error("[".concat(this._clientId,"] resubscribe datachannel error"),T.toString())}))}),e&&(this.safeEmit(de.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(o=>{const{uid:a,stream_id:d}=o,l=this._users.find(f=>f._uintid===a);if(!l)return void v.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const h=l._dataChannels.find(f=>f.id===o.stream_id);h&&(v.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(a)),this._p2pChannel.unsubscribeDataChannel(l,[h]).then(f=>{if(l._dataChannels=l._dataChannels.filter(m=>m!==h),f)return this._gateway.unsubscribeDataChannel(f,l.uid)}),v.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished datachannel ,id:").concat(h.id)),this.safeEmit(de.USER_UNPUBLISHED,l,"datachannel",h._config))})}_handleRemoveDataChannels(t){const e=this._users.find(n=>n.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){v.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{v.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(r=>{this.safeEmit(de.USER_UNPUBLISHED,e,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,e.uid)}),n()}}else v.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(ar.UPDATE_GATEWAY_CONFIG,()=>{(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void v.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();Object.keys(e).forEach(r=>{const{value:i,type:o,expires:a}=e[r];a&&a<=n||o||TR()||!Object.prototype.hasOwnProperty.call(Ym,r)||(Qs[r]=i,tn[r]=i,v.debug("Update gateway parameters from config distribute",r,i))})}catch(e){v.error("Error update config from local cache",e.message)}})()}),this._gateway.on(ar.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(ar.CONNECTION_STATE_CHANGE,(t,e,n)=>{var r;if(n===ke.FALLBACK)return;const i=()=>{this.safeEmit(de.CONNECTION_STATE_CHANGE,t,e,n)};if(bt.reportApiInvoke(this._sessionId||((r=this._gateway.joinInfo)===null||r===void 0?void 0:r.sid)||null,{name:Kn.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:vn.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),v.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void i();if(t==="RECONNECTING")this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((a,d)=>{this._gateway.setStreamFallbackOption(d,a).catch(l=>{v.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),l)})}),this._remoteStreamTypeCacheMap.forEach((a,d)=>{this._gateway.setRemoteVideoStreamType(d,a).catch(l=>{v.warning("[".concat(this._clientId,"] auto set remote stream type failed"),l)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{v.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{v.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{v.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(v.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,vt.AUDIO,!1)),a._trust_video_mute_state_||(v.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,vt.VIDEO,!1)),a._trust_audio_enabled_state_||(v.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(v.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(v.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(v.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(v.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}i()}),this._gateway.on(ar.REQUEST_NEW_GATEWAY_LIST,async(t,e)=>{if(!this._joinInfo)return e(new z(D.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;const r=await XU(Ds(Ds({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(n=r.ap,ZU(r),this._joinInfo.preload=!0):(n=await GR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||qn,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach(o=>{let{address:a}=o;const[d,l]=a.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:d,port:l}):i.push({host:d,port:l})}),t(i)}catch(n){e(n)}}),this._gateway.on(ar.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(de.NETWORK_QUALITY,t)}),this._gateway.on(ar.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(de.STREAM_TYPE_CHANGED,t,e),bt.reportApiInvoke(this._sessionId,{name:Kn.STREAM_TYPE_CHANGE,options:[t,e],tag:vn.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(ar.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(ar.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,n)=>{try{let r=await this._p2pChannel.getEstablishParams();M("ENABLE_PREALLOC_PC")&&r||(r=await this._p2pChannel.startP2PConnection(t)),e(r)}catch(r){n(r)}}),this._gateway.on(ar.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;let n;t.attributes?n=t.attributes.userAttributes.preSubSsrcs:v.debug("no attributes in joinResponse");const r=z1(t.ortc,e,n);this._p2pChannel.connect(r)}),this._gateway.on(ar.PRE_CONNECT_PC,async t=>{const{candidates:e,fingerprint:n}=t;if(this._joinInfo&&e.length>0&&!this._p2pChannel.isPlanB){var r;await this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});const{cert:i,cid:o}=this._joinInfo.apResponse;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(o,"_").concat(i),icePwd:"".concat(o,"_").concat(i)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(r=M("FINGERPRINT"))!==null&&r!==void 0?r:n}]},candidates:e,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}})}_handleGatewaySignalEvents(){this._gateway.signal.on(ue.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(ue.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(ue.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(ue.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(ue.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(ue.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(ue.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(ue.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(ue.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,vt.AUDIO,!0)),this._gateway.signal.on(ue.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,vt.AUDIO,!1)),this._gateway.signal.on(ue.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,vt.VIDEO,!0)),this._gateway.signal.on(ue.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,vt.VIDEO,!1)),this._gateway.signal.on(ue.RECEIVE_METADATA,t=>{const e=Ed(t.metadata);this.safeEmit(de.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(ue.ON_DATA_STREAM,async t=>{var e;if(!t)return;let n=Ed(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&ft(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<du)throw new z(D.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(du));n=await async function(o,a,d){const l=d.subarray(0,du),h=l.slice(8,du),f=(h[0]<<8)+h[1],m=(l[6]<<8)+l[7],T=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:oL,additionalData:new Uint8Array(Yk(f,2))},a,d.subarray(du));return new Uint8Array(T).subarray(0,m)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let r=0;if(t.ordered||t.syncWithAudio){const i=this._p2pChannel.getStats(),o=this.remoteUsers.find(d=>d.uid===t.uid),a=i==null?void 0:i.audioRecv.find(d=>d.ssrc===(o==null?void 0:o._audioSSRC));r=a==null?void 0:a.jitterBufferMs}(r==null||Number.isNaN(r))&&(r=0),g$(Ds(Ds({},t),{},{payload:n}),r,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(ue.ON_CRYPT_ERROR,()=>{uc(()=>{v.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(de.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(ue.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{v.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,ke.TOKEN_EXPIRE),this.safeEmit(de.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(ue.ON_STREAM_FALLBACK_UPDATE,t=>{v.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(de.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(ue.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),v.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(ue.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(ue.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(qt.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case Wt.PUBLISH:{if(!e)return;const i=e.ortc;if(i){var n,r;const o=i.some(l=>{let{stream_type:h}=l;return h===Ue.Audio}),a=i.some(l=>{let{stream_type:h}=l;return h!==Ue.Audio}),d=i.some(l=>{let{stream_type:h}=l;return h===Ue.Screen||h===Ue.ScreenLow});e.state==="offer"&&bt.publish(this._joinInfo.sid,{eventElapse:Dr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:D.TIMEOUT,audio:o,video:a,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:d,audioName:o?(n=i.find(l=>{let{stream_type:h}=l;return h===Ue.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:a?(r=i.find(l=>{let{stream_type:h}=l;return h!==Ue.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0})}break}case Wt.SUBSCRIBE:e&&bt.subscribe(this._joinInfo.sid,{succ:!1,ec:D.TIMEOUT,audio:e.stream_type===vt.AUDIO,video:e.stream_type===vt.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:Dr.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}}),this._gateway.signal.on(ue.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(ue.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;M("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(r=>!Ad(r.string_id||r.stream_id,this.channelName)));const e=[],n=[];for(const r of t.users){let i=this._users.find(f=>f._uintid===r.stream_id);i?i._trust_in_room_=!0:(i=new Sc(r.string_id||r.stream_id,r.stream_id),this._users.push(i),this.getListeners(de.PUBLISHED_USER_LIST).length===0&&(v.debug("[".concat(this._clientId,"] user online"),r.stream_id),this.safeEmit(de.USER_JOINED,i)));const o=rr.Audio&r.stream_type,a=(rr.Video|rr.LwoVideo)&r.stream_type,d=(65280&r.stream_type)!=0,l=o&&i.hasAudio,h=a&&i.hasVideo;a&&(i._trust_video_stream_added_state_=!0,i._video_added_=!0,i._videoSSRC=r.video_ssrc,i._rtxSsrcId=r.video_rtx),o&&(i._trust_audio_stream_added_state_=!0,i._audio_added_=!0,i._audioSSRC=r.audio_ssrc),o&&!l&&this.getListeners(de.PUBLISHED_USER_LIST).length===0&&(v.info("[".concat(this._clientId,"] remote user ").concat(i.uid," published audio")),this.safeEmit(de.USER_PUBLISHED,i,"audio")),a&&!h&&this.getListeners(de.PUBLISHED_USER_LIST).length===0&&(v.info("[".concat(this._clientId,"] remote user ").concat(i.uid," published video")),this.safeEmit(de.USER_PUBLISHED,i,"video")),(o&&!l||a&&!h||d)&&e.push(i),a&&this._p2pChannel.hasPendingRemoteMedia(i,"video")&&n.push({user:i,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(i,"audio")&&n.push({user:i,mediaType:"audio"})}n.length>0&&(v.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(r=>"user: ".concat(r.user.uid,", mediaType: ").concat(r.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(r=>{v.error("[".concat(this._clientId,"] mass resubscribe error"),r.toString())})),this.getListeners(de.PUBLISHED_USER_LIST).length>0?M("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(v.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(r=>r.uid).join(", "))),this.safeEmit(de.PUBLISHED_USER_LIST,e)):v.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(r=>r.uid).join(", ")))}),this._gateway.signal.on(ue.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:e}=t;this._p2pChannel instanceof Pp&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(n=>n.toLowerCase()).filter(n=>{var r;return ft(r=Object.keys(zm)).call(r,n)}))})}_handleP2PEvents(){this._gateway.signal.on(ue.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Ln.PUBLISH,(t,e,n)=>{const{uid:r}=t;t.forEach(i=>{const{kind:o,ssrcs:a,mid:d,isMuted:l}=i;this._handleP2PAddAudioOrVideoStream(o,r,a[0].ssrcId,d);const h=this._users.find(f=>f.uid===r);return h&&this.store.useP2P?this._p2pChannel.mockSubscribe(h,o,a[0].ssrcId,d).then(()=>{e()}).catch(n):e(),this._handleMuteStream(r,o,!!l)})}),this._gateway.signal.on(Ln.CALL,async(t,e,n)=>{if(this.store.useP2P)try{var r;e(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},t))}catch(i){n(i)}}),this._gateway.signal.on(qt.P2P_CONNECTION,async t=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(t)}),this._gateway.signal.on(Ln.UNPUBLISH,async(t,e,n)=>{if(this.store.useP2P){const{unpubMsg:r,uid:i}=t,o=this._users.find(a=>a.uid===i);if(!o)return v.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i)),void e();try{r.forEach(async a=>{let{stream_type:d}=a;const l=d===Ue.Audio?vt.AUDIO:vt.VIDEO;await this._p2pChannel.unsubscribe(o,l),this._handleMuteStream(i,l,!0)}),e()}catch(a){n(a)}}}),this._gateway.signal.on(Ln.CONTROL,async(t,e)=>{const{action:n}=t;switch(n){case _c.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,vt.VIDEO,!0);break;case _c.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,vt.AUDIO,!0);break;case _c.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,vt.VIDEO,!1);break;case _c.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,vt.AUDIO,!1)}}),this._gateway.signal.on(Ln.RESTART_ICE,async(t,e,n)=>{if(this.store.useP2P)try{const{direction:r,iceParameter:i}=t;r!==ei.SEND_ONLY||i?e(await this._p2pChannel.restartICE(r,i)):(this._p2pChannel.handleDisconnect(r),e())}catch(r){n(r)}}),this._gateway.signal.on(Ln.CANDIDATE,t=>{if(this.store.useP2P){const{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n)}}),this._p2pChannel.on(Mt.RequestP2PRestartICE,async(t,e,n)=>{try{const{direction:r}=t;e(await this._gateway.sendExtensionMessage(Ln.RESTART_ICE,t,r===ei.SEND_ONLY))}catch(r){n(r)}}),this._p2pChannel.on(Mt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(Ln.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(Mt.RequestP2PMuteLocal,async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(Ln.CONTROL,t,!0),e()}catch(r){n(r)}}),this._p2pChannel.on(Mt.RequestP2PUnmuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===D.DISCONNECT_P2P?e():n(r)}else e()}),this._p2pChannel.on(Mt.RequestP2PMuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===D.DISCONNECT_P2P?e():n(r)}else e()}),this._p2pChannel.on(Mt.StateChange,(t,e)=>{e===Le.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(Mt.PeerConnectionStateChange,t=>{const e=this._peerConnectionState;t!==e&&(this.safeEmit(de.PEERCONNECTION_STATE_CHANGE,t,e),this._peerConnectionState=t)}),this._p2pChannel.on(Mt.RequestMuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===D.DISCONNECT_P2P?e():n(r)}else e()}),this._p2pChannel.on(Mt.RequestUnmuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===D.DISCONNECT_P2P?e():n(r)}else e()}),this._p2pChannel.on(Mt.RequestRePublish,(t,e,n)=>{this.publish(t,!1).then(e).catch(n)}),this._p2pChannel.on(Mt.RequestRePublishDataChannel,(t,e,n)=>{mt.all(t.map(async r=>{const i=await this._p2pChannel.publishDataChannel([r]);try{i.forEach(o=>{this._uid&&this._gateway.publishDataChannel(this._uid,o,!0)})}catch(o){if(o.code!==D.DISCONNECT_P2P)throw o}})).then(e).catch(n)}),this._p2pChannel.on(Mt.RequestReSubscribe,async(t,e,n)=>{try{for(const{user:r,kind:i}of t)i===vt.VIDEO?await this.subscribe(r,"video"):await this.subscribe(r,"audio");e()}catch(r){n(r)}}),this._p2pChannel.on(Mt.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(Mt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(Mt.MediaReconnectStart,t=>{this.safeEmit(de.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(Mt.MediaReconnectEnd,t=>{this.safeEmit(de.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(Mt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(Mt.RequestRestartICE,async t=>{if(this.store.useP2P)return;const e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;const r=n.value;let i;try{i=await this._gateway.restartICE({iceParameters:r})}catch(a){return void e.throw(a)}const{iceParameters:o}=function(a){const d=a.iceParameters;return{iceParameters:{iceUfrag:d.iceUfrag,icePwd:d.icePwd}}}(i);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(Mt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(Mt.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:n,rtpCapabilities:r}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:i,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:r}),a=z1(i,o);await this._p2pChannel.connect(a),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(Mt.RequestUnpublishForReconnectPC,async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n()}),this._p2pChannel.on(Mt.P2PLost,()=>{this.safeEmit(de.P2P_LOST,this.store.uid)}),this._p2pChannel.on(Mt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(Mt.ConnectionTypeChange,t=>{this.safeEmit(de.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(Mt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(Mt.QueryClientConnectionState,t=>{t(this.connectionState)}),this._p2pChannel.on(Mt.AudioMetadata,t=>{this.safeEmit(de.AUDIO_METADATA,t)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const n=(e={config:t},wa("ContentInspect").create(e));this._inspect=n,this.handleVideoInspectEvents(n);const{appId:r,cname:i,sid:o,token:a,uid:d,cid:l,vid:h}=this._joinInfo;await n.init({appId:r,areaCode:"",cname:i,sid:o,token:a,uid:d,cid:l,vid:h?Number(h):0},qn)}catch(n){throw Array.isArray(n)?n[0]:n}var e}handleVideoInspectEvents(t){t.on(cr.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(de.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===bs.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(de.CONTENT_INSPECT_ERROR,new z(D.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(cr.INSPECT_RESULT,(e,n)=>{var r;if((n==null?void 0:n.code)===D.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return v.debug("Stop inspect content because that has left channel"),this==null||(r=this._inspect)===null||r===void 0||r.close(),void(this._inspect=void 0);this.safeEmit(de.CONTENT_INSPECT_RESULT,e,n)}),t.on(cr.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(Sa(t,"enabled"),t){if(!e)throw new z(D.INVALID_PARAMS,"config is required");if(h2(e),!this._joinInfo)throw new z(D.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{const r=(n={config:e},wa("ImageModeration").create(n));this._moderation=r,this.handleImageModerationEvents(r);const{appId:i,cname:o,sid:a,token:d,uid:l,cid:h,vid:f}=this._joinInfo;await r.init({appId:i,areaCode:"",cname:o,sid:a,token:d,uid:l,cid:h,vid:f?Number(f):0},qn)}}catch(r){throw Array.isArray(r)?r[0]:r}}else{var n;if(!this._moderation)throw new z(D.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(r){throw Array.isArray(r)?r[0]:r}}}handleImageModerationEvents(t){t.on(to.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(de.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===as.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new z(D.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(to.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}setP2PTransport(t){if(function(e){tr(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new z(D.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,v.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return v.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){Sa(t,"enabled"),Fe("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},Ct(gt.prototype,"leave",[p2],Object.getOwnPropertyDescriptor(gt.prototype,"leave"),gt.prototype),Ct(gt.prototype,"publish",[f2],Object.getOwnPropertyDescriptor(gt.prototype,"publish"),gt.prototype),Ct(gt.prototype,"unpublish",[_2],Object.getOwnPropertyDescriptor(gt.prototype,"unpublish"),gt.prototype),Ct(gt.prototype,"subscribe",[m2],Object.getOwnPropertyDescriptor(gt.prototype,"subscribe"),gt.prototype),Ct(gt.prototype,"presubscribe",[E2],Object.getOwnPropertyDescriptor(gt.prototype,"presubscribe"),gt.prototype),Ct(gt.prototype,"massSubscribe",[g2],Object.getOwnPropertyDescriptor(gt.prototype,"massSubscribe"),gt.prototype),Ct(gt.prototype,"unsubscribe",[T2],Object.getOwnPropertyDescriptor(gt.prototype,"unsubscribe"),gt.prototype),Ct(gt.prototype,"massUnsubscribe",[S2],Object.getOwnPropertyDescriptor(gt.prototype,"massUnsubscribe"),gt.prototype),Ct(gt.prototype,"setLowStreamParameter",[v2],Object.getOwnPropertyDescriptor(gt.prototype,"setLowStreamParameter"),gt.prototype),Ct(gt.prototype,"enableDualStream",[y2],Object.getOwnPropertyDescriptor(gt.prototype,"enableDualStream"),gt.prototype),Ct(gt.prototype,"disableDualStream",[R2],Object.getOwnPropertyDescriptor(gt.prototype,"disableDualStream"),gt.prototype),Ct(gt.prototype,"setClientRole",[I2],Object.getOwnPropertyDescriptor(gt.prototype,"setClientRole"),gt.prototype),Ct(gt.prototype,"_setClientRoleOptions",[C2],Object.getOwnPropertyDescriptor(gt.prototype,"_setClientRoleOptions"),gt.prototype),Ct(gt.prototype,"setProxyServer",[A2],Object.getOwnPropertyDescriptor(gt.prototype,"setProxyServer"),gt.prototype),Ct(gt.prototype,"setTurnServer",[w2],Object.getOwnPropertyDescriptor(gt.prototype,"setTurnServer"),gt.prototype),Ct(gt.prototype,"setLicense",[b2],Object.getOwnPropertyDescriptor(gt.prototype,"setLicense"),gt.prototype),Ct(gt.prototype,"startProxyServer",[O2],Object.getOwnPropertyDescriptor(gt.prototype,"startProxyServer"),gt.prototype),Ct(gt.prototype,"stopProxyServer",[N2],Object.getOwnPropertyDescriptor(gt.prototype,"stopProxyServer"),gt.prototype),Ct(gt.prototype,"setLocalAccessPointsV2",[P2],Object.getOwnPropertyDescriptor(gt.prototype,"setLocalAccessPointsV2"),gt.prototype),Ct(gt.prototype,"setLocalAccessPoints",[D2],Object.getOwnPropertyDescriptor(gt.prototype,"setLocalAccessPoints"),gt.prototype),Ct(gt.prototype,"setRemoteDefaultVideoStreamType",[k2],Object.getOwnPropertyDescriptor(gt.prototype,"setRemoteDefaultVideoStreamType"),gt.prototype),Ct(gt.prototype,"setRemoteVideoStreamType",[L2],Object.getOwnPropertyDescriptor(gt.prototype,"setRemoteVideoStreamType"),gt.prototype),Ct(gt.prototype,"setStreamFallbackOption",[M2],Object.getOwnPropertyDescriptor(gt.prototype,"setStreamFallbackOption"),gt.prototype),Ct(gt.prototype,"setEncryptionConfig",[U2],Object.getOwnPropertyDescriptor(gt.prototype,"setEncryptionConfig"),gt.prototype),Ct(gt.prototype,"renewToken",[x2],Object.getOwnPropertyDescriptor(gt.prototype,"renewToken"),gt.prototype),Ct(gt.prototype,"enableAudioVolumeIndicator",[V2],Object.getOwnPropertyDescriptor(gt.prototype,"enableAudioVolumeIndicator"),gt.prototype),Ct(gt.prototype,"startLiveStreaming",[F2],Object.getOwnPropertyDescriptor(gt.prototype,"startLiveStreaming"),gt.prototype),Ct(gt.prototype,"setLiveTranscoding",[B2],Object.getOwnPropertyDescriptor(gt.prototype,"setLiveTranscoding"),gt.prototype),Ct(gt.prototype,"stopLiveStreaming",[j2],Object.getOwnPropertyDescriptor(gt.prototype,"stopLiveStreaming"),gt.prototype),Ct(gt.prototype,"startChannelMediaRelay",[G2],Object.getOwnPropertyDescriptor(gt.prototype,"startChannelMediaRelay"),gt.prototype),Ct(gt.prototype,"updateChannelMediaRelay",[W2],Object.getOwnPropertyDescriptor(gt.prototype,"updateChannelMediaRelay"),gt.prototype),Ct(gt.prototype,"stopChannelMediaRelay",[H2],Object.getOwnPropertyDescriptor(gt.prototype,"stopChannelMediaRelay"),gt.prototype),Ct(gt.prototype,"sendCustomReportMessage",[K2],Object.getOwnPropertyDescriptor(gt.prototype,"sendCustomReportMessage"),gt.prototype),Ct(gt.prototype,"pickSVCLayer",[q2],Object.getOwnPropertyDescriptor(gt.prototype,"pickSVCLayer"),gt.prototype),Ct(gt.prototype,"setRTMConfig",[Y2],Object.getOwnPropertyDescriptor(gt.prototype,"setRTMConfig"),gt.prototype),Ct(gt.prototype,"enableContentInspect",[z2],Object.getOwnPropertyDescriptor(gt.prototype,"enableContentInspect"),gt.prototype),Ct(gt.prototype,"disableContentInspect",[J2],Object.getOwnPropertyDescriptor(gt.prototype,"disableContentInspect"),gt.prototype),Ct(gt.prototype,"setImageModeration",[X2],Object.getOwnPropertyDescriptor(gt.prototype,"setImageModeration"),gt.prototype),Ct(gt.prototype,"setP2PTransport",[Q2],Object.getOwnPropertyDescriptor(gt.prototype,"setP2PTransport"),gt.prototype),Ct(gt.prototype,"getJoinChannelServiceRecords",[$2],Object.getOwnPropertyDescriptor(gt.prototype,"getJoinChannelServiceRecords"),gt.prototype),Ct(gt.prototype,"setPublishAudioFilterEnabled",[Z2],Object.getOwnPropertyDescriptor(gt.prototype,"setPublishAudioFilterEnabled"),gt.prototype),gt);class Lp{constructor(e,n){b(this,"id",0),b(this,"element",void 0),b(this,"peerPair",void 0),b(this,"context",void 0),b(this,"audioPlayerElement",void 0),b(this,"audioTrack",void 0),Lp.count+=1,this.id=Lp.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const e=async(r,i)=>{const o=i==="offer"?await r.createOffer():await r.createAnswer();return await r.setLocalDescription(o),r.iceGatheringState==="complete"?r.localDescription:new mt(a=>{r.onicegatheringstatechange=()=>{r.iceGatheringState==="complete"&&a(r.localDescription)}})},n=async(r,i)=>await r.setRemoteDescription(i);try{const r=await e(this.peerPair[0],"offer");await n(this.peerPair[1],r);const i=await e(this.peerPair[1],"answer");await n(this.peerPair[0],i)}catch(r){throw new z(D.LOCAL_AEC_ERROR,r.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n)}catch(i){throw new z(D.LOCAL_AEC_ERROR,i.toString()).print()}if(!n)throw new z(D.LOCAL_AEC_ERROR,"no dest node when local aec").print();const r=n.stream.getAudioTracks()[0];return this.audioTrack=r,r}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){v.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var ex,BE;b(Lp,"count",0);const M$=window.AudioContext||window.webkitAudioContext,U$=new(ex=xt({report:bt}),Ct((BE=class{constructor(){b(this,"units",[]),b(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return v.debug("the system does not need to process local aec"),-1;this.context||(this.context=new M$);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new Lp(t,this.context),this.units.push(e)),e.startEchoCancellation(),v.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return ve().name!==Oe.SAFARI}}).prototype,"processExternalMediaAEC",[ex],Object.getOwnPropertyDescriptor(BE.prototype,"processExternalMediaAEC"),BE.prototype),BE);function nx(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function rx(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nx(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nx(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const iI=window||document;function ix(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!iI)return;const n=Yn._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);const r=i=>{if(!(i&&i.blockedURI&&(Yn.onSecurityPolicyViolation||Yn.getListeners(Po.SECURITY_POLICY_VIOLATION).length>0)))return;const o=i.blockedURI;M("CSP_DETECTED_HOSTNAME_LIST").some(a=>ft(o).call(o,a))&&(Yn.onSecurityPolicyViolation&&typeof Yn.onSecurityPolicyViolation=="function"&&Yn.onSecurityPolicyViolation(i),Yn.getListeners(Po.SECURITY_POLICY_VIOLATION).length>0&&Yn.safeEmit(Po.SECURITY_POLICY_VIOLATION,i))};n&&iI.removeEventListener("securitypolicyviolation",n),(e||t&&typeof t=="function"||Yn.getListeners(Po.SECURITY_POLICY_VIOLATION).length>0)&&iI.addEventListener("securitypolicyviolation",r),Yn._cspEventHandlerPointer=r}var x$=st,V$=jD,sx=RegExp.prototype,F$=function(t){return t===sx||x$(sx,t)?V$(t):t.flags},Hr=_(F$);function Uu(t){let e=t.length;for(;--e>=0;)t[e]=0}const sI=256,ox=286,Mp=30,Up=15,oI=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),jE=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),B$=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),ax=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Na=new Array(576);Uu(Na);const xp=new Array(60);Uu(xp);const Vp=new Array(512);Uu(Vp);const Fp=new Array(256);Uu(Fp);const aI=new Array(29);Uu(aI);const GE=new Array(Mp);function cI(t,e,n,r,i){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=t&&t.length}let cx,dx,lx;function dI(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Uu(GE);const ux=t=>t<256?Vp[t]:Vp[256+(t>>>7)],Bp=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},Xi=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,Bp(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},Uo=(t,e,n)=>{Xi(t,n[2*e],n[2*e+1])},hx=(t,e)=>{let n=0;do n|=1&t,t>>>=1,n<<=1;while(--e>0);return n>>>1},px=(t,e,n)=>{const r=new Array(16);let i,o,a=0;for(i=1;i<=Up;i++)a=a+n[i-1]<<1,r[i]=a;for(o=0;o<=e;o++){let d=t[2*o+1];d!==0&&(t[2*o]=hx(r[d]++,d))}},fx=t=>{let e;for(e=0;e<ox;e++)t.dyn_ltree[2*e]=0;for(e=0;e<Mp;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},_x=t=>{t.bi_valid>8?Bp(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},mx=(t,e,n,r)=>{const i=2*e,o=2*n;return t[i]<t[o]||t[i]===t[o]&&r[e]<=r[n]},lI=(t,e,n)=>{const r=t.heap[n];let i=n<<1;for(;i<=t.heap_len&&(i<t.heap_len&&mx(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!mx(e,r,t.heap[i],t.depth));)t.heap[n]=t.heap[i],n=i,i<<=1;t.heap[n]=r},Ex=(t,e,n)=>{let r,i,o,a,d=0;if(t.sym_next!==0)do r=255&t.pending_buf[t.sym_buf+d++],r+=(255&t.pending_buf[t.sym_buf+d++])<<8,i=t.pending_buf[t.sym_buf+d++],r===0?Uo(t,i,e):(o=Fp[i],Uo(t,o+sI+1,e),a=oI[o],a!==0&&(i-=aI[o],Xi(t,i,a)),r--,o=ux(r),Uo(t,o,n),a=jE[o],a!==0&&(r-=GE[o],Xi(t,r,a)));while(d<t.sym_next);Uo(t,256,e)},uI=(t,e)=>{const n=e.dyn_tree,r=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.elems;let a,d,l,h=-1;for(t.heap_len=0,t.heap_max=573,a=0;a<o;a++)n[2*a]!==0?(t.heap[++t.heap_len]=h=a,t.depth[a]=0):n[2*a+1]=0;for(;t.heap_len<2;)l=t.heap[++t.heap_len]=h<2?++h:0,n[2*l]=1,t.depth[l]=0,t.opt_len--,i&&(t.static_len-=r[2*l+1]);for(e.max_code=h,a=t.heap_len>>1;a>=1;a--)lI(t,n,a);l=o;do a=t.heap[1],t.heap[1]=t.heap[t.heap_len--],lI(t,n,1),d=t.heap[1],t.heap[--t.heap_max]=a,t.heap[--t.heap_max]=d,n[2*l]=n[2*a]+n[2*d],t.depth[l]=(t.depth[a]>=t.depth[d]?t.depth[a]:t.depth[d])+1,n[2*a+1]=n[2*d+1]=l,t.heap[1]=l++,lI(t,n,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((f,m)=>{const T=m.dyn_tree,S=m.max_code,w=m.stat_desc.static_tree,I=m.stat_desc.has_stree,C=m.stat_desc.extra_bits,N=m.stat_desc.extra_base,P=m.stat_desc.max_length;let x,W,H,j,$,ct,Et=0;for(j=0;j<=Up;j++)f.bl_count[j]=0;for(T[2*f.heap[f.heap_max]+1]=0,x=f.heap_max+1;x<573;x++)W=f.heap[x],j=T[2*T[2*W+1]+1]+1,j>P&&(j=P,Et++),T[2*W+1]=j,W>S||(f.bl_count[j]++,$=0,W>=N&&($=C[W-N]),ct=T[2*W],f.opt_len+=ct*(j+$),I&&(f.static_len+=ct*(w[2*W+1]+$)));if(Et!==0){do{for(j=P-1;f.bl_count[j]===0;)j--;f.bl_count[j]--,f.bl_count[j+1]+=2,f.bl_count[P]--,Et-=2}while(Et>0);for(j=P;j!==0;j--)for(W=f.bl_count[j];W!==0;)H=f.heap[--x],H>S||(T[2*H+1]!==j&&(f.opt_len+=(j-T[2*H+1])*T[2*H],T[2*H+1]=j),W--)}})(t,e),px(n,h,t.bl_count)},gx=(t,e,n)=>{let r,i,o=-1,a=e[1],d=0,l=7,h=4;for(a===0&&(l=138,h=3),e[2*(n+1)+1]=65535,r=0;r<=n;r++)i=a,a=e[2*(r+1)+1],++d<l&&i===a||(d<h?t.bl_tree[2*i]+=d:i!==0?(i!==o&&t.bl_tree[2*i]++,t.bl_tree[32]++):d<=10?t.bl_tree[34]++:t.bl_tree[36]++,d=0,o=i,a===0?(l=138,h=3):i===a?(l=6,h=3):(l=7,h=4))},Tx=(t,e,n)=>{let r,i,o=-1,a=e[1],d=0,l=7,h=4;for(a===0&&(l=138,h=3),r=0;r<=n;r++)if(i=a,a=e[2*(r+1)+1],!(++d<l&&i===a)){if(d<h)do Uo(t,i,t.bl_tree);while(--d!=0);else i!==0?(i!==o&&(Uo(t,i,t.bl_tree),d--),Uo(t,16,t.bl_tree),Xi(t,d-3,2)):d<=10?(Uo(t,17,t.bl_tree),Xi(t,d-3,3)):(Uo(t,18,t.bl_tree),Xi(t,d-11,7));d=0,o=i,a===0?(l=138,h=3):i===a?(l=6,h=3):(l=7,h=4)}};let Sx=!1;const vx=(t,e,n,r)=>{Xi(t,0+(r?1:0),3),_x(t),Bp(t,n),Bp(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var j$=t=>{Sx||((()=>{let e,n,r,i,o;const a=new Array(16);for(r=0,i=0;i<28;i++)for(aI[i]=r,e=0;e<1<<oI[i];e++)Fp[r++]=i;for(Fp[r-1]=i,o=0,i=0;i<16;i++)for(GE[i]=o,e=0;e<1<<jE[i];e++)Vp[o++]=i;for(o>>=7;i<Mp;i++)for(GE[i]=o<<7,e=0;e<1<<jE[i]-7;e++)Vp[256+o++]=i;for(n=0;n<=Up;n++)a[n]=0;for(e=0;e<=143;)Na[2*e+1]=8,e++,a[8]++;for(;e<=255;)Na[2*e+1]=9,e++,a[9]++;for(;e<=279;)Na[2*e+1]=7,e++,a[7]++;for(;e<=287;)Na[2*e+1]=8,e++,a[8]++;for(px(Na,287,a),e=0;e<Mp;e++)xp[2*e+1]=5,xp[2*e]=hx(e,5);cx=new cI(Na,oI,257,ox,Up),dx=new cI(xp,jE,0,Mp,Up),lx=new cI(new Array(0),B$,0,19,7)})(),Sx=!0),t.l_desc=new dI(t.dyn_ltree,cx),t.d_desc=new dI(t.dyn_dtree,dx),t.bl_desc=new dI(t.bl_tree,lx),t.bi_buf=0,t.bi_valid=0,fx(t)},G$=(t,e,n,r)=>{let i,o,a=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(d=>{let l,h=4093624447;for(l=0;l<=31;l++,h>>>=1)if(1&h&&d.dyn_ltree[2*l]!==0)return 0;if(d.dyn_ltree[18]!==0||d.dyn_ltree[20]!==0||d.dyn_ltree[26]!==0)return 1;for(l=32;l<sI;l++)if(d.dyn_ltree[2*l]!==0)return 1;return 0})(t)),uI(t,t.l_desc),uI(t,t.d_desc),a=(d=>{let l;for(gx(d,d.dyn_ltree,d.l_desc.max_code),gx(d,d.dyn_dtree,d.d_desc.max_code),uI(d,d.bl_desc),l=18;l>=3&&d.bl_tree[2*ax[l]+1]===0;l--);return d.opt_len+=3*(l+1)+5+5+4,l})(t),i=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=i&&(i=o)):i=o=n+5,n+4<=i&&e!==-1?vx(t,e,n,r):t.strategy===4||o===i?(Xi(t,2+(r?1:0),3),Ex(t,Na,xp)):(Xi(t,4+(r?1:0),3),((d,l,h,f)=>{let m;for(Xi(d,l-257,5),Xi(d,h-1,5),Xi(d,f-4,4),m=0;m<f;m++)Xi(d,d.bl_tree[2*ax[m]+1],3);Tx(d,d.dyn_ltree,l-1),Tx(d,d.dyn_dtree,h-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,a+1),Ex(t,t.dyn_ltree,t.dyn_dtree)),fx(t),r&&_x(t)},W$=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,e===0?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(Fp[n]+sI+1)]++,t.dyn_dtree[2*ux(e)]++),t.sym_next===t.sym_end),H$=t=>{Xi(t,2,3),Uo(t,256,Na),(e=>{e.bi_valid===16?(Bp(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},K$={_tr_init:j$,_tr_stored_block:vx,_tr_flush_block:G$,_tr_tally:W$,_tr_align:H$},jp=(t,e,n,r)=>{let i=65535&t|0,o=t>>>16&65535|0,a=0;for(;n!==0;){a=n>2e3?2e3:n,n-=a;do i=i+e[r++]|0,o=o+i|0;while(--a);i%=65521,o%=65521}return i|o<<16|0};const q$=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var ri=(t,e,n,r)=>{const i=q$,o=r+n;t^=-1;for(let a=r;a<o;a++)t=t>>>8^i[255&(t^e[a])];return-1^t},Md={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},WE={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Y$,_tr_stored_block:hI,_tr_flush_block:z$,_tr_tally:Ic,_tr_align:J$}=K$,{Z_NO_FLUSH:Cc,Z_PARTIAL_FLUSH:X$,Z_FULL_FLUSH:Q$,Z_FINISH:ks,Z_BLOCK:yx,Z_OK:hi,Z_STREAM_END:Rx,Z_STREAM_ERROR:xo,Z_DATA_ERROR:$$,Z_BUF_ERROR:pI,Z_DEFAULT_COMPRESSION:Z$,Z_FILTERED:tZ,Z_HUFFMAN_ONLY:HE,Z_RLE:eZ,Z_FIXED:nZ,Z_DEFAULT_STRATEGY:rZ,Z_UNKNOWN:iZ,Z_DEFLATED:KE}=WE,fI=286,sZ=30,oZ=19,aZ=2*fI+1,cZ=15,Ud=258,Vo=262,xu=42,xd=113,Gp=666,Vd=(t,e)=>(t.msg=Md[e],e),Ix=t=>2*t-(t>4?9:0),Ac=t=>{let e=t.length;for(;--e>=0;)t[e]=0},dZ=t=>{let e,n,r,i=t.w_size;e=t.hash_size,r=e;do n=t.head[--r],t.head[r]=n>=i?n-i:0;while(--e);e=i,r=e;do n=t.prev[--r],t.prev[r]=n>=i?n-i:0;while(--e)};let wc=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const ds=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),n!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0))},ls=(t,e)=>{z$(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,ds(t.strm)},Nn=(t,e)=>{t.pending_buf[t.pending++]=e},Wp=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},_I=(t,e,n,r)=>{let i=t.avail_in;return i>r&&(i=r),i===0?0:(t.avail_in-=i,e.set(t.input.subarray(t.next_in,t.next_in+i),n),t.state.wrap===1?t.adler=jp(t.adler,e,i,n):t.state.wrap===2&&(t.adler=ri(t.adler,e,i,n)),t.next_in+=i,t.total_in+=i,i)},Cx=(t,e)=>{let n,r,i=t.max_chain_length,o=t.strstart,a=t.prev_length,d=t.nice_match;const l=t.strstart>t.w_size-Vo?t.strstart-(t.w_size-Vo):0,h=t.window,f=t.w_mask,m=t.prev,T=t.strstart+Ud;let S=h[o+a-1],w=h[o+a];t.prev_length>=t.good_match&&(i>>=2),d>t.lookahead&&(d=t.lookahead);do if(n=e,h[n+a]===w&&h[n+a-1]===S&&h[n]===h[o]&&h[++n]===h[o+1]){o+=2,n++;do;while(h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&h[++o]===h[++n]&&o<T);if(r=Ud-(T-o),o=T-Ud,r>a){if(t.match_start=e,a=r,r>=d)break;S=h[o+a-1],w=h[o+a]}}while((e=m[e&f])>l&&--i!=0);return a<=t.lookahead?a:t.lookahead},Vu=t=>{const e=t.w_size;let n,r,i;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-Vo)&&(t.window.set(t.window.subarray(e,e+e-r),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),dZ(t),r+=e),t.strm.avail_in===0)break;if(n=_I(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=n,t.lookahead+t.insert>=3)for(i=t.strstart-t.insert,t.ins_h=t.window[i],t.ins_h=wc(t,t.ins_h,t.window[i+1]);t.insert&&(t.ins_h=wc(t,t.ins_h,t.window[i+3-1]),t.prev[i&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=i,i++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<Vo&&t.strm.avail_in!==0)},Ax=(t,e)=>{let n,r,i,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,a=0,d=t.strm.avail_in;do{if(n=65535,i=t.bi_valid+42>>3,t.strm.avail_out<i||(i=t.strm.avail_out-i,r=t.strstart-t.block_start,n>r+t.strm.avail_in&&(n=r+t.strm.avail_in),n>i&&(n=i),n<o&&(n===0&&e!==ks||e===Cc||n!==r+t.strm.avail_in)))break;a=e===ks&&n===r+t.strm.avail_in?1:0,hI(t,0,0,a),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,ds(t.strm),r&&(r>n&&(r=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+r),t.strm.next_out),t.strm.next_out+=r,t.strm.avail_out-=r,t.strm.total_out+=r,t.block_start+=r,n-=r),n&&(_I(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(a===0);return d-=t.strm.avail_in,d&&(d>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=d&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-d,t.strm.next_in),t.strstart),t.strstart+=d,t.insert+=d>t.w_size-t.insert?t.w_size-t.insert:d),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),a?4:e!==Cc&&e!==ks&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(i=t.window_size-t.strstart,t.strm.avail_in>i&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,i+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),i>t.strm.avail_in&&(i=t.strm.avail_in),i&&(_I(t.strm,t.window,t.strstart,i),t.strstart+=i,t.insert+=i>t.w_size-t.insert?t.w_size-t.insert:i),t.high_water<t.strstart&&(t.high_water=t.strstart),i=t.bi_valid+42>>3,i=t.pending_buf_size-i>65535?65535:t.pending_buf_size-i,o=i>t.w_size?t.w_size:i,r=t.strstart-t.block_start,(r>=o||(r||e===ks)&&e!==Cc&&t.strm.avail_in===0&&r<=i)&&(n=r>i?i:r,a=e===ks&&t.strm.avail_in===0&&n===r?1:0,hI(t,t.block_start,n,a),t.block_start+=n,ds(t.strm)),a?3:1)},mI=(t,e)=>{let n,r;for(;;){if(t.lookahead<Vo){if(Vu(t),t.lookahead<Vo&&e===Cc)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=wc(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),n!==0&&t.strstart-n<=t.w_size-Vo&&(t.match_length=Cx(t,n)),t.match_length>=3)if(r=Ic(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=wc(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=wc(t,t.ins_h,t.window[t.strstart+1]);else r=Ic(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(ls(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===ks?(ls(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(ls(t,!1),t.strm.avail_out===0)?1:2},Fu=(t,e)=>{let n,r,i;for(;;){if(t.lookahead<Vo){if(Vu(t),t.lookahead<Vo&&e===Cc)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=wc(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,n!==0&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-Vo&&(t.match_length=Cx(t,n),t.match_length<=5&&(t.strategy===tZ||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-3,r=Ic(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=i&&(t.ins_h=wc(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(ls(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(r=Ic(t,0,t.window[t.strstart-1]),r&&ls(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=Ic(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===ks?(ls(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(ls(t,!1),t.strm.avail_out===0)?1:2};function Fo(t,e,n,r,i){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=r,this.func=i}const Hp=[new Fo(0,0,0,0,Ax),new Fo(4,4,8,4,mI),new Fo(4,5,16,8,mI),new Fo(4,6,32,32,mI),new Fo(4,4,16,16,Fu),new Fo(8,16,32,32,Fu),new Fo(8,16,128,128,Fu),new Fo(8,32,128,256,Fu),new Fo(32,128,258,1024,Fu),new Fo(32,258,258,4096,Fu)];function lZ(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=KE,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*aZ),this.dyn_dtree=new Uint16Array(2*(2*sZ+1)),this.bl_tree=new Uint16Array(2*(2*oZ+1)),Ac(this.dyn_ltree),Ac(this.dyn_dtree),Ac(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(cZ+1),this.heap=new Uint16Array(2*fI+1),Ac(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*fI+1),Ac(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Kp=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==xu&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==xd&&e.status!==Gp?1:0},wx=t=>{if(Kp(t))return Vd(t,xo);t.total_in=t.total_out=0,t.data_type=iZ;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?xu:xd,t.adler=e.wrap===2?0:1,e.last_flush=-2,Y$(e),hi},bx=t=>{const e=wx(t);return e===hi&&(n=>{n.window_size=2*n.w_size,Ac(n.head),n.max_lazy_match=Hp[n.level].max_lazy,n.good_match=Hp[n.level].good_length,n.nice_match=Hp[n.level].nice_length,n.max_chain_length=Hp[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(t.state),e},Ox=(t,e,n,r,i,o)=>{if(!t)return xo;let a=1;if(e===Z$&&(e=6),r<0?(a=0,r=-r):r>15&&(a=2,r-=16),i<1||i>9||n!==KE||r<8||r>15||e<0||e>9||o<0||o>nZ||r===8&&a!==1)return Vd(t,xo);r===8&&(r=9);const d=new lZ;return t.state=d,d.strm=t,d.status=xu,d.wrap=a,d.gzhead=null,d.w_bits=r,d.w_size=1<<d.w_bits,d.w_mask=d.w_size-1,d.hash_bits=i+7,d.hash_size=1<<d.hash_bits,d.hash_mask=d.hash_size-1,d.hash_shift=~~((d.hash_bits+3-1)/3),d.window=new Uint8Array(2*d.w_size),d.head=new Uint16Array(d.hash_size),d.prev=new Uint16Array(d.w_size),d.lit_bufsize=1<<i+6,d.pending_buf_size=4*d.lit_bufsize,d.pending_buf=new Uint8Array(d.pending_buf_size),d.sym_buf=d.lit_bufsize,d.sym_end=3*(d.lit_bufsize-1),d.level=e,d.strategy=o,d.method=n,bx(t)};var uZ=(t,e)=>{if(Kp(t)||e>yx||e<0)return t?Vd(t,xo):xo;const n=t.state;if(!t.output||t.avail_in!==0&&!t.input||n.status===Gp&&e!==ks)return Vd(t,t.avail_out===0?pI:xo);const r=n.last_flush;if(n.last_flush=e,n.pending!==0){if(ds(t),t.avail_out===0)return n.last_flush=-1,hi}else if(t.avail_in===0&&Ix(e)<=Ix(r)&&e!==ks)return Vd(t,pI);if(n.status===Gp&&t.avail_in!==0)return Vd(t,pI);if(n.status===xu&&n.wrap===0&&(n.status=xd),n.status===xu){let i=KE+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=HE||n.level<2?0:n.level<6?1:n.level===6?2:3,i|=o<<6,n.strstart!==0&&(i|=32),i+=31-i%31,Wp(n,i),n.strstart!==0&&(Wp(n,t.adler>>>16),Wp(n,65535&t.adler)),t.adler=1,n.status=xd,ds(t),n.pending!==0)return n.last_flush=-1,hi}if(n.status===57){if(t.adler=0,Nn(n,31),Nn(n,139),Nn(n,8),n.gzhead)Nn(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Nn(n,255&n.gzhead.time),Nn(n,n.gzhead.time>>8&255),Nn(n,n.gzhead.time>>16&255),Nn(n,n.gzhead.time>>24&255),Nn(n,n.level===9?2:n.strategy>=HE||n.level<2?4:0),Nn(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Nn(n,255&n.gzhead.extra.length),Nn(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=ri(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Nn(n,0),Nn(n,0),Nn(n,0),Nn(n,0),Nn(n,0),Nn(n,n.level===9?2:n.strategy>=HE||n.level<2?4:0),Nn(n,3),n.status=xd,ds(t),n.pending!==0)return n.last_flush=-1,hi}if(n.status===69){if(n.gzhead.extra){let i=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let d=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+d),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>i&&(t.adler=ri(t.adler,n.pending_buf,n.pending-i,i)),n.gzindex+=d,ds(t),n.pending!==0)return n.last_flush=-1,hi;i=0,o-=d}let a=new Uint8Array(n.gzhead.extra);n.pending_buf.set(a.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>i&&(t.adler=ri(t.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=ri(t.adler,n.pending_buf,n.pending-o,o)),ds(t),n.pending!==0)return n.last_flush=-1,hi;o=0}i=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Nn(n,i)}while(i!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=ri(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=ri(t.adler,n.pending_buf,n.pending-o,o)),ds(t),n.pending!==0)return n.last_flush=-1,hi;o=0}i=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Nn(n,i)}while(i!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=ri(t.adler,n.pending_buf,n.pending-o,o))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(ds(t),n.pending!==0))return n.last_flush=-1,hi;Nn(n,255&t.adler),Nn(n,t.adler>>8&255),t.adler=0}if(n.status=xd,ds(t),n.pending!==0)return n.last_flush=-1,hi}if(t.avail_in!==0||n.lookahead!==0||e!==Cc&&n.status!==Gp){let i=n.level===0?Ax(n,e):n.strategy===HE?((o,a)=>{let d;for(;;){if(o.lookahead===0&&(Vu(o),o.lookahead===0)){if(a===Cc)return 1;break}if(o.match_length=0,d=Ic(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,d&&(ls(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,a===ks?(ls(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(ls(o,!1),o.strm.avail_out===0)?1:2})(n,e):n.strategy===eZ?((o,a)=>{let d,l,h,f;const m=o.window;for(;;){if(o.lookahead<=Ud){if(Vu(o),o.lookahead<=Ud&&a===Cc)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(h=o.strstart-1,l=m[h],l===m[++h]&&l===m[++h]&&l===m[++h])){f=o.strstart+Ud;do;while(l===m[++h]&&l===m[++h]&&l===m[++h]&&l===m[++h]&&l===m[++h]&&l===m[++h]&&l===m[++h]&&l===m[++h]&&h<f);o.match_length=Ud-(f-h),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(d=Ic(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(d=Ic(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),d&&(ls(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,a===ks?(ls(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(ls(o,!1),o.strm.avail_out===0)?1:2})(n,e):Hp[n.level].func(n,e);if(i!==3&&i!==4||(n.status=Gp),i===1||i===3)return t.avail_out===0&&(n.last_flush=-1),hi;if(i===2&&(e===X$?J$(n):e!==yx&&(hI(n,0,0,!1),e===Q$&&(Ac(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),ds(t),t.avail_out===0))return n.last_flush=-1,hi}return e!==ks?hi:n.wrap<=0?Rx:(n.wrap===2?(Nn(n,255&t.adler),Nn(n,t.adler>>8&255),Nn(n,t.adler>>16&255),Nn(n,t.adler>>24&255),Nn(n,255&t.total_in),Nn(n,t.total_in>>8&255),Nn(n,t.total_in>>16&255),Nn(n,t.total_in>>24&255)):(Wp(n,t.adler>>>16),Wp(n,65535&t.adler)),ds(t),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?hi:Rx)},hZ=(t,e)=>{let n=e.length;if(Kp(t))return xo;const r=t.state,i=r.wrap;if(i===2||i===1&&r.status!==xu||r.lookahead)return xo;if(i===1&&(t.adler=jp(t.adler,e,n,0)),r.wrap=0,n>=r.w_size){i===0&&(Ac(r.head),r.strstart=0,r.block_start=0,r.insert=0);let l=new Uint8Array(r.w_size);l.set(e.subarray(n-r.w_size,n),0),e=l,n=r.w_size}const o=t.avail_in,a=t.next_in,d=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Vu(r);r.lookahead>=3;){let l=r.strstart,h=r.lookahead-2;do r.ins_h=wc(r,r.ins_h,r.window[l+3-1]),r.prev[l&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=l,l++;while(--h);r.strstart=l,r.lookahead=2,Vu(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,t.next_in=a,t.input=d,t.avail_in=o,r.wrap=i,hi},qp={deflateInit:(t,e)=>Ox(t,e,KE,15,8,rZ),deflateInit2:Ox,deflateReset:bx,deflateResetKeep:wx,deflateSetHeader:(t,e)=>Kp(t)||t.state.wrap!==2?xo:(t.state.gzhead=e,hi),deflate:uZ,deflateEnd:t=>{if(Kp(t))return xo;const e=t.state.status;return t.state=null,e===xd?Vd(t,$$):hi},deflateSetDictionary:hZ,deflateInfo:"pako deflate (from Nodeca project)"};const pZ=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var qE={assign:function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const r in n)pZ(n,r)&&(t[r]=n[r])}}return t},flattenChunks:t=>{let e=0;for(let r=0,i=t.length;r<i;r++)e+=t[r].length;const n=new Uint8Array(e);for(let r=0,i=0,o=t.length;r<o;r++){let a=t[r];n.set(a,i),i+=a.length}return n}};let Nx=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Nx=!1}const Yp=new Uint8Array(256);for(let t=0;t<256;t++)Yp[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Yp[254]=Yp[254]=1;var zp={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,n,r,i,o,a=t.length,d=0;for(i=0;i<a;i++)n=t.charCodeAt(i),(64512&n)==55296&&i+1<a&&(r=t.charCodeAt(i+1),(64512&r)==56320&&(n=65536+(n-55296<<10)+(r-56320),i++)),d+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(d),o=0,i=0;o<d;i++)n=t.charCodeAt(i),(64512&n)==55296&&i+1<a&&(r=t.charCodeAt(i+1),(64512&r)==56320&&(n=65536+(n-55296<<10)+(r-56320),i++)),n<128?e[o++]=n:n<2048?(e[o++]=192|n>>>6,e[o++]=128|63&n):n<65536?(e[o++]=224|n>>>12,e[o++]=128|n>>>6&63,e[o++]=128|63&n):(e[o++]=240|n>>>18,e[o++]=128|n>>>12&63,e[o++]=128|n>>>6&63,e[o++]=128|63&n);return e},buf2string:(t,e)=>{const n=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let r,i;const o=new Array(2*n);for(i=0,r=0;r<n;){let a=t[r++];if(a<128){o[i++]=a;continue}let d=Yp[a];if(d>4)o[i++]=65533,r+=d-1;else{for(a&=d===2?31:d===3?15:7;d>1&&r<n;)a=a<<6|63&t[r++],d--;d>1?o[i++]=65533:a<65536?o[i++]=a:(a-=65536,o[i++]=55296|a>>10&1023,o[i++]=56320|1023&a)}}return((a,d)=>{if(d<65534&&a.subarray&&Nx)return String.fromCharCode.apply(null,a.length===d?a:a.subarray(0,d));let l="";for(let h=0;h<d;h++)l+=String.fromCharCode(a[h]);return l})(o,i)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+Yp[t[n]]>e?n:e}},Px=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Dx=Object.prototype.toString,{Z_NO_FLUSH:fZ,Z_SYNC_FLUSH:_Z,Z_FULL_FLUSH:mZ,Z_FINISH:EZ,Z_OK:YE,Z_STREAM_END:gZ,Z_DEFAULT_COMPRESSION:TZ,Z_DEFAULT_STRATEGY:SZ,Z_DEFLATED:vZ}=WE;function zE(t){this.options=qE.assign({level:TZ,method:vZ,chunkSize:16384,windowBits:15,memLevel:8,strategy:SZ},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Px,this.strm.avail_out=0;let n=qp.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==YE)throw new Error(Md[n]);if(e.header&&qp.deflateSetHeader(this.strm,e.header),e.dictionary){let r;if(r=typeof e.dictionary=="string"?zp.string2buf(e.dictionary):Dx.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=qp.deflateSetDictionary(this.strm,r),n!==YE)throw new Error(Md[n]);this._dict_set=!0}}function yZ(t,e){const n=new zE(e);if(n.push(t,!0),n.err)throw n.msg||Md[n.err];return n.result}zE.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize;let i,o;if(this.ended)return!1;for(o=e===~~e?e:e===!0?EZ:fZ,typeof t=="string"?n.input=zp.string2buf(t):Dx.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),(o===_Z||o===mZ)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(i=qp.deflate(n,o),i===gZ)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=qp.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===YE;if(n.avail_out!==0){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},zE.prototype.onData=function(t){this.chunks.push(t)},zE.prototype.onEnd=function(t){t===YE&&(this.result=qE.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var RZ={deflate:yZ};const JE=16209;var IZ=function(t,e){let n,r,i,o,a,d,l,h,f,m,T,S,w,I,C,N,P,x,W,H,j,$,ct,Et;const Tt=t.state;n=t.next_in,ct=t.input,r=n+(t.avail_in-5),i=t.next_out,Et=t.output,o=i-(e-t.avail_out),a=i+(t.avail_out-257),d=Tt.dmax,l=Tt.wsize,h=Tt.whave,f=Tt.wnext,m=Tt.window,T=Tt.hold,S=Tt.bits,w=Tt.lencode,I=Tt.distcode,C=(1<<Tt.lenbits)-1,N=(1<<Tt.distbits)-1;t:do{S<15&&(T+=ct[n++]<<S,S+=8,T+=ct[n++]<<S,S+=8),P=w[T&C];e:for(;;){if(x=P>>>24,T>>>=x,S-=x,x=P>>>16&255,x===0)Et[i++]=65535&P;else{if(!(16&x)){if((64&x)==0){P=w[(65535&P)+(T&(1<<x)-1)];continue e}if(32&x){Tt.mode=16191;break t}t.msg="invalid literal/length code",Tt.mode=JE;break t}W=65535&P,x&=15,x&&(S<x&&(T+=ct[n++]<<S,S+=8),W+=T&(1<<x)-1,T>>>=x,S-=x),S<15&&(T+=ct[n++]<<S,S+=8,T+=ct[n++]<<S,S+=8),P=I[T&N];n:for(;;){if(x=P>>>24,T>>>=x,S-=x,x=P>>>16&255,!(16&x)){if((64&x)==0){P=I[(65535&P)+(T&(1<<x)-1)];continue n}t.msg="invalid distance code",Tt.mode=JE;break t}if(H=65535&P,x&=15,S<x&&(T+=ct[n++]<<S,S+=8,S<x&&(T+=ct[n++]<<S,S+=8)),H+=T&(1<<x)-1,H>d){t.msg="invalid distance too far back",Tt.mode=JE;break t}if(T>>>=x,S-=x,x=i-o,H>x){if(x=H-x,x>h&&Tt.sane){t.msg="invalid distance too far back",Tt.mode=JE;break t}if(j=0,$=m,f===0){if(j+=l-x,x<W){W-=x;do Et[i++]=m[j++];while(--x);j=i-H,$=Et}}else if(f<x){if(j+=l+f-x,x-=f,x<W){W-=x;do Et[i++]=m[j++];while(--x);if(j=0,f<W){x=f,W-=x;do Et[i++]=m[j++];while(--x);j=i-H,$=Et}}}else if(j+=f-x,x<W){W-=x;do Et[i++]=m[j++];while(--x);j=i-H,$=Et}for(;W>2;)Et[i++]=$[j++],Et[i++]=$[j++],Et[i++]=$[j++],W-=3;W&&(Et[i++]=$[j++],W>1&&(Et[i++]=$[j++]))}else{j=i-H;do Et[i++]=Et[j++],Et[i++]=Et[j++],Et[i++]=Et[j++],W-=3;while(W>2);W&&(Et[i++]=Et[j++],W>1&&(Et[i++]=Et[j++]))}break}}break}}while(n<r&&i<a);W=S>>3,n-=W,S-=W<<3,T&=(1<<S)-1,t.next_in=n,t.next_out=i,t.avail_in=n<r?r-n+5:5-(n-r),t.avail_out=i<a?a-i+257:257-(i-a),Tt.hold=T,Tt.bits=S};const XE=15,CZ=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),AZ=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),wZ=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),bZ=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Jp=(t,e,n,r,i,o,a,d)=>{const l=d.bits;let h,f,m,T,S,w,I=0,C=0,N=0,P=0,x=0,W=0,H=0,j=0,$=0,ct=0,Et=null;const Tt=new Uint16Array(16),he=new Uint16Array(16);let pe,Xe,Mn,Cn=null;for(I=0;I<=XE;I++)Tt[I]=0;for(C=0;C<r;C++)Tt[e[n+C]]++;for(x=l,P=XE;P>=1&&Tt[P]===0;P--);if(x>P&&(x=P),P===0)return i[o++]=20971520,i[o++]=20971520,d.bits=1,0;for(N=1;N<P&&Tt[N]===0;N++);for(x<N&&(x=N),j=1,I=1;I<=XE;I++)if(j<<=1,j-=Tt[I],j<0)return-1;if(j>0&&(t===0||P!==1))return-1;for(he[1]=0,I=1;I<XE;I++)he[I+1]=he[I]+Tt[I];for(C=0;C<r;C++)e[n+C]!==0&&(a[he[e[n+C]]++]=C);if(t===0?(Et=Cn=a,w=20):t===1?(Et=CZ,Cn=AZ,w=257):(Et=wZ,Cn=bZ,w=0),ct=0,C=0,I=N,S=o,W=x,H=0,m=-1,$=1<<x,T=$-1,t===1&&$>852||t===2&&$>592)return 1;for(;;){pe=I-H,a[C]+1<w?(Xe=0,Mn=a[C]):a[C]>=w?(Xe=Cn[a[C]-w],Mn=Et[a[C]-w]):(Xe=96,Mn=0),h=1<<I-H,f=1<<W,N=f;do f-=h,i[S+(ct>>H)+f]=pe<<24|Xe<<16|Mn|0;while(f!==0);for(h=1<<I-1;ct&h;)h>>=1;if(h!==0?(ct&=h-1,ct+=h):ct=0,C++,--Tt[I]==0){if(I===P)break;I=e[n+a[C]]}if(I>x&&(ct&T)!==m){for(H===0&&(H=x),S+=N,W=I-H,j=1<<W;W+H<P&&(j-=Tt[W+H],!(j<=0));)W++,j<<=1;if($+=1<<W,t===1&&$>852||t===2&&$>592)return 1;m=ct&T,i[m]=x<<24|W<<16|S-o|0}}return ct!==0&&(i[S+ct]=I-H<<24|64<<16|0),d.bits=x,0};const{Z_FINISH:kx,Z_BLOCK:OZ,Z_TREES:QE,Z_OK:Fd,Z_STREAM_END:NZ,Z_NEED_DICT:PZ,Z_STREAM_ERROR:Ls,Z_DATA_ERROR:Lx,Z_MEM_ERROR:Mx,Z_BUF_ERROR:DZ,Z_DEFLATED:Ux}=WE,$E=16180,ZE=16190,Pa=16191,EI=16192,gI=16194,tg=16199,eg=16200,TI=16206,dr=16209,xx=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function kZ(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Bd=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<$E||e.mode>16211?1:0},Vx=t=>{if(Bd(t))return Ls;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=$E,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Fd},Fx=t=>{if(Bd(t))return Ls;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,Vx(t)},Bx=(t,e)=>{let n;if(Bd(t))return Ls;const r=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Ls:(r.window!==null&&r.wbits!==e&&(r.window=null),r.wrap=n,r.wbits=e,Fx(t))},jx=(t,e)=>{if(!t)return Ls;const n=new kZ;t.state=n,n.strm=t,n.window=null,n.mode=$E;const r=Bx(t,e);return r!==Fd&&(t.state=null),r};let SI,vI,Gx=!0;const LZ=t=>{if(Gx){SI=new Int32Array(512),vI=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Jp(1,t.lens,0,288,SI,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Jp(2,t.lens,0,32,vI,0,t.work,{bits:5}),Gx=!1}t.lencode=SI,t.lenbits=9,t.distcode=vI,t.distbits=5},Wx=(t,e,n,r)=>{let i;const o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),r>=o.wsize?(o.window.set(e.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(i=o.wsize-o.wnext,i>r&&(i=r),o.window.set(e.subarray(n-r,n-r+i),o.wnext),(r-=i)?(o.window.set(e.subarray(n-r,n),0),o.wnext=r,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i))),0};var MZ=(t,e)=>{let n,r,i,o,a,d,l,h,f,m,T,S,w,I,C,N,P,x,W,H,j,$,ct=0;const Et=new Uint8Array(4);let Tt,he;const pe=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Bd(t)||!t.output||!t.input&&t.avail_in!==0)return Ls;n=t.state,n.mode===Pa&&(n.mode=EI),a=t.next_out,i=t.output,l=t.avail_out,o=t.next_in,r=t.input,d=t.avail_in,h=n.hold,f=n.bits,m=d,T=l,$=Fd;t:for(;;)switch(n.mode){case $E:if(n.wrap===0){n.mode=EI;break}for(;f<16;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(2&n.wrap&&h===35615){n.wbits===0&&(n.wbits=15),n.check=0,Et[0]=255&h,Et[1]=h>>>8&255,n.check=ri(n.check,Et,2,0),h=0,f=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&h)<<8)+(h>>8))%31){t.msg="incorrect header check",n.mode=dr;break}if((15&h)!==Ux){t.msg="unknown compression method",n.mode=dr;break}if(h>>>=4,f-=4,j=8+(15&h),n.wbits===0&&(n.wbits=j),j>15||j>n.wbits){t.msg="invalid window size",n.mode=dr;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&h?16189:Pa,h=0,f=0;break;case 16181:for(;f<16;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(n.flags=h,(255&Hr(n))!==Ux){t.msg="unknown compression method",n.mode=dr;break}if(57344&Hr(n)){t.msg="unknown header flags set",n.mode=dr;break}n.head&&(n.head.text=h>>8&1),512&Hr(n)&&4&n.wrap&&(Et[0]=255&h,Et[1]=h>>>8&255,n.check=ri(n.check,Et,2,0)),h=0,f=0,n.mode=16182;case 16182:for(;f<32;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.head&&(n.head.time=h),512&Hr(n)&&4&n.wrap&&(Et[0]=255&h,Et[1]=h>>>8&255,Et[2]=h>>>16&255,Et[3]=h>>>24&255,n.check=ri(n.check,Et,4,0)),h=0,f=0,n.mode=16183;case 16183:for(;f<16;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.head&&(n.head.xflags=255&h,n.head.os=h>>8),512&Hr(n)&&4&n.wrap&&(Et[0]=255&h,Et[1]=h>>>8&255,n.check=ri(n.check,Et,2,0)),h=0,f=0,n.mode=16184;case 16184:if(1024&Hr(n)){for(;f<16;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.length=h,n.head&&(n.head.extra_len=h),512&Hr(n)&&4&n.wrap&&(Et[0]=255&h,Et[1]=h>>>8&255,n.check=ri(n.check,Et,2,0)),h=0,f=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&Hr(n)&&(S=n.length,S>d&&(S=d),S&&(n.head&&(j=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(r.subarray(o,o+S),j)),512&Hr(n)&&4&n.wrap&&(n.check=ri(n.check,r,S,o)),d-=S,o+=S,n.length-=S),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&Hr(n)){if(d===0)break t;S=0;do j=r[o+S++],n.head&&j&&n.length<65536&&(n.head.name+=String.fromCharCode(j));while(j&&S<d);if(512&Hr(n)&&4&n.wrap&&(n.check=ri(n.check,r,S,o)),d-=S,o+=S,j)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&Hr(n)){if(d===0)break t;S=0;do j=r[o+S++],n.head&&j&&n.length<65536&&(n.head.comment+=String.fromCharCode(j));while(j&&S<d);if(512&Hr(n)&&4&n.wrap&&(n.check=ri(n.check,r,S,o)),d-=S,o+=S,j)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&Hr(n)){for(;f<16;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(4&n.wrap&&h!==(65535&n.check)){t.msg="header crc mismatch",n.mode=dr;break}h=0,f=0}n.head&&(n.head.hcrc=Hr(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=Pa;break;case 16189:for(;f<32;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}t.adler=n.check=xx(h),h=0,f=0,n.mode=ZE;case ZE:if(n.havedict===0)return t.next_out=a,t.avail_out=l,t.next_in=o,t.avail_in=d,n.hold=h,n.bits=f,PZ;t.adler=n.check=1,n.mode=Pa;case Pa:if(e===OZ||e===QE)break t;case EI:if(n.last){h>>>=7&f,f-=7&f,n.mode=TI;break}for(;f<3;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}switch(n.last=1&h,h>>>=1,f-=1,3&h){case 0:n.mode=16193;break;case 1:if(LZ(n),n.mode=tg,e===QE){h>>>=2,f-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=dr}h>>>=2,f-=2;break;case 16193:for(h>>>=7&f,f-=7&f;f<32;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if((65535&h)!=(h>>>16^65535)){t.msg="invalid stored block lengths",n.mode=dr;break}if(n.length=65535&h,h=0,f=0,n.mode=gI,e===QE)break t;case gI:n.mode=16195;case 16195:if(S=n.length,S){if(S>d&&(S=d),S>l&&(S=l),S===0)break t;i.set(r.subarray(o,o+S),a),d-=S,o+=S,l-=S,a+=S,n.length-=S;break}n.mode=Pa;break;case 16196:for(;f<14;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(n.nlen=257+(31&h),h>>>=5,f-=5,n.ndist=1+(31&h),h>>>=5,f-=5,n.ncode=4+(15&h),h>>>=4,f-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=dr;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;f<3;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.lens[pe[n.have++]]=7&h,h>>>=3,f-=3}for(;n.have<19;)n.lens[pe[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,Tt={bits:n.lenbits},$=Jp(0,n.lens,0,19,n.lencode,0,n.work,Tt),n.lenbits=Tt.bits,$){t.msg="invalid code lengths set",n.mode=dr;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;ct=n.lencode[h&(1<<n.lenbits)-1],C=ct>>>24,N=ct>>>16&255,P=65535&ct,!(C<=f);){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(P<16)h>>>=C,f-=C,n.lens[n.have++]=P;else{if(P===16){for(he=C+2;f<he;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(h>>>=C,f-=C,n.have===0){t.msg="invalid bit length repeat",n.mode=dr;break}j=n.lens[n.have-1],S=3+(3&h),h>>>=2,f-=2}else if(P===17){for(he=C+3;f<he;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}h>>>=C,f-=C,j=0,S=3+(7&h),h>>>=3,f-=3}else{for(he=C+7;f<he;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}h>>>=C,f-=C,j=0,S=11+(127&h),h>>>=7,f-=7}if(n.have+S>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=dr;break}for(;S--;)n.lens[n.have++]=j}}if(n.mode===dr)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=dr;break}if(n.lenbits=9,Tt={bits:n.lenbits},$=Jp(1,n.lens,0,n.nlen,n.lencode,0,n.work,Tt),n.lenbits=Tt.bits,$){t.msg="invalid literal/lengths set",n.mode=dr;break}if(n.distbits=6,n.distcode=n.distdyn,Tt={bits:n.distbits},$=Jp(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,Tt),n.distbits=Tt.bits,$){t.msg="invalid distances set",n.mode=dr;break}if(n.mode=tg,e===QE)break t;case tg:n.mode=eg;case eg:if(d>=6&&l>=258){t.next_out=a,t.avail_out=l,t.next_in=o,t.avail_in=d,n.hold=h,n.bits=f,IZ(t,T),a=t.next_out,i=t.output,l=t.avail_out,o=t.next_in,r=t.input,d=t.avail_in,h=n.hold,f=n.bits,n.mode===Pa&&(n.back=-1);break}for(n.back=0;ct=n.lencode[h&(1<<n.lenbits)-1],C=ct>>>24,N=ct>>>16&255,P=65535&ct,!(C<=f);){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(N&&(240&N)==0){for(x=C,W=N,H=P;ct=n.lencode[H+((h&(1<<x+W)-1)>>x)],C=ct>>>24,N=ct>>>16&255,P=65535&ct,!(x+C<=f);){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}h>>>=x,f-=x,n.back+=x}if(h>>>=C,f-=C,n.back+=C,n.length=P,N===0){n.mode=16205;break}if(32&N){n.back=-1,n.mode=Pa;break}if(64&N){t.msg="invalid literal/length code",n.mode=dr;break}n.extra=15&N,n.mode=16201;case 16201:if(n.extra){for(he=n.extra;f<he;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.length+=h&(1<<n.extra)-1,h>>>=n.extra,f-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;ct=n.distcode[h&(1<<n.distbits)-1],C=ct>>>24,N=ct>>>16&255,P=65535&ct,!(C<=f);){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if((240&N)==0){for(x=C,W=N,H=P;ct=n.distcode[H+((h&(1<<x+W)-1)>>x)],C=ct>>>24,N=ct>>>16&255,P=65535&ct,!(x+C<=f);){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}h>>>=x,f-=x,n.back+=x}if(h>>>=C,f-=C,n.back+=C,64&N){t.msg="invalid distance code",n.mode=dr;break}n.offset=P,n.extra=15&N,n.mode=16203;case 16203:if(n.extra){for(he=n.extra;f<he;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}n.offset+=h&(1<<n.extra)-1,h>>>=n.extra,f-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=dr;break}n.mode=16204;case 16204:if(l===0)break t;if(S=T-l,n.offset>S){if(S=n.offset-S,S>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=dr;break}S>n.wnext?(S-=n.wnext,w=n.wsize-S):w=n.wnext-S,S>n.length&&(S=n.length),I=n.window}else I=i,w=a-n.offset,S=n.length;S>l&&(S=l),l-=S,n.length-=S;do i[a++]=I[w++];while(--S);n.length===0&&(n.mode=eg);break;case 16205:if(l===0)break t;i[a++]=n.length,l--,n.mode=eg;break;case TI:if(n.wrap){for(;f<32;){if(d===0)break t;d--,h|=r[o++]<<f,f+=8}if(T-=l,t.total_out+=T,n.total+=T,4&n.wrap&&T&&(t.adler=n.check=Hr(n)?ri(n.check,i,T,a-T):jp(n.check,i,T,a-T)),T=l,4&n.wrap&&(Hr(n)?h:xx(h))!==n.check){t.msg="incorrect data check",n.mode=dr;break}h=0,f=0}n.mode=16207;case 16207:if(n.wrap&&Hr(n)){for(;f<32;){if(d===0)break t;d--,h+=r[o++]<<f,f+=8}if(4&n.wrap&&h!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=dr;break}h=0,f=0}n.mode=16208;case 16208:$=NZ;break t;case dr:$=Lx;break t;case 16210:return Mx;default:return Ls}return t.next_out=a,t.avail_out=l,t.next_in=o,t.avail_in=d,n.hold=h,n.bits=f,(n.wsize||T!==t.avail_out&&n.mode<dr&&(n.mode<TI||e!==kx))&&Wx(t,t.output,t.next_out,T-t.avail_out),m-=t.avail_in,T-=t.avail_out,t.total_in+=m,t.total_out+=T,n.total+=T,4&n.wrap&&T&&(t.adler=n.check=Hr(n)?ri(n.check,i,T,t.next_out-T):jp(n.check,i,T,t.next_out-T)),t.data_type=n.bits+(n.last?64:0)+(n.mode===Pa?128:0)+(n.mode===tg||n.mode===gI?256:0),(m===0&&T===0||e===kx)&&$===Fd&&($=DZ),$},Da={inflateReset:Fx,inflateReset2:Bx,inflateResetKeep:Vx,inflateInit:t=>jx(t,15),inflateInit2:jx,inflate:MZ,inflateEnd:t=>{if(Bd(t))return Ls;let e=t.state;return e.window&&(e.window=null),t.state=null,Fd},inflateGetHeader:(t,e)=>{if(Bd(t))return Ls;const n=t.state;return(2&n.wrap)==0?Ls:(n.head=e,e.done=!1,Fd)},inflateSetDictionary:(t,e)=>{const n=e.length;let r,i,o;return Bd(t)?Ls:(r=t.state,r.wrap!==0&&r.mode!==ZE?Ls:r.mode===ZE&&(i=1,i=jp(i,e,n,0),i!==r.check)?Lx:(o=Wx(t,e,n,n),o?(r.mode=16210,Mx):(r.havedict=1,Fd)))},inflateInfo:"pako inflate (from Nodeca project)"},UZ=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Hx=Object.prototype.toString,{Z_NO_FLUSH:xZ,Z_FINISH:VZ,Z_OK:Xp,Z_STREAM_END:yI,Z_NEED_DICT:RI,Z_STREAM_ERROR:FZ,Z_DATA_ERROR:Kx,Z_MEM_ERROR:BZ}=WE;function ng(t){this.options=qE.assign({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits)==0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Px,this.strm.avail_out=0;let n=Da.inflateInit2(this.strm,e.windowBits);if(n!==Xp)throw new Error(Md[n]);if(this.header=new UZ,Da.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=zp.string2buf(e.dictionary):Hx.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Da.inflateSetDictionary(this.strm,e.dictionary),n!==Xp)))throw new Error(Md[n])}function jZ(t,e){const n=new ng(e);if(n.push(t),n.err)throw n.msg||Md[n.err];return n.result}ng.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize,i=this.options.dictionary;let o,a,d;if(this.ended)return!1;for(a=e===~~e?e:e===!0?VZ:xZ,Hx.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),o=Da.inflate(n,a),o===RI&&i&&(o=Da.inflateSetDictionary(n,i),o===Xp?o=Da.inflate(n,a):o===Kx&&(o=RI));n.avail_in>0&&o===yI&&n.state.wrap>0&&t[n.next_in]!==0;)Da.inflateReset(n),o=Da.inflate(n,a);switch(o){case FZ:case Kx:case RI:case BZ:return this.onEnd(o),this.ended=!0,!1}if(d=n.avail_out,n.next_out&&(n.avail_out===0||o===yI))if(this.options.to==="string"){let l=zp.utf8border(n.output,n.next_out),h=n.next_out-l,f=zp.buf2string(n.output,l);n.next_out=h,n.avail_out=r-h,h&&n.output.set(n.output.subarray(l,l+h),0),this.onData(f)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==Xp||d!==0){if(o===yI)return o=Da.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},ng.prototype.onData=function(t){this.chunks.push(t)},ng.prototype.onEnd=function(t){t===Xp&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=qE.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var GZ={inflate:jZ};const{deflate:WZ}=RZ,{inflate:HZ}=GZ;var KZ=WZ,qZ=HZ,qx=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(qx||{});class YZ{constructor(){b(this,"_sequence",0),b(this,"_startTime",Date.now()),b(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const d=new Uint8Array(4);d.set([1,0,0,0]);const l={id:0,length:4,data:d.buffer},h={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[l]};n.commonPacketHeader.extension=1,n.extension=h,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;M("SHOW_DATASTREAM2_LOG")&&v.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const r=new ArrayBuffer(n.commonPacketHeader.length),i=new Uint8Array(r),o=new DataView(r);let a=0;if(o.setUint16(a,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),a+=2,o.setUint32(a,n.commonPacketHeader.sequence,!0),a+=4,o.setUint16(a,n.commonStreamHeader,!0),a+=2,n.extension){const d=this.serializeExtension(n.extension);i.set(new Uint8Array(d),a),a+=d.byteLength}if(i.set(new Uint8Array(n.payload),a),a+=n.payload.byteLength,a!==n.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const n=new DataView(e);let r=0;const i=n.getUint16(r,!0);r+=2;const o={length:16383&i,reserved:(16384&i)>>14,extension:(32768&i)>>15,sequence:n.getUint16(r+2,!0)<<16|n.getUint16(r,!0)};let a,d;if(r+=4,M("SHOW_DATASTREAM2_LOG")&&v.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(r,!0),r+=2,o.extension){d=this.deserializeExtension(e.slice(r)),r+=2+d.length,a=e.slice(r);let l=!1;if(d.datas.length>0){const h=d.datas.find(f=>f.id===0);h&&(l=(1&new DataView(h.data).getUint32(0,!0))==1)}a=l?this.decompress(a):a}else a=e.slice(8);return a}serializeExtension(e){const{profile:n,length:r,datas:i}=e,o=new ArrayBuffer(r+2),a=new Uint8Array(o),d=new DataView(o);let l=0;if(d.setUint8(l++,n),d.setUint8(l++,r),i.forEach(h=>{n?(d.setUint8(l++,h.id),d.setUint8(l++,h.length),a.set(new Uint8Array(h.data),l),l+=h.data.byteLength):(d.setUint8(l++,h.id|h.length<<4),a.set(new Uint8Array(h.data),l),l+=h.data.byteLength)}),l!==r+2)throw Error("serialize extension error, is ".concat(l,"!==").concat(r+2));return o}deserializeExtension(e){const n=new DataView(e);let r=0;const i=n.getUint8(r);r++;const o=n.getUint8(r);r++;const a=i===qx.TWO_BYTE,d=[],l=new DataView(e,2);let h=0;for(;h<o;){let f=0,m=0,T=new ArrayBuffer(0);a?(f=l.getUint8(h),h++,m=l.getUint8(h),h++):(f=15&l.getUint8(h),m=l.getUint8(h)>>4,h++),m>0&&(T=l.buffer.slice(h+2,h+2+m),h+=T.byteLength),d.push({id:f,length:m,data:T})}if(h!==o)throw Error("parse error");return{profile:i,length:o,datas:d}}decompress(e){return qZ(new Uint8Array(e))}compress(e){return KZ(new Uint8Array(e))}}const zZ={name:"DataStream",create:(t,e)=>{const n=e?new eQ(t):new nQ(t);return n.useDataStream(new YZ),n}};class JZ extends _n{constructor(e,n,r){super(),b(this,"ws",void 0),b(this,"requestId",1),b(this,"heartBeatTimer",void 0),b(this,"joinInfo",void 0),b(this,"clientId",void 0),b(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),b(this,"onClose",i=>{this.emit("close"),this.dispose()}),b(this,"onMessage",i=>{const o=JSON.parse(i.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=n,this.ws=new yp("cross-channel-".concat(this.clientId),r),this.ws.on(Qt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Qt.CONNECTED,this.onOpen),this.ws.on(Qt.ON_MESSAGE,this.onMessage),this.ws.on(Qt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new mt((n,r)=>{const i=window.setTimeout(()=>{r(new z(D.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(i),o.state&&o.state!==0?r(new z(D.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(i),r(new z(D.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new z(D.WS_DISCONNECT);const n=()=>new mt((a,d)=>{this.ws.once(Qt.CLOSED,()=>d(new z(D.WS_ABORT))),this.ws.once(Qt.CONNECTED,a)});this.ws.state!=="connected"&&await n();const r=this.sendMessage(e),i=new mt((a,d)=>{const l=()=>{d(new z(D.WS_ABORT))};this.ws.once(Qt.RECONNECTING,l),this.ws.once(Qt.CLOSED,l),this.once("req_".concat(r),a),hr(3e3).then(()=>{this.removeAllListeners("req_".concat(r)),this.ws.off(Qt.RECONNECTING,l),this.ws.off(Qt.CLOSED,l),d(new z(D.TIMEOUT,"cross channel ws request timeout"))})}),o=await i;if(!o||o.code!==200)throw new z(D.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners(Qt.REQUEST_NEW_URLS),this.ws.on(Qt.REQUEST_NEW_URLS,n=>{n(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class XZ extends _n{set state(e){e!==this._state&&(e!==vi.RELAY_STATE_FAILURE&&(this.errorCode=Ru.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,r,i,o){super(),b(this,"joinInfo",void 0),b(this,"sid",void 0),b(this,"clientId",void 0),b(this,"cancelToken",ai.CancelToken.source()),b(this,"workerToken",void 0),b(this,"requestId",0),b(this,"signal",void 0),b(this,"prevChannelMediaConfig",void 0),b(this,"httpRetryConfig",void 0),b(this,"_resolution",void 0),b(this,"_state",vi.RELAY_STATE_IDLE),b(this,"errorCode",Ru.RELAY_OK),b(this,"onStatus",a=>{v.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(a))),a&&a.command&&(a.command==="onAudioPacketReceived"&&this.emit("event",Ca.PACKET_RECEIVED_AUDIO_FROM_SRC),a.command==="onVideoPacketReceived"&&this.emit("event",Ca.PACKET_RECEIVED_VIDEO_FROM_SRC),a.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Ru.SRC_TOKEN_EXPIRED,this.state=vi.RELAY_STATE_FAILURE),a.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Ru.DEST_TOKEN_EXPIRED,this.state=vi.RELAY_STATE_FAILURE))}),b(this,"onReconnect",async()=>{v.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Ca.NETWORK_DISCONNECTED),this.state=vi.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(a=>{this.state!==vi.RELAY_STATE_IDLE&&(v.error("auto restart channel media relay failed",a.toString()),this.errorCode=Ru.SERVER_CONNECTION_LOST,this.state=vi.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=n,this.sid=gd(),this.signal=new JZ(this.joinInfo,this.clientId,r),this.httpRetryConfig=i,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==vi.RELAY_STATE_IDLE)throw new z(D.INVALID_OPERATION);this.state=vi.RELAY_STATE_CONNECTING,await this.connect(),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new z(D.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new z(D.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new z(D.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==vi.RELAY_STATE_RUNNING)throw new z(D.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==vi.RELAY_STATE_RUNNING)throw new z(D.INVALID_OPERATION);const n=this.genMessage(ni.SetVideoProfile);await this.signal.request(n),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),v.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=vi.RELAY_STATE_IDLE,this.dispose()}dispose(){v.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ai.CancelToken.source(),this.state=vi.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await o$(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Ca.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const n=this.genMessage(ni.StopPacketTransfer);await this.signal.request(n),await this.signal.waitStatus("Normal Quit"),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const r=this.genMessage(ni.SetSdkProfile,e);await this.signal.request(r),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(ni.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Ca.PACKET_JOINED_SRC_CHANNEL),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(ni.SetSourceUserId,e);await this.signal.request(o),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const a=this.genMessage(ni.SetDestChannel,e);await this.signal.request(a),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Ca.PACKET_JOINED_DEST_CHANNEL),v.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const d=this.genMessage(ni.StartPacketTransfer,e);await this.signal.request(d),this.emit("event",Ca.PACKET_SENT_TO_DEST_CHANNEL),this.state=vi.RELAY_STATE_RUNNING,v.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const n=this.genMessage(ni.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",Ca.PACKET_UPDATE_DEST_CHANNEL),v.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(ni.StopPacketTransfer);await this.signal.request(e),v.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,n){const r=[],i=[],o=[];this.requestId+=1;const a={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:is,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};a.sdkVersion==="4.23.2"&&(a.sdkVersion="0.0.1");let d=null,l=null;switch(e){case ni.SetSdkProfile:return a.clientRequest={command:"SetSdkProfile",type:"multi_channel"},a;case ni.SetSourceChannel:if(l=n&&n.getSrcChannelMediaInfo(),!l)throw new z(D.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceChannel",uid:"0",channelName:l.channelName,token:l.token||this.joinInfo.appId},a;case ni.SetSourceUserId:if(l=n&&n.getSrcChannelMediaInfo(),!l)throw new z(D.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceUserId",uid:l.uid+""},a;case ni.SetDestChannel:if(d=n&&n.getDestChannelMediaInfo(),!d)throw new z(D.UNEXPECTED_ERROR,"can not find dest config");return d.forEach(h=>{r.push(h.channelName),i.push(h.uid+""),o.push(h.token||this.joinInfo.appId)}),a.clientRequest={command:"SetDestChannel",channelName:r,uid:i,token:o},a;case ni.StartPacketTransfer:return a.clientRequest={command:"StartPacketTransfer"},a;case ni.Reconnect:return a.clientRequest={command:"Reconnect"},a;case ni.StopPacketTransfer:return a.clientRequest={command:"StopPacketTransfer"},a;case ni.UpdateDestChannel:if(d=n&&n.getDestChannelMediaInfo(),!d)throw new z(D.UNEXPECTED_ERROR,"can not find dest config");return d.forEach(h=>{r.push(h.channelName),i.push(h.uid+""),o.push(h.token||this.joinInfo.appId)}),a.clientRequest={command:"UpdateDestChannel",channelName:r,uid:i,token:o},a;case ni.SetVideoProfile:a.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return a}}const QZ={name:"ChannelMediaRelay",create:function(t){return new XZ(t.joinInfo,t.clientId,t.websocketRetryConfig||qn,t.httpRetryConfig||qn,t.resolution)}};function Yx(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Qp(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Yx(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Yx(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class $Z extends _n{constructor(e,n,r,i){super(),b(this,"spec",void 0),b(this,"token",void 0),b(this,"websocket",void 0),b(this,"pingpongTimer",void 0),b(this,"reconnectMode","retry"),b(this,"serviceMode",void 0),b(this,"reqId",0),b(this,"commandReqId",0),b(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),b(this,"handleWebSocketMessage",o=>{if(!o.data)return;const a=JSON.parse(o.data);a.requestId?this.emit("@".concat(a.requestId,"-").concat(a.sid),a):(bt.workerEvent(this.spec.sid,{actionType:"status",serverCode:a.code,workerType:this.serviceMode===Ia.TRANSCODE?1:2}),this.emit(fc.PUBLISH_STREAM_STATUS,a))}),this.spec=n,this.token=e,this.serviceMode=i,this.websocket=new yp("live-streaming",r),this.websocket.on(Qt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Qt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Qt.REQUEST_NEW_URLS,(o,a)=>{yr(this,fc.REQUEST_NEW_ADDRESS).then(o).catch(a)}),this.websocket.on(Qt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,n,r,i){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const o=this.commandReqId,a=this.reqId;if(!a||!this.websocket)throw new z(D.UNEXPECTED_ERROR);const d=Qp({command:e,sdkVersion:is==="4.23.2"?"0.0.1":is,seq:a,requestId:a,allocate:r,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new z(D.WS_DISCONNECT);const l=()=>new mt((T,S)=>{this.websocket.once(Qt.CLOSED,()=>S(new z(D.WS_ABORT))),this.websocket.once(Qt.CONNECTED,T)});this.websocket.state!=="connected"&&await l(),d.clientRequest&&(d.clientRequest.workerToken=this.token);const h=new mt((T,S)=>{const w=()=>{S(new z(D.WS_ABORT))};this.websocket.once(Qt.RECONNECTING,w),this.websocket.once(Qt.CLOSED,w),this.once("@".concat(a,"-").concat(this.spec.sid),I=>{T(I)})});i&&bt.workerEvent(this.spec.sid,Qp(Qp({},i),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const f=Date.now();this.websocket.sendMessage(d);let m=null;try{m=await h}catch(T){if(this.websocket.state==="closed")throw T;return await l(),await this.request(e,n,r)}return i&&bt.workerEvent(this.spec.sid,Qp(Qp({},i),{},{requestId:o,actionType:"response",payload:JSON.stringify(m.serverResponse),serverCode:m.code,success:m.code===200,responseTime:Date.now()-f})),m.code!==200&&this.handleResponseError(m),m}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=is==="4.23.2"?"0.0.1":is;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Zn.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void v.warning("live stream response already exists stream");case Zn.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Zn.LIVE_STREAM_RESPONSE_BAD_STREAM:case Zn.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new z(D.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Zn.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Zn.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new z(D.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Zn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new z(D.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(fc.WARNING,n,e.serverResponse.url)}case Zn.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new z(D.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(fc.WARNING,n,e.serverResponse.url)}case Zn.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Zn.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new z(D.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Zn.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new z(D.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(fc.WARNING,n,e.serverResponse.url)}case Zn.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Zn.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Zn.LIVE_STREAM_RESPONSE_WORKER_LOST:case Zn.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Zn.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Zn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new z(D.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Wm)},6e3)}}function zx(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function yi(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zx(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zx(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class ZZ extends _n{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:qn,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:qn;super(),b(this,"onLiveStreamWarning",void 0),b(this,"onLiveStreamError",void 0),b(this,"spec",void 0),b(this,"retryTimeout",1e4),b(this,"connection",void 0),b(this,"httpRetryConfig",void 0),b(this,"wsRetryConfig",void 0),b(this,"streamingTasks",new Map),b(this,"isStartingStreamingTask",!1),b(this,"taskMutex",new Or("live-streaming")),b(this,"cancelToken",ai.CancelToken.source()),b(this,"transcodingConfig",void 0),b(this,"uapResponse",void 0),b(this,"lastTaskId",1),b(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=r,this.wsRetryConfig=n}async setTranscodingConfig(e){const n=yi(yi({},FQ),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(v.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(a=>yi(yi(yi({},VQ),a),{},{zOrder:a.zOrder?a.zOrder+1:1}))),function(a){Sn(a.width)||Ge(a.width,"config.width",0,1e4),Sn(a.height)||Ge(a.height,"config.height",0,1e4),Sn(a.videoBitrate)||Ge(a.videoBitrate,"config.videoBitrate",1,1e6),Sn(a.videoFrameRate)||Ge(a.videoFrameRate,"config.videoFrameRate"),Sn(a.lowLatency)||Sa(a.lowLatency,"config.lowLatency"),Sn(a.audioSampleRate)||tr(a.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Sn(a.audioBitrate)||Ge(a.audioBitrate,"config.audioBitrate",1,128),Sn(a.audioChannels)||tr(a.audioChannels,"config.audioChannels",[1,2,3,4,5]),Sn(a.videoGop)||Ge(a.videoGop,"config.videoGop"),Sn(a.videoCodecProfile)||tr(a.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Sn(a.userCount)||Ge(a.userCount,"config.userCount",0,17),Sn(a.backgroundColor)||Ge(a.backgroundColor,"config.backgroundColor",0,16777215),Sn(a.userConfigExtraInfo)||ur(a.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),a.transcodingUsers&&!Sn(a.transcodingUsers)&&(va(a.transcodingUsers,"config.transcodingUsers"),a.transcodingUsers.forEach((d,l)=>{pE(d.uid),Sn(d.x)||Ge(d.x,"transcodingUser[".concat(l,"].x"),0,1e4),Sn(d.y)||Ge(d.y,"transcodingUser[".concat(l,"].y"),0,1e4),Sn(d.width)||Ge(d.width,"transcodingUser[".concat(l,"].width"),0,1e4),Sn(d.height)||Ge(d.height,"transcodingUser[".concat(l,"].height"),0,1e4),Sn(d.zOrder)||Ge(d.zOrder-1,"transcodingUser[".concat(l,"].zOrder"),0,100),Sn(d.alpha)||Ge(d.alpha,"transcodingUser[".concat(l,"].alpha"),0,1,!1)})),Sn(a.watermark)||CR(a.watermark,"watermark"),Sn(a.backgroundImage)||CR(a.backgroundImage,"backgroundImage"),a.images&&!Sn(a.images)&&(va(a.images,"config.images"),a.images.forEach((d,l)=>{CR(d,"images[".concat(l,"]"))}))}(n);const r=[];n.images&&r.push(...n.images.map(a=>yi(yi(yi({},IR),a),{},{zOrder:255}))),n.backgroundImage&&(r.push(yi(yi(yi({},IR),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(r.push(yi(yi(yi({},IR),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=r,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(a=>yi({},a)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const i=(n.userConfigs||[]).map(a=>typeof a.uid=="number"?mt.resolve(a.uid):mU(a.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await mt.all(i)).forEach((a,d)=>{n.userConfigs&&n.userConfigs[d]&&(n.userConfigs[d].uid=a)}),this.transcodingConfig=n,this.connection)try{var o;const a=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Vi(o=this.streamingTasks).call(o)).map(d=>d.taskId).join("#")});v.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(a.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(a){if(!a.data||!a.data.retry)throw a;a.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(d=>{v.warning("[".concat(this.spec.clientId,"] live streaming receive error"),a.toString(),"try to republish",d.url),this.startLiveStreamingTask(d.url,d.mode,a).then(()=>{v.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(d.url," success"))}).catch(l=>{v.error("[".concat(this.spec.clientId,"] live streaming republish failed"),d.url,l.toString()),this.onLiveStreamError&&this.onLiveStreamError(d.url,l)})})}}async startLiveStreamingTask(e,n,r){if(!this.transcodingConfig&&n===Ia.TRANSCODE)throw new z(D.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const i={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};v.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));const o=await this.taskMutex.lock();if(!this.connection&&r)return void o();if(this.streamingTasks.get(e)&&!r)return o(),new z(D.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(d){throw o(),d}switch(n){case Ia.TRANSCODE:i.transcodingConfig=yi({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(i.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const d=new mt((h,f)=>{hr(this.retryTimeout).then(()=>{if(r)return f(r);const m=this.statusError.get(e);return m?(this.statusError.delete(e),f(m)):void 0})}),l=await mt.race([this.connection.request("request",{clientRequest:i},!0,{url:e,command:"PublishStream",workerType:n===Ia.TRANSCODE?1:2,requestByUser:!r,tid:a.toString()}),d]);this.isStartingStreamingTask=!1,v.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(l.code)),this.streamingTasks.set(e,{clientRequest:i,mode:n,url:e,taskId:a}),o()}catch(d){if(o(),this.isStartingStreamingTask=!1,!d.data||!d.data.retry||r)throw d;return d.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,d)):await this.startLiveStreamingTask(e,n,d)}}stopLiveStreamingTask(e){return new mt((n,r)=>{const i=this.streamingTasks.get(e);if(!i||!this.connection)return new z(D.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=i.mode;i.abortTask=()=>{v.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:i.url}},!1,{url:e,command:"UnPublishStream",workerType:o===Ia.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(a=>{v.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(a.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()}).catch(r)})}resetAllTask(){var e;const n=Array.from(Vi(e=this.streamingTasks).call(e));this.terminate();for(const r of n)this.startLiveStreamingTask(r.url,r.mode).catch(i=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,i)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ai.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new z(D.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await yr(this,AR.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new $Z(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(fc.WARNING,(r,i)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(i,r)),this.connection.on(fc.PUBLISH_STREAM_STATUS,r=>this.handlePublishStreamServer(r)),this.connection.on(fc.REQUEST_NEW_ADDRESS,(r,i)=>{if(!this.connection)return i(new z(D.UNEXPECTED_ERROR,"can not get new live streaming address list"));yr(this,AR.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,r(o.addressList)}).catch(i)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){const n=e.serverStatus&&e.serverStatus.url||"empty_url",r=this.streamingTasks.get(n),i=e.reason;switch(e.code){case Zn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Zn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const a=new z(D.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(r)return v.error(a.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,a);if(!this.isStartingStreamingTask)return;this.statusError.set(n,a)}case Zn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const a=new z(D.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,i);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,a)}case Zn.LIVE_STREAM_RESPONSE_WORKER_LOST:case Zn.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const a=Array.from(Vi(o=this.streamingTasks).call(o));for(const d of a)d.abortTask?d.abortTask():(v.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",d.url),this.startLiveStreamingTask(d.url,d.mode,new z(D.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{v.debug("[".concat(this.spec.clientId,"] republish live stream success"),d.url)}).catch(l=>{v.error(l.toString()),this.onLiveStreamError&&this.onLiveStreamError(d.url,l)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}const ttt={name:"LiveStreaming",create:function(t){return new ZZ(t.joinInfo,t.websocketRetryConfig||qn,t.httpRetryConfig||qn)}};function ett(t){let e=Qx();return function(n,r){let i=n.appId;i!==void 0&&(xe(r,10),Bo(r,i));let o=n.cid;o!==void 0&&(xe(r,16),xe(r,o));let a=n.cname;a!==void 0&&(xe(r,26),Bo(r,a));let d=n.deviceId;d!==void 0&&(xe(r,34),Bo(r,d));let l=n.elapse;l!==void 0&&(xe(r,40),bc(r,l));let h=n.fileSize;h!==void 0&&(xe(r,48),bc(r,Bu(h)));let f=n.height;f!==void 0&&(xe(r,56),bc(r,Bu(f)));let m=n.jpg;m!==void 0&&(xe(r,66),xe(r,m.length),function(pi,it){let ut=ju(pi,it.length);pi.bytes.set(it,ut)}(r,m));let T=n.networkType;T!==void 0&&(xe(r,72),bc(r,Bu(T)));let S=n.osType;S!==void 0&&(xe(r,80),bc(r,Bu(S)));let w=n.requestId;w!==void 0&&(xe(r,90),Bo(r,w));let I=n.sdkVersion;I!==void 0&&(xe(r,98),Bo(r,I));let C=n.sequence;C!==void 0&&(xe(r,104),bc(r,Bu(C)));let N=n.sid;N!==void 0&&(xe(r,114),Bo(r,N));let P=n.timestamp;P!==void 0&&(xe(r,120),bc(r,P));let x=n.uid;x!==void 0&&(xe(r,128),xe(r,x));let W=n.vid;W!==void 0&&(xe(r,136),xe(r,W));let H=n.width;H!==void 0&&(xe(r,144),bc(r,Bu(H)));let j=n.service;j!==void 0&&(xe(r,152),xe(r,j));let $=n.callbackData;$!==void 0&&(xe(r,162),Bo(r,$));let ct=n.jpgEncryption;ct!==void 0&&(xe(r,168),xe(r,ct));let Et=n.requestType;Et!==void 0&&(xe(r,176),xe(r,Et));let Tt=n.scorePorn;Tt!==void 0&&(xe(r,185),bI(r,Tt));let he=n.scoreSexy;he!==void 0&&(xe(r,193),bI(r,he));let pe=n.scoreNeutral;pe!==void 0&&(xe(r,201),bI(r,pe));let Xe=n.scene;Xe!==void 0&&(xe(r,208),xe(r,Xe));let Mn=n.ossFilePrefix;Mn!==void 0&&(xe(r,218),Bo(r,Mn));let Cn=n.serviceVendor;if(Cn!==void 0)for(let pi of Cn){xe(r,226);let it=Qx();itt(pi,it),xe(r,it.limit),ctt(r,it),att(it)}}(t,e),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(e)}function ntt(t){return function(n){let r={};t:for(;!$x(n);){let i=jo(n);switch(i>>>3){case 0:break t;case 1:r.code=jo(n);break;case 2:r.msg=Zx(n,jo(n));break;case 3:{let o=stt(n);r.data=rtt(n),n.limit=o;break}default:Jx(n,7&i)}}return r}({bytes:e=t,offset:0,limit:e.length});var e}function rtt(t){let e={};t:for(;!$x(t);){let n=jo(t);switch(n>>>3){case 0:break t;case 1:e.requestId=Zx(t,jo(t));break;case 2:e.requestType=jo(t)>>>0;break;case 3:e.scorePorn=wI(t);break;case 4:e.scoreSexy=wI(t);break;case 5:e.scoreNeutral=wI(t);break;case 6:e.requestScene=jo(t)>>>0;break;case 7:e.scene=jo(t)>>>0;break;default:Jx(t,7&n)}}return e}function itt(t,e){let n=t.service;n!==void 0&&(xe(e,8),xe(e,n));let r=t.vendor;r!==void 0&&(xe(e,16),xe(e,r));let i=t.token;i!==void 0&&(xe(e,26),Bo(e,i));let o=t.callbackUrl;o!==void 0&&(xe(e,34),Bo(e,o))}function stt(t){let e=jo(t),n=t.limit;return t.limit=t.offset+e,n}function Jx(t,e){switch(e){case 0:for(;128&tV(t););break;case 2:CI(t,jo(t));break;case 5:CI(t,4);break;case 1:CI(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let ott=new Float32Array(1);new Uint8Array(ott.buffer);let II=new Float64Array(1),Ri=new Uint8Array(II.buffer);function Bu(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let Xx=[];function Qx(){const t=Xx.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function att(t){Xx.push(t)}function CI(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function $x(t){return t.offset>=t.limit}function ju(t,e){let n=t.bytes,r=t.offset,i=t.limit,o=r+e;if(o>n.length){let a=new Uint8Array(2*o);a.set(n),t.bytes=a}return t.offset=o,o>i&&(t.limit=o),r}function AI(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function Zx(t,e){let n=AI(t,e),r=String.fromCharCode,i=t.bytes,o="�",a="";for(let d=0;d<e;d++){let l,h,f,m,T=i[d+n];(128&T)==0?a+=r(T):(224&T)==192?d+1>=e?a+=o:(l=i[d+n+1],(192&l)!=128?a+=o:(m=(31&T)<<6|63&l,m<128?a+=o:(a+=r(m),d++))):(240&T)==224?d+2>=e?a+=o:(l=i[d+n+1],h=i[d+n+2],(49344&(l|h<<8))!=32896?a+=o:(m=(15&T)<<12|(63&l)<<6|63&h,m<2048||m>=55296&&m<=57343?a+=o:(a+=r(m),d+=2))):(248&T)==240?d+3>=e?a+=o:(l=i[d+n+1],h=i[d+n+2],f=i[d+n+3],(12632256&(l|h<<8|f<<16))!=8421504?a+=o:(m=(7&T)<<18|(63&l)<<12|(63&h)<<6|63&f,m<65536||m>1114111?a+=o:(m-=65536,a+=r(55296+(m>>10),56320+(1023&m)),d+=3))):a+=o}return a}function Bo(t,e){let n=e.length,r=0;for(let a=0;a<n;a++){let d=e.charCodeAt(a);d>=55296&&d<=56319&&a+1<n&&(d=(d<<10)+e.charCodeAt(++a)-56613888),r+=d<128?1:d<2048?2:d<65536?3:4}xe(t,r);let i=ju(t,r),o=t.bytes;for(let a=0;a<n;a++){let d=e.charCodeAt(a);d>=55296&&d<=56319&&a+1<n&&(d=(d<<10)+e.charCodeAt(++a)-56613888),d<128?o[i++]=d:(d<2048?o[i++]=d>>6&31|192:(d<65536?o[i++]=d>>12&15|224:(o[i++]=d>>18&7|240,o[i++]=d>>12&63|128),o[i++]=d>>6&63|128),o[i++]=63&d|128)}}function ctt(t,e){let n=ju(t,e.limit),r=t.bytes,i=e.bytes;for(let o=0,a=e.limit;o<a;o++)r[o+n]=i[o]}function tV(t){return t.bytes[AI(t,1)]}function eV(t,e){let n=ju(t,1);t.bytes[n]=e}function wI(t){let e=AI(t,8),n=t.bytes;return Ri[0]=n[e++],Ri[1]=n[e++],Ri[2]=n[e++],Ri[3]=n[e++],Ri[4]=n[e++],Ri[5]=n[e++],Ri[6]=n[e++],Ri[7]=n[e++],II[0]}function bI(t,e){let n=ju(t,8),r=t.bytes;II[0]=e,r[n++]=Ri[0],r[n++]=Ri[1],r[n++]=Ri[2],r[n++]=Ri[3],r[n++]=Ri[4],r[n++]=Ri[5],r[n++]=Ri[6],r[n++]=Ri[7]}function jo(t){let e,n=0,r=0;do e=tV(t),n<32&&(r|=(127&e)<<n),n+=7;while(128&e);return r}function xe(t,e){for(e>>>=0;e>=128;)eV(t,127&e|128),e>>>=7;eV(t,e)}function bc(t,e){let n=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,i=e.high>>>24,o=i===0?r===0?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,a=ju(t,o),d=t.bytes;switch(o){case 10:d[a+9]=i>>>7&1;case 9:d[a+8]=o!==9?128|i:127&i;case 8:d[a+7]=o!==8?r>>>21|128:r>>>21&127;case 7:d[a+6]=o!==7?r>>>14|128:r>>>14&127;case 6:d[a+5]=o!==6?r>>>7|128:r>>>7&127;case 5:d[a+4]=o!==5?128|r:127&r;case 4:d[a+3]=o!==4?n>>>21|128:n>>>21&127;case 3:d[a+2]=o!==3?n>>>14|128:n>>>14&127;case 2:d[a+1]=o!==2?n>>>7|128:n>>>7&127;case 1:d[a]=o!==1?128|n:127&n}}function nV(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}const dtt=new Map([["moderation",1],["supervise",2]]);class ltt extends _n{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(cr.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=Ws(n=e.map(r=>dtt.get(r)||0)).call(n,(r,i)=>r+i),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),b(this,"name","AgoraRTCVideoContentInspect"),b(this,"_connectionState",bs.CONNECTING),b(this,"_innerConnectionState",void 0),b(this,"sequence",0),b(this,"inspectStartTime",void 0),b(this,"workerManagerConnection",void 0),b(this,"workerConnection",void 0),b(this,"workerMessageLengthLimit",void 0),b(this,"inspectIntervalMinimum",void 0),b(this,"qualityRatio",void 0),b(this,"_connectInfo",void 0),b(this,"_cancelTokenSource",ai.CancelToken.source()),b(this,"_retryConfig",void 0),b(this,"wmSequence",0),b(this,"inspectInterval",void 0),b(this,"inspectTimer",null),b(this,"ossFilePrefix",void 0),b(this,"extraInfo",void 0),b(this,"_inspectType",void 0),b(this,"_inspectMode",void 0),b(this,"_quality",1),b(this,"qualityTimer",null),b(this,"_inspectId",void 0),b(this,"_needWorkUrlOnly",!1),b(this,"inspectImage",()=>{if(this.connectionState!==bs.CONNECTED)throw new z(D.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===bs.CONNECTED?this.requestToInspectImage():v.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=ze(5,"inspect-"),this.workerMessageLengthLimit=M("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=M("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=M("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new yp("worker-manager-"+this._inspectId,qn),this.on(cr.STATE_CHANGE,(n,r)=>{this._innerConnectionState=n,v.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Os[n]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new yp("worker-"+this._inspectId,qn),this.handleWorkerEvents()}async init(e,n){this.emit(cr.STATE_CHANGE,Os.CONNECT_AP),this._connectInfo=e;const r=this._cancelTokenSource.token;return this._retryConfig=n,new mt((i,o)=>{this.on(cr.CONNECTION_STATE_CHANGE,(a,d)=>{d===bs.CONNECTED&&i()}),this.requestAP(e,r,n).then(a=>{this.connectWorkerManager(a)}).catch(a=>{o(a)})})}async requestAP(e,n,r){const i=M("WEBCS_DOMAIN").map(d=>"https://".concat(d,"/api/v1")),o=await function(d,l,h,f){let{appId:m,areaCode:T,cname:S,sid:w,token:I,uid:C}=l;Nu++;const N="image_moderation_api",P={service_name:N,json_body:JSON.stringify({appId:m,areaCode:T,cname:S,command:"allocateEdge",requestId:Nu,seq:Nu,sid:w,token:I,ts:Date.now(),uid:C+""})};let x,W,H=d[0];return Xs(async()=>{x=Date.now();const j=await eo(H,{data:P,cancelToken:h,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(W=Date.now()-x,j.code!==0){const Tt=new z(D.UNEXPECTED_RESPONSE,"image inspect ap error, code"+j.code,{retry:!0,responseTime:W});throw v.error(Tt.toString()),Tt}const $=JSON.parse(j.json_body);if($.code!==200){const Tt=new z(D.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat($.code,", reason: ").concat($.reason),{code:$.code,responseTime:W});throw v.error(Tt.toString()),Tt}if(!$.servers||!Array.isArray($.servers)||$.servers.length===0){const Tt=new z(D.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:$.code,responseTime:W});throw v.error(Tt.toString()),Tt}const ct=M("VIDEO_INSPECT_WORKER_MANAGER_HOST"),Et=M("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:$.servers.map(Tt=>{let{address:he,wss:pe}=Tt;if(he&&pe)return"wss://".concat(he.replace(/\./g,"-"),".").concat(ct,":").concat(Et||pe)}).filter(Tt=>!!Tt),workerToken:$.workerToken,vid:$.vid,responseTime:W}},(j,$)=>(bt.apworkerEvent(w,{success:!0,sc:200,serviceName:N,responseDetail:JSON.stringify(j.addressList),firstSuccess:$===0,responseTime:W,serverIp:d[$%d.length]}),!1),(j,$)=>(bt.apworkerEvent(w,{success:!1,sc:j.data&&j.data.code||200,serviceName:N,responseTime:W,serverIp:d[$%d.length]}),!!(j.code!==D.OPERATION_ABORTED&&j.code!==D.UNEXPECTED_RESPONSE||j.data&&j.data.retry)&&(H=d[($+1)%d.length],!0)),f)}(i,e,n,r);this.emit(cr.STATE_CHANGE,Os.AP_CONNECTED);const{addressList:a}=o;return this.wmSequence++,a}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(cr.STATE_CHANGE,Os.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Qt.CONNECTED,async()=>{this.emit(cr.STATE_CHANGE,Os.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.23.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Qt.CLOSED,()=>{this._innerConnectionState<Os.GET_WORKER_MANAGER_RESPONSE&&v.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Qt.FAILED,()=>{this._innerConnectionState<Os.GET_WORKER_MANAGER_RESPONSE&&v.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Qt.RECONNECTING,()=>{this._innerConnectionState<Os.GET_WORKER_MANAGER_RESPONSE&&v.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Qt.ON_MESSAGE,async e=>{this.emit(cr.STATE_CHANGE,Os.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const r=JSON.parse(e.data);if(r.code!==200)throw v.error("[".concat(this._inspectId,"] Unexpected code ").concat(r.code," from worker manager")),new z(D.UNEXPECTED_RESPONSE,"response code of worker is unexpected",r);if(!(r.serverResponse&&r.serverResponse.portWss&&n))throw v.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(r))),new z(D.UNEXPECTED_RESPONSE,"response content of worker is unexpected",r);{const i=M("VIDEO_INSPECT_WORKER_PORT")||r.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(i));this.emit(cr.STATE_CHANGE,Os.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(cr.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(Qt.WILL_RECONNECT,(e,n,r)=>{r(e)}),this.workerManagerConnection.on(Qt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}handleWorkerEvents(){this.workerConnection.on(Qt.CONNECTED,async()=>{this.emit(cr.STATE_CHANGE,Os.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=bs.CONNECTED}),this.workerConnection.on(Qt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const r=ntt(new Uint8Array(e.data));if(M("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&v.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(r)),r.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(cr.INSPECT_RESULT,void 0,void 0);if(r.data&&r.data.scorePorn&&r.data.scoreSexy&&r.data.scoreNeutral){var n;const i={porn:r.data.scorePorn,sexy:r.data.scoreSexy,neutral:r.data.scoreNeutral},o=Ws(n=Object.keys(i)).call(n,(d,l)=>i[d]>i[l]?d:l,"porn"),a=Object.keys(i).find(d=>d===o);this.emit(cr.INSPECT_RESULT,a)}else this.emit(cr.INSPECT_RESULT,void 0,new z(D.UNEXPECTED_RESPONSE,r.code+"","There is an unexpected data on message"))}else this.emit(cr.INSPECT_RESULT,void 0,new z(D.UNEXPECTED_RESPONSE,r.code+"",r.msg))}else v.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(cr.INSPECT_RESULT,void 0,new z(D.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Qt.CLOSED,()=>{this.connectionState=bs.CLOSED}),this.workerConnection.on(Qt.FAILED,()=>{this.connectionState=bs.CLOSED}),this.workerConnection.on(Qt.RECONNECTING,()=>{this.connectionState=this.connectionState===bs.CONNECTED?bs.RECONNECTING:bs.CONNECTING}),this.workerConnection.on(Qt.WILL_RECONNECT,(e,n,r)=>{e==="recover"&&r(e),r("tryNext")}),this.workerConnection.on(Qt.REQUEST_NEW_URLS,(e,n)=>{this.workerManagerConnection.close(),this.once(cr.REQUEST_NEW_WORKER_URL,r=>{e([r])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(r=>{this.connectWorkerManager(r,!0)}).catch(r=>{n(r)})})}async requestToInspectImage(){this.sequence++;const e=Bi(this,cr.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(cr.INSPECT_RESULT,void 0,new z(D.INVALID_OPERATION,"Only the track being played can be inspected"));const r=await this.generateRequestData(e,n);this.workerConnection.sendMessage(r,!0,!0)}else this.emit(cr.INSPECT_RESULT,void 0,new z(D.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,n){let{appId:r,cname:i,cid:o,vid:a,sid:d,uid:l}=n;const h=Date.now(),f=await e.getCurrentFrameImage("image/jpeg",this.quality),m=await xL(f,r,i),T=this.sequence+"-"+o+"-"+l+"-"+h+"-"+ze(12,""),S={appId:r,cid:o,cname:i,deviceId:"",elapse:(w=Number(h-this.inspectStartTime),{low:w|=0,high:w>>31,unsigned:w>=0}),fileSize:m.byteLength,jpgEncryption:2,height:f.height,width:f.width,jpg:m,networkType:6,osType:7,requestId:T,sdkVersion:"4.23.2",sequence:this.sequence,sid:d,timestamp:l2(h),uid:l,vid:a,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var w;this.extraInfo===void 0&&delete S.callbackData,this.ossFilePrefix===void 0&&delete S.ossFilePrefix;const I=ett(S);if(I.byteLength<this.workerMessageLengthLimit){if(M("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const C=function(N){for(var P=1;P<arguments.length;P++){var x=arguments[P]!=null?arguments[P]:{};P%2?nV(Object(x),!0).forEach(function(W){b(N,W,x[W])}):Object.getOwnPropertyDescriptors?Object.defineProperties(N,Object.getOwnPropertyDescriptors(x)):nV(Object(x)).forEach(function(W){Object.defineProperty(N,W,Object.getOwnPropertyDescriptor(x,W))})}return N}({},S);delete C.jpg,v.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(C))}return I}{const C=this.quality*this.qualityRatio;return this.quality=C,await this.generateRequestData(e,{appId:r,cname:i,cid:o,vid:a,sid:d,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ai.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=bs.CLOSED,this.emit(cr.STATE_CHANGE,Os.CLOSED)}}const utt={name:"ContentInspect",create:function(t){let{config:e}=t;return function(n){if(!n)throw new z(D.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new z(D.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const r=[...new Set(n.inspectType)];r.forEach(i=>{var o;if(!ft(o=["supervise","moderation"]).call(o,i))throw new z(D.INVALID_PARAMS,"".concat(i," is not a valid inspect type."))}),n.inspectType=r}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new z(D.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new ltt(e)}};var rV=_(xr.Object.getOwnPropertySymbols),htt=Me,ptt=Ni.indexOf,ftt=T_,OI=Z([].indexOf),iV=!!OI&&1/OI([1],1,-0)<0;htt({target:"Array",proto:!0,forced:iV||!ftt("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return iV?OI(this,t,e)||0:ptt(this,t,e)}});var _tt=Es("Array").indexOf,mtt=st,Ett=_tt,NI=Array.prototype,gtt=function(t){var e=t.indexOf;return t===NI||mtt(NI,t)&&e===NI.indexOf?Ett:e},sV=_(gtt);function Ttt(t,e){if(t==null)return{};var n,r,i=function(a,d){if(a==null)return{};var l,h,f={},m=C1(a);for(h=0;h<m.length;h++)l=m[h],sV(d).call(d,l)>=0||(f[l]=a[l]);return f}(t,e);if(rV){var o=rV(t);for(r=0;r<o.length;r++)n=o[r],sV(e).call(e,n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}let oV=class{get localCapabilities(){return yn(this._localCapabilities)}get rtpCapabilities(){return yn(this._rtpCapabilities)}get candidates(){return yn(this._candidates)}get iceParameters(){return yn(this._iceParameters)}get dtlsParameters(){return yn(this._dtlsParameters)}constructor(t){b(this,"sessionDesc",void 0),b(this,"_localCapabilities",void 0),b(this,"_rtpCapabilities",void 0),b(this,"_candidates",void 0),b(this,"_iceParameters",void 0),b(this,"_dtlsParameters",void 0),b(this,"setup",void 0),b(this,"currentMidIndex",void 0),b(this,"cname","o/i14u9pJrxRKAsu"),b(this,"firefoxSsrcMidMap",new Map),t=yn(t);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:i,localCapabilities:o,direction:a,setup:d,videoCodec:l,audioCodec:h}=t;let f;this.setup=d,f=a===ei.RECEIVE_ONLY?Si(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Si(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=i,this._candidates=r,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=o;const m=a===ei.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,T=a===ei.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,S=a===ei.RECEIVE_ONLY?i.send.videoCodecs:Cp(vt.VIDEO,m,T,l),w=a===ei.RECEIVE_ONLY?i.send.audioCodecs:Cp(vt.AUDIO,m,T,h);for(const I of f.mediaDescriptions)I.attributes.iceUfrag=e.iceUfrag,I.attributes.icePwd=e.icePwd,I.attributes.fingerprints=n.fingerprints,I.attributes.candidates=r,I.attributes.setup=this.setup,I.media.mediaType==="application"&&(I.attributes.sctpPort="5000"),I.media.mediaType==="video"&&(I.media.fmts=S.map(C=>C.payloadType.toString(10)),I.attributes.payloads=S,I.attributes.extmaps=m.videoExtensions),I.media.mediaType==="audio"&&(I.media.fmts=w.map(C=>C.payloadType.toString(10)),I.attributes.payloads=w,I.attributes.extmaps=m.audioExtensions,Ou(I));this.sessionDesc=f,this.currentMidIndex=f.mediaDescriptions.length-1}toString(){return pc(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,n,r,i){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:a}=wd(e,this.cname,M("SYNC_GROUP")?n:void 0),d=this.findPreloadMediaDesc(o);if(d){if(Tn()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),i&&(i.twcc||i.remb)){const l=this.sessionDesc.mediaDescriptions.indexOf(d);return this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(d,i),{mid:d.attributes.mid,needExchangeSDP:!0}}return{mid:d.attributes.mid,needExchangeSDP:!1}}{const l=this.findAvailableMediaIndex(t,o,r);let h;return l===-1?(h=this.createOrRecycleSendMedia(t,o,a,"sendonly",r,i),this.updateBundleMids()):(h=yn(this.sessionDesc.mediaDescriptions[l]),h.attributes.direction="sendonly",h.attributes.ssrcs=o,h.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(h,i)),Tn()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,h.attributes.mid),{needExchangeSDP:!0,mid:h.attributes.mid}}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,n){const r=[];return t.forEach(i=>{const o=i._mediaStreamTrack.kind,a=this.findAvailableRecvMediaIndex(o);let d,l=!1;a===-1?(l=!0,d=this.createOrRecycleRecvMedia(i,[],"recvonly",e,n),this.updateBundleMids()):(d=yn(this.sessionDesc.mediaDescriptions[a]),d.attributes.direction="recvonly"),r.push({mid:d.attributes.mid,needCreateTransceiver:l})}),r}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:e,protocol:n,address:r,port:i,type:o,relatedAddress:a,relatedPort:d,priority:l}=new RTCIceCandidate(t),h={foundation:e??"",componentId:"1",transport:n??"",priority:l?l+"":"",connectionAddress:r??"",port:i?i+"":"",type:o?o+"":"",relAddr:a??"",relPort:d?d+"":"",extension:{}};this.candidates.some(f=>f.priority===h.priority&&f.connectionAddress===h.connectionAddress&&f.port===h.port)||(this._candidates.push(h),this.sessionDesc.mediaDescriptions.forEach(f=>{f.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,n,r,i){const o=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,d=Cp(o,a,this.localCapabilities.send,o===vt.AUDIO?i:r),l=o===vt.VIDEO?a.videoExtensions:a.audioExtensions,h="".concat(++this.currentMidIndex);let f={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(T=>T.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};f=this.mungRecvMediaDsec(f,t);const m=this.findFirstClosedMedia(o);if(m){const T=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[T]=f}else this.sessionDesc.mediaDescriptions.push(f);return f}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>ft(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>ft(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex(r=>{const i=r.media.mediaType===t&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(Tn()){if(i){const o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!o||o!==r.attributes.mid)}return!1}return i&&r.attributes.mid===n})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{const n=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n})}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=yn(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,n,r,i,o){const a=this.rtpCapabilities.send,d=t===vt.VIDEO?a.videoCodecs:a.audioCodecs,l=t===vt.VIDEO?a.videoExtensions:a.audioExtensions;Tn()&&(i="".concat(++this.currentMidIndex));let h={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:i}};h=this.mungSendMediaDesc(h,o);const f=this.findFirstClosedMedia(t);if(f){const m=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[m]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}mungRecvMediaDsec(t,e,n){const r=yn(t);return PR(r),bu(r,e),DR(r,e),X1(r),SE(r,n,this.localCapabilities.send),r}mungSendMediaDesc(t,e){const n=yn(t);return SE(n,e,this.localCapabilities.recv),Ou(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===t);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=r}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>Tn()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}};const Stt=["sdp"];var $e;function aV(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Oc(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?aV(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aV(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let cV=($e=class Gu extends P1{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,r){super(e,n),b(this,"direction",void 0),b(this,"name",void 0),b(this,"store",void 0),b(this,"spec",void 0),b(this,"peerConnection",void 0),b(this,"initialOffer",void 0),b(this,"transport",void 0),b(this,"statsFilter",void 0),b(this,"localCandidateCount",0),b(this,"_isInRestartIce",!1),b(this,"mutex",void 0),b(this,"onLocalCandidate",void 0),b(this,"remoteSDP",void 0),b(this,"pendingCandidates",[]),b(this,"localCapabilities",void 0),b(this,"isReady",!1),b(this,"restartCnt",0),b(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.mutex=new Or("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Gu.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=r??ei.SEND_ONLY,this.name=this.direction===ei.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Ky(this.peerConnection,M("STATS_UPDATE_INTERVAL"),void 0,Tn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const n=await $1();if(this.localCapabilities=vE(n),e){const{sdp:r}=e,i=Ttt(e,Stt),o=function(){const f={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},m=Ip(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},w={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Ns(m,f,"videoExtensions",T,S,w),Ns(m,f,"videoCodecs",T,S,w),Ns(m,f,"audioExtensions",T,S,w),Ns(m,f,"audioCodecs",T,S,w),M("RAISE_H264_BASELINE_PRIORITY")){const I=w.videoCodecs.findIndex(C=>C.rtpMap&&C.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&C.fmtp&&C.fmtp.parameters["profile-level-id"]==="42001f");if(I!==-1){const C=w.videoCodecs.findIndex(N=>N.rtpMap&&N.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(C<I){v.debug("raising H264 baseline profile priority");const N=w.videoCodecs[I];w.videoCodecs.splice(I,1),w.videoCodecs.splice(C,0,N)}C!==-1&&M("FILTER_SEND_H264_BASELINE")&&(T.videoCodecs=T.videoCodecs.filter(N=>!(N.rtpMap&&N.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&N.fmtp&&N.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:T,recv:S,sendrecv:w}}({},{},r);this.remoteSDP=new oV({remoteIceParameters:i.iceParameters,remoteDtlsParameters:i.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const a=await this.peerConnection.createAnswer();if(!a.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const d=gc(a.sdp);await this.peerConnection.setLocalDescription(a);const l=await Z1({},{},a.sdp);this.localCapabilities=vE(l);const h=this.peerConnection.getTransceivers()[0];return h!=null&&h.receiver&&h.receiver.transport&&this.tryBindTransportEvents(h.receiver.transport),Oc(Oc({},d),{},{sdp:a.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=gc(r.sdp);return this.initialOffer=r,Oc(Oc({},i),{},{sdp:r.sdp})}}catch(n){throw new et(D.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:r,dtlsParameters:i}=e,o=await Z1({},{},n);this.remoteSDP=new oV({remoteIceParameters:r,remoteDtlsParameters:i,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const a=this.peerConnection.getTransceivers()[0];a!=null&&a.sender&&a.sender.transport&&this.tryBindTransportEvents(a.sender.transport)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new et(D.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,r){var i=this;return rs(function*(){const o=yield Se(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const a=[],d=i.remoteSDP.receive(e,n,r);e.forEach((C,N)=>{if(d[N].needCreateTransceiver){const P=i.peerConnection.addTransceiver(C._mediaStreamTrack,{direction:"sendonly"});a.push(P),C._updateRtpTransceiver(P)}else{const P=i.peerConnection.getTransceivers().find(x=>x.mid===d[N].mid);if(!P)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(d[N].mid));a.push(P),C._updateRtpTransceiver(P)}}),Tn()&&M("SIMULCAST")===!0&&(yield Se(i.applySimulcastForFirefox(a,e)));const l=d.map(C=>C.mid),h=yield Se(i.peerConnection.createOffer()),f=i.mungSendOfferSDP(h.sdp,e,l),m=Si(f),T=l.map(C=>{const N=m.mediaDescriptions.find(P=>P.attributes.mid===C);if(!N)throw new Error("Cannot extract ssrc from mediaDescription.");return Y1(N,M("USE_PUB_RTX"))}),S=a.map((C,N)=>{const P=l[N];return{localSSRC:T[N],id:P}});yield Se(i.peerConnection.setLocalDescription({type:"offer",sdp:f}));try{yield S}catch(C){const N=i.remoteSDP.toString();throw yield Se(i.peerConnection.setLocalDescription({type:"offer",sdp:f})),yield Se(i.peerConnection.setRemoteDescription({type:"answer",sdp:N})),yield Se(i.stopSending(l,!0)),C}yield Se(i.applySimulcastEncodings(a,e)),yield Se(i.applySendEncodings(a,e));const w=i.remoteSDP.toString(),I=i.logSDPExchange(f,"offer","local","send");return I==null||I(w),yield Se(i.setRemoteDescription({type:"answer",sdp:w})),a.map((C,N)=>{const P=l[N];return{localSSRC:T[N],id:P}})}catch(a){throw a instanceof et?a:new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{o()}})()}async stopSending(e,n){const r=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getTransceivers().filter(l=>e.indexOf(l.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length (".concat(i.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));i.map(l=>{var h;l.direction="inactive",(h=l.stop)===null||h===void 0||h.call(l)});const o=await this.peerConnection.createOffer(),a=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);const d=this.remoteSDP.toString();a==null||a(d),await this.setRemoteDescription({type:"answer",sdp:d})}catch(i){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}finally{r&&r()}}async receive(e,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,n,r,i);if(a){const l=this.remoteSDP.toString(),h=this.logSDPExchange(l,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:l});const f=await this.peerConnection.createAnswer(),m=this.mungReceiveAnswerSDP(f.sdp,o,e);h==null||h(m||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:m}),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const d=this.peerConnection.getTransceivers().find(l=>l.mid===o);if(!d||d.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:d.receiver.track,mid:d.mid,transceiver:d}}catch(o){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(e,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,n,r,i);if(a){const d=this.remoteSDP.toString(),l=this.logSDPExchange(d,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:d});const h=await this.peerConnection.createAnswer(),f=this.mungReceiveAnswerSDP(h.sdp,o,e);l==null||l(f||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:f}),v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else v.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(o){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Td.Auto&&(this.store.p2pTransport=Td.SdRtn,Ie().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Gu.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Ie().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Gu.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:r}=gc(n.sdp);return this.store.descriptionStart(),this.direction===ei.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),r}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===ei.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:r}=gc(n.sdp);return await this.peerConnection.setLocalDescription(n),r}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const o=this.remoteSDP.toString(),a=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),a==null||a(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new et(D.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,n){const r=this.peerConnection.getTransceivers().filter(i=>i.mid===e);r.length===1&&(this.isVP8Simulcast(n)?Tn()||await this.applySimulcastEncodings(r,[n]):await this.applySendEncodings(r,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);r&&await r.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:r,remote:i}=n.getSelectedCandidatePair();return{local:Oc(Oc({},wo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:Oc(Oc({},wo),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;ft(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const i={iceServers:[]};var o;return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(up(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Gu.turnServerConfigToIceServers(e.turnServer.servers,n,r)),M("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Gu.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,r)),ft(o=[Td.Relay,Td.SdRtn]).call(o,n)&&(i.iceTransportPolicy="relay"),M("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(i.iceTransportPolicy="relay")}))),M("ENABLE_ENCODED_TRANSFORM")&&Ie().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),v.debug("P2PConnection p2pTransport is ".concat(n)),i}static turnServerConfigToIceServers(e,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const i=[],o=e.filter(d=>d.tcpport);v.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(r));const a=o.length>r?o[r]:o[0];switch(n){case Td.SdRtn:const d=e.filter(h=>{var f;return ft(f=h.username).call(f,"glb:")&&h.turnServerURL==h.turnServerURL}),l=d.length>r?d[r]:d[0];l&&(i.push({username:l.username,credential:l.password,credentialType:"password",urls:"turn:".concat(mc(l.turnServerURL),":").concat(l.tcpport,"?transport=udp")}),i.push({username:l.username,credential:l.password,credentialType:"password",urls:"turns:".concat(mc(l.turnServerURL),":").concat(l.tcpport,"?transport=tcp")}));break;case Td.Relay:a&&(i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(mc(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}));break;default:a&&(i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),i.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(mc(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}),i.push({username:a.username,credential:a.password,credentialType:"password",urls:"stun:".concat(a.turnServerURL,":").concat(a.tcpport)}))}return i}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var r;e!=null&&e.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,e.state))},e.onerror=r=>{var i;(i=this.onDTLSTransportError)===null||i===void 0||i.call(this,"error"in r?r.error:r)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const r=e==null?void 0:e.iceTransport.state;var i;r&&((i=this.onICETransportStateChange)===null||i===void 0||i.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:i}=n.getSelectedCandidatePair();v.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var r;if(n||(n=this.peerConnection.getSenders().find(f=>f.track===e._mediaStreamTrack)),!n)return v.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return v.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ie().supportSetRtpSenderParameters)return v.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},o={};switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(e._encoderConfig){var a;const{bitrateMax:f,frameRate:m,scaleResolutionDownBy:T}=e._encoderConfig;f&&(o.maxBitrate=1e3*f),ft(a=e._hints).call(a,Je.LOW_STREAM)&&(m&&(o.maxFramerate=Li(m)),T&&T>=1&&(o.scaleResolutionDownBy=T))}if(M("DSCP_TYPE")&&Ta()){var d;const f=M("DSCP_TYPE");ft(d=["very-low","low","medium","high"]).call(d,f)&&(o.networkPriority=f)}const l=n.getParameters(),h=(r=l.encodings)===null||r===void 0?void 0:r[0];Tn()&&!h&&(i.encodings=[o]),h&&Object.assign(h,o),Object.assign(l,i),v.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await n.setParameters(l)}async applySendEncodings(e,n){try{if(!Ie().supportSetRtpSenderParameters||e.length!==n.length)return;for(let r=0;r<e.length;r++){const i=e[r],o=n[r];o instanceof en&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch{v.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,r){const i=Si(e);return n.forEach((o,a)=>{const d=r[a],l=i.mediaDescriptions.find(h=>h.attributes.mid===d);l&&(bu(l,o),Q1(l,o,this.store.codec))}),pc(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let l=0;l<e.length;l++){var r,i,o,a,d;const h=e[l],f=n[l];if(f instanceof en&&!ft(r=f._hints).call(r,Je.LOW_STREAM)&&(i=f._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((o=f._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(a=f._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((d=f._scalabilityMode)===null||d===void 0?void 0:d.numSpatialLayers)>1&&this.store.codec==="vp8"){const m={},T={high:1e3*(f._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:T.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:T.high}];const S=h.sender.getParameters();await h.sender.setParameters(Object.assign(S,m))}}}async applySimulcastEncodings(e,n){if(!Tn()&&e.length===n.length)for(let r=0;r<e.length;r++){const i=n[r];if(i instanceof en&&this.isVP8Simulcast(i)){const o=e[r],a={},d={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:d.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:d.medium,scaleResolutionDownBy:4}];const l=o.sender.getParameters();await o.sender.setParameters(Object.assign(l,a))}}}isVP8Simulcast(e){var n,r,i,o,a;return!!(e instanceof en&&M("SIMULCAST")&&this.store.codec==="vp8"&&!ft(n=e._hints).call(n,Je.LOW_STREAM)&&(r=e._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=e._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=e._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(e,n,r,i){if(M("SDP_LOGGING"))return v.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(a=>a.mid&&e.indexOf(a.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(a=>{a.direction="inactive"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();i==null||i(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(a=>a.mid&&e.indexOf(a.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async a=>{a.direction="sendonly"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(e);const o=this.remoteSDP.toString();i==null||i(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var r,i;if(n=(r=n)!==null&&r!==void 0?r:(i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp){var o;const a=(o=Si(n).mediaDescriptions.find(d=>d.attributes.mid===e))===null||o===void 0?void 0:o.attributes.ssrcs;return a==null?void 0:a[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),ft(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,n,r){const i=Si(e),o=i.mediaDescriptions.find(a=>a.attributes.mid===n);return o&&r===vt.AUDIO&&o.media.mediaType==="audio"&&Ou(o),pc(i)}},Ct($e.prototype,"establish",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"establish"),$e.prototype),Ct($e.prototype,"connect",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"connect"),$e.prototype),Ct($e.prototype,"receive",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"receive"),$e.prototype),Ct($e.prototype,"mockReceive",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"mockReceive"),$e.prototype),Ct($e.prototype,"stopReceiving",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"stopReceiving"),$e.prototype),Ct($e.prototype,"restartICE",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"restartICE"),$e.prototype),Ct($e.prototype,"close",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"close"),$e.prototype),Ct($e.prototype,"updateEncoderConfig",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"updateEncoderConfig"),$e.prototype),Ct($e.prototype,"updateSendParameters",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"updateSendParameters"),$e.prototype),Ct($e.prototype,"replaceTrack",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"replaceTrack"),$e.prototype),Ct($e.prototype,"muteLocal",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"muteLocal"),$e.prototype),Ct($e.prototype,"unmuteLocal",[Ms],Object.getOwnPropertyDescriptor($e.prototype,"unmuteLocal"),$e.prototype),$e);function Ms(t,e,n){const r=t[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PConnection.".concat(e));try{for(var a=arguments.length,d=new Array(a),l=0;l<a;l++)d[l]=arguments[l];return await r.apply(this,d)}finally{o()}},n}let ro=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});var dV,lV,uV,hV,pV,fV,_V,mV,EV,gV,TV,ln;function SV(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function rg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?SV(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):SV(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let vtt=(dV=io(ro.SEND_ONLY),lV=io(ro.SEND_ONLY),uV=io(),hV=io(ro.RECEIVE_ONLY),pV=io(ro.RECEIVE_ONLY),fV=io(ro.RECEIVE_ONLY),_V=io(ro.RECEIVE_ONLY),mV=io(ro.RECEIVE_ONLY),EV=io(ro.RECEIVE_ONLY),gV=io(),TV=io(ro.RECEIVE_ONLY),ln=class extends _n{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Mt.StateChange,e,this._state)}constructor(t,e){super(),b(this,"isPlanB",!1),b(this,"store",void 0),b(this,"statsUploader",void 0),b(this,"sendConnection",void 0),b(this,"recvConnection",void 0),b(this,"localTrackMap",new Map),b(this,"remoteUserMap",new Map),b(this,"localDataChannels",[]),b(this,"pendingLocalTracks",[]),b(this,"pendingRemoteTracks",[]),b(this,"statsCollector",void 0),b(this,"dtlsFailedCount",0),b(this,"sendMutex",void 0),b(this,"recvMutex",void 0),b(this,"_state",Le.Disconnected),b(this,"_restartStates",["disconnected","failed"]),b(this,"reconnectInterval",void 0),b(this,"uploadUnplinkStarted",!1),b(this,"uploadDownlinkStarted",!1),b(this,"uplinkStateUploadInterval",void 0),b(this,"downlinkStatsUploadInterval",void 0),b(this,"handleMuteLocalTrack",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Le.Connected)return void i(new et(D.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const l=this.filterTobeMutedTracks(n);if(l.length===0)return void r();const h=l.find(S=>S[0]==="videoLowTrack");h&&h[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(l.map(S=>{let[,{id:w}]=S;return w}));let f=!1;var a,d;n.trackMediaType==="video"?f=!((a=this.localTrackMap.get(at.LocalAudioTrack))===null||a===void 0||!a.track._muted):f=((d=this.localTrackMap.get(at.LocalVideoTrack))===null||d===void 0?void 0:d.id)===void 0;const m=this.createMuteMessage(l);await Ye(this,Mt.RequestMuteLocal,m);const T=n.trackMediaType==="video"?_c.MUTE_LOCAL_VIDEO:_c.MUTE_LOCAL_AUDIO;await Ye(this,Mt.RequestP2PMuteLocal,{action:T,message:m,isMuteAll:f}),r()}catch(l){i(l)}finally{o()}}),b(this,"handleUnmuteLocalTrack",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Le.Connected)return void i(new et(D.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const a=this.filterTobeUnmutedTracks(n);if(a.length===0)return void r();await this.sendConnection.unmuteLocal(a.map(h=>{let[,{id:f}]=h;return f}));const d=this.createUnmuteMessage(a),l=n.trackMediaType==="video"?_c.UNMUTE_LOCAL_VIDEO:_c.UNMUTE_LOCAL_AUDIO;await Ye(this,Mt.RequestP2PMuteLocal,{action:l,message:d}),r()}catch(a){i(a)}finally{o()}}),b(this,"handleUpdateVideoEncoder",async(n,r,i,o)=>{let a;typeof o=="boolean"&&o||(a=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get(at.LocalVideoTrack);if(!this.sendConnection||!l||l.track!==n||this.state!==Le.Connected)return void r();const{id:h,track:f}=l;h&&(await this.sendConnection.updateSendParameters(h,f),await this.sendConnection.updateEncoderConfig(h,f),this.emit(Mt.UpdateVideoEncoder,f)),r()}catch(l){i(l)}finally{var d;(d=a)===null||d===void 0||d()}}),b(this,"handleUpdateVideoSendParameters",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const a=this.localTrackMap.get(at.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==n||this.state!==Le.Connected)return void r();const{id:d,track:l}=a;d&&await this.sendConnection.updateSendParameters(d,l),r()}catch(a){i(a)}finally{o()}}),b(this,"handleReplaceTrack",async(n,r,i,o)=>{let a;v.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var d;const h=Array.from(this.localTrackMap.entries()).find(f=>{let[,{track:m}]=f;return n===m});if(!this.sendConnection||!h||h[1].id===void 0||this.state!==Le.Connected)return void r();if(await((d=this.sendConnection)===null||d===void 0?void 0:d.replaceTrack(n,h[1].id)),h[0]===at.LocalVideoTrack&&Ie().supportDualStreamEncoding){const f=this.localTrackMap.get(at.LocalVideoLowTrack);if(f){const m=n._mediaStreamTrack.clone();f.track._originMediaStreamTrack.stop(),f.track._mediaStreamTrack=m,f.track._originMediaStreamTrack=m,await new mt((T,S)=>{this.handleReplaceTrack(f.track,T,S,!0)})}}r()}catch(h){i(h)}finally{var l;(l=a)===null||l===void 0||l()}}),b(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),b(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),b(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),b(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new VU(t),this.bindStatsUploaderEvents(),this.sendMutex=new Or("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new Or("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},M("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new et(D.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t){throw new et(D.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(v.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new cV(t,this.store,ei.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const r=await this.recvConnection.establish(e);return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}{this.state=Le.New,this.sendConnection&&(v.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new cV(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const r=await this.sendConnection.establish();return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}}finally{n&&n()}}async p2pConnect(t){if(!this.sendConnection)throw new et(D.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Le.Connected}async addRemoteCandidate(t,e){if(e===ei.RECEIVE_ONLY){if(!this.sendConnection)throw new et(D.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new et(D.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,n){var r=this;return rs(function*(){const i=yield Se(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==Le.Connected){r.throwIfTrackTypeNotMatch(t);const h=t.filter(f=>r.pendingLocalTracks.indexOf(f)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(h))}r.store.pubId=r.store.pubId+1,Dr.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield Se(r.tryToUnmuteAudio(t)));o.forEach(h=>{let{track:f,type:m}=h;const T=Date.now();r.store.publish(f.getTrackId(),m===at.LocalAudioTrack?"audio":"video",T)}),r.bindLocalTrackEvents(o);const a=yield Se(r.sendConnection.send(o.map(h=>{let{track:f}=h;return f}),r.store.codec,r.store.audioCodec)),d=(yield Se(a.next())).value,l=r.createGatewayPublishMessage(o,d);try{yield l}catch(h){throw a.throw(h),(h==null?void 0:h.code)===D.WS_ABORT&&o.forEach(f=>{let{track:m}=f;r.pendingLocalTracks.indexOf(m)===-1&&r.pendingLocalTracks.push(m)}),r.unbindLocalTrackEvents(o),h}yield Se(a.next()),o.forEach(h=>{let{type:f}=h;r.statsCollector.addLocalStats(f)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(o,d),o.forEach(h=>{let{track:f,type:m}=h;const T=Date.now();r.store.publish(f.getTrackId(),m===at.LocalAudioTrack?"audio":"video",void 0,T)}),r.startUploadUplinkState()}finally{i()}})()}async unpublish(t){if(!this.sendConnection||this.state!==Le.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(i=>!ft(t).call(t,i)));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(i=>i[0]==="videoLowTrack");n&&n[1].track.close();const r=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(i=>{let[,{id:o}]=i;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(i=>{let[o,{track:a}]=i;return{type:o,track:a}})),e.forEach(i=>{let[o]=i;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Le.Connected)return n&&n[1].track.close(),r;t.forEach(i=>{const o=this.pendingLocalTracks.indexOf(i);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[i,{track:o,ssrcs:a}]=r;const d={stream_type:h$(o,i),ssrcs:a};o._muted||!o._enabled?e.push(d):n.push(d)}),e.length>0&&e.forEach(r=>{Ye(this,Mt.RequestMuteLocal,[r])}),n.length>0&&n.forEach(r=>{Ye(this,Mt.RequestUnmuteLocal,[r])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return rs(function*(){throw new et(D.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(v.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await yr(this,Mt.RequestRePublish,this.pendingLocalTracks),this.emit(Mt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new et(D.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,r){var i;if(!this.recvConnection)throw new et(D.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((i=this.remoteUserMap.get(t))!==null&&i!==void 0&&i.has(e))return;const{track:o,mid:a,transceiver:d}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),r);e===vt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new Su(o,t.uid,t._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),d&&t._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Tu(o,t.uid,t._uintid,this.store),v.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),d&&t._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._videoTrack));const l=this.remoteUserMap.get(t);l?l.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const h=this.pendingRemoteTracks.findIndex(f=>{let{user:m,kind:T}=f;return m.uid===t.uid&&e===T});h!==-1&&(this.pendingRemoteTracks.splice(h,1),this.emit(Mt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,n,r){if(!this.recvConnection)throw new et(D.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),r)}async unsubscribe(t,e,n){const r=this.pendingRemoteTracks.filter(o=>{let{user:a,kind:d}=o;return e!==void 0?a.uid===t.uid&&e===d:a.uid===t.uid});if(r.forEach(o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)}),this.recvConnection||n||r.forEach(o=>{let{kind:a}=o;var d;if(a===vt.AUDIO)(d=t._audioTrack)===null||d===void 0||d._destroy(),t._audioTrack=void 0;else if(a===vt.VIDEO){var l;(l=t._videoTrack)===null||l===void 0||l._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const i=this.filterTobeUnSubscribedTracks(t,e);i.length!==0&&(await this.recvConnection.stopReceiving(i.map(o=>{let[,{id:a}]=o;return a})),this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),i.forEach(o=>{let[a,{kind:d}]=o;var l,h;if(d===vt.VIDEO&&a._videoSSRC&&((l=this.recvConnection)===null||l===void 0||l.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),d===vt.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((h=a._videoTrack)===null||h===void 0||h._destroy(),a._videoTrack=void 0);else if(d===vt.AUDIO){var f;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((f=a._audioTrack)===null||f===void 0||f._destroy(),a._audioTrack=void 0)}}),i.forEach(o=>{let[,{kind:a}]=o;Ye(this,Mt.RequestP2PMuteRemote,a)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[vt.VIDEO,vt.AUDIO].forEach(r=>{n.has(r)?Ye(this,Mt.RequestP2PUnmuteRemote,r):Ye(this,Mt.RequestP2PMuteRemote,r)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new et(D.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new et(D.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new et(D.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new et(D.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const r=e===vt.VIDEO?t._videoSSRC:t._audioSSRC;r!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void v.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||v.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(at.LocalAudioTrack);if((e==null?void 0:e.track)instanceof $n){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==at.LocalAudioTrack}).filter(r=>{let[i]=r;return!(t&&i===at.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(t&&r===at.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}reportPublishEvent(t,e,n,r,i){if(t){const a=this.localTrackMap.get(at.LocalAudioTrack),d=r?this.localTrackMap.get(at.LocalVideoLowTrack):this.localTrackMap.get(at.LocalVideoTrack);bt.publish(this.store.sessionId,{eventElapse:Dr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:d==null?void 0:d.track.getTrackLabel(),screenshare:(d==null?void 0:d.track._hints.indexOf(Je.SCREEN_TRACK))!==-1,audio:!!a,video:!!d,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const a=n.find(l=>l instanceof In),d=r?(o=this.localTrackMap.get(at.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(l=>l instanceof en);bt.publish(this.store.sessionId,{eventElapse:Dr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:d==null?void 0:d.getTrackLabel(),screenshare:(d==null?void 0:d._hints.indexOf(Je.SCREEN_TRACK))!==-1,audio:!!a,video:!!d,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(t,e,n,r){const i=r===vt.VIDEO?n._videoSSRC:n._audioSSRC;i&&bt.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===vt.VIDEO,audio:r===vt.AUDIO,peerid:n.uid,subscribeRequestid:r===vt.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Dr.measureFromSubscribeStart(this.store.clientId,i)})}reset(){v.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Or("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Or("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(at.LocalAudioTrack);if((t==null?void 0:t.track)instanceof $n){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Le.Disconnected}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(at.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(at.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof en||e&&e.track instanceof In?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Gi(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(at.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Jh(t).call(t,(n,r)=>n.level-r.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(v.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Le.Reconnecting,M("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:r}]=t;switch(n){case at.LocalVideoTrack:ft(e=r._hints).call(e,Je.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case at.LocalAudioTrack:r instanceof $n?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case at.LocalVideoLowTrack:}}),this.emit(Mt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Gi(n).call(n)).forEach(r=>{this.setPendingRemoteMedia(e,r)}),this.emit(Mt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),v.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((t instanceof Sc?t.uid:t)===r.uid&&e===i)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let n,r;if(t===ei.SEND_ONLY){if(!this.sendConnection)throw new et(D.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),r=this.sendConnection}else{if(!this.recvConnection)throw new et(D.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),r=this.recvConnection}try{if(e){const i=await r.restartICE(e);return r.isInRestartIce=!1,i}{const i=await r.restartICE();if(i){const o=await yr(this,Mt.RequestP2PRestartICE,{direction:ei.RECEIVE_ONLY,iceParameter:i});await r.restartICE(o),r.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(at.LocalVideoTrack),n=this.localTrackMap.get(at.LocalAudioTrack),r=t.videoSend.find(S=>{var w;return S.ssrc===(e==null||(w=e.ssrcs)===null||w===void 0?void 0:w[0].ssrcId)}),i=t.audioSend.find(S=>{var w;return S.ssrc===(n==null||(w=n.ssrcs)===null||w===void 0?void 0:w[0].ssrcId)});if(!r||!i)return 1;const o=Bi(this,Mt.NeedSignalRTT),a=r?r.rttMs:void 0,d=i?i.rttMs:void 0,l=a&&d?(a+d)/2:a||d,h=(l&&o?(l+o)/2:l||o)||0,f=100*t.sendPacketLossRate*.7/50+.3*h/1500,m=f<.17?1:f<.36?2:f<.59?3:f<.1?4:5,T=e==null?void 0:e.track;if(T&&T._encoderConfig&&T._hints.indexOf(Je.SCREEN_TRACK)===-1){const S=T._encoderConfig.bitrateMax,w=t.bitrate.actualEncoded;if(S&&w){const I=(1e3*S-w)/(1e3*S);return y1[I<.15?0:I<.3?1:I<.45?2:I<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,a=t.audioRecv.find(w=>w.ssrc===i),d=t.videoRecv.find(w=>w.ssrc===o);if(!a&&!d)return void(e+=1);const l=Bi(this,Mt.NeedSignalRTT),h=t.rtt,f=(h&&l?(h+l)/2:h||l)||0,m=a?a.jitterMs:void 0,T=t.recvPacketLossRate;let S=.7*T*100/50+.3*f/1500;m&&(S=.6*T*100/50+.2*f/1500+.2*m/400),e+=S<.1?1:S<.17?2:S<.36?3:S<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new mt((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}filterTobePublishedTracks(t,e,n){const r=[],i=Ie(),o=this.getAllTracks();t=ou(t=t.filter(l=>o.indexOf(l)===-1));let a=!1,d=!1;for(const l of t){if(l instanceof en&&(this.localTrackMap.has(at.LocalVideoTrack)||a?new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:l,type:at.LocalVideoTrack}),a=!0),e)){const h=this.getLowVideoTrack(l,n);r.push({track:h,type:at.LocalVideoLowTrack})}if(l instanceof In){const h=this.localTrackMap.get(at.LocalAudioTrack);if(h){if(!(h.track instanceof $n))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");h.track.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0)}else if(d){const f=r.find(m=>{let{type:T}=m;return T===at.LocalAudioTrack});if(!(f.track instanceof $n))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");f.track.addAudioTrack(l)}else{if(!i.webAudioMediaStreamDest||l instanceof $n||l._bypassWebAudio)r.push({track:l,type:at.LocalAudioTrack});else{const f=new $n;f.addAudioTrack(l),r.push({track:f,type:at.LocalAudioTrack})}d=!0}}}return r}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=ou(t=t.filter(r=>n.indexOf(r)!==-1));for(const r of t){if(r instanceof In){const i=this.localTrackMap.get(at.LocalAudioTrack);if(!i)continue;i.track instanceof $n?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),i.track.trackList.length===0&&(e.push([at.LocalAudioTrack,i]),i.track.close())):e.push([at.LocalAudioTrack,i])}if(r instanceof en){const i=this.localTrackMap.get(at.LocalVideoTrack);if(!i)continue;e.push([at.LocalVideoTrack,i]);const o=this.localTrackMap.get(at.LocalVideoLowTrack);o&&e.push([at.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:r}=e;switch(r){case at.LocalVideoTrack:n.addListener(Rt.GET_STATS,this.handleGetLocalVideoStats),n.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(Rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case at.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case at.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof $n?t.trackList.forEach(n=>{n.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Rt.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Rt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:r}]=e;return{track:r,type:n}})),t.forEach(e=>{let{track:n,type:r}=e;switch(r){case at.LocalVideoTrack:n.off(Rt.GET_STATS,this.handleGetLocalVideoStats),n.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Rt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(Rt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case at.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case at.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof $n?t.trackList.forEach(e=>{e.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Rt.GET_STATS,this.handleGetLocalAudioStats),e.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Rt.GET_STATS,this.handleGetLocalAudioStats),t.off(Rt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Rt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Rt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Rt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Rt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Tu&&e.addListener(Rt.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof Su&&e.addListener(Rt.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Rt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(vt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(vt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,r)=>{var i;let o,{track:a,type:d}=n;switch(d){case at.LocalAudioTrack:o=Ue.Audio;break;case at.LocalVideoTrack:o=ft(i=a._hints).call(i,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:o=Ue.Low}return{kind:d===at.LocalAudioTrack?vt.AUDIO:vt.VIDEO,stream_type:o,mid:e[r].id,ssrcs:e[r].localSSRC,isMuted:a.muted||!a.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}assignLocalTracks(t,e){t.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(Mt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),ft(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await hr(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),bt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:vn.TRACER}).onSuccess(),this.emit(Mt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var i;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(i=r.audioTrack)===null||i===void 0||i.emit(fu.FIRST_FRAME_DECODED),bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_AUDIO_DECODE,cn.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(i=>i._audioSSRC===e);r&&bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_AUDIO_RECEIVED,cn.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,r)=>{this.reportVideoFirstFrameDecoded(e,n,r)},t.onFirstVideoReceived=e=>{var n;const r=Array.from(Gi(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===e);r&&bt.firstRemoteFrame(this.store.sessionId,nr.FIRST_VIDEO_RECEIVED,cn.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const r=e.candidateType==="relay",i=n.candidateType==="relay";n.candidateType!=="unknown"&&r===i||this.emit(Mt.ConnectionTypeChange,r),v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ec(n))," -> ").concat(JSON.stringify(Ec(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{v.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ec(n))," -> ").concat(JSON.stringify(Ec(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(Mt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===ei.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,v.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===ei.SEND_ONLY?this.restartICE(t):yr(this,Mt.RequestP2PRestartICE,{direction:ei.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(at.LocalAudioTrack);if(t instanceof In&&(n==null?void 0:n.track)instanceof $n)return n.track.isActive||e.push([at.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r&&(e.push(r),r[0]===at.LocalVideoTrack)){const i=this.localTrackMap.get(at.LocalVideoLowTrack);i&&e.push([at.LocalVideoLowTrack,i])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(at.LocalAudioTrack);if(t instanceof In&&(n==null?void 0:n.track)instanceof $n)return n.track.isActive&&e.push([at.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r)if(r[0]===at.LocalVideoTrack){e.push(r);const i=this.localTrackMap.get(at.LocalVideoLowTrack);i&&e.push([at.LocalVideoLowTrack,i])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}createUnmuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:a,id:d}]=e;switch(i){case at.LocalAudioTrack:r=Ue.Audio;break;case at.LocalVideoTrack:r=ft(n=o._hints).call(n,Je.SCREEN_TRACK)?Ue.Screen:Ue.High;break;case at.LocalVideoLowTrack:r=Ue.Low}return{stream_type:r,ssrcs:a,mid:d}})}filterTobeUnSubscribedTracks(t,e){const n=[],r=this.remoteUserMap.get(t);if(!r)return n;if(e){const i=r.get(e);if(!i)return n;n.push([t,{kind:e,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,a]=i;n.push([t,{kind:o,id:a}])});return n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[r,{kind:i,id:o}]=n;switch(i){case vt.VIDEO:return void(r._videoSSRC&&e.push({stream_type:vt.VIDEO,ssrcId:r._videoSSRC}));case vt.AUDIO:return void(r._audioSSRC&&e.push({stream_type:vt.AUDIO,ssrcId:r._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:r}]=e;const i=this.remoteUserMap.get(n);i&&(i.delete(r),Array.from(i.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(at.LocalVideoTrack),n=this.localTrackMap.get(at.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new mt((r,i)=>{this.handleUpdateVideoEncoder(e.track,r,i,!0)})),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new mt((r,i)=>{this.handleUpdateVideoEncoder(n.track,r,i,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof In){const n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;const r=this.createUnmuteMessage(n);return void await Ye(this,Mt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Mt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Mt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await hr(Fy(this.dtlsFailedCount,qn)),this.emit(Mt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(at.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof en)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof en).length>1)throw new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof In).length>1&&(t.some(e=>e instanceof In&&e._bypassWebAudio)||!Ie().webAudioMediaStreamDest))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof en&&this.pendingLocalTracks.some(n=>n instanceof en))throw new et(D.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof In&&this.pendingLocalTracks.some(n=>n instanceof In)&&(!Ie().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof In&&n._bypassWebAudio)))throw new et(D.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!M("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ie().supportDualStreamEncoding,r=rg(rg({},{width:160,height:120,framerate:15,bitrate:50}),e);let i;i=n?t._mediaStreamTrack.clone():zR(t,r);const o=ze(8,"track-low-"),a=new en(i,rg(rg({},n&&{scaleResolutionDownBy:NR(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(Sd.TRANSCEIVER_UPDATED,d=>{t._updateRtpTransceiver(d,hu.LOW_STREAM)}),a._hints.push(Je.LOW_STREAM),t.addListener(Rt.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,r){var i;const o=Array.from(Gi(i=this.remoteUserMap).call(i)).find(a=>a._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find(l=>l.userId===o.uid&&l.type==="video");bt.firstRemoteVideoDecode(this.store.sessionId,nr.FIRST_VIDEO_DECODE,cn.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Dr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(d==null?void 0:d.subscribeEnd)||0,subscriberStart:(d==null?void 0:d.subscribeStart)||0,videoAddNotify:(d==null?void 0:d.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return!1;const r=this.remoteUserMap.get(t);if(!r)return!1;const i=r.get(e);if(!i)return!1;const o=await this.recvConnection.getRemoteSSRC(i);return o!==void 0&&o!==n}isPreSubScribe(t){return!1}async publishDataChannel(t){throw new et(D.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new et(D.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new et(D.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new et(D.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new et(D.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new et(D.NOT_SUPPORTED)}async preConnect(t){throw new et(D.NOT_SUPPORTED)}getEstablishParams(){throw new et(D.NOT_SUPPORTED)}async reSubscribe(t){throw new et(D.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new et(D.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===at.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,hu.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},Ct(ln.prototype,"p2pConnect",[dV],Object.getOwnPropertyDescriptor(ln.prototype,"p2pConnect"),ln.prototype),Ct(ln.prototype,"unpublish",[lV],Object.getOwnPropertyDescriptor(ln.prototype,"unpublish"),ln.prototype),Ct(ln.prototype,"unpublishLowStream",[uV],Object.getOwnPropertyDescriptor(ln.prototype,"unpublishLowStream"),ln.prototype),Ct(ln.prototype,"subscribe",[hV],Object.getOwnPropertyDescriptor(ln.prototype,"subscribe"),ln.prototype),Ct(ln.prototype,"mockSubscribe",[pV],Object.getOwnPropertyDescriptor(ln.prototype,"mockSubscribe"),ln.prototype),Ct(ln.prototype,"unsubscribe",[fV],Object.getOwnPropertyDescriptor(ln.prototype,"unsubscribe"),ln.prototype),Ct(ln.prototype,"muteRemote",[_V],Object.getOwnPropertyDescriptor(ln.prototype,"muteRemote"),ln.prototype),Ct(ln.prototype,"unmuteRemote",[mV],Object.getOwnPropertyDescriptor(ln.prototype,"unmuteRemote"),ln.prototype),Ct(ln.prototype,"hasRemoteMediaWithLock",[EV],Object.getOwnPropertyDescriptor(ln.prototype,"hasRemoteMediaWithLock"),ln.prototype),Ct(ln.prototype,"disconnectForReconnect",[gV],Object.getOwnPropertyDescriptor(ln.prototype,"disconnectForReconnect"),ln.prototype),Ct(ln.prototype,"remoteMediaSsrcChanged",[TV],Object.getOwnPropertyDescriptor(ln.prototype,"remoteMediaSsrcChanged"),ln.prototype),ln);function io(t){return function(e,n,r){const i=e[n];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){for(var o=arguments.length,a=new Array(o),d=0;d<o;d++)a[d]=arguments[d];switch(t){case ro.SEND_ONLY:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,a)}finally{l()}}case ro.RECEIVE_ONLY:{const l=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,a)}finally{l()}}default:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(n)),h=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,a)}finally{l(),h()}}}},r}}class jd extends _n{constructor(e,n){super(),b(this,"signal",void 0),b(this,"token",void 0),b(this,"tokenTimeout",void 0),b(this,"tokenInterval",void 0),b(this,"_sequence",0),b(this,"userMap",new Map),b(this,"encoder",new TextEncoder),this.signal=e,this.token=n;const r=()=>{this.signal.connectionState===Qe.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(r,1e3):this.tokenInterval=window.setTimeout(r,3*M("P2P_TOKEN_INTERVAL"))};r()}async send(e,n,r,i,o){var a,d,l;if(this.userMap.size===0)return;const h=Array.from(Vi(a=this.userMap).call(a))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),i=(d=i)!==null&&d!==void 0?d:ze(6,""),o=(l=o)!==null&&l!==void 0?l:this._sequence++;const f={_id:i,_type:e,_seq:o,_message:n,token:"".concat(this.token,"_").concat(h)};M("SHOW_P2P_LOG")&&v.debug("send message",f,"noNeedResponse : ".concat(r)),this.splitMessage(JSON.stringify(f)).forEach(T=>{this.signal.request(Wt.DATA_STREAM,{payload:hc(this.encoder.encode(T))})});const m=new mt((T,S)=>{const w=window.setTimeout(()=>{this.off("res-@".concat(i,"_ack"),I),this.off("res-@".concat(i),N),this.off(Cu.ABORT,C),v.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(i)),this.userMap.size===0?S(new et(D.INVALID_REMOTE_USER)):S(new et(D.TIMEOUT))},M("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),I=()=>{w&&window.clearTimeout(w),this.off(Cu.ABORT,C),r&&T()},C=()=>{w&&window.clearTimeout(w),this.off("res-@".concat(i,"_ack"),I),this.off("res-@".concat(i),N),S(new et(D.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(i)))};this.once(Cu.ABORT,C),this.once("res-@".concat(i,"_ack"),I);const N=(x,W)=>{P=!0,w&&window.clearTimeout(w),this.off("res-@".concat(i,"_ack"),I),this.off(Cu.ABORT,C),x==="success"?T(W):S(new et(D.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(i)))};let P=!1;r||(this.once("res-@".concat(i),N),hr(M("SIGNAL_REQUEST_TIMEOUT")).then(()=>{P||v.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(i,", ").concat(f))}))});try{return await m}catch(T){if(T.code===D.TIMEOUT)return await this.send(e,n,r,i,o);throw T}}onMessage(e){var n;const{_uid:r}=e;let i,o=this.userMap.get(r);if(o)i=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==Ln.CHECK)return;const{token:h}=e;i=new Map,o={uid:r,isStart:!0,token:h,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(r,o),this.signal.emit(ue.ON_USER_ONLINE,{uid:r}),this.handleUserOnline()}if("id"in e&&"total"in e){var a;const{id:h,total:f}=e,m=(a=i.get(h))!==null&&a!==void 0?a:[];if(m.push(e),i.has(h)||i.set(h,m),m.length!==f)return;{const T=Jh(m).call(m,(S,w)=>S.index-w.index).map(S=>S.payload).join("");i.delete(h),(e=JSON.parse(T))._uid=r}}const{_type:d,token:l}=e;if(ft(n=[Ln.ACK,Ln.CHECK]).call(n,d))return d===Ln.CHECK&&this.handleCheckToken(o,l),void this.receiveMessage(e);l==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):v.debug('Receive unexpected message", '.concat(l,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){const e={_id:ze(6,""),token:this.token,_type:Ln.CHECK};M("SHOW_P2P_LOG")&&v.debug("send message",e),this.signal.request(Wt.DATA_STREAM,{payload:hc(this.encoder.encode(JSON.stringify(e)))})}ack(e){const n={_id:e,_type:Ln.ACK,token:this.token};M("SHOW_P2P_LOG")&&v.debug("send message",n),this.signal.request(Wt.DATA_STREAM,{payload:hc(this.encoder.encode(JSON.stringify(n)))})}response(e,n,r){this.send(Ln.RESPONSE,JSON.stringify({success:!r,message:n}),!0,e)}handleReceivedMessage(e){const n=()=>{this.userMap.forEach(h=>{const{receivedMessagesMap:f,nextExpectedSequenceNumber:m}=h;for(;f.has(m);){const T=f.get(m);f.delete(m),this.receiveMessage(T),h.nextExpectedSequenceNumber++}})};if(!e)return void n();const{_uid:r,_seq:i}=e,o=this.userMap.get(r),{receivedMessagesMap:a,isStart:d,nextExpectedSequenceNumber:l}=o;if(i<l)return this.ack(e._id),void v.debug("[external-signal] receive old message, seq: ".concat(i,", ").concat(e._message));a.set(i,e),d&&i===l&&(this.receiveMessage(e),a.delete(l),o.nextExpectedSequenceNumber++,n())}receiveMessage(e){const{_id:n,_type:r,_message:i,_uid:o}=e;if(M("SHOW_P2P_LOG")&&v.debug("receive message",e),n){let a;switch(e._type!==Ln.ACK&&(i&&(a=JSON.parse(i)),this.ack(e._id)),e._type){case Ln.CANDIDATE:case Ln.CONTROL:this.signal.emit(r,a,o);break;case Ln.PUBLISH:case Ln.UNPUBLISH:case Ln.RESTART_ICE:case Ln.CALL:a.uid=o,yr(this.signal,r,a).then(d=>{this.response(e._id,d)}).catch(()=>{this.response(e._id,void 0,!0)});break;case Ln.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case Ln.RESPONSE:{const{success:d,message:l}=a;this.emit("res-@".concat(n),d?"success":"failed",l);break}}}}splitMessage(e){if(e.length<jd.MAX_MESSAGE_SIZE)return[e];const n=[],{remoteToken:r}=JSON.parse(e),i=ze(6,"");let o=0,a=800;const d=Math.ceil(e.length/a);for(;e.length>0;){o++;const l={id:i,index:o,total:d,payload:e.slice(0,a),token:"".concat(this.token,"_").concat(r)};JSON.stringify(l).length>jd.MAX_MESSAGE_SIZE?a-=50:(n.push(l),e=e.slice(a))}return n.map(l=>JSON.stringify(l))}handleCheckToken(e,n){return e.token!==n?(v.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{v.debug("token timeout, ".concat(n)),this.reset(e.uid)},M("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await yr(this.signal,Ln.CALL,void 0),n=await this.send(Ln.CALL,e);this.signal.emit(qt.P2P_CONNECTION,n,!0)}async reset(e,n){const r=this.userMap.get(e);r&&(this.emit(Cu.ABORT),this.signal.emit(ue.ON_USER_OFFLINE,{uid:r.uid,reason:BQ.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(v.debug("change local token from ".concat(n," to ").concat(n)),this.token=ze(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Cu.ABORT)}}b(jd,"MAX_SIZE",1),b(jd,"MAX_MESSAGE_SIZE",1024);class ytt extends _n{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Qe.CONNECTED?this.emit(qt.WS_CONNECTED):e===Qe.RECONNECTING?this.emit(qt.WS_RECONNECTING,this._websocketReconnectReason):e===Qe.CLOSED&&this.emit(qt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),b(this,"_disconnectedReason",void 0),b(this,"_websocketReconnectReason",void 0),b(this,"_connectionState",Qe.CLOSED),b(this,"reconnectToken",void 0),b(this,"p2pToken",void 0),b(this,"websocket",void 0),b(this,"openConnectionTime",void 0),b(this,"clientId",void 0),b(this,"lastMsgTime",Date.now()),b(this,"uploadCache",[]),b(this,"uploadCacheInterval",void 0),b(this,"rttRolling",new Xk(5)),b(this,"pingpongTimer",void 0),b(this,"pingpongTimeoutCount",0),b(this,"joinResponse",void 0),b(this,"multiIpOption",void 0),b(this,"initError",void 0),b(this,"spec",void 0),b(this,"store",void 0),b(this,"_external_signal",void 0),b(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(qt.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case ue.ON_DATA_STREAM:return void this.handleDataStream(i._message);case ue.MUTE_AUDIO:case ue.MUTE_VIDEO:case ue.ON_P2P_LOST:case ue.ON_USER_ONLINE:return;case ue.ON_USER_OFFLINE:const{uid:o}=i._message;return v.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(i._type,i._message),i._type===ue.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===ue.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(ke.UID_BANNED);break;case 15:this.close(ke.IP_BANNED);break;case 16:this.close(ke.CHANNEL_BANNED)}if(i._type===ue.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case Ut.ERR_LICENSE_MISSING:this.close(ke.LICENSE_MISSING);break;case Ut.ERR_LICENSE_EXPIRED:this.close(ke.LICENSE_EXPIRED);break;case Ut.ERR_LICENSE_MINUTES_EXCEEDED:this.close(ke.LICENSE_MINUTES_EXCEEDED);break;case Ut.ERR_LICENSE_PERIOD_INVALID:this.close(ke.LICENSE_PERIOD_INVALID);break;case Ut.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(ke.LICENSE_MULTIPLE_SDK_SERVICE);break;case Ut.ERR_LICENSE_ILLEGAL:this.close(ke.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new bR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,M("JOIN_GATEWAY_USE_DUAL_DOMAIN"),M("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Qe.CONNECTED&&this.reconnect("retry",vr.OFFLINE)}),this.p2pToken=ze(6,""),this._external_signal=new jd(this,this.p2pToken)}async request(e,n,r,i){const o=ze(6,""),a={_id:o,_type:e,_message:n},d=this.websocket.connectionID,l=()=>new mt((w,I)=>{if(this.connectionState===Qe.CONNECTED)return w();const C=()=>{this.off(qt.WS_CLOSED,N),w()},N=()=>{this.off(qt.WS_CONNECTED,C),I(new et(D.WS_ABORT))};this.once(qt.WS_CONNECTED,C),this.once(qt.WS_CLOSED,N)});if(this.connectionState!==Qe.CONNECTING&&this.connectionState!==Qe.RECONNECTING||e===Wt.JOIN||e===Wt.REJOIN||await l(),this.websocket.sendMessage(a,!0),i)return;const h=new mt((w,I)=>{let C=!1;const N=(x,W)=>{C=!0,w({isSuccess:x==="success",message:W||{}}),this.off(qt.WS_CLOSED,P),this.off(qt.WS_RECONNECTING,P),this.emit(qt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),N);const P=()=>{I(new et(D.WS_ABORT,"type: ".concat(e))),this.off(qt.WS_CLOSED,P),this.off(qt.WS_RECONNECTING,P),this.off("res-@".concat(o),N)};this.once(qt.WS_CLOSED,P),this.once(qt.WS_RECONNECTING,P),hr(M("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==d||C||(v.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(qt.REQUEST_TIMEOUT,e,n))})});let f=null;try{f=await h}catch(w){if(this.connectionState===Qe.CLOSED||e===Wt.LEAVE)throw new et(D.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?w.throw():e===Wt.JOIN||e===Wt.REJOIN?null:(await l(),await this.request(e,n))}if(f.isSuccess)return f.message;const m=Number(f.message.error_code||f.message.code),T=vp(m),S=new et(D.UNEXPECTED_RESPONSE,"".concat(T.desc,": ").concat(f.message.error_str),{code:m,data:f.message,desc:T.desc});return T.action==="success"?f.message:(v.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(m,", message: ").concat(T.desc,", action: ").concat(T.action)),m===Ut.ERR_TOO_MANY_BROADCASTERS?((e===Wt.JOIN||e===Wt.REJOIN)&&(this.initError=S,this.close()),S.throw()):T.action==="failed"?S.throw():T.action==="quit"?(this.initError=S,this.close(),S.throw()):(m===Ut.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=f.message.option,v.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",vr.MULTI_IP)):this.reconnect(T.action,vr.SERVER_ERROR),e===Wt.JOIN||e===Wt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new mt(r=>{const i=o=>{(!n||n(o))&&(this.off(e,i),r(o))};this.on(e,i)})}uploadWRTCStats(e){if(!this.store.sessionId)return void v.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Tp.WRTC_STATS,n)}upload(e,n){const r={_type:e,_message:n};try{this.websocket.sendMessage(r)}catch{const o=M("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Qe.CONNECTED)return;const a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},M("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const r={_type:e,_message:n};this.websocket.sendMessage(r)}async sendExtensionMessage(e,n,r){return await this._external_signal.send(e,n,r)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new mt((n,r)=>{this.once(qt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(qt.WS_CLOSED,()=>r(this.initError||new et(D.WS_ABORT))),this.connectionState=Qe.CONNECTING,this.websocket.init(e).catch(r)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||ke.LEAVE,this.connectionState=Qe.CLOSED,v.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=ze(6,""),this._external_signal.clear(),this._external_signal=new jd(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(qt.ABORT_P2P_EXECUTION);const e=await yr(this,qt.REQUEST_JOIN_INFO),n=await this.request(Wt.JOIN,e);if(!n)return this.emit(qt.REPORT_JOIN_GATEWAY,D.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(qt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Qe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleDataStream(e){try{var n;const r=Ed(e.payload),i=new TextDecoder().decode(r),o=JSON.parse(i);"total"in o&&"id"in o||ft(n=Object.values(Ln)).call(n,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(ue.ON_DATA_STREAM,e)}catch{this.emit(ue.ON_DATA_STREAM,e)}}handleNotification(e){v.debug("[".concat(this.clientId,"] receive notification: "),e);const n=vp(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(ke.UID_BANNED),void this.close()):void this.reconnect(n.action,vr.SERVER_ERROR);v.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=M("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(v.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>M("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",vr.TIMEOUT):this.request(Wt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),M("REPORT_STATS")&&this.send(Wt.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWebsocketEvents(){this.websocket.on(Qt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(qt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Qt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Qt.CLOSED,()=>{this.connectionState=Qe.CLOSED}),this.websocket.on(Qt.FAILED,()=>{this._disconnectedReason=ke.NETWORK_ERROR,this.connectionState=Qe.CLOSED}),this.websocket.on(Qt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Qe.CONNECTED?this.connectionState=Qe.RECONNECTING:this.connectionState=Qe.CONNECTING}),this.websocket.on(Qt.WILL_RECONNECT,(e,n,r)=>{e!=="retry"?(v.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):v.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),r(e)}),this.websocket.on(Qt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(qt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof et&&e.code===D.UNEXPECTED_RESPONSE&&e.data.code===Ut.ERR_NO_AUTHORIZED)return v.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",vr.SERVER_ERROR);v.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",vr.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Qt.REQUEST_NEW_URLS,(e,n)=>{yr(this,qt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Qt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const Rtt={name:"P2PChannel",create:function(t){let{store:e,statsCollector:n}=t;return new vtt(e,n)},createSubmodule:function(t){let{store:e,spec:n}=t;return new ytt(n,e)}};function vV(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function yV(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vV(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vV(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class Itt{constructor(e){b(this,"sessionDesc",void 0),b(this,"localCapabilities",void 0),b(this,"rtpCapabilities",void 0),b(this,"candidates",void 0),b(this,"_originCandidates",void 0),b(this,"iceParameters",void 0),b(this,"dtlsParameters",void 0),b(this,"setup",void 0),b(this,"currentMidIndex",void 0),b(this,"cname",void 0),e=yn(e);const{iceParameters:n,dtlsParameters:r,candidates:i,rtpCapabilities:o,setup:a,localCapabilities:d,sdkCodec:l,cname:h}=e,f=Si(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=i,this._originCandidates=yn(i),this.iceParameters=n,this.dtlsParameters=r,this.setup=a,this.localCapabilities=d,this.cname=h;for(let m=0;m<f.mediaDescriptions.length;m++){const T=f.mediaDescriptions[m];if(T.attributes.iceUfrag=n.iceUfrag,T.attributes.icePwd=n.icePwd,T.attributes.fingerprints=r.fingerprints,T.attributes.candidates=i,T.attributes.setup=a,T.media.mediaType==="video"){T.media.fmts=o.videoCodecs.map(w=>w.payloadType.toString(10));let S=o.videoCodecs.filter(w=>{var I,C;return(I=w.rtpMap)===null||I===void 0?void 0:ft(C=I.encodingName.toLowerCase()).call(C,l)});S.length===0&&(S=o.videoCodecs),T.attributes.payloads=S,T.attributes.extmaps=o.videoExtensions}T.media.mediaType==="audio"&&(T.media.fmts=o.audioCodecs.map(S=>S.payloadType.toString(10)),T.attributes.payloads=o.audioCodecs,T.attributes.extmaps=o.audioExtensions),f.mediaDescriptions[m]=this.mungMediaDesc(T)}this.sessionDesc=f,this.currentMidIndex=f.mediaDescriptions.length-1}toString(){return pc(this.sessionDesc)}send(e,n,r){const{ssrcs:i,ssrcGroups:o}=wd(n,this.cname),a=this.sessionDesc.mediaDescriptions.find(h=>e===vt.VIDEO?h.media.mediaType==="video":h.media.mediaType==="audio"),d=i[0].attributes.label,l=i[0].attributes.mslabel;return a.attributes.ssrcs=a.attributes.ssrcs.concat(i),a.attributes.ssrcGroups=a.attributes.ssrcGroups.concat(o),{id:d,mslabel:l}}batchSend(e){return e.map(n=>{let{kind:r,ssrcMsg:i}=n;return this.send(r,i,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(n=>{const r=[],i=[],o=[];n.attributes.ssrcs.forEach(a=>{ft(e).call(e,a.attributes.label||"")?o.push(a):r.push(a)}),n.attributes.ssrcGroups.forEach(a=>{var d;ft(d=o.map(l=>l.ssrcId)).call(d,a.ssrcIds[0])||i.push(a)}),n.attributes.ssrcs=r,n.attributes.ssrcGroups=i})}mute(e){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(e,n,r){e.forEach((i,o)=>{const a=i._mediaStreamTrack,d=this.sessionDesc.mediaDescriptions.findIndex(h=>h.attributes.mid===a.kind),l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[d],i);this.sessionDesc.mediaDescriptions[d]=l})}stopReceiving(e){}updateCandidates(e){const n=this._originCandidates.filter(i=>i.transport==="udp"),r=[];if(n.forEach(i=>{r.push(yV(yV({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),n.length!==0){switch(e){case Pr.TCP_RELAY:this.candidates=r;break;case Pr.UDP_TCP_RELAY:case Pr.RELAY:this.candidates=[...n,...r];break;default:this.candidates=n}for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(e){e=yn(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const n=[];for(let r=0;r<e;r++)n.push((this.currentMidIndex+r+1).toString(10));return n}mungRecvMediaDsec(e,n){const r=yn(e);return bu(r,n),DR(r,n),r}updateRecvMedia(e,n){const r=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===e);if(r!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],n);this.sessionDesc.mediaDescriptions[r]=i}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,n,r){const i=this.sessionDesc.mediaDescriptions.find(a=>e===vt.VIDEO?a.attributes.mid==="video":a.attributes.mid==="audio");if(i){const a=i.attributes.ssrcs.find(d=>d.attributes.label===n);var o;a&&(a.attributes.label=r,(o=a.attributes.msid)===null||o===void 0||o.replace(n,r))}}mungMediaDesc(e){const n=yn(e);return PR(n),function(r){const i=r.attributes.extmaps.find(o=>TE(o.extensionName));i&&r.attributes.extmaps.splice(r.attributes.extmaps.indexOf(i),1),r.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(d=>d.type==="transport-cc");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}(n),n}getSSRC(e){for(const n of this.sessionDesc.mediaDescriptions)for(const r of n.attributes.ssrcs)if(r.attributes.label===e)return[r]}}var Ke;function RV(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function ig(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?RV(Object(n),!0).forEach(function(r){b(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):RV(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let Ctt=(Ke=class Zp extends D1{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return ft(n=Object.keys(zm)).call(n,e)}))]}constructor(e,n){super(e,n),b(this,"store",void 0),b(this,"peerConnection",void 0),b(this,"remoteSDP",void 0),b(this,"initialOffer",void 0),b(this,"statsFilter",void 0),b(this,"useRTX",!1),b(this,"localCapabilities",void 0),b(this,"localCandidateCount",0),b(this,"allCandidatesReceived",!1),b(this,"establishPromise",void 0),b(this,"mutex",void 0),this.store=n,this.mutex=new Or("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Zp.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Ky(this.peerConnection,M("STATS_UPDATE_INTERVAL"),void 0,Tn()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=gc(e.sdp),r=Ip(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:M("FILTER_VIDEO_FEC"),filterAudioFec:M("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=r,this.initialOffer=e,ig(ig({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:r},offerSDP:e.sdp})}catch(e){throw new et(D.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new Itt(ig(ig({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new et(D.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,n){var r=this;return rs(function*(){const i=yield Se(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=e.map(T=>r.peerConnection.addTrack(T._mediaStreamTrack)),a=yield Se(r.peerConnection.createOffer()),d=Si(a.sdp),l=e.map(T=>{const S=T._mediaStreamTrack,w=d.mediaDescriptions.find(I=>I.attributes.mid===S.kind);if(!w)throw new Error("Cannot extract ssrc from mediaDescription.");return function(I,C,N){const P=I.attributes.ssrcs.filter(W=>W.attributes.label===C),x=I.attributes.ssrcGroups;if(P.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(x&&P.length>1){const W=x.find(H=>H.ssrcIds.indexOf(P[0].ssrcId)!==-1);return W?[{ssrcId:W.ssrcIds[0],rtx:N?W.ssrcIds[1]:void 0}]:[{ssrcId:P[0].ssrcId}]}return[{ssrcId:P[0].ssrcId}]}(w,S.id,r.useRTX)});let h;try{h=yield l}catch(T){throw o.forEach(S=>{Sr()&&S.replaceTrack(null),r.peerConnection.removeTrack(S)}),T}const f=r.mungSendOfferSDP(a.sdp,e);r.remoteSDP.receive(e,n,h);const m=r.remoteSDP.toString();return yield Se(r.peerConnection.setLocalDescription({type:"offer",sdp:f})),yield Se(r.applySendEncodings(o,e)),yield Se(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),e.map((T,S)=>{const w=T._mediaStreamTrack.id;return{localSSRC:l[S],id:w}})}catch(o){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{i()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter(o=>{var a;return e.indexOf(((a=o.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{Sr()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:o,mslabel:a}=this.remoteSDP.send(e,n,i),d=new mt((f,m)=>{const T=setTimeout(()=>{m(new Error("Cannot receive track, id: ".concat(o)))},1e4),S=w=>{const I=ve();if((I.name==="Safari"&&Number(I.version)===11||$r())&&w.track.id!==o&&w.streams[0].id===a){var C;const N=w.streams[0].getTracks()[0];return(C=this.remoteSDP)===null||C===void 0||C.updateTrackLabel(e,o,w.track.id),this.peerConnection.removeEventListener("track",S),clearTimeout(T),void f(N)}if(w.track.id===o)return this.peerConnection.removeEventListener("track",S),clearTimeout(T),void f(w.track)};this.peerConnection.addEventListener("track",S)}),l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});const h=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(h),{track:await d,id:o}}catch(o){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(r=>{var i;return e.indexOf(((i=r.track)===null||i===void 0?void 0:i.id)||"")!==-1});if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map(r=>{if(Sr()&&r.track)r.track.enabled=!1;else{const i=r.getParameters();i.encodings.forEach(o=>o.active=!1),r.setParameters(i)}})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(o=>{var a;return e.indexOf(((a=o.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if(Sr()&&o.track)o.track.enabled=!0;else{const a=o.getParameters();a.encodings.forEach(d=>d.active=!0),await o.setParameters(a)}});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return rs(function*(){const r=yield Se(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const i=Ie().supportPCSetConfiguration;if(e===Pr.RELAY&&!i)return;if(i){const h=n.peerConnection.getConfiguration(),f=e===Pr.RELAY?"relay":"all";h.iceTransportPolicy!==f&&(v.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(f,"]")),h.iceTransportPolicy=f,n.peerConnection.setConfiguration(h))}e!==Pr.RELAY&&n.remoteSDP.updateCandidates(e);const o=yield Se(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=gc(o.sdp),{remoteIceParameters:d}=yield a.iceParameters;n.remoteSDP.restartICE(d);const l=n.remoteSDP.toString();yield Se(n.peerConnection.setLocalDescription(o)),yield Se(n.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(i){v.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new et(D.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,n){const r=this.peerConnection.getSenders().filter(i=>{var o;return((o=i.track)===null||o===void 0?void 0:o.id)===e});r.length===1&&await this.applySendEncodings(r,[n])}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const r=this.peerConnection.getSenders().find(i=>{var o;return((o=i.track)===null||o===void 0?void 0:o.id)===n});r&&await r.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,n){throw new et(D.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new et(D.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,v.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},M("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(up(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Zp.turnServerConfigToIceServers(e.turnServer.servers)),M("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Zp.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(e,n){var r;if(n||(n=this.peerConnection.getSenders().find(h=>{var f;return((f=h.track)===null||f===void 0?void 0:f.id)===e._mediaStreamTrack.id})),!n)return v.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Ie().supportSetRtpSenderParameters)return v.warn("Browser not support set rtp-sender parameters");const i={},o={};if(e instanceof en)switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(M("DSCP_TYPE")&&Ta()){var a;const h=M("DSCP_TYPE");ft(a=["very-low","low","medium","high"]).call(a,h)&&(o.networkPriority=h)}const d=n.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,i),v.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await n.setParameters(d)}async applySendEncodings(e,n){try{if(!Ie().supportSetRtpSenderParameters||e.length!==n.length)return;for(let r=0;r<e.length;r++){const i=e[r],o=n[r];i&&o&&await this.updateRtpSenderEncodings(o,i)}}catch{v.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n){const r=Si(e);return n.forEach((i,o)=>{const a=i._mediaStreamTrack,d=r.mediaDescriptions.find(l=>l.attributes.mid===a.kind);d&&bu(d,i)}),pc(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(e).map((o,a)=>{let{id:d,mslabel:l}=o;const{kind:h}=e[a];return new mt((f,m)=>{const T=setTimeout(()=>{m(new Error("Cannot receive track, id: ".concat(d)))},1e4),S=w=>{const I=ve();if(I.name==="Safari"&&Number(I.version)===11&&w.track.id!==d&&w.streams[0].id===l){var C;const N=w.streams[0].getTracks()[0];return(C=this.remoteSDP)===null||C===void 0||C.updateTrackLabel(h,d,w.track.id),this.peerConnection.removeEventListener("track",S),clearTimeout(T),void f({track:N,id:d})}if(w.track.id===d)return this.peerConnection.removeEventListener("track",S),clearTimeout(T),void f({track:w.track,id:d})};this.peerConnection.addEventListener("track",S)})}),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const i=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(i),await mt.all(n)}catch(n){throw new et(D.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n==null?void 0:n[0].ssrcId}setConfiguration(e){if(Ie().supportPCSetConfiguration){const n=Zp.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},Ct(Ke.prototype,"connect",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"connect"),Ke.prototype),Ct(Ke.prototype,"stopSending",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"stopSending"),Ke.prototype),Ct(Ke.prototype,"receive",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"receive"),Ke.prototype),Ct(Ke.prototype,"stopReceiving",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"stopReceiving"),Ke.prototype),Ct(Ke.prototype,"muteRemote",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"muteRemote"),Ke.prototype),Ct(Ke.prototype,"unmuteRemote",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"unmuteRemote"),Ke.prototype),Ct(Ke.prototype,"muteLocal",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"muteLocal"),Ke.prototype),Ct(Ke.prototype,"unmuteLocal",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"unmuteLocal"),Ke.prototype),Ct(Ke.prototype,"close",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"close"),Ke.prototype),Ct(Ke.prototype,"updateEncoderConfig",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"updateEncoderConfig"),Ke.prototype),Ct(Ke.prototype,"updateSendParameters",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"updateSendParameters"),Ke.prototype),Ct(Ke.prototype,"replaceTrack",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"replaceTrack"),Ke.prototype),Ct(Ke.prototype,"getRemoteSSRC",[us],Object.getOwnPropertyDescriptor(Ke.prototype,"getRemoteSSRC"),Ke.prototype),Ke);function us(t,e,n){const r=t[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("Locking from P2PConnection.".concat(e));try{for(var a=arguments.length,d=new Array(a),l=0;l<a;l++)d[l]=arguments[l];return await r.apply(this,d)}finally{o()}},n}const Att={name:"PlanBConnection",create:function(t){let{store:e,spec:n}=t;return new Ctt(n,e)}},wtt={interceptLocalAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Ie().supportWebRTCEncodedTransform)return void v.warning("browser not support audio encoded transform");if(rE.has(t)||!t.track)return;const n={track:t.track};if(ga()){if(!t.createEncodedStreams)return void v.warning("browser not support createEncodedStreams() API");let i=null;try{i=t.createEncodedStreams()}catch(a){return void v.error("create audio-encoded-streams error",a&&a.message)}const o=new TransformStream({transform(a,d){n.controller||(n.controller=d),t.track&&t.track.id!==n.track.id&&(v.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));const l=e.metadata&&e.metadata();l?function(h,f){const{chunk:m,controller:T}=f,S=M("ENABLE_AUDIO_PTS_METADATA")?Ra.AUDIO_64_BIT_PTS:Ra.METADATA;m.data=function(w,I,C){const N=C.byteLength,P=N+_R+m1,x=pR+fR+P,W=new ArrayBuffer(w.byteLength+x),H=new DataView(W);H.setUint8(0,_1),H.setUint16(1,P),H.setUint8(3,I),H.setUint16(4,N);for(let $=0;$<N;$++)H.setUint8(6+$,C[$]);const j=new Uint8Array(H.buffer);return j.set(new Uint8Array(w),x),j.buffer}(m.data,S,h),T.enqueue(m)}(l,{chunk:a,controller:d}):d.enqueue(a)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else if(Sr()){if(typeof RTCRtpScriptTransform>"u")return void v.warning("browser not support RTCRtpScriptTransform");const i=nE(),o=new MessageChannel;await new mt(d=>i.onmessage=l=>{l.data==="registered"&&d(void 0)});const a=new RTCRtpScriptTransform(i,{name:"audio-metadata-tx",port:o.port2},[o.port2]);t.transform=a,await new mt(d=>i.onmessage=l=>{l.data==="started"&&d(void 0)}),o.port1.onmessage=d=>{var l;if(d.data.transformed&&t.track&&((l=t.track)===null||l===void 0?void 0:l.id)!==n.track.id)v.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r);else if(d.data.getMetadata){const h=e.metadata&&e.metadata();h&&o.port1.postMessage({metadata:h})}},n.worker=i}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}const i=rE.get(t);if(i){rE.delete(t);try{var o,a;(o=i.controller)===null||o===void 0||o.terminate(),(a=i.worker)===null||a===void 0||a.terminate()}catch(d){v.warning(d&&d.message)}}}rE.set(t,n),t.track.addEventListener("ended",r)},interceptRemoteAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Ie().supportWebRTCEncodedTransform)return void v.warning("browser not support audio encoded transform");if(dE.has(t))return;const n={track:t.track,onMetadata:e.onMetadata};if(ga()){if(!t.createEncodedStreams)return void v.warning("browser not support createEncodedStreams() API");wy(Oe.CHROME,87,116)||(e.enableTopn=!1);let i=null;try{i=t.createEncodedStreams()}catch(a){return void v.error("create audio-encoded-streams error",a&&a.message)}const o=new TransformStream({transform(a,d){n.controller||(n.controller=d),t.track&&t.track.id!==n.track.id&&(v.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)),e.enableTopn?function(l,h,f){var m;const T=E1(new DataView(h.data));if(!T)return f.enqueue(h);const S=l.track.id;aQ.set(S,l.track);const w=(m=T.tlv.find(W=>W.tag===Ra.AUDIO_LEVEL))===null||m===void 0?void 0:m.value;let I=0;typeof w=="number"&&(I=127-w);const C=Math.round(Math.pow(10,I/60)-1),{selected:N,speaker:P}=function(W,H){let j=vu.get(W);if(j||(j=function($){const ct=new T1;return vu.set($,ct),$s||($s=new sQ(M("TOPN_SILENCE_THRESHOLD")||500),$s.on("ActiveSpeakerChanged",Et=>{Et!=null&&(oE=Et)})),$s.addSpeakers([ct]),ct}(W)),vu.size<=S1)return{selected:!0,speaker:j};if(!$s)throw new Error("no active speaker detector");return $s.levelChanged(j.id,H),Id=$s.loudest.map($=>$.id),oE&&!ft(Id).call(Id,oE)&&Id.length>=S1&&Id.pop(),{selected:ft(Id).call(Id,j.id)||j.id===oE,speaker:j}}(l,C),x=function(W,H,j){const $=Zs.get(W)||new oQ(W,H);return $.score=j,Zs.set(W,$),function(ct){if(aE.set(ct,!0),!cE)return void(cE=Date.now());const Et=Date.now();Et-cE>1e3&&(aE.get(ct)?aE.set(ct,!1):(v1(ct),aE.delete(ct)),cE=Et)}(W),$}(S,l.track,P.energyScore);x.addSample(N),x.active&&(h.data=T.frame.buffer,f.enqueue(h))}(t,a,d):e.enableMetadata?function(l,h,f){const m=E1(new DataView(l.data));if(!m)return h.enqueue(l);const T=m.tlv.find(S=>S.tag===Ra.METADATA||S.tag===Ra.AUDIO_64_BIT_PTS);T&&f&&T.value instanceof Uint8Array&&f(T.value),l.data=m.frame.buffer,h.enqueue(l)}(a,d,e.onMetadata):d.enqueue(a)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else if(Sr()){if(typeof RTCRtpScriptTransform>"u")return void v.warning("browser not support RTCRtpScriptTransform");const i=nE(),o=new MessageChannel;await new mt(d=>i.onmessage=l=>{l.data==="registered"&&d(void 0)});const a=new RTCRtpScriptTransform(i,{name:"audio-metadata-rx",port:o.port2},[o.port2]);t.transform=a,await new mt(d=>i.onmessage=l=>{l.data==="started"&&d(void 0)}),o.port1.onmessage=d=>{var l;d.data.transformed&&t.track&&((l=t.track)===null||l===void 0?void 0:l.id)!==n.track.id?(v.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)):d.data.metadata&&n.onMetadata&&n.onMetadata(d.data.metadata)},n.worker=i}function r(){t.track.removeEventListener("ended",r),function(i){const o=dE.get(i);if(o){(function(l){const h=vu.get(l);h&&(vu.delete(l),$s&&($s.removeSpeakers([h]),vu.size===0&&($s.destroy(),$s=null)))})(i),v1(i.track.id),dE.delete(i);try{var a,d;(a=o.controller)===null||a===void 0||a.terminate(),(d=o.worker)===null||d===void 0||d.terminate()}catch(l){v.warning(l&&l.message)}}}(t)}dE.set(t,n),t.track.addEventListener("ended",r)},interceptLocalVideoFrame:async function(t,e){if(!Ie().supportWebRTCEncodedTransform)return void v.warning("browser not support video encoded transform");if(lE.has(t)||!t.track)return;const n={track:t.track};if(ga()){if(!t.createEncodedStreams)return void v.warning("browser not support createEncodedStreams() API");let i=null;try{i=t.createEncodedStreams()}catch(d){return void v.error("create video-encoded-streams error",d&&d.message)}const o=[];e.on("sei-to-send",d=>{o.push(d)});const a=new TransformStream({transform(d,l){n.controller||(n.controller=l),t.track&&t.track.id!==n.track.id&&(v.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));const h=o.shift();h&&(d.data=function(f,m){const T=function(P){const x=P.length;let W=[],H=0;for(;H<x;)H+2<x&&P[H]===0&&P[H+1]===0&&(P[H+2]===0||P[H+2]===1||P[H+2]===2||P[H+2]===3)?(W.push(P[H],P[H+1],3,P[H+2]),H+=3):(W.push(P[H]),H++);return new Uint8Array(W)}(m),S=T.length,w=Math.floor(S/255),I=S%255,C=new Uint8Array(6+w+1+S+f.byteLength);C[0]=0,C[1]=0,C[2]=0,C[3]=1,C[4]=6,C[5]=101;let N=0;for(;N<w;)C[6+N]=255,N++;return C[6+N]=I,N++,C.set(T,6+N),C.set(new Uint8Array(f),6+N+S),C.buffer}(d.data,h)),l.enqueue(d)}});i.readable.pipeThrough(a).pipeTo(i.writable)}else{if(!Sr())return;{if(typeof RTCRtpScriptTransform>"u")return void v.warning("browser not support RTCRtpScriptTransform");const i=nE(),o=new MessageChannel;await new mt(d=>i.onmessage=l=>{l.data==="registered"&&d(void 0)});const a=new RTCRtpScriptTransform(i,{name:"sei-tx",port:o.port2},[o.port2]);t.transform=a,await new mt(d=>i.onmessage=l=>{l.data==="started"&&d(void 0)}),e.on("sei-to-send",d=>{o.port1.postMessage({sei:d})}),o.port1.onmessage=d=>{var l;d.data.transformed&&t.track&&((l=t.track)===null||l===void 0?void 0:l.id)!==n.track.id&&(v.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r))},n.worker=i}}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}const i=lE.get(t);if(i){lE.delete(t);try{var o,a;(o=i.controller)===null||o===void 0||o.terminate(),(a=i.worker)===null||a===void 0||a.terminate()}catch(d){v.warning(d&&d.message)}}}lE.set(t,n),t.track.addEventListener("ended",r)},interceptRemoteVideoFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Ie().supportWebRTCEncodedTransform)return void v.warning("browser not support video encoded transform");if(!t.track)return;if(gp.has(t)){const i=gp.get(t);return void(i&&(i.onSei=e.onSei))}const n={track:t.track,onSei:e.onSei};if(ga()){if(!t.createEncodedStreams)return void v.warning("browser not support createEncodedStreams() API");let i=null;try{i=t.createEncodedStreams()}catch(a){return void v.error("create video-encoded-streams error",a&&a.message)}const o=new TransformStream({transform(a,d){n.controller||(n.controller=d),t.track&&t.track.id!==n.track.id&&(v.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));const l=function(h){const f=new DataView(h.data);let m=0;for(;m+4<h.data.byteLength;){if(f.getUint8(m+0)===0&&f.getUint8(m+1)===0&&f.getUint8(m+2)===0&&f.getUint8(m+3)===1&&f.getUint8(m+4)===6){let T=m+6,S=0,w=0;for(;(w=f.getUint8(T++))===255;)S+=255;S+=w;const I=cQ(h.data,T,S);return new Uint8Array(I)}m++}return null}(a);l&&n.onSei&&n.onSei(l),d.enqueue(a)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else if(Sr()){if(typeof RTCRtpScriptTransform>"u")return void v.warning("browser not support RTCRtpScriptTransform");const i=nE(),o=new MessageChannel;await new mt(d=>i.onmessage=l=>{l.data==="registered"&&d(void 0)});const a=new RTCRtpScriptTransform(i,{name:"sei-rx",port:o.port2},[o.port2]);t.transform=a,await new mt(d=>i.onmessage=l=>{l.data==="started"&&d(void 0)}),o.port1.onmessage=d=>{var l;d.data.transformed&&t.track&&((l=t.track)===null||l===void 0?void 0:l.id)!==n.track.id?(v.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)):d.data.sei&&n.onSei&&n.onSei(d.data.sei)},n.worker=i}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}(function(i){const o=gp.get(i);if(o){gp.delete(i);try{var a,d;(a=o.controller)===null||a===void 0||a.terminate(),(d=o.worker)===null||d===void 0||d.terminate()}catch(l){v.warning(l&&l.message)}}})(t)}gp.set(t,n),t.track.addEventListener("ended",r)}},btt={name:"InterceptFrame",create:()=>wtt};qy(),Fe("PROCESS_ID","process-".concat(ze(8,""),"-").concat(ze(4,""),"-").concat(ze(4,""),"-").concat(ze(4,""),"-").concat(ze(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void v.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();v.debug("Loading global parameters from cache",e),Object.keys(e).forEach(r=>{if(Object.prototype.hasOwnProperty.call(tn,r)){const{value:i,expires:o}=e[r];if(o&&o<=n)return;Qs[r]=i,tn[r]=i}})}catch(e){v.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(Qs.AREAS)&&Qs.AREAS.length>0&&xR(Qs.AREAS,!0);const IV=(t,e,n)=>{v.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Fe(t,e,n)};Tc(QZ,!1),Tc(ttt,!1),Tc(k$,!1),Tc(utt,!1),Tc(zZ,!1),Tc(Rtt,!1),Tc(Att,!1),Tc(btt,!1);const Yn=function(t){const e=new _n,n=t,r={getListeners:e.getListeners.bind(e),on:(i,o)=>(function(a,d){a===Po.SECURITY_POLICY_VIOLATION&&ix(d,!0)}(i,o),e.on.bind(e)(i,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return rx(rx({},n),r)}({__TRACK_LIST__:uu,VERSION:is,BUILD:Jy,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:IV,getParameter:M,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;const n=await async function(r){let i;return Ie().supportUnifiedPlan?(r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"}),i=(await r.createOffer()).sdp):i=(await r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,i}(e);if(!n)return t;e.close(),e=null,t=function(r){const i={video:[],audio:[]};return r.match(/ VP8/i)&&i.video.push("VP8"),r.match(/ VP9/i)&&i.video.push("VP9"),r.match(/ AV1/i)&&i.video.push("AV1"),r.match(/ H264/i)&&i.video.push("H264"),r.match(/ H265/i)&&i.video.push("H265"),r.match(/ opus/i)&&i.audio.push("OPUS"),r.match(/ PCMU/i)&&i.audio.push("PCMU"),r.match(/ PCMA/i)&&i.audio.push("PCMA"),r.match(/ G722/i)&&i.audio.push("G722"),i}(n)}catch(e){throw new z(D.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){const t=bt.reportApiInvoke(null,{name:Kn.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:vn.TRACER});let e=!1;try{const o=window.RTCPeerConnection,a=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;e=!!(o&&a&&d),e&&Py()&&Ck(75)&&new o().close()}catch(o){return v.error("check system requirement failed: ",o),!1}let n=!1;const r=ve();r.name===Oe.CHROME&&Number(r.version)>=58&&(Js.engine.name!=="WebKit"||function(){const o=ve();if(Fm()){if(o.os===er.MAC_OS)return!0;if(o.os===er.IOS){const a=Js.os.version&&Js.os.version.split(".");if(a&&Number(a[0])===14&&a[1]&&Number(a[1])>=3||a&&Number(a[0])>14)return!0}}return!1}())&&(n=!0),(r.name===Oe.FIREFOX&&Number(r.version)>=56||r.name===Oe.OPERA&&Number(r.version)>=45||r.name===Oe.SAFARI&&Number(r.version)>=11||r.name==="WebKit"&&($r()||Is())&&r.osVersion&&Number(r.osVersion.split(".")[0])>=11||Pk()||ve().name===Oe.QQ)&&(n=!0),v.debug("checkSystemRequirements, api:",e,"browser",n);const i=e&&n;return t.onSuccess(i),i},getDevices:function(t){return Yi.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return Yi.getRecordingDevices(t)},getCameras:function(t){return Yi.getCamerasDevices(t)},getElectronScreenSources:CL,getPlaybackDevices:function(t){return Yi.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=ze(5,"client-"),r=bt.reportApiInvoke(null,{id:n,name:Kn.CREATE_CLIENT,options:[e],tag:vn.TRACER});try{(function(i){tr(i.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),tr(i.mode,"config.mode",["rtc","live","p2p"]),i.audioCodec!==void 0&&tr(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),i.proxyServer!==void 0&&ur(i.proxyServer,"config.proxyServer",1,1e4),i.turnServer!==void 0&&Fk(i.turnServer),i.httpRetryConfig!==void 0&&Vk(i.httpRetryConfig),i.websocketRetryConfig!==void 0&&Vk(i.websocketRetryConfig)})(e)}catch(i){throw r.onError(i),i}return(wk(16,0)||bk(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",v.debug("browser not support vp9, force use vp8")),Fe("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),r.onSuccess(),new L$(Ds(Ds({forceWaitGatewayResponse:!0},e),{},{role:ft(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),n)},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=M("CAMERA_CAPTURE_CONFIG"),n=ze(8,"track-cam-"),r=bt.reportApiInvoke(null,{id:n,tag:vn.TRACER,name:Kn.CREATE_CAM_VIDEO_TRACK,options:[dn({},t),e]});e&&(t.encoderConfig=e);const i=tE(t);let o=null;v.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{o=(await qi({video:i},n)).getVideoTracks()[0]||null}catch(d){throw r.onError(d),d}if(!o){const d=new et(D.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(d),d.throw(v)}t.optimizationMode&&hR(n,o,t,bo(t.encoderConfig));const a=new uR(o,t,i,t.scalabiltyMode?Xm(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return r.onSuccess(a.getTrackId()),v.info("create camera video success, trackId:",n),a},createCustomVideoTrack:function(t){const e=ze(8,"track-cus-"),n=bt.reportApiInvoke(null,{id:e,tag:vn.TRACER,name:Kn.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),r=new en(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Xm(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[Je.CUSTOM_TRACK]);return n.onSuccess(r.getTrackId()),v.info("create custom video track success with config",t,"trackId",r.getTrackId()),r},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=typeof e=="object"?function(T){return ML(T)}(e):void 0;n&&(e="auto");const r=ze(8,"track-scr-v-"),i=bt.reportApiInvoke(null,{id:r,tag:vn.TRACER,name:Kn.CREATE_SCREEN_VIDEO_TRACK,options:[dn({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const o=function(T){const S={};T.screenSourceType&&(S.mediaSource=T.screenSourceType),T.extensionId&&ga()&&(S.extensionId=T.extensionId);const{displaySurface:w,selfBrowserSurface:I,surfaceSwitching:C,systemAudio:N,preferCurrentTab:P}=T;(ap(107)||by(107)||Oy(93))&&(w&&(tr(w,"displaySurface",["browser","window","monitor"]),S.displaySurface=w),I?(tr(I,"selfBrowserSurface",["exclude","include"]),S.selfBrowserSurface=I):S.selfBrowserSurface="include",C&&(tr(C,"surfaceSwitching",["exclude","include"]),S.surfaceSwitching=C)),(ap(105)||by(105)||Oy(91))&&N&&(tr(N,"systemAudio",["exclude","include"]),S.systemAudio=N),(ap(94)||by(94)||Oy(80))&&P&&(S.preferCurrentTab=!0),T.electronScreenSourceId&&(S.sourceId=T.electronScreenSourceId);const x=T.encoderConfig?tR(T.encoderConfig):null;return S.mandatory={chromeMediaSource:"desktop",maxWidth:x?x.width:void 0,maxHeight:x?x.height:void 0},x&&(x.frameRate&&(typeof x.frameRate=="number"?(S.mandatory.maxFrameRate=x.frameRate,S.mandatory.minFrameRate=x.frameRate):(S.mandatory.maxFrameRate=x.frameRate.max||x.frameRate.ideal||x.frameRate.exact||void 0,S.mandatory.minFrameRate=x.frameRate.min||x.frameRate.ideal||x.frameRate.exact||void 0),S.frameRate=x.frameRate),x.width&&(S.width=x.width),x.height&&(S.height=x.height)),S}(t);let a=null,d=null;const l=Ie();if(!l.supportShareAudio&&e==="enable"){const T=new et(D.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(T),T.throw(v)}v.info("start create screen video track with config",t,"withAudio",e,"trackId",r);const h=l.supportShareAudio&&e!=="disable";try{const T=await qi({screen:o,screenAudio:h?n||!0:void 0},r);a=T.getVideoTracks()[0]||null,d=T.getAudioTracks()[0]||null}catch(T){throw i.onError(T),T}if(!a){const T=new et(D.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(T),T.throw(v)}if(!d&&e==="enable"){a&&a.stop();const T=new et(D.SHARE_AUDIO_NOT_ALLOWED);return i.onError(T),T.throw(v)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(hR(r,a,t,t.encoderConfig&&tR(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const f=new en(a,t.encoderConfig?tR(t.encoderConfig):{},t.scalabiltyMode?Xm(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r,[Je.SCREEN_TRACK]);if(!d)return i.onSuccess(f.getTrackId()),v.info("create screen video track success","video:",f.getTrackId()),f;const m=new In(d,void 0,ze(8,"track-scr-a-"),!1);return i.onSuccess([f.getTrackId(),m.getTrackId()]),v.info("create screen video track success","video:",f.getTrackId(),"audio:",m.getTrackId()),[f,m]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=M("CAMERA_CAPTURE_CONFIG"),r=ze(8,"track-mic-"),i=ze(8,"track-cam-"),o=bt.reportApiInvoke(null,{id:"".concat(r,"-").concat(i),tag:vn.TRACER,name:Kn.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,n]});n&&(e.encoderConfig=n);const a=tE(e),d=UL(t);let l=null,h=null;v.info("start create camera video track(".concat(i,") and microphone audio track(").concat(r,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const T=await qi({audio:d,video:a},"".concat(r,"-").concat(i));l=T.getAudioTracks()[0],h=T.getVideoTracks()[0]}catch(T){throw o.onError(T),T}if(!l||!h){const T=new et(D.UNEXPECTED_ERROR,"can not find tracks in media stream");return o.onError(T),T.throw(v)}e.optimizationMode&&hR(i,h,e,bo(e.encoderConfig));const f=new eE(l,t,d,r),m=new uR(h,e,a,e.scalabiltyMode?Xm(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i);return o.onSuccess([f.getTrackId(),m.getTrackId()]),v.info("create camera video track(".concat(i,") and microphone audio track(").concat(r,") success")),[f,m]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=ze(8,"track-mic-"),n=bt.reportApiInvoke(null,{id:e,tag:vn.TRACER,name:Kn.CREATE_MIC_AUDIO_TRACK,options:[t]}),r=UL(t);let i=null;v.info("start create microphone audio track with config",JSON.stringify(t),"trackId",e);try{i=(await qi({audio:r},e)).getAudioTracks()[0]||null}catch(a){throw n.onError(a),a}if(!i){const a=new et(D.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(a),a.throw(v)}const o=new eE(i,t,r,e);return n.onSuccess(o.getTrackId()),v.info("create microphone audio track success, trackId:",e),o},createCustomAudioTrack:function(t){const e=ze(8,"track-cus-"),n=bt.reportApiInvoke(null,{id:e,tag:vn.TRACER,name:Kn.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),r=new In(t.mediaStreamTrack,t.encoderConfig?Qm(t.encoderConfig):{},e,!1);return v.info("create custom audio track success with config",t,"trackId",r.getTrackId()),n.onSuccess(r.getTrackId()),r},createBufferSourceAudioTrack:async function(t){var e;const{cacheOnlineFile:n,encoderConfig:r}=t;let{source:i}=t;const o={source:i instanceof AudioBuffer?"AudioBuffer":i instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":i,cacheOnlineFile:n,encoderConfig:r},a=ze(8,"track-buf-"),d=bt.reportApiInvoke(null,{id:a,tag:vn.TRACER,name:Kn.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(M("DISABLE_WEBAUDIO"))throw new et(D.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");v.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);const l=i;if(!(i instanceof AudioBuffer))try{i=await async function(m,T){let S=null;if(typeof m=="string"){const I=yM.get(m);if(I)return v.debug("use cached audio resource: ",m),I;try{S=(await Xs(()=>ai.get(m,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(C){throw new et(D.FETCH_AUDIO_FILE_FAILED,C.toString())}}else S=await new mt((C,N)=>{const P=new FileReader;P.onload=x=>{x.target?C(x.target.result):N(new et(D.READ_LOCAL_AUDIO_FILE_ERROR))},P.onerror=()=>{N(new et(D.READ_LOCAL_AUDIO_FILE_ERROR))},P.readAsArrayBuffer(m)});const w=await function(I){const C=Eu();return new mt((N,P)=>{C.decodeAudioData(I,x=>{N(x)},x=>{P(new et(D.DECODE_AUDIO_FILE_FAILED,x.toString()))})})}(S);return typeof m=="string"&&T&&yM.set(m,w),w}(i,n)}catch(m){return d.onError(m),m.throw(v)}const h=new tQ(i),f=new ZX(l,h,r?Qm(r):{},a);return v.info("create buffer source audio track success, trackId:",a),d.onSuccess(f.getTrackId()),f},setAppType:function(t){if(v.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw v.debug("Invalid appType"),new z(D.INVALID_PARAMS,"invalid app type",t);Fe("APP_TYPE",Math.floor(t))},setLogLevel:function(t){v.setLogLevel(t)},enableLogUpload:function(){M("USE_NEW_LOG")?Fe("UPLOAD_LOG",!0):v.enableLogUpload()},disableLogUpload:function(){M("USE_NEW_LOG")?Fe("UPLOAD_LOG",!1):v.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new yU},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=bt.reportApiInvoke(null,{tag:vn.TRACER,name:Kn.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof In||t instanceof Su)){const l=new z(D.INVALID_TRACK,"the parameter is not a audio track");return n.onError(l),l.throw()}e&&e<1e3&&(e=1e3);const r=t instanceof In?t.getTrackLabel():"remote_track",i=t.getVolumeLevel();let o=i,a=i;const d=Date.now();return new mt(l=>{const h=setInterval(()=>{const f=t.getVolumeLevel();o=f>o?f:o,a=f<a?f:a;const m=o-a>1e-4,T=Date.now()-d;if(m||T>e){clearInterval(h);const S=m,w={duration:T,deviceLabel:r,maxVolumeLevel:o,result:S};v.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(w))),n.onSuccess(w),l(S)}},200)})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=bt.reportApiInvoke(null,{tag:vn.TRACER,name:Kn.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof en||t instanceof Tu)){const m=new z(D.INVALID_TRACK,"the parameter is not a video track");return n.onError(m),m.throw()}e&&e<1e3&&(e=1e3);const r=t instanceof en?t.getTrackLabel():"remote_track",i=t.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Sr()||Fm())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([i]),o.play();const a=document.createElement("canvas");a.width=160,a.height=120;let d=0,l=0;try{const m=Date.now();d=await function(T,S,w,I){let C,N=0,P=null;return new mt((x,W)=>{function H(){N>I&&C&&(C(),x(N));const j=w.getContext("2d");if(!j){const Et=new z(D.UNEXPECTED_ERROR,"can not get canvas 2d context.");return v.error(Et.toString()),void W(Et)}j.drawImage(T,0,0,160,120);const $=j.getImageData(0,0,w.width,w.height),ct=Math.floor($.data.length/3);if(P){for(let Et=0;Et<ct;Et+=3)if($.data[Et]!==P[Et])return N+=1,void(P=$.data);P=$.data}else P=$.data}setTimeout(()=>{C&&(C(),x(N))},S),C=sR(()=>{H()},30)})}(o,e,a,4),l=Date.now()-m}catch(m){throw n.onError(m),m}T$===Oe.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const h=d>4,f={duration:l,changedPicNum:d,deviceLabel:r,result:h};return v.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(f))),n.onSuccess(f),h},setArea:xR,audioElementPlayCenter:ci,resumeAudioContext:function(){ci.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){U$.processExternalMediaAEC(t)},registerExtensions:function(t){const e=M("PLUGIN_INFO")||[];t.forEach(n=>{"name"in n&&!ft(e).call(e,n.name)&&e.push(n.name);const r=n;r.__registered__=!0,r.logger.hookLog=v.extLog,r.reporter.hookApiInvoke=bt.extApiInvoke,r.parameters&&Object.keys(r.parameters).forEach(i=>{r.parameters[i]=M(i)})}),IV("PLUGIN_INFO",e)},ChannelMediaRelayError:Ru,ChannelMediaRelayEvent:Ca,ChannelMediaRelayState:vi,RemoteStreamFallbackType:qX,RemoteStreamType:KX,ConnectionDisconnectedReason:ke,AudienceLatencyLevelType:yX,AREAS:Ne,preload:async function(t,e,n,r){return JU(t,e,n,r)}});return Object.defineProperties(Yn,{onAudioAutoplayFailed:{get:()=>zi.onAudioAutoplayFailed,set:t=>{zi.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>zi.onAutoplayFailed,set:t=>{zi.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Yn._onSecurityPolicyViolation,set(t){Yn._onSecurityPolicyViolation=t,ix(t)}},__CLIENT_LIST__:{get:()=>M("SHOW_GLOBAL_CLIENT_LIST")?Cd:[]}}),Yi.on(vd.CAMERA_DEVICE_CHANGED,t=>{v.info("camera device changed",JSON.stringify(t)),Yn.onCameraChanged&&Yn.onCameraChanged(t),Yn.safeEmit(Po.CAMERA_CHANGED,t)}),Yi.on(vd.RECORDING_DEVICE_CHANGED,t=>{v.info("microphone device changed",JSON.stringify(t)),Yn.onMicrophoneChanged&&Yn.onMicrophoneChanged(t),Yn.safeEmit(Po.MICROPHONE_CHANGED,t)}),Yi.on(vd.PLAYOUT_DEVICE_CHANGED,t=>{v.debug("playout device changed",JSON.stringify(t)),Yn.onPlaybackDeviceChanged&&Yn.onPlaybackDeviceChanged(t),Yn.safeEmit(Po.PLAYBACK_DEVICE_CHANGED,t)}),ci.onAutoplayFailed=()=>{v.info("detect audio element autoplay failed"),zi.onAudioAutoplayFailed&&zi.onAudioAutoplayFailed()},Be.on("autoplay-failed",()=>{v.info("detect webaudio autoplay failed"),zi.onAudioAutoplayFailed&&zi.onAudioAutoplayFailed(),Yn.safeEmit(Po.AUTOPLAY_FAILED)}),Be.on(fr.STATE_CHANGE,(t,e)=>{v.info("audio context state changed: ".concat(e," => ").concat(t)),Yn.onAudioContextStateChanged&&Yn.onAudioContextStateChanged(t,e),Yn.safeEmit(Po.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),Fn.on(su.NETWORK_STATE_CHANGE,(t,e)=>{v.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=Yn),Yn})}(ef)),ef.exports}var VV=xV();const nf=PI(VV);var rf={exports:{}},sf={exports:{}},Pn={};/** @license React v16.13.1
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var FI;function FV(){if(FI)return Pn;FI=1;var u=typeof Symbol=="function"&&Symbol.for,s=u?Symbol.for("react.element"):60103,c=u?Symbol.for("react.portal"):60106,p=u?Symbol.for("react.fragment"):60107,_=u?Symbol.for("react.strict_mode"):60108,g=u?Symbol.for("react.profiler"):60114,y=u?Symbol.for("react.provider"):60109,O=u?Symbol.for("react.context"):60110,L=u?Symbol.for("react.async_mode"):60111,V=u?Symbol.for("react.concurrent_mode"):60111,G=u?Symbol.for("react.forward_ref"):60112,tt=u?Symbol.for("react.suspense"):60113,st=u?Symbol.for("react.suspense_list"):60120,ht=u?Symbol.for("react.memo"):60115,yt=u?Symbol.for("react.lazy"):60116,Vt=u?Symbol.for("react.block"):60121,wt=u?Symbol.for("react.fundamental"):60117,te=u?Symbol.for("react.responder"):60118,Nt=u?Symbol.for("react.scope"):60119;function oe(It){if(typeof It=="object"&&It!==null){var ae=It.$$typeof;switch(ae){case s:switch(It=It.type,It){case L:case V:case p:case g:case _:case tt:return It;default:switch(It=It&&It.$$typeof,It){case O:case G:case yt:case ht:case y:return It;default:return ae}}case c:return ae}}}function Lt(It){return oe(It)===V}return Pn.AsyncMode=L,Pn.ConcurrentMode=V,Pn.ContextConsumer=O,Pn.ContextProvider=y,Pn.Element=s,Pn.ForwardRef=G,Pn.Fragment=p,Pn.Lazy=yt,Pn.Memo=ht,Pn.Portal=c,Pn.Profiler=g,Pn.StrictMode=_,Pn.Suspense=tt,Pn.isAsyncMode=function(It){return Lt(It)||oe(It)===L},Pn.isConcurrentMode=Lt,Pn.isContextConsumer=function(It){return oe(It)===O},Pn.isContextProvider=function(It){return oe(It)===y},Pn.isElement=function(It){return typeof It=="object"&&It!==null&&It.$$typeof===s},Pn.isForwardRef=function(It){return oe(It)===G},Pn.isFragment=function(It){return oe(It)===p},Pn.isLazy=function(It){return oe(It)===yt},Pn.isMemo=function(It){return oe(It)===ht},Pn.isPortal=function(It){return oe(It)===c},Pn.isProfiler=function(It){return oe(It)===g},Pn.isStrictMode=function(It){return oe(It)===_},Pn.isSuspense=function(It){return oe(It)===tt},Pn.isValidElementType=function(It){return typeof It=="string"||typeof It=="function"||It===p||It===V||It===g||It===_||It===tt||It===st||typeof It=="object"&&It!==null&&(It.$$typeof===yt||It.$$typeof===ht||It.$$typeof===y||It.$$typeof===O||It.$$typeof===G||It.$$typeof===wt||It.$$typeof===te||It.$$typeof===Nt||It.$$typeof===Vt)},Pn.typeOf=oe,Pn}var Dn={};/** @license React v16.13.1
 * react-is.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var BI;function BV(){return BI||(BI=1,process.env.NODE_ENV!=="production"&&function(){var u=typeof Symbol=="function"&&Symbol.for,s=u?Symbol.for("react.element"):60103,c=u?Symbol.for("react.portal"):60106,p=u?Symbol.for("react.fragment"):60107,_=u?Symbol.for("react.strict_mode"):60108,g=u?Symbol.for("react.profiler"):60114,y=u?Symbol.for("react.provider"):60109,O=u?Symbol.for("react.context"):60110,L=u?Symbol.for("react.async_mode"):60111,V=u?Symbol.for("react.concurrent_mode"):60111,G=u?Symbol.for("react.forward_ref"):60112,tt=u?Symbol.for("react.suspense"):60113,st=u?Symbol.for("react.suspense_list"):60120,ht=u?Symbol.for("react.memo"):60115,yt=u?Symbol.for("react.lazy"):60116,Vt=u?Symbol.for("react.block"):60121,wt=u?Symbol.for("react.fundamental"):60117,te=u?Symbol.for("react.responder"):60118,Nt=u?Symbol.for("react.scope"):60119;function oe(jt){return typeof jt=="string"||typeof jt=="function"||jt===p||jt===V||jt===g||jt===_||jt===tt||jt===st||typeof jt=="object"&&jt!==null&&(jt.$$typeof===yt||jt.$$typeof===ht||jt.$$typeof===y||jt.$$typeof===O||jt.$$typeof===G||jt.$$typeof===wt||jt.$$typeof===te||jt.$$typeof===Nt||jt.$$typeof===Vt)}function Lt(jt){if(typeof jt=="object"&&jt!==null){var qr=jt.$$typeof;switch(qr){case s:var ps=jt.type;switch(ps){case L:case V:case p:case g:case _:case tt:return ps;default:var Yr=ps&&ps.$$typeof;switch(Yr){case O:case G:case yt:case ht:case y:return Yr;default:return qr}}case c:return qr}}}var It=L,ae=V,J=O,q=y,K=s,Z=G,rt=p,nt=yt,X=ht,ee=c,xn=g,ne=_,nn=tt,lr=!1;function an(jt){return lr||(lr=!0,console.warn("The ReactIs.isAsyncMode() alias has been deprecated, and will be removed in React 17+. Update your code to use ReactIs.isConcurrentMode() instead. It has the exact same API.")),Pt(jt)||Lt(jt)===L}function Pt(jt){return Lt(jt)===V}function zt(jt){return Lt(jt)===O}function Te(jt){return Lt(jt)===y}function Ot(jt){return typeof jt=="object"&&jt!==null&&jt.$$typeof===s}function Bt(jt){return Lt(jt)===G}function re(jt){return Lt(jt)===p}function ie(jt){return Lt(jt)===yt}function we(jt){return Lt(jt)===ht}function Zt(jt){return Lt(jt)===c}function me(jt){return Lt(jt)===g}function fe(jt){return Lt(jt)===_}function Hn(jt){return Lt(jt)===tt}Dn.AsyncMode=It,Dn.ConcurrentMode=ae,Dn.ContextConsumer=J,Dn.ContextProvider=q,Dn.Element=K,Dn.ForwardRef=Z,Dn.Fragment=rt,Dn.Lazy=nt,Dn.Memo=X,Dn.Portal=ee,Dn.Profiler=xn,Dn.StrictMode=ne,Dn.Suspense=nn,Dn.isAsyncMode=an,Dn.isConcurrentMode=Pt,Dn.isContextConsumer=zt,Dn.isContextProvider=Te,Dn.isElement=Ot,Dn.isForwardRef=Bt,Dn.isFragment=re,Dn.isLazy=ie,Dn.isMemo=we,Dn.isPortal=Zt,Dn.isProfiler=me,Dn.isStrictMode=fe,Dn.isSuspense=Hn,Dn.isValidElementType=oe,Dn.typeOf=Lt}()),Dn}var jI;function GI(){return jI||(jI=1,process.env.NODE_ENV==="production"?sf.exports=FV():sf.exports=BV()),sf.exports}/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var dg,WI;function jV(){if(WI)return dg;WI=1;var u=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable;function p(g){if(g==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(g)}function _(){try{if(!Object.assign)return!1;var g=new String("abc");if(g[5]="de",Object.getOwnPropertyNames(g)[0]==="5")return!1;for(var y={},O=0;O<10;O++)y["_"+String.fromCharCode(O)]=O;var L=Object.getOwnPropertyNames(y).map(function(G){return y[G]});if(L.join("")!=="0123456789")return!1;var V={};return"abcdefghijklmnopqrst".split("").forEach(function(G){V[G]=G}),Object.keys(Object.assign({},V)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}return dg=_()?Object.assign:function(g,y){for(var O,L=p(g),V,G=1;G<arguments.length;G++){O=Object(arguments[G]);for(var tt in O)s.call(O,tt)&&(L[tt]=O[tt]);if(u){V=u(O);for(var st=0;st<V.length;st++)c.call(O,V[st])&&(L[V[st]]=O[V[st]])}}return L},dg}var lg,HI;function ug(){if(HI)return lg;HI=1;var u="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";return lg=u,lg}var hg,KI;function qI(){return KI||(KI=1,hg=Function.call.bind(Object.prototype.hasOwnProperty)),hg}var pg,YI;function GV(){if(YI)return pg;YI=1;var u=function(){};if(process.env.NODE_ENV!=="production"){var s=ug(),c={},p=qI();u=function(g){var y="Warning: "+g;typeof console<"u"&&console.error(y);try{throw new Error(y)}catch{}}}function _(g,y,O,L,V){if(process.env.NODE_ENV!=="production"){for(var G in g)if(p(g,G)){var tt;try{if(typeof g[G]!="function"){var st=Error((L||"React class")+": "+O+" type `"+G+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof g[G]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw st.name="Invariant Violation",st}tt=g[G](y,G,L,O,null,s)}catch(yt){tt=yt}if(tt&&!(tt instanceof Error)&&u((L||"React class")+": type specification of "+O+" `"+G+"` is invalid; the type checker function must return `null` or an `Error` but returned a "+typeof tt+". You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument)."),tt instanceof Error&&!(tt.message in c)){c[tt.message]=!0;var ht=V?V():"";u("Failed "+O+" type: "+tt.message+(ht??""))}}}}return _.resetWarningCache=function(){process.env.NODE_ENV!=="production"&&(c={})},pg=_,pg}var fg,zI;function WV(){if(zI)return fg;zI=1;var u=GI(),s=jV(),c=ug(),p=qI(),_=GV(),g=function(){};process.env.NODE_ENV!=="production"&&(g=function(O){var L="Warning: "+O;typeof console<"u"&&console.error(L);try{throw new Error(L)}catch{}});function y(){return null}return fg=function(O,L){var V=typeof Symbol=="function"&&Symbol.iterator,G="@@iterator";function tt(Pt){var zt=Pt&&(V&&Pt[V]||Pt[G]);if(typeof zt=="function")return zt}var st="<<anonymous>>",ht={array:te("array"),bigint:te("bigint"),bool:te("boolean"),func:te("function"),number:te("number"),object:te("object"),string:te("string"),symbol:te("symbol"),any:Nt(),arrayOf:oe,element:Lt(),elementType:It(),instanceOf:ae,node:Z(),objectOf:q,oneOf:J,oneOfType:K,shape:nt,exact:X};function yt(Pt,zt){return Pt===zt?Pt!==0||1/Pt===1/zt:Pt!==Pt&&zt!==zt}function Vt(Pt,zt){this.message=Pt,this.data=zt&&typeof zt=="object"?zt:{},this.stack=""}Vt.prototype=Error.prototype;function wt(Pt){if(process.env.NODE_ENV!=="production")var zt={},Te=0;function Ot(re,ie,we,Zt,me,fe,Hn){if(Zt=Zt||st,fe=fe||we,Hn!==c){if(L){var jt=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use `PropTypes.checkPropTypes()` to call them. Read more at http://fb.me/use-check-prop-types");throw jt.name="Invariant Violation",jt}else if(process.env.NODE_ENV!=="production"&&typeof console<"u"){var qr=Zt+":"+we;!zt[qr]&&Te<3&&(g("You are manually calling a React.PropTypes validation function for the `"+fe+"` prop on `"+Zt+"`. This is deprecated and will throw in the standalone `prop-types` package. You may be seeing this warning due to a third-party PropTypes library. See https://fb.me/react-warning-dont-call-proptypes for details."),zt[qr]=!0,Te++)}}return ie[we]==null?re?ie[we]===null?new Vt("The "+me+" `"+fe+"` is marked as required "+("in `"+Zt+"`, but its value is `null`.")):new Vt("The "+me+" `"+fe+"` is marked as required in "+("`"+Zt+"`, but its value is `undefined`.")):null:Pt(ie,we,Zt,me,fe)}var Bt=Ot.bind(null,!1);return Bt.isRequired=Ot.bind(null,!0),Bt}function te(Pt){function zt(Te,Ot,Bt,re,ie,we){var Zt=Te[Ot],me=ne(Zt);if(me!==Pt){var fe=nn(Zt);return new Vt("Invalid "+re+" `"+ie+"` of type "+("`"+fe+"` supplied to `"+Bt+"`, expected ")+("`"+Pt+"`."),{expectedType:Pt})}return null}return wt(zt)}function Nt(){return wt(y)}function oe(Pt){function zt(Te,Ot,Bt,re,ie){if(typeof Pt!="function")return new Vt("Property `"+ie+"` of component `"+Bt+"` has invalid PropType notation inside arrayOf.");var we=Te[Ot];if(!Array.isArray(we)){var Zt=ne(we);return new Vt("Invalid "+re+" `"+ie+"` of type "+("`"+Zt+"` supplied to `"+Bt+"`, expected an array."))}for(var me=0;me<we.length;me++){var fe=Pt(we,me,Bt,re,ie+"["+me+"]",c);if(fe instanceof Error)return fe}return null}return wt(zt)}function Lt(){function Pt(zt,Te,Ot,Bt,re){var ie=zt[Te];if(!O(ie)){var we=ne(ie);return new Vt("Invalid "+Bt+" `"+re+"` of type "+("`"+we+"` supplied to `"+Ot+"`, expected a single ReactElement."))}return null}return wt(Pt)}function It(){function Pt(zt,Te,Ot,Bt,re){var ie=zt[Te];if(!u.isValidElementType(ie)){var we=ne(ie);return new Vt("Invalid "+Bt+" `"+re+"` of type "+("`"+we+"` supplied to `"+Ot+"`, expected a single ReactElement type."))}return null}return wt(Pt)}function ae(Pt){function zt(Te,Ot,Bt,re,ie){if(!(Te[Ot]instanceof Pt)){var we=Pt.name||st,Zt=an(Te[Ot]);return new Vt("Invalid "+re+" `"+ie+"` of type "+("`"+Zt+"` supplied to `"+Bt+"`, expected ")+("instance of `"+we+"`."))}return null}return wt(zt)}function J(Pt){if(!Array.isArray(Pt))return process.env.NODE_ENV!=="production"&&(arguments.length>1?g("Invalid arguments supplied to oneOf, expected an array, got "+arguments.length+" arguments. A common mistake is to write oneOf(x, y, z) instead of oneOf([x, y, z])."):g("Invalid argument supplied to oneOf, expected an array.")),y;function zt(Te,Ot,Bt,re,ie){for(var we=Te[Ot],Zt=0;Zt<Pt.length;Zt++)if(yt(we,Pt[Zt]))return null;var me=JSON.stringify(Pt,function(Hn,jt){var qr=nn(jt);return qr==="symbol"?String(jt):jt});return new Vt("Invalid "+re+" `"+ie+"` of value `"+String(we)+"` "+("supplied to `"+Bt+"`, expected one of "+me+"."))}return wt(zt)}function q(Pt){function zt(Te,Ot,Bt,re,ie){if(typeof Pt!="function")return new Vt("Property `"+ie+"` of component `"+Bt+"` has invalid PropType notation inside objectOf.");var we=Te[Ot],Zt=ne(we);if(Zt!=="object")return new Vt("Invalid "+re+" `"+ie+"` of type "+("`"+Zt+"` supplied to `"+Bt+"`, expected an object."));for(var me in we)if(p(we,me)){var fe=Pt(we,me,Bt,re,ie+"."+me,c);if(fe instanceof Error)return fe}return null}return wt(zt)}function K(Pt){if(!Array.isArray(Pt))return process.env.NODE_ENV!=="production"&&g("Invalid argument supplied to oneOfType, expected an instance of array."),y;for(var zt=0;zt<Pt.length;zt++){var Te=Pt[zt];if(typeof Te!="function")return g("Invalid argument supplied to oneOfType. Expected an array of check functions, but received "+lr(Te)+" at index "+zt+"."),y}function Ot(Bt,re,ie,we,Zt){for(var me=[],fe=0;fe<Pt.length;fe++){var Hn=Pt[fe],jt=Hn(Bt,re,ie,we,Zt,c);if(jt==null)return null;jt.data&&p(jt.data,"expectedType")&&me.push(jt.data.expectedType)}var qr=me.length>0?", expected one of type ["+me.join(", ")+"]":"";return new Vt("Invalid "+we+" `"+Zt+"` supplied to "+("`"+ie+"`"+qr+"."))}return wt(Ot)}function Z(){function Pt(zt,Te,Ot,Bt,re){return ee(zt[Te])?null:new Vt("Invalid "+Bt+" `"+re+"` supplied to "+("`"+Ot+"`, expected a ReactNode."))}return wt(Pt)}function rt(Pt,zt,Te,Ot,Bt){return new Vt((Pt||"React class")+": "+zt+" type `"+Te+"."+Ot+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+Bt+"`.")}function nt(Pt){function zt(Te,Ot,Bt,re,ie){var we=Te[Ot],Zt=ne(we);if(Zt!=="object")return new Vt("Invalid "+re+" `"+ie+"` of type `"+Zt+"` "+("supplied to `"+Bt+"`, expected `object`."));for(var me in Pt){var fe=Pt[me];if(typeof fe!="function")return rt(Bt,re,ie,me,nn(fe));var Hn=fe(we,me,Bt,re,ie+"."+me,c);if(Hn)return Hn}return null}return wt(zt)}function X(Pt){function zt(Te,Ot,Bt,re,ie){var we=Te[Ot],Zt=ne(we);if(Zt!=="object")return new Vt("Invalid "+re+" `"+ie+"` of type `"+Zt+"` "+("supplied to `"+Bt+"`, expected `object`."));var me=s({},Te[Ot],Pt);for(var fe in me){var Hn=Pt[fe];if(p(Pt,fe)&&typeof Hn!="function")return rt(Bt,re,ie,fe,nn(Hn));if(!Hn)return new Vt("Invalid "+re+" `"+ie+"` key `"+fe+"` supplied to `"+Bt+"`.\nBad object: "+JSON.stringify(Te[Ot],null,"  ")+`
Valid keys: `+JSON.stringify(Object.keys(Pt),null,"  "));var jt=Hn(we,fe,Bt,re,ie+"."+fe,c);if(jt)return jt}return null}return wt(zt)}function ee(Pt){switch(typeof Pt){case"number":case"string":case"undefined":return!0;case"boolean":return!Pt;case"object":if(Array.isArray(Pt))return Pt.every(ee);if(Pt===null||O(Pt))return!0;var zt=tt(Pt);if(zt){var Te=zt.call(Pt),Ot;if(zt!==Pt.entries){for(;!(Ot=Te.next()).done;)if(!ee(Ot.value))return!1}else for(;!(Ot=Te.next()).done;){var Bt=Ot.value;if(Bt&&!ee(Bt[1]))return!1}}else return!1;return!0;default:return!1}}function xn(Pt,zt){return Pt==="symbol"?!0:zt?zt["@@toStringTag"]==="Symbol"||typeof Symbol=="function"&&zt instanceof Symbol:!1}function ne(Pt){var zt=typeof Pt;return Array.isArray(Pt)?"array":Pt instanceof RegExp?"object":xn(zt,Pt)?"symbol":zt}function nn(Pt){if(typeof Pt>"u"||Pt===null)return""+Pt;var zt=ne(Pt);if(zt==="object"){if(Pt instanceof Date)return"date";if(Pt instanceof RegExp)return"regexp"}return zt}function lr(Pt){var zt=nn(Pt);switch(zt){case"array":case"object":return"an "+zt;case"boolean":case"date":case"regexp":return"a "+zt;default:return zt}}function an(Pt){return!Pt.constructor||!Pt.constructor.name?st:Pt.constructor.name}return ht.checkPropTypes=_,ht.resetWarningCache=_.resetWarningCache,ht.PropTypes=ht,ht},fg}var _g,JI;function HV(){if(JI)return _g;JI=1;var u=ug();function s(){}function c(){}return c.resetWarningCache=s,_g=function(){function p(y,O,L,V,G,tt){if(tt!==u){var st=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw st.name="Invariant Violation",st}}p.isRequired=p;function _(){return p}var g={array:p,bigint:p,bool:p,func:p,number:p,object:p,string:p,symbol:p,any:p,arrayOf:_,element:p,elementType:p,instanceOf:_,node:p,objectOf:_,oneOf:_,oneOfType:_,shape:_,exact:_,checkPropTypes:c,resetWarningCache:s};return g.PropTypes=g,g},_g}var XI;function KV(){if(XI)return rf.exports;if(XI=1,process.env.NODE_ENV!=="production"){var u=GI(),s=!0;rf.exports=WV()(u.isElement,s)}else rf.exports=HV()();return rf.exports}var qV=KV();const Dc=PI(qV),YV=nf.createClient({mode:"rtc",codec:"vp8"});let of=null;const QI=Ht.createContext(null),$I=({children:u,appId:s="130dccf9b3554bda87f8cf577f91c8c4",channel:c=null,token:p=null,uid:_=null,enabled:g=!0,startMuted:y=!0,onClientReady:O=()=>{}})=>{const[L,V]=Ht.useState(!1),[G,tt]=Ht.useState(!1),[st,ht]=Ht.useState([]),[yt,Vt]=Ht.useState(null),[wt,te]=Ht.useState(null),[Nt,oe]=Ht.useState(null),[Lt,It]=Ht.useState(!1),[ae,J]=Ht.useState(!1),[q,K]=Ht.useState(!1),[Z,rt]=Ht.useState(null),nt=Ht.useRef(YV),X=Ht.useRef({appId:s,channel:c,uid:_,enabled:g});Ht.useRef(!1);const ee=Ht.useRef(null);Ht.useRef(null),Ht.useEffect(()=>{X.current={appId:s,channel:c,uid:_,enabled:g},console.log("AgoraProvider: Updated props ref:",{appId:s,channel:c,uid:_,enabled:g})},[s,c,_,g]),Ht.useEffect(()=>{console.log("AgoraProvider: Props changed:",{appId:s,channel:c,uid:_,enabled:g}),typeof window<"u"&&!window.agoraClient&&(window.agoraClient={isVoiceEnabled:!1,isJoined:!1,client:nt.current},console.log("AgoraProvider: Initialized window.agoraClient"))},[s,c,_,g]),Ht.useEffect(()=>{console.log("AgoraProvider: Setting current channel:",c),te(c)},[c]),Ht.useEffect(()=>{if(!nt.current)return;const Ot=Bt=>{console.log(`Connection state changed to: ${Bt}`),Bt==="DISCONNECTED"?(V(!1),console.log("Disconnected from Agora")):Bt==="CONNECTED"&&(V(!0),Vt(null))};return nt.current.on("connection-state-change",Ot),()=>{nt.current.off("connection-state-change",Ot)}},[]),Ht.useEffect(()=>{if(!c||!g){console.log("AgoraProvider: Skipping initialization - channel or enabled is falsy",{channel:c,enabled:g});return}console.log("AgoraProvider: Initial setup for channel",c,"with UID",_);const Ot=async(Zt,me)=>{console.log("AgoraProvider: User published:",Zt.uid,me);try{await nt.current.subscribe(Zt,me),console.log("AgoraProvider: Subscribed to user:",Zt.uid,"mediaType:",me),me==="audio"&&(Zt.audioTrack.play(),console.log("AgoraProvider: Playing audio track for user:",Zt.uid)),ht(fe=>fe.some(Hn=>Hn.uid===Zt.uid)?fe:[...fe,Zt])}catch(fe){console.error("AgoraProvider: Error subscribing to user:",fe)}},Bt=(Zt,me)=>{console.log("AgoraProvider: User unpublished:",Zt.uid,me),me==="audio"&&Zt.audioTrack&&(Zt.audioTrack.stop(),console.log("AgoraProvider: Stopped audio track for user:",Zt.uid))},re=Zt=>{console.log("AgoraProvider: User joined:",Zt.uid),ht(me=>me.some(fe=>fe.uid===Zt.uid)?me:[...me,Zt])},ie=Zt=>{console.log("AgoraProvider: User left:",Zt.uid),ht(me=>me.filter(fe=>fe.uid!==Zt.uid))};nt.current.on("user-published",Ot),nt.current.on("user-unpublished",Bt),nt.current.on("user-joined",re),nt.current.on("user-left",ie);const we=async()=>{try{if(console.log("AgoraProvider: Starting initialization with client state:",nt.current.connectionState),nt.current.connectionState==="CONNECTED"&&ee.current===c){console.log("AgoraProvider: Client already connected to this channel, setting joined state to true"),V(!0),It(!0),O(nt.current);return}console.log("AgoraProvider: Initializing microphone");const Zt=await xn();console.log("AgoraProvider: Microphone initialized:",!!Zt),!L||ee.current!==c?(console.log("AgoraProvider: Joining channel",c,"current joined channel:",ee.current),await ne(),console.log("AgoraProvider: Join channel completed")):console.log("AgoraProvider: Already joined to channel",c)}catch(Zt){console.error("AgoraProvider: Error during initialization:",Zt)}};return console.log("AgoraProvider: Running initialization"),we(),()=>{console.log("AgoraProvider: Cleaning up event listeners"),nt.current.off("user-published",Ot),nt.current.off("user-unpublished",Bt),nt.current.off("user-joined",re),nt.current.off("user-left",ie)}},[c,g,_,O,L]);const xn=async()=>{if(!g||Nt)return Nt;console.log("Initializing microphone");try{const Ot=await nf.createMicrophoneAudioTrack();return await Ot.setMuted(y),oe(Ot),console.log("Microphone initialized successfully"),Ot}catch(Ot){return console.error("Error initializing microphone:",Ot),Vt("Failed to initialize microphone. Please check your permissions."),null}},ne=async()=>{if(!g)return console.log("AgoraProvider: Agora is disabled, not joining channel"),!1;if(!c)return console.error("AgoraProvider: No channel specified"),Vt("No channel specified"),!1;if(console.log("AgoraProvider: joinChannel called for channel",c,"with UID",_),console.log("AgoraProvider: Current state:",{isJoined:L,isJoining:ae,connectionState:nt.current.connectionState,joinedChannel:ee.current}),L&&ee.current===c)return console.log("AgoraProvider: Already joined to channel:",c),!0;if(ae)return console.log("AgoraProvider: Already in the process of joining"),!1;if(nt.current.connectionState==="CONNECTED")if(ee.current&&ee.current!==c){console.log("AgoraProvider: Connected to different channel, leaving first");try{await nn()}catch(Ot){console.error("AgoraProvider: Error leaving channel:",Ot)}}else return console.log("AgoraProvider: Client already connected, setting joined state to true"),V(!0),It(!0),ee.current=c,of=c,O(nt.current),!0;try{console.log("AgoraProvider: Joining channel:",c,"with UID:",_||"random"),J(!0);const Ot=_||Math.floor(Math.random()*1e6);if(await nt.current.join(s,c,p,Ot),console.log("AgoraProvider: Joined channel successfully with UID:",nt.current.uid),Nt){if(!Nt.muted&&G)try{await nt.current.publish(Nt),console.log("AgoraProvider: Published existing microphone track")}catch(Bt){!Bt.message||!Bt.message.includes("already published")?console.error("AgoraProvider: Error publishing microphone track:",Bt):console.log("AgoraProvider: Microphone track already published")}}else{const Bt=await xn();console.log("AgoraProvider: Microphone initialized in joinChannel:",!!Bt),Bt&&!y&&(await nt.current.publish(Bt),console.log("AgoraProvider: Published microphone track"))}return V(!0),J(!1),It(!0),ee.current=c,of=c,O(nt.current),!0}catch(Ot){return console.error("AgoraProvider: Error joining channel:",Ot),Ot.message&&(Ot.message.includes("already in connecting/connected state")||Ot.message.includes("INVALID_OPERATION"))?(console.log("AgoraProvider: Client already connected, considering join successful"),V(!0),J(!1),It(!0),ee.current=c,of=c,O(nt.current),!0):(Vt(`Failed to join channel: ${Ot.message}`),J(!1),!1)}},nn=async()=>{if(L)try{Nt&&await nt.current.unpublish(Nt),await nt.current.leave(),of=null,ee.current=null,console.log("Left channel successfully"),V(!1),ht([])}catch(Ot){console.error("Error leaving channel:",Ot),Vt(Ot.message||"Failed to leave channel")}};Ht.useEffect(()=>()=>{Nt&&Nt.close()},[]),Ht.useEffect(()=>{g&&c&&(!L||ee.current!==c)&&xn().then(()=>{ne()})},[g,c,L]);const lr=()=>{if(!Nt)return!1;try{return Nt.isActive&&!Nt.muted}catch(Ot){return console.error("Error checking microphone status:",Ot),!1}};Ht.useEffect(()=>{const Ot=()=>{const re=lr();re!==G&&(console.log("Syncing microphone state:",{actualStatus:re,currentState:G}),tt(re),window.dispatchEvent(new CustomEvent("VoiceToggled",{detail:{enabled:re}})),window.agoraClient&&(window.agoraClient.isVoiceEnabled=re,window.agoraClient.microphoneTrack=Nt))};Nt&&Ot();const Bt=setInterval(Ot,1e3);return()=>{clearInterval(Bt)}},[Nt,G]);const an=async()=>{var Ot;try{const Bt=G!==void 0?G:Nt?!Nt.muted:!1;if(console.log("AgoraProvider: Toggling voice, current state:",{isVoiceEnabled:G,currentState:Bt,hasMicTrack:!!Nt,trackMuted:Nt==null?void 0:Nt.muted}),!Nt&&(console.log("AgoraProvider: No microphone track, initializing..."),!await xn()))return console.error("AgoraProvider: Failed to initialize microphone"),Bt;const re=!Bt;if(console.log("AgoraProvider: New voice state will be:",re),Bt){if(Nt)try{console.log("AgoraProvider: Muting microphone track"),await Nt.setMuted(!0),Nt.muted||(console.warn("AgoraProvider: Track not muted after setMuted(true), trying again"),await Nt.setEnabled(!1)),console.log("AgoraProvider: Microphone track muted successfully, muted state:",Nt.muted)}catch(ie){return console.error("Error muting track:",ie),Bt}}else if(Nt)try{nt.current&&L&&!((Ot=nt.current.localTracks)!=null&&Ot.includes(Nt))&&(console.log("AgoraProvider: Publishing microphone track"),await nt.current.publish(Nt),console.log("AgoraProvider: Microphone track published successfully")),console.log("AgoraProvider: Unmuting microphone track"),await Nt.setMuted(!1),Nt.muted&&(console.warn("AgoraProvider: Track still muted after setMuted(false), trying again"),await Nt.setEnabled(!0)),console.log("AgoraProvider: Microphone track unmuted successfully, muted state:",Nt.muted)}catch(ie){return console.error("Error unmuting track:",ie),Bt}return console.log("AgoraProvider: Setting voice enabled state to:",re),tt(re),typeof window<"u"&&(window.agoraClient||(window.agoraClient={}),window.agoraClient.isVoiceEnabled=re,window.agoraClient.microphoneTrack=Nt,window.agoraClient.client=nt.current,console.log("AgoraProvider: Updated window.agoraClient with new state:",re)),typeof window<"u"&&(window.dispatchEvent(new CustomEvent("VoiceToggled",{detail:{enabled:re}})),console.log("AgoraProvider: Dispatched VoiceToggled event with enabled:",re)),await new Promise(ie=>setTimeout(ie,100)),re}catch(Bt){return console.error("Error toggling voice:",Bt),G}},Pt=async Ot=>{try{oe(Ot),console.log("Microphone track updated successfully")}catch(Bt){throw console.error("Error updating microphone track:",Bt),Bt}},zt=async()=>{if(!nt.current||!c)return console.error("AgoraProvider: Voice chat not connected"),!1;try{if(q)return console.log("AgoraProvider: Stopping screen share"),Z&&(Array.isArray(Z)?(await nt.current.unpublish(Z),Z.forEach(Ot=>Ot.close())):(await nt.current.unpublish(Z),Z.close()),rt(null)),K(!1),console.log("AgoraProvider: Screen sharing stopped"),typeof window<"u"&&(window.agoraClient||(window.agoraClient={}),window.agoraClient.isScreenSharing=!1,window.agoraClient.screenTrack=null),!1;console.log("AgoraProvider: Starting screen share");try{const Ot=await nf.createScreenVideoTrack({encoderConfig:"1080p_1",optimizationMode:"detail"});return console.log("AgoraProvider: Screen track created:",Ot),Ot.on("track-ended",()=>{console.log("AgoraProvider: Screen sharing ended by browser UI"),nt.current.unpublish(Ot),Ot.close(),rt(null),K(!1),typeof window<"u"&&(window.agoraClient||(window.agoraClient={}),window.agoraClient.isScreenSharing=!1,window.agoraClient.screenTrack=null)}),await nt.current.publish(Ot),rt(Ot),K(!0),console.log("AgoraProvider: Screen sharing started"),typeof window<"u"&&(window.agoraClient||(window.agoraClient={}),window.agoraClient.isScreenSharing=!0,window.agoraClient.screenTrack=Ot),!0}catch(Ot){return console.error("AgoraProvider: Error creating screen track:",Ot),K(!1),rt(null),!1}}catch(Ot){return console.error("AgoraProvider: Error toggling screen share:",Ot),K(!1),rt(null),!1}};Ht.useEffect(()=>(console.log("AgoraProvider: Initializing window.agoraClient"),typeof window<"u"&&(window.agoraClient={isVoiceEnabled:!1,isJoined:!1,client:nt.current}),()=>{typeof window<"u"&&window.agoraClient&&(console.log("AgoraProvider: Cleaning up window.agoraClient"),window.agoraClient=null)}),[]),Ht.useEffect(()=>{console.log("AgoraProvider: Voice enabled state changed:",G),typeof window<"u"&&(window.agoraClient||(window.agoraClient={}),window.agoraClient.isVoiceEnabled=G,window.agoraClient.microphoneTrack=Nt,window.agoraClient.client=nt.current,window.dispatchEvent(new CustomEvent("VoiceToggled",{detail:{enabled:G}})),console.log("AgoraProvider: Updated window.agoraClient and dispatched event:",{isVoiceEnabled:G}))},[G,Nt]);const Te={client:nt.current,isJoined:L,isVoiceEnabled:G,users:st,error:yt,channel:wt,appId:s,toggleVoice:an,leaveChannel:nn,joinChannel:ne,microphoneTrack:Nt,isReady:Lt,createMicrophoneTrack:Pt,isScreenSharing:q,screenTrack:Z,toggleScreenShare:zt};return Ze.jsx(QI.Provider,{value:Te,children:u})},mg=()=>{const u=Ht.useContext(QI);if(!u)throw new Error("useAgoraContext must be used within an AgoraProvider");return u};$I.propTypes={children:Dc.node.isRequired,appId:Dc.string.isRequired,channel:Dc.string.isRequired,token:Dc.string,uid:Dc.oneOfType([Dc.string,Dc.number])};const af=()=>{var ee,xn;const{client:u,isVoiceEnabled:s,isJoined:c,users:p,error:_,microphoneTrack:g,isReady:y,channel:O,appId:L,toggleVoice:V,joinChannel:G,leaveChannel:tt,createMicrophoneTrack:st,isScreenSharing:ht,screenTrack:yt,toggleScreenShare:Vt}=mg(),[wt,te]=Ht.useState(s!==void 0?s:((ee=window.agoraClient)==null?void 0:ee.isVoiceEnabled)||!1),[Nt,oe]=Ht.useState(ht!==void 0?ht:((xn=window.agoraClient)==null?void 0:xn.isScreenSharing)||!1),[Lt,It]=Ht.useState(!0);Ht.useEffect(()=>{var ne;s!==void 0?te(s):((ne=window.agoraClient)==null?void 0:ne.isVoiceEnabled)!==void 0?te(window.agoraClient.isVoiceEnabled):g&&te(!g.muted)},[s,g]),Ht.useEffect(()=>{var ne;ht!==void 0?oe(ht):((ne=window.agoraClient)==null?void 0:ne.isScreenSharing)!==void 0&&oe(window.agoraClient.isScreenSharing)},[ht]);const ae=Ht.useRef({isVoiceEnabled:wt,isScreenSharing:Nt,isJoined:c,users:p,error:_,isReady:y,channel:O,appId:L});Ht.useEffect(()=>{ae.current={isVoiceEnabled:wt,isScreenSharing:Nt,isJoined:c,users:p,error:_,isReady:y,channel:O,appId:L}},[wt,Nt,c,p,_,y,O,L]),Ht.useEffect(()=>{const ne=setTimeout(()=>{It(!1)},5e3);return()=>clearTimeout(ne)},[]),Ht.useEffect(()=>{y&&It(!1)},[y]),Ht.useEffect(()=>{console.log("useVoiceChat context:",{contextIsVoiceEnabled:s,localVoiceEnabled:wt,contextIsScreenSharing:ht,localScreenSharing:Nt,isJoined:c,users:p.length,error:_,isReady:y,channel:O,appId:L,hasMicrophoneTrack:!!g,trackMuted:g==null?void 0:g.muted,hasScreenTrack:!!yt})},[s,wt,ht,Nt,c,p,_,y,O,L,g,yt]);const J=async()=>{try{console.log("useVoiceChat: Toggling voice from:",wt);const ne=await V();if(console.log("useVoiceChat: Toggle result:",ne),ne!==void 0)te(ne);else{const nn=!wt;te(nn),window.agoraClient&&(window.agoraClient.isVoiceEnabled=nn)}return ne!==void 0?ne:!wt}catch(ne){return console.error("useVoiceChat: Error toggling voice:",ne),wt}},q=async()=>{try{console.log("useVoiceChat: Toggling screen share from:",Nt);const ne=await Vt();if(console.log("useVoiceChat: Screen share toggle result:",ne),ne!==void 0)oe(ne);else{const nn=!Nt;oe(nn),window.agoraClient&&(window.agoraClient.isScreenSharing=nn)}return ne!==void 0?ne:!Nt}catch(ne){return console.error("useVoiceChat: Error toggling screen share:",ne),Nt}},K=async()=>{wt&&g&&await J()},Z=async()=>{!wt&&g&&await J()},rt=ne=>p.some(nn=>{var lr;return nn.uid===ne&&((lr=nn.audioTrack)==null?void 0:lr.isPlaying)}),nt=Ht.useCallback(()=>{if(!g||!wt)return 0;try{return g.getVolumeLevel()}catch(ne){return console.error("Error getting volume level:",ne),0}},[g,wt]);return{isVoiceEnabled:wt,isScreenSharing:Nt,isJoined:c,users:p,error:_,toggleVoice:J,toggleScreenShare:q,mute:K,unmute:Z,isUserSpeaking:rt,getVolumeLevel:nt,microphoneTrack:g,screenTrack:yt,isLoading:Lt,channel:O,appId:L,joinChannel:G,leaveChannel:tt,client:u,setMicrophoneDevice:async ne=>{try{if(!ne){console.error("No device ID provided");return}if(!u||!c){console.error("Client not initialized or not joined to a channel");return}g&&(wt&&await u.unpublish(g),await g.close());const nn=await nf.createMicrophoneAudioTrack({microphoneId:ne,encoderConfig:"music_standard"});st&&await st(nn),wt&&await u.publish(nn),console.log("Microphone device changed successfully")}catch(nn){throw console.error("Error changing microphone device:",nn),nn}}}},cf=()=>{const u=new Date,s=u.getHours().toString().padStart(2,"0"),c=u.getMinutes().toString().padStart(2,"0"),p=u.getSeconds().toString().padStart(2,"0"),_=u.getMilliseconds().toString().padStart(3,"0");return`${s}:${c}:${p}.${_}`},Kd={log:(...u)=>{{const s=u.map((c,p)=>p===0&&typeof c=="string"?`
${c}`:c);console.log(`[LOG] [${cf()}] `,...s)}},error:(...u)=>{{const s=u.map((c,p)=>p===0&&typeof c=="string"?`
${c}`:c);console.error(`[ERROR] [${cf()}] `,...s)}},warn:(...u)=>{{const s=u.map((c,p)=>p===0&&typeof c=="string"?`
${c}`:c);console.warn(`[WARN] [${cf()}]`,...s)}},trace:u=>{console.trace(`[TRACE] [${cf()}] ${u}`)}},zV=({size:u="md",tooltipPlacement:s="top",defaultMuted:c=!0,joinOnClick:p=!0,className:_="voice-button"})=>{const{isVoiceEnabled:g,toggleVoice:y,isJoined:O,joinChannel:L,channel:V,client:G}=af(),[tt,st]=Ht.useState(!1),[ht,yt]=Ht.useState(!1);Ht.useEffect(()=>{const te=()=>{Kd.log("VoiceButton: Player instantiated, showing button"),yt(!0)};return window.addEventListener("PlayerInstantiated",te),window.isPlayerInstantiated&&(Kd.log("VoiceButton: Player was already instantiated"),yt(!0)),()=>{window.removeEventListener("PlayerInstantiated",te)}},[]),Ht.useEffect(()=>{console.log("VoiceButton: State:",{isVoiceEnabled:g,isJoined:O,channel:V,hasClient:!!G,clientState:G==null?void 0:G.connectionState,windowAgoraClient:window.agoraClient,isPlayerReady:ht})},[g,O,V,G,ht]);const Vt=async()=>{if(!tt){st(!0),console.log("VoiceButton: Handling click, current state:",{isVoiceEnabled:g,isJoined:O});try{if(!O&&p)try{console.log("VoiceButton: Not joined, attempting to join channel"),await L(),console.log("VoiceButton: Joined channel successfully")}catch(Nt){Nt.message&&Nt.message.includes("already in connecting/connected state")?console.log("VoiceButton: Already connected to channel"):console.error("VoiceButton: Error joining channel:",Nt)}console.log("VoiceButton: Toggling voice state from:",g);const te=await y();console.log("VoiceButton: Voice toggled, new state:",te)}catch(te){console.error("VoiceButton: Error toggling voice:",te)}finally{st(!1)}}},wt=()=>ht?tt?"Processing...":O?g?"Turn microphone off":"Turn microphone on":"Connecting to voice chat...":"Waiting for player to be ready...";return ht?Ze.jsx(Cr.Tooltip,{label:wt(),placement:s,hasArrow:!0,children:Ze.jsxs(Cr.Box,{position:"relative",cursor:"pointer",onClick:Vt,children:[Ze.jsx(Cr.Avatar,{size:u,borderRadius:"full",bg:g?"green.500":"red.500",icon:g?Ze.jsx(MV,{color:"white"}):Ze.jsx(LV,{color:"white"}),borderWidth:"1px",borderColor:"whiteAlpha.300",className:_,"data-testid":"voice-button"}),tt&&Ze.jsx(Cr.Box,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",display:"flex",alignItems:"center",justifyContent:"center",bg:"rgba(0, 0, 0, 0.6)",borderRadius:"full",children:Ze.jsx(Cr.Spinner,{size:"sm",color:"white"})})]})}):null},JV=({size:u="md",...s})=>{const{isScreenSharing:c,toggleScreenShare:p,isJoined:_,joinChannel:g}=af(),[y,O]=Ht.useState(!1),[L,V]=Ht.useState(!1),G=Cr.useToast();Ht.useEffect(()=>{const st=()=>{console.log("ScreenShareButton: Player instantiated"),O(!0)};return window.isPlayerInstantiated&&(console.log("ScreenShareButton: Player already instantiated"),O(!0)),window.addEventListener("PlayerInstantiated",st),()=>{window.removeEventListener("PlayerInstantiated",st)}},[]);const tt=async()=>{try{if(!_){G({title:"Not connected to voice chat",description:"You need to join voice chat before sharing your screen",status:"warning",duration:3e3,isClosable:!0});return}await p()?G({title:"Screen sharing started",status:"success",duration:3e3,isClosable:!0}):c&&G({title:"Screen sharing stopped",status:"info",duration:3e3,isClosable:!0})}catch(st){if(console.error("Error toggling screen share:",st),st.message&&(st.message.includes("already in connecting/connected state")||st.message.includes("INVALID_OPERATION"))){console.log("ScreenShareButton: Client already connected, trying again");try{await p()?G({title:"Screen sharing started",status:"success",duration:3e3,isClosable:!0}):c&&G({title:"Screen sharing stopped",status:"info",duration:3e3,isClosable:!0})}catch(ht){console.error("Error toggling screen share on retry:",ht),G({title:"Screen sharing error",description:ht.message||"Failed to toggle screen sharing",status:"error",duration:5e3,isClosable:!0})}}else G({title:"Screen sharing error",description:st.message||"Failed to toggle screen sharing",status:"error",duration:5e3,isClosable:!0})}};return y?Ze.jsx(Cr.Button,{onClick:tt,colorScheme:c?"red":"blue",size:u,leftIcon:Ze.jsx(Cr.Icon,{as:kV}),isLoading:L,loadingText:"Connecting...",...s,children:c?"Stop Sharing":"Share Screen"}):null};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ZI=function(u){const s=[];let c=0;for(let p=0;p<u.length;p++){let _=u.charCodeAt(p);_<128?s[c++]=_:_<2048?(s[c++]=_>>6|192,s[c++]=_&63|128):(_&64512)===55296&&p+1<u.length&&(u.charCodeAt(p+1)&64512)===56320?(_=65536+((_&1023)<<10)+(u.charCodeAt(++p)&1023),s[c++]=_>>18|240,s[c++]=_>>12&63|128,s[c++]=_>>6&63|128,s[c++]=_&63|128):(s[c++]=_>>12|224,s[c++]=_>>6&63|128,s[c++]=_&63|128)}return s},XV=function(u){const s=[];let c=0,p=0;for(;c<u.length;){const _=u[c++];if(_<128)s[p++]=String.fromCharCode(_);else if(_>191&&_<224){const g=u[c++];s[p++]=String.fromCharCode((_&31)<<6|g&63)}else if(_>239&&_<365){const g=u[c++],y=u[c++],O=u[c++],L=((_&7)<<18|(g&63)<<12|(y&63)<<6|O&63)-65536;s[p++]=String.fromCharCode(55296+(L>>10)),s[p++]=String.fromCharCode(56320+(L&1023))}else{const g=u[c++],y=u[c++];s[p++]=String.fromCharCode((_&15)<<12|(g&63)<<6|y&63)}}return s.join("")},tC={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(u,s){if(!Array.isArray(u))throw Error("encodeByteArray takes an array as a parameter");this.init_();const c=s?this.byteToCharMapWebSafe_:this.byteToCharMap_,p=[];for(let _=0;_<u.length;_+=3){const g=u[_],y=_+1<u.length,O=y?u[_+1]:0,L=_+2<u.length,V=L?u[_+2]:0,G=g>>2,tt=(g&3)<<4|O>>4;let st=(O&15)<<2|V>>6,ht=V&63;L||(ht=64,y||(st=64)),p.push(c[G],c[tt],c[st],c[ht])}return p.join("")},encodeString(u,s){return this.HAS_NATIVE_SUPPORT&&!s?btoa(u):this.encodeByteArray(ZI(u),s)},decodeString(u,s){return this.HAS_NATIVE_SUPPORT&&!s?atob(u):XV(this.decodeStringToByteArray(u,s))},decodeStringToByteArray(u,s){this.init_();const c=s?this.charToByteMapWebSafe_:this.charToByteMap_,p=[];for(let _=0;_<u.length;){const g=c[u.charAt(_++)],O=_<u.length?c[u.charAt(_)]:0;++_;const V=_<u.length?c[u.charAt(_)]:64;++_;const tt=_<u.length?c[u.charAt(_)]:64;if(++_,g==null||O==null||V==null||tt==null)throw new QV;const st=g<<2|O>>4;if(p.push(st),V!==64){const ht=O<<4&240|V>>2;if(p.push(ht),tt!==64){const yt=V<<6&192|tt;p.push(yt)}}}return p},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let u=0;u<this.ENCODED_VALS.length;u++)this.byteToCharMap_[u]=this.ENCODED_VALS.charAt(u),this.charToByteMap_[this.byteToCharMap_[u]]=u,this.byteToCharMapWebSafe_[u]=this.ENCODED_VALS_WEBSAFE.charAt(u),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[u]]=u,u>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(u)]=u,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(u)]=u)}}};class QV extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const $V=function(u){const s=ZI(u);return tC.encodeByteArray(s,!0)},df=function(u){return $V(u).replace(/\./g,"")},eC=function(u){try{return tC.decodeString(u,!0)}catch(s){console.error("base64Decode failed: ",s)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ZV(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const tF=()=>ZV().__FIREBASE_DEFAULTS__,eF=()=>{if(typeof process>"u"||typeof process.env>"u")return;const u=process.env.__FIREBASE_DEFAULTS__;if(u)return JSON.parse(u)},nF=()=>{if(typeof document>"u")return;let u;try{u=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const s=u&&eC(u[1]);return s&&JSON.parse(s)},lf=()=>{try{return tF()||eF()||nF()}catch(u){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${u}`);return}},nC=u=>{var s,c;return(c=(s=lf())===null||s===void 0?void 0:s.emulatorHosts)===null||c===void 0?void 0:c[u]},rF=u=>{const s=nC(u);if(!s)return;const c=s.lastIndexOf(":");if(c<=0||c+1===s.length)throw new Error(`Invalid host ${s} with no separate hostname and port!`);const p=parseInt(s.substring(c+1),10);return s[0]==="["?[s.substring(1,c-1),p]:[s.substring(0,c),p]},rC=()=>{var u;return(u=lf())===null||u===void 0?void 0:u.config},iC=u=>{var s;return(s=lf())===null||s===void 0?void 0:s[`_${u}`]};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iF{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((s,c)=>{this.resolve=s,this.reject=c})}wrapCallback(s){return(c,p)=>{c?this.reject(c):this.resolve(p),typeof s=="function"&&(this.promise.catch(()=>{}),s.length===1?s(c):s(c,p))}}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function sF(u,s){if(u.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const c={alg:"none",type:"JWT"},p=s||"demo-project",_=u.iat||0,g=u.sub||u.user_id;if(!g)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const y=Object.assign({iss:`https://securetoken.google.com/${p}`,aud:p,iat:_,exp:_+3600,auth_time:_,sub:g,user_id:g,firebase:{sign_in_provider:"custom",identities:{}}},u);return[df(JSON.stringify(c)),df(JSON.stringify(y)),""].join(".")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fi(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function oF(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(fi())}function aF(){var u;const s=(u=lf())===null||u===void 0?void 0:u.forceEnvironment;if(s==="node")return!0;if(s==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function cF(){return typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"}function dF(){const u=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof u=="object"&&u.id!==void 0}function lF(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function uF(){const u=fi();return u.indexOf("MSIE ")>=0||u.indexOf("Trident/")>=0}function hF(){return!aF()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function pF(){try{return typeof indexedDB=="object"}catch{return!1}}function fF(){return new Promise((u,s)=>{try{let c=!0;const p="validate-browser-context-for-indexeddb-analytics-module",_=self.indexedDB.open(p);_.onsuccess=()=>{_.result.close(),c||self.indexedDB.deleteDatabase(p),u(!0)},_.onupgradeneeded=()=>{c=!1},_.onerror=()=>{var g;s(((g=_.error)===null||g===void 0?void 0:g.message)||"")}}catch(c){s(c)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _F="FirebaseError";class Wo extends Error{constructor(s,c,p){super(c),this.code=s,this.customData=p,this.name=_F,Object.setPrototypeOf(this,Wo.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Ku.prototype.create)}}class Ku{constructor(s,c,p){this.service=s,this.serviceName=c,this.errors=p}create(s,...c){const p=c[0]||{},_=`${this.service}/${s}`,g=this.errors[s],y=g?mF(g,p):"Error",O=`${this.serviceName}: ${y} (${_}).`;return new Wo(_,O,p)}}function mF(u,s){return u.replace(EF,(c,p)=>{const _=s[p];return _!=null?String(_):`<${p}?>`})}const EF=/\{\$([^}]+)}/g;function gF(u){for(const s in u)if(Object.prototype.hasOwnProperty.call(u,s))return!1;return!0}function uf(u,s){if(u===s)return!0;const c=Object.keys(u),p=Object.keys(s);for(const _ of c){if(!p.includes(_))return!1;const g=u[_],y=s[_];if(sC(g)&&sC(y)){if(!uf(g,y))return!1}else if(g!==y)return!1}for(const _ of p)if(!c.includes(_))return!1;return!0}function sC(u){return u!==null&&typeof u=="object"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qu(u){const s=[];for(const[c,p]of Object.entries(u))Array.isArray(p)?p.forEach(_=>{s.push(encodeURIComponent(c)+"="+encodeURIComponent(_))}):s.push(encodeURIComponent(c)+"="+encodeURIComponent(p));return s.length?"&"+s.join("&"):""}function TF(u,s){const c=new SF(u,s);return c.subscribe.bind(c)}class SF{constructor(s,c){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=c,this.task.then(()=>{s(this)}).catch(p=>{this.error(p)})}next(s){this.forEachObserver(c=>{c.next(s)})}error(s){this.forEachObserver(c=>{c.error(s)}),this.close(s)}complete(){this.forEachObserver(s=>{s.complete()}),this.close()}subscribe(s,c,p){let _;if(s===void 0&&c===void 0&&p===void 0)throw new Error("Missing Observer.");vF(s,["next","error","complete"])?_=s:_={next:s,error:c,complete:p},_.next===void 0&&(_.next=Eg),_.error===void 0&&(_.error=Eg),_.complete===void 0&&(_.complete=Eg);const g=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(()=>{try{this.finalError?_.error(this.finalError):_.complete()}catch{}}),this.observers.push(_),g}unsubscribeOne(s){this.observers===void 0||this.observers[s]===void 0||(delete this.observers[s],this.observerCount-=1,this.observerCount===0&&this.onNoObservers!==void 0&&this.onNoObservers(this))}forEachObserver(s){if(!this.finalized)for(let c=0;c<this.observers.length;c++)this.sendOne(c,s)}sendOne(s,c){this.task.then(()=>{if(this.observers!==void 0&&this.observers[s]!==void 0)try{c(this.observers[s])}catch(p){typeof console<"u"&&console.error&&console.error(p)}})}close(s){this.finalized||(this.finalized=!0,s!==void 0&&(this.finalError=s),this.task.then(()=>{this.observers=void 0,this.onNoObservers=void 0}))}}function vF(u,s){if(typeof u!="object"||u===null)return!1;for(const c of s)if(c in u&&typeof u[c]=="function")return!0;return!1}function Eg(){}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kc(u){return u&&u._delegate?u._delegate:u}class Lc{constructor(s,c,p){this.name=s,this.instanceFactory=c,this.type=p,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(s){return this.instantiationMode=s,this}setMultipleInstances(s){return this.multipleInstances=s,this}setServiceProps(s){return this.serviceProps=s,this}setInstanceCreatedCallback(s){return this.onInstanceCreated=s,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mc="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yF{constructor(s,c){this.name=s,this.container=c,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(s){const c=this.normalizeInstanceIdentifier(s);if(!this.instancesDeferred.has(c)){const p=new iF;if(this.instancesDeferred.set(c,p),this.isInitialized(c)||this.shouldAutoInitialize())try{const _=this.getOrInitializeService({instanceIdentifier:c});_&&p.resolve(_)}catch{}}return this.instancesDeferred.get(c).promise}getImmediate(s){var c;const p=this.normalizeInstanceIdentifier(s==null?void 0:s.identifier),_=(c=s==null?void 0:s.optional)!==null&&c!==void 0?c:!1;if(this.isInitialized(p)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:p})}catch(g){if(_)return null;throw g}else{if(_)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(s){if(s.name!==this.name)throw Error(`Mismatching Component ${s.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=s,!!this.shouldAutoInitialize()){if(IF(s))try{this.getOrInitializeService({instanceIdentifier:Mc})}catch{}for(const[c,p]of this.instancesDeferred.entries()){const _=this.normalizeInstanceIdentifier(c);try{const g=this.getOrInitializeService({instanceIdentifier:_});p.resolve(g)}catch{}}}}clearInstance(s=Mc){this.instancesDeferred.delete(s),this.instancesOptions.delete(s),this.instances.delete(s)}async delete(){const s=Array.from(this.instances.values());await Promise.all([...s.filter(c=>"INTERNAL"in c).map(c=>c.INTERNAL.delete()),...s.filter(c=>"_delete"in c).map(c=>c._delete())])}isComponentSet(){return this.component!=null}isInitialized(s=Mc){return this.instances.has(s)}getOptions(s=Mc){return this.instancesOptions.get(s)||{}}initialize(s={}){const{options:c={}}=s,p=this.normalizeInstanceIdentifier(s.instanceIdentifier);if(this.isInitialized(p))throw Error(`${this.name}(${p}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const _=this.getOrInitializeService({instanceIdentifier:p,options:c});for(const[g,y]of this.instancesDeferred.entries()){const O=this.normalizeInstanceIdentifier(g);p===O&&y.resolve(_)}return _}onInit(s,c){var p;const _=this.normalizeInstanceIdentifier(c),g=(p=this.onInitCallbacks.get(_))!==null&&p!==void 0?p:new Set;g.add(s),this.onInitCallbacks.set(_,g);const y=this.instances.get(_);return y&&s(y,_),()=>{g.delete(s)}}invokeOnInitCallbacks(s,c){const p=this.onInitCallbacks.get(c);if(p)for(const _ of p)try{_(s,c)}catch{}}getOrInitializeService({instanceIdentifier:s,options:c={}}){let p=this.instances.get(s);if(!p&&this.component&&(p=this.component.instanceFactory(this.container,{instanceIdentifier:RF(s),options:c}),this.instances.set(s,p),this.instancesOptions.set(s,c),this.invokeOnInitCallbacks(p,s),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,s,p)}catch{}return p||null}normalizeInstanceIdentifier(s=Mc){return this.component?this.component.multipleInstances?s:Mc:s}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function RF(u){return u===Mc?void 0:u}function IF(u){return u.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class CF{constructor(s){this.name=s,this.providers=new Map}addComponent(s){const c=this.getProvider(s.name);if(c.isComponentSet())throw new Error(`Component ${s.name} has already been registered with ${this.name}`);c.setComponent(s)}addOrOverwriteComponent(s){this.getProvider(s.name).isComponentSet()&&this.providers.delete(s.name),this.addComponent(s)}getProvider(s){if(this.providers.has(s))return this.providers.get(s);const c=new yF(s,this);return this.providers.set(s,c),c}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var on;(function(u){u[u.DEBUG=0]="DEBUG",u[u.VERBOSE=1]="VERBOSE",u[u.INFO=2]="INFO",u[u.WARN=3]="WARN",u[u.ERROR=4]="ERROR",u[u.SILENT=5]="SILENT"})(on||(on={}));const AF={debug:on.DEBUG,verbose:on.VERBOSE,info:on.INFO,warn:on.WARN,error:on.ERROR,silent:on.SILENT},wF=on.INFO,bF={[on.DEBUG]:"log",[on.VERBOSE]:"log",[on.INFO]:"info",[on.WARN]:"warn",[on.ERROR]:"error"},OF=(u,s,...c)=>{if(s<u.logLevel)return;const p=new Date().toISOString(),_=bF[s];if(_)console[_](`[${p}]  ${u.name}:`,...c);else throw new Error(`Attempted to log a message with an invalid logType (value: ${s})`)};class gg{constructor(s){this.name=s,this._logLevel=wF,this._logHandler=OF,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(s){if(!(s in on))throw new TypeError(`Invalid value "${s}" assigned to \`logLevel\``);this._logLevel=s}setLogLevel(s){this._logLevel=typeof s=="string"?AF[s]:s}get logHandler(){return this._logHandler}set logHandler(s){if(typeof s!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=s}get userLogHandler(){return this._userLogHandler}set userLogHandler(s){this._userLogHandler=s}debug(...s){this._userLogHandler&&this._userLogHandler(this,on.DEBUG,...s),this._logHandler(this,on.DEBUG,...s)}log(...s){this._userLogHandler&&this._userLogHandler(this,on.VERBOSE,...s),this._logHandler(this,on.VERBOSE,...s)}info(...s){this._userLogHandler&&this._userLogHandler(this,on.INFO,...s),this._logHandler(this,on.INFO,...s)}warn(...s){this._userLogHandler&&this._userLogHandler(this,on.WARN,...s),this._logHandler(this,on.WARN,...s)}error(...s){this._userLogHandler&&this._userLogHandler(this,on.ERROR,...s),this._logHandler(this,on.ERROR,...s)}}const NF=(u,s)=>s.some(c=>u instanceof c);let oC,aC;function PF(){return oC||(oC=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function DF(){return aC||(aC=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cC=new WeakMap,Tg=new WeakMap,dC=new WeakMap,Sg=new WeakMap,vg=new WeakMap;function kF(u){const s=new Promise((c,p)=>{const _=()=>{u.removeEventListener("success",g),u.removeEventListener("error",y)},g=()=>{c(Ma(u.result)),_()},y=()=>{p(u.error),_()};u.addEventListener("success",g),u.addEventListener("error",y)});return s.then(c=>{c instanceof IDBCursor&&cC.set(c,u)}).catch(()=>{}),vg.set(s,u),s}function LF(u){if(Tg.has(u))return;const s=new Promise((c,p)=>{const _=()=>{u.removeEventListener("complete",g),u.removeEventListener("error",y),u.removeEventListener("abort",y)},g=()=>{c(),_()},y=()=>{p(u.error||new DOMException("AbortError","AbortError")),_()};u.addEventListener("complete",g),u.addEventListener("error",y),u.addEventListener("abort",y)});Tg.set(u,s)}let yg={get(u,s,c){if(u instanceof IDBTransaction){if(s==="done")return Tg.get(u);if(s==="objectStoreNames")return u.objectStoreNames||dC.get(u);if(s==="store")return c.objectStoreNames[1]?void 0:c.objectStore(c.objectStoreNames[0])}return Ma(u[s])},set(u,s,c){return u[s]=c,!0},has(u,s){return u instanceof IDBTransaction&&(s==="done"||s==="store")?!0:s in u}};function MF(u){yg=u(yg)}function UF(u){return u===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(s,...c){const p=u.call(Rg(this),s,...c);return dC.set(p,s.sort?s.sort():[s]),Ma(p)}:DF().includes(u)?function(...s){return u.apply(Rg(this),s),Ma(cC.get(this))}:function(...s){return Ma(u.apply(Rg(this),s))}}function xF(u){return typeof u=="function"?UF(u):(u instanceof IDBTransaction&&LF(u),NF(u,PF())?new Proxy(u,yg):u)}function Ma(u){if(u instanceof IDBRequest)return kF(u);if(Sg.has(u))return Sg.get(u);const s=xF(u);return s!==u&&(Sg.set(u,s),vg.set(s,u)),s}const Rg=u=>vg.get(u);function VF(u,s,{blocked:c,upgrade:p,blocking:_,terminated:g}={}){const y=indexedDB.open(u,s),O=Ma(y);return p&&y.addEventListener("upgradeneeded",L=>{p(Ma(y.result),L.oldVersion,L.newVersion,Ma(y.transaction),L)}),c&&y.addEventListener("blocked",L=>c(L.oldVersion,L.newVersion,L)),O.then(L=>{g&&L.addEventListener("close",()=>g()),_&&L.addEventListener("versionchange",V=>_(V.oldVersion,V.newVersion,V))}).catch(()=>{}),O}const FF=["get","getKey","getAll","getAllKeys","count"],BF=["put","add","delete","clear"],Ig=new Map;function lC(u,s){if(!(u instanceof IDBDatabase&&!(s in u)&&typeof s=="string"))return;if(Ig.get(s))return Ig.get(s);const c=s.replace(/FromIndex$/,""),p=s!==c,_=BF.includes(c);if(!(c in(p?IDBIndex:IDBObjectStore).prototype)||!(_||FF.includes(c)))return;const g=async function(y,...O){const L=this.transaction(y,_?"readwrite":"readonly");let V=L.store;return p&&(V=V.index(O.shift())),(await Promise.all([V[c](...O),_&&L.done]))[0]};return Ig.set(s,g),g}MF(u=>({...u,get:(s,c,p)=>lC(s,c)||u.get(s,c,p),has:(s,c)=>!!lC(s,c)||u.has(s,c)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class jF{constructor(s){this.container=s}getPlatformInfoString(){return this.container.getProviders().map(c=>{if(GF(c)){const p=c.getImmediate();return`${p.library}/${p.version}`}else return null}).filter(c=>c).join(" ")}}function GF(u){const s=u.getComponent();return(s==null?void 0:s.type)==="VERSION"}const Cg="@firebase/app",uC="0.10.13";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ho=new gg("@firebase/app"),WF="@firebase/app-compat",HF="@firebase/analytics-compat",KF="@firebase/analytics",qF="@firebase/app-check-compat",YF="@firebase/app-check",zF="@firebase/auth",JF="@firebase/auth-compat",XF="@firebase/database",QF="@firebase/data-connect",$F="@firebase/database-compat",ZF="@firebase/functions",tB="@firebase/functions-compat",eB="@firebase/installations",nB="@firebase/installations-compat",rB="@firebase/messaging",iB="@firebase/messaging-compat",sB="@firebase/performance",oB="@firebase/performance-compat",aB="@firebase/remote-config",cB="@firebase/remote-config-compat",dB="@firebase/storage",lB="@firebase/storage-compat",uB="@firebase/firestore",hB="@firebase/vertexai-preview",pB="@firebase/firestore-compat",fB="firebase",_B="10.14.1";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ag="[DEFAULT]",mB={[Cg]:"fire-core",[WF]:"fire-core-compat",[KF]:"fire-analytics",[HF]:"fire-analytics-compat",[YF]:"fire-app-check",[qF]:"fire-app-check-compat",[zF]:"fire-auth",[JF]:"fire-auth-compat",[XF]:"fire-rtdb",[QF]:"fire-data-connect",[$F]:"fire-rtdb-compat",[ZF]:"fire-fn",[tB]:"fire-fn-compat",[eB]:"fire-iid",[nB]:"fire-iid-compat",[rB]:"fire-fcm",[iB]:"fire-fcm-compat",[sB]:"fire-perf",[oB]:"fire-perf-compat",[aB]:"fire-rc",[cB]:"fire-rc-compat",[dB]:"fire-gcs",[lB]:"fire-gcs-compat",[uB]:"fire-fst",[pB]:"fire-fst-compat",[hB]:"fire-vertex","fire-js":"fire-js",[fB]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hf=new Map,EB=new Map,wg=new Map;function hC(u,s){try{u.container.addComponent(s)}catch(c){Ho.debug(`Component ${s.name} failed to register with FirebaseApp ${u.name}`,c)}}function qd(u){const s=u.name;if(wg.has(s))return Ho.debug(`There were multiple attempts to register component ${s}.`),!1;wg.set(s,u);for(const c of hf.values())hC(c,u);for(const c of EB.values())hC(c,u);return!0}function bg(u,s){const c=u.container.getProvider("heartbeat").getImmediate({optional:!0});return c&&c.triggerHeartbeat(),u.container.getProvider(s)}function Ua(u){return u.settings!==void 0}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gB={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},xa=new Ku("app","Firebase",gB);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class TB{constructor(s,c,p){this._isDeleted=!1,this._options=Object.assign({},s),this._config=Object.assign({},c),this._name=c.name,this._automaticDataCollectionEnabled=c.automaticDataCollectionEnabled,this._container=p,this.container.addComponent(new Lc("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(s){this.checkDestroyed(),this._automaticDataCollectionEnabled=s}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(s){this._isDeleted=s}checkDestroyed(){if(this.isDeleted)throw xa.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yd=_B;function pC(u,s={}){let c=u;typeof s!="object"&&(s={name:s});const p=Object.assign({name:Ag,automaticDataCollectionEnabled:!1},s),_=p.name;if(typeof _!="string"||!_)throw xa.create("bad-app-name",{appName:String(_)});if(c||(c=rC()),!c)throw xa.create("no-options");const g=hf.get(_);if(g){if(uf(c,g.options)&&uf(p,g.config))return g;throw xa.create("duplicate-app",{appName:_})}const y=new CF(_);for(const L of wg.values())y.addComponent(L);const O=new TB(c,p,y);return hf.set(_,O),O}function fC(u=Ag){const s=hf.get(u);if(!s&&u===Ag&&rC())return pC();if(!s)throw xa.create("no-app",{appName:u});return s}function Va(u,s,c){var p;let _=(p=mB[u])!==null&&p!==void 0?p:u;c&&(_+=`-${c}`);const g=_.match(/\s|\//),y=s.match(/\s|\//);if(g||y){const O=[`Unable to register library "${_}" with version "${s}":`];g&&O.push(`library name "${_}" contains illegal characters (whitespace or "/")`),g&&y&&O.push("and"),y&&O.push(`version name "${s}" contains illegal characters (whitespace or "/")`),Ho.warn(O.join(" "));return}qd(new Lc(`${_}-version`,()=>({library:_,version:s}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const SB="firebase-heartbeat-database",vB=1,Yu="firebase-heartbeat-store";let Og=null;function _C(){return Og||(Og=VF(SB,vB,{upgrade:(u,s)=>{switch(s){case 0:try{u.createObjectStore(Yu)}catch(c){console.warn(c)}}}}).catch(u=>{throw xa.create("idb-open",{originalErrorMessage:u.message})})),Og}async function yB(u){try{const c=(await _C()).transaction(Yu),p=await c.objectStore(Yu).get(EC(u));return await c.done,p}catch(s){if(s instanceof Wo)Ho.warn(s.message);else{const c=xa.create("idb-get",{originalErrorMessage:s==null?void 0:s.message});Ho.warn(c.message)}}}async function mC(u,s){try{const p=(await _C()).transaction(Yu,"readwrite");await p.objectStore(Yu).put(s,EC(u)),await p.done}catch(c){if(c instanceof Wo)Ho.warn(c.message);else{const p=xa.create("idb-set",{originalErrorMessage:c==null?void 0:c.message});Ho.warn(p.message)}}}function EC(u){return`${u.name}!${u.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const RB=1024,IB=30*24*60*60*1e3;class CB{constructor(s){this.container=s,this._heartbeatsCache=null;const c=this.container.getProvider("app").getImmediate();this._storage=new wB(c),this._heartbeatsCachePromise=this._storage.read().then(p=>(this._heartbeatsCache=p,p))}async triggerHeartbeat(){var s,c;try{const _=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),g=gC();return((s=this._heartbeatsCache)===null||s===void 0?void 0:s.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((c=this._heartbeatsCache)===null||c===void 0?void 0:c.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===g||this._heartbeatsCache.heartbeats.some(y=>y.date===g)?void 0:(this._heartbeatsCache.heartbeats.push({date:g,agent:_}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(y=>{const O=new Date(y.date).valueOf();return Date.now()-O<=IB}),this._storage.overwrite(this._heartbeatsCache))}catch(p){Ho.warn(p)}}async getHeartbeatsHeader(){var s;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((s=this._heartbeatsCache)===null||s===void 0?void 0:s.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const c=gC(),{heartbeatsToSend:p,unsentEntries:_}=AB(this._heartbeatsCache.heartbeats),g=df(JSON.stringify({version:2,heartbeats:p}));return this._heartbeatsCache.lastSentHeartbeatDate=c,_.length>0?(this._heartbeatsCache.heartbeats=_,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),g}catch(c){return Ho.warn(c),""}}}function gC(){return new Date().toISOString().substring(0,10)}function AB(u,s=RB){const c=[];let p=u.slice();for(const _ of u){const g=c.find(y=>y.agent===_.agent);if(g){if(g.dates.push(_.date),TC(c)>s){g.dates.pop();break}}else if(c.push({agent:_.agent,dates:[_.date]}),TC(c)>s){c.pop();break}p=p.slice(1)}return{heartbeatsToSend:c,unsentEntries:p}}class wB{constructor(s){this.app=s,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return pF()?fF().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const c=await yB(this.app);return c!=null&&c.heartbeats?c:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(s){var c;if(await this._canUseIndexedDBPromise){const _=await this.read();return mC(this.app,{lastSentHeartbeatDate:(c=s.lastSentHeartbeatDate)!==null&&c!==void 0?c:_.lastSentHeartbeatDate,heartbeats:s.heartbeats})}else return}async add(s){var c;if(await this._canUseIndexedDBPromise){const _=await this.read();return mC(this.app,{lastSentHeartbeatDate:(c=s.lastSentHeartbeatDate)!==null&&c!==void 0?c:_.lastSentHeartbeatDate,heartbeats:[..._.heartbeats,...s.heartbeats]})}else return}}function TC(u){return df(JSON.stringify({version:2,heartbeats:u})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bB(u){qd(new Lc("platform-logger",s=>new jF(s),"PRIVATE")),qd(new Lc("heartbeat",s=>new CB(s),"PRIVATE")),Va(Cg,uC,u),Va(Cg,uC,"esm2017"),Va("fire-js","")}bB("");var SC=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var Uc,vC;(function(){var u;/** @license

	 Copyright The Closure Library Authors.
	 SPDX-License-Identifier: Apache-2.0
	*/function s(J,q){function K(){}K.prototype=q.prototype,J.D=q.prototype,J.prototype=new K,J.prototype.constructor=J,J.C=function(Z,rt,nt){for(var X=Array(arguments.length-2),ee=2;ee<arguments.length;ee++)X[ee-2]=arguments[ee];return q.prototype[rt].apply(Z,X)}}function c(){this.blockSize=-1}function p(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}s(p,c),p.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function _(J,q,K){K||(K=0);var Z=Array(16);if(typeof q=="string")for(var rt=0;16>rt;++rt)Z[rt]=q.charCodeAt(K++)|q.charCodeAt(K++)<<8|q.charCodeAt(K++)<<16|q.charCodeAt(K++)<<24;else for(rt=0;16>rt;++rt)Z[rt]=q[K++]|q[K++]<<8|q[K++]<<16|q[K++]<<24;q=J.g[0],K=J.g[1],rt=J.g[2];var nt=J.g[3],X=q+(nt^K&(rt^nt))+Z[0]+3614090360&4294967295;q=K+(X<<7&4294967295|X>>>25),X=nt+(rt^q&(K^rt))+Z[1]+3905402710&4294967295,nt=q+(X<<12&4294967295|X>>>20),X=rt+(K^nt&(q^K))+Z[2]+606105819&4294967295,rt=nt+(X<<17&4294967295|X>>>15),X=K+(q^rt&(nt^q))+Z[3]+3250441966&4294967295,K=rt+(X<<22&4294967295|X>>>10),X=q+(nt^K&(rt^nt))+Z[4]+4118548399&4294967295,q=K+(X<<7&4294967295|X>>>25),X=nt+(rt^q&(K^rt))+Z[5]+1200080426&4294967295,nt=q+(X<<12&4294967295|X>>>20),X=rt+(K^nt&(q^K))+Z[6]+2821735955&4294967295,rt=nt+(X<<17&4294967295|X>>>15),X=K+(q^rt&(nt^q))+Z[7]+4249261313&4294967295,K=rt+(X<<22&4294967295|X>>>10),X=q+(nt^K&(rt^nt))+Z[8]+1770035416&4294967295,q=K+(X<<7&4294967295|X>>>25),X=nt+(rt^q&(K^rt))+Z[9]+2336552879&4294967295,nt=q+(X<<12&4294967295|X>>>20),X=rt+(K^nt&(q^K))+Z[10]+4294925233&4294967295,rt=nt+(X<<17&4294967295|X>>>15),X=K+(q^rt&(nt^q))+Z[11]+2304563134&4294967295,K=rt+(X<<22&4294967295|X>>>10),X=q+(nt^K&(rt^nt))+Z[12]+1804603682&4294967295,q=K+(X<<7&4294967295|X>>>25),X=nt+(rt^q&(K^rt))+Z[13]+4254626195&4294967295,nt=q+(X<<12&4294967295|X>>>20),X=rt+(K^nt&(q^K))+Z[14]+2792965006&4294967295,rt=nt+(X<<17&4294967295|X>>>15),X=K+(q^rt&(nt^q))+Z[15]+1236535329&4294967295,K=rt+(X<<22&4294967295|X>>>10),X=q+(rt^nt&(K^rt))+Z[1]+4129170786&4294967295,q=K+(X<<5&4294967295|X>>>27),X=nt+(K^rt&(q^K))+Z[6]+3225465664&4294967295,nt=q+(X<<9&4294967295|X>>>23),X=rt+(q^K&(nt^q))+Z[11]+643717713&4294967295,rt=nt+(X<<14&4294967295|X>>>18),X=K+(nt^q&(rt^nt))+Z[0]+3921069994&4294967295,K=rt+(X<<20&4294967295|X>>>12),X=q+(rt^nt&(K^rt))+Z[5]+3593408605&4294967295,q=K+(X<<5&4294967295|X>>>27),X=nt+(K^rt&(q^K))+Z[10]+38016083&4294967295,nt=q+(X<<9&4294967295|X>>>23),X=rt+(q^K&(nt^q))+Z[15]+3634488961&4294967295,rt=nt+(X<<14&4294967295|X>>>18),X=K+(nt^q&(rt^nt))+Z[4]+3889429448&4294967295,K=rt+(X<<20&4294967295|X>>>12),X=q+(rt^nt&(K^rt))+Z[9]+568446438&4294967295,q=K+(X<<5&4294967295|X>>>27),X=nt+(K^rt&(q^K))+Z[14]+3275163606&4294967295,nt=q+(X<<9&4294967295|X>>>23),X=rt+(q^K&(nt^q))+Z[3]+4107603335&4294967295,rt=nt+(X<<14&4294967295|X>>>18),X=K+(nt^q&(rt^nt))+Z[8]+1163531501&4294967295,K=rt+(X<<20&4294967295|X>>>12),X=q+(rt^nt&(K^rt))+Z[13]+2850285829&4294967295,q=K+(X<<5&4294967295|X>>>27),X=nt+(K^rt&(q^K))+Z[2]+4243563512&4294967295,nt=q+(X<<9&4294967295|X>>>23),X=rt+(q^K&(nt^q))+Z[7]+1735328473&4294967295,rt=nt+(X<<14&4294967295|X>>>18),X=K+(nt^q&(rt^nt))+Z[12]+2368359562&4294967295,K=rt+(X<<20&4294967295|X>>>12),X=q+(K^rt^nt)+Z[5]+4294588738&4294967295,q=K+(X<<4&4294967295|X>>>28),X=nt+(q^K^rt)+Z[8]+2272392833&4294967295,nt=q+(X<<11&4294967295|X>>>21),X=rt+(nt^q^K)+Z[11]+1839030562&4294967295,rt=nt+(X<<16&4294967295|X>>>16),X=K+(rt^nt^q)+Z[14]+4259657740&4294967295,K=rt+(X<<23&4294967295|X>>>9),X=q+(K^rt^nt)+Z[1]+2763975236&4294967295,q=K+(X<<4&4294967295|X>>>28),X=nt+(q^K^rt)+Z[4]+1272893353&4294967295,nt=q+(X<<11&4294967295|X>>>21),X=rt+(nt^q^K)+Z[7]+4139469664&4294967295,rt=nt+(X<<16&4294967295|X>>>16),X=K+(rt^nt^q)+Z[10]+3200236656&4294967295,K=rt+(X<<23&4294967295|X>>>9),X=q+(K^rt^nt)+Z[13]+681279174&4294967295,q=K+(X<<4&4294967295|X>>>28),X=nt+(q^K^rt)+Z[0]+3936430074&4294967295,nt=q+(X<<11&4294967295|X>>>21),X=rt+(nt^q^K)+Z[3]+3572445317&4294967295,rt=nt+(X<<16&4294967295|X>>>16),X=K+(rt^nt^q)+Z[6]+76029189&4294967295,K=rt+(X<<23&4294967295|X>>>9),X=q+(K^rt^nt)+Z[9]+3654602809&4294967295,q=K+(X<<4&4294967295|X>>>28),X=nt+(q^K^rt)+Z[12]+3873151461&4294967295,nt=q+(X<<11&4294967295|X>>>21),X=rt+(nt^q^K)+Z[15]+530742520&4294967295,rt=nt+(X<<16&4294967295|X>>>16),X=K+(rt^nt^q)+Z[2]+3299628645&4294967295,K=rt+(X<<23&4294967295|X>>>9),X=q+(rt^(K|~nt))+Z[0]+4096336452&4294967295,q=K+(X<<6&4294967295|X>>>26),X=nt+(K^(q|~rt))+Z[7]+1126891415&4294967295,nt=q+(X<<10&4294967295|X>>>22),X=rt+(q^(nt|~K))+Z[14]+2878612391&4294967295,rt=nt+(X<<15&4294967295|X>>>17),X=K+(nt^(rt|~q))+Z[5]+4237533241&4294967295,K=rt+(X<<21&4294967295|X>>>11),X=q+(rt^(K|~nt))+Z[12]+1700485571&4294967295,q=K+(X<<6&4294967295|X>>>26),X=nt+(K^(q|~rt))+Z[3]+2399980690&4294967295,nt=q+(X<<10&4294967295|X>>>22),X=rt+(q^(nt|~K))+Z[10]+4293915773&4294967295,rt=nt+(X<<15&4294967295|X>>>17),X=K+(nt^(rt|~q))+Z[1]+2240044497&4294967295,K=rt+(X<<21&4294967295|X>>>11),X=q+(rt^(K|~nt))+Z[8]+1873313359&4294967295,q=K+(X<<6&4294967295|X>>>26),X=nt+(K^(q|~rt))+Z[15]+4264355552&4294967295,nt=q+(X<<10&4294967295|X>>>22),X=rt+(q^(nt|~K))+Z[6]+2734768916&4294967295,rt=nt+(X<<15&4294967295|X>>>17),X=K+(nt^(rt|~q))+Z[13]+1309151649&4294967295,K=rt+(X<<21&4294967295|X>>>11),X=q+(rt^(K|~nt))+Z[4]+4149444226&4294967295,q=K+(X<<6&4294967295|X>>>26),X=nt+(K^(q|~rt))+Z[11]+3174756917&4294967295,nt=q+(X<<10&4294967295|X>>>22),X=rt+(q^(nt|~K))+Z[2]+718787259&4294967295,rt=nt+(X<<15&4294967295|X>>>17),X=K+(nt^(rt|~q))+Z[9]+3951481745&4294967295,J.g[0]=J.g[0]+q&4294967295,J.g[1]=J.g[1]+(rt+(X<<21&4294967295|X>>>11))&4294967295,J.g[2]=J.g[2]+rt&4294967295,J.g[3]=J.g[3]+nt&4294967295}p.prototype.u=function(J,q){q===void 0&&(q=J.length);for(var K=q-this.blockSize,Z=this.B,rt=this.h,nt=0;nt<q;){if(rt==0)for(;nt<=K;)_(this,J,nt),nt+=this.blockSize;if(typeof J=="string"){for(;nt<q;)if(Z[rt++]=J.charCodeAt(nt++),rt==this.blockSize){_(this,Z),rt=0;break}}else for(;nt<q;)if(Z[rt++]=J[nt++],rt==this.blockSize){_(this,Z),rt=0;break}}this.h=rt,this.o+=q},p.prototype.v=function(){var J=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);J[0]=128;for(var q=1;q<J.length-8;++q)J[q]=0;var K=8*this.o;for(q=J.length-8;q<J.length;++q)J[q]=K&255,K/=256;for(this.u(J),J=Array(16),q=K=0;4>q;++q)for(var Z=0;32>Z;Z+=8)J[K++]=this.g[q]>>>Z&255;return J};function g(J,q){var K=O;return Object.prototype.hasOwnProperty.call(K,J)?K[J]:K[J]=q(J)}function y(J,q){this.h=q;for(var K=[],Z=!0,rt=J.length-1;0<=rt;rt--){var nt=J[rt]|0;Z&&nt==q||(K[rt]=nt,Z=!1)}this.g=K}var O={};function L(J){return-128<=J&&128>J?g(J,function(q){return new y([q|0],0>q?-1:0)}):new y([J|0],0>J?-1:0)}function V(J){if(isNaN(J)||!isFinite(J))return tt;if(0>J)return wt(V(-J));for(var q=[],K=1,Z=0;J>=K;Z++)q[Z]=J/K|0,K*=4294967296;return new y(q,0)}function G(J,q){if(J.length==0)throw Error("number format error: empty string");if(q=q||10,2>q||36<q)throw Error("radix out of range: "+q);if(J.charAt(0)=="-")return wt(G(J.substring(1),q));if(0<=J.indexOf("-"))throw Error('number format error: interior "-" character');for(var K=V(Math.pow(q,8)),Z=tt,rt=0;rt<J.length;rt+=8){var nt=Math.min(8,J.length-rt),X=parseInt(J.substring(rt,rt+nt),q);8>nt?(nt=V(Math.pow(q,nt)),Z=Z.j(nt).add(V(X))):(Z=Z.j(K),Z=Z.add(V(X)))}return Z}var tt=L(0),st=L(1),ht=L(16777216);u=y.prototype,u.m=function(){if(Vt(this))return-wt(this).m();for(var J=0,q=1,K=0;K<this.g.length;K++){var Z=this.i(K);J+=(0<=Z?Z:4294967296+Z)*q,q*=4294967296}return J},u.toString=function(J){if(J=J||10,2>J||36<J)throw Error("radix out of range: "+J);if(yt(this))return"0";if(Vt(this))return"-"+wt(this).toString(J);for(var q=V(Math.pow(J,6)),K=this,Z="";;){var rt=Lt(K,q).g;K=te(K,rt.j(q));var nt=((0<K.g.length?K.g[0]:K.h)>>>0).toString(J);if(K=rt,yt(K))return nt+Z;for(;6>nt.length;)nt="0"+nt;Z=nt+Z}},u.i=function(J){return 0>J?0:J<this.g.length?this.g[J]:this.h};function yt(J){if(J.h!=0)return!1;for(var q=0;q<J.g.length;q++)if(J.g[q]!=0)return!1;return!0}function Vt(J){return J.h==-1}u.l=function(J){return J=te(this,J),Vt(J)?-1:yt(J)?0:1};function wt(J){for(var q=J.g.length,K=[],Z=0;Z<q;Z++)K[Z]=~J.g[Z];return new y(K,~J.h).add(st)}u.abs=function(){return Vt(this)?wt(this):this},u.add=function(J){for(var q=Math.max(this.g.length,J.g.length),K=[],Z=0,rt=0;rt<=q;rt++){var nt=Z+(this.i(rt)&65535)+(J.i(rt)&65535),X=(nt>>>16)+(this.i(rt)>>>16)+(J.i(rt)>>>16);Z=X>>>16,nt&=65535,X&=65535,K[rt]=X<<16|nt}return new y(K,K[K.length-1]&-2147483648?-1:0)};function te(J,q){return J.add(wt(q))}u.j=function(J){if(yt(this)||yt(J))return tt;if(Vt(this))return Vt(J)?wt(this).j(wt(J)):wt(wt(this).j(J));if(Vt(J))return wt(this.j(wt(J)));if(0>this.l(ht)&&0>J.l(ht))return V(this.m()*J.m());for(var q=this.g.length+J.g.length,K=[],Z=0;Z<2*q;Z++)K[Z]=0;for(Z=0;Z<this.g.length;Z++)for(var rt=0;rt<J.g.length;rt++){var nt=this.i(Z)>>>16,X=this.i(Z)&65535,ee=J.i(rt)>>>16,xn=J.i(rt)&65535;K[2*Z+2*rt]+=X*xn,Nt(K,2*Z+2*rt),K[2*Z+2*rt+1]+=nt*xn,Nt(K,2*Z+2*rt+1),K[2*Z+2*rt+1]+=X*ee,Nt(K,2*Z+2*rt+1),K[2*Z+2*rt+2]+=nt*ee,Nt(K,2*Z+2*rt+2)}for(Z=0;Z<q;Z++)K[Z]=K[2*Z+1]<<16|K[2*Z];for(Z=q;Z<2*q;Z++)K[Z]=0;return new y(K,0)};function Nt(J,q){for(;(J[q]&65535)!=J[q];)J[q+1]+=J[q]>>>16,J[q]&=65535,q++}function oe(J,q){this.g=J,this.h=q}function Lt(J,q){if(yt(q))throw Error("division by zero");if(yt(J))return new oe(tt,tt);if(Vt(J))return q=Lt(wt(J),q),new oe(wt(q.g),wt(q.h));if(Vt(q))return q=Lt(J,wt(q)),new oe(wt(q.g),q.h);if(30<J.g.length){if(Vt(J)||Vt(q))throw Error("slowDivide_ only works with positive integers.");for(var K=st,Z=q;0>=Z.l(J);)K=It(K),Z=It(Z);var rt=ae(K,1),nt=ae(Z,1);for(Z=ae(Z,2),K=ae(K,2);!yt(Z);){var X=nt.add(Z);0>=X.l(J)&&(rt=rt.add(K),nt=X),Z=ae(Z,1),K=ae(K,1)}return q=te(J,rt.j(q)),new oe(rt,q)}for(rt=tt;0<=J.l(q);){for(K=Math.max(1,Math.floor(J.m()/q.m())),Z=Math.ceil(Math.log(K)/Math.LN2),Z=48>=Z?1:Math.pow(2,Z-48),nt=V(K),X=nt.j(q);Vt(X)||0<X.l(J);)K-=Z,nt=V(K),X=nt.j(q);yt(nt)&&(nt=st),rt=rt.add(nt),J=te(J,X)}return new oe(rt,J)}u.A=function(J){return Lt(this,J).h},u.and=function(J){for(var q=Math.max(this.g.length,J.g.length),K=[],Z=0;Z<q;Z++)K[Z]=this.i(Z)&J.i(Z);return new y(K,this.h&J.h)},u.or=function(J){for(var q=Math.max(this.g.length,J.g.length),K=[],Z=0;Z<q;Z++)K[Z]=this.i(Z)|J.i(Z);return new y(K,this.h|J.h)},u.xor=function(J){for(var q=Math.max(this.g.length,J.g.length),K=[],Z=0;Z<q;Z++)K[Z]=this.i(Z)^J.i(Z);return new y(K,this.h^J.h)};function It(J){for(var q=J.g.length+1,K=[],Z=0;Z<q;Z++)K[Z]=J.i(Z)<<1|J.i(Z-1)>>>31;return new y(K,J.h)}function ae(J,q){var K=q>>5;q%=32;for(var Z=J.g.length-K,rt=[],nt=0;nt<Z;nt++)rt[nt]=0<q?J.i(nt+K)>>>q|J.i(nt+K+1)<<32-q:J.i(nt+K);return new y(rt,J.h)}p.prototype.digest=p.prototype.v,p.prototype.reset=p.prototype.s,p.prototype.update=p.prototype.u,vC=p,y.prototype.add=y.prototype.add,y.prototype.multiply=y.prototype.j,y.prototype.modulo=y.prototype.A,y.prototype.compare=y.prototype.l,y.prototype.toNumber=y.prototype.m,y.prototype.toString=y.prototype.toString,y.prototype.getBits=y.prototype.i,y.fromNumber=V,y.fromString=G,Uc=y}).apply(typeof SC<"u"?SC:typeof self<"u"?self:typeof window<"u"?window:{});var pf=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var yC,zu,RC,ff,Ng,IC,CC,AC;(function(){var u,s=typeof Object.defineProperties=="function"?Object.defineProperty:function(E,A,k){return E==Array.prototype||E==Object.prototype||(E[A]=k.value),E};function c(E){E=[typeof globalThis=="object"&&globalThis,E,typeof window=="object"&&window,typeof self=="object"&&self,typeof pf=="object"&&pf];for(var A=0;A<E.length;++A){var k=E[A];if(k&&k.Math==Math)return k}throw Error("Cannot find global object")}var p=c(this);function _(E,A){if(A)t:{var k=p;E=E.split(".");for(var B=0;B<E.length-1;B++){var dt=E[B];if(!(dt in k))break t;k=k[dt]}E=E[E.length-1],B=k[E],A=A(B),A!=B&&A!=null&&s(k,E,{configurable:!0,writable:!0,value:A})}}function g(E,A){E instanceof String&&(E+="");var k=0,B=!1,dt={next:function(){if(!B&&k<E.length){var pt=k++;return{value:A(pt,E[pt]),done:!1}}return B=!0,{done:!0,value:void 0}}};return dt[Symbol.iterator]=function(){return dt},dt}_("Array.prototype.values",function(E){return E||function(){return g(this,function(A,k){return k})}});/** @license

	 Copyright The Closure Library Authors.
	 SPDX-License-Identifier: Apache-2.0
	*/var y=y||{},O=this||self;function L(E){var A=typeof E;return A=A!="object"?A:E?Array.isArray(E)?"array":A:"null",A=="array"||A=="object"&&typeof E.length=="number"}function V(E){var A=typeof E;return A=="object"&&E!=null||A=="function"}function G(E,A,k){return E.call.apply(E.bind,arguments)}function tt(E,A,k){if(!E)throw Error();if(2<arguments.length){var B=Array.prototype.slice.call(arguments,2);return function(){var dt=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(dt,B),E.apply(A,dt)}}return function(){return E.apply(A,arguments)}}function st(E,A,k){return st=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?G:tt,st.apply(null,arguments)}function ht(E,A){var k=Array.prototype.slice.call(arguments,1);return function(){var B=k.slice();return B.push.apply(B,arguments),E.apply(this,B)}}function yt(E,A){function k(){}k.prototype=A.prototype,E.aa=A.prototype,E.prototype=new k,E.prototype.constructor=E,E.Qb=function(B,dt,pt){for(var Ft=Array(arguments.length-2),Vn=2;Vn<arguments.length;Vn++)Ft[Vn-2]=arguments[Vn];return A.prototype[dt].apply(B,Ft)}}function Vt(E){const A=E.length;if(0<A){const k=Array(A);for(let B=0;B<A;B++)k[B]=E[B];return k}return[]}function wt(E,A){for(let k=1;k<arguments.length;k++){const B=arguments[k];if(L(B)){const dt=E.length||0,pt=B.length||0;E.length=dt+pt;for(let Ft=0;Ft<pt;Ft++)E[dt+Ft]=B[Ft]}else E.push(B)}}class te{constructor(A,k){this.i=A,this.j=k,this.h=0,this.g=null}get(){let A;return 0<this.h?(this.h--,A=this.g,this.g=A.next,A.next=null):A=this.i(),A}}function Nt(E){return/^[\s\xa0]*$/.test(E)}function oe(){var E=O.navigator;return E&&(E=E.userAgent)?E:""}function Lt(E){return Lt[" "](E),E}Lt[" "]=function(){};var It=oe().indexOf("Gecko")!=-1&&!(oe().toLowerCase().indexOf("webkit")!=-1&&oe().indexOf("Edge")==-1)&&!(oe().indexOf("Trident")!=-1||oe().indexOf("MSIE")!=-1)&&oe().indexOf("Edge")==-1;function ae(E,A,k){for(const B in E)A.call(k,E[B],B,E)}function J(E,A){for(const k in E)A.call(void 0,E[k],k,E)}function q(E){const A={};for(const k in E)A[k]=E[k];return A}const K="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Z(E,A){let k,B;for(let dt=1;dt<arguments.length;dt++){B=arguments[dt];for(k in B)E[k]=B[k];for(let pt=0;pt<K.length;pt++)k=K[pt],Object.prototype.hasOwnProperty.call(B,k)&&(E[k]=B[k])}}function rt(E){var A=1;E=E.split(":");const k=[];for(;0<A&&E.length;)k.push(E.shift()),A--;return E.length&&k.push(E.join(":")),k}function nt(E){O.setTimeout(()=>{throw E},0)}function X(){var E=an;let A=null;return E.g&&(A=E.g,E.g=E.g.next,E.g||(E.h=null),A.next=null),A}class ee{constructor(){this.h=this.g=null}add(A,k){const B=xn.get();B.set(A,k),this.h?this.h.next=B:this.g=B,this.h=B}}var xn=new te(()=>new ne,E=>E.reset());class ne{constructor(){this.next=this.g=this.h=null}set(A,k){this.h=A,this.g=k,this.next=null}reset(){this.next=this.g=this.h=null}}let nn,lr=!1,an=new ee,Pt=()=>{const E=O.Promise.resolve(void 0);nn=()=>{E.then(zt)}};var zt=()=>{for(var E;E=X();){try{E.h.call(E.g)}catch(k){nt(k)}var A=xn;A.j(E),100>A.h&&(A.h++,E.next=A.g,A.g=E)}lr=!1};function Te(){this.s=this.s,this.C=this.C}Te.prototype.s=!1,Te.prototype.ma=function(){this.s||(this.s=!0,this.N())},Te.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function Ot(E,A){this.type=E,this.g=this.target=A,this.defaultPrevented=!1}Ot.prototype.h=function(){this.defaultPrevented=!0};var Bt=function(){if(!O.addEventListener||!Object.defineProperty)return!1;var E=!1,A=Object.defineProperty({},"passive",{get:function(){E=!0}});try{const k=()=>{};O.addEventListener("test",k,A),O.removeEventListener("test",k,A)}catch{}return E}();function re(E,A){if(Ot.call(this,E?E.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,E){var k=this.type=E.type,B=E.changedTouches&&E.changedTouches.length?E.changedTouches[0]:null;if(this.target=E.target||E.srcElement,this.g=A,A=E.relatedTarget){if(It){t:{try{Lt(A.nodeName);var dt=!0;break t}catch{}dt=!1}dt||(A=null)}}else k=="mouseover"?A=E.fromElement:k=="mouseout"&&(A=E.toElement);this.relatedTarget=A,B?(this.clientX=B.clientX!==void 0?B.clientX:B.pageX,this.clientY=B.clientY!==void 0?B.clientY:B.pageY,this.screenX=B.screenX||0,this.screenY=B.screenY||0):(this.clientX=E.clientX!==void 0?E.clientX:E.pageX,this.clientY=E.clientY!==void 0?E.clientY:E.pageY,this.screenX=E.screenX||0,this.screenY=E.screenY||0),this.button=E.button,this.key=E.key||"",this.ctrlKey=E.ctrlKey,this.altKey=E.altKey,this.shiftKey=E.shiftKey,this.metaKey=E.metaKey,this.pointerId=E.pointerId||0,this.pointerType=typeof E.pointerType=="string"?E.pointerType:ie[E.pointerType]||"",this.state=E.state,this.i=E,E.defaultPrevented&&re.aa.h.call(this)}}yt(re,Ot);var ie={2:"touch",3:"pen",4:"mouse"};re.prototype.h=function(){re.aa.h.call(this);var E=this.i;E.preventDefault?E.preventDefault():E.returnValue=!1};var we="closure_listenable_"+(1e6*Math.random()|0),Zt=0;function me(E,A,k,B,dt){this.listener=E,this.proxy=null,this.src=A,this.type=k,this.capture=!!B,this.ha=dt,this.key=++Zt,this.da=this.fa=!1}function fe(E){E.da=!0,E.listener=null,E.proxy=null,E.src=null,E.ha=null}function Hn(E){this.src=E,this.g={},this.h=0}Hn.prototype.add=function(E,A,k,B,dt){var pt=E.toString();E=this.g[pt],E||(E=this.g[pt]=[],this.h++);var Ft=qr(E,A,B,dt);return-1<Ft?(A=E[Ft],k||(A.fa=!1)):(A=new me(A,this.src,pt,!!B,dt),A.fa=k,E.push(A)),A};function jt(E,A){var k=A.type;if(k in E.g){var B=E.g[k],dt=Array.prototype.indexOf.call(B,A,void 0),pt;(pt=0<=dt)&&Array.prototype.splice.call(B,dt,1),pt&&(fe(A),E.g[k].length==0&&(delete E.g[k],E.h--))}}function qr(E,A,k,B){for(var dt=0;dt<E.length;++dt){var pt=E[dt];if(!pt.da&&pt.listener==A&&pt.capture==!!k&&pt.ha==B)return dt}return-1}var ps="closure_lm_"+(1e6*Math.random()|0),Yr={};function $o(E,A,k,B,dt){if(Array.isArray(A)){for(var pt=0;pt<A.length;pt++)$o(E,A[pt],k,B,dt);return null}return k=qc(k),E&&E[we]?E.K(A,k,V(B)?!!B.capture:!1,dt):fl(E,A,k,!1,B,dt)}function fl(E,A,k,B,dt,pt){if(!A)throw Error("Invalid event type");var Ft=V(dt)?!!dt.capture:!!dt,Vn=Zo(E);if(Vn||(E[ps]=Vn=new Hn(E)),k=Vn.add(A,k,B,Ft,pt),k.proxy)return k;if(B=Qi(),k.proxy=B,B.src=E,B.listener=k,E.addEventListener)Bt||(dt=Ft),dt===void 0&&(dt=!1),E.addEventListener(A.toString(),B,dt);else if(E.attachEvent)E.attachEvent(Ur(A.toString()),B);else if(E.addListener&&E.removeListener)E.addListener(B);else throw Error("addEventListener and attachEvent are unavailable.");return k}function Qi(){function E(k){return A.call(E.src,E.listener,k)}const A=xr;return E}function po(E,A,k,B,dt){if(Array.isArray(A))for(var pt=0;pt<A.length;pt++)po(E,A[pt],k,B,dt);else B=V(B)?!!B.capture:!!B,k=qc(k),E&&E[we]?(E=E.i,A=String(A).toString(),A in E.g&&(pt=E.g[A],k=qr(pt,k,B,dt),-1<k&&(fe(pt[k]),Array.prototype.splice.call(pt,k,1),pt.length==0&&(delete E.g[A],E.h--)))):E&&(E=Zo(E))&&(A=E.g[A.toString()],E=-1,A&&(E=qr(A,k,B,dt)),(k=-1<E?A[E]:null)&&Kc(k))}function Kc(E){if(typeof E!="number"&&E&&!E.da){var A=E.src;if(A&&A[we])jt(A.i,E);else{var k=E.type,B=E.proxy;A.removeEventListener?A.removeEventListener(k,B,E.capture):A.detachEvent?A.detachEvent(Ur(k),B):A.addListener&&A.removeListener&&A.removeListener(B),(k=Zo(A))?(jt(k,E),k.h==0&&(k.src=null,A[ps]=null)):fe(E)}}}function Ur(E){return E in Yr?Yr[E]:Yr[E]="on"+E}function xr(E,A){if(E.da)E=!0;else{A=new re(A,this);var k=E.listener,B=E.ha||E.src;E.fa&&Kc(E),E=k.call(B,A)}return E}function Zo(E){return E=E[ps],E instanceof Hn?E:null}var ta="__closure_events_fn_"+(1e9*Math.random()>>>0);function qc(E){return typeof E=="function"?E:(E[ta]||(E[ta]=function(A){return E.handleEvent(A)}),E[ta])}function Er(){Te.call(this),this.i=new Hn(this),this.M=this,this.F=null}yt(Er,Te),Er.prototype[we]=!0,Er.prototype.removeEventListener=function(E,A,k,B){po(this,E,A,k,B)};function pn(E,A){var k,B=E.F;if(B)for(k=[];B;B=B.F)k.push(B);if(E=E.M,B=A.type||A,typeof A=="string")A=new Ot(A,E);else if(A instanceof Ot)A.target=A.target||E;else{var dt=A;A=new Ot(B,E),Z(A,dt)}if(dt=!0,k)for(var pt=k.length-1;0<=pt;pt--){var Ft=A.g=k[pt];dt=bi(Ft,B,!0,A)&&dt}if(Ft=A.g=E,dt=bi(Ft,B,!0,A)&&dt,dt=bi(Ft,B,!1,A)&&dt,k)for(pt=0;pt<k.length;pt++)Ft=A.g=k[pt],dt=bi(Ft,B,!1,A)&&dt}Er.prototype.N=function(){if(Er.aa.N.call(this),this.i){var E=this.i,A;for(A in E.g){for(var k=E.g[A],B=0;B<k.length;B++)fe(k[B]);delete E.g[A],E.h--}}this.F=null},Er.prototype.K=function(E,A,k,B){return this.i.add(String(E),A,!1,k,B)},Er.prototype.L=function(E,A,k,B){return this.i.add(String(E),A,!0,k,B)};function bi(E,A,k,B){if(A=E.i.g[String(A)],!A)return!0;A=A.concat();for(var dt=!0,pt=0;pt<A.length;++pt){var Ft=A[pt];if(Ft&&!Ft.da&&Ft.capture==k){var Vn=Ft.listener,Qn=Ft.ha||Ft.src;Ft.fa&&jt(E.i,Ft),dt=Vn.call(Qn,B)!==!1&&dt}}return dt&&!B.defaultPrevented}function Ja(E,A,k){if(typeof E=="function")k&&(E=st(E,k));else if(E&&typeof E.handleEvent=="function")E=st(E.handleEvent,E);else throw Error("Invalid listener argument");return 2147483647<Number(A)?-1:O.setTimeout(E,A||0)}function ea(E){E.g=Ja(()=>{E.g=null,E.i&&(E.i=!1,ea(E))},E.l);const A=E.h;E.h=null,E.m.apply(null,A)}class _l extends Te{constructor(A,k){super(),this.m=A,this.l=k,this.h=null,this.i=!1,this.g=null}j(A){this.h=arguments,this.g?this.i=!0:ea(this)}N(){super.N(),this.g&&(O.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function fo(E){Te.call(this),this.h=E,this.g={}}yt(fo,Te);var Yc=[];function zc(E){ae(E.g,function(A,k){this.g.hasOwnProperty(k)&&Kc(A)},E),E.g={}}fo.prototype.N=function(){fo.aa.N.call(this),zc(this)},fo.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var $i=O.JSON.stringify,ml=O.JSON.parse,mh=class{stringify(E){return O.JSON.stringify(E,void 0)}parse(E){return O.JSON.parse(E,void 0)}};function na(){}na.prototype.h=null;function fs(E){return E.h||(E.h=E.i())}function _s(){}var Us={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ra(){Ot.call(this,"d")}yt(ra,Ot);function Xa(){Ot.call(this,"c")}yt(Xa,Ot);var xs={},Vs=null;function Qa(){return Vs=Vs||new Er}xs.La="serverreachability";function ms(E){Ot.call(this,xs.La,E)}yt(ms,Ot);function _o(E){const A=Qa();pn(A,new ms(A))}xs.STAT_EVENT="statevent";function El(E,A){Ot.call(this,xs.STAT_EVENT,E),this.stat=A}yt(El,Ot);function Vr(E){const A=Qa();pn(A,new El(A,E))}xs.Ma="timingevent";function Fr(E,A){Ot.call(this,xs.Ma,E),this.size=A}yt(Fr,Ot);function ia(E,A){if(typeof E!="function")throw Error("Fn must not be null and must be a function");return O.setTimeout(function(){E()},A)}function sa(){this.g=!0}sa.prototype.xa=function(){this.g=!1};function $a(E,A,k,B,dt,pt){E.info(function(){if(E.g)if(pt)for(var Ft="",Vn=pt.split("&"),Qn=0;Qn<Vn.length;Qn++){var fn=Vn[Qn].split("=");if(1<fn.length){var Jr=fn[0];fn=fn[1];var Xr=Jr.split("_");Ft=2<=Xr.length&&Xr[1]=="type"?Ft+(Jr+"="+fn+"&"):Ft+(Jr+"=redacted&")}}else Ft=null;else Ft=pt;return"XMLHTTP REQ ("+B+") [attempt "+dt+"]: "+A+`
`+k+`
`+Ft})}function gl(E,A,k,B,dt,pt,Ft){E.info(function(){return"XMLHTTP RESP ("+B+") [ attempt "+dt+"]: "+A+`
`+k+`
`+pt+" "+Ft})}function Q(E,A,k,B){E.info(function(){return"XMLHTTP TEXT ("+A+"): "+Jt(E,k)+(B?" "+B:"")})}function kt(E,A){E.info(function(){return"TIMEOUT: "+A})}sa.prototype.info=function(){};function Jt(E,A){if(!E.g)return A;if(!A)return null;try{var k=JSON.parse(A);if(k){for(E=0;E<k.length;E++)if(Array.isArray(k[E])){var B=k[E];if(!(2>B.length)){var dt=B[1];if(Array.isArray(dt)&&!(1>dt.length)){var pt=dt[0];if(pt!="noop"&&pt!="stop"&&pt!="close")for(var Ft=1;Ft<dt.length;Ft++)dt[Ft]=""}}}}return $i(k)}catch{return A}}var _e={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},rn={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},gn;function He(){}yt(He,na),He.prototype.g=function(){return new XMLHttpRequest},He.prototype.i=function(){return{}},gn=new He;function be(E,A,k,B){this.j=E,this.i=A,this.l=k,this.R=B||1,this.U=new fo(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new gr}function gr(){this.i=null,this.g="",this.h=!1}var Jn={},wn={};function zr(E,A,k){E.L=1,E.v=da(Bs(A)),E.m=k,E.P=!0,Fs(E,null)}function Fs(E,A){E.F=Date.now(),Tl(E),E.A=Bs(E.v);var k=E.A,B=E.R;Array.isArray(B)||(B=[String(B)]),e_(k.i,"t",B),E.C=0,k=E.j.J,E.h=new gr,E.g=__(E.j,k?A:null,!E.m),0<E.O&&(E.M=new _l(st(E.Y,E,E.g),E.O)),A=E.U,k=E.g,B=E.ca;var dt="readystatechange";Array.isArray(dt)||(dt&&(Yc[0]=dt.toString()),dt=Yc);for(var pt=0;pt<dt.length;pt++){var Ft=$o(k,dt[pt],B||A.handleEvent,!1,A.h||A);if(!Ft)break;A.g[Ft.key]=Ft}A=E.H?q(E.H):{},E.m?(E.u||(E.u="POST"),A["Content-Type"]="application/x-www-form-urlencoded",E.g.ea(E.A,E.u,E.m,A)):(E.u="GET",E.g.ea(E.A,E.u,null,A)),_o(),$a(E.i,E.u,E.A,E.l,E.R,E.m)}be.prototype.ca=function(E){E=E.target;const A=this.M;A&&js(E)==3?A.j():this.Y(E)},be.prototype.Y=function(E){try{if(E==this.g)t:{const Xr=js(this.g);var A=this.g.Ba();const fa=this.g.Z();if(!(3>Xr)&&(Xr!=3||this.g&&(this.h.h||this.g.oa()||l_(this.g)))){this.J||Xr!=4||A==7||(A==8||0>=fa?_o(3):_o(2)),Eh(this);var k=this.g.Z();this.X=k;e:if(gi(this)){var B=l_(this.g);E="";var dt=B.length,pt=js(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){oa(this),Jc(this);var Ft="";break e}this.h.i=new O.TextDecoder}for(A=0;A<dt;A++)this.h.h=!0,E+=this.h.i.decode(B[A],{stream:!(pt&&A==dt-1)});B.length=0,this.h.g+=E,this.C=0,Ft=this.h.g}else Ft=this.g.oa();if(this.o=k==200,gl(this.i,this.u,this.A,this.l,this.R,Xr,k),this.o){if(this.T&&!this.K){e:{if(this.g){var Vn,Qn=this.g;if((Vn=Qn.g?Qn.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!Nt(Vn)){var fn=Vn;break e}}fn=null}if(k=fn)Q(this.i,this.l,k,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,gh(this,k);else{this.o=!1,this.s=3,Vr(12),oa(this),Jc(this);break t}}if(this.P){k=!0;let Ni;for(;!this.J&&this.C<Ft.length;)if(Ni=Zi(this,Ft),Ni==wn){Xr==4&&(this.s=4,Vr(14),k=!1),Q(this.i,this.l,null,"[Incomplete Response]");break}else if(Ni==Jn){this.s=4,Vr(15),Q(this.i,this.l,Ft,"[Invalid Chunk]"),k=!1;break}else Q(this.i,this.l,Ni,null),gh(this,Ni);if(gi(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Xr!=4||Ft.length!=0||this.h.h||(this.s=1,Vr(16),k=!1),this.o=this.o&&k,!k)Q(this.i,this.l,Ft,"[Invalid Chunked Response]"),oa(this),Jc(this);else if(0<Ft.length&&!this.W){this.W=!0;var Jr=this.j;Jr.g==this&&Jr.ba&&!Jr.M&&(Jr.j.info("Great, no buffering proxy detected. Bytes received: "+Ft.length),wh(Jr),Jr.M=!0,Vr(11))}}else Q(this.i,this.l,Ft,null),gh(this,Ft);Xr==4&&oa(this),this.o&&!this.J&&(Xr==4?f_(this.j,this):(this.o=!1,Tl(this)))}else Al(this.g),k==400&&0<Ft.indexOf("Unknown SID")?(this.s=3,Vr(12)):(this.s=0,Vr(13)),oa(this),Jc(this)}}}catch{}finally{}};function gi(E){return E.g?E.u=="GET"&&E.L!=2&&E.j.Ca:!1}function Zi(E,A){var k=E.C,B=A.indexOf(`
`,k);return B==-1?wn:(k=Number(A.substring(k,B)),isNaN(k)?Jn:(B+=1,B+k>A.length?wn:(A=A.slice(B,B+k),E.C=B+k,A)))}be.prototype.cancel=function(){this.J=!0,oa(this)};function Tl(E){E.S=Date.now()+E.I,or(E,E.I)}function or(E,A){if(E.B!=null)throw Error("WatchDog timer not null");E.B=ia(st(E.ba,E),A)}function Eh(E){E.B&&(O.clearTimeout(E.B),E.B=null)}be.prototype.ba=function(){this.B=null;const E=Date.now();0<=E-this.S?(kt(this.i,this.A),this.L!=2&&(_o(),Vr(17)),oa(this),this.s=2,Jc(this)):or(this,this.S-E)};function Jc(E){E.j.G==0||E.J||f_(E.j,E)}function oa(E){Eh(E);var A=E.M;A&&typeof A.ma=="function"&&A.ma(),E.M=null,zc(E.U),E.g&&(A=E.g,E.g=null,A.abort(),A.ma())}function gh(E,A){try{var k=E.j;if(k.G!=0&&(k.g==E||vh(k.h,E))){if(!E.K&&vh(k.h,E)&&k.G==3){try{var B=k.Da.g.parse(A)}catch{B=null}if(Array.isArray(B)&&B.length==3){var dt=B;if(dt[0]==0){t:if(!k.u){if(k.g)if(k.g.F+3e3<E.F)Ol(k),wl(k);else break t;Ah(k),Vr(18)}}else k.za=dt[1],0<k.za-k.T&&37500>dt[2]&&k.F&&k.v==0&&!k.C&&(k.C=ia(st(k.Za,k),6e3));if(1>=zf(k.h)&&k.ca){try{k.ca()}catch{}k.ca=void 0}}else ha(k,11)}else if((E.K||k.g==E)&&Ol(k),!Nt(A))for(dt=k.Da.g.parse(A),A=0;A<dt.length;A++){let fn=dt[A];if(k.T=fn[0],fn=fn[1],k.G==2)if(fn[0]=="c"){k.K=fn[1],k.ia=fn[2];const Jr=fn[3];Jr!=null&&(k.la=Jr,k.j.info("VER="+k.la));const Xr=fn[4];Xr!=null&&(k.Aa=Xr,k.j.info("SVER="+k.Aa));const fa=fn[5];fa!=null&&typeof fa=="number"&&0<fa&&(B=1.5*fa,k.L=B,k.j.info("backChannelRequestTimeoutMs_="+B)),B=k;const Ni=E.g;if(Ni){const Pl=Ni.g?Ni.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Pl){var pt=B.h;pt.g||Pl.indexOf("spdy")==-1&&Pl.indexOf("quic")==-1&&Pl.indexOf("h2")==-1||(pt.j=pt.l,pt.g=new Set,pt.h&&(yh(pt,pt.h),pt.h=null))}if(B.D){const Oh=Ni.g?Ni.g.getResponseHeader("X-HTTP-Session-Id"):null;Oh&&(B.ya=Oh,Xn(B.I,B.D,Oh))}}k.G=3,k.l&&k.l.ua(),k.ba&&(k.R=Date.now()-E.F,k.j.info("Handshake RTT: "+k.R+"ms")),B=k;var Ft=E;if(B.qa=bh(B,B.J?B.ia:null,B.W),Ft.K){aa(B.h,Ft);var Vn=Ft,Qn=B.L;Qn&&(Vn.I=Qn),Vn.B&&(Eh(Vn),Tl(Vn)),B.g=Ft}else ed(B);0<k.i.length&&rc(k)}else fn[0]!="stop"&&fn[0]!="close"||ha(k,7);else k.G==3&&(fn[0]=="stop"||fn[0]=="close"?fn[0]=="stop"?ha(k,7):Zc(k):fn[0]!="noop"&&k.l&&k.l.ta(fn),k.v=0)}}_o(4)}catch{}}var Th=class{constructor(E,A){this.g=E,this.map=A}};function Yf(E){this.l=E||10,O.PerformanceNavigationTiming?(E=O.performance.getEntriesByType("navigation"),E=0<E.length&&(E[0].nextHopProtocol=="hq"||E[0].nextHopProtocol=="h2")):E=!!(O.chrome&&O.chrome.loadTimes&&O.chrome.loadTimes()&&O.chrome.loadTimes().wasFetchedViaSpdy),this.j=E?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Sh(E){return E.h?!0:E.g?E.g.size>=E.j:!1}function zf(E){return E.h?1:E.g?E.g.size:0}function vh(E,A){return E.h?E.h==A:E.g?E.g.has(A):!1}function yh(E,A){E.g?E.g.add(A):E.h=A}function aa(E,A){E.h&&E.h==A?E.h=null:E.g&&E.g.has(A)&&E.g.delete(A)}Yf.prototype.cancel=function(){if(this.i=Sl(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const E of this.g.values())E.cancel();this.g.clear()}};function Sl(E){if(E.h!=null)return E.i.concat(E.h.D);if(E.g!=null&&E.g.size!==0){let A=E.i;for(const k of E.g.values())A=A.concat(k.D);return A}return Vt(E.i)}function UT(E){if(E.V&&typeof E.V=="function")return E.V();if(typeof Map<"u"&&E instanceof Map||typeof Set<"u"&&E instanceof Set)return Array.from(E.values());if(typeof E=="string")return E.split("");if(L(E)){for(var A=[],k=E.length,B=0;B<k;B++)A.push(E[B]);return A}A=[],k=0;for(B in E)A[k++]=E[B];return A}function bn(E){if(E.na&&typeof E.na=="function")return E.na();if(!E.V||typeof E.V!="function"){if(typeof Map<"u"&&E instanceof Map)return Array.from(E.keys());if(!(typeof Set<"u"&&E instanceof Set)){if(L(E)||typeof E=="string"){var A=[];E=E.length;for(var k=0;k<E;k++)A.push(k);return A}A=[],k=0;for(const B in E)A[k++]=B;return A}}}function Jf(E,A){if(E.forEach&&typeof E.forEach=="function")E.forEach(A,void 0);else if(L(E)||typeof E=="string")Array.prototype.forEach.call(E,A,void 0);else for(var k=bn(E),B=UT(E),dt=B.length,pt=0;pt<dt;pt++)A.call(void 0,B[pt],k&&k[pt],E)}var Rh=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Xf(E,A){if(E){E=E.split("&");for(var k=0;k<E.length;k++){var B=E[k].indexOf("="),dt=null;if(0<=B){var pt=E[k].substring(0,B);dt=E[k].substring(B+1)}else pt=E[k];A(pt,dt?decodeURIComponent(dt.replace(/\+/g," ")):"")}}}function ca(E){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,E instanceof ca){this.h=E.h,vl(this,E.j),this.o=E.o,this.g=E.g,yl(this,E.s),this.l=E.l;var A=E.i,k=new Xc;k.i=A.i,A.g&&(k.g=new Map(A.g),k.h=A.h),Qf(this,k),this.m=E.m}else E&&(A=String(E).match(Rh))?(this.h=!1,vl(this,A[1]||"",!0),this.o=Za(A[2]||""),this.g=Za(A[3]||"",!0),yl(this,A[4]),this.l=Za(A[5]||"",!0),Qf(this,A[6]||"",!0),this.m=Za(A[7]||"")):(this.h=!1,this.i=new Xc(null,this.h))}ca.prototype.toString=function(){var E=[],A=this.j;A&&E.push(la(A,Rl,!0),":");var k=this.g;return(k||A=="file")&&(E.push("//"),(A=this.o)&&E.push(la(A,Rl,!0),"@"),E.push(encodeURIComponent(String(k)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),k=this.s,k!=null&&E.push(":",String(k))),(k=this.l)&&(this.g&&k.charAt(0)!="/"&&E.push("/"),E.push(la(k,k.charAt(0)=="/"?$f:VT,!0))),(k=this.i.toString())&&E.push("?",k),(k=this.m)&&E.push("#",la(k,BT)),E.join("")};function Bs(E){return new ca(E)}function vl(E,A,k){E.j=k?Za(A,!0):A,E.j&&(E.j=E.j.replace(/:$/,""))}function yl(E,A){if(A){if(A=Number(A),isNaN(A)||0>A)throw Error("Bad port number "+A);E.s=A}else E.s=null}function Qf(E,A,k){A instanceof Xc?(E.i=A,n_(E.i,E.h)):(k||(A=la(A,FT)),E.i=new Xc(A,E.h))}function Xn(E,A,k){E.i.set(A,k)}function da(E){return Xn(E,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),E}function Za(E,A){return E?A?decodeURI(E.replace(/%25/g,"%2525")):decodeURIComponent(E):""}function la(E,A,k){return typeof E=="string"?(E=encodeURI(E).replace(A,xT),k&&(E=E.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),E):null}function xT(E){return E=E.charCodeAt(0),"%"+(E>>4&15).toString(16)+(E&15).toString(16)}var Rl=/[#\/\?@]/g,VT=/[#\?:]/g,$f=/[#\?]/g,FT=/[#\?@]/g,BT=/#/g;function Xc(E,A){this.h=this.g=null,this.i=E||null,this.j=!!A}function mo(E){E.g||(E.g=new Map,E.h=0,E.i&&Xf(E.i,function(A,k){E.add(decodeURIComponent(A.replace(/\+/g," ")),k)}))}u=Xc.prototype,u.add=function(E,A){mo(this),this.i=null,E=tc(this,E);var k=this.g.get(E);return k||this.g.set(E,k=[]),k.push(A),this.h+=1,this};function Zf(E,A){mo(E),A=tc(E,A),E.g.has(A)&&(E.i=null,E.h-=E.g.get(A).length,E.g.delete(A))}function t_(E,A){return mo(E),A=tc(E,A),E.g.has(A)}u.forEach=function(E,A){mo(this),this.g.forEach(function(k,B){k.forEach(function(dt){E.call(A,dt,B,this)},this)},this)},u.na=function(){mo(this);const E=Array.from(this.g.values()),A=Array.from(this.g.keys()),k=[];for(let B=0;B<A.length;B++){const dt=E[B];for(let pt=0;pt<dt.length;pt++)k.push(A[B])}return k},u.V=function(E){mo(this);let A=[];if(typeof E=="string")t_(this,E)&&(A=A.concat(this.g.get(tc(this,E))));else{E=Array.from(this.g.values());for(let k=0;k<E.length;k++)A=A.concat(E[k])}return A},u.set=function(E,A){return mo(this),this.i=null,E=tc(this,E),t_(this,E)&&(this.h-=this.g.get(E).length),this.g.set(E,[A]),this.h+=1,this},u.get=function(E,A){return E?(E=this.V(E),0<E.length?String(E[0]):A):A};function e_(E,A,k){Zf(E,A),0<k.length&&(E.i=null,E.g.set(tc(E,A),Vt(k)),E.h+=k.length)}u.toString=function(){if(this.i)return this.i;if(!this.g)return"";const E=[],A=Array.from(this.g.keys());for(var k=0;k<A.length;k++){var B=A[k];const pt=encodeURIComponent(String(B)),Ft=this.V(B);for(B=0;B<Ft.length;B++){var dt=pt;Ft[B]!==""&&(dt+="="+encodeURIComponent(String(Ft[B]))),E.push(dt)}}return this.i=E.join("&")};function tc(E,A){return A=String(A),E.j&&(A=A.toLowerCase()),A}function n_(E,A){A&&!E.j&&(mo(E),E.i=null,E.g.forEach(function(k,B){var dt=B.toLowerCase();B!=dt&&(Zf(this,B),e_(this,dt,k))},E)),E.j=A}function jT(E,A){const k=new sa;if(O.Image){const B=new Image;B.onload=ht(Eo,k,"TestLoadImage: loaded",!0,A,B),B.onerror=ht(Eo,k,"TestLoadImage: error",!1,A,B),B.onabort=ht(Eo,k,"TestLoadImage: abort",!1,A,B),B.ontimeout=ht(Eo,k,"TestLoadImage: timeout",!1,A,B),O.setTimeout(function(){B.ontimeout&&B.ontimeout()},1e4),B.src=E}else A(!1)}function GT(E,A){const k=new sa,B=new AbortController,dt=setTimeout(()=>{B.abort(),Eo(k,"TestPingServer: timeout",!1,A)},1e4);fetch(E,{signal:B.signal}).then(pt=>{clearTimeout(dt),pt.ok?Eo(k,"TestPingServer: ok",!0,A):Eo(k,"TestPingServer: server error",!1,A)}).catch(()=>{clearTimeout(dt),Eo(k,"TestPingServer: error",!1,A)})}function Eo(E,A,k,B,dt){try{dt&&(dt.onload=null,dt.onerror=null,dt.onabort=null,dt.ontimeout=null),B(k)}catch{}}function Qc(){this.g=new mh}function WT(E,A,k){const B=k||"";try{Jf(E,function(dt,pt){let Ft=dt;V(dt)&&(Ft=$i(dt)),A.push(B+pt+"="+encodeURIComponent(Ft))})}catch(dt){throw A.push(B+"type="+encodeURIComponent("_badmap")),dt}}function Il(E){this.l=E.Ub||null,this.j=E.eb||!1}yt(Il,na),Il.prototype.g=function(){return new Cl(this.l,this.j)},Il.prototype.i=function(E){return function(){return E}}({});function Cl(E,A){Er.call(this),this.D=E,this.o=A,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}yt(Cl,Er),u=Cl.prototype,u.open=function(E,A){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=E,this.A=A,this.readyState=1,$c(this)},u.send=function(E){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const A={headers:this.u,method:this.B,credentials:this.m,cache:void 0};E&&(A.body=E),(this.D||O).fetch(new Request(this.A,A)).then(this.Sa.bind(this),this.ga.bind(this))},u.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,ec(this)),this.readyState=0},u.Sa=function(E){if(this.g&&(this.l=E,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=E.headers,this.readyState=2,$c(this)),this.g&&(this.readyState=3,$c(this),this.g)))if(this.responseType==="arraybuffer")E.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof O.ReadableStream<"u"&&"body"in E){if(this.j=E.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;r_(this)}else E.text().then(this.Ra.bind(this),this.ga.bind(this))};function r_(E){E.j.read().then(E.Pa.bind(E)).catch(E.ga.bind(E))}u.Pa=function(E){if(this.g){if(this.o&&E.value)this.response.push(E.value);else if(!this.o){var A=E.value?E.value:new Uint8Array(0);(A=this.v.decode(A,{stream:!E.done}))&&(this.response=this.responseText+=A)}E.done?ec(this):$c(this),this.readyState==3&&r_(this)}},u.Ra=function(E){this.g&&(this.response=this.responseText=E,ec(this))},u.Qa=function(E){this.g&&(this.response=E,ec(this))},u.ga=function(){this.g&&ec(this)};function ec(E){E.readyState=4,E.l=null,E.j=null,E.v=null,$c(E)}u.setRequestHeader=function(E,A){this.u.append(E,A)},u.getResponseHeader=function(E){return this.h&&this.h.get(E.toLowerCase())||""},u.getAllResponseHeaders=function(){if(!this.h)return"";const E=[],A=this.h.entries();for(var k=A.next();!k.done;)k=k.value,E.push(k[0]+": "+k[1]),k=A.next();return E.join(`\r
`)};function $c(E){E.onreadystatechange&&E.onreadystatechange.call(E)}Object.defineProperty(Cl.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(E){this.m=E?"include":"same-origin"}});function i_(E){let A="";return ae(E,function(k,B){A+=B,A+=":",A+=k,A+=`\r
`}),A}function Ih(E,A,k){t:{for(B in k){var B=!1;break t}B=!0}B||(k=i_(k),typeof E=="string"?k!=null&&encodeURIComponent(String(k)):Xn(E,A,k))}function On(E){Er.call(this),this.headers=new Map,this.o=E||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}yt(On,Er);var xi=/^https?$/i,s_=["POST","PUT"];u=On.prototype,u.Ha=function(E){this.J=E},u.ea=function(E,A,k,B){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+E);A=A?A.toUpperCase():"GET",this.D=E,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():gn.g(),this.v=this.o?fs(this.o):fs(gn),this.g.onreadystatechange=st(this.Ea,this);try{this.B=!0,this.g.open(A,String(E),!0),this.B=!1}catch(pt){o_(this,pt);return}if(E=k||"",k=new Map(this.headers),B)if(Object.getPrototypeOf(B)===Object.prototype)for(var dt in B)k.set(dt,B[dt]);else if(typeof B.keys=="function"&&typeof B.get=="function")for(const pt of B.keys())k.set(pt,B.get(pt));else throw Error("Unknown input type for opt_headers: "+String(B));B=Array.from(k.keys()).find(pt=>pt.toLowerCase()=="content-type"),dt=O.FormData&&E instanceof O.FormData,!(0<=Array.prototype.indexOf.call(s_,A,void 0))||B||dt||k.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[pt,Ft]of k)this.g.setRequestHeader(pt,Ft);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{d_(this),this.u=!0,this.g.send(E),this.u=!1}catch(pt){o_(this,pt)}};function o_(E,A){E.h=!1,E.g&&(E.j=!0,E.g.abort(),E.j=!1),E.l=A,E.m=5,a_(E),br(E)}function a_(E){E.A||(E.A=!0,pn(E,"complete"),pn(E,"error"))}u.abort=function(E){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=E||7,pn(this,"complete"),pn(this,"abort"),br(this))},u.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),br(this,!0)),On.aa.N.call(this)},u.Ea=function(){this.s||(this.B||this.u||this.j?c_(this):this.bb())},u.bb=function(){c_(this)};function c_(E){if(E.h&&typeof y<"u"&&(!E.v[1]||js(E)!=4||E.Z()!=2)){if(E.u&&js(E)==4)Ja(E.Ea,0,E);else if(pn(E,"readystatechange"),js(E)==4){E.h=!1;try{const Ft=E.Z();t:switch(Ft){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var A=!0;break t;default:A=!1}var k;if(!(k=A)){var B;if(B=Ft===0){var dt=String(E.D).match(Rh)[1]||null;!dt&&O.self&&O.self.location&&(dt=O.self.location.protocol.slice(0,-1)),B=!xi.test(dt?dt.toLowerCase():"")}k=B}if(k)pn(E,"complete"),pn(E,"success");else{E.m=6;try{var pt=2<js(E)?E.g.statusText:""}catch{pt=""}E.l=pt+" ["+E.Z()+"]",a_(E)}}finally{br(E)}}}}function br(E,A){if(E.g){d_(E);const k=E.g,B=E.v[0]?()=>{}:null;E.g=null,E.v=null,A||pn(E,"ready");try{k.onreadystatechange=B}catch{}}}function d_(E){E.I&&(O.clearTimeout(E.I),E.I=null)}u.isActive=function(){return!!this.g};function js(E){return E.g?E.g.readyState:0}u.Z=function(){try{return 2<js(this)?this.g.status:-1}catch{return-1}},u.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},u.Oa=function(E){if(this.g){var A=this.g.responseText;return E&&A.indexOf(E)==0&&(A=A.substring(E.length)),ml(A)}};function l_(E){try{if(!E.g)return null;if("response"in E.g)return E.g.response;switch(E.H){case"":case"text":return E.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in E.g)return E.g.mozResponseArrayBuffer}return null}catch{return null}}function Al(E){const A={};E=(E.g&&2<=js(E)&&E.g.getAllResponseHeaders()||"").split(`\r
`);for(let B=0;B<E.length;B++){if(Nt(E[B]))continue;var k=rt(E[B]);const dt=k[0];if(k=k[1],typeof k!="string")continue;k=k.trim();const pt=A[dt]||[];A[dt]=pt,pt.push(k)}J(A,function(B){return B.join(", ")})}u.Ba=function(){return this.m},u.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function nc(E,A,k){return k&&k.internalChannelParams&&k.internalChannelParams[E]||A}function u_(E){this.Aa=0,this.i=[],this.j=new sa,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=nc("failFast",!1,E),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=nc("baseRetryDelayMs",5e3,E),this.cb=nc("retryDelaySeedMs",1e4,E),this.Wa=nc("forwardChannelMaxRetries",2,E),this.wa=nc("forwardChannelRequestTimeoutMs",2e4,E),this.pa=E&&E.xmlHttpFactory||void 0,this.Xa=E&&E.Tb||void 0,this.Ca=E&&E.useFetchStreams||!1,this.L=void 0,this.J=E&&E.supportsCrossDomainXhr||!1,this.K="",this.h=new Yf(E&&E.concurrentRequestLimit),this.Da=new Qc,this.P=E&&E.fastHandshake||!1,this.O=E&&E.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=E&&E.Rb||!1,E&&E.xa&&this.j.xa(),E&&E.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&E&&E.detectBufferingProxy||!1,this.ja=void 0,E&&E.longPollingTimeout&&0<E.longPollingTimeout&&(this.ja=E.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}u=u_.prototype,u.la=8,u.G=1,u.connect=function(E,A,k,B){Vr(0),this.W=E,this.H=A||{},k&&B!==void 0&&(this.H.OSID=k,this.H.OAID=B),this.F=this.X,this.I=bh(this,null,this.W),rc(this)};function Zc(E){if(bl(E),E.G==3){var A=E.U++,k=Bs(E.I);if(Xn(k,"SID",E.K),Xn(k,"RID",A),Xn(k,"TYPE","terminate"),td(E,k),A=new be(E,E.j,A),A.L=2,A.v=da(Bs(k)),k=!1,O.navigator&&O.navigator.sendBeacon)try{k=O.navigator.sendBeacon(A.v.toString(),"")}catch{}!k&&O.Image&&(new Image().src=A.v,k=!0),k||(A.g=__(A.j,null),A.g.ea(A.v)),A.F=Date.now(),Tl(A)}pa(E)}function wl(E){E.g&&(wh(E),E.g.cancel(),E.g=null)}function bl(E){wl(E),E.u&&(O.clearTimeout(E.u),E.u=null),Ol(E),E.h.cancel(),E.s&&(typeof E.s=="number"&&O.clearTimeout(E.s),E.s=null)}function rc(E){if(!Sh(E.h)&&!E.s){E.s=!0;var A=E.Ga;nn||Pt(),lr||(nn(),lr=!0),an.add(A,E),E.B=0}}function Ch(E,A){return zf(E.h)>=E.h.j-(E.s?1:0)?!1:E.s?(E.i=A.D.concat(E.i),!0):E.G==1||E.G==2||E.B>=(E.Va?0:E.Wa)?!1:(E.s=ia(st(E.Ga,E,A),ua(E,E.B)),E.B++,!0)}u.Ga=function(E){if(this.s)if(this.s=null,this.G==1){if(!E){this.U=Math.floor(1e5*Math.random()),E=this.U++;const dt=new be(this,this.j,E);let pt=this.o;if(this.S&&(pt?(pt=q(pt),Z(pt,this.S)):pt=this.S),this.m!==null||this.O||(dt.H=pt,pt=null),this.P)t:{for(var A=0,k=0;k<this.i.length;k++){e:{var B=this.i[k];if("__data__"in B.map&&(B=B.map.__data__,typeof B=="string")){B=B.length;break e}B=void 0}if(B===void 0)break;if(A+=B,4096<A){A=k;break t}if(A===4096||k===this.i.length-1){A=k+1;break t}}A=1e3}else A=1e3;A=Gs(this,dt,A),k=Bs(this.I),Xn(k,"RID",E),Xn(k,"CVER",22),this.D&&Xn(k,"X-HTTP-Session-Id",this.D),td(this,k),pt&&(this.O?A="headers="+encodeURIComponent(String(i_(pt)))+"&"+A:this.m&&Ih(k,this.m,pt)),yh(this.h,dt),this.Ua&&Xn(k,"TYPE","init"),this.P?(Xn(k,"$req",A),Xn(k,"SID","null"),dt.T=!0,zr(dt,k,null)):zr(dt,k,A),this.G=2}}else this.G==3&&(E?h_(this,E):this.i.length==0||Sh(this.h)||h_(this))};function h_(E,A){var k;A?k=A.l:k=E.U++;const B=Bs(E.I);Xn(B,"SID",E.K),Xn(B,"RID",k),Xn(B,"AID",E.T),td(E,B),E.m&&E.o&&Ih(B,E.m,E.o),k=new be(E,E.j,k,E.B+1),E.m===null&&(k.H=E.o),A&&(E.i=A.D.concat(E.i)),A=Gs(E,k,1e3),k.I=Math.round(.5*E.wa)+Math.round(.5*E.wa*Math.random()),yh(E.h,k),zr(k,B,A)}function td(E,A){E.H&&ae(E.H,function(k,B){Xn(A,B,k)}),E.l&&Jf({},function(k,B){Xn(A,B,k)})}function Gs(E,A,k){k=Math.min(E.i.length,k);var B=E.l?st(E.l.Na,E.l,E):null;t:{var dt=E.i;let pt=-1;for(;;){const Ft=["count="+k];pt==-1?0<k?(pt=dt[0].g,Ft.push("ofs="+pt)):pt=0:Ft.push("ofs="+pt);let Vn=!0;for(let Qn=0;Qn<k;Qn++){let fn=dt[Qn].g;const Jr=dt[Qn].map;if(fn-=pt,0>fn)pt=Math.max(0,dt[Qn].g-100),Vn=!1;else try{WT(Jr,Ft,"req"+fn+"_")}catch{B&&B(Jr)}}if(Vn){B=Ft.join("&");break t}}}return E=E.i.splice(0,k),A.D=E,B}function ed(E){if(!E.g&&!E.u){E.Y=1;var A=E.Fa;nn||Pt(),lr||(nn(),lr=!0),an.add(A,E),E.v=0}}function Ah(E){return E.g||E.u||3<=E.v?!1:(E.Y++,E.u=ia(st(E.Fa,E),ua(E,E.v)),E.v++,!0)}u.Fa=function(){if(this.u=null,p_(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var E=2*this.R;this.j.info("BP detection timer enabled: "+E),this.A=ia(st(this.ab,this),E)}},u.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Vr(10),wl(this),p_(this))};function wh(E){E.A!=null&&(O.clearTimeout(E.A),E.A=null)}function p_(E){E.g=new be(E,E.j,"rpc",E.Y),E.m===null&&(E.g.H=E.o),E.g.O=0;var A=Bs(E.qa);Xn(A,"RID","rpc"),Xn(A,"SID",E.K),Xn(A,"AID",E.T),Xn(A,"CI",E.F?"0":"1"),!E.F&&E.ja&&Xn(A,"TO",E.ja),Xn(A,"TYPE","xmlhttp"),td(E,A),E.m&&E.o&&Ih(A,E.m,E.o),E.L&&(E.g.I=E.L);var k=E.g;E=E.ia,k.L=1,k.v=da(Bs(A)),k.m=null,k.P=!0,Fs(k,E)}u.Za=function(){this.C!=null&&(this.C=null,wl(this),Ah(this),Vr(19))};function Ol(E){E.C!=null&&(O.clearTimeout(E.C),E.C=null)}function f_(E,A){var k=null;if(E.g==A){Ol(E),wh(E),E.g=null;var B=2}else if(vh(E.h,A))k=A.D,aa(E.h,A),B=1;else return;if(E.G!=0){if(A.o)if(B==1){k=A.m?A.m.length:0,A=Date.now()-A.F;var dt=E.B;B=Qa(),pn(B,new Fr(B,k)),rc(E)}else ed(E);else if(dt=A.s,dt==3||dt==0&&0<A.X||!(B==1&&Ch(E,A)||B==2&&Ah(E)))switch(k&&0<k.length&&(A=E.h,A.i=A.i.concat(k)),dt){case 1:ha(E,5);break;case 4:ha(E,10);break;case 3:ha(E,6);break;default:ha(E,2)}}}function ua(E,A){let k=E.Ta+Math.floor(Math.random()*E.cb);return E.isActive()||(k*=2),k*A}function ha(E,A){if(E.j.info("Error code "+A),A==2){var k=st(E.fb,E),B=E.Xa;const dt=!B;B=new ca(B||"//www.google.com/images/cleardot.gif"),O.location&&O.location.protocol=="http"||vl(B,"https"),da(B),dt?jT(B.toString(),k):GT(B.toString(),k)}else Vr(2);E.G=0,E.l&&E.l.sa(A),pa(E),bl(E)}u.fb=function(E){E?(this.j.info("Successfully pinged google.com"),Vr(2)):(this.j.info("Failed to ping google.com"),Vr(1))};function pa(E){if(E.G=0,E.ka=[],E.l){const A=Sl(E.h);(A.length!=0||E.i.length!=0)&&(wt(E.ka,A),wt(E.ka,E.i),E.h.i.length=0,Vt(E.i),E.i.length=0),E.l.ra()}}function bh(E,A,k){var B=k instanceof ca?Bs(k):new ca(k);if(B.g!="")A&&(B.g=A+"."+B.g),yl(B,B.s);else{var dt=O.location;B=dt.protocol,A=A?A+"."+dt.hostname:dt.hostname,dt=+dt.port;var pt=new ca(null);B&&vl(pt,B),A&&(pt.g=A),dt&&yl(pt,dt),k&&(pt.l=k),B=pt}return k=E.D,A=E.ya,k&&A&&Xn(B,k,A),Xn(B,"VER",E.la),td(E,B),B}function __(E,A,k){if(A&&!E.J)throw Error("Can't create secondary domain capable XhrIo object.");return A=E.Ca&&!E.pa?new On(new Il({eb:k})):new On(E.pa),A.Ha(E.J),A}u.isActive=function(){return!!this.l&&this.l.isActive(this)};function Me(){}u=Me.prototype,u.ua=function(){},u.ta=function(){},u.sa=function(){},u.ra=function(){},u.isActive=function(){return!0},u.Na=function(){};function Nl(){}Nl.prototype.g=function(E,A){return new Oi(E,A)};function Oi(E,A){Er.call(this),this.g=new u_(A),this.l=E,this.h=A&&A.messageUrlParams||null,E=A&&A.messageHeaders||null,A&&A.clientProtocolHeaderRequired&&(E?E["X-Client-Protocol"]="webchannel":E={"X-Client-Protocol":"webchannel"}),this.g.o=E,E=A&&A.initMessageHeaders||null,A&&A.messageContentType&&(E?E["X-WebChannel-Content-Type"]=A.messageContentType:E={"X-WebChannel-Content-Type":A.messageContentType}),A&&A.va&&(E?E["X-WebChannel-Client-Profile"]=A.va:E={"X-WebChannel-Client-Profile":A.va}),this.g.S=E,(E=A&&A.Sb)&&!Nt(E)&&(this.g.m=E),this.v=A&&A.supportsCrossDomainXhr||!1,this.u=A&&A.sendRawJson||!1,(A=A&&A.httpSessionIdParam)&&!Nt(A)&&(this.g.D=A,E=this.h,E!==null&&A in E&&(E=this.h,A in E&&delete E[A])),this.j=new go(this)}yt(Oi,Er),Oi.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Oi.prototype.close=function(){Zc(this.g)},Oi.prototype.o=function(E){var A=this.g;if(typeof E=="string"){var k={};k.__data__=E,E=k}else this.u&&(k={},k.__data__=$i(E),E=k);A.i.push(new Th(A.Ya++,E)),A.G==3&&rc(A)},Oi.prototype.N=function(){this.g.l=null,delete this.j,Zc(this.g),delete this.g,Oi.aa.N.call(this)};function m_(E){ra.call(this),E.__headers__&&(this.headers=E.__headers__,this.statusCode=E.__status__,delete E.__headers__,delete E.__status__);var A=E.__sm__;if(A){t:{for(const k in A){E=k;break t}E=void 0}(this.i=E)&&(E=this.i,A=A!==null&&E in A?A[E]:void 0),this.data=A}else this.data=E}yt(m_,ra);function E_(){Xa.call(this),this.status=1}yt(E_,Xa);function go(E){this.g=E}yt(go,Me),go.prototype.ua=function(){pn(this.g,"a")},go.prototype.ta=function(E){pn(this.g,new m_(E))},go.prototype.sa=function(E){pn(this.g,new E_)},go.prototype.ra=function(){pn(this.g,"b")},Nl.prototype.createWebChannel=Nl.prototype.g,Oi.prototype.send=Oi.prototype.o,Oi.prototype.open=Oi.prototype.m,Oi.prototype.close=Oi.prototype.close,AC=function(){return new Nl},CC=function(){return Qa()},IC=xs,Ng={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},_e.NO_ERROR=0,_e.TIMEOUT=8,_e.HTTP_ERROR=6,ff=_e,rn.COMPLETE="complete",RC=rn,_s.EventType=Us,Us.OPEN="a",Us.CLOSE="b",Us.ERROR="c",Us.MESSAGE="d",Er.prototype.listen=Er.prototype.K,zu=_s,On.prototype.listenOnce=On.prototype.L,On.prototype.getLastError=On.prototype.Ka,On.prototype.getLastErrorCode=On.prototype.Ba,On.prototype.getStatus=On.prototype.Z,On.prototype.getResponseJson=On.prototype.Oa,On.prototype.getResponseText=On.prototype.oa,On.prototype.send=On.prototype.ea,On.prototype.setWithCredentials=On.prototype.Ha,yC=On}).apply(typeof pf<"u"?pf:typeof self<"u"?self:typeof window<"u"?window:{});const wC="@firebase/firestore";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _i{constructor(s){this.uid=s}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(s){return s.uid===this.uid}}_i.UNAUTHENTICATED=new _i(null),_i.GOOGLE_CREDENTIALS=new _i("google-credentials-uid"),_i.FIRST_PARTY=new _i("first-party-uid"),_i.MOCK_USER=new _i("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let zd="10.14.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const xc=new gg("@firebase/firestore");function Ju(){return xc.logLevel}function se(u,...s){if(xc.logLevel<=on.DEBUG){const c=s.map(Pg);xc.debug(`Firestore (${zd}): ${u}`,...c)}}function Ko(u,...s){if(xc.logLevel<=on.ERROR){const c=s.map(Pg);xc.error(`Firestore (${zd}): ${u}`,...c)}}function Jd(u,...s){if(xc.logLevel<=on.WARN){const c=s.map(Pg);xc.warn(`Firestore (${zd}): ${u}`,...c)}}function Pg(u){if(typeof u=="string")return u;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(c){return JSON.stringify(c)}(u)}catch{return u}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qe(u="Unexpected state"){const s=`FIRESTORE (${zd}) INTERNAL ASSERTION FAILED: `+u;throw Ko(s),new Error(s)}function _r(u,s){u||qe()}function un(u,s){return u}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Kt={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ce extends Wo{constructor(s,c){super(s,c),this.code=s,this.message=c,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Vc{constructor(){this.promise=new Promise((s,c)=>{this.resolve=s,this.reject=c})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bC{constructor(s,c){this.user=c,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${s}`)}}class OB{getToken(){return Promise.resolve(null)}invalidateToken(){}start(s,c){s.enqueueRetryable(()=>c(_i.UNAUTHENTICATED))}shutdown(){}}class NB{constructor(s){this.token=s,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(s,c){this.changeListener=c,s.enqueueRetryable(()=>c(this.token.user))}shutdown(){this.changeListener=null}}class PB{constructor(s){this.t=s,this.currentUser=_i.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(s,c){_r(this.o===void 0);let p=this.i;const _=L=>this.i!==p?(p=this.i,c(L)):Promise.resolve();let g=new Vc;this.o=()=>{this.i++,this.currentUser=this.u(),g.resolve(),g=new Vc,s.enqueueRetryable(()=>_(this.currentUser))};const y=()=>{const L=g;s.enqueueRetryable(async()=>{await L.promise,await _(this.currentUser)})},O=L=>{se("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=L,this.o&&(this.auth.addAuthTokenListener(this.o),y())};this.t.onInit(L=>O(L)),setTimeout(()=>{if(!this.auth){const L=this.t.getImmediate({optional:!0});L?O(L):(se("FirebaseAuthCredentialsProvider","Auth not yet detected"),g.resolve(),g=new Vc)}},0),y()}getToken(){const s=this.i,c=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(c).then(p=>this.i!==s?(se("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):p?(_r(typeof p.accessToken=="string"),new bC(p.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const s=this.auth&&this.auth.getUid();return _r(s===null||typeof s=="string"),new _i(s)}}class DB{constructor(s,c,p){this.l=s,this.h=c,this.P=p,this.type="FirstParty",this.user=_i.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const s=this.T();return s&&this.I.set("Authorization",s),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class kB{constructor(s,c,p){this.l=s,this.h=c,this.P=p}getToken(){return Promise.resolve(new DB(this.l,this.h,this.P))}start(s,c){s.enqueueRetryable(()=>c(_i.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class LB{constructor(s){this.value=s,this.type="AppCheck",this.headers=new Map,s&&s.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class MB{constructor(s){this.A=s,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(s,c){_r(this.o===void 0);const p=g=>{g.error!=null&&se("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${g.error.message}`);const y=g.token!==this.R;return this.R=g.token,se("FirebaseAppCheckTokenProvider",`Received ${y?"new":"existing"} token.`),y?c(g.token):Promise.resolve()};this.o=g=>{s.enqueueRetryable(()=>p(g))};const _=g=>{se("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=g,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(g=>_(g)),setTimeout(()=>{if(!this.appCheck){const g=this.A.getImmediate({optional:!0});g?_(g):se("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const s=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(s).then(c=>c?(_r(typeof c.token=="string"),this.R=c.token,new LB(c.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function UB(u){const s=typeof self<"u"&&(self.crypto||self.msCrypto),c=new Uint8Array(u);if(s&&typeof s.getRandomValues=="function")s.getRandomValues(c);else for(let p=0;p<u;p++)c[p]=Math.floor(256*Math.random());return c}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class OC{static newId(){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=Math.floor(256/s.length)*s.length;let p="";for(;p.length<20;){const _=UB(40);for(let g=0;g<_.length;++g)p.length<20&&_[g]<c&&(p+=s.charAt(_[g]%s.length))}return p}}function An(u,s){return u<s?-1:u>s?1:0}function Xd(u,s,c){return u.length===s.length&&u.every((p,_)=>c(p,s[_]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ui{constructor(s,c){if(this.seconds=s,this.nanoseconds=c,c<0)throw new Ce(Kt.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+c);if(c>=1e9)throw new Ce(Kt.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+c);if(s<-62135596800)throw new Ce(Kt.INVALID_ARGUMENT,"Timestamp seconds out of range: "+s);if(s>=253402300800)throw new Ce(Kt.INVALID_ARGUMENT,"Timestamp seconds out of range: "+s)}static now(){return Ui.fromMillis(Date.now())}static fromDate(s){return Ui.fromMillis(s.getTime())}static fromMillis(s){const c=Math.floor(s/1e3),p=Math.floor(1e6*(s-1e3*c));return new Ui(c,p)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(s){return this.seconds===s.seconds?An(this.nanoseconds,s.nanoseconds):An(this.seconds,s.seconds)}isEqual(s){return s.seconds===this.seconds&&s.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const s=this.seconds- -62135596800;return String(s).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ve{constructor(s){this.timestamp=s}static fromTimestamp(s){return new Ve(s)}static min(){return new Ve(new Ui(0,0))}static max(){return new Ve(new Ui(253402300799,999999999))}compareTo(s){return this.timestamp._compareTo(s.timestamp)}isEqual(s){return this.timestamp.isEqual(s.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xu{constructor(s,c,p){c===void 0?c=0:c>s.length&&qe(),p===void 0?p=s.length-c:p>s.length-c&&qe(),this.segments=s,this.offset=c,this.len=p}get length(){return this.len}isEqual(s){return Xu.comparator(this,s)===0}child(s){const c=this.segments.slice(this.offset,this.limit());return s instanceof Xu?s.forEach(p=>{c.push(p)}):c.push(s),this.construct(c)}limit(){return this.offset+this.length}popFirst(s){return s=s===void 0?1:s,this.construct(this.segments,this.offset+s,this.length-s)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(s){return this.segments[this.offset+s]}isEmpty(){return this.length===0}isPrefixOf(s){if(s.length<this.length)return!1;for(let c=0;c<this.length;c++)if(this.get(c)!==s.get(c))return!1;return!0}isImmediateParentOf(s){if(this.length+1!==s.length)return!1;for(let c=0;c<this.length;c++)if(this.get(c)!==s.get(c))return!1;return!0}forEach(s){for(let c=this.offset,p=this.limit();c<p;c++)s(this.segments[c])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(s,c){const p=Math.min(s.length,c.length);for(let _=0;_<p;_++){const g=s.get(_),y=c.get(_);if(g<y)return-1;if(g>y)return 1}return s.length<c.length?-1:s.length>c.length?1:0}}class mr extends Xu{construct(s,c,p){return new mr(s,c,p)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...s){const c=[];for(const p of s){if(p.indexOf("//")>=0)throw new Ce(Kt.INVALID_ARGUMENT,`Invalid segment (${p}). Paths must not contain // in them.`);c.push(...p.split("/").filter(_=>_.length>0))}return new mr(c)}static emptyPath(){return new mr([])}}const xB=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class wi extends Xu{construct(s,c,p){return new wi(s,c,p)}static isValidIdentifier(s){return xB.test(s)}canonicalString(){return this.toArray().map(s=>(s=s.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),wi.isValidIdentifier(s)||(s="`"+s+"`"),s)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new wi(["__name__"])}static fromServerFormat(s){const c=[];let p="",_=0;const g=()=>{if(p.length===0)throw new Ce(Kt.INVALID_ARGUMENT,`Invalid field path (${s}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);c.push(p),p=""};let y=!1;for(;_<s.length;){const O=s[_];if(O==="\\"){if(_+1===s.length)throw new Ce(Kt.INVALID_ARGUMENT,"Path has trailing escape character: "+s);const L=s[_+1];if(L!=="\\"&&L!=="."&&L!=="`")throw new Ce(Kt.INVALID_ARGUMENT,"Path has invalid escape sequence: "+s);p+=L,_+=2}else O==="`"?(y=!y,_++):O!=="."||y?(p+=O,_++):(g(),_++)}if(g(),y)throw new Ce(Kt.INVALID_ARGUMENT,"Unterminated ` in path: "+s);return new wi(c)}static emptyPath(){return new wi([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ae{constructor(s){this.path=s}static fromPath(s){return new Ae(mr.fromString(s))}static fromName(s){return new Ae(mr.fromString(s).popFirst(5))}static empty(){return new Ae(mr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(s){return this.path.length>=2&&this.path.get(this.path.length-2)===s}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(s){return s!==null&&mr.comparator(this.path,s.path)===0}toString(){return this.path.toString()}static comparator(s,c){return mr.comparator(s.path,c.path)}static isDocumentKey(s){return s.length%2==0}static fromSegments(s){return new Ae(new mr(s.slice()))}}function VB(u,s){const c=u.toTimestamp().seconds,p=u.toTimestamp().nanoseconds+1,_=Ve.fromTimestamp(p===1e9?new Ui(c+1,0):new Ui(c,p));return new Fa(_,Ae.empty(),s)}function FB(u){return new Fa(u.readTime,u.key,-1)}class Fa{constructor(s,c,p){this.readTime=s,this.documentKey=c,this.largestBatchId=p}static min(){return new Fa(Ve.min(),Ae.empty(),-1)}static max(){return new Fa(Ve.max(),Ae.empty(),-1)}}function BB(u,s){let c=u.readTime.compareTo(s.readTime);return c!==0?c:(c=Ae.comparator(u.documentKey,s.documentKey),c!==0?c:An(u.largestBatchId,s.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const jB="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class GB{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(s){this.onCommittedListeners.push(s)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(s=>s())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Dg(u){if(u.code!==Kt.FAILED_PRECONDITION||u.message!==jB)throw u;se("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dt{constructor(s){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,s(c=>{this.isDone=!0,this.result=c,this.nextCallback&&this.nextCallback(c)},c=>{this.isDone=!0,this.error=c,this.catchCallback&&this.catchCallback(c)})}catch(s){return this.next(void 0,s)}next(s,c){return this.callbackAttached&&qe(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(c,this.error):this.wrapSuccess(s,this.result):new Dt((p,_)=>{this.nextCallback=g=>{this.wrapSuccess(s,g).next(p,_)},this.catchCallback=g=>{this.wrapFailure(c,g).next(p,_)}})}toPromise(){return new Promise((s,c)=>{this.next(s,c)})}wrapUserFunction(s){try{const c=s();return c instanceof Dt?c:Dt.resolve(c)}catch(c){return Dt.reject(c)}}wrapSuccess(s,c){return s?this.wrapUserFunction(()=>s(c)):Dt.resolve(c)}wrapFailure(s,c){return s?this.wrapUserFunction(()=>s(c)):Dt.reject(c)}static resolve(s){return new Dt((c,p)=>{c(s)})}static reject(s){return new Dt((c,p)=>{p(s)})}static waitFor(s){return new Dt((c,p)=>{let _=0,g=0,y=!1;s.forEach(O=>{++_,O.next(()=>{++g,y&&g===_&&c()},L=>p(L))}),y=!0,g===_&&c()})}static or(s){let c=Dt.resolve(!1);for(const p of s)c=c.next(_=>_?Dt.resolve(_):p());return c}static forEach(s,c){const p=[];return s.forEach((_,g)=>{p.push(c.call(this,_,g))}),this.waitFor(p)}static mapArray(s,c){return new Dt((p,_)=>{const g=s.length,y=new Array(g);let O=0;for(let L=0;L<g;L++){const V=L;c(s[V]).next(G=>{y[V]=G,++O,O===g&&p(y)},G=>_(G))}})}static doWhile(s,c){return new Dt((p,_)=>{const g=()=>{s()===!0?c().next(()=>{g()},_):p()};g()})}}function WB(u){const s=u.match(/Android ([\d.]+)/i),c=s?s[1].split(".").slice(0,2).join("."):"-1";return Number(c)}function Qu(u){return u.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kg{constructor(s,c){this.previousValue=s,c&&(c.sequenceNumberHandler=p=>this.ie(p),this.se=p=>c.writeSequenceNumber(p))}ie(s){return this.previousValue=Math.max(s,this.previousValue),this.previousValue}next(){const s=++this.previousValue;return this.se&&this.se(s),s}}kg.oe=-1;function _f(u){return u==null}function Lg(u){return u===0&&1/u==-1/0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function NC(u){let s=0;for(const c in u)Object.prototype.hasOwnProperty.call(u,c)&&s++;return s}function mf(u,s){for(const c in u)Object.prototype.hasOwnProperty.call(u,c)&&s(c,u[c])}function HB(u){for(const s in u)if(Object.prototype.hasOwnProperty.call(u,s))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ar{constructor(s,c){this.comparator=s,this.root=c||ii.EMPTY}insert(s,c){return new Ar(this.comparator,this.root.insert(s,c,this.comparator).copy(null,null,ii.BLACK,null,null))}remove(s){return new Ar(this.comparator,this.root.remove(s,this.comparator).copy(null,null,ii.BLACK,null,null))}get(s){let c=this.root;for(;!c.isEmpty();){const p=this.comparator(s,c.key);if(p===0)return c.value;p<0?c=c.left:p>0&&(c=c.right)}return null}indexOf(s){let c=0,p=this.root;for(;!p.isEmpty();){const _=this.comparator(s,p.key);if(_===0)return c+p.left.size;_<0?p=p.left:(c+=p.left.size+1,p=p.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(s){return this.root.inorderTraversal(s)}forEach(s){this.inorderTraversal((c,p)=>(s(c,p),!1))}toString(){const s=[];return this.inorderTraversal((c,p)=>(s.push(`${c}:${p}`),!1)),`{${s.join(", ")}}`}reverseTraversal(s){return this.root.reverseTraversal(s)}getIterator(){return new Ef(this.root,null,this.comparator,!1)}getIteratorFrom(s){return new Ef(this.root,s,this.comparator,!1)}getReverseIterator(){return new Ef(this.root,null,this.comparator,!0)}getReverseIteratorFrom(s){return new Ef(this.root,s,this.comparator,!0)}}class Ef{constructor(s,c,p,_){this.isReverse=_,this.nodeStack=[];let g=1;for(;!s.isEmpty();)if(g=c?p(s.key,c):1,c&&_&&(g*=-1),g<0)s=this.isReverse?s.left:s.right;else{if(g===0){this.nodeStack.push(s);break}this.nodeStack.push(s),s=this.isReverse?s.right:s.left}}getNext(){let s=this.nodeStack.pop();const c={key:s.key,value:s.value};if(this.isReverse)for(s=s.left;!s.isEmpty();)this.nodeStack.push(s),s=s.right;else for(s=s.right;!s.isEmpty();)this.nodeStack.push(s),s=s.left;return c}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const s=this.nodeStack[this.nodeStack.length-1];return{key:s.key,value:s.value}}}class ii{constructor(s,c,p,_,g){this.key=s,this.value=c,this.color=p??ii.RED,this.left=_??ii.EMPTY,this.right=g??ii.EMPTY,this.size=this.left.size+1+this.right.size}copy(s,c,p,_,g){return new ii(s??this.key,c??this.value,p??this.color,_??this.left,g??this.right)}isEmpty(){return!1}inorderTraversal(s){return this.left.inorderTraversal(s)||s(this.key,this.value)||this.right.inorderTraversal(s)}reverseTraversal(s){return this.right.reverseTraversal(s)||s(this.key,this.value)||this.left.reverseTraversal(s)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(s,c,p){let _=this;const g=p(s,_.key);return _=g<0?_.copy(null,null,null,_.left.insert(s,c,p),null):g===0?_.copy(null,c,null,null,null):_.copy(null,null,null,null,_.right.insert(s,c,p)),_.fixUp()}removeMin(){if(this.left.isEmpty())return ii.EMPTY;let s=this;return s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.removeMin(),null),s.fixUp()}remove(s,c){let p,_=this;if(c(s,_.key)<0)_.left.isEmpty()||_.left.isRed()||_.left.left.isRed()||(_=_.moveRedLeft()),_=_.copy(null,null,null,_.left.remove(s,c),null);else{if(_.left.isRed()&&(_=_.rotateRight()),_.right.isEmpty()||_.right.isRed()||_.right.left.isRed()||(_=_.moveRedRight()),c(s,_.key)===0){if(_.right.isEmpty())return ii.EMPTY;p=_.right.min(),_=_.copy(p.key,p.value,null,null,_.right.removeMin())}_=_.copy(null,null,null,null,_.right.remove(s,c))}return _.fixUp()}isRed(){return this.color}fixUp(){let s=this;return s.right.isRed()&&!s.left.isRed()&&(s=s.rotateLeft()),s.left.isRed()&&s.left.left.isRed()&&(s=s.rotateRight()),s.left.isRed()&&s.right.isRed()&&(s=s.colorFlip()),s}moveRedLeft(){let s=this.colorFlip();return s.right.left.isRed()&&(s=s.copy(null,null,null,null,s.right.rotateRight()),s=s.rotateLeft(),s=s.colorFlip()),s}moveRedRight(){let s=this.colorFlip();return s.left.left.isRed()&&(s=s.rotateRight(),s=s.colorFlip()),s}rotateLeft(){const s=this.copy(null,null,ii.RED,null,this.right.left);return this.right.copy(null,null,this.color,s,null)}rotateRight(){const s=this.copy(null,null,ii.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,s)}colorFlip(){const s=this.left.copy(null,null,!this.left.color,null,null),c=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,s,c)}checkMaxDepth(){const s=this.check();return Math.pow(2,s)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw qe();const s=this.left.check();if(s!==this.right.check())throw qe();return s+(this.isRed()?0:1)}}ii.EMPTY=null,ii.RED=!0,ii.BLACK=!1,ii.EMPTY=new class{constructor(){this.size=0}get key(){throw qe()}get value(){throw qe()}get color(){throw qe()}get left(){throw qe()}get right(){throw qe()}copy(s,c,p,_,g){return this}insert(s,c,p){return new ii(s,c)}remove(s,c){return this}isEmpty(){return!0}inorderTraversal(s){return!1}reverseTraversal(s){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class si{constructor(s){this.comparator=s,this.data=new Ar(this.comparator)}has(s){return this.data.get(s)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(s){return this.data.indexOf(s)}forEach(s){this.data.inorderTraversal((c,p)=>(s(c),!1))}forEachInRange(s,c){const p=this.data.getIteratorFrom(s[0]);for(;p.hasNext();){const _=p.getNext();if(this.comparator(_.key,s[1])>=0)return;c(_.key)}}forEachWhile(s,c){let p;for(p=c!==void 0?this.data.getIteratorFrom(c):this.data.getIterator();p.hasNext();)if(!s(p.getNext().key))return}firstAfterOrEqual(s){const c=this.data.getIteratorFrom(s);return c.hasNext()?c.getNext().key:null}getIterator(){return new PC(this.data.getIterator())}getIteratorFrom(s){return new PC(this.data.getIteratorFrom(s))}add(s){return this.copy(this.data.remove(s).insert(s,!0))}delete(s){return this.has(s)?this.copy(this.data.remove(s)):this}isEmpty(){return this.data.isEmpty()}unionWith(s){let c=this;return c.size<s.size&&(c=s,s=this),s.forEach(p=>{c=c.add(p)}),c}isEqual(s){if(!(s instanceof si)||this.size!==s.size)return!1;const c=this.data.getIterator(),p=s.data.getIterator();for(;c.hasNext();){const _=c.getNext().key,g=p.getNext().key;if(this.comparator(_,g)!==0)return!1}return!0}toArray(){const s=[];return this.forEach(c=>{s.push(c)}),s}toString(){const s=[];return this.forEach(c=>s.push(c)),"SortedSet("+s.toString()+")"}copy(s){const c=new si(this.comparator);return c.data=s,c}}class PC{constructor(s){this.iter=s}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ba{constructor(s){this.fields=s,s.sort(wi.comparator)}static empty(){return new Ba([])}unionWith(s){let c=new si(wi.comparator);for(const p of this.fields)c=c.add(p);for(const p of s)c=c.add(p);return new Ba(c.toArray())}covers(s){for(const c of this.fields)if(c.isPrefixOf(s))return!0;return!1}isEqual(s){return Xd(this.fields,s.fields,(c,p)=>c.isEqual(p))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class DC extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oi{constructor(s){this.binaryString=s}static fromBase64String(s){const c=function(_){try{return atob(_)}catch(g){throw typeof DOMException<"u"&&g instanceof DOMException?new DC("Invalid base64 string: "+g):g}}(s);return new oi(c)}static fromUint8Array(s){const c=function(_){let g="";for(let y=0;y<_.length;++y)g+=String.fromCharCode(_[y]);return g}(s);return new oi(c)}[Symbol.iterator](){let s=0;return{next:()=>s<this.binaryString.length?{value:this.binaryString.charCodeAt(s++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(c){return btoa(c)}(this.binaryString)}toUint8Array(){return function(c){const p=new Uint8Array(c.length);for(let _=0;_<c.length;_++)p[_]=c.charCodeAt(_);return p}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(s){return An(this.binaryString,s.binaryString)}isEqual(s){return this.binaryString===s.binaryString}}oi.EMPTY_BYTE_STRING=new oi("");const KB=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ja(u){if(_r(!!u),typeof u=="string"){let s=0;const c=KB.exec(u);if(_r(!!c),c[1]){let _=c[1];_=(_+"000000000").substr(0,9),s=Number(_)}const p=new Date(u);return{seconds:Math.floor(p.getTime()/1e3),nanos:s}}return{seconds:wr(u.seconds),nanos:wr(u.nanos)}}function wr(u){return typeof u=="number"?u:typeof u=="string"?Number(u):0}function Fc(u){return typeof u=="string"?oi.fromBase64String(u):oi.fromUint8Array(u)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mg(u){var s,c;return((c=(((s=u==null?void 0:u.mapValue)===null||s===void 0?void 0:s.fields)||{}).__type__)===null||c===void 0?void 0:c.stringValue)==="server_timestamp"}function Ug(u){const s=u.mapValue.fields.__previous_value__;return Mg(s)?Ug(s):s}function $u(u){const s=ja(u.mapValue.fields.__local_write_time__.timestampValue);return new Ui(s.seconds,s.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qB{constructor(s,c,p,_,g,y,O,L,V){this.databaseId=s,this.appId=c,this.persistenceKey=p,this.host=_,this.ssl=g,this.forceLongPolling=y,this.autoDetectLongPolling=O,this.longPollingOptions=L,this.useFetchStreams=V}}class Zu{constructor(s,c){this.projectId=s,this.database=c||"(default)"}static empty(){return new Zu("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(s){return s instanceof Zu&&s.projectId===this.projectId&&s.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gf={mapValue:{}};function Bc(u){return"nullValue"in u?0:"booleanValue"in u?1:"integerValue"in u||"doubleValue"in u?2:"timestampValue"in u?3:"stringValue"in u?5:"bytesValue"in u?6:"referenceValue"in u?7:"geoPointValue"in u?8:"arrayValue"in u?9:"mapValue"in u?Mg(u)?4:zB(u)?9007199254740991:YB(u)?10:11:qe()}function oo(u,s){if(u===s)return!0;const c=Bc(u);if(c!==Bc(s))return!1;switch(c){case 0:case 9007199254740991:return!0;case 1:return u.booleanValue===s.booleanValue;case 4:return $u(u).isEqual($u(s));case 3:return function(_,g){if(typeof _.timestampValue=="string"&&typeof g.timestampValue=="string"&&_.timestampValue.length===g.timestampValue.length)return _.timestampValue===g.timestampValue;const y=ja(_.timestampValue),O=ja(g.timestampValue);return y.seconds===O.seconds&&y.nanos===O.nanos}(u,s);case 5:return u.stringValue===s.stringValue;case 6:return function(_,g){return Fc(_.bytesValue).isEqual(Fc(g.bytesValue))}(u,s);case 7:return u.referenceValue===s.referenceValue;case 8:return function(_,g){return wr(_.geoPointValue.latitude)===wr(g.geoPointValue.latitude)&&wr(_.geoPointValue.longitude)===wr(g.geoPointValue.longitude)}(u,s);case 2:return function(_,g){if("integerValue"in _&&"integerValue"in g)return wr(_.integerValue)===wr(g.integerValue);if("doubleValue"in _&&"doubleValue"in g){const y=wr(_.doubleValue),O=wr(g.doubleValue);return y===O?Lg(y)===Lg(O):isNaN(y)&&isNaN(O)}return!1}(u,s);case 9:return Xd(u.arrayValue.values||[],s.arrayValue.values||[],oo);case 10:case 11:return function(_,g){const y=_.mapValue.fields||{},O=g.mapValue.fields||{};if(NC(y)!==NC(O))return!1;for(const L in y)if(y.hasOwnProperty(L)&&(O[L]===void 0||!oo(y[L],O[L])))return!1;return!0}(u,s);default:return qe()}}function th(u,s){return(u.values||[]).find(c=>oo(c,s))!==void 0}function Qd(u,s){if(u===s)return 0;const c=Bc(u),p=Bc(s);if(c!==p)return An(c,p);switch(c){case 0:case 9007199254740991:return 0;case 1:return An(u.booleanValue,s.booleanValue);case 2:return function(g,y){const O=wr(g.integerValue||g.doubleValue),L=wr(y.integerValue||y.doubleValue);return O<L?-1:O>L?1:O===L?0:isNaN(O)?isNaN(L)?0:-1:1}(u,s);case 3:return kC(u.timestampValue,s.timestampValue);case 4:return kC($u(u),$u(s));case 5:return An(u.stringValue,s.stringValue);case 6:return function(g,y){const O=Fc(g),L=Fc(y);return O.compareTo(L)}(u.bytesValue,s.bytesValue);case 7:return function(g,y){const O=g.split("/"),L=y.split("/");for(let V=0;V<O.length&&V<L.length;V++){const G=An(O[V],L[V]);if(G!==0)return G}return An(O.length,L.length)}(u.referenceValue,s.referenceValue);case 8:return function(g,y){const O=An(wr(g.latitude),wr(y.latitude));return O!==0?O:An(wr(g.longitude),wr(y.longitude))}(u.geoPointValue,s.geoPointValue);case 9:return LC(u.arrayValue,s.arrayValue);case 10:return function(g,y){var O,L,V,G;const tt=g.fields||{},st=y.fields||{},ht=(O=tt.value)===null||O===void 0?void 0:O.arrayValue,yt=(L=st.value)===null||L===void 0?void 0:L.arrayValue,Vt=An(((V=ht==null?void 0:ht.values)===null||V===void 0?void 0:V.length)||0,((G=yt==null?void 0:yt.values)===null||G===void 0?void 0:G.length)||0);return Vt!==0?Vt:LC(ht,yt)}(u.mapValue,s.mapValue);case 11:return function(g,y){if(g===gf.mapValue&&y===gf.mapValue)return 0;if(g===gf.mapValue)return 1;if(y===gf.mapValue)return-1;const O=g.fields||{},L=Object.keys(O),V=y.fields||{},G=Object.keys(V);L.sort(),G.sort();for(let tt=0;tt<L.length&&tt<G.length;++tt){const st=An(L[tt],G[tt]);if(st!==0)return st;const ht=Qd(O[L[tt]],V[G[tt]]);if(ht!==0)return ht}return An(L.length,G.length)}(u.mapValue,s.mapValue);default:throw qe()}}function kC(u,s){if(typeof u=="string"&&typeof s=="string"&&u.length===s.length)return An(u,s);const c=ja(u),p=ja(s),_=An(c.seconds,p.seconds);return _!==0?_:An(c.nanos,p.nanos)}function LC(u,s){const c=u.values||[],p=s.values||[];for(let _=0;_<c.length&&_<p.length;++_){const g=Qd(c[_],p[_]);if(g)return g}return An(c.length,p.length)}function $d(u){return xg(u)}function xg(u){return"nullValue"in u?"null":"booleanValue"in u?""+u.booleanValue:"integerValue"in u?""+u.integerValue:"doubleValue"in u?""+u.doubleValue:"timestampValue"in u?function(c){const p=ja(c);return`time(${p.seconds},${p.nanos})`}(u.timestampValue):"stringValue"in u?u.stringValue:"bytesValue"in u?function(c){return Fc(c).toBase64()}(u.bytesValue):"referenceValue"in u?function(c){return Ae.fromName(c).toString()}(u.referenceValue):"geoPointValue"in u?function(c){return`geo(${c.latitude},${c.longitude})`}(u.geoPointValue):"arrayValue"in u?function(c){let p="[",_=!0;for(const g of c.values||[])_?_=!1:p+=",",p+=xg(g);return p+"]"}(u.arrayValue):"mapValue"in u?function(c){const p=Object.keys(c.fields||{}).sort();let _="{",g=!0;for(const y of p)g?g=!1:_+=",",_+=`${y}:${xg(c.fields[y])}`;return _+"}"}(u.mapValue):qe()}function Vg(u){return!!u&&"integerValue"in u}function Fg(u){return!!u&&"arrayValue"in u}function MC(u){return!!u&&"nullValue"in u}function UC(u){return!!u&&"doubleValue"in u&&isNaN(Number(u.doubleValue))}function Bg(u){return!!u&&"mapValue"in u}function YB(u){var s,c;return((c=(((s=u==null?void 0:u.mapValue)===null||s===void 0?void 0:s.fields)||{}).__type__)===null||c===void 0?void 0:c.stringValue)==="__vector__"}function eh(u){if(u.geoPointValue)return{geoPointValue:Object.assign({},u.geoPointValue)};if(u.timestampValue&&typeof u.timestampValue=="object")return{timestampValue:Object.assign({},u.timestampValue)};if(u.mapValue){const s={mapValue:{fields:{}}};return mf(u.mapValue.fields,(c,p)=>s.mapValue.fields[c]=eh(p)),s}if(u.arrayValue){const s={arrayValue:{values:[]}};for(let c=0;c<(u.arrayValue.values||[]).length;++c)s.arrayValue.values[c]=eh(u.arrayValue.values[c]);return s}return Object.assign({},u)}function zB(u){return(((u.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ao{constructor(s){this.value=s}static empty(){return new ao({mapValue:{}})}field(s){if(s.isEmpty())return this.value;{let c=this.value;for(let p=0;p<s.length-1;++p)if(c=(c.mapValue.fields||{})[s.get(p)],!Bg(c))return null;return c=(c.mapValue.fields||{})[s.lastSegment()],c||null}}set(s,c){this.getFieldsMap(s.popLast())[s.lastSegment()]=eh(c)}setAll(s){let c=wi.emptyPath(),p={},_=[];s.forEach((y,O)=>{if(!c.isImmediateParentOf(O)){const L=this.getFieldsMap(c);this.applyChanges(L,p,_),p={},_=[],c=O.popLast()}y?p[O.lastSegment()]=eh(y):_.push(O.lastSegment())});const g=this.getFieldsMap(c);this.applyChanges(g,p,_)}delete(s){const c=this.field(s.popLast());Bg(c)&&c.mapValue.fields&&delete c.mapValue.fields[s.lastSegment()]}isEqual(s){return oo(this.value,s.value)}getFieldsMap(s){let c=this.value;c.mapValue.fields||(c.mapValue={fields:{}});for(let p=0;p<s.length;++p){let _=c.mapValue.fields[s.get(p)];Bg(_)&&_.mapValue.fields||(_={mapValue:{fields:{}}},c.mapValue.fields[s.get(p)]=_),c=_}return c.mapValue.fields}applyChanges(s,c,p){mf(c,(_,g)=>s[_]=g);for(const _ of p)delete s[_]}clone(){return new ao(eh(this.value))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mi{constructor(s,c,p,_,g,y,O){this.key=s,this.documentType=c,this.version=p,this.readTime=_,this.createTime=g,this.data=y,this.documentState=O}static newInvalidDocument(s){return new mi(s,0,Ve.min(),Ve.min(),Ve.min(),ao.empty(),0)}static newFoundDocument(s,c,p,_){return new mi(s,1,c,Ve.min(),p,_,0)}static newNoDocument(s,c){return new mi(s,2,c,Ve.min(),Ve.min(),ao.empty(),0)}static newUnknownDocument(s,c){return new mi(s,3,c,Ve.min(),Ve.min(),ao.empty(),2)}convertToFoundDocument(s,c){return!this.createTime.isEqual(Ve.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=s),this.version=s,this.documentType=1,this.data=c,this.documentState=0,this}convertToNoDocument(s){return this.version=s,this.documentType=2,this.data=ao.empty(),this.documentState=0,this}convertToUnknownDocument(s){return this.version=s,this.documentType=3,this.data=ao.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Ve.min(),this}setReadTime(s){return this.readTime=s,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(s){return s instanceof mi&&this.key.isEqual(s.key)&&this.version.isEqual(s.version)&&this.documentType===s.documentType&&this.documentState===s.documentState&&this.data.isEqual(s.data)}mutableCopy(){return new mi(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Tf{constructor(s,c){this.position=s,this.inclusive=c}}function xC(u,s,c){let p=0;for(let _=0;_<u.position.length;_++){const g=s[_],y=u.position[_];if(g.field.isKeyField()?p=Ae.comparator(Ae.fromName(y.referenceValue),c.key):p=Qd(y,c.data.field(g.field)),g.dir==="desc"&&(p*=-1),p!==0)break}return p}function VC(u,s){if(u===null)return s===null;if(s===null||u.inclusive!==s.inclusive||u.position.length!==s.position.length)return!1;for(let c=0;c<u.position.length;c++)if(!oo(u.position[c],s.position[c]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sf{constructor(s,c="asc"){this.field=s,this.dir=c}}function JB(u,s){return u.dir===s.dir&&u.field.isEqual(s.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FC{}class Mr extends FC{constructor(s,c,p){super(),this.field=s,this.op=c,this.value=p}static create(s,c,p){return s.isKeyField()?c==="in"||c==="not-in"?this.createKeyFieldInFilter(s,c,p):new QB(s,c,p):c==="array-contains"?new tj(s,p):c==="in"?new ej(s,p):c==="not-in"?new nj(s,p):c==="array-contains-any"?new rj(s,p):new Mr(s,c,p)}static createKeyFieldInFilter(s,c,p){return c==="in"?new $B(s,p):new ZB(s,p)}matches(s){const c=s.data.field(this.field);return this.op==="!="?c!==null&&this.matchesComparison(Qd(c,this.value)):c!==null&&Bc(this.value)===Bc(c)&&this.matchesComparison(Qd(c,this.value))}matchesComparison(s){switch(this.op){case"<":return s<0;case"<=":return s<=0;case"==":return s===0;case"!=":return s!==0;case">":return s>0;case">=":return s>=0;default:return qe()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class co extends FC{constructor(s,c){super(),this.filters=s,this.op=c,this.ae=null}static create(s,c){return new co(s,c)}matches(s){return BC(this)?this.filters.find(c=>!c.matches(s))===void 0:this.filters.find(c=>c.matches(s))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((s,c)=>s.concat(c.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function BC(u){return u.op==="and"}function jC(u){return XB(u)&&BC(u)}function XB(u){for(const s of u.filters)if(s instanceof co)return!1;return!0}function jg(u){if(u instanceof Mr)return u.field.canonicalString()+u.op.toString()+$d(u.value);if(jC(u))return u.filters.map(s=>jg(s)).join(",");{const s=u.filters.map(c=>jg(c)).join(",");return`${u.op}(${s})`}}function GC(u,s){return u instanceof Mr?function(p,_){return _ instanceof Mr&&p.op===_.op&&p.field.isEqual(_.field)&&oo(p.value,_.value)}(u,s):u instanceof co?function(p,_){return _ instanceof co&&p.op===_.op&&p.filters.length===_.filters.length?p.filters.reduce((g,y,O)=>g&&GC(y,_.filters[O]),!0):!1}(u,s):void qe()}function WC(u){return u instanceof Mr?function(c){return`${c.field.canonicalString()} ${c.op} ${$d(c.value)}`}(u):u instanceof co?function(c){return c.op.toString()+" {"+c.getFilters().map(WC).join(" ,")+"}"}(u):"Filter"}class QB extends Mr{constructor(s,c,p){super(s,c,p),this.key=Ae.fromName(p.referenceValue)}matches(s){const c=Ae.comparator(s.key,this.key);return this.matchesComparison(c)}}class $B extends Mr{constructor(s,c){super(s,"in",c),this.keys=HC("in",c)}matches(s){return this.keys.some(c=>c.isEqual(s.key))}}class ZB extends Mr{constructor(s,c){super(s,"not-in",c),this.keys=HC("not-in",c)}matches(s){return!this.keys.some(c=>c.isEqual(s.key))}}function HC(u,s){var c;return(((c=s.arrayValue)===null||c===void 0?void 0:c.values)||[]).map(p=>Ae.fromName(p.referenceValue))}class tj extends Mr{constructor(s,c){super(s,"array-contains",c)}matches(s){const c=s.data.field(this.field);return Fg(c)&&th(c.arrayValue,this.value)}}class ej extends Mr{constructor(s,c){super(s,"in",c)}matches(s){const c=s.data.field(this.field);return c!==null&&th(this.value.arrayValue,c)}}class nj extends Mr{constructor(s,c){super(s,"not-in",c)}matches(s){if(th(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const c=s.data.field(this.field);return c!==null&&!th(this.value.arrayValue,c)}}class rj extends Mr{constructor(s,c){super(s,"array-contains-any",c)}matches(s){const c=s.data.field(this.field);return!(!Fg(c)||!c.arrayValue.values)&&c.arrayValue.values.some(p=>th(this.value.arrayValue,p))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ij{constructor(s,c=null,p=[],_=[],g=null,y=null,O=null){this.path=s,this.collectionGroup=c,this.orderBy=p,this.filters=_,this.limit=g,this.startAt=y,this.endAt=O,this.ue=null}}function KC(u,s=null,c=[],p=[],_=null,g=null,y=null){return new ij(u,s,c,p,_,g,y)}function Gg(u){const s=un(u);if(s.ue===null){let c=s.path.canonicalString();s.collectionGroup!==null&&(c+="|cg:"+s.collectionGroup),c+="|f:",c+=s.filters.map(p=>jg(p)).join(","),c+="|ob:",c+=s.orderBy.map(p=>function(g){return g.field.canonicalString()+g.dir}(p)).join(","),_f(s.limit)||(c+="|l:",c+=s.limit),s.startAt&&(c+="|lb:",c+=s.startAt.inclusive?"b:":"a:",c+=s.startAt.position.map(p=>$d(p)).join(",")),s.endAt&&(c+="|ub:",c+=s.endAt.inclusive?"a:":"b:",c+=s.endAt.position.map(p=>$d(p)).join(",")),s.ue=c}return s.ue}function Wg(u,s){if(u.limit!==s.limit||u.orderBy.length!==s.orderBy.length)return!1;for(let c=0;c<u.orderBy.length;c++)if(!JB(u.orderBy[c],s.orderBy[c]))return!1;if(u.filters.length!==s.filters.length)return!1;for(let c=0;c<u.filters.length;c++)if(!GC(u.filters[c],s.filters[c]))return!1;return u.collectionGroup===s.collectionGroup&&!!u.path.isEqual(s.path)&&!!VC(u.startAt,s.startAt)&&VC(u.endAt,s.endAt)}function Hg(u){return Ae.isDocumentKey(u.path)&&u.collectionGroup===null&&u.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vf{constructor(s,c=null,p=[],_=[],g=null,y="F",O=null,L=null){this.path=s,this.collectionGroup=c,this.explicitOrderBy=p,this.filters=_,this.limit=g,this.limitType=y,this.startAt=O,this.endAt=L,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function sj(u,s,c,p,_,g,y,O){return new vf(u,s,c,p,_,g,y,O)}function Kg(u){return new vf(u)}function qC(u){return u.filters.length===0&&u.limit===null&&u.startAt==null&&u.endAt==null&&(u.explicitOrderBy.length===0||u.explicitOrderBy.length===1&&u.explicitOrderBy[0].field.isKeyField())}function oj(u){return u.collectionGroup!==null}function nh(u){const s=un(u);if(s.ce===null){s.ce=[];const c=new Set;for(const g of s.explicitOrderBy)s.ce.push(g),c.add(g.field.canonicalString());const p=s.explicitOrderBy.length>0?s.explicitOrderBy[s.explicitOrderBy.length-1].dir:"asc";(function(y){let O=new si(wi.comparator);return y.filters.forEach(L=>{L.getFlattenedFilters().forEach(V=>{V.isInequality()&&(O=O.add(V.field))})}),O})(s).forEach(g=>{c.has(g.canonicalString())||g.isKeyField()||s.ce.push(new Sf(g,p))}),c.has(wi.keyField().canonicalString())||s.ce.push(new Sf(wi.keyField(),p))}return s.ce}function lo(u){const s=un(u);return s.le||(s.le=aj(s,nh(u))),s.le}function aj(u,s){if(u.limitType==="F")return KC(u.path,u.collectionGroup,s,u.filters,u.limit,u.startAt,u.endAt);{s=s.map(_=>{const g=_.dir==="desc"?"asc":"desc";return new Sf(_.field,g)});const c=u.endAt?new Tf(u.endAt.position,u.endAt.inclusive):null,p=u.startAt?new Tf(u.startAt.position,u.startAt.inclusive):null;return KC(u.path,u.collectionGroup,s,u.filters,u.limit,c,p)}}function qg(u,s,c){return new vf(u.path,u.collectionGroup,u.explicitOrderBy.slice(),u.filters.slice(),s,c,u.startAt,u.endAt)}function yf(u,s){return Wg(lo(u),lo(s))&&u.limitType===s.limitType}function YC(u){return`${Gg(lo(u))}|lt:${u.limitType}`}function Zd(u){return`Query(target=${function(c){let p=c.path.canonicalString();return c.collectionGroup!==null&&(p+=" collectionGroup="+c.collectionGroup),c.filters.length>0&&(p+=`, filters: [${c.filters.map(_=>WC(_)).join(", ")}]`),_f(c.limit)||(p+=", limit: "+c.limit),c.orderBy.length>0&&(p+=`, orderBy: [${c.orderBy.map(_=>function(y){return`${y.field.canonicalString()} (${y.dir})`}(_)).join(", ")}]`),c.startAt&&(p+=", startAt: ",p+=c.startAt.inclusive?"b:":"a:",p+=c.startAt.position.map(_=>$d(_)).join(",")),c.endAt&&(p+=", endAt: ",p+=c.endAt.inclusive?"a:":"b:",p+=c.endAt.position.map(_=>$d(_)).join(",")),`Target(${p})`}(lo(u))}; limitType=${u.limitType})`}function Rf(u,s){return s.isFoundDocument()&&function(p,_){const g=_.key.path;return p.collectionGroup!==null?_.key.hasCollectionId(p.collectionGroup)&&p.path.isPrefixOf(g):Ae.isDocumentKey(p.path)?p.path.isEqual(g):p.path.isImmediateParentOf(g)}(u,s)&&function(p,_){for(const g of nh(p))if(!g.field.isKeyField()&&_.data.field(g.field)===null)return!1;return!0}(u,s)&&function(p,_){for(const g of p.filters)if(!g.matches(_))return!1;return!0}(u,s)&&function(p,_){return!(p.startAt&&!function(y,O,L){const V=xC(y,O,L);return y.inclusive?V<=0:V<0}(p.startAt,nh(p),_)||p.endAt&&!function(y,O,L){const V=xC(y,O,L);return y.inclusive?V>=0:V>0}(p.endAt,nh(p),_))}(u,s)}function cj(u){return u.collectionGroup||(u.path.length%2==1?u.path.lastSegment():u.path.get(u.path.length-2))}function zC(u){return(s,c)=>{let p=!1;for(const _ of nh(u)){const g=dj(_,s,c);if(g!==0)return g;p=p||_.field.isKeyField()}return 0}}function dj(u,s,c){const p=u.field.isKeyField()?Ae.comparator(s.key,c.key):function(g,y,O){const L=y.data.field(g),V=O.data.field(g);return L!==null&&V!==null?Qd(L,V):qe()}(u.field,s,c);switch(u.dir){case"asc":return p;case"desc":return-1*p;default:return qe()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tl{constructor(s,c){this.mapKeyFn=s,this.equalsFn=c,this.inner={},this.innerSize=0}get(s){const c=this.mapKeyFn(s),p=this.inner[c];if(p!==void 0){for(const[_,g]of p)if(this.equalsFn(_,s))return g}}has(s){return this.get(s)!==void 0}set(s,c){const p=this.mapKeyFn(s),_=this.inner[p];if(_===void 0)return this.inner[p]=[[s,c]],void this.innerSize++;for(let g=0;g<_.length;g++)if(this.equalsFn(_[g][0],s))return void(_[g]=[s,c]);_.push([s,c]),this.innerSize++}delete(s){const c=this.mapKeyFn(s),p=this.inner[c];if(p===void 0)return!1;for(let _=0;_<p.length;_++)if(this.equalsFn(p[_][0],s))return p.length===1?delete this.inner[c]:p.splice(_,1),this.innerSize--,!0;return!1}forEach(s){mf(this.inner,(c,p)=>{for(const[_,g]of p)s(_,g)})}isEmpty(){return HB(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lj=new Ar(Ae.comparator);function Ga(){return lj}const JC=new Ar(Ae.comparator);function rh(...u){let s=JC;for(const c of u)s=s.insert(c.key,c);return s}function uj(u){let s=JC;return u.forEach((c,p)=>s=s.insert(c,p.overlayedDocument)),s}function jc(){return ih()}function XC(){return ih()}function ih(){return new tl(u=>u.toString(),(u,s)=>u.isEqual(s))}const hj=new si(Ae.comparator);function En(...u){let s=hj;for(const c of u)s=s.add(c);return s}const pj=new si(An);function fj(){return pj}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _j(u,s){if(u.useProto3Json){if(isNaN(s))return{doubleValue:"NaN"};if(s===1/0)return{doubleValue:"Infinity"};if(s===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Lg(s)?"-0":s}}function mj(u){return{integerValue:""+u}}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class If{constructor(){this._=void 0}}function Ej(u,s,c){return u instanceof Yg?function(_,g){const y={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:_.seconds,nanos:_.nanoseconds}}}};return g&&Mg(g)&&(g=Ug(g)),g&&(y.fields.__previous_value__=g),{mapValue:y}}(c,s):u instanceof Cf?QC(u,s):u instanceof Af?$C(u,s):function(_,g){const y=Tj(_,g),O=ZC(y)+ZC(_.Pe);return Vg(y)&&Vg(_.Pe)?mj(O):_j(_.serializer,O)}(u,s)}function gj(u,s,c){return u instanceof Cf?QC(u,s):u instanceof Af?$C(u,s):c}function Tj(u,s){return u instanceof zg?function(p){return Vg(p)||function(g){return!!g&&"doubleValue"in g}(p)}(s)?s:{integerValue:0}:null}class Yg extends If{}class Cf extends If{constructor(s){super(),this.elements=s}}function QC(u,s){const c=tA(s);for(const p of u.elements)c.some(_=>oo(_,p))||c.push(p);return{arrayValue:{values:c}}}class Af extends If{constructor(s){super(),this.elements=s}}function $C(u,s){let c=tA(s);for(const p of u.elements)c=c.filter(_=>!oo(_,p));return{arrayValue:{values:c}}}class zg extends If{constructor(s,c){super(),this.serializer=s,this.Pe=c}}function ZC(u){return wr(u.integerValue||u.doubleValue)}function tA(u){return Fg(u)&&u.arrayValue.values?u.arrayValue.values.slice():[]}function Sj(u,s){return u.field.isEqual(s.field)&&function(p,_){return p instanceof Cf&&_ instanceof Cf||p instanceof Af&&_ instanceof Af?Xd(p.elements,_.elements,oo):p instanceof zg&&_ instanceof zg?oo(p.Pe,_.Pe):p instanceof Yg&&_ instanceof Yg}(u.transform,s.transform)}class Gc{constructor(s,c){this.updateTime=s,this.exists=c}static none(){return new Gc}static exists(s){return new Gc(void 0,s)}static updateTime(s){return new Gc(s)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(s){return this.exists===s.exists&&(this.updateTime?!!s.updateTime&&this.updateTime.isEqual(s.updateTime):!s.updateTime)}}function wf(u,s){return u.updateTime!==void 0?s.isFoundDocument()&&s.version.isEqual(u.updateTime):u.exists===void 0||u.exists===s.isFoundDocument()}class Jg{}function eA(u,s){if(!u.hasLocalMutations||s&&s.fields.length===0)return null;if(s===null)return u.isNoDocument()?new yj(u.key,Gc.none()):new Xg(u.key,u.data,Gc.none());{const c=u.data,p=ao.empty();let _=new si(wi.comparator);for(let g of s.fields)if(!_.has(g)){let y=c.field(g);y===null&&g.length>1&&(g=g.popLast(),y=c.field(g)),y===null?p.delete(g):p.set(g,y),_=_.add(g)}return new bf(u.key,p,new Ba(_.toArray()),Gc.none())}}function vj(u,s,c){u instanceof Xg?function(_,g,y){const O=_.value.clone(),L=iA(_.fieldTransforms,g,y.transformResults);O.setAll(L),g.convertToFoundDocument(y.version,O).setHasCommittedMutations()}(u,s,c):u instanceof bf?function(_,g,y){if(!wf(_.precondition,g))return void g.convertToUnknownDocument(y.version);const O=iA(_.fieldTransforms,g,y.transformResults),L=g.data;L.setAll(rA(_)),L.setAll(O),g.convertToFoundDocument(y.version,L).setHasCommittedMutations()}(u,s,c):function(_,g,y){g.convertToNoDocument(y.version).setHasCommittedMutations()}(0,s,c)}function sh(u,s,c,p){return u instanceof Xg?function(g,y,O,L){if(!wf(g.precondition,y))return O;const V=g.value.clone(),G=sA(g.fieldTransforms,L,y);return V.setAll(G),y.convertToFoundDocument(y.version,V).setHasLocalMutations(),null}(u,s,c,p):u instanceof bf?function(g,y,O,L){if(!wf(g.precondition,y))return O;const V=sA(g.fieldTransforms,L,y),G=y.data;return G.setAll(rA(g)),G.setAll(V),y.convertToFoundDocument(y.version,G).setHasLocalMutations(),O===null?null:O.unionWith(g.fieldMask.fields).unionWith(g.fieldTransforms.map(tt=>tt.field))}(u,s,c,p):function(g,y,O){return wf(g.precondition,y)?(y.convertToNoDocument(y.version).setHasLocalMutations(),null):O}(u,s,c)}function nA(u,s){return u.type===s.type&&!!u.key.isEqual(s.key)&&!!u.precondition.isEqual(s.precondition)&&!!function(p,_){return p===void 0&&_===void 0||!(!p||!_)&&Xd(p,_,(g,y)=>Sj(g,y))}(u.fieldTransforms,s.fieldTransforms)&&(u.type===0?u.value.isEqual(s.value):u.type!==1||u.data.isEqual(s.data)&&u.fieldMask.isEqual(s.fieldMask))}class Xg extends Jg{constructor(s,c,p,_=[]){super(),this.key=s,this.value=c,this.precondition=p,this.fieldTransforms=_,this.type=0}getFieldMask(){return null}}class bf extends Jg{constructor(s,c,p,_,g=[]){super(),this.key=s,this.data=c,this.fieldMask=p,this.precondition=_,this.fieldTransforms=g,this.type=1}getFieldMask(){return this.fieldMask}}function rA(u){const s=new Map;return u.fieldMask.fields.forEach(c=>{if(!c.isEmpty()){const p=u.data.field(c);s.set(c,p)}}),s}function iA(u,s,c){const p=new Map;_r(u.length===c.length);for(let _=0;_<c.length;_++){const g=u[_],y=g.transform,O=s.data.field(g.field);p.set(g.field,gj(y,O,c[_]))}return p}function sA(u,s,c){const p=new Map;for(const _ of u){const g=_.transform,y=c.data.field(_.field);p.set(_.field,Ej(g,y,s))}return p}class yj extends Jg{constructor(s,c){super(),this.key=s,this.precondition=c,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rj{constructor(s,c,p,_){this.batchId=s,this.localWriteTime=c,this.baseMutations=p,this.mutations=_}applyToRemoteDocument(s,c){const p=c.mutationResults;for(let _=0;_<this.mutations.length;_++){const g=this.mutations[_];g.key.isEqual(s.key)&&vj(g,s,p[_])}}applyToLocalView(s,c){for(const p of this.baseMutations)p.key.isEqual(s.key)&&(c=sh(p,s,c,this.localWriteTime));for(const p of this.mutations)p.key.isEqual(s.key)&&(c=sh(p,s,c,this.localWriteTime));return c}applyToLocalDocumentSet(s,c){const p=XC();return this.mutations.forEach(_=>{const g=s.get(_.key),y=g.overlayedDocument;let O=this.applyToLocalView(y,g.mutatedFields);O=c.has(_.key)?null:O;const L=eA(y,O);L!==null&&p.set(_.key,L),y.isValidDocument()||y.convertToNoDocument(Ve.min())}),p}keys(){return this.mutations.reduce((s,c)=>s.add(c.key),En())}isEqual(s){return this.batchId===s.batchId&&Xd(this.mutations,s.mutations,(c,p)=>nA(c,p))&&Xd(this.baseMutations,s.baseMutations,(c,p)=>nA(c,p))}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ij{constructor(s,c){this.largestBatchId=s,this.mutation=c}getKey(){return this.mutation.key}isEqual(s){return s!==null&&this.mutation===s.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cj{constructor(s,c){this.count=s,this.unchangedNames=c}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var kr,hn;function oA(u){if(u===void 0)return Ko("GRPC error has no .code"),Kt.UNKNOWN;switch(u){case kr.OK:return Kt.OK;case kr.CANCELLED:return Kt.CANCELLED;case kr.UNKNOWN:return Kt.UNKNOWN;case kr.DEADLINE_EXCEEDED:return Kt.DEADLINE_EXCEEDED;case kr.RESOURCE_EXHAUSTED:return Kt.RESOURCE_EXHAUSTED;case kr.INTERNAL:return Kt.INTERNAL;case kr.UNAVAILABLE:return Kt.UNAVAILABLE;case kr.UNAUTHENTICATED:return Kt.UNAUTHENTICATED;case kr.INVALID_ARGUMENT:return Kt.INVALID_ARGUMENT;case kr.NOT_FOUND:return Kt.NOT_FOUND;case kr.ALREADY_EXISTS:return Kt.ALREADY_EXISTS;case kr.PERMISSION_DENIED:return Kt.PERMISSION_DENIED;case kr.FAILED_PRECONDITION:return Kt.FAILED_PRECONDITION;case kr.ABORTED:return Kt.ABORTED;case kr.OUT_OF_RANGE:return Kt.OUT_OF_RANGE;case kr.UNIMPLEMENTED:return Kt.UNIMPLEMENTED;case kr.DATA_LOSS:return Kt.DATA_LOSS;default:return qe()}}(hn=kr||(kr={}))[hn.OK=0]="OK",hn[hn.CANCELLED=1]="CANCELLED",hn[hn.UNKNOWN=2]="UNKNOWN",hn[hn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",hn[hn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",hn[hn.NOT_FOUND=5]="NOT_FOUND",hn[hn.ALREADY_EXISTS=6]="ALREADY_EXISTS",hn[hn.PERMISSION_DENIED=7]="PERMISSION_DENIED",hn[hn.UNAUTHENTICATED=16]="UNAUTHENTICATED",hn[hn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",hn[hn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",hn[hn.ABORTED=10]="ABORTED",hn[hn.OUT_OF_RANGE=11]="OUT_OF_RANGE",hn[hn.UNIMPLEMENTED=12]="UNIMPLEMENTED",hn[hn.INTERNAL=13]="INTERNAL",hn[hn.UNAVAILABLE=14]="UNAVAILABLE",hn[hn.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Aj(){return new TextEncoder}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wj=new Uc([4294967295,4294967295],0);function aA(u){const s=Aj().encode(u),c=new vC;return c.update(s),new Uint8Array(c.digest())}function cA(u){const s=new DataView(u.buffer),c=s.getUint32(0,!0),p=s.getUint32(4,!0),_=s.getUint32(8,!0),g=s.getUint32(12,!0);return[new Uc([c,p],0),new Uc([_,g],0)]}class Qg{constructor(s,c,p){if(this.bitmap=s,this.padding=c,this.hashCount=p,c<0||c>=8)throw new oh(`Invalid padding: ${c}`);if(p<0)throw new oh(`Invalid hash count: ${p}`);if(s.length>0&&this.hashCount===0)throw new oh(`Invalid hash count: ${p}`);if(s.length===0&&c!==0)throw new oh(`Invalid padding when bitmap length is 0: ${c}`);this.Ie=8*s.length-c,this.Te=Uc.fromNumber(this.Ie)}Ee(s,c,p){let _=s.add(c.multiply(Uc.fromNumber(p)));return _.compare(wj)===1&&(_=new Uc([_.getBits(0),_.getBits(1)],0)),_.modulo(this.Te).toNumber()}de(s){return(this.bitmap[Math.floor(s/8)]&1<<s%8)!=0}mightContain(s){if(this.Ie===0)return!1;const c=aA(s),[p,_]=cA(c);for(let g=0;g<this.hashCount;g++){const y=this.Ee(p,_,g);if(!this.de(y))return!1}return!0}static create(s,c,p){const _=s%8==0?0:8-s%8,g=new Uint8Array(Math.ceil(s/8)),y=new Qg(g,_,c);return p.forEach(O=>y.insert(O)),y}insert(s){if(this.Ie===0)return;const c=aA(s),[p,_]=cA(c);for(let g=0;g<this.hashCount;g++){const y=this.Ee(p,_,g);this.Ae(y)}}Ae(s){const c=Math.floor(s/8),p=s%8;this.bitmap[c]|=1<<p}}class oh extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Of{constructor(s,c,p,_,g){this.snapshotVersion=s,this.targetChanges=c,this.targetMismatches=p,this.documentUpdates=_,this.resolvedLimboDocuments=g}static createSynthesizedRemoteEventForCurrentChange(s,c,p){const _=new Map;return _.set(s,ah.createSynthesizedTargetChangeForCurrentChange(s,c,p)),new Of(Ve.min(),_,new Ar(An),Ga(),En())}}class ah{constructor(s,c,p,_,g){this.resumeToken=s,this.current=c,this.addedDocuments=p,this.modifiedDocuments=_,this.removedDocuments=g}static createSynthesizedTargetChangeForCurrentChange(s,c,p){return new ah(p,c,En(),En(),En())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nf{constructor(s,c,p,_){this.Re=s,this.removedTargetIds=c,this.key=p,this.Ve=_}}class dA{constructor(s,c){this.targetId=s,this.me=c}}class lA{constructor(s,c,p=oi.EMPTY_BYTE_STRING,_=null){this.state=s,this.targetIds=c,this.resumeToken=p,this.cause=_}}class uA{constructor(){this.fe=0,this.ge=pA(),this.pe=oi.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(s){s.approximateByteSize()>0&&(this.we=!0,this.pe=s)}ve(){let s=En(),c=En(),p=En();return this.ge.forEach((_,g)=>{switch(g){case 0:s=s.add(_);break;case 2:c=c.add(_);break;case 1:p=p.add(_);break;default:qe()}}),new ah(this.pe,this.ye,s,c,p)}Ce(){this.we=!1,this.ge=pA()}Fe(s,c){this.we=!0,this.ge=this.ge.insert(s,c)}Me(s){this.we=!0,this.ge=this.ge.remove(s)}xe(){this.fe+=1}Oe(){this.fe-=1,_r(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class bj{constructor(s){this.Le=s,this.Be=new Map,this.ke=Ga(),this.qe=hA(),this.Qe=new Ar(An)}Ke(s){for(const c of s.Re)s.Ve&&s.Ve.isFoundDocument()?this.$e(c,s.Ve):this.Ue(c,s.key,s.Ve);for(const c of s.removedTargetIds)this.Ue(c,s.key,s.Ve)}We(s){this.forEachTarget(s,c=>{const p=this.Ge(c);switch(s.state){case 0:this.ze(c)&&p.De(s.resumeToken);break;case 1:p.Oe(),p.Se||p.Ce(),p.De(s.resumeToken);break;case 2:p.Oe(),p.Se||this.removeTarget(c);break;case 3:this.ze(c)&&(p.Ne(),p.De(s.resumeToken));break;case 4:this.ze(c)&&(this.je(c),p.De(s.resumeToken));break;default:qe()}})}forEachTarget(s,c){s.targetIds.length>0?s.targetIds.forEach(c):this.Be.forEach((p,_)=>{this.ze(_)&&c(_)})}He(s){const c=s.targetId,p=s.me.count,_=this.Je(c);if(_){const g=_.target;if(Hg(g))if(p===0){const y=new Ae(g.path);this.Ue(c,y,mi.newNoDocument(y,Ve.min()))}else _r(p===1);else{const y=this.Ye(c);if(y!==p){const O=this.Ze(s),L=O?this.Xe(O,s,y):1;if(L!==0){this.je(c);const V=L===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(c,V)}}}}}Ze(s){const c=s.me.unchangedNames;if(!c||!c.bits)return null;const{bits:{bitmap:p="",padding:_=0},hashCount:g=0}=c;let y,O;try{y=Fc(p).toUint8Array()}catch(L){if(L instanceof DC)return Jd("Decoding the base64 bloom filter in existence filter failed ("+L.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw L}try{O=new Qg(y,_,g)}catch(L){return Jd(L instanceof oh?"BloomFilter error: ":"Applying bloom filter failed: ",L),null}return O.Ie===0?null:O}Xe(s,c,p){return c.me.count===p-this.nt(s,c.targetId)?0:2}nt(s,c){const p=this.Le.getRemoteKeysForTarget(c);let _=0;return p.forEach(g=>{const y=this.Le.tt(),O=`projects/${y.projectId}/databases/${y.database}/documents/${g.path.canonicalString()}`;s.mightContain(O)||(this.Ue(c,g,null),_++)}),_}rt(s){const c=new Map;this.Be.forEach((g,y)=>{const O=this.Je(y);if(O){if(g.current&&Hg(O.target)){const L=new Ae(O.target.path);this.ke.get(L)!==null||this.it(y,L)||this.Ue(y,L,mi.newNoDocument(L,s))}g.be&&(c.set(y,g.ve()),g.Ce())}});let p=En();this.qe.forEach((g,y)=>{let O=!0;y.forEachWhile(L=>{const V=this.Je(L);return!V||V.purpose==="TargetPurposeLimboResolution"||(O=!1,!1)}),O&&(p=p.add(g))}),this.ke.forEach((g,y)=>y.setReadTime(s));const _=new Of(s,c,this.Qe,this.ke,p);return this.ke=Ga(),this.qe=hA(),this.Qe=new Ar(An),_}$e(s,c){if(!this.ze(s))return;const p=this.it(s,c.key)?2:0;this.Ge(s).Fe(c.key,p),this.ke=this.ke.insert(c.key,c),this.qe=this.qe.insert(c.key,this.st(c.key).add(s))}Ue(s,c,p){if(!this.ze(s))return;const _=this.Ge(s);this.it(s,c)?_.Fe(c,1):_.Me(c),this.qe=this.qe.insert(c,this.st(c).delete(s)),p&&(this.ke=this.ke.insert(c,p))}removeTarget(s){this.Be.delete(s)}Ye(s){const c=this.Ge(s).ve();return this.Le.getRemoteKeysForTarget(s).size+c.addedDocuments.size-c.removedDocuments.size}xe(s){this.Ge(s).xe()}Ge(s){let c=this.Be.get(s);return c||(c=new uA,this.Be.set(s,c)),c}st(s){let c=this.qe.get(s);return c||(c=new si(An),this.qe=this.qe.insert(s,c)),c}ze(s){const c=this.Je(s)!==null;return c||se("WatchChangeAggregator","Detected inactive target",s),c}Je(s){const c=this.Be.get(s);return c&&c.Se?null:this.Le.ot(s)}je(s){this.Be.set(s,new uA),this.Le.getRemoteKeysForTarget(s).forEach(c=>{this.Ue(s,c,null)})}it(s,c){return this.Le.getRemoteKeysForTarget(s).has(c)}}function hA(){return new Ar(Ae.comparator)}function pA(){return new Ar(Ae.comparator)}const Oj={asc:"ASCENDING",desc:"DESCENDING"},Nj={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Pj={and:"AND",or:"OR"};class Dj{constructor(s,c){this.databaseId=s,this.useProto3Json=c}}function $g(u,s){return u.useProto3Json||_f(s)?s:{value:s}}function kj(u,s){return u.useProto3Json?`${new Date(1e3*s.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+s.nanoseconds).slice(-9)}Z`:{seconds:""+s.seconds,nanos:s.nanoseconds}}function Lj(u,s){return u.useProto3Json?s.toBase64():s.toUint8Array()}function el(u){return _r(!!u),Ve.fromTimestamp(function(c){const p=ja(c);return new Ui(p.seconds,p.nanos)}(u))}function Mj(u,s){return Zg(u,s).canonicalString()}function Zg(u,s){const c=function(_){return new mr(["projects",_.projectId,"databases",_.database])}(u).child("documents");return s===void 0?c:c.child(s)}function fA(u){const s=mr.fromString(u);return _r(SA(s)),s}function tT(u,s){const c=fA(s);if(c.get(1)!==u.databaseId.projectId)throw new Ce(Kt.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+c.get(1)+" vs "+u.databaseId.projectId);if(c.get(3)!==u.databaseId.database)throw new Ce(Kt.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+c.get(3)+" vs "+u.databaseId.database);return new Ae(EA(c))}function _A(u,s){return Mj(u.databaseId,s)}function Uj(u){const s=fA(u);return s.length===4?mr.emptyPath():EA(s)}function mA(u){return new mr(["projects",u.databaseId.projectId,"databases",u.databaseId.database]).canonicalString()}function EA(u){return _r(u.length>4&&u.get(4)==="documents"),u.popFirst(5)}function xj(u,s){let c;if("targetChange"in s){s.targetChange;const p=function(V){return V==="NO_CHANGE"?0:V==="ADD"?1:V==="REMOVE"?2:V==="CURRENT"?3:V==="RESET"?4:qe()}(s.targetChange.targetChangeType||"NO_CHANGE"),_=s.targetChange.targetIds||[],g=function(V,G){return V.useProto3Json?(_r(G===void 0||typeof G=="string"),oi.fromBase64String(G||"")):(_r(G===void 0||G instanceof Buffer||G instanceof Uint8Array),oi.fromUint8Array(G||new Uint8Array))}(u,s.targetChange.resumeToken),y=s.targetChange.cause,O=y&&function(V){const G=V.code===void 0?Kt.UNKNOWN:oA(V.code);return new Ce(G,V.message||"")}(y);c=new lA(p,_,g,O||null)}else if("documentChange"in s){s.documentChange;const p=s.documentChange;p.document,p.document.name,p.document.updateTime;const _=tT(u,p.document.name),g=el(p.document.updateTime),y=p.document.createTime?el(p.document.createTime):Ve.min(),O=new ao({mapValue:{fields:p.document.fields}}),L=mi.newFoundDocument(_,g,y,O),V=p.targetIds||[],G=p.removedTargetIds||[];c=new Nf(V,G,L.key,L)}else if("documentDelete"in s){s.documentDelete;const p=s.documentDelete;p.document;const _=tT(u,p.document),g=p.readTime?el(p.readTime):Ve.min(),y=mi.newNoDocument(_,g),O=p.removedTargetIds||[];c=new Nf([],O,y.key,y)}else if("documentRemove"in s){s.documentRemove;const p=s.documentRemove;p.document;const _=tT(u,p.document),g=p.removedTargetIds||[];c=new Nf([],g,_,null)}else{if(!("filter"in s))return qe();{s.filter;const p=s.filter;p.targetId;const{count:_=0,unchangedNames:g}=p,y=new Cj(_,g),O=p.targetId;c=new dA(O,y)}}return c}function Vj(u,s){return{documents:[_A(u,s.path)]}}function Fj(u,s){const c={structuredQuery:{}},p=s.path;let _;s.collectionGroup!==null?(_=p,c.structuredQuery.from=[{collectionId:s.collectionGroup,allDescendants:!0}]):(_=p.popLast(),c.structuredQuery.from=[{collectionId:p.lastSegment()}]),c.parent=_A(u,_);const g=function(V){if(V.length!==0)return TA(co.create(V,"and"))}(s.filters);g&&(c.structuredQuery.where=g);const y=function(V){if(V.length!==0)return V.map(G=>function(st){return{field:nl(st.field),direction:Gj(st.dir)}}(G))}(s.orderBy);y&&(c.structuredQuery.orderBy=y);const O=$g(u,s.limit);return O!==null&&(c.structuredQuery.limit=O),s.startAt&&(c.structuredQuery.startAt=function(V){return{before:V.inclusive,values:V.position}}(s.startAt)),s.endAt&&(c.structuredQuery.endAt=function(V){return{before:!V.inclusive,values:V.position}}(s.endAt)),{_t:c,parent:_}}function Bj(u){let s=Uj(u.parent);const c=u.structuredQuery,p=c.from?c.from.length:0;let _=null;if(p>0){_r(p===1);const G=c.from[0];G.allDescendants?_=G.collectionId:s=s.child(G.collectionId)}let g=[];c.where&&(g=function(tt){const st=gA(tt);return st instanceof co&&jC(st)?st.getFilters():[st]}(c.where));let y=[];c.orderBy&&(y=function(tt){return tt.map(st=>function(yt){return new Sf(rl(yt.field),function(wt){switch(wt){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(yt.direction))}(st))}(c.orderBy));let O=null;c.limit&&(O=function(tt){let st;return st=typeof tt=="object"?tt.value:tt,_f(st)?null:st}(c.limit));let L=null;c.startAt&&(L=function(tt){const st=!!tt.before,ht=tt.values||[];return new Tf(ht,st)}(c.startAt));let V=null;return c.endAt&&(V=function(tt){const st=!tt.before,ht=tt.values||[];return new Tf(ht,st)}(c.endAt)),sj(s,_,y,g,O,"F",L,V)}function jj(u,s){const c=function(_){switch(_){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return qe()}}(s.purpose);return c==null?null:{"goog-listen-tags":c}}function gA(u){return u.unaryFilter!==void 0?function(c){switch(c.unaryFilter.op){case"IS_NAN":const p=rl(c.unaryFilter.field);return Mr.create(p,"==",{doubleValue:NaN});case"IS_NULL":const _=rl(c.unaryFilter.field);return Mr.create(_,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const g=rl(c.unaryFilter.field);return Mr.create(g,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const y=rl(c.unaryFilter.field);return Mr.create(y,"!=",{nullValue:"NULL_VALUE"});default:return qe()}}(u):u.fieldFilter!==void 0?function(c){return Mr.create(rl(c.fieldFilter.field),function(_){switch(_){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return qe()}}(c.fieldFilter.op),c.fieldFilter.value)}(u):u.compositeFilter!==void 0?function(c){return co.create(c.compositeFilter.filters.map(p=>gA(p)),function(_){switch(_){case"AND":return"and";case"OR":return"or";default:return qe()}}(c.compositeFilter.op))}(u):qe()}function Gj(u){return Oj[u]}function Wj(u){return Nj[u]}function Hj(u){return Pj[u]}function nl(u){return{fieldPath:u.canonicalString()}}function rl(u){return wi.fromServerFormat(u.fieldPath)}function TA(u){return u instanceof Mr?function(c){if(c.op==="=="){if(UC(c.value))return{unaryFilter:{field:nl(c.field),op:"IS_NAN"}};if(MC(c.value))return{unaryFilter:{field:nl(c.field),op:"IS_NULL"}}}else if(c.op==="!="){if(UC(c.value))return{unaryFilter:{field:nl(c.field),op:"IS_NOT_NAN"}};if(MC(c.value))return{unaryFilter:{field:nl(c.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:nl(c.field),op:Wj(c.op),value:c.value}}}(u):u instanceof co?function(c){const p=c.getFilters().map(_=>TA(_));return p.length===1?p[0]:{compositeFilter:{op:Hj(c.op),filters:p}}}(u):qe()}function SA(u){return u.length>=4&&u.get(0)==="projects"&&u.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Wa{constructor(s,c,p,_,g=Ve.min(),y=Ve.min(),O=oi.EMPTY_BYTE_STRING,L=null){this.target=s,this.targetId=c,this.purpose=p,this.sequenceNumber=_,this.snapshotVersion=g,this.lastLimboFreeSnapshotVersion=y,this.resumeToken=O,this.expectedCount=L}withSequenceNumber(s){return new Wa(this.target,this.targetId,this.purpose,s,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(s,c){return new Wa(this.target,this.targetId,this.purpose,this.sequenceNumber,c,this.lastLimboFreeSnapshotVersion,s,null)}withExpectedCount(s){return new Wa(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,s)}withLastLimboFreeSnapshotVersion(s){return new Wa(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,s,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kj{constructor(s){this.ct=s}}function qj(u){const s=Bj({parent:u.parent,structuredQuery:u.structuredQuery});return u.limitType==="LAST"?qg(s,s.limit,"L"):s}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Yj{constructor(){this.un=new zj}addToCollectionParentIndex(s,c){return this.un.add(c),Dt.resolve()}getCollectionParents(s,c){return Dt.resolve(this.un.getEntries(c))}addFieldIndex(s,c){return Dt.resolve()}deleteFieldIndex(s,c){return Dt.resolve()}deleteAllFieldIndexes(s){return Dt.resolve()}createTargetIndexes(s,c){return Dt.resolve()}getDocumentsMatchingTarget(s,c){return Dt.resolve(null)}getIndexType(s,c){return Dt.resolve(0)}getFieldIndexes(s,c){return Dt.resolve([])}getNextCollectionGroupToUpdate(s){return Dt.resolve(null)}getMinOffset(s,c){return Dt.resolve(Fa.min())}getMinOffsetFromCollectionGroup(s,c){return Dt.resolve(Fa.min())}updateCollectionGroup(s,c,p){return Dt.resolve()}updateIndexEntries(s,c){return Dt.resolve()}}class zj{constructor(){this.index={}}add(s){const c=s.lastSegment(),p=s.popLast(),_=this.index[c]||new si(mr.comparator),g=!_.has(p);return this.index[c]=_.add(p),g}has(s){const c=s.lastSegment(),p=s.popLast(),_=this.index[c];return _&&_.has(p)}getEntries(s){return(this.index[s]||new si(mr.comparator)).toArray()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class il{constructor(s){this.Ln=s}next(){return this.Ln+=2,this.Ln}static Bn(){return new il(0)}static kn(){return new il(-1)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jj{constructor(){this.changes=new tl(s=>s.toString(),(s,c)=>s.isEqual(c)),this.changesApplied=!1}addEntry(s){this.assertNotApplied(),this.changes.set(s.key,s)}removeEntry(s,c){this.assertNotApplied(),this.changes.set(s,mi.newInvalidDocument(s).setReadTime(c))}getEntry(s,c){this.assertNotApplied();const p=this.changes.get(c);return p!==void 0?Dt.resolve(p):this.getFromCache(s,c)}getEntries(s,c){return this.getAllFromCache(s,c)}apply(s){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(s)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xj{constructor(s,c){this.overlayedDocument=s,this.mutatedFields=c}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qj{constructor(s,c,p,_){this.remoteDocumentCache=s,this.mutationQueue=c,this.documentOverlayCache=p,this.indexManager=_}getDocument(s,c){let p=null;return this.documentOverlayCache.getOverlay(s,c).next(_=>(p=_,this.remoteDocumentCache.getEntry(s,c))).next(_=>(p!==null&&sh(p.mutation,_,Ba.empty(),Ui.now()),_))}getDocuments(s,c){return this.remoteDocumentCache.getEntries(s,c).next(p=>this.getLocalViewOfDocuments(s,p,En()).next(()=>p))}getLocalViewOfDocuments(s,c,p=En()){const _=jc();return this.populateOverlays(s,_,c).next(()=>this.computeViews(s,c,_,p).next(g=>{let y=rh();return g.forEach((O,L)=>{y=y.insert(O,L.overlayedDocument)}),y}))}getOverlayedDocuments(s,c){const p=jc();return this.populateOverlays(s,p,c).next(()=>this.computeViews(s,c,p,En()))}populateOverlays(s,c,p){const _=[];return p.forEach(g=>{c.has(g)||_.push(g)}),this.documentOverlayCache.getOverlays(s,_).next(g=>{g.forEach((y,O)=>{c.set(y,O)})})}computeViews(s,c,p,_){let g=Ga();const y=ih(),O=function(){return ih()}();return c.forEach((L,V)=>{const G=p.get(V.key);_.has(V.key)&&(G===void 0||G.mutation instanceof bf)?g=g.insert(V.key,V):G!==void 0?(y.set(V.key,G.mutation.getFieldMask()),sh(G.mutation,V,G.mutation.getFieldMask(),Ui.now())):y.set(V.key,Ba.empty())}),this.recalculateAndSaveOverlays(s,g).next(L=>(L.forEach((V,G)=>y.set(V,G)),c.forEach((V,G)=>{var tt;return O.set(V,new Xj(G,(tt=y.get(V))!==null&&tt!==void 0?tt:null))}),O))}recalculateAndSaveOverlays(s,c){const p=ih();let _=new Ar((y,O)=>y-O),g=En();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,c).next(y=>{for(const O of y)O.keys().forEach(L=>{const V=c.get(L);if(V===null)return;let G=p.get(L)||Ba.empty();G=O.applyToLocalView(V,G),p.set(L,G);const tt=(_.get(O.batchId)||En()).add(L);_=_.insert(O.batchId,tt)})}).next(()=>{const y=[],O=_.getReverseIterator();for(;O.hasNext();){const L=O.getNext(),V=L.key,G=L.value,tt=XC();G.forEach(st=>{if(!g.has(st)){const ht=eA(c.get(st),p.get(st));ht!==null&&tt.set(st,ht),g=g.add(st)}}),y.push(this.documentOverlayCache.saveOverlays(s,V,tt))}return Dt.waitFor(y)}).next(()=>p)}recalculateAndSaveOverlaysForDocumentKeys(s,c){return this.remoteDocumentCache.getEntries(s,c).next(p=>this.recalculateAndSaveOverlays(s,p))}getDocumentsMatchingQuery(s,c,p,_){return function(y){return Ae.isDocumentKey(y.path)&&y.collectionGroup===null&&y.filters.length===0}(c)?this.getDocumentsMatchingDocumentQuery(s,c.path):oj(c)?this.getDocumentsMatchingCollectionGroupQuery(s,c,p,_):this.getDocumentsMatchingCollectionQuery(s,c,p,_)}getNextDocuments(s,c,p,_){return this.remoteDocumentCache.getAllFromCollectionGroup(s,c,p,_).next(g=>{const y=_-g.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(s,c,p.largestBatchId,_-g.size):Dt.resolve(jc());let O=-1,L=g;return y.next(V=>Dt.forEach(V,(G,tt)=>(O<tt.largestBatchId&&(O=tt.largestBatchId),g.get(G)?Dt.resolve():this.remoteDocumentCache.getEntry(s,G).next(st=>{L=L.insert(G,st)}))).next(()=>this.populateOverlays(s,V,g)).next(()=>this.computeViews(s,L,V,En())).next(G=>({batchId:O,changes:uj(G)})))})}getDocumentsMatchingDocumentQuery(s,c){return this.getDocument(s,new Ae(c)).next(p=>{let _=rh();return p.isFoundDocument()&&(_=_.insert(p.key,p)),_})}getDocumentsMatchingCollectionGroupQuery(s,c,p,_){const g=c.collectionGroup;let y=rh();return this.indexManager.getCollectionParents(s,g).next(O=>Dt.forEach(O,L=>{const V=function(tt,st){return new vf(st,null,tt.explicitOrderBy.slice(),tt.filters.slice(),tt.limit,tt.limitType,tt.startAt,tt.endAt)}(c,L.child(g));return this.getDocumentsMatchingCollectionQuery(s,V,p,_).next(G=>{G.forEach((tt,st)=>{y=y.insert(tt,st)})})}).next(()=>y))}getDocumentsMatchingCollectionQuery(s,c,p,_){let g;return this.documentOverlayCache.getOverlaysForCollection(s,c.path,p.largestBatchId).next(y=>(g=y,this.remoteDocumentCache.getDocumentsMatchingQuery(s,c,p,g,_))).next(y=>{g.forEach((L,V)=>{const G=V.getKey();y.get(G)===null&&(y=y.insert(G,mi.newInvalidDocument(G)))});let O=rh();return y.forEach((L,V)=>{const G=g.get(L);G!==void 0&&sh(G.mutation,V,Ba.empty(),Ui.now()),Rf(c,V)&&(O=O.insert(L,V))}),O})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $j{constructor(s){this.serializer=s,this.hr=new Map,this.Pr=new Map}getBundleMetadata(s,c){return Dt.resolve(this.hr.get(c))}saveBundleMetadata(s,c){return this.hr.set(c.id,function(_){return{id:_.id,version:_.version,createTime:el(_.createTime)}}(c)),Dt.resolve()}getNamedQuery(s,c){return Dt.resolve(this.Pr.get(c))}saveNamedQuery(s,c){return this.Pr.set(c.name,function(_){return{name:_.name,query:qj(_.bundledQuery),readTime:el(_.readTime)}}(c)),Dt.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zj{constructor(){this.overlays=new Ar(Ae.comparator),this.Ir=new Map}getOverlay(s,c){return Dt.resolve(this.overlays.get(c))}getOverlays(s,c){const p=jc();return Dt.forEach(c,_=>this.getOverlay(s,_).next(g=>{g!==null&&p.set(_,g)})).next(()=>p)}saveOverlays(s,c,p){return p.forEach((_,g)=>{this.ht(s,c,g)}),Dt.resolve()}removeOverlaysForBatchId(s,c,p){const _=this.Ir.get(p);return _!==void 0&&(_.forEach(g=>this.overlays=this.overlays.remove(g)),this.Ir.delete(p)),Dt.resolve()}getOverlaysForCollection(s,c,p){const _=jc(),g=c.length+1,y=new Ae(c.child("")),O=this.overlays.getIteratorFrom(y);for(;O.hasNext();){const L=O.getNext().value,V=L.getKey();if(!c.isPrefixOf(V.path))break;V.path.length===g&&L.largestBatchId>p&&_.set(L.getKey(),L)}return Dt.resolve(_)}getOverlaysForCollectionGroup(s,c,p,_){let g=new Ar((V,G)=>V-G);const y=this.overlays.getIterator();for(;y.hasNext();){const V=y.getNext().value;if(V.getKey().getCollectionGroup()===c&&V.largestBatchId>p){let G=g.get(V.largestBatchId);G===null&&(G=jc(),g=g.insert(V.largestBatchId,G)),G.set(V.getKey(),V)}}const O=jc(),L=g.getIterator();for(;L.hasNext()&&(L.getNext().value.forEach((V,G)=>O.set(V,G)),!(O.size()>=_)););return Dt.resolve(O)}ht(s,c,p){const _=this.overlays.get(p.key);if(_!==null){const y=this.Ir.get(_.largestBatchId).delete(p.key);this.Ir.set(_.largestBatchId,y)}this.overlays=this.overlays.insert(p.key,new Ij(c,p));let g=this.Ir.get(c);g===void 0&&(g=En(),this.Ir.set(c,g)),this.Ir.set(c,g.add(p.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class tG{constructor(){this.sessionToken=oi.EMPTY_BYTE_STRING}getSessionToken(s){return Dt.resolve(this.sessionToken)}setSessionToken(s,c){return this.sessionToken=c,Dt.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eT{constructor(){this.Tr=new si(Kr.Er),this.dr=new si(Kr.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(s,c){const p=new Kr(s,c);this.Tr=this.Tr.add(p),this.dr=this.dr.add(p)}Rr(s,c){s.forEach(p=>this.addReference(p,c))}removeReference(s,c){this.Vr(new Kr(s,c))}mr(s,c){s.forEach(p=>this.removeReference(p,c))}gr(s){const c=new Ae(new mr([])),p=new Kr(c,s),_=new Kr(c,s+1),g=[];return this.dr.forEachInRange([p,_],y=>{this.Vr(y),g.push(y.key)}),g}pr(){this.Tr.forEach(s=>this.Vr(s))}Vr(s){this.Tr=this.Tr.delete(s),this.dr=this.dr.delete(s)}yr(s){const c=new Ae(new mr([])),p=new Kr(c,s),_=new Kr(c,s+1);let g=En();return this.dr.forEachInRange([p,_],y=>{g=g.add(y.key)}),g}containsKey(s){const c=new Kr(s,0),p=this.Tr.firstAfterOrEqual(c);return p!==null&&s.isEqual(p.key)}}class Kr{constructor(s,c){this.key=s,this.wr=c}static Er(s,c){return Ae.comparator(s.key,c.key)||An(s.wr,c.wr)}static Ar(s,c){return An(s.wr,c.wr)||Ae.comparator(s.key,c.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eG{constructor(s,c){this.indexManager=s,this.referenceDelegate=c,this.mutationQueue=[],this.Sr=1,this.br=new si(Kr.Er)}checkEmpty(s){return Dt.resolve(this.mutationQueue.length===0)}addMutationBatch(s,c,p,_){const g=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const y=new Rj(g,c,p,_);this.mutationQueue.push(y);for(const O of _)this.br=this.br.add(new Kr(O.key,g)),this.indexManager.addToCollectionParentIndex(s,O.key.path.popLast());return Dt.resolve(y)}lookupMutationBatch(s,c){return Dt.resolve(this.Dr(c))}getNextMutationBatchAfterBatchId(s,c){const p=c+1,_=this.vr(p),g=_<0?0:_;return Dt.resolve(this.mutationQueue.length>g?this.mutationQueue[g]:null)}getHighestUnacknowledgedBatchId(){return Dt.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(s){return Dt.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(s,c){const p=new Kr(c,0),_=new Kr(c,Number.POSITIVE_INFINITY),g=[];return this.br.forEachInRange([p,_],y=>{const O=this.Dr(y.wr);g.push(O)}),Dt.resolve(g)}getAllMutationBatchesAffectingDocumentKeys(s,c){let p=new si(An);return c.forEach(_=>{const g=new Kr(_,0),y=new Kr(_,Number.POSITIVE_INFINITY);this.br.forEachInRange([g,y],O=>{p=p.add(O.wr)})}),Dt.resolve(this.Cr(p))}getAllMutationBatchesAffectingQuery(s,c){const p=c.path,_=p.length+1;let g=p;Ae.isDocumentKey(g)||(g=g.child(""));const y=new Kr(new Ae(g),0);let O=new si(An);return this.br.forEachWhile(L=>{const V=L.key.path;return!!p.isPrefixOf(V)&&(V.length===_&&(O=O.add(L.wr)),!0)},y),Dt.resolve(this.Cr(O))}Cr(s){const c=[];return s.forEach(p=>{const _=this.Dr(p);_!==null&&c.push(_)}),c}removeMutationBatch(s,c){_r(this.Fr(c.batchId,"removed")===0),this.mutationQueue.shift();let p=this.br;return Dt.forEach(c.mutations,_=>{const g=new Kr(_.key,c.batchId);return p=p.delete(g),this.referenceDelegate.markPotentiallyOrphaned(s,_.key)}).next(()=>{this.br=p})}On(s){}containsKey(s,c){const p=new Kr(c,0),_=this.br.firstAfterOrEqual(p);return Dt.resolve(c.isEqual(_&&_.key))}performConsistencyCheck(s){return this.mutationQueue.length,Dt.resolve()}Fr(s,c){return this.vr(s)}vr(s){return this.mutationQueue.length===0?0:s-this.mutationQueue[0].batchId}Dr(s){const c=this.vr(s);return c<0||c>=this.mutationQueue.length?null:this.mutationQueue[c]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nG{constructor(s){this.Mr=s,this.docs=function(){return new Ar(Ae.comparator)}(),this.size=0}setIndexManager(s){this.indexManager=s}addEntry(s,c){const p=c.key,_=this.docs.get(p),g=_?_.size:0,y=this.Mr(c);return this.docs=this.docs.insert(p,{document:c.mutableCopy(),size:y}),this.size+=y-g,this.indexManager.addToCollectionParentIndex(s,p.path.popLast())}removeEntry(s){const c=this.docs.get(s);c&&(this.docs=this.docs.remove(s),this.size-=c.size)}getEntry(s,c){const p=this.docs.get(c);return Dt.resolve(p?p.document.mutableCopy():mi.newInvalidDocument(c))}getEntries(s,c){let p=Ga();return c.forEach(_=>{const g=this.docs.get(_);p=p.insert(_,g?g.document.mutableCopy():mi.newInvalidDocument(_))}),Dt.resolve(p)}getDocumentsMatchingQuery(s,c,p,_){let g=Ga();const y=c.path,O=new Ae(y.child("")),L=this.docs.getIteratorFrom(O);for(;L.hasNext();){const{key:V,value:{document:G}}=L.getNext();if(!y.isPrefixOf(V.path))break;V.path.length>y.length+1||BB(FB(G),p)<=0||(_.has(G.key)||Rf(c,G))&&(g=g.insert(G.key,G.mutableCopy()))}return Dt.resolve(g)}getAllFromCollectionGroup(s,c,p,_){qe()}Or(s,c){return Dt.forEach(this.docs,p=>c(p))}newChangeBuffer(s){return new rG(this)}getSize(s){return Dt.resolve(this.size)}}class rG extends Jj{constructor(s){super(),this.cr=s}applyChanges(s){const c=[];return this.changes.forEach((p,_)=>{_.isValidDocument()?c.push(this.cr.addEntry(s,_)):this.cr.removeEntry(p)}),Dt.waitFor(c)}getFromCache(s,c){return this.cr.getEntry(s,c)}getAllFromCache(s,c){return this.cr.getEntries(s,c)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iG{constructor(s){this.persistence=s,this.Nr=new tl(c=>Gg(c),Wg),this.lastRemoteSnapshotVersion=Ve.min(),this.highestTargetId=0,this.Lr=0,this.Br=new eT,this.targetCount=0,this.kr=il.Bn()}forEachTarget(s,c){return this.Nr.forEach((p,_)=>c(_)),Dt.resolve()}getLastRemoteSnapshotVersion(s){return Dt.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(s){return Dt.resolve(this.Lr)}allocateTargetId(s){return this.highestTargetId=this.kr.next(),Dt.resolve(this.highestTargetId)}setTargetsMetadata(s,c,p){return p&&(this.lastRemoteSnapshotVersion=p),c>this.Lr&&(this.Lr=c),Dt.resolve()}Kn(s){this.Nr.set(s.target,s);const c=s.targetId;c>this.highestTargetId&&(this.kr=new il(c),this.highestTargetId=c),s.sequenceNumber>this.Lr&&(this.Lr=s.sequenceNumber)}addTargetData(s,c){return this.Kn(c),this.targetCount+=1,Dt.resolve()}updateTargetData(s,c){return this.Kn(c),Dt.resolve()}removeTargetData(s,c){return this.Nr.delete(c.target),this.Br.gr(c.targetId),this.targetCount-=1,Dt.resolve()}removeTargets(s,c,p){let _=0;const g=[];return this.Nr.forEach((y,O)=>{O.sequenceNumber<=c&&p.get(O.targetId)===null&&(this.Nr.delete(y),g.push(this.removeMatchingKeysForTargetId(s,O.targetId)),_++)}),Dt.waitFor(g).next(()=>_)}getTargetCount(s){return Dt.resolve(this.targetCount)}getTargetData(s,c){const p=this.Nr.get(c)||null;return Dt.resolve(p)}addMatchingKeys(s,c,p){return this.Br.Rr(c,p),Dt.resolve()}removeMatchingKeys(s,c,p){this.Br.mr(c,p);const _=this.persistence.referenceDelegate,g=[];return _&&c.forEach(y=>{g.push(_.markPotentiallyOrphaned(s,y))}),Dt.waitFor(g)}removeMatchingKeysForTargetId(s,c){return this.Br.gr(c),Dt.resolve()}getMatchingKeysForTargetId(s,c){const p=this.Br.yr(c);return Dt.resolve(p)}containsKey(s,c){return Dt.resolve(this.Br.containsKey(c))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sG{constructor(s,c){this.qr={},this.overlays={},this.Qr=new kg(0),this.Kr=!1,this.Kr=!0,this.$r=new tG,this.referenceDelegate=s(this),this.Ur=new iG(this),this.indexManager=new Yj,this.remoteDocumentCache=function(_){return new nG(_)}(p=>this.referenceDelegate.Wr(p)),this.serializer=new Kj(c),this.Gr=new $j(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(s){return this.indexManager}getDocumentOverlayCache(s){let c=this.overlays[s.toKey()];return c||(c=new Zj,this.overlays[s.toKey()]=c),c}getMutationQueue(s,c){let p=this.qr[s.toKey()];return p||(p=new eG(c,this.referenceDelegate),this.qr[s.toKey()]=p),p}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(s,c,p){se("MemoryPersistence","Starting transaction:",s);const _=new oG(this.Qr.next());return this.referenceDelegate.zr(),p(_).next(g=>this.referenceDelegate.jr(_).next(()=>g)).toPromise().then(g=>(_.raiseOnCommittedEvent(),g))}Hr(s,c){return Dt.or(Object.values(this.qr).map(p=>()=>p.containsKey(s,c)))}}class oG extends GB{constructor(s){super(),this.currentSequenceNumber=s}}class nT{constructor(s){this.persistence=s,this.Jr=new eT,this.Yr=null}static Zr(s){return new nT(s)}get Xr(){if(this.Yr)return this.Yr;throw qe()}addReference(s,c,p){return this.Jr.addReference(p,c),this.Xr.delete(p.toString()),Dt.resolve()}removeReference(s,c,p){return this.Jr.removeReference(p,c),this.Xr.add(p.toString()),Dt.resolve()}markPotentiallyOrphaned(s,c){return this.Xr.add(c.toString()),Dt.resolve()}removeTarget(s,c){this.Jr.gr(c.targetId).forEach(_=>this.Xr.add(_.toString()));const p=this.persistence.getTargetCache();return p.getMatchingKeysForTargetId(s,c.targetId).next(_=>{_.forEach(g=>this.Xr.add(g.toString()))}).next(()=>p.removeTargetData(s,c))}zr(){this.Yr=new Set}jr(s){const c=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Dt.forEach(this.Xr,p=>{const _=Ae.fromPath(p);return this.ei(s,_).next(g=>{g||c.removeEntry(_,Ve.min())})}).next(()=>(this.Yr=null,c.apply(s)))}updateLimboDocument(s,c){return this.ei(s,c).next(p=>{p?this.Xr.delete(c.toString()):this.Xr.add(c.toString())})}Wr(s){return 0}ei(s,c){return Dt.or([()=>Dt.resolve(this.Jr.containsKey(c)),()=>this.persistence.getTargetCache().containsKey(s,c),()=>this.persistence.Hr(s,c)])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rT{constructor(s,c,p,_){this.targetId=s,this.fromCache=c,this.$i=p,this.Ui=_}static Wi(s,c){let p=En(),_=En();for(const g of c.docChanges)switch(g.type){case 0:p=p.add(g.doc.key);break;case 1:_=_.add(g.doc.key)}return new rT(s,c.fromCache,p,_)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aG{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(s){this._documentReadCount+=s}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cG{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return hF()?8:WB(fi())>0?6:4}()}initialize(s,c){this.Ji=s,this.indexManager=c,this.Gi=!0}getDocumentsMatchingQuery(s,c,p,_){const g={result:null};return this.Yi(s,c).next(y=>{g.result=y}).next(()=>{if(!g.result)return this.Zi(s,c,_,p).next(y=>{g.result=y})}).next(()=>{if(g.result)return;const y=new aG;return this.Xi(s,c,y).next(O=>{if(g.result=O,this.zi)return this.es(s,c,y,O.size)})}).next(()=>g.result)}es(s,c,p,_){return p.documentReadCount<this.ji?(Ju()<=on.DEBUG&&se("QueryEngine","SDK will not create cache indexes for query:",Zd(c),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),Dt.resolve()):(Ju()<=on.DEBUG&&se("QueryEngine","Query:",Zd(c),"scans",p.documentReadCount,"local documents and returns",_,"documents as results."),p.documentReadCount>this.Hi*_?(Ju()<=on.DEBUG&&se("QueryEngine","The SDK decides to create cache indexes for query:",Zd(c),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(s,lo(c))):Dt.resolve())}Yi(s,c){if(qC(c))return Dt.resolve(null);let p=lo(c);return this.indexManager.getIndexType(s,p).next(_=>_===0?null:(c.limit!==null&&_===1&&(c=qg(c,null,"F"),p=lo(c)),this.indexManager.getDocumentsMatchingTarget(s,p).next(g=>{const y=En(...g);return this.Ji.getDocuments(s,y).next(O=>this.indexManager.getMinOffset(s,p).next(L=>{const V=this.ts(c,O);return this.ns(c,V,y,L.readTime)?this.Yi(s,qg(c,null,"F")):this.rs(s,V,c,L)}))})))}Zi(s,c,p,_){return qC(c)||_.isEqual(Ve.min())?Dt.resolve(null):this.Ji.getDocuments(s,p).next(g=>{const y=this.ts(c,g);return this.ns(c,y,p,_)?Dt.resolve(null):(Ju()<=on.DEBUG&&se("QueryEngine","Re-using previous result from %s to execute query: %s",_.toString(),Zd(c)),this.rs(s,y,c,VB(_,-1)).next(O=>O))})}ts(s,c){let p=new si(zC(s));return c.forEach((_,g)=>{Rf(s,g)&&(p=p.add(g))}),p}ns(s,c,p,_){if(s.limit===null)return!1;if(p.size!==c.size)return!0;const g=s.limitType==="F"?c.last():c.first();return!!g&&(g.hasPendingWrites||g.version.compareTo(_)>0)}Xi(s,c,p){return Ju()<=on.DEBUG&&se("QueryEngine","Using full collection scan to execute query:",Zd(c)),this.Ji.getDocumentsMatchingQuery(s,c,Fa.min(),p)}rs(s,c,p,_){return this.Ji.getDocumentsMatchingQuery(s,p,_).next(g=>(c.forEach(y=>{g=g.insert(y.key,y)}),g))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dG{constructor(s,c,p,_){this.persistence=s,this.ss=c,this.serializer=_,this.os=new Ar(An),this._s=new tl(g=>Gg(g),Wg),this.us=new Map,this.cs=s.getRemoteDocumentCache(),this.Ur=s.getTargetCache(),this.Gr=s.getBundleCache(),this.ls(p)}ls(s){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(s),this.indexManager=this.persistence.getIndexManager(s),this.mutationQueue=this.persistence.getMutationQueue(s,this.indexManager),this.localDocuments=new Qj(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(s){return this.persistence.runTransaction("Collect garbage","readwrite-primary",c=>s.collect(c,this.os))}}function lG(u,s,c,p){return new dG(u,s,c,p)}async function vA(u,s){const c=un(u);return await c.persistence.runTransaction("Handle user change","readonly",p=>{let _;return c.mutationQueue.getAllMutationBatches(p).next(g=>(_=g,c.ls(s),c.mutationQueue.getAllMutationBatches(p))).next(g=>{const y=[],O=[];let L=En();for(const V of _){y.push(V.batchId);for(const G of V.mutations)L=L.add(G.key)}for(const V of g){O.push(V.batchId);for(const G of V.mutations)L=L.add(G.key)}return c.localDocuments.getDocuments(p,L).next(V=>({hs:V,removedBatchIds:y,addedBatchIds:O}))})})}function yA(u){const s=un(u);return s.persistence.runTransaction("Get last remote snapshot version","readonly",c=>s.Ur.getLastRemoteSnapshotVersion(c))}function uG(u,s){const c=un(u),p=s.snapshotVersion;let _=c.os;return c.persistence.runTransaction("Apply remote event","readwrite-primary",g=>{const y=c.cs.newChangeBuffer({trackRemovals:!0});_=c.os;const O=[];s.targetChanges.forEach((G,tt)=>{const st=_.get(tt);if(!st)return;O.push(c.Ur.removeMatchingKeys(g,G.removedDocuments,tt).next(()=>c.Ur.addMatchingKeys(g,G.addedDocuments,tt)));let ht=st.withSequenceNumber(g.currentSequenceNumber);s.targetMismatches.get(tt)!==null?ht=ht.withResumeToken(oi.EMPTY_BYTE_STRING,Ve.min()).withLastLimboFreeSnapshotVersion(Ve.min()):G.resumeToken.approximateByteSize()>0&&(ht=ht.withResumeToken(G.resumeToken,p)),_=_.insert(tt,ht),function(Vt,wt,te){return Vt.resumeToken.approximateByteSize()===0||wt.snapshotVersion.toMicroseconds()-Vt.snapshotVersion.toMicroseconds()>=3e8?!0:te.addedDocuments.size+te.modifiedDocuments.size+te.removedDocuments.size>0}(st,ht,G)&&O.push(c.Ur.updateTargetData(g,ht))});let L=Ga(),V=En();if(s.documentUpdates.forEach(G=>{s.resolvedLimboDocuments.has(G)&&O.push(c.persistence.referenceDelegate.updateLimboDocument(g,G))}),O.push(hG(g,y,s.documentUpdates).next(G=>{L=G.Ps,V=G.Is})),!p.isEqual(Ve.min())){const G=c.Ur.getLastRemoteSnapshotVersion(g).next(tt=>c.Ur.setTargetsMetadata(g,g.currentSequenceNumber,p));O.push(G)}return Dt.waitFor(O).next(()=>y.apply(g)).next(()=>c.localDocuments.getLocalViewOfDocuments(g,L,V)).next(()=>L)}).then(g=>(c.os=_,g))}function hG(u,s,c){let p=En(),_=En();return c.forEach(g=>p=p.add(g)),s.getEntries(u,p).next(g=>{let y=Ga();return c.forEach((O,L)=>{const V=g.get(O);L.isFoundDocument()!==V.isFoundDocument()&&(_=_.add(O)),L.isNoDocument()&&L.version.isEqual(Ve.min())?(s.removeEntry(O,L.readTime),y=y.insert(O,L)):!V.isValidDocument()||L.version.compareTo(V.version)>0||L.version.compareTo(V.version)===0&&V.hasPendingWrites?(s.addEntry(L),y=y.insert(O,L)):se("LocalStore","Ignoring outdated watch update for ",O,". Current version:",V.version," Watch version:",L.version)}),{Ps:y,Is:_}})}function pG(u,s){const c=un(u);return c.persistence.runTransaction("Allocate target","readwrite",p=>{let _;return c.Ur.getTargetData(p,s).next(g=>g?(_=g,Dt.resolve(_)):c.Ur.allocateTargetId(p).next(y=>(_=new Wa(s,y,"TargetPurposeListen",p.currentSequenceNumber),c.Ur.addTargetData(p,_).next(()=>_))))}).then(p=>{const _=c.os.get(p.targetId);return(_===null||p.snapshotVersion.compareTo(_.snapshotVersion)>0)&&(c.os=c.os.insert(p.targetId,p),c._s.set(s,p.targetId)),p})}async function iT(u,s,c){const p=un(u),_=p.os.get(s),g=c?"readwrite":"readwrite-primary";try{c||await p.persistence.runTransaction("Release target",g,y=>p.persistence.referenceDelegate.removeTarget(y,_))}catch(y){if(!Qu(y))throw y;se("LocalStore",`Failed to update sequence numbers for target ${s}: ${y}`)}p.os=p.os.remove(s),p._s.delete(_.target)}function RA(u,s,c){const p=un(u);let _=Ve.min(),g=En();return p.persistence.runTransaction("Execute query","readwrite",y=>function(L,V,G){const tt=un(L),st=tt._s.get(G);return st!==void 0?Dt.resolve(tt.os.get(st)):tt.Ur.getTargetData(V,G)}(p,y,lo(s)).next(O=>{if(O)return _=O.lastLimboFreeSnapshotVersion,p.Ur.getMatchingKeysForTargetId(y,O.targetId).next(L=>{g=L})}).next(()=>p.ss.getDocumentsMatchingQuery(y,s,c?_:Ve.min(),c?g:En())).next(O=>(fG(p,cj(s),O),{documents:O,Ts:g})))}function fG(u,s,c){let p=u.us.get(s)||Ve.min();c.forEach((_,g)=>{g.readTime.compareTo(p)>0&&(p=g.readTime)}),u.us.set(s,p)}class IA{constructor(){this.activeTargetIds=fj()}fs(s){this.activeTargetIds=this.activeTargetIds.add(s)}gs(s){this.activeTargetIds=this.activeTargetIds.delete(s)}Vs(){const s={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(s)}}class _G{constructor(){this.so=new IA,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(s){}updateMutationState(s,c,p){}addLocalQueryTarget(s,c=!0){return c&&this.so.fs(s),this.oo[s]||"not-current"}updateQueryState(s,c,p){this.oo[s]=c}removeLocalQueryTarget(s){this.so.gs(s)}isLocalQueryTarget(s){return this.so.activeTargetIds.has(s)}clearQueryState(s){delete this.oo[s]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(s){return this.so.activeTargetIds.has(s)}start(){return this.so=new IA,Promise.resolve()}handleUserChange(s,c,p){}setOnlineState(s){}shutdown(){}writeSequenceNumber(s){}notifyBundleLoaded(s){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mG{_o(s){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class CA{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(s){this.ho.push(s)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){se("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const s of this.ho)s(0)}lo(){se("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const s of this.ho)s(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Pf=null;function sT(){return Pf===null?Pf=function(){return 268435456+Math.round(2147483648*Math.random())}():Pf++,"0x"+Pf.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const EG={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gG{constructor(s){this.Io=s.Io,this.To=s.To}Eo(s){this.Ao=s}Ro(s){this.Vo=s}mo(s){this.fo=s}onMessage(s){this.po=s}close(){this.To()}send(s){this.Io(s)}yo(){this.Ao()}wo(){this.Vo()}So(s){this.fo(s)}bo(s){this.po(s)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ei="WebChannelConnection";class TG extends class{constructor(c){this.databaseInfo=c,this.databaseId=c.databaseId;const p=c.ssl?"https":"http",_=encodeURIComponent(this.databaseId.projectId),g=encodeURIComponent(this.databaseId.database);this.Do=p+"://"+c.host,this.vo=`projects/${_}/databases/${g}`,this.Co=this.databaseId.database==="(default)"?`project_id=${_}`:`project_id=${_}&database_id=${g}`}get Fo(){return!1}Mo(c,p,_,g,y){const O=sT(),L=this.xo(c,p.toUriEncodedString());se("RestConnection",`Sending RPC '${c}' ${O}:`,L,_);const V={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(V,g,y),this.No(c,L,V,_).then(G=>(se("RestConnection",`Received RPC '${c}' ${O}: `,G),G),G=>{throw Jd("RestConnection",`RPC '${c}' ${O} failed with error: `,G,"url: ",L,"request:",_),G})}Lo(c,p,_,g,y,O){return this.Mo(c,p,_,g,y)}Oo(c,p,_){c["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+zd}(),c["Content-Type"]="text/plain",this.databaseInfo.appId&&(c["X-Firebase-GMPID"]=this.databaseInfo.appId),p&&p.headers.forEach((g,y)=>c[y]=g),_&&_.headers.forEach((g,y)=>c[y]=g)}xo(c,p){const _=EG[c];return`${this.Do}/v1/${p}:${_}`}terminate(){}}{constructor(s){super(s),this.forceLongPolling=s.forceLongPolling,this.autoDetectLongPolling=s.autoDetectLongPolling,this.useFetchStreams=s.useFetchStreams,this.longPollingOptions=s.longPollingOptions}No(s,c,p,_){const g=sT();return new Promise((y,O)=>{const L=new yC;L.setWithCredentials(!0),L.listenOnce(RC.COMPLETE,()=>{try{switch(L.getLastErrorCode()){case ff.NO_ERROR:const G=L.getResponseJson();se(Ei,`XHR for RPC '${s}' ${g} received:`,JSON.stringify(G)),y(G);break;case ff.TIMEOUT:se(Ei,`RPC '${s}' ${g} timed out`),O(new Ce(Kt.DEADLINE_EXCEEDED,"Request time out"));break;case ff.HTTP_ERROR:const tt=L.getStatus();if(se(Ei,`RPC '${s}' ${g} failed with status:`,tt,"response text:",L.getResponseText()),tt>0){let st=L.getResponseJson();Array.isArray(st)&&(st=st[0]);const ht=st==null?void 0:st.error;if(ht&&ht.status&&ht.message){const yt=function(wt){const te=wt.toLowerCase().replace(/_/g,"-");return Object.values(Kt).indexOf(te)>=0?te:Kt.UNKNOWN}(ht.status);O(new Ce(yt,ht.message))}else O(new Ce(Kt.UNKNOWN,"Server responded with status "+L.getStatus()))}else O(new Ce(Kt.UNAVAILABLE,"Connection failed."));break;default:qe()}}finally{se(Ei,`RPC '${s}' ${g} completed.`)}});const V=JSON.stringify(_);se(Ei,`RPC '${s}' ${g} sending request:`,_),L.send(c,"POST",V,p,15)})}Bo(s,c,p){const _=sT(),g=[this.Do,"/","google.firestore.v1.Firestore","/",s,"/channel"],y=AC(),O=CC(),L={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},V=this.longPollingOptions.timeoutSeconds;V!==void 0&&(L.longPollingTimeout=Math.round(1e3*V)),this.useFetchStreams&&(L.useFetchStreams=!0),this.Oo(L.initMessageHeaders,c,p),L.encodeInitMessageHeaders=!0;const G=g.join("");se(Ei,`Creating RPC '${s}' stream ${_}: ${G}`,L);const tt=y.createWebChannel(G,L);let st=!1,ht=!1;const yt=new gG({Io:wt=>{ht?se(Ei,`Not sending because RPC '${s}' stream ${_} is closed:`,wt):(st||(se(Ei,`Opening RPC '${s}' stream ${_} transport.`),tt.open(),st=!0),se(Ei,`RPC '${s}' stream ${_} sending:`,wt),tt.send(wt))},To:()=>tt.close()}),Vt=(wt,te,Nt)=>{wt.listen(te,oe=>{try{Nt(oe)}catch(Lt){setTimeout(()=>{throw Lt},0)}})};return Vt(tt,zu.EventType.OPEN,()=>{ht||(se(Ei,`RPC '${s}' stream ${_} transport opened.`),yt.yo())}),Vt(tt,zu.EventType.CLOSE,()=>{ht||(ht=!0,se(Ei,`RPC '${s}' stream ${_} transport closed`),yt.So())}),Vt(tt,zu.EventType.ERROR,wt=>{ht||(ht=!0,Jd(Ei,`RPC '${s}' stream ${_} transport errored:`,wt),yt.So(new Ce(Kt.UNAVAILABLE,"The operation could not be completed")))}),Vt(tt,zu.EventType.MESSAGE,wt=>{var te;if(!ht){const Nt=wt.data[0];_r(!!Nt);const oe=Nt,Lt=oe.error||((te=oe[0])===null||te===void 0?void 0:te.error);if(Lt){se(Ei,`RPC '${s}' stream ${_} received error:`,Lt);const It=Lt.status;let ae=function(K){const Z=kr[K];if(Z!==void 0)return oA(Z)}(It),J=Lt.message;ae===void 0&&(ae=Kt.INTERNAL,J="Unknown error status: "+It+" with message "+Lt.message),ht=!0,yt.So(new Ce(ae,J)),tt.close()}else se(Ei,`RPC '${s}' stream ${_} received:`,Nt),yt.bo(Nt)}}),Vt(O,IC.STAT_EVENT,wt=>{wt.stat===Ng.PROXY?se(Ei,`RPC '${s}' stream ${_} detected buffering proxy`):wt.stat===Ng.NOPROXY&&se(Ei,`RPC '${s}' stream ${_} detected no buffering proxy`)}),setTimeout(()=>{yt.wo()},0),yt}}function oT(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function AA(u){return new Dj(u,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wA{constructor(s,c,p=1e3,_=1.5,g=6e4){this.ui=s,this.timerId=c,this.ko=p,this.qo=_,this.Qo=g,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(s){this.cancel();const c=Math.floor(this.Ko+this.zo()),p=Math.max(0,Date.now()-this.Uo),_=Math.max(0,c-p);_>0&&se("ExponentialBackoff",`Backing off for ${_} ms (base delay: ${this.Ko} ms, delay with jitter: ${c} ms, last attempt: ${p} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,_,()=>(this.Uo=Date.now(),s())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class SG{constructor(s,c,p,_,g,y,O,L){this.ui=s,this.Ho=p,this.Jo=_,this.connection=g,this.authCredentialsProvider=y,this.appCheckCredentialsProvider=O,this.listener=L,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new wA(s,c)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(s){this.u_(),this.stream.send(s)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(s,c){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,s!==4?this.t_.reset():c&&c.code===Kt.RESOURCE_EXHAUSTED?(Ko(c.toString()),Ko("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):c&&c.code===Kt.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=s,await this.listener.mo(c)}l_(){}auth(){this.state=1;const s=this.h_(this.Yo),c=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([p,_])=>{this.Yo===c&&this.P_(p,_)},p=>{s(()=>{const _=new Ce(Kt.UNKNOWN,"Fetching auth token failed: "+p.message);return this.I_(_)})})}P_(s,c){const p=this.h_(this.Yo);this.stream=this.T_(s,c),this.stream.Eo(()=>{p(()=>this.listener.Eo())}),this.stream.Ro(()=>{p(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(_=>{p(()=>this.I_(_))}),this.stream.onMessage(_=>{p(()=>++this.e_==1?this.E_(_):this.onNext(_))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(s){return se("PersistentStream",`close with error: ${s}`),this.stream=null,this.close(4,s)}h_(s){return c=>{this.ui.enqueueAndForget(()=>this.Yo===s?c():(se("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class vG extends SG{constructor(s,c,p,_,g,y){super(s,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",c,p,_,y),this.serializer=g}T_(s,c){return this.connection.Bo("Listen",s,c)}E_(s){return this.onNext(s)}onNext(s){this.t_.reset();const c=xj(this.serializer,s),p=function(g){if(!("targetChange"in g))return Ve.min();const y=g.targetChange;return y.targetIds&&y.targetIds.length?Ve.min():y.readTime?el(y.readTime):Ve.min()}(s);return this.listener.d_(c,p)}A_(s){const c={};c.database=mA(this.serializer),c.addTarget=function(g,y){let O;const L=y.target;if(O=Hg(L)?{documents:Vj(g,L)}:{query:Fj(g,L)._t},O.targetId=y.targetId,y.resumeToken.approximateByteSize()>0){O.resumeToken=Lj(g,y.resumeToken);const V=$g(g,y.expectedCount);V!==null&&(O.expectedCount=V)}else if(y.snapshotVersion.compareTo(Ve.min())>0){O.readTime=kj(g,y.snapshotVersion.toTimestamp());const V=$g(g,y.expectedCount);V!==null&&(O.expectedCount=V)}return O}(this.serializer,s);const p=jj(this.serializer,s);p&&(c.labels=p),this.a_(c)}R_(s){const c={};c.database=mA(this.serializer),c.removeTarget=s,this.a_(c)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yG extends class{}{constructor(s,c,p,_){super(),this.authCredentials=s,this.appCheckCredentials=c,this.connection=p,this.serializer=_,this.y_=!1}w_(){if(this.y_)throw new Ce(Kt.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(s,c,p,_){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([g,y])=>this.connection.Mo(s,Zg(c,p),_,g,y)).catch(g=>{throw g.name==="FirebaseError"?(g.code===Kt.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),g):new Ce(Kt.UNKNOWN,g.toString())})}Lo(s,c,p,_,g){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([y,O])=>this.connection.Lo(s,Zg(c,p),_,y,O,g)).catch(y=>{throw y.name==="FirebaseError"?(y.code===Kt.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),y):new Ce(Kt.UNKNOWN,y.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class RG{constructor(s,c){this.asyncQueue=s,this.onlineStateHandler=c,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(s){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${s.toString()}`),this.C_("Offline")))}set(s){this.x_(),this.S_=0,s==="Online"&&(this.D_=!1),this.C_(s)}C_(s){s!==this.state&&(this.state=s,this.onlineStateHandler(s))}F_(s){const c=`Could not reach Cloud Firestore backend. ${s}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(Ko(c),this.D_=!1):se("OnlineStateTracker",c)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class IG{constructor(s,c,p,_,g){this.localStore=s,this.datastore=c,this.asyncQueue=p,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=g,this.k_._o(y=>{p.enqueueAndForget(async()=>{dh(this)&&(se("RemoteStore","Restarting streams for network reachability change."),await async function(L){const V=un(L);V.L_.add(4),await ch(V),V.q_.set("Unknown"),V.L_.delete(4),await Df(V)}(this))})}),this.q_=new RG(p,_)}}async function Df(u){if(dh(u))for(const s of u.B_)await s(!0)}async function ch(u){for(const s of u.B_)await s(!1)}function bA(u,s){const c=un(u);c.N_.has(s.targetId)||(c.N_.set(s.targetId,s),lT(c)?dT(c):sl(c).r_()&&cT(c,s))}function aT(u,s){const c=un(u),p=sl(c);c.N_.delete(s),p.r_()&&OA(c,s),c.N_.size===0&&(p.r_()?p.o_():dh(c)&&c.q_.set("Unknown"))}function cT(u,s){if(u.Q_.xe(s.targetId),s.resumeToken.approximateByteSize()>0||s.snapshotVersion.compareTo(Ve.min())>0){const c=u.remoteSyncer.getRemoteKeysForTarget(s.targetId).size;s=s.withExpectedCount(c)}sl(u).A_(s)}function OA(u,s){u.Q_.xe(s),sl(u).R_(s)}function dT(u){u.Q_=new bj({getRemoteKeysForTarget:s=>u.remoteSyncer.getRemoteKeysForTarget(s),ot:s=>u.N_.get(s)||null,tt:()=>u.datastore.serializer.databaseId}),sl(u).start(),u.q_.v_()}function lT(u){return dh(u)&&!sl(u).n_()&&u.N_.size>0}function dh(u){return un(u).L_.size===0}function NA(u){u.Q_=void 0}async function CG(u){u.q_.set("Online")}async function AG(u){u.N_.forEach((s,c)=>{cT(u,s)})}async function wG(u,s){NA(u),lT(u)?(u.q_.M_(s),dT(u)):u.q_.set("Unknown")}async function bG(u,s,c){if(u.q_.set("Online"),s instanceof lA&&s.state===2&&s.cause)try{await async function(_,g){const y=g.cause;for(const O of g.targetIds)_.N_.has(O)&&(await _.remoteSyncer.rejectListen(O,y),_.N_.delete(O),_.Q_.removeTarget(O))}(u,s)}catch(p){se("RemoteStore","Failed to remove targets %s: %s ",s.targetIds.join(","),p),await PA(u,p)}else if(s instanceof Nf?u.Q_.Ke(s):s instanceof dA?u.Q_.He(s):u.Q_.We(s),!c.isEqual(Ve.min()))try{const p=await yA(u.localStore);c.compareTo(p)>=0&&await function(g,y){const O=g.Q_.rt(y);return O.targetChanges.forEach((L,V)=>{if(L.resumeToken.approximateByteSize()>0){const G=g.N_.get(V);G&&g.N_.set(V,G.withResumeToken(L.resumeToken,y))}}),O.targetMismatches.forEach((L,V)=>{const G=g.N_.get(L);if(!G)return;g.N_.set(L,G.withResumeToken(oi.EMPTY_BYTE_STRING,G.snapshotVersion)),OA(g,L);const tt=new Wa(G.target,L,V,G.sequenceNumber);cT(g,tt)}),g.remoteSyncer.applyRemoteEvent(O)}(u,c)}catch(p){se("RemoteStore","Failed to raise snapshot:",p),await PA(u,p)}}async function PA(u,s,c){if(!Qu(s))throw s;u.L_.add(1),await ch(u),u.q_.set("Offline"),c||(c=()=>yA(u.localStore)),u.asyncQueue.enqueueRetryable(async()=>{se("RemoteStore","Retrying IndexedDB access"),await c(),u.L_.delete(1),await Df(u)})}async function DA(u,s){const c=un(u);c.asyncQueue.verifyOperationInProgress(),se("RemoteStore","RemoteStore received new credentials");const p=dh(c);c.L_.add(3),await ch(c),p&&c.q_.set("Unknown"),await c.remoteSyncer.handleCredentialChange(s),c.L_.delete(3),await Df(c)}async function OG(u,s){const c=un(u);s?(c.L_.delete(2),await Df(c)):s||(c.L_.add(2),await ch(c),c.q_.set("Unknown"))}function sl(u){return u.K_||(u.K_=function(c,p,_){const g=un(c);return g.w_(),new vG(p,g.connection,g.authCredentials,g.appCheckCredentials,g.serializer,_)}(u.datastore,u.asyncQueue,{Eo:CG.bind(null,u),Ro:AG.bind(null,u),mo:wG.bind(null,u),d_:bG.bind(null,u)}),u.B_.push(async s=>{s?(u.K_.s_(),lT(u)?dT(u):u.q_.set("Unknown")):(await u.K_.stop(),NA(u))})),u.K_}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uT{constructor(s,c,p,_,g){this.asyncQueue=s,this.timerId=c,this.targetTimeMs=p,this.op=_,this.removalCallback=g,this.deferred=new Vc,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(y=>{})}get promise(){return this.deferred.promise}static createAndSchedule(s,c,p,_,g){const y=Date.now()+p,O=new uT(s,c,y,_,g);return O.start(p),O}start(s){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),s)}skipDelay(){return this.handleDelayElapsed()}cancel(s){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new Ce(Kt.CANCELLED,"Operation cancelled"+(s?": "+s:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(s=>this.deferred.resolve(s))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function kA(u,s){if(Ko("AsyncQueue",`${s}: ${u}`),Qu(u))return new Ce(Kt.UNAVAILABLE,`${s}: ${u}`);throw u}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ol{constructor(s){this.comparator=s?(c,p)=>s(c,p)||Ae.comparator(c.key,p.key):(c,p)=>Ae.comparator(c.key,p.key),this.keyedMap=rh(),this.sortedSet=new Ar(this.comparator)}static emptySet(s){return new ol(s.comparator)}has(s){return this.keyedMap.get(s)!=null}get(s){return this.keyedMap.get(s)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(s){const c=this.keyedMap.get(s);return c?this.sortedSet.indexOf(c):-1}get size(){return this.sortedSet.size}forEach(s){this.sortedSet.inorderTraversal((c,p)=>(s(c),!1))}add(s){const c=this.delete(s.key);return c.copy(c.keyedMap.insert(s.key,s),c.sortedSet.insert(s,null))}delete(s){const c=this.get(s);return c?this.copy(this.keyedMap.remove(s),this.sortedSet.remove(c)):this}isEqual(s){if(!(s instanceof ol)||this.size!==s.size)return!1;const c=this.sortedSet.getIterator(),p=s.sortedSet.getIterator();for(;c.hasNext();){const _=c.getNext().key,g=p.getNext().key;if(!_.isEqual(g))return!1}return!0}toString(){const s=[];return this.forEach(c=>{s.push(c.toString())}),s.length===0?"DocumentSet ()":`DocumentSet (
  `+s.join(`  
`)+`
)`}copy(s,c){const p=new ol;return p.comparator=this.comparator,p.keyedMap=s,p.sortedSet=c,p}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class LA{constructor(){this.W_=new Ar(Ae.comparator)}track(s){const c=s.doc.key,p=this.W_.get(c);p?s.type!==0&&p.type===3?this.W_=this.W_.insert(c,s):s.type===3&&p.type!==1?this.W_=this.W_.insert(c,{type:p.type,doc:s.doc}):s.type===2&&p.type===2?this.W_=this.W_.insert(c,{type:2,doc:s.doc}):s.type===2&&p.type===0?this.W_=this.W_.insert(c,{type:0,doc:s.doc}):s.type===1&&p.type===0?this.W_=this.W_.remove(c):s.type===1&&p.type===2?this.W_=this.W_.insert(c,{type:1,doc:p.doc}):s.type===0&&p.type===1?this.W_=this.W_.insert(c,{type:2,doc:s.doc}):qe():this.W_=this.W_.insert(c,s)}G_(){const s=[];return this.W_.inorderTraversal((c,p)=>{s.push(p)}),s}}class al{constructor(s,c,p,_,g,y,O,L,V){this.query=s,this.docs=c,this.oldDocs=p,this.docChanges=_,this.mutatedKeys=g,this.fromCache=y,this.syncStateChanged=O,this.excludesMetadataChanges=L,this.hasCachedResults=V}static fromInitialDocuments(s,c,p,_,g){const y=[];return c.forEach(O=>{y.push({type:0,doc:O})}),new al(s,c,ol.emptySet(c),y,p,_,!0,!1,g)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(s){if(!(this.fromCache===s.fromCache&&this.hasCachedResults===s.hasCachedResults&&this.syncStateChanged===s.syncStateChanged&&this.mutatedKeys.isEqual(s.mutatedKeys)&&yf(this.query,s.query)&&this.docs.isEqual(s.docs)&&this.oldDocs.isEqual(s.oldDocs)))return!1;const c=this.docChanges,p=s.docChanges;if(c.length!==p.length)return!1;for(let _=0;_<c.length;_++)if(c[_].type!==p[_].type||!c[_].doc.isEqual(p[_].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class NG{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(s=>s.J_())}}class PG{constructor(){this.queries=MA(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(c,p){const _=un(c),g=_.queries;_.queries=MA(),g.forEach((y,O)=>{for(const L of O.j_)L.onError(p)})})(this,new Ce(Kt.ABORTED,"Firestore shutting down"))}}function MA(){return new tl(u=>YC(u),yf)}async function DG(u,s){const c=un(u);let p=3;const _=s.query;let g=c.queries.get(_);g?!g.H_()&&s.J_()&&(p=2):(g=new NG,p=s.J_()?0:1);try{switch(p){case 0:g.z_=await c.onListen(_,!0);break;case 1:g.z_=await c.onListen(_,!1);break;case 2:await c.onFirstRemoteStoreListen(_)}}catch(y){const O=kA(y,`Initialization of query '${Zd(s.query)}' failed`);return void s.onError(O)}c.queries.set(_,g),g.j_.push(s),s.Z_(c.onlineState),g.z_&&s.X_(g.z_)&&hT(c)}async function kG(u,s){const c=un(u),p=s.query;let _=3;const g=c.queries.get(p);if(g){const y=g.j_.indexOf(s);y>=0&&(g.j_.splice(y,1),g.j_.length===0?_=s.J_()?0:1:!g.H_()&&s.J_()&&(_=2))}switch(_){case 0:return c.queries.delete(p),c.onUnlisten(p,!0);case 1:return c.queries.delete(p),c.onUnlisten(p,!1);case 2:return c.onLastRemoteStoreUnlisten(p);default:return}}function LG(u,s){const c=un(u);let p=!1;for(const _ of s){const g=_.query,y=c.queries.get(g);if(y){for(const O of y.j_)O.X_(_)&&(p=!0);y.z_=_}}p&&hT(c)}function MG(u,s,c){const p=un(u),_=p.queries.get(s);if(_)for(const g of _.j_)g.onError(c);p.queries.delete(s)}function hT(u){u.Y_.forEach(s=>{s.next()})}var pT,UA;(UA=pT||(pT={})).ea="default",UA.Cache="cache";class UG{constructor(s,c,p){this.query=s,this.ta=c,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=p||{}}X_(s){if(!this.options.includeMetadataChanges){const p=[];for(const _ of s.docChanges)_.type!==3&&p.push(_);s=new al(s.query,s.docs,s.oldDocs,p,s.mutatedKeys,s.fromCache,s.syncStateChanged,!0,s.hasCachedResults)}let c=!1;return this.na?this.ia(s)&&(this.ta.next(s),c=!0):this.sa(s,this.onlineState)&&(this.oa(s),c=!0),this.ra=s,c}onError(s){this.ta.error(s)}Z_(s){this.onlineState=s;let c=!1;return this.ra&&!this.na&&this.sa(this.ra,s)&&(this.oa(this.ra),c=!0),c}sa(s,c){if(!s.fromCache||!this.J_())return!0;const p=c!=="Offline";return(!this.options._a||!p)&&(!s.docs.isEmpty()||s.hasCachedResults||c==="Offline")}ia(s){if(s.docChanges.length>0)return!0;const c=this.ra&&this.ra.hasPendingWrites!==s.hasPendingWrites;return!(!s.syncStateChanged&&!c)&&this.options.includeMetadataChanges===!0}oa(s){s=al.fromInitialDocuments(s.query,s.docs,s.mutatedKeys,s.fromCache,s.hasCachedResults),this.na=!0,this.ta.next(s)}J_(){return this.options.source!==pT.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xA{constructor(s){this.key=s}}class VA{constructor(s){this.key=s}}class xG{constructor(s,c){this.query=s,this.Ta=c,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=En(),this.mutatedKeys=En(),this.Aa=zC(s),this.Ra=new ol(this.Aa)}get Va(){return this.Ta}ma(s,c){const p=c?c.fa:new LA,_=c?c.Ra:this.Ra;let g=c?c.mutatedKeys:this.mutatedKeys,y=_,O=!1;const L=this.query.limitType==="F"&&_.size===this.query.limit?_.last():null,V=this.query.limitType==="L"&&_.size===this.query.limit?_.first():null;if(s.inorderTraversal((G,tt)=>{const st=_.get(G),ht=Rf(this.query,tt)?tt:null,yt=!!st&&this.mutatedKeys.has(st.key),Vt=!!ht&&(ht.hasLocalMutations||this.mutatedKeys.has(ht.key)&&ht.hasCommittedMutations);let wt=!1;st&&ht?st.data.isEqual(ht.data)?yt!==Vt&&(p.track({type:3,doc:ht}),wt=!0):this.ga(st,ht)||(p.track({type:2,doc:ht}),wt=!0,(L&&this.Aa(ht,L)>0||V&&this.Aa(ht,V)<0)&&(O=!0)):!st&&ht?(p.track({type:0,doc:ht}),wt=!0):st&&!ht&&(p.track({type:1,doc:st}),wt=!0,(L||V)&&(O=!0)),wt&&(ht?(y=y.add(ht),g=Vt?g.add(G):g.delete(G)):(y=y.delete(G),g=g.delete(G)))}),this.query.limit!==null)for(;y.size>this.query.limit;){const G=this.query.limitType==="F"?y.last():y.first();y=y.delete(G.key),g=g.delete(G.key),p.track({type:1,doc:G})}return{Ra:y,fa:p,ns:O,mutatedKeys:g}}ga(s,c){return s.hasLocalMutations&&c.hasCommittedMutations&&!c.hasLocalMutations}applyChanges(s,c,p,_){const g=this.Ra;this.Ra=s.Ra,this.mutatedKeys=s.mutatedKeys;const y=s.fa.G_();y.sort((G,tt)=>function(ht,yt){const Vt=wt=>{switch(wt){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return qe()}};return Vt(ht)-Vt(yt)}(G.type,tt.type)||this.Aa(G.doc,tt.doc)),this.pa(p),_=_!=null&&_;const O=c&&!_?this.ya():[],L=this.da.size===0&&this.current&&!_?1:0,V=L!==this.Ea;return this.Ea=L,y.length!==0||V?{snapshot:new al(this.query,s.Ra,g,y,s.mutatedKeys,L===0,V,!1,!!p&&p.resumeToken.approximateByteSize()>0),wa:O}:{wa:O}}Z_(s){return this.current&&s==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new LA,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(s){return!this.Ta.has(s)&&!!this.Ra.has(s)&&!this.Ra.get(s).hasLocalMutations}pa(s){s&&(s.addedDocuments.forEach(c=>this.Ta=this.Ta.add(c)),s.modifiedDocuments.forEach(c=>{}),s.removedDocuments.forEach(c=>this.Ta=this.Ta.delete(c)),this.current=s.current)}ya(){if(!this.current)return[];const s=this.da;this.da=En(),this.Ra.forEach(p=>{this.Sa(p.key)&&(this.da=this.da.add(p.key))});const c=[];return s.forEach(p=>{this.da.has(p)||c.push(new VA(p))}),this.da.forEach(p=>{s.has(p)||c.push(new xA(p))}),c}ba(s){this.Ta=s.Ts,this.da=En();const c=this.ma(s.documents);return this.applyChanges(c,!0)}Da(){return al.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}}class VG{constructor(s,c,p){this.query=s,this.targetId=c,this.view=p}}class FG{constructor(s){this.key=s,this.va=!1}}class BG{constructor(s,c,p,_,g,y){this.localStore=s,this.remoteStore=c,this.eventManager=p,this.sharedClientState=_,this.currentUser=g,this.maxConcurrentLimboResolutions=y,this.Ca={},this.Fa=new tl(O=>YC(O),yf),this.Ma=new Map,this.xa=new Set,this.Oa=new Ar(Ae.comparator),this.Na=new Map,this.La=new eT,this.Ba={},this.ka=new Map,this.qa=il.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}}async function jG(u,s,c=!0){const p=KA(u);let _;const g=p.Fa.get(s);return g?(p.sharedClientState.addLocalQueryTarget(g.targetId),_=g.view.Da()):_=await FA(p,s,c,!0),_}async function GG(u,s){const c=KA(u);await FA(c,s,!0,!1)}async function FA(u,s,c,p){const _=await pG(u.localStore,lo(s)),g=_.targetId,y=u.sharedClientState.addLocalQueryTarget(g,c);let O;return p&&(O=await WG(u,s,g,y==="current",_.resumeToken)),u.isPrimaryClient&&c&&bA(u.remoteStore,_),O}async function WG(u,s,c,p,_){u.Ka=(tt,st,ht)=>async function(Vt,wt,te,Nt){let oe=wt.view.ma(te);oe.ns&&(oe=await RA(Vt.localStore,wt.query,!1).then(({documents:J})=>wt.view.ma(J,oe)));const Lt=Nt&&Nt.targetChanges.get(wt.targetId),It=Nt&&Nt.targetMismatches.get(wt.targetId)!=null,ae=wt.view.applyChanges(oe,Vt.isPrimaryClient,Lt,It);return WA(Vt,wt.targetId,ae.wa),ae.snapshot}(u,tt,st,ht);const g=await RA(u.localStore,s,!0),y=new xG(s,g.Ts),O=y.ma(g.documents),L=ah.createSynthesizedTargetChangeForCurrentChange(c,p&&u.onlineState!=="Offline",_),V=y.applyChanges(O,u.isPrimaryClient,L);WA(u,c,V.wa);const G=new VG(s,c,y);return u.Fa.set(s,G),u.Ma.has(c)?u.Ma.get(c).push(s):u.Ma.set(c,[s]),V.snapshot}async function HG(u,s,c){const p=un(u),_=p.Fa.get(s),g=p.Ma.get(_.targetId);if(g.length>1)return p.Ma.set(_.targetId,g.filter(y=>!yf(y,s))),void p.Fa.delete(s);p.isPrimaryClient?(p.sharedClientState.removeLocalQueryTarget(_.targetId),p.sharedClientState.isActiveQueryTarget(_.targetId)||await iT(p.localStore,_.targetId,!1).then(()=>{p.sharedClientState.clearQueryState(_.targetId),c&&aT(p.remoteStore,_.targetId),fT(p,_.targetId)}).catch(Dg)):(fT(p,_.targetId),await iT(p.localStore,_.targetId,!0))}async function KG(u,s){const c=un(u),p=c.Fa.get(s),_=c.Ma.get(p.targetId);c.isPrimaryClient&&_.length===1&&(c.sharedClientState.removeLocalQueryTarget(p.targetId),aT(c.remoteStore,p.targetId))}async function BA(u,s){const c=un(u);try{const p=await uG(c.localStore,s);s.targetChanges.forEach((_,g)=>{const y=c.Na.get(g);y&&(_r(_.addedDocuments.size+_.modifiedDocuments.size+_.removedDocuments.size<=1),_.addedDocuments.size>0?y.va=!0:_.modifiedDocuments.size>0?_r(y.va):_.removedDocuments.size>0&&(_r(y.va),y.va=!1))}),await HA(c,p,s)}catch(p){await Dg(p)}}function jA(u,s,c){const p=un(u);if(p.isPrimaryClient&&c===0||!p.isPrimaryClient&&c===1){const _=[];p.Fa.forEach((g,y)=>{const O=y.view.Z_(s);O.snapshot&&_.push(O.snapshot)}),function(y,O){const L=un(y);L.onlineState=O;let V=!1;L.queries.forEach((G,tt)=>{for(const st of tt.j_)st.Z_(O)&&(V=!0)}),V&&hT(L)}(p.eventManager,s),_.length&&p.Ca.d_(_),p.onlineState=s,p.isPrimaryClient&&p.sharedClientState.setOnlineState(s)}}async function qG(u,s,c){const p=un(u);p.sharedClientState.updateQueryState(s,"rejected",c);const _=p.Na.get(s),g=_&&_.key;if(g){let y=new Ar(Ae.comparator);y=y.insert(g,mi.newNoDocument(g,Ve.min()));const O=En().add(g),L=new Of(Ve.min(),new Map,new Ar(An),y,O);await BA(p,L),p.Oa=p.Oa.remove(g),p.Na.delete(s),_T(p)}else await iT(p.localStore,s,!1).then(()=>fT(p,s,c)).catch(Dg)}function fT(u,s,c=null){u.sharedClientState.removeLocalQueryTarget(s);for(const p of u.Ma.get(s))u.Fa.delete(p),c&&u.Ca.$a(p,c);u.Ma.delete(s),u.isPrimaryClient&&u.La.gr(s).forEach(p=>{u.La.containsKey(p)||GA(u,p)})}function GA(u,s){u.xa.delete(s.path.canonicalString());const c=u.Oa.get(s);c!==null&&(aT(u.remoteStore,c),u.Oa=u.Oa.remove(s),u.Na.delete(c),_T(u))}function WA(u,s,c){for(const p of c)p instanceof xA?(u.La.addReference(p.key,s),YG(u,p)):p instanceof VA?(se("SyncEngine","Document no longer in limbo: "+p.key),u.La.removeReference(p.key,s),u.La.containsKey(p.key)||GA(u,p.key)):qe()}function YG(u,s){const c=s.key,p=c.path.canonicalString();u.Oa.get(c)||u.xa.has(p)||(se("SyncEngine","New document in limbo: "+c),u.xa.add(p),_T(u))}function _T(u){for(;u.xa.size>0&&u.Oa.size<u.maxConcurrentLimboResolutions;){const s=u.xa.values().next().value;u.xa.delete(s);const c=new Ae(mr.fromString(s)),p=u.qa.next();u.Na.set(p,new FG(c)),u.Oa=u.Oa.insert(c,p),bA(u.remoteStore,new Wa(lo(Kg(c.path)),p,"TargetPurposeLimboResolution",kg.oe))}}async function HA(u,s,c){const p=un(u),_=[],g=[],y=[];p.Fa.isEmpty()||(p.Fa.forEach((O,L)=>{y.push(p.Ka(L,s,c).then(V=>{var G;if((V||c)&&p.isPrimaryClient){const tt=V?!V.fromCache:(G=c==null?void 0:c.targetChanges.get(L.targetId))===null||G===void 0?void 0:G.current;p.sharedClientState.updateQueryState(L.targetId,tt?"current":"not-current")}if(V){_.push(V);const tt=rT.Wi(L.targetId,V);g.push(tt)}}))}),await Promise.all(y),p.Ca.d_(_),await async function(L,V){const G=un(L);try{await G.persistence.runTransaction("notifyLocalViewChanges","readwrite",tt=>Dt.forEach(V,st=>Dt.forEach(st.$i,ht=>G.persistence.referenceDelegate.addReference(tt,st.targetId,ht)).next(()=>Dt.forEach(st.Ui,ht=>G.persistence.referenceDelegate.removeReference(tt,st.targetId,ht)))))}catch(tt){if(!Qu(tt))throw tt;se("LocalStore","Failed to update sequence numbers: "+tt)}for(const tt of V){const st=tt.targetId;if(!tt.fromCache){const ht=G.os.get(st),yt=ht.snapshotVersion,Vt=ht.withLastLimboFreeSnapshotVersion(yt);G.os=G.os.insert(st,Vt)}}}(p.localStore,g))}async function zG(u,s){const c=un(u);if(!c.currentUser.isEqual(s)){se("SyncEngine","User change. New user:",s.toKey());const p=await vA(c.localStore,s);c.currentUser=s,function(g,y){g.ka.forEach(O=>{O.forEach(L=>{L.reject(new Ce(Kt.CANCELLED,y))})}),g.ka.clear()}(c,"'waitForPendingWrites' promise is rejected due to a user change."),c.sharedClientState.handleUserChange(s,p.removedBatchIds,p.addedBatchIds),await HA(c,p.hs)}}function JG(u,s){const c=un(u),p=c.Na.get(s);if(p&&p.va)return En().add(p.key);{let _=En();const g=c.Ma.get(s);if(!g)return _;for(const y of g){const O=c.Fa.get(y);_=_.unionWith(O.view.Va)}return _}}function KA(u){const s=un(u);return s.remoteStore.remoteSyncer.applyRemoteEvent=BA.bind(null,s),s.remoteStore.remoteSyncer.getRemoteKeysForTarget=JG.bind(null,s),s.remoteStore.remoteSyncer.rejectListen=qG.bind(null,s),s.Ca.d_=LG.bind(null,s.eventManager),s.Ca.$a=MG.bind(null,s.eventManager),s}class kf{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(s){this.serializer=AA(s.databaseInfo.databaseId),this.sharedClientState=this.Wa(s),this.persistence=this.Ga(s),await this.persistence.start(),this.localStore=this.za(s),this.gcScheduler=this.ja(s,this.localStore),this.indexBackfillerScheduler=this.Ha(s,this.localStore)}ja(s,c){return null}Ha(s,c){return null}za(s){return lG(this.persistence,new cG,s.initialUser,this.serializer)}Ga(s){return new sG(nT.Zr,this.serializer)}Wa(s){return new _G}async terminate(){var s,c;(s=this.gcScheduler)===null||s===void 0||s.stop(),(c=this.indexBackfillerScheduler)===null||c===void 0||c.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}kf.provider={build:()=>new kf};class mT{async initialize(s,c){this.localStore||(this.localStore=s.localStore,this.sharedClientState=s.sharedClientState,this.datastore=this.createDatastore(c),this.remoteStore=this.createRemoteStore(c),this.eventManager=this.createEventManager(c),this.syncEngine=this.createSyncEngine(c,!s.synchronizeTabs),this.sharedClientState.onlineStateHandler=p=>jA(this.syncEngine,p,1),this.remoteStore.remoteSyncer.handleCredentialChange=zG.bind(null,this.syncEngine),await OG(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(s){return function(){return new PG}()}createDatastore(s){const c=AA(s.databaseInfo.databaseId),p=function(g){return new TG(g)}(s.databaseInfo);return function(g,y,O,L){return new yG(g,y,O,L)}(s.authCredentials,s.appCheckCredentials,p,c)}createRemoteStore(s){return function(p,_,g,y,O){return new IG(p,_,g,y,O)}(this.localStore,this.datastore,s.asyncQueue,c=>jA(this.syncEngine,c,0),function(){return CA.D()?new CA:new mG}())}createSyncEngine(s,c){return function(_,g,y,O,L,V,G){const tt=new BG(_,g,y,O,L,V);return G&&(tt.Qa=!0),tt}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,s.initialUser,s.maxConcurrentLimboResolutions,c)}async terminate(){var s,c;await async function(_){const g=un(_);se("RemoteStore","RemoteStore shutting down."),g.L_.add(5),await ch(g),g.k_.shutdown(),g.q_.set("Unknown")}(this.remoteStore),(s=this.datastore)===null||s===void 0||s.terminate(),(c=this.eventManager)===null||c===void 0||c.terminate()}}mT.provider={build:()=>new mT};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class XG{constructor(s){this.observer=s,this.muted=!1}next(s){this.muted||this.observer.next&&this.Ya(this.observer.next,s)}error(s){this.muted||(this.observer.error?this.Ya(this.observer.error,s):Ko("Uncaught Error in snapshot listener:",s.toString()))}Za(){this.muted=!0}Ya(s,c){setTimeout(()=>{this.muted||s(c)},0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QG{constructor(s,c,p,_,g){this.authCredentials=s,this.appCheckCredentials=c,this.asyncQueue=p,this.databaseInfo=_,this.user=_i.UNAUTHENTICATED,this.clientId=OC.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=g,this.authCredentials.start(p,async y=>{se("FirestoreClient","Received user=",y.uid),await this.authCredentialListener(y),this.user=y}),this.appCheckCredentials.start(p,y=>(se("FirestoreClient","Received new app check token=",y),this.appCheckCredentialListener(y,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(s){this.authCredentialListener=s}setAppCheckTokenChangeListener(s){this.appCheckCredentialListener=s}terminate(){this.asyncQueue.enterRestrictedMode();const s=new Vc;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),s.resolve()}catch(c){const p=kA(c,"Failed to shutdown persistence");s.reject(p)}}),s.promise}}async function ET(u,s){u.asyncQueue.verifyOperationInProgress(),se("FirestoreClient","Initializing OfflineComponentProvider");const c=u.configuration;await s.initialize(c);let p=c.initialUser;u.setCredentialChangeListener(async _=>{p.isEqual(_)||(await vA(s.localStore,_),p=_)}),s.persistence.setDatabaseDeletedListener(()=>u.terminate()),u._offlineComponents=s}async function qA(u,s){u.asyncQueue.verifyOperationInProgress();const c=await $G(u);se("FirestoreClient","Initializing OnlineComponentProvider"),await s.initialize(c,u.configuration),u.setCredentialChangeListener(p=>DA(s.remoteStore,p)),u.setAppCheckTokenChangeListener((p,_)=>DA(s.remoteStore,_)),u._onlineComponents=s}async function $G(u){if(!u._offlineComponents)if(u._uninitializedComponentsProvider){se("FirestoreClient","Using user provided OfflineComponentProvider");try{await ET(u,u._uninitializedComponentsProvider._offline)}catch(s){const c=s;if(!function(_){return _.name==="FirebaseError"?_.code===Kt.FAILED_PRECONDITION||_.code===Kt.UNIMPLEMENTED:!(typeof DOMException<"u"&&_ instanceof DOMException)||_.code===22||_.code===20||_.code===11}(c))throw c;Jd("Error using user provided cache. Falling back to memory cache: "+c),await ET(u,new kf)}}else se("FirestoreClient","Using default OfflineComponentProvider"),await ET(u,new kf);return u._offlineComponents}async function ZG(u){return u._onlineComponents||(u._uninitializedComponentsProvider?(se("FirestoreClient","Using user provided OnlineComponentProvider"),await qA(u,u._uninitializedComponentsProvider._online)):(se("FirestoreClient","Using default OnlineComponentProvider"),await qA(u,new mT))),u._onlineComponents}async function t4(u){const s=await ZG(u),c=s.eventManager;return c.onListen=jG.bind(null,s.syncEngine),c.onUnlisten=HG.bind(null,s.syncEngine),c.onFirstRemoteStoreListen=GG.bind(null,s.syncEngine),c.onLastRemoteStoreUnlisten=KG.bind(null,s.syncEngine),c}function e4(u,s,c={}){const p=new Vc;return u.asyncQueue.enqueueAndForget(async()=>function(g,y,O,L,V){const G=new XG({next:st=>{G.Za(),y.enqueueAndForget(()=>kG(g,tt));const ht=st.docs.has(O);!ht&&st.fromCache?V.reject(new Ce(Kt.UNAVAILABLE,"Failed to get document because the client is offline.")):ht&&st.fromCache&&L&&L.source==="server"?V.reject(new Ce(Kt.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):V.resolve(st)},error:st=>V.reject(st)}),tt=new UG(Kg(O.path),G,{includeMetadataChanges:!0,_a:!0});return DG(g,tt)}(await t4(u),u.asyncQueue,s,c,p)),p.promise}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function YA(u){const s={};return u.timeoutSeconds!==void 0&&(s.timeoutSeconds=u.timeoutSeconds),s}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zA=new Map;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function n4(u,s,c){if(!c)throw new Ce(Kt.INVALID_ARGUMENT,`Function ${u}() cannot be called with an empty ${s}.`)}function r4(u,s,c,p){if(s===!0&&p===!0)throw new Ce(Kt.INVALID_ARGUMENT,`${u} and ${c} cannot be used together.`)}function JA(u){if(!Ae.isDocumentKey(u))throw new Ce(Kt.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${u} has ${u.length}.`)}function i4(u){if(u===void 0)return"undefined";if(u===null)return"null";if(typeof u=="string")return u.length>20&&(u=`${u.substring(0,20)}...`),JSON.stringify(u);if(typeof u=="number"||typeof u=="boolean")return""+u;if(typeof u=="object"){if(u instanceof Array)return"an array";{const s=function(p){return p.constructor?p.constructor.name:null}(u);return s?`a custom ${s} object`:"an object"}}return typeof u=="function"?"a function":qe()}function gT(u,s){if("_delegate"in u&&(u=u._delegate),!(u instanceof s)){if(s.name===u.constructor.name)throw new Ce(Kt.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const c=i4(u);throw new Ce(Kt.INVALID_ARGUMENT,`Expected type '${s.name}', but it was: ${c}`)}}return u}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class XA{constructor(s){var c,p;if(s.host===void 0){if(s.ssl!==void 0)throw new Ce(Kt.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=s.host,this.ssl=(c=s.ssl)===null||c===void 0||c;if(this.credentials=s.credentials,this.ignoreUndefinedProperties=!!s.ignoreUndefinedProperties,this.localCache=s.localCache,s.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(s.cacheSizeBytes!==-1&&s.cacheSizeBytes<1048576)throw new Ce(Kt.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=s.cacheSizeBytes}r4("experimentalForceLongPolling",s.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",s.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!s.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:s.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!s.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=YA((p=s.experimentalLongPollingOptions)!==null&&p!==void 0?p:{}),function(g){if(g.timeoutSeconds!==void 0){if(isNaN(g.timeoutSeconds))throw new Ce(Kt.INVALID_ARGUMENT,`invalid long polling timeout: ${g.timeoutSeconds} (must not be NaN)`);if(g.timeoutSeconds<5)throw new Ce(Kt.INVALID_ARGUMENT,`invalid long polling timeout: ${g.timeoutSeconds} (minimum allowed value is 5)`);if(g.timeoutSeconds>30)throw new Ce(Kt.INVALID_ARGUMENT,`invalid long polling timeout: ${g.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!s.useFetchStreams}isEqual(s){return this.host===s.host&&this.ssl===s.ssl&&this.credentials===s.credentials&&this.cacheSizeBytes===s.cacheSizeBytes&&this.experimentalForceLongPolling===s.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===s.experimentalAutoDetectLongPolling&&function(p,_){return p.timeoutSeconds===_.timeoutSeconds}(this.experimentalLongPollingOptions,s.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===s.ignoreUndefinedProperties&&this.useFetchStreams===s.useFetchStreams}}class TT{constructor(s,c,p,_){this._authCredentials=s,this._appCheckCredentials=c,this._databaseId=p,this._app=_,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new XA({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new Ce(Kt.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(s){if(this._settingsFrozen)throw new Ce(Kt.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new XA(s),s.credentials!==void 0&&(this._authCredentials=function(p){if(!p)return new OB;switch(p.type){case"firstParty":return new kB(p.sessionIndex||"0",p.iamToken||null,p.authTokenFactory||null);case"provider":return p.client;default:throw new Ce(Kt.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(s.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(c){const p=zA.get(c);p&&(se("ComponentProvider","Removing Datastore"),zA.delete(c),p.terminate())}(this),Promise.resolve()}}function s4(u,s,c,p={}){var _;const g=(u=gT(u,TT))._getSettings(),y=`${s}:${c}`;if(g.host!=="firestore.googleapis.com"&&g.host!==y&&Jd("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),u._setSettings(Object.assign(Object.assign({},g),{host:y,ssl:!1})),p.mockUserToken){let O,L;if(typeof p.mockUserToken=="string")O=p.mockUserToken,L=_i.MOCK_USER;else{O=sF(p.mockUserToken,(_=u._app)===null||_===void 0?void 0:_.options.projectId);const V=p.mockUserToken.sub||p.mockUserToken.user_id;if(!V)throw new Ce(Kt.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");L=new _i(V)}u._authCredentials=new NB(new bC(O,L))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ST{constructor(s,c,p){this.converter=c,this._query=p,this.type="query",this.firestore=s}withConverter(s){return new ST(this.firestore,s,this._query)}}class qo{constructor(s,c,p){this.converter=c,this._key=p,this.type="document",this.firestore=s}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lh(this.firestore,this.converter,this._key.path.popLast())}withConverter(s){return new qo(this.firestore,s,this._key)}}class lh extends ST{constructor(s,c,p){super(s,c,Kg(p)),this._path=p,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const s=this._path.popLast();return s.isEmpty()?null:new qo(this.firestore,null,new Ae(s))}withConverter(s){return new lh(this.firestore,s,this._path)}}function o4(u,s,...c){if(u=kc(u),arguments.length===1&&(s=OC.newId()),n4("doc","path",s),u instanceof TT){const p=mr.fromString(s,...c);return JA(p),new qo(u,null,new Ae(p))}{if(!(u instanceof qo||u instanceof lh))throw new Ce(Kt.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const p=u._path.child(mr.fromString(s,...c));return JA(p),new qo(u.firestore,u instanceof lh?u.converter:null,new Ae(p))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QA{constructor(s=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new wA(this,"async_queue_retry"),this.Vu=()=>{const p=oT();p&&se("AsyncQueue","Visibility state changed to "+p.visibilityState),this.t_.jo()},this.mu=s;const c=oT();c&&typeof c.addEventListener=="function"&&c.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(s){this.enqueue(s)}enqueueAndForgetEvenWhileRestricted(s){this.fu(),this.gu(s)}enterRestrictedMode(s){if(!this.Iu){this.Iu=!0,this.Au=s||!1;const c=oT();c&&typeof c.removeEventListener=="function"&&c.removeEventListener("visibilitychange",this.Vu)}}enqueue(s){if(this.fu(),this.Iu)return new Promise(()=>{});const c=new Vc;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(s().then(c.resolve,c.reject),c.promise)).then(()=>c.promise)}enqueueRetryable(s){this.enqueueAndForget(()=>(this.Pu.push(s),this.pu()))}async pu(){if(this.Pu.length!==0){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(s){if(!Qu(s))throw s;se("AsyncQueue","Operation failed with retryable error: "+s)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(s){const c=this.mu.then(()=>(this.du=!0,s().catch(p=>{this.Eu=p,this.du=!1;const _=function(y){let O=y.message||"";return y.stack&&(O=y.stack.includes(y.message)?y.stack:y.message+`
`+y.stack),O}(p);throw Ko("INTERNAL UNHANDLED ERROR: ",_),p}).then(p=>(this.du=!1,p))));return this.mu=c,c}enqueueAfterDelay(s,c,p){this.fu(),this.Ru.indexOf(s)>-1&&(c=0);const _=uT.createAndSchedule(this,s,c,p,g=>this.yu(g));return this.Tu.push(_),_}fu(){this.Eu&&qe()}verifyOperationInProgress(){}async wu(){let s;do s=this.mu,await s;while(s!==this.mu)}Su(s){for(const c of this.Tu)if(c.timerId===s)return!0;return!1}bu(s){return this.wu().then(()=>{this.Tu.sort((c,p)=>c.targetTimeMs-p.targetTimeMs);for(const c of this.Tu)if(c.skipDelay(),s!=="all"&&c.timerId===s)break;return this.wu()})}Du(s){this.Ru.push(s)}yu(s){const c=this.Tu.indexOf(s);this.Tu.splice(c,1)}}class $A extends TT{constructor(s,c,p,_){super(s,c,p,_),this.type="firestore",this._queue=new QA,this._persistenceKey=(_==null?void 0:_.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const s=this._firestoreClient.terminate();this._queue=new QA(s),this._firestoreClient=void 0,await s}}}function a4(u,s){const c=typeof u=="object"?u:fC(),p=typeof u=="string"?u:"(default)",_=bg(c,"firestore").getImmediate({identifier:p});if(!_._initialized){const g=rF("firestore");g&&s4(_,...g)}return _}function c4(u){if(u._terminated)throw new Ce(Kt.FAILED_PRECONDITION,"The client has already been terminated.");return u._firestoreClient||d4(u),u._firestoreClient}function d4(u){var s,c,p;const _=u._freezeSettings(),g=function(O,L,V,G){return new qB(O,L,V,G.host,G.ssl,G.experimentalForceLongPolling,G.experimentalAutoDetectLongPolling,YA(G.experimentalLongPollingOptions),G.useFetchStreams)}(u._databaseId,((s=u._app)===null||s===void 0?void 0:s.options.appId)||"",u._persistenceKey,_);u._componentsProvider||!((c=_.localCache)===null||c===void 0)&&c._offlineComponentProvider&&(!((p=_.localCache)===null||p===void 0)&&p._onlineComponentProvider)&&(u._componentsProvider={_offline:_.localCache._offlineComponentProvider,_online:_.localCache._onlineComponentProvider}),u._firestoreClient=new QG(u._authCredentials,u._appCheckCredentials,u._queue,g,u._componentsProvider&&function(O){const L=O==null?void 0:O._online.build();return{_offline:O==null?void 0:O._offline.build(L),_online:L}}(u._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lf{constructor(s){this._byteString=s}static fromBase64String(s){try{return new Lf(oi.fromBase64String(s))}catch(c){throw new Ce(Kt.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+c)}}static fromUint8Array(s){return new Lf(oi.fromUint8Array(s))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(s){return this._byteString.isEqual(s._byteString)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ZA{constructor(...s){for(let c=0;c<s.length;++c)if(s[c].length===0)throw new Ce(Kt.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new wi(s)}isEqual(s){return this._internalPath.isEqual(s._internalPath)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class l4{constructor(s,c){if(!isFinite(s)||s<-90||s>90)throw new Ce(Kt.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+s);if(!isFinite(c)||c<-180||c>180)throw new Ce(Kt.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+c);this._lat=s,this._long=c}get latitude(){return this._lat}get longitude(){return this._long}isEqual(s){return this._lat===s._lat&&this._long===s._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(s){return An(this._lat,s._lat)||An(this._long,s._long)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class u4{constructor(s){this._values=(s||[]).map(c=>c)}toArray(){return this._values.map(s=>s)}isEqual(s){return function(p,_){if(p.length!==_.length)return!1;for(let g=0;g<p.length;++g)if(p[g]!==_[g])return!1;return!0}(this._values,s._values)}}const h4=new RegExp("[~\\*/\\[\\]]");function p4(u,s,c){if(s.search(h4)>=0)throw tw(`Invalid field path (${s}). Paths must not contain '~', '*', '/', '[', or ']'`,u);try{return new ZA(...s.split("."))._internalPath}catch{throw tw(`Invalid field path (${s}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,u)}}function tw(u,s,c,p,_){let g=`Function ${s}() called with invalid data`;g+=". ";let y="";return new Ce(Kt.INVALID_ARGUMENT,g+u+y)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ew{constructor(s,c,p,_,g){this._firestore=s,this._userDataWriter=c,this._key=p,this._document=_,this._converter=g}get id(){return this._key.path.lastSegment()}get ref(){return new qo(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const s=new f4(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(s)}return this._userDataWriter.convertValue(this._document.data.value)}}get(s){if(this._document){const c=this._document.data.field(nw("DocumentSnapshot.get",s));if(c!==null)return this._userDataWriter.convertValue(c)}}}class f4 extends ew{data(){return super.data()}}function nw(u,s){return typeof s=="string"?p4(u,s):s instanceof ZA?s._internalPath:s._delegate._internalPath}class _4{convertValue(s,c="none"){switch(Bc(s)){case 0:return null;case 1:return s.booleanValue;case 2:return wr(s.integerValue||s.doubleValue);case 3:return this.convertTimestamp(s.timestampValue);case 4:return this.convertServerTimestamp(s,c);case 5:return s.stringValue;case 6:return this.convertBytes(Fc(s.bytesValue));case 7:return this.convertReference(s.referenceValue);case 8:return this.convertGeoPoint(s.geoPointValue);case 9:return this.convertArray(s.arrayValue,c);case 11:return this.convertObject(s.mapValue,c);case 10:return this.convertVectorValue(s.mapValue);default:throw qe()}}convertObject(s,c){return this.convertObjectMap(s.fields,c)}convertObjectMap(s,c="none"){const p={};return mf(s,(_,g)=>{p[_]=this.convertValue(g,c)}),p}convertVectorValue(s){var c,p,_;const g=(_=(p=(c=s.fields)===null||c===void 0?void 0:c.value.arrayValue)===null||p===void 0?void 0:p.values)===null||_===void 0?void 0:_.map(y=>wr(y.doubleValue));return new u4(g)}convertGeoPoint(s){return new l4(wr(s.latitude),wr(s.longitude))}convertArray(s,c){return(s.values||[]).map(p=>this.convertValue(p,c))}convertServerTimestamp(s,c){switch(c){case"previous":const p=Ug(s);return p==null?null:this.convertValue(p,c);case"estimate":return this.convertTimestamp($u(s));default:return null}}convertTimestamp(s){const c=ja(s);return new Ui(c.seconds,c.nanos)}convertDocumentKey(s,c){const p=mr.fromString(s);_r(SA(p));const _=new Zu(p.get(1),p.get(3)),g=new Ae(p.popFirst(5));return _.isEqual(c)||Ko(`Document ${g} contains a document reference within a different database (${_.projectId}/${_.database}) which is not supported. It will be treated as a reference in the current database (${c.projectId}/${c.database}) instead.`),g}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class m4{constructor(s,c){this.hasPendingWrites=s,this.fromCache=c}isEqual(s){return this.hasPendingWrites===s.hasPendingWrites&&this.fromCache===s.fromCache}}class rw extends ew{constructor(s,c,p,_,g,y){super(s,c,p,_,y),this._firestore=s,this._firestoreImpl=s,this.metadata=g}exists(){return super.exists()}data(s={}){if(this._document){if(this._converter){const c=new E4(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(c,s)}return this._userDataWriter.convertValue(this._document.data.value,s.serverTimestamps)}}get(s,c={}){if(this._document){const p=this._document.data.field(nw("DocumentSnapshot.get",s));if(p!==null)return this._userDataWriter.convertValue(p,c.serverTimestamps)}}}class E4 extends rw{data(s={}){return super.data(s)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function g4(u){u=gT(u,qo);const s=gT(u.firestore,$A);return e4(c4(s),u._key).then(c=>S4(s,u,c))}class T4 extends _4{constructor(s){super(),this.firestore=s}convertBytes(s){return new Lf(s)}convertReference(s){const c=this.convertDocumentKey(s,this.firestore._databaseId);return new qo(this.firestore,null,c)}}function S4(u,s,c){const p=c.docs.get(s._key),_=new T4(u);return new rw(u,_,s._key,p,new m4(c.hasPendingWrites,c.fromCache),s.converter)}(function(s,c=!0){(function(_){zd=_})(Yd),qd(new Lc("firestore",(p,{instanceIdentifier:_,options:g})=>{const y=p.getProvider("app").getImmediate(),O=new $A(new PB(p.getProvider("auth-internal")),new MB(p.getProvider("app-check-internal")),function(V,G){if(!Object.prototype.hasOwnProperty.apply(V.options,["projectId"]))throw new Ce(Kt.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Zu(V.options.projectId,G)}(y,_),y);return g=Object.assign({useFetchStreams:c},g),O._setSettings(g),O},"PUBLIC").setMultipleInstances(!0)),Va(wC,"4.7.3",s),Va(wC,"4.7.3","esm2017")})();function vT(u,s){var c={};for(var p in u)Object.prototype.hasOwnProperty.call(u,p)&&s.indexOf(p)<0&&(c[p]=u[p]);if(u!=null&&typeof Object.getOwnPropertySymbols=="function")for(var _=0,p=Object.getOwnPropertySymbols(u);_<p.length;_++)s.indexOf(p[_])<0&&Object.prototype.propertyIsEnumerable.call(u,p[_])&&(c[p[_]]=u[p[_]]);return c}typeof SuppressedError=="function"&&SuppressedError;function iw(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}const v4=iw,sw=new Ku("auth","Firebase",iw());/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mf=new gg("@firebase/auth");function y4(u,...s){Mf.logLevel<=on.WARN&&Mf.warn(`Auth (${Yd}): ${u}`,...s)}function Uf(u,...s){Mf.logLevel<=on.ERROR&&Mf.error(`Auth (${Yd}): ${u}`,...s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yo(u,...s){throw yT(u,...s)}function uo(u,...s){return yT(u,...s)}function ow(u,s,c){const p=Object.assign(Object.assign({},v4()),{[s]:c});return new Ku("auth","Firebase",p).create(s,{appName:u.name})}function Wc(u){return ow(u,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function yT(u,...s){if(typeof u!="string"){const c=s[0],p=[...s.slice(1)];return p[0]&&(p[0].appName=u.name),u._errorFactory.create(c,...p)}return sw.create(u,...s)}function De(u,s,...c){if(!u)throw yT(s,...c)}function zo(u){const s="INTERNAL ASSERTION FAILED: "+u;throw Uf(s),new Error(s)}function Jo(u,s){u||zo(s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function RT(){var u;return typeof self<"u"&&((u=self.location)===null||u===void 0?void 0:u.href)||""}function R4(){return aw()==="http:"||aw()==="https:"}function aw(){var u;return typeof self<"u"&&((u=self.location)===null||u===void 0?void 0:u.protocol)||null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function I4(){return typeof navigator<"u"&&navigator&&"onLine"in navigator&&typeof navigator.onLine=="boolean"&&(R4()||dF()||"connection"in navigator)?navigator.onLine:!0}function C4(){if(typeof navigator>"u")return null;const u=navigator;return u.languages&&u.languages[0]||u.language||null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uh{constructor(s,c){this.shortDelay=s,this.longDelay=c,Jo(c>s,"Short delay should be less than long delay!"),this.isMobile=oF()||lF()}get(){return I4()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function IT(u,s){Jo(u.emulator,"Emulator should always be set here");const{url:c}=u.emulator;return s?`${c}${s.startsWith("/")?s.slice(1):s}`:c}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class cw{static initialize(s,c,p){this.fetchImpl=s,c&&(this.headersImpl=c),p&&(this.responseImpl=p)}static fetch(){if(this.fetchImpl)return this.fetchImpl;if(typeof self<"u"&&"fetch"in self)return self.fetch;if(typeof globalThis<"u"&&globalThis.fetch)return globalThis.fetch;if(typeof fetch<"u")return fetch;zo("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){if(this.headersImpl)return this.headersImpl;if(typeof self<"u"&&"Headers"in self)return self.Headers;if(typeof globalThis<"u"&&globalThis.Headers)return globalThis.Headers;if(typeof Headers<"u")return Headers;zo("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){if(this.responseImpl)return this.responseImpl;if(typeof self<"u"&&"Response"in self)return self.Response;if(typeof globalThis<"u"&&globalThis.Response)return globalThis.Response;if(typeof Response<"u")return Response;zo("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const A4={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const w4=new uh(3e4,6e4);function CT(u,s){return u.tenantId&&!s.tenantId?Object.assign(Object.assign({},s),{tenantId:u.tenantId}):s}async function cl(u,s,c,p,_={}){return dw(u,_,async()=>{let g={},y={};p&&(s==="GET"?y=p:g={body:JSON.stringify(p)});const O=qu(Object.assign({key:u.config.apiKey},y)).slice(1),L=await u._getAdditionalHeaders();L["Content-Type"]="application/json",u.languageCode&&(L["X-Firebase-Locale"]=u.languageCode);const V=Object.assign({method:s,headers:L},g);return cF()||(V.referrerPolicy="no-referrer"),cw.fetch()(lw(u,u.config.apiHost,c,O),V)})}async function dw(u,s,c){u._canInitEmulator=!1;const p=Object.assign(Object.assign({},A4),s);try{const _=new O4(u),g=await Promise.race([c(),_.promise]);_.clearNetworkTimeout();const y=await g.json();if("needConfirmation"in y)throw xf(u,"account-exists-with-different-credential",y);if(g.ok&&!("errorMessage"in y))return y;{const O=g.ok?y.errorMessage:y.error.message,[L,V]=O.split(" : ");if(L==="FEDERATED_USER_ID_ALREADY_LINKED")throw xf(u,"credential-already-in-use",y);if(L==="EMAIL_EXISTS")throw xf(u,"email-already-in-use",y);if(L==="USER_DISABLED")throw xf(u,"user-disabled",y);const G=p[L]||L.toLowerCase().replace(/[_\s]+/g,"-");if(V)throw ow(u,G,V);Yo(u,G)}}catch(_){if(_ instanceof Wo)throw _;Yo(u,"network-request-failed",{message:String(_)})}}async function b4(u,s,c,p,_={}){const g=await cl(u,s,c,p,_);return"mfaPendingCredential"in g&&Yo(u,"multi-factor-auth-required",{_serverResponse:g}),g}function lw(u,s,c,p){const _=`${s}${c}?${p}`;return u.config.emulator?IT(u.config,_):`${u.config.apiScheme}://${_}`}class O4{constructor(s){this.auth=s,this.timer=null,this.promise=new Promise((c,p)=>{this.timer=setTimeout(()=>p(uo(this.auth,"network-request-failed")),w4.get())})}clearNetworkTimeout(){clearTimeout(this.timer)}}function xf(u,s,c){const p={appName:u.name};c.email&&(p.email=c.email),c.phoneNumber&&(p.phoneNumber=c.phoneNumber);const _=uo(u,s,p);return _.customData._tokenResponse=c,_}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function N4(u,s){return cl(u,"POST","/v1/accounts:delete",s)}async function uw(u,s){return cl(u,"POST","/v1/accounts:lookup",s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hh(u){if(u)try{const s=new Date(Number(u));if(!isNaN(s.getTime()))return s.toUTCString()}catch{}}async function P4(u,s=!1){const c=kc(u),p=await c.getIdToken(s),_=wT(p);De(_&&_.exp&&_.auth_time&&_.iat,c.auth,"internal-error");const g=typeof _.firebase=="object"?_.firebase:void 0,y=g==null?void 0:g.sign_in_provider;return{claims:_,token:p,authTime:hh(AT(_.auth_time)),issuedAtTime:hh(AT(_.iat)),expirationTime:hh(AT(_.exp)),signInProvider:y||null,signInSecondFactor:(g==null?void 0:g.sign_in_second_factor)||null}}function AT(u){return Number(u)*1e3}function wT(u){const[s,c,p]=u.split(".");if(s===void 0||c===void 0||p===void 0)return Uf("JWT malformed, contained fewer than 3 sections"),null;try{const _=eC(c);return _?JSON.parse(_):(Uf("Failed to decode base64 JWT payload"),null)}catch(_){return Uf("Caught error parsing JWT payload as JSON",_==null?void 0:_.toString()),null}}function hw(u){const s=wT(u);return De(s,"internal-error"),De(typeof s.exp<"u","internal-error"),De(typeof s.iat<"u","internal-error"),Number(s.exp)-Number(s.iat)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ph(u,s,c=!1){if(c)return s;try{return await s}catch(p){throw p instanceof Wo&&D4(p)&&u.auth.currentUser===u&&await u.auth.signOut(),p}}function D4({code:u}){return u==="auth/user-disabled"||u==="auth/user-token-expired"}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class k4{constructor(s){this.user=s,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,this.timerId!==null&&clearTimeout(this.timerId))}getInterval(s){var c;if(s){const p=this.errorBackoff;return this.errorBackoff=Math.min(this.errorBackoff*2,96e4),p}else{this.errorBackoff=3e4;const _=((c=this.user.stsTokenManager.expirationTime)!==null&&c!==void 0?c:0)-Date.now()-3e5;return Math.max(0,_)}}schedule(s=!1){if(!this.isRunning)return;const c=this.getInterval(s);this.timerId=setTimeout(async()=>{await this.iteration()},c)}async iteration(){try{await this.user.getIdToken(!0)}catch(s){(s==null?void 0:s.code)==="auth/network-request-failed"&&this.schedule(!0);return}this.schedule()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bT{constructor(s,c){this.createdAt=s,this.lastLoginAt=c,this._initializeTime()}_initializeTime(){this.lastSignInTime=hh(this.lastLoginAt),this.creationTime=hh(this.createdAt)}_copy(s){this.createdAt=s.createdAt,this.lastLoginAt=s.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Vf(u){var s;const c=u.auth,p=await u.getIdToken(),_=await ph(u,uw(c,{idToken:p}));De(_==null?void 0:_.users.length,c,"internal-error");const g=_.users[0];u._notifyReloadListener(g);const y=!((s=g.providerUserInfo)===null||s===void 0)&&s.length?pw(g.providerUserInfo):[],O=M4(u.providerData,y),L=u.isAnonymous,V=!(u.email&&g.passwordHash)&&!(O!=null&&O.length),G=L?V:!1,tt={uid:g.localId,displayName:g.displayName||null,photoURL:g.photoUrl||null,email:g.email||null,emailVerified:g.emailVerified||!1,phoneNumber:g.phoneNumber||null,tenantId:g.tenantId||null,providerData:O,metadata:new bT(g.createdAt,g.lastLoginAt),isAnonymous:G};Object.assign(u,tt)}async function L4(u){const s=kc(u);await Vf(s),await s.auth._persistUserIfCurrent(s),s.auth._notifyListenersIfCurrent(s)}function M4(u,s){return[...u.filter(p=>!s.some(_=>_.providerId===p.providerId)),...s]}function pw(u){return u.map(s=>{var{providerId:c}=s,p=vT(s,["providerId"]);return{providerId:c,uid:p.rawId||"",displayName:p.displayName||null,email:p.email||null,phoneNumber:p.phoneNumber||null,photoURL:p.photoUrl||null}})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function U4(u,s){const c=await dw(u,{},async()=>{const p=qu({grant_type:"refresh_token",refresh_token:s}).slice(1),{tokenApiHost:_,apiKey:g}=u.config,y=lw(u,_,"/v1/token",`key=${g}`),O=await u._getAdditionalHeaders();return O["Content-Type"]="application/x-www-form-urlencoded",cw.fetch()(y,{method:"POST",headers:O,body:p})});return{accessToken:c.access_token,expiresIn:c.expires_in,refreshToken:c.refresh_token}}async function x4(u,s){return cl(u,"POST","/v2/accounts:revokeToken",CT(u,s))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dl{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(s){De(s.idToken,"internal-error"),De(typeof s.idToken<"u","internal-error"),De(typeof s.refreshToken<"u","internal-error");const c="expiresIn"in s&&typeof s.expiresIn<"u"?Number(s.expiresIn):hw(s.idToken);this.updateTokensAndExpiration(s.idToken,s.refreshToken,c)}updateFromIdToken(s){De(s.length!==0,"internal-error");const c=hw(s);this.updateTokensAndExpiration(s,null,c)}async getToken(s,c=!1){return!c&&this.accessToken&&!this.isExpired?this.accessToken:(De(this.refreshToken,s,"user-token-expired"),this.refreshToken?(await this.refresh(s,this.refreshToken),this.accessToken):null)}clearRefreshToken(){this.refreshToken=null}async refresh(s,c){const{accessToken:p,refreshToken:_,expiresIn:g}=await U4(s,c);this.updateTokensAndExpiration(p,_,Number(g))}updateTokensAndExpiration(s,c,p){this.refreshToken=c||null,this.accessToken=s||null,this.expirationTime=Date.now()+p*1e3}static fromJSON(s,c){const{refreshToken:p,accessToken:_,expirationTime:g}=c,y=new dl;return p&&(De(typeof p=="string","internal-error",{appName:s}),y.refreshToken=p),_&&(De(typeof _=="string","internal-error",{appName:s}),y.accessToken=_),g&&(De(typeof g=="number","internal-error",{appName:s}),y.expirationTime=g),y}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(s){this.accessToken=s.accessToken,this.refreshToken=s.refreshToken,this.expirationTime=s.expirationTime}_clone(){return Object.assign(new dl,this.toJSON())}_performRefresh(){return zo("not implemented")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ha(u,s){De(typeof u=="string"||typeof u>"u","internal-error",{appName:s})}class Xo{constructor(s){var{uid:c,auth:p,stsTokenManager:_}=s,g=vT(s,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new k4(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=c,this.auth=p,this.stsTokenManager=_,this.accessToken=_.accessToken,this.displayName=g.displayName||null,this.email=g.email||null,this.emailVerified=g.emailVerified||!1,this.phoneNumber=g.phoneNumber||null,this.photoURL=g.photoURL||null,this.isAnonymous=g.isAnonymous||!1,this.tenantId=g.tenantId||null,this.providerData=g.providerData?[...g.providerData]:[],this.metadata=new bT(g.createdAt||void 0,g.lastLoginAt||void 0)}async getIdToken(s){const c=await ph(this,this.stsTokenManager.getToken(this.auth,s));return De(c,this.auth,"internal-error"),this.accessToken!==c&&(this.accessToken=c,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),c}getIdTokenResult(s){return P4(this,s)}reload(){return L4(this)}_assign(s){this!==s&&(De(this.uid===s.uid,this.auth,"internal-error"),this.displayName=s.displayName,this.photoURL=s.photoURL,this.email=s.email,this.emailVerified=s.emailVerified,this.phoneNumber=s.phoneNumber,this.isAnonymous=s.isAnonymous,this.tenantId=s.tenantId,this.providerData=s.providerData.map(c=>Object.assign({},c)),this.metadata._copy(s.metadata),this.stsTokenManager._assign(s.stsTokenManager))}_clone(s){const c=new Xo(Object.assign(Object.assign({},this),{auth:s,stsTokenManager:this.stsTokenManager._clone()}));return c.metadata._copy(this.metadata),c}_onReload(s){De(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=s,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(s){this.reloadListener?this.reloadListener(s):this.reloadUserInfo=s}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(s,c=!1){let p=!1;s.idToken&&s.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(s),p=!0),c&&await Vf(this),await this.auth._persistUserIfCurrent(this),p&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(Ua(this.auth.app))return Promise.reject(Wc(this.auth));const s=await this.getIdToken();return await ph(this,N4(this.auth,{idToken:s})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map(s=>Object.assign({},s)),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(s,c){var p,_,g,y,O,L,V,G;const tt=(p=c.displayName)!==null&&p!==void 0?p:void 0,st=(_=c.email)!==null&&_!==void 0?_:void 0,ht=(g=c.phoneNumber)!==null&&g!==void 0?g:void 0,yt=(y=c.photoURL)!==null&&y!==void 0?y:void 0,Vt=(O=c.tenantId)!==null&&O!==void 0?O:void 0,wt=(L=c._redirectEventId)!==null&&L!==void 0?L:void 0,te=(V=c.createdAt)!==null&&V!==void 0?V:void 0,Nt=(G=c.lastLoginAt)!==null&&G!==void 0?G:void 0,{uid:oe,emailVerified:Lt,isAnonymous:It,providerData:ae,stsTokenManager:J}=c;De(oe&&J,s,"internal-error");const q=dl.fromJSON(this.name,J);De(typeof oe=="string",s,"internal-error"),Ha(tt,s.name),Ha(st,s.name),De(typeof Lt=="boolean",s,"internal-error"),De(typeof It=="boolean",s,"internal-error"),Ha(ht,s.name),Ha(yt,s.name),Ha(Vt,s.name),Ha(wt,s.name),Ha(te,s.name),Ha(Nt,s.name);const K=new Xo({uid:oe,auth:s,email:st,emailVerified:Lt,displayName:tt,isAnonymous:It,photoURL:yt,phoneNumber:ht,tenantId:Vt,stsTokenManager:q,createdAt:te,lastLoginAt:Nt});return ae&&Array.isArray(ae)&&(K.providerData=ae.map(Z=>Object.assign({},Z))),wt&&(K._redirectEventId=wt),K}static async _fromIdTokenResponse(s,c,p=!1){const _=new dl;_.updateFromServerResponse(c);const g=new Xo({uid:c.localId,auth:s,stsTokenManager:_,isAnonymous:p});return await Vf(g),g}static async _fromGetAccountInfoResponse(s,c,p){const _=c.users[0];De(_.localId!==void 0,"internal-error");const g=_.providerUserInfo!==void 0?pw(_.providerUserInfo):[],y=!(_.email&&_.passwordHash)&&!(g!=null&&g.length),O=new dl;O.updateFromIdToken(p);const L=new Xo({uid:_.localId,auth:s,stsTokenManager:O,isAnonymous:y}),V={uid:_.localId,displayName:_.displayName||null,photoURL:_.photoUrl||null,email:_.email||null,emailVerified:_.emailVerified||!1,phoneNumber:_.phoneNumber||null,tenantId:_.tenantId||null,providerData:g,metadata:new bT(_.createdAt,_.lastLoginAt),isAnonymous:!(_.email&&_.passwordHash)&&!(g!=null&&g.length)};return Object.assign(L,V),L}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fw=new Map;function Qo(u){Jo(u instanceof Function,"Expected a class definition");let s=fw.get(u);return s?(Jo(s instanceof u,"Instance stored in cache mismatched with class"),s):(s=new u,fw.set(u,s),s)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _w{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(s,c){this.storage[s]=c}async _get(s){const c=this.storage[s];return c===void 0?null:c}async _remove(s){delete this.storage[s]}_addListener(s,c){}_removeListener(s,c){}}_w.type="NONE";const mw=_w;/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ff(u,s,c){return`firebase:${u}:${s}:${c}`}class ll{constructor(s,c,p){this.persistence=s,this.auth=c,this.userKey=p;const{config:_,name:g}=this.auth;this.fullUserKey=Ff(this.userKey,_.apiKey,g),this.fullPersistenceKey=Ff("persistence",_.apiKey,g),this.boundEventHandler=c._onStorageEvent.bind(c),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(s){return this.persistence._set(this.fullUserKey,s.toJSON())}async getCurrentUser(){const s=await this.persistence._get(this.fullUserKey);return s?Xo._fromJSON(this.auth,s):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(s){if(this.persistence===s)return;const c=await this.getCurrentUser();if(await this.removeCurrentUser(),this.persistence=s,c)return this.setCurrentUser(c)}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(s,c,p="authUser"){if(!c.length)return new ll(Qo(mw),s,p);const _=(await Promise.all(c.map(async V=>{if(await V._isAvailable())return V}))).filter(V=>V);let g=_[0]||Qo(mw);const y=Ff(p,s.config.apiKey,s.name);let O=null;for(const V of c)try{const G=await V._get(y);if(G){const tt=Xo._fromJSON(s,G);V!==g&&(O=tt),g=V;break}}catch{}const L=_.filter(V=>V._shouldAllowMigration);return!g._shouldAllowMigration||!L.length?new ll(g,s,p):(g=L[0],O&&await g._set(y,O.toJSON()),await Promise.all(c.map(async V=>{if(V!==g)try{await V._remove(y)}catch{}})),new ll(g,s,p))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ew(u){const s=u.toLowerCase();if(s.includes("opera/")||s.includes("opr/")||s.includes("opios/"))return"Opera";if(vw(s))return"IEMobile";if(s.includes("msie")||s.includes("trident/"))return"IE";if(s.includes("edge/"))return"Edge";if(gw(s))return"Firefox";if(s.includes("silk/"))return"Silk";if(Rw(s))return"Blackberry";if(Iw(s))return"Webos";if(Tw(s))return"Safari";if((s.includes("chrome/")||Sw(s))&&!s.includes("edge/"))return"Chrome";if(yw(s))return"Android";{const c=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,p=u.match(c);if((p==null?void 0:p.length)===2)return p[1]}return"Other"}function gw(u=fi()){return/firefox\//i.test(u)}function Tw(u=fi()){const s=u.toLowerCase();return s.includes("safari/")&&!s.includes("chrome/")&&!s.includes("crios/")&&!s.includes("android")}function Sw(u=fi()){return/crios\//i.test(u)}function vw(u=fi()){return/iemobile/i.test(u)}function yw(u=fi()){return/android/i.test(u)}function Rw(u=fi()){return/blackberry/i.test(u)}function Iw(u=fi()){return/webos/i.test(u)}function OT(u=fi()){return/iphone|ipad|ipod/i.test(u)||/macintosh/i.test(u)&&/mobile/i.test(u)}function V4(u=fi()){var s;return OT(u)&&!!(!((s=window.navigator)===null||s===void 0)&&s.standalone)}function F4(){return uF()&&document.documentMode===10}function Cw(u=fi()){return OT(u)||yw(u)||Iw(u)||Rw(u)||/windows phone/i.test(u)||vw(u)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Aw(u,s=[]){let c;switch(u){case"Browser":c=Ew(fi());break;case"Worker":c=`${Ew(fi())}-${u}`;break;default:c=u}const p=s.length?s.join(","):"FirebaseCore-web";return`${c}/JsCore/${Yd}/${p}`}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class B4{constructor(s){this.auth=s,this.queue=[]}pushCallback(s,c){const p=g=>new Promise((y,O)=>{try{const L=s(g);y(L)}catch(L){O(L)}});p.onAbort=c,this.queue.push(p);const _=this.queue.length-1;return()=>{this.queue[_]=()=>Promise.resolve()}}async runMiddleware(s){if(this.auth.currentUser===s)return;const c=[];try{for(const p of this.queue)await p(s),p.onAbort&&c.push(p.onAbort)}catch(p){c.reverse();for(const _ of c)try{_()}catch{}throw this.auth._errorFactory.create("login-blocked",{originalMessage:p==null?void 0:p.message})}}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function j4(u,s={}){return cl(u,"GET","/v2/passwordPolicy",CT(u,s))}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const G4=6;class W4{constructor(s){var c,p,_,g;const y=s.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=(c=y.minPasswordLength)!==null&&c!==void 0?c:G4,y.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=y.maxPasswordLength),y.containsLowercaseCharacter!==void 0&&(this.customStrengthOptions.containsLowercaseLetter=y.containsLowercaseCharacter),y.containsUppercaseCharacter!==void 0&&(this.customStrengthOptions.containsUppercaseLetter=y.containsUppercaseCharacter),y.containsNumericCharacter!==void 0&&(this.customStrengthOptions.containsNumericCharacter=y.containsNumericCharacter),y.containsNonAlphanumericCharacter!==void 0&&(this.customStrengthOptions.containsNonAlphanumericCharacter=y.containsNonAlphanumericCharacter),this.enforcementState=s.enforcementState,this.enforcementState==="ENFORCEMENT_STATE_UNSPECIFIED"&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=(_=(p=s.allowedNonAlphanumericCharacters)===null||p===void 0?void 0:p.join(""))!==null&&_!==void 0?_:"",this.forceUpgradeOnSignin=(g=s.forceUpgradeOnSignin)!==null&&g!==void 0?g:!1,this.schemaVersion=s.schemaVersion}validatePassword(s){var c,p,_,g,y,O;const L={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(s,L),this.validatePasswordCharacterOptions(s,L),L.isValid&&(L.isValid=(c=L.meetsMinPasswordLength)!==null&&c!==void 0?c:!0),L.isValid&&(L.isValid=(p=L.meetsMaxPasswordLength)!==null&&p!==void 0?p:!0),L.isValid&&(L.isValid=(_=L.containsLowercaseLetter)!==null&&_!==void 0?_:!0),L.isValid&&(L.isValid=(g=L.containsUppercaseLetter)!==null&&g!==void 0?g:!0),L.isValid&&(L.isValid=(y=L.containsNumericCharacter)!==null&&y!==void 0?y:!0),L.isValid&&(L.isValid=(O=L.containsNonAlphanumericCharacter)!==null&&O!==void 0?O:!0),L}validatePasswordLengthOptions(s,c){const p=this.customStrengthOptions.minPasswordLength,_=this.customStrengthOptions.maxPasswordLength;p&&(c.meetsMinPasswordLength=s.length>=p),_&&(c.meetsMaxPasswordLength=s.length<=_)}validatePasswordCharacterOptions(s,c){this.updatePasswordCharacterOptionsStatuses(c,!1,!1,!1,!1);let p;for(let _=0;_<s.length;_++)p=s.charAt(_),this.updatePasswordCharacterOptionsStatuses(c,p>="a"&&p<="z",p>="A"&&p<="Z",p>="0"&&p<="9",this.allowedNonAlphanumericCharacters.includes(p))}updatePasswordCharacterOptionsStatuses(s,c,p,_,g){this.customStrengthOptions.containsLowercaseLetter&&(s.containsLowercaseLetter||(s.containsLowercaseLetter=c)),this.customStrengthOptions.containsUppercaseLetter&&(s.containsUppercaseLetter||(s.containsUppercaseLetter=p)),this.customStrengthOptions.containsNumericCharacter&&(s.containsNumericCharacter||(s.containsNumericCharacter=_)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(s.containsNonAlphanumericCharacter||(s.containsNonAlphanumericCharacter=g))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class H4{constructor(s,c,p,_){this.app=s,this.heartbeatServiceProvider=c,this.appCheckServiceProvider=p,this.config=_,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new ww(this),this.idTokenSubscription=new ww(this),this.beforeStateQueue=new B4(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=sw,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=s.name,this.clientVersion=_.sdkClientVersion}_initializeWithPersistence(s,c){return c&&(this._popupRedirectResolver=Qo(c)),this._initializationPromise=this.queue(async()=>{var p,_;if(!this._deleted&&(this.persistenceManager=await ll.create(this,s),!this._deleted)){if(!((p=this._popupRedirectResolver)===null||p===void 0)&&p._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch{}await this.initializeCurrentUser(c),this.lastNotifiedUid=((_=this.currentUser)===null||_===void 0?void 0:_.uid)||null,!this._deleted&&(this._isInitialized=!0)}}),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const s=await this.assertedPersistence.getCurrentUser();if(!(!this.currentUser&&!s)){if(this.currentUser&&s&&this.currentUser.uid===s.uid){this._currentUser._assign(s),await this.currentUser.getIdToken();return}await this._updateCurrentUser(s,!0)}}async initializeCurrentUserFromIdToken(s){try{const c=await uw(this,{idToken:s}),p=await Xo._fromGetAccountInfoResponse(this,c,s);await this.directlySetCurrentUser(p)}catch(c){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",c),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(s){var c;if(Ua(this.app)){const y=this.app.settings.authIdToken;return y?new Promise(O=>{setTimeout(()=>this.initializeCurrentUserFromIdToken(y).then(O,O))}):this.directlySetCurrentUser(null)}const p=await this.assertedPersistence.getCurrentUser();let _=p,g=!1;if(s&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const y=(c=this.redirectUser)===null||c===void 0?void 0:c._redirectEventId,O=_==null?void 0:_._redirectEventId,L=await this.tryRedirectSignIn(s);(!y||y===O)&&(L!=null&&L.user)&&(_=L.user,g=!0)}if(!_)return this.directlySetCurrentUser(null);if(!_._redirectEventId){if(g)try{await this.beforeStateQueue.runMiddleware(_)}catch(y){_=p,this._popupRedirectResolver._overrideRedirectResult(this,()=>Promise.reject(y))}return _?this.reloadAndSetCurrentUserOrClear(_):this.directlySetCurrentUser(null)}return De(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===_._redirectEventId?this.directlySetCurrentUser(_):this.reloadAndSetCurrentUserOrClear(_)}async tryRedirectSignIn(s){let c=null;try{c=await this._popupRedirectResolver._completeRedirectFn(this,s,!0)}catch{await this._setRedirectUser(null)}return c}async reloadAndSetCurrentUserOrClear(s){try{await Vf(s)}catch(c){if((c==null?void 0:c.code)!=="auth/network-request-failed")return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(s)}useDeviceLanguage(){this.languageCode=C4()}async _delete(){this._deleted=!0}async updateCurrentUser(s){if(Ua(this.app))return Promise.reject(Wc(this));const c=s?kc(s):null;return c&&De(c.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(c&&c._clone(this))}async _updateCurrentUser(s,c=!1){if(!this._deleted)return s&&De(this.tenantId===s.tenantId,this,"tenant-id-mismatch"),c||await this.beforeStateQueue.runMiddleware(s),this.queue(async()=>{await this.directlySetCurrentUser(s),this.notifyAuthListeners()})}async signOut(){return Ua(this.app)?Promise.reject(Wc(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(s){return Ua(this.app)?Promise.reject(Wc(this)):this.queue(async()=>{await this.assertedPersistence.setPersistence(Qo(s))})}_getRecaptchaConfig(){return this.tenantId==null?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(s){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const c=this._getPasswordPolicyInternal();return c.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):c.validatePassword(s)}_getPasswordPolicyInternal(){return this.tenantId===null?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const s=await j4(this),c=new W4(s);this.tenantId===null?this._projectPasswordPolicy=c:this._tenantPasswordPolicies[this.tenantId]=c}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(s){this._errorFactory=new Ku("auth","Firebase",s())}onAuthStateChanged(s,c,p){return this.registerStateListener(this.authStateSubscription,s,c,p)}beforeAuthStateChanged(s,c){return this.beforeStateQueue.pushCallback(s,c)}onIdTokenChanged(s,c,p){return this.registerStateListener(this.idTokenSubscription,s,c,p)}authStateReady(){return new Promise((s,c)=>{if(this.currentUser)s();else{const p=this.onAuthStateChanged(()=>{p(),s()},c)}})}async revokeAccessToken(s){if(this.currentUser){const c=await this.currentUser.getIdToken(),p={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:s,idToken:c};this.tenantId!=null&&(p.tenantId=this.tenantId),await x4(this,p)}}toJSON(){var s;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:(s=this._currentUser)===null||s===void 0?void 0:s.toJSON()}}async _setRedirectUser(s,c){const p=await this.getOrInitRedirectPersistenceManager(c);return s===null?p.removeCurrentUser():p.setCurrentUser(s)}async getOrInitRedirectPersistenceManager(s){if(!this.redirectPersistenceManager){const c=s&&Qo(s)||this._popupRedirectResolver;De(c,this,"argument-error"),this.redirectPersistenceManager=await ll.create(this,[Qo(c._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(s){var c,p;return this._isInitialized&&await this.queue(async()=>{}),((c=this._currentUser)===null||c===void 0?void 0:c._redirectEventId)===s?this._currentUser:((p=this.redirectUser)===null||p===void 0?void 0:p._redirectEventId)===s?this.redirectUser:null}async _persistUserIfCurrent(s){if(s===this.currentUser)return this.queue(async()=>this.directlySetCurrentUser(s))}_notifyListenersIfCurrent(s){s===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var s,c;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const p=(c=(s=this.currentUser)===null||s===void 0?void 0:s.uid)!==null&&c!==void 0?c:null;this.lastNotifiedUid!==p&&(this.lastNotifiedUid=p,this.authStateSubscription.next(this.currentUser))}registerStateListener(s,c,p,_){if(this._deleted)return()=>{};const g=typeof c=="function"?c:c.next.bind(c);let y=!1;const O=this._isInitialized?Promise.resolve():this._initializationPromise;if(De(O,this,"internal-error"),O.then(()=>{y||g(this.currentUser)}),typeof c=="function"){const L=s.addObserver(c,p,_);return()=>{y=!0,L()}}else{const L=s.addObserver(c);return()=>{y=!0,L()}}}async directlySetCurrentUser(s){this.currentUser&&this.currentUser!==s&&this._currentUser._stopProactiveRefresh(),s&&this.isProactiveRefreshEnabled&&s._startProactiveRefresh(),this.currentUser=s,s?await this.assertedPersistence.setCurrentUser(s):await this.assertedPersistence.removeCurrentUser()}queue(s){return this.operations=this.operations.then(s,s),this.operations}get assertedPersistence(){return De(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(s){!s||this.frameworks.includes(s)||(this.frameworks.push(s),this.frameworks.sort(),this.clientVersion=Aw(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var s;const c={"X-Client-Version":this.clientVersion};this.app.options.appId&&(c["X-Firebase-gmpid"]=this.app.options.appId);const p=await((s=this.heartbeatServiceProvider.getImmediate({optional:!0}))===null||s===void 0?void 0:s.getHeartbeatsHeader());p&&(c["X-Firebase-Client"]=p);const _=await this._getAppCheckToken();return _&&(c["X-Firebase-AppCheck"]=_),c}async _getAppCheckToken(){var s;const c=await((s=this.appCheckServiceProvider.getImmediate({optional:!0}))===null||s===void 0?void 0:s.getToken());return c!=null&&c.error&&y4(`Error while retrieving App Check token: ${c.error}`),c==null?void 0:c.token}}function NT(u){return kc(u)}class ww{constructor(s){this.auth=s,this.observer=null,this.addObserver=TF(c=>this.observer=c)}get next(){return De(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let PT={async loadJS(){throw new Error("Unable to load external scripts")},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function K4(u){PT=u}function q4(u){return PT.loadJS(u)}function Y4(){return PT.gapiScript}function z4(u){return`__${u}${Math.floor(Math.random()*1e6)}`}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function J4(u,s){const c=bg(u,"auth");if(c.isInitialized()){const _=c.getImmediate(),g=c.getOptions();if(uf(g,s??{}))return _;Yo(_,"already-initialized")}return c.initialize({options:s})}function X4(u,s){const c=(s==null?void 0:s.persistence)||[],p=(Array.isArray(c)?c:[c]).map(Qo);s!=null&&s.errorMap&&u._updateErrorMap(s.errorMap),u._initializeWithPersistence(p,s==null?void 0:s.popupRedirectResolver)}function Q4(u,s,c){const p=NT(u);De(p._canInitEmulator,p,"emulator-config-failed"),De(/^https?:\/\//.test(s),p,"invalid-emulator-scheme");const _=!1,g=bw(s),{host:y,port:O}=$4(s),L=O===null?"":`:${O}`;p.config.emulator={url:`${g}//${y}${L}/`},p.settings.appVerificationDisabledForTesting=!0,p.emulatorConfig=Object.freeze({host:y,port:O,protocol:g.replace(":",""),options:Object.freeze({disableWarnings:_})}),Z4()}function bw(u){const s=u.indexOf(":");return s<0?"":u.substr(0,s+1)}function $4(u){const s=bw(u),c=/(\/\/)?([^?#/]+)/.exec(u.substr(s.length));if(!c)return{host:"",port:null};const p=c[2].split("@").pop()||"",_=/^(\[[^\]]+\])(:|$)/.exec(p);if(_){const g=_[1];return{host:g,port:Ow(p.substr(g.length+1))}}else{const[g,y]=p.split(":");return{host:g,port:Ow(y)}}}function Ow(u){if(!u)return null;const s=Number(u);return isNaN(s)?null:s}function Z4(){function u(){const s=document.createElement("p"),c=s.style;s.innerText="Running in emulator mode. Do not use with production credentials.",c.position="fixed",c.width="100%",c.backgroundColor="#ffffff",c.border=".1em solid #000000",c.color="#b50000",c.bottom="0px",c.left="0px",c.margin="0px",c.zIndex="10000",c.textAlign="center",s.classList.add("firebase-emulator-warning"),document.body.appendChild(s)}typeof console<"u"&&typeof console.info=="function"&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),typeof window<"u"&&typeof document<"u"&&(document.readyState==="loading"?window.addEventListener("DOMContentLoaded",u):u())}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nw{constructor(s,c){this.providerId=s,this.signInMethod=c}toJSON(){return zo("not implemented")}_getIdTokenResponse(s){return zo("not implemented")}_linkToIdToken(s,c){return zo("not implemented")}_getReauthenticationResolver(s){return zo("not implemented")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ul(u,s){return b4(u,"POST","/v1/accounts:signInWithIdp",CT(u,s))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const t3="http://localhost";class Hc extends Nw{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(s){const c=new Hc(s.providerId,s.signInMethod);return s.idToken||s.accessToken?(s.idToken&&(c.idToken=s.idToken),s.accessToken&&(c.accessToken=s.accessToken),s.nonce&&!s.pendingToken&&(c.nonce=s.nonce),s.pendingToken&&(c.pendingToken=s.pendingToken)):s.oauthToken&&s.oauthTokenSecret?(c.accessToken=s.oauthToken,c.secret=s.oauthTokenSecret):Yo("argument-error"),c}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(s){const c=typeof s=="string"?JSON.parse(s):s,{providerId:p,signInMethod:_}=c,g=vT(c,["providerId","signInMethod"]);if(!p||!_)return null;const y=new Hc(p,_);return y.idToken=g.idToken||void 0,y.accessToken=g.accessToken||void 0,y.secret=g.secret,y.nonce=g.nonce,y.pendingToken=g.pendingToken||null,y}_getIdTokenResponse(s){const c=this.buildRequest();return ul(s,c)}_linkToIdToken(s,c){const p=this.buildRequest();return p.idToken=c,ul(s,p)}_getReauthenticationResolver(s){const c=this.buildRequest();return c.autoCreate=!1,ul(s,c)}buildRequest(){const s={requestUri:t3,returnSecureToken:!0};if(this.pendingToken)s.pendingToken=this.pendingToken;else{const c={};this.idToken&&(c.id_token=this.idToken),this.accessToken&&(c.access_token=this.accessToken),this.secret&&(c.oauth_token_secret=this.secret),c.providerId=this.providerId,this.nonce&&!this.pendingToken&&(c.nonce=this.nonce),s.postBody=qu(c)}return s}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pw{constructor(s){this.providerId=s,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(s){this.defaultLanguageCode=s}setCustomParameters(s){return this.customParameters=s,this}getCustomParameters(){return this.customParameters}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fh extends Pw{constructor(){super(...arguments),this.scopes=[]}addScope(s){return this.scopes.includes(s)||this.scopes.push(s),this}getScopes(){return[...this.scopes]}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ka extends fh{constructor(){super("facebook.com")}static credential(s){return Hc._fromParams({providerId:Ka.PROVIDER_ID,signInMethod:Ka.FACEBOOK_SIGN_IN_METHOD,accessToken:s})}static credentialFromResult(s){return Ka.credentialFromTaggedObject(s)}static credentialFromError(s){return Ka.credentialFromTaggedObject(s.customData||{})}static credentialFromTaggedObject({_tokenResponse:s}){if(!s||!("oauthAccessToken"in s)||!s.oauthAccessToken)return null;try{return Ka.credential(s.oauthAccessToken)}catch{return null}}}Ka.FACEBOOK_SIGN_IN_METHOD="facebook.com",Ka.PROVIDER_ID="facebook.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qa extends fh{constructor(){super("google.com"),this.addScope("profile")}static credential(s,c){return Hc._fromParams({providerId:qa.PROVIDER_ID,signInMethod:qa.GOOGLE_SIGN_IN_METHOD,idToken:s,accessToken:c})}static credentialFromResult(s){return qa.credentialFromTaggedObject(s)}static credentialFromError(s){return qa.credentialFromTaggedObject(s.customData||{})}static credentialFromTaggedObject({_tokenResponse:s}){if(!s)return null;const{oauthIdToken:c,oauthAccessToken:p}=s;if(!c&&!p)return null;try{return qa.credential(c,p)}catch{return null}}}qa.GOOGLE_SIGN_IN_METHOD="google.com",qa.PROVIDER_ID="google.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ya extends fh{constructor(){super("github.com")}static credential(s){return Hc._fromParams({providerId:Ya.PROVIDER_ID,signInMethod:Ya.GITHUB_SIGN_IN_METHOD,accessToken:s})}static credentialFromResult(s){return Ya.credentialFromTaggedObject(s)}static credentialFromError(s){return Ya.credentialFromTaggedObject(s.customData||{})}static credentialFromTaggedObject({_tokenResponse:s}){if(!s||!("oauthAccessToken"in s)||!s.oauthAccessToken)return null;try{return Ya.credential(s.oauthAccessToken)}catch{return null}}}Ya.GITHUB_SIGN_IN_METHOD="github.com",Ya.PROVIDER_ID="github.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class za extends fh{constructor(){super("twitter.com")}static credential(s,c){return Hc._fromParams({providerId:za.PROVIDER_ID,signInMethod:za.TWITTER_SIGN_IN_METHOD,oauthToken:s,oauthTokenSecret:c})}static credentialFromResult(s){return za.credentialFromTaggedObject(s)}static credentialFromError(s){return za.credentialFromTaggedObject(s.customData||{})}static credentialFromTaggedObject({_tokenResponse:s}){if(!s)return null;const{oauthAccessToken:c,oauthTokenSecret:p}=s;if(!c||!p)return null;try{return za.credential(c,p)}catch{return null}}}za.TWITTER_SIGN_IN_METHOD="twitter.com",za.PROVIDER_ID="twitter.com";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hl{constructor(s){this.user=s.user,this.providerId=s.providerId,this._tokenResponse=s._tokenResponse,this.operationType=s.operationType}static async _fromIdTokenResponse(s,c,p,_=!1){const g=await Xo._fromIdTokenResponse(s,p,_),y=Dw(p);return new hl({user:g,providerId:y,_tokenResponse:p,operationType:c})}static async _forOperation(s,c,p){await s._updateTokensIfNecessary(p,!0);const _=Dw(p);return new hl({user:s,providerId:_,_tokenResponse:p,operationType:c})}}function Dw(u){return u.providerId?u.providerId:"phoneNumber"in u?"phone":null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bf extends Wo{constructor(s,c,p,_){var g;super(c.code,c.message),this.operationType=p,this.user=_,Object.setPrototypeOf(this,Bf.prototype),this.customData={appName:s.name,tenantId:(g=s.tenantId)!==null&&g!==void 0?g:void 0,_serverResponse:c.customData._serverResponse,operationType:p}}static _fromErrorAndOperation(s,c,p,_){return new Bf(s,c,p,_)}}function kw(u,s,c,p){return(s==="reauthenticate"?c._getReauthenticationResolver(u):c._getIdTokenResponse(u)).catch(g=>{throw g.code==="auth/multi-factor-auth-required"?Bf._fromErrorAndOperation(u,g,s,p):g})}async function e3(u,s,c=!1){const p=await ph(u,s._linkToIdToken(u.auth,await u.getIdToken()),c);return hl._forOperation(u,"link",p)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function n3(u,s,c=!1){const{auth:p}=u;if(Ua(p.app))return Promise.reject(Wc(p));const _="reauthenticate";try{const g=await ph(u,kw(p,_,s,u),c);De(g.idToken,p,"internal-error");const y=wT(g.idToken);De(y,p,"internal-error");const{sub:O}=y;return De(u.uid===O,p,"user-mismatch"),hl._forOperation(u,_,g)}catch(g){throw(g==null?void 0:g.code)==="auth/user-not-found"&&Yo(p,"user-mismatch"),g}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function r3(u,s,c=!1){if(Ua(u.app))return Promise.reject(Wc(u));const p="signIn",_=await kw(u,p,s),g=await hl._fromIdTokenResponse(u,p,_);return c||await u._updateCurrentUser(g.user),g}function i3(u,s,c,p){return kc(u).onIdTokenChanged(s,c,p)}function s3(u,s,c){return kc(u).beforeAuthStateChanged(s,c)}const jf="__sak";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lw{constructor(s,c){this.storageRetriever=s,this.type=c}_isAvailable(){try{return this.storage?(this.storage.setItem(jf,"1"),this.storage.removeItem(jf),Promise.resolve(!0)):Promise.resolve(!1)}catch{return Promise.resolve(!1)}}_set(s,c){return this.storage.setItem(s,JSON.stringify(c)),Promise.resolve()}_get(s){const c=this.storage.getItem(s);return Promise.resolve(c?JSON.parse(c):null)}_remove(s){return this.storage.removeItem(s),Promise.resolve()}get storage(){return this.storageRetriever()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const o3=1e3,a3=10;class Mw extends Lw{constructor(){super(()=>window.localStorage,"LOCAL"),this.boundEventHandler=(s,c)=>this.onStorageEvent(s,c),this.listeners={},this.localCache={},this.pollTimer=null,this.fallbackToPolling=Cw(),this._shouldAllowMigration=!0}forAllChangedKeys(s){for(const c of Object.keys(this.listeners)){const p=this.storage.getItem(c),_=this.localCache[c];p!==_&&s(c,_,p)}}onStorageEvent(s,c=!1){if(!s.key){this.forAllChangedKeys((y,O,L)=>{this.notifyListeners(y,L)});return}const p=s.key;c?this.detachListener():this.stopPolling();const _=()=>{const y=this.storage.getItem(p);!c&&this.localCache[p]===y||this.notifyListeners(p,y)},g=this.storage.getItem(p);F4()&&g!==s.newValue&&s.newValue!==s.oldValue?setTimeout(_,a3):_()}notifyListeners(s,c){this.localCache[s]=c;const p=this.listeners[s];if(p)for(const _ of Array.from(p))_(c&&JSON.parse(c))}startPolling(){this.stopPolling(),this.pollTimer=setInterval(()=>{this.forAllChangedKeys((s,c,p)=>{this.onStorageEvent(new StorageEvent("storage",{key:s,oldValue:c,newValue:p}),!0)})},o3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(s,c){Object.keys(this.listeners).length===0&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[s]||(this.listeners[s]=new Set,this.localCache[s]=this.storage.getItem(s)),this.listeners[s].add(c)}_removeListener(s,c){this.listeners[s]&&(this.listeners[s].delete(c),this.listeners[s].size===0&&delete this.listeners[s]),Object.keys(this.listeners).length===0&&(this.detachListener(),this.stopPolling())}async _set(s,c){await super._set(s,c),this.localCache[s]=JSON.stringify(c)}async _get(s){const c=await super._get(s);return this.localCache[s]=JSON.stringify(c),c}async _remove(s){await super._remove(s),delete this.localCache[s]}}Mw.type="LOCAL";const c3=Mw;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Uw extends Lw{constructor(){super(()=>window.sessionStorage,"SESSION")}_addListener(s,c){}_removeListener(s,c){}}Uw.type="SESSION";const xw=Uw;/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function d3(u){return Promise.all(u.map(async s=>{try{return{fulfilled:!0,value:await s}}catch(c){return{fulfilled:!1,reason:c}}}))}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gf{constructor(s){this.eventTarget=s,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(s){const c=this.receivers.find(_=>_.isListeningto(s));if(c)return c;const p=new Gf(s);return this.receivers.push(p),p}isListeningto(s){return this.eventTarget===s}async handleEvent(s){const c=s,{eventId:p,eventType:_,data:g}=c.data,y=this.handlersMap[_];if(!(y!=null&&y.size))return;c.ports[0].postMessage({status:"ack",eventId:p,eventType:_});const O=Array.from(y).map(async V=>V(c.origin,g)),L=await d3(O);c.ports[0].postMessage({status:"done",eventId:p,eventType:_,response:L})}_subscribe(s,c){Object.keys(this.handlersMap).length===0&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[s]||(this.handlersMap[s]=new Set),this.handlersMap[s].add(c)}_unsubscribe(s,c){this.handlersMap[s]&&c&&this.handlersMap[s].delete(c),(!c||this.handlersMap[s].size===0)&&delete this.handlersMap[s],Object.keys(this.handlersMap).length===0&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}Gf.receivers=[];/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function DT(u="",s=10){let c="";for(let p=0;p<s;p++)c+=Math.floor(Math.random()*10);return u+c}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class l3{constructor(s){this.target=s,this.handlers=new Set}removeMessageHandler(s){s.messageChannel&&(s.messageChannel.port1.removeEventListener("message",s.onMessage),s.messageChannel.port1.close()),this.handlers.delete(s)}async _send(s,c,p=50){const _=typeof MessageChannel<"u"?new MessageChannel:null;if(!_)throw new Error("connection_unavailable");let g,y;return new Promise((O,L)=>{const V=DT("",20);_.port1.start();const G=setTimeout(()=>{L(new Error("unsupported_event"))},p);y={messageChannel:_,onMessage(tt){const st=tt;if(st.data.eventId===V)switch(st.data.status){case"ack":clearTimeout(G),g=setTimeout(()=>{L(new Error("timeout"))},3e3);break;case"done":clearTimeout(g),O(st.data.response);break;default:clearTimeout(G),clearTimeout(g),L(new Error("invalid_response"));break}}},this.handlers.add(y),_.port1.addEventListener("message",y.onMessage),this.target.postMessage({eventType:s,eventId:V,data:c},[_.port2])}).finally(()=>{y&&this.removeMessageHandler(y)})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ho(){return window}function u3(u){ho().location.href=u}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Vw(){return typeof ho().WorkerGlobalScope<"u"&&typeof ho().importScripts=="function"}async function h3(){if(!(navigator!=null&&navigator.serviceWorker))return null;try{return(await navigator.serviceWorker.ready).active}catch{return null}}function p3(){var u;return((u=navigator==null?void 0:navigator.serviceWorker)===null||u===void 0?void 0:u.controller)||null}function f3(){return Vw()?self:null}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fw="firebaseLocalStorageDb",_3=1,Wf="firebaseLocalStorage",Bw="fbase_key";class _h{constructor(s){this.request=s}toPromise(){return new Promise((s,c)=>{this.request.addEventListener("success",()=>{s(this.request.result)}),this.request.addEventListener("error",()=>{c(this.request.error)})})}}function Hf(u,s){return u.transaction([Wf],s?"readwrite":"readonly").objectStore(Wf)}function m3(){const u=indexedDB.deleteDatabase(Fw);return new _h(u).toPromise()}function kT(){const u=indexedDB.open(Fw,_3);return new Promise((s,c)=>{u.addEventListener("error",()=>{c(u.error)}),u.addEventListener("upgradeneeded",()=>{const p=u.result;try{p.createObjectStore(Wf,{keyPath:Bw})}catch(_){c(_)}}),u.addEventListener("success",async()=>{const p=u.result;p.objectStoreNames.contains(Wf)?s(p):(p.close(),await m3(),s(await kT()))})})}async function jw(u,s,c){const p=Hf(u,!0).put({[Bw]:s,value:c});return new _h(p).toPromise()}async function E3(u,s){const c=Hf(u,!1).get(s),p=await new _h(c).toPromise();return p===void 0?null:p.value}function Gw(u,s){const c=Hf(u,!0).delete(s);return new _h(c).toPromise()}const g3=800,T3=3;class Ww{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then(()=>{},()=>{})}async _openDb(){return this.db?this.db:(this.db=await kT(),this.db)}async _withRetries(s){let c=0;for(;;)try{const p=await this._openDb();return await s(p)}catch(p){if(c++>T3)throw p;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return Vw()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=Gf._getInstance(f3()),this.receiver._subscribe("keyChanged",async(s,c)=>({keyProcessed:(await this._poll()).includes(c.key)})),this.receiver._subscribe("ping",async(s,c)=>["keyChanged"])}async initializeSender(){var s,c;if(this.activeServiceWorker=await h3(),!this.activeServiceWorker)return;this.sender=new l3(this.activeServiceWorker);const p=await this.sender._send("ping",{},800);p&&!((s=p[0])===null||s===void 0)&&s.fulfilled&&!((c=p[0])===null||c===void 0)&&c.value.includes("keyChanged")&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(s){if(!(!this.sender||!this.activeServiceWorker||p3()!==this.activeServiceWorker))try{await this.sender._send("keyChanged",{key:s},this.serviceWorkerReceiverAvailable?800:50)}catch{}}async _isAvailable(){try{if(!indexedDB)return!1;const s=await kT();return await jw(s,jf,"1"),await Gw(s,jf),!0}catch{}return!1}async _withPendingWrite(s){this.pendingWrites++;try{await s()}finally{this.pendingWrites--}}async _set(s,c){return this._withPendingWrite(async()=>(await this._withRetries(p=>jw(p,s,c)),this.localCache[s]=c,this.notifyServiceWorker(s)))}async _get(s){const c=await this._withRetries(p=>E3(p,s));return this.localCache[s]=c,c}async _remove(s){return this._withPendingWrite(async()=>(await this._withRetries(c=>Gw(c,s)),delete this.localCache[s],this.notifyServiceWorker(s)))}async _poll(){const s=await this._withRetries(_=>{const g=Hf(_,!1).getAll();return new _h(g).toPromise()});if(!s)return[];if(this.pendingWrites!==0)return[];const c=[],p=new Set;if(s.length!==0)for(const{fbase_key:_,value:g}of s)p.add(_),JSON.stringify(this.localCache[_])!==JSON.stringify(g)&&(this.notifyListeners(_,g),c.push(_));for(const _ of Object.keys(this.localCache))this.localCache[_]&&!p.has(_)&&(this.notifyListeners(_,null),c.push(_));return c}notifyListeners(s,c){this.localCache[s]=c;const p=this.listeners[s];if(p)for(const _ of Array.from(p))_(c)}startPolling(){this.stopPolling(),this.pollTimer=setInterval(async()=>this._poll(),g3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(s,c){Object.keys(this.listeners).length===0&&this.startPolling(),this.listeners[s]||(this.listeners[s]=new Set,this._get(s)),this.listeners[s].add(c)}_removeListener(s,c){this.listeners[s]&&(this.listeners[s].delete(c),this.listeners[s].size===0&&delete this.listeners[s]),Object.keys(this.listeners).length===0&&this.stopPolling()}}Ww.type="LOCAL";const S3=Ww;new uh(3e4,6e4);/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function v3(u,s){return s?Qo(s):(De(u._popupRedirectResolver,u,"argument-error"),u._popupRedirectResolver)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class LT extends Nw{constructor(s){super("custom","custom"),this.params=s}_getIdTokenResponse(s){return ul(s,this._buildIdpRequest())}_linkToIdToken(s,c){return ul(s,this._buildIdpRequest(c))}_getReauthenticationResolver(s){return ul(s,this._buildIdpRequest())}_buildIdpRequest(s){const c={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return s&&(c.idToken=s),c}}function y3(u){return r3(u.auth,new LT(u),u.bypassAuthState)}function R3(u){const{auth:s,user:c}=u;return De(c,s,"internal-error"),n3(c,new LT(u),u.bypassAuthState)}async function I3(u){const{auth:s,user:c}=u;return De(c,s,"internal-error"),e3(c,new LT(u),u.bypassAuthState)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hw{constructor(s,c,p,_,g=!1){this.auth=s,this.resolver=p,this.user=_,this.bypassAuthState=g,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(c)?c:[c]}execute(){return new Promise(async(s,c)=>{this.pendingPromise={resolve:s,reject:c};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(p){this.reject(p)}})}async onAuthEvent(s){const{urlResponse:c,sessionId:p,postBody:_,tenantId:g,error:y,type:O}=s;if(y){this.reject(y);return}const L={auth:this.auth,requestUri:c,sessionId:p,tenantId:g||void 0,postBody:_||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(O)(L))}catch(V){this.reject(V)}}onError(s){this.reject(s)}getIdpTask(s){switch(s){case"signInViaPopup":case"signInViaRedirect":return y3;case"linkViaPopup":case"linkViaRedirect":return I3;case"reauthViaPopup":case"reauthViaRedirect":return R3;default:Yo(this.auth,"internal-error")}}resolve(s){Jo(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(s),this.unregisterAndCleanUp()}reject(s){Jo(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(s),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const C3=new uh(2e3,1e4);class pl extends Hw{constructor(s,c,p,_,g){super(s,c,_,g),this.provider=p,this.authWindow=null,this.pollId=null,pl.currentPopupAction&&pl.currentPopupAction.cancel(),pl.currentPopupAction=this}async executeNotNull(){const s=await this.execute();return De(s,this.auth,"internal-error"),s}async onExecution(){Jo(this.filter.length===1,"Popup operations only handle one event");const s=DT();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],s),this.authWindow.associatedEvent=s,this.resolver._originValidation(this.auth).catch(c=>{this.reject(c)}),this.resolver._isIframeWebStorageSupported(this.auth,c=>{c||this.reject(uo(this.auth,"web-storage-unsupported"))}),this.pollUserCancellation()}get eventId(){var s;return((s=this.authWindow)===null||s===void 0?void 0:s.associatedEvent)||null}cancel(){this.reject(uo(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,pl.currentPopupAction=null}pollUserCancellation(){const s=()=>{var c,p;if(!((p=(c=this.authWindow)===null||c===void 0?void 0:c.window)===null||p===void 0)&&p.closed){this.pollId=window.setTimeout(()=>{this.pollId=null,this.reject(uo(this.auth,"popup-closed-by-user"))},8e3);return}this.pollId=window.setTimeout(s,C3.get())};s()}}pl.currentPopupAction=null;/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const A3="pendingRedirect",Kf=new Map;class w3 extends Hw{constructor(s,c,p=!1){super(s,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],c,void 0,p),this.eventId=null}async execute(){let s=Kf.get(this.auth._key());if(!s){try{const p=await b3(this.resolver,this.auth)?await super.execute():null;s=()=>Promise.resolve(p)}catch(c){s=()=>Promise.reject(c)}Kf.set(this.auth._key(),s)}return this.bypassAuthState||Kf.set(this.auth._key(),()=>Promise.resolve(null)),s()}async onAuthEvent(s){if(s.type==="signInViaRedirect")return super.onAuthEvent(s);if(s.type==="unknown"){this.resolve(null);return}if(s.eventId){const c=await this.auth._redirectUserForId(s.eventId);if(c)return this.user=c,super.onAuthEvent(s);this.resolve(null)}}async onExecution(){}cleanUp(){}}async function b3(u,s){const c=P3(s),p=N3(u);if(!await p._isAvailable())return!1;const _=await p._get(c)==="true";return await p._remove(c),_}function O3(u,s){Kf.set(u._key(),s)}function N3(u){return Qo(u._redirectPersistence)}function P3(u){return Ff(A3,u.config.apiKey,u.name)}async function D3(u,s,c=!1){if(Ua(u.app))return Promise.reject(Wc(u));const p=NT(u),_=v3(p,s),y=await new w3(p,_,c).execute();return y&&!c&&(delete y.user._redirectEventId,await p._persistUserIfCurrent(y.user),await p._setRedirectUser(null,s)),y}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const k3=10*60*1e3;class L3{constructor(s){this.auth=s,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(s){this.consumers.add(s),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,s)&&(this.sendToConsumer(this.queuedRedirectEvent,s),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(s){this.consumers.delete(s)}onEvent(s){if(this.hasEventBeenHandled(s))return!1;let c=!1;return this.consumers.forEach(p=>{this.isEventForConsumer(s,p)&&(c=!0,this.sendToConsumer(s,p),this.saveEventToCache(s))}),this.hasHandledPotentialRedirect||!M3(s)||(this.hasHandledPotentialRedirect=!0,c||(this.queuedRedirectEvent=s,c=!0)),c}sendToConsumer(s,c){var p;if(s.error&&!qw(s)){const _=((p=s.error.code)===null||p===void 0?void 0:p.split("auth/")[1])||"internal-error";c.onError(uo(this.auth,_))}else c.onAuthEvent(s)}isEventForConsumer(s,c){const p=c.eventId===null||!!s.eventId&&s.eventId===c.eventId;return c.filter.includes(s.type)&&p}hasEventBeenHandled(s){return Date.now()-this.lastProcessedEventTime>=k3&&this.cachedEventUids.clear(),this.cachedEventUids.has(Kw(s))}saveEventToCache(s){this.cachedEventUids.add(Kw(s)),this.lastProcessedEventTime=Date.now()}}function Kw(u){return[u.type,u.eventId,u.sessionId,u.tenantId].filter(s=>s).join("-")}function qw({type:u,error:s}){return u==="unknown"&&(s==null?void 0:s.code)==="auth/no-auth-event"}function M3(u){switch(u.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return qw(u);default:return!1}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function U3(u,s={}){return cl(u,"GET","/v1/projects",s)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const x3=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,V3=/^https?/;async function F3(u){if(u.config.emulator)return;const{authorizedDomains:s}=await U3(u);for(const c of s)try{if(B3(c))return}catch{}Yo(u,"unauthorized-domain")}function B3(u){const s=RT(),{protocol:c,hostname:p}=new URL(s);if(u.startsWith("chrome-extension://")){const y=new URL(u);return y.hostname===""&&p===""?c==="chrome-extension:"&&u.replace("chrome-extension://","")===s.replace("chrome-extension://",""):c==="chrome-extension:"&&y.hostname===p}if(!V3.test(c))return!1;if(x3.test(u))return p===u;const _=u.replace(/\./g,"\\.");return new RegExp("^(.+\\."+_+"|"+_+")$","i").test(p)}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const j3=new uh(3e4,6e4);function Yw(){const u=ho().___jsl;if(u!=null&&u.H){for(const s of Object.keys(u.H))if(u.H[s].r=u.H[s].r||[],u.H[s].L=u.H[s].L||[],u.H[s].r=[...u.H[s].L],u.CP)for(let c=0;c<u.CP.length;c++)u.CP[c]=null}}function G3(u){return new Promise((s,c)=>{var p,_,g;function y(){Yw(),gapi.load("gapi.iframes",{callback:()=>{s(gapi.iframes.getContext())},ontimeout:()=>{Yw(),c(uo(u,"network-request-failed"))},timeout:j3.get()})}if(!((_=(p=ho().gapi)===null||p===void 0?void 0:p.iframes)===null||_===void 0)&&_.Iframe)s(gapi.iframes.getContext());else if(!((g=ho().gapi)===null||g===void 0)&&g.load)y();else{const O=z4("iframefcb");return ho()[O]=()=>{gapi.load?y():c(uo(u,"network-request-failed"))},q4(`${Y4()}?onload=${O}`).catch(L=>c(L))}}).catch(s=>{throw qf=null,s})}let qf=null;function W3(u){return qf=qf||G3(u),qf}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const H3=new uh(5e3,15e3),K3="__/auth/iframe",q3="emulator/auth/iframe",Y3={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},z3=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function J3(u){const s=u.config;De(s.authDomain,u,"auth-domain-config-required");const c=s.emulator?IT(s,q3):`https://${u.config.authDomain}/${K3}`,p={apiKey:s.apiKey,appName:u.name,v:Yd},_=z3.get(u.config.apiHost);_&&(p.eid=_);const g=u._getFrameworks();return g.length&&(p.fw=g.join(",")),`${c}?${qu(p).slice(1)}`}async function X3(u){const s=await W3(u),c=ho().gapi;return De(c,u,"internal-error"),s.open({where:document.body,url:J3(u),messageHandlersFilter:c.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:Y3,dontclear:!0},p=>new Promise(async(_,g)=>{await p.restyle({setHideOnLeave:!1});const y=uo(u,"network-request-failed"),O=ho().setTimeout(()=>{g(y)},H3.get());function L(){ho().clearTimeout(O),_(p)}p.ping(L).then(L,()=>{g(y)})}))}/**
 * @license
 * Copyright 2020 Google LLC.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Q3={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"},$3=500,Z3=600,tW="_blank",eW="http://localhost";class zw{constructor(s){this.window=s,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch{}}}function nW(u,s,c,p=$3,_=Z3){const g=Math.max((window.screen.availHeight-_)/2,0).toString(),y=Math.max((window.screen.availWidth-p)/2,0).toString();let O="";const L=Object.assign(Object.assign({},Q3),{width:p.toString(),height:_.toString(),top:g,left:y}),V=fi().toLowerCase();c&&(O=Sw(V)?tW:c),gw(V)&&(s=s||eW,L.scrollbars="yes");const G=Object.entries(L).reduce((st,[ht,yt])=>`${st}${ht}=${yt},`,"");if(V4(V)&&O!=="_self")return rW(s||"",O),new zw(null);const tt=window.open(s||"",O,G);De(tt,u,"popup-blocked");try{tt.focus()}catch{}return new zw(tt)}function rW(u,s){const c=document.createElement("a");c.href=u,c.target=s;const p=document.createEvent("MouseEvent");p.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),c.dispatchEvent(p)}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iW="__/auth/handler",sW="emulator/auth/handler",oW=encodeURIComponent("fac");async function Jw(u,s,c,p,_,g){De(u.config.authDomain,u,"auth-domain-config-required"),De(u.config.apiKey,u,"invalid-api-key");const y={apiKey:u.config.apiKey,appName:u.name,authType:c,redirectUrl:p,v:Yd,eventId:_};if(s instanceof Pw){s.setDefaultLanguage(u.languageCode),y.providerId=s.providerId||"",gF(s.getCustomParameters())||(y.customParameters=JSON.stringify(s.getCustomParameters()));for(const[G,tt]of Object.entries({}))y[G]=tt}if(s instanceof fh){const G=s.getScopes().filter(tt=>tt!=="");G.length>0&&(y.scopes=G.join(","))}u.tenantId&&(y.tid=u.tenantId);const O=y;for(const G of Object.keys(O))O[G]===void 0&&delete O[G];const L=await u._getAppCheckToken(),V=L?`#${oW}=${encodeURIComponent(L)}`:"";return`${aW(u)}?${qu(O).slice(1)}${V}`}function aW({config:u}){return u.emulator?IT(u,sW):`https://${u.authDomain}/${iW}`}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const MT="webStorageSupport";class cW{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=xw,this._completeRedirectFn=D3,this._overrideRedirectResult=O3}async _openPopup(s,c,p,_){var g;Jo((g=this.eventManagers[s._key()])===null||g===void 0?void 0:g.manager,"_initialize() not called before _openPopup()");const y=await Jw(s,c,p,RT(),_);return nW(s,y,DT())}async _openRedirect(s,c,p,_){await this._originValidation(s);const g=await Jw(s,c,p,RT(),_);return u3(g),new Promise(()=>{})}_initialize(s){const c=s._key();if(this.eventManagers[c]){const{manager:_,promise:g}=this.eventManagers[c];return _?Promise.resolve(_):(Jo(g,"If manager is not set, promise should be"),g)}const p=this.initAndGetManager(s);return this.eventManagers[c]={promise:p},p.catch(()=>{delete this.eventManagers[c]}),p}async initAndGetManager(s){const c=await X3(s),p=new L3(s);return c.register("authEvent",_=>(De(_==null?void 0:_.authEvent,s,"invalid-auth-event"),{status:p.onEvent(_.authEvent)?"ACK":"ERROR"}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[s._key()]={manager:p},this.iframes[s._key()]=c,p}_isIframeWebStorageSupported(s,c){this.iframes[s._key()].send(MT,{type:MT},_=>{var g;const y=(g=_==null?void 0:_[0])===null||g===void 0?void 0:g[MT];y!==void 0&&c(!!y),Yo(s,"internal-error")},gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(s){const c=s._key();return this.originValidationPromises[c]||(this.originValidationPromises[c]=F3(s)),this.originValidationPromises[c]}get _shouldInitProactively(){return Cw()||Tw()||OT()}}const dW=cW;var Xw="@firebase/auth",Qw="1.7.9";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class lW{constructor(s){this.auth=s,this.internalListeners=new Map}getUid(){var s;return this.assertAuthConfigured(),((s=this.auth.currentUser)===null||s===void 0?void 0:s.uid)||null}async getToken(s){return this.assertAuthConfigured(),await this.auth._initializationPromise,this.auth.currentUser?{accessToken:await this.auth.currentUser.getIdToken(s)}:null}addAuthTokenListener(s){if(this.assertAuthConfigured(),this.internalListeners.has(s))return;const c=this.auth.onIdTokenChanged(p=>{s((p==null?void 0:p.stsTokenManager.accessToken)||null)});this.internalListeners.set(s,c),this.updateProactiveRefresh()}removeAuthTokenListener(s){this.assertAuthConfigured();const c=this.internalListeners.get(s);c&&(this.internalListeners.delete(s),c(),this.updateProactiveRefresh())}assertAuthConfigured(){De(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function uW(u){switch(u){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}function hW(u){qd(new Lc("auth",(s,{options:c})=>{const p=s.getProvider("app").getImmediate(),_=s.getProvider("heartbeat"),g=s.getProvider("app-check-internal"),{apiKey:y,authDomain:O}=p.options;De(y&&!y.includes(":"),"invalid-api-key",{appName:p.name});const L={apiKey:y,authDomain:O,clientPlatform:u,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:Aw(u)},V=new H4(p,_,g,L);return X4(V,c),V},"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback((s,c,p)=>{s.getProvider("auth-internal").initialize()})),qd(new Lc("auth-internal",s=>{const c=NT(s.getProvider("auth").getImmediate());return(p=>new lW(p))(c)},"PRIVATE").setInstantiationMode("EXPLICIT")),Va(Xw,Qw,uW(u)),Va(Xw,Qw,"esm2017")}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pW=5*60,fW=iC("authIdTokenMaxAge")||pW;let $w=null;const _W=u=>async s=>{const c=s&&await s.getIdTokenResult(),p=c&&(new Date().getTime()-Date.parse(c.issuedAtTime))/1e3;if(p&&p>fW)return;const _=c==null?void 0:c.token;$w!==_&&($w=_,await fetch(u,{method:_?"POST":"DELETE",headers:_?{Authorization:`Bearer ${_}`}:{}}))};function mW(u=fC()){const s=bg(u,"auth");if(s.isInitialized())return s.getImmediate();const c=J4(u,{popupRedirectResolver:dW,persistence:[S3,c3,xw]}),p=iC("authTokenSyncURL");if(p&&typeof isSecureContext=="boolean"&&isSecureContext){const g=new URL(p,location.origin);if(location.origin===g.origin){const y=_W(g.toString());s3(c,y,()=>y(c.currentUser)),i3(c,O=>y(O))}}const _=nC("auth");return _&&Q4(c,`http://${_}`),c}function EW(){var u,s;return(s=(u=document.getElementsByTagName("head"))===null||u===void 0?void 0:u[0])!==null&&s!==void 0?s:document}K4({loadJS(u){return new Promise((s,c)=>{const p=document.createElement("script");p.setAttribute("src",u),p.onload=s,p.onerror=_=>{const g=uo("internal-error");g.customData=_,c(g)},p.type="text/javascript",p.charset="UTF-8",EW().appendChild(p)})},gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="}),hW("Browser");var gW="firebase",TW="10.14.1";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */Va(gW,TW,"app");const Zw=pC({apiKey:"AIzaSyCaxoNKRIMaXhotGzdAjXc5gkARoqtS3bU",authDomain:"disruptive-metaverse.firebaseapp.com",projectId:"disruptive-metaverse",storageBucket:"disruptive-metaverse.appspot.com",messagingSenderId:"294433070603",appId:"1:294433070603:web:136cddd196eea9614fb10e"});mW(Zw);const SW=a4(Zw),vW=async u=>{try{Kd.log("userFirestore: Get user Profile data for user ID: "+u);const s=o4(SW,"users",u),c=await g4(s);return c.exists()?(Kd.log("userFirestore: Found Profile for : "+c.data().Nickname),c.data()):(Kd.error("userFirestore: user profile document not found"),null)}catch(s){throw Kd.error("userFirestore: Error fetching user profile data:",s),s}},yW=Ht.createContext({user:null}),RW=({userNickname:u})=>{const{client:s,channel:c,screenTrack:p,isScreenSharing:_,toggleScreenShare:g}=mg(),[y,O]=Ht.useState([]),[L,V]=Ht.useState(!1),[G,tt]=Ht.useState(!0);Ht.useRef({});const st=Ht.useRef(null),{user:ht}=Ht.useContext(yW)||{user:null},[yt,Vt]=Ht.useState({}),wt=Ht.useRef(p);Ht.useEffect(()=>{wt.current=p},[p]),Ht.useEffect(()=>{if(!s||!c){V(!1);return}const Lt=setTimeout(()=>{tt(!1)},5e3);console.log("Setting up screen share display with existing client:",s),console.log("Current channel:",c);const It=s.connectionState;if(console.log("Current connection state:",It),It==="CONNECTED")V(!0),tt(!1);else{V(!1);const ae=J=>{console.log("Connection state changed:",J),J==="CONNECTED"?(V(!0),tt(!1)):V(!1)};return s.on("connection-state-change",ae),()=>{s.off("connection-state-change",ae),clearTimeout(Lt)}}return()=>{clearTimeout(Lt)}},[s,c]),Ht.useEffect(()=>{const Lt=async()=>{const It={...yt};let ae=!1;for(const J of y){if(yt[J.uid])continue;let q=null,K=J.uid;if(typeof K=="string"&&(K.includes("-")?(q=K.split("-")[0],K=K.split("-")[1]):K.includes("_")&&(q=K.split("_")[0],K=K.split("_")[1])),K)try{console.log("Trying to fetch nickname for user ID:",K);const Z=await vW(K);Z&&Z.Nickname?(console.log("Found nickname in Firebase for user ID:",K,"Nickname:",Z.Nickname),It[J.uid]=Z.Nickname,ae=!0):q?(console.log("Using extracted name for user ID:",K,"Name:",q),It[J.uid]=q,ae=!0):(It[J.uid]="User",ae=!0)}catch(Z){console.error("Error fetching user profile:",Z),q?(It[J.uid]=q,ae=!0):(It[J.uid]="User",ae=!0)}else q?(It[J.uid]=q,ae=!0):(It[J.uid]="User",ae=!0)}ae&&Vt(It)};y.length>0&&Lt()},[y,yt]),Ht.useEffect(()=>{if(!s||!c||!L)return;console.log("Setting up screen share event handlers");const Lt=async(J,q)=>{if(console.log("User published:",J.uid,q,J),q==="video"){console.log("Remote video track detected:",J.uid);try{await s.subscribe(J,q),console.log("Subscribed to remote video track:",J.uid),O(K=>K.some(Z=>Z.uid===J.uid)?K:[...K,J])}catch(K){console.error("Error subscribing to remote video track:",K)}}},It=(J,q)=>{if(console.log("User unpublished:",J.uid,q),q==="video"){if(console.log("Remote video track unpublished:",J.uid),J.videoTrack)try{J.videoTrack.stop()}catch(K){console.error("Error stopping video track:",K)}if(O(K=>K.filter(Z=>Z.uid!==J.uid)),_&&wt.current&&st.current)try{console.log("Ensuring local screen track is still playing after remote user unpublished"),wt.current.play(st.current)}catch(K){console.error("Error replaying local screen track:",K)}}},ae=J=>{console.log("User left:",J.uid);const q=y.find(K=>K.uid===J.uid);if(q&&q.videoTrack)try{q.videoTrack.stop()}catch(K){console.error("Error stopping video track:",K)}if(O(K=>K.filter(Z=>Z.uid!==J.uid)),_&&wt.current&&st.current)try{console.log("Ensuring local screen track is still playing after remote user left"),wt.current.play(st.current)}catch(K){console.error("Error replaying local screen track:",K)}};return s.on("user-published",Lt),s.on("user-unpublished",It),s.on("user-left",ae),()=>{s.off("user-published",Lt),s.off("user-unpublished",It),s.off("user-left",ae)}},[s,c,L,y,_]),Ht.useEffect(()=>{if(console.log("Remote screens changed:",y.length,y),y.forEach(Lt=>{if(Lt.videoTrack)try{console.log("Playing video track for:",Lt.uid),Lt.videoTrack.play(`video-container-${Lt.uid}`)}catch(It){console.error("Error playing video track:",It)}}),_&&wt.current&&st.current)try{console.log("Ensuring local screen track is still playing after remote screens changed"),wt.current.play(st.current)}catch(Lt){console.error("Error replaying local screen track:",Lt)}},[y,_]),Ht.useEffect(()=>{if(console.log("Local screen sharing state changed:",_,p),_&&p&&st.current)try{console.log("Playing local screen track"),p.play(st.current)}catch(Lt){console.error("Error playing local screen track:",Lt)}},[_,p]),Ht.useEffect(()=>()=>{if(y.forEach(Lt=>{if(Lt.videoTrack)try{Lt.videoTrack.stop()}catch(It){console.error("Error stopping video track on unmount:",It)}}),p)try{p.stop()}catch(Lt){console.error("Error stopping local screen track on unmount:",Lt)}},[y,p]);const te=Lt=>{console.log("Closing screen share for:",Lt);const It=y.find(ae=>ae.uid===Lt);if(It&&It.videoTrack)try{It.videoTrack.stop()}catch(ae){console.error("Error stopping video track:",ae)}if(O(ae=>ae.filter(J=>J.uid!==Lt)),_&&wt.current&&st.current)try{console.log("Ensuring local screen track is still playing after closing remote screen"),wt.current.play(st.current)}catch(ae){console.error("Error replaying local screen track:",ae)}},Nt=()=>{console.log("Stopping local screen share"),g()},oe=Lt=>(console.log("Getting display name for UID:",Lt,"type:",typeof Lt),_&&ht&&(Lt===ht.uid||Lt===(s==null?void 0:s.uid))?u||"You":yt[Lt]?yt[Lt]:typeof Lt=="string"?Lt.includes("-")?Lt.split("-")[0]:Lt.includes("_")?Lt.split("_")[0]:Lt:"User");return!L||G&&y.length===0&&!_||y.length===0&&!_?null:Ze.jsxs(Cr.Box,{position:"fixed",top:"70px",right:"20px",zIndex:1e4,maxWidth:"80vw",maxHeight:"80vh",overflow:"auto",children:[_&&p&&Ze.jsxs(Cr.Box,{position:"relative",mb:4,borderRadius:"md",overflow:"hidden",boxShadow:"xl",bg:"black",width:"640px",height:"360px",children:[Ze.jsx(Cr.Box,{position:"absolute",top:2,right:2,zIndex:10,children:Ze.jsx(Cr.CloseButton,{size:"sm",bg:"rgba(0,0,0,0.5)",color:"white",onClick:Nt})}),Ze.jsx(Cr.Box,{ref:st,width:"100%",height:"100%",position:"relative",id:"local-screen-container"}),Ze.jsx(Cr.Box,{position:"absolute",bottom:2,left:2,color:"white",fontSize:"sm",bg:"rgba(0,0,0,0.5)",px:2,py:1,borderRadius:"md",zIndex:5,children:u?`${u}'s Screen`:"Your Screen"})]}),y.map(Lt=>{const It=yt[Lt.uid]||oe(Lt.uid);return Ze.jsxs(Cr.Box,{position:"relative",mb:4,borderRadius:"md",overflow:"hidden",boxShadow:"xl",bg:"black",width:"640px",height:"360px",children:[Ze.jsx(Cr.Box,{position:"absolute",top:2,right:2,zIndex:10,children:Ze.jsx(Cr.CloseButton,{size:"sm",bg:"rgba(0,0,0,0.5)",color:"white",onClick:()=>te(Lt.uid)})}),Ze.jsx(Cr.Box,{id:`video-container-${Lt.uid}`,width:"100%",height:"100%",position:"relative"}),Ze.jsx(Cr.Box,{position:"absolute",bottom:2,left:2,color:"white",fontSize:"sm",bg:"rgba(0,0,0,0.5)",px:2,py:1,borderRadius:"md",zIndex:5,children:`${It}'s Screen`})]},Lt.uid)})]})},IW=({onClose:u})=>{const s=Cr.useToast(),[c,p]=Ht.useState(!1),[_,g]=Ht.useState(!1);Ht.useEffect(()=>{const L=()=>{window.agoraClient&&g(!!window.agoraClient.isScreenSharing)};L();const V=setInterval(L,1e3),G=()=>{L()};return window.addEventListener("ScreenShareToggled",G),()=>{clearInterval(V),window.removeEventListener("ScreenShareToggled",G)}},[]);const y=async L=>{if(L.preventDefault(),L.stopPropagation(),u&&u(),!window.agoraClient||!window.agoraClient.client){s({title:"Screen sharing not available",description:"Voice chat must be connected to use screen sharing",status:"warning",duration:3e3,isClosable:!0});return}try{if(p(!0),window.agoraClient.isJoined)O();else{console.log("ScreenShareMenuOption: Not joined to voice chat, joining automatically");const V=new CustomEvent("JoinVoiceChat",{detail:{callback:G=>{if(!G){console.error("ScreenShareMenuOption: Failed to join voice chat"),s({title:"Connection failed",description:"Could not connect to voice chat",status:"error",duration:3e3,isClosable:!0}),p(!1);return}O()}}});window.dispatchEvent(V)}}catch(V){console.error("Error in screen share handler:",V),p(!1),s({title:"Screen sharing error",description:V.message||"Failed to toggle screen sharing",status:"error",duration:5e3,isClosable:!0})}},O=async()=>{try{const L=new CustomEvent("ToggleScreenShare",{detail:{callback:(V,G)=>{p(!1),V?(g(G),s(G?{title:"Screen sharing started",status:"success",duration:3e3,isClosable:!0}:{title:"Screen sharing stopped",status:"info",duration:3e3,isClosable:!0})):s({title:"Screen sharing error",description:"Failed to toggle screen sharing",status:"error",duration:5e3,isClosable:!0})}}});window.dispatchEvent(L)}catch(L){console.error("Error toggling screen share:",L),p(!1),s({title:"Screen sharing error",description:L.message||"Failed to toggle screen sharing",status:"error",duration:5e3,isClosable:!0})}};return Ze.jsx(Cr.Text,{fontSize:"md",cursor:"pointer",_hover:{bg:"whiteAlpha.200"},p:2,borderRadius:"md",onClick:y,color:_?"red.300":"white",children:c?"Connecting...":_?"Stop Screen Sharing":"Share Screen"})},CW=()=>{let u=null;try{u=af()}catch(G){return G.message,null}if(!u)return null;const{isJoined:s,channel:c,uid:p,isVoiceEnabled:_,microphoneTrack:g,client:y}=u,O={position:"fixed",bottom:"10px",left:"10px",backgroundColor:"rgba(0, 0, 0, 0.7)",color:"white",padding:"10px",borderRadius:"5px",fontSize:"12px",zIndex:9999,maxWidth:"300px",fontFamily:"monospace"},V=(()=>{if(!y)return"Not initialized";try{return{connectionState:y.connectionState,remoteUsers:Object.keys(y.remoteUsers||{}).length,uid:y.uid,channelName:y.channelName}}catch{return"Error getting client state"}})();return Ze.jsxs("div",{style:O,children:[Ze.jsx("h3",{style:{margin:"0 0 8px 0"},children:"Agora Debug Panel"}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"Channel:"})," ",c||"Not set"]}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"UID:"})," ",p||"Not set"]}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"Joined:"})," ",s?"Yes":"No"]}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"Voice Enabled:"})," ",_?"Yes":"No"]}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"Mic Track:"})," ",g?`${g.trackMediaType} (${g.muted?"Muted":"Active"})`:"Not created"]}),Ze.jsxs("div",{children:[Ze.jsx("strong",{children:"Client State:"})," ",typeof V=="object"?Ze.jsx("pre",{style:{margin:"5px 0"},children:JSON.stringify(V,null,2)}):V]})]})};Ai.AgoraProvider=$I,Ai.ScreenShareButton=JV,Ai.ScreenShareDisplay=RW,Ai.ScreenShareMenuOption=IW,Ai.VoiceButton=zV,Ai.VoiceChatDebugPanel=CW,Ai.useAgoraContext=mg,Ai.useVoiceChat=af,Object.defineProperty(Ai,Symbol.toStringTag,{value:"Module"})});
