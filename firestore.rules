rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is in a specific group
    function userIsInGroup(groupName) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groups != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groups.hasAny([groupName]);
    }
    
    // Helper function to check if user is in a space-specific group (owner or host)
    function userIsInSpaceGroup(spaceId) {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groups != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groups.hasAny([
          'space_' + spaceId + '_owners',
          'space_' + spaceId + '_hosts'
        ]);
    }

    // Users can read and write their own profile records
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow other authenticated users to read user profiles
      allow read: if request.auth != null;
    }

    // Public resources accessible to all authenticated users
    match /public/{document=**} {
      allow read: if request.auth != null;
    }

    // Website CMS Content - Publicly readable but only admins can write
    match /website/{docId} {
      allow read;
      allow write: if request.auth != null && userIsInGroup('disruptiveAdmin');
    }
    
    // Contact form submissions - Allow anyone to create, only admins can read/update
    match /contactSubmissions/{submissionId} {
      // Anyone can create a contact submission (even without authentication)
      allow create;
      // Only admins can read/update/delete
      allow read, update, delete: if request.auth != null && userIsInGroup('disruptiveAdmin');
    }

    // Spaces - Make publicly readable for SEO
    match /spaces/{spaceId} {
      // Allow public read access to spaces for SEO purposes
      allow read;

      // Allow write access if:
      // 1. The user's UID is in the usersAdmin or usersModerators arrays
      // 2. The user is in a space-specific owner or host group
      // 3. The user is in the disruptiveAdmin group
      allow write: if (request.auth != null && 
                      (request.auth.uid in resource.data.usersAdmin ||
                       request.auth.uid in resource.data.usersModerators ||
                       userIsInSpaceGroup(spaceId) ||
                       userIsInGroup('disruptiveAdmin')));

      // Space Chat - Make more permissive
      match /chatMessages/{messageId} {
        allow read, write: if request.auth != null;
      }

      // Space Videos - Make more permissive
      match /videos/{videoId} {
        allow read: if request.auth != null;
      }
      
      // Media Screens - Make more permissive
      match /mediaScreens/{screenId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // SEO Content - Make publicly readable
    match /seoContent/{docId} {
      allow read;
      allow write: if request.auth != null && userIsInGroup('disruptiveAdmin');
    }
    
    // Disruptive Admin has full access to everything
    match /{document=**} {
      allow read, write: if userIsInGroup('disruptiveAdmin');
    }
  }
}
